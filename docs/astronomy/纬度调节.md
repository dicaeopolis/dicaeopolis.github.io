<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æè½´ä¿¯ä»°åŠ©æ‰‹</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #e0e0e0;
            --accent-red: #ff3b30;
            --accent-green: #32d74b;
            --panel-bg: #1c1c1e;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        h1 { font-size: 1.2rem; margin-bottom: 10px; opacity: 0.8; }

        /* ä»ªè¡¨ç›˜åŒºåŸŸ */
        .gauge-container {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .gauge-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid #333;
            border-radius: 50%;
            box-sizing: border-box;
        }

        .target-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: var(--accent-green);
            opacity: 0.5;
            transform: rotate(0deg); /* åŠ¨æ€è°ƒæ•´ */
        }
        
        .current-pointer {
            position: absolute;
            width: 4px;
            height: 50%;
            background-color: var(--accent-red);
            bottom: 50%;
            transform-origin: bottom center;
            transition: transform 0.1s linear;
        }

        .center-value {
            z-index: 10;
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 10px;
        }

        .big-number {
            font-size: 3.5rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            color: var(--accent-red);
        }
        
        .aligned .big-number { color: var(--accent-green); }
        .aligned .current-pointer { background-color: var(--accent-green); }

        .sub-text { font-size: 0.9rem; color: #888; }

        /* GPS ä¿¡æ¯ */
        .gps-info {
            background: var(--panel-bg);
            padding: 10px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 320px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .gps-status.ok { color: var(--accent-green); }

        /* æ¨¡å¼é€‰æ‹© */
        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 340px;
            margin-bottom: 15px;
        }

        .mode-btn {
            background: #333;
            border: 2px solid transparent;
            color: #aaa;
            padding: 10px 5px;
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #444;
            border-color: var(--accent-red);
            color: #fff;
        }
        
        .mode-icon { display: block; font-size: 1.5rem; margin-bottom: 4px; }

        /* æ ¡å‡†æŒ‰é’® */
        .btn-calibrate {
            background: var(--panel-bg);
            border: 1px solid #444;
            color: #fff;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
            margin-bottom: 20px;
            width: 100%;
            max-width: 320px;
        }
        
        .btn-calibrate:active { background: #333; }

        /* è°ƒè¯•/æç¤ºä¿¡æ¯ */
        .hint {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 10px;
            max-width: 300px;
        }
    </style>
</head>
<body>

    <div class="gps-info">
        <span>ç›®æ ‡çº¬åº¦ (GPS)</span>
        <span id="target-lat" class="gps-status">è·å–ä¸­...</span>
    </div>

    <div class="mode-selector">
        <div class="mode-btn active" onclick="setMode('A')">
            <span class="mode-icon">ğŸ“±â¬†ï¸</span>
            å¹³æ”¾ä»°èµ·<br>(åº•è¾¹è½´)
        </div>
        <div class="mode-btn" onclick="setMode('B')">
            <span class="mode-icon">ğŸ“²â¡ï¸</span>
            æ¨ªæ”¾ä»°èµ·<br>(å·¦ä¾§è½´)
        </div>
        <div class="mode-btn" onclick="setMode('C')">
            <span class="mode-icon">ğŸ“±ğŸ”„</span>
            ç«–ç«‹ä¾§æ”¾<br>(åšåº¦è½´)
        </div>
    </div>

    <div class="gauge-container" id="gauge-container">
        <div class="gauge-circle"></div>
        <!-- ç›®æ ‡çº¿ï¼šä»£è¡¨GPSçº¬åº¦ -->
        <div class="target-line" id="target-indicator"></div>
        <!-- å½“å‰æŒ‡é’ˆ -->
        <div class="current-pointer" id="current-pointer"></div>
        
        <div class="center-value" id="value-display">
            <div class="sub-text">å½“å‰ä»°è§’</div>
            <div class="big-number" id="current-pitch">0.00Â°</div>
            <div class="sub-text" id="diff-text">ç­‰å¾…æ•°æ®</div>
        </div>
    </div>

    <div class="hint" id="mode-hint">æ¨¡å¼Aï¼šå……ç”µå£æœè‡ªå·±ï¼Œå±å¹•æœä¸Šã€‚æ‰‹æœºéšèµ¤é“ä»ªåƒç¿»ç›–ä¸€æ ·æŠ¬èµ·ã€‚</div>

    <button class="btn-calibrate" onclick="calibrate()">åœ¨æ­¤å¹³é¢æ ¡å‡†å½’é›¶</button>

    <script>
        // --- æ ¸å¿ƒçŠ¶æ€ ---
        let state = {
            mode: 'A',
            targetLat: 0,
            currentPitch: 0,
            calibrationOffset: 0,
            rawPitchHistory: [], // ç”¨äºå¹³æ»‘æ»¤æ³¢
            hasGPS: false
        };

        const SMOOTHING_FACTOR = 0.15; // æ»¤æ³¢ç³»æ•°ï¼Œè¶Šå°è¶Šå¹³æ»‘ä½†å»¶è¿Ÿè¶Šé«˜
        let smoothedPitch = 0;

        // --- DOM å…ƒç´  ---
        const elTargetLat = document.getElementById('target-lat');
        const elCurrentPitch = document.getElementById('current-pitch');
        const elDiffText = document.getElementById('diff-text');
        const elPointer = document.getElementById('current-pointer');
        const elTargetIndicator = document.getElementById('target-indicator'); // å…¶å®ä¸éœ€è¦åŠ¨ï¼Œå› ä¸ºè¡¨ç›˜ç›¸å¯¹è½¬åŠ¨ï¼Œæˆ–è€…æŒ‡é’ˆåŠ¨
        const elValueDisplay = document.getElementById('value-display');
        const elHint = document.getElementById('mode-hint');

        // --- 1. GPS è·å– ---
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(
                (position) => {
                    state.targetLat = position.coords.latitude;
                    state.hasGPS = true;
                    elTargetLat.innerText = state.targetLat.toFixed(2) + "Â° N";
                    elTargetLat.classList.add('ok');
                    updateUI();
                },
                (error) => {
                    elTargetLat.innerText = "GPS å¤±è´¥";
                    console.error(error);
                },
                { enableHighAccuracy: true }
            );
        } else {
            elTargetLat.innerText = "ä¸æ”¯æŒ GPS";
        }

        // --- 2. æ¨¡å¼åˆ‡æ¢ ---
        function setMode(mode) {
            state.mode = mode;
            // é‡ç½®æ ¡å‡†
            state.calibrationOffset = 0;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // æ›´æ–°æç¤ºæ–‡æ¡ˆ
            const hints = {
                'A': 'æ¨¡å¼Aï¼šå……ç”µå£æœè‡ªå·±ï¼Œå±å¹•æœä¸Šã€‚æ‰‹æœºé¡¶éƒ¨æŒ‡å‘æè½´æ–¹å‘ã€‚',
                'B': 'æ¨¡å¼Bï¼šæ‰‹æœºæ¨ªæ”¾ï¼Œå……ç”µå£æœå³ï¼ˆéŸ³é‡é”®æœä¸Šï¼‰ã€‚æ‰‹æœºå³ä¾§è¾¹æŒ‡å‘æè½´æ–¹å‘ã€‚',
                'C': 'æ¨¡å¼Cï¼šæ‰‹æœºç«–ç«‹ä¾§æ”¾ï¼ˆå±å¹•å‚ç›´å¤§åœ°ï¼‰ã€‚å……ç”µå£æœè‡ªå·±ã€‚'
            };
            elHint.innerText = hints[mode];
        }

        // --- 3. æ ¡å‡†é€»è¾‘ ---
        function calibrate() {
            // å½“å‰æµ‹é‡å€¼å³ä¸ºåå·®å€¼
            // å‡è®¾ç”¨æˆ·ç°åœ¨æ”¾åœ¨æ°´å¹³é¢ä¸Šï¼Œè¯»æ•°åº”è¯¥æ˜¯0åº¦ã€‚
            // å¦‚æœè¯»æ•°æ˜¯ 2.5åº¦ï¼Œè¯´æ˜æˆ‘ä»¬è¦å‡å» 2.5åº¦ã€‚
            state.calibrationOffset = state.currentPitch + state.calibrationOffset;
            alert("æ ¡å‡†å·²å®Œæˆï¼\nå‡è®¾å½“å‰å¹³é¢ä¸º0Â°æ°´å¹³é¢ã€‚\nè¯·å°†æ‰‹æœºå®‰è£…åˆ°è®¾å¤‡ä¸Šã€‚");
        }

        // --- 4. ä¼ æ„Ÿå™¨ä¸æ ¸å¿ƒè§£ç®— ---
        window.addEventListener('devicemotion', handleMotion);

        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            // Androidé€šå¸¸è¿”å›ï¼š
            // å¹³æ”¾(å±å¹•æœä¸Š): x=0, y=0, z=9.8
            // ç«–ç«‹(é¡¶éƒ¨æœä¸Š): x=0, y=9.8, z=0 (æ³¨ï¼šä¸åŒæµè§ˆå™¨/è®¾å¤‡yè½´æ­£è´Ÿå¯èƒ½ä¸åŒï¼Œéœ€é€šç”¨å¤„ç†)
            // å‘é‡è§£ç®—ä¸éœ€è¦å…³å¿ƒæ­£è´Ÿï¼Œåªå…³å¿ƒé‡åŠ›çŸ¢é‡åœ¨æŒ‡å‘è½´ä¸Šçš„æŠ•å½±

            const gx = acc.x;
            const gy = acc.y;
            const gz = acc.z;

            // è®¡ç®—ä»°è§’
            let rawAngle = calculateElevationFromVector(gx, gy, gz, state.mode);

            // ç®€å•ä½é€šæ»¤æ³¢
            smoothedPitch = smoothedPitch + SMOOTHING_FACTOR * (rawAngle - smoothedPitch);
            if (Math.abs(rawAngle - smoothedPitch) > 180) smoothedPitch = rawAngle; // é˜²æ­¢è¿‡0ç‚¹çªå˜

            // æ›´æ–°çŠ¶æ€ï¼ˆæš‚å­˜æœªæ ¡å‡†çš„åŸå§‹è®¡ç®—å€¼ç”¨äºå¹³æ»‘ï¼ŒUIæ˜¾ç¤ºæ—¶å†å‡åç½®ï¼‰
            // è¿™é‡Œæˆ‘ä»¬ç›´æ¥å¹³æ»‘ç»“æœã€‚æ ¡å‡†åç½®æ˜¯çº¿æ€§çš„ã€‚
            state.currentPitch = smoothedPitch;

            requestAnimationFrame(updateUI);
        }

        // æ ¸å¿ƒå‘é‡ç®—æ³•
        function calculateElevationFromVector(gx, gy, gz, mode) {
            // å®šä¹‰æ‰‹æœºåæ ‡ç³»ä¸­çš„â€œæŒ‡å‘å‘é‡â€ (Pointing Vector)
            // è¯¥å‘é‡ä»£è¡¨â€œæœ›è¿œé•œæŒ‡å‘æè½´â€çš„æ–¹å‘
            let vx = 0, vy = 0, vz = 0;

            if (mode === 'A') {
                // æ¨¡å¼Aï¼šåº•è¾¹ä¸ºè½´ï¼Œå±å¹•æœä¸Šã€‚æŒ‡å‘å‘é‡ä¸ºæ‰‹æœºé¡¶éƒ¨ (+Y)
                vx = 0; vy = 1; vz = 0;
            } else if (mode === 'B') {
                // æ¨¡å¼Bï¼šå·¦ä¾§ä¸ºè½´ï¼Œæ¨ªæ”¾ã€‚æŒ‡å‘å‘é‡ä¸ºæ‰‹æœºå³ä¾§ (+X)
                // (å‡è®¾æ¨ªå±æ—¶ï¼Œå·¦ä¾§è´´åº•åº§ï¼Œå¾€å³ä¾§æŠ¬èµ·)
                vx = 1; vy = 0; vz = 0;
            } else if (mode === 'C') {
                // æ¨¡å¼Cï¼šç«–ç«‹ä¾§æ”¾ã€‚æŒ‡å‘å‘é‡ä¸ºæ‰‹æœºé¡¶éƒ¨ (+Y)
                // å³ä½¿å±å¹•ä¸æ˜¯å‚ç›´åœ°é¢ï¼ˆæœ‰Rollè§’ï¼‰ï¼Œé‡åŠ›åœ¨Yè½´ä¸Šçš„æŠ•å½±ä¸å˜
                vx = 0; vy = 1; vz = 0;
            }

            // 1. è®¡ç®—é‡åŠ›å‘é‡çš„æ¨¡é•¿ |g|
            const magG = Math.sqrt(gx*gx + gy*gy + gz*gz);
            
            // 2. è®¡ç®—ç‚¹ç§¯ g Â· v
            const dot = (gx * vx) + (gy * vy) + (gz * vz);

            // 3. è®¡ç®—å¤¹è§’ theta = arccos(dot / (|g|*|v|))
            // æ³¨æ„ï¼š|v| = 1
            // å¤¹è§’èŒƒå›´ 0 ~ 180 åº¦
            let angleRad = Math.acos(dot / magG);
            let angleDeg = angleRad * (180 / Math.PI);

            // 4. è½¬æ¢ä¸ºä»°è§’
            // é‡åŠ›çŸ¢é‡æ˜¯æŒ‡å‘åœ°å¿ƒçš„ã€‚
            // å¦‚æœæŒ‡å‘å‘é‡æŒ‡å¤©é¡¶ï¼ˆä»°è§’90ï¼‰ï¼Œå®ƒä¸é‡åŠ›åå‘ï¼Œå¤¹è§’180ã€‚
            // å¦‚æœæŒ‡å‘å‘é‡æŒ‡åœ°å¹³ï¼ˆä»°è§’0ï¼‰ï¼Œå®ƒä¸é‡åŠ›å‚ç›´ï¼Œå¤¹è§’90ã€‚
            // å…¬å¼ï¼šä»°è§’ = angleDeg - 90
            
            // ä¿®æ­£Androidé‡åŠ›æ–¹å‘å·®å¼‚ï¼š
            // é€šå¸¸ DeviceMotion ä¸­ï¼Œé‡åŠ›æ˜¯åŠ ä¸Šå»çš„ã€‚å¹³æ”¾æ—¶ Z = +9.8ã€‚
            // å¦‚æœæ‰‹æœºç›´ç«‹ï¼ˆé¡¶éƒ¨æœå¤©ï¼‰ï¼Œé‡åŠ›å‘ä¸‹ï¼Œä¼ æ„Ÿå™¨æ„Ÿå—åˆ°å‘ä¸Šçš„åŠ›ï¼Ÿ
            // æ ‡å‡† Android Chromeï¼šç«–ç›´æ”¾ç½® y çº¦ä¸º 9.8ã€‚
            // æ­¤æ—¶ v=(0,1,0), g=(0,9.8,0). dot > 0. angle = 0.
            // ç­‰ç­‰ï¼Œå¦‚æœ angle=0ï¼Œè¯´æ˜é‡åŠ›æ–¹å‘å’ŒæŒ‡å‘æ–¹å‘ç›¸åŒã€‚ä¹Ÿå°±æ˜¯æ‰‹æœºé¡¶éƒ¨æŒ‡å‘åœ°å¿ƒã€‚
            // è¿™æ„å‘³ç€ä»°è§’æ˜¯ -90åº¦ã€‚
            // æ‰€ä»¥å¦‚æœ angleDeg æ˜¯ g å’Œ v çš„å¤¹è§’ï¼š
            // 0åº¦ -> æŒ‡å‘åœ°å¿ƒ (-90 elev)
            // 90åº¦ -> åœ°å¹³ (0 elev)
            // 180åº¦ -> æŒ‡å‘å¤©é¡¶ (+90 elev)
            
            return -(angleDeg - 90); 
        }

        // --- 5. UI æ›´æ–° ---
        function updateUI() {
            // åº”ç”¨æ ¡å‡†
            let displayPitch = state.currentPitch - state.calibrationOffset;

            // æ ¼å¼åŒ–æ˜¾ç¤º
            elCurrentPitch.innerText = displayPitch.toFixed(2) + "Â°";

            // è®¡ç®—å·®å€¼
            let diff = displayPitch - state.targetLat;
            
            // é¢œè‰²ä¸æç¤º
            if (state.hasGPS) {
                if (Math.abs(diff) < 0.5) {
                    elValueDisplay.classList.add('aligned');
                    elDiffText.innerText = "âœ… å·²å¯¹å‡†";
                    elDiffText.style.color = "var(--accent-green)";
                } else {
                    elValueDisplay.classList.remove('aligned');
                    let direction = diff < 0 ? "â¬†ï¸ å‘ä¸Šè°ƒ" : "â¬‡ï¸ å‘ä¸‹è°ƒ";
                    elDiffText.innerText = `${direction} ${Math.abs(diff).toFixed(2)}Â°`;
                    elDiffText.style.color = "#aaa";
                }
            }

            // åŠ¨ç”»æŒ‡é’ˆ
            // ä»ªè¡¨ç›˜é€»è¾‘ï¼š
            // 0åº¦ï¼ˆåœ°å¹³ï¼‰åœ¨ 3ç‚¹é’Ÿæ–¹å‘ (CSSé»˜è®¤) ? ä¸ï¼Œæˆ‘ä»¬è®©0åº¦åœ¨æ°´å¹³çº¿ã€‚
            // æˆ‘ä»¬è®© target æ°¸è¿œä¿æŒåœ¨æ°´å¹³çº¿ä¸Šï¼Œè¿˜æ˜¯è®©æŒ‡é’ˆåŠ¨ï¼Ÿ
            // æ–¹æ¡ˆï¼šè®©æŒ‡é’ˆåŠ¨ã€‚
            // å‡è®¾ 0åº¦æ˜¯æ°´å¹³ã€‚90åº¦æ˜¯å‚ç›´ã€‚
            // ä¸ºäº†ç›´è§‚ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿèµ¤é“ä»ªçš„è§†è§’ã€‚
            // è¿™é‡Œåšä¸€ä¸ªç®€å•çš„ç›¸å¯¹æ˜¾ç¤ºï¼š
            // ç›®æ ‡çº¬åº¦æ˜¯æ­£ä¸Šæ–¹ (0deg rotation visually)ï¼Œå½“å‰æ˜¯ç›¸å¯¹åç§»ã€‚
            
            // ç®€åŒ–è§†è§‰ï¼š
            // æŒ‡é’ˆæ—‹è½¬è§’åº¦ = 0åº¦ (å‚ç›´å‘ä¸Š) + (å½“å‰ - ç›®æ ‡)
            // å¦‚æœå½“å‰æ¯”ç›®æ ‡ä½ï¼ŒæŒ‡é’ˆå‘å·¦åï¼›é«˜åˆ™å‘å³åã€‚
            let visualRotation = displayPitch - state.targetLat;
            
            // é™åˆ¶ä¸€ä¸‹æŒ‡é’ˆåˆ«è½¬åœˆåœˆ
            visualRotation = Math.max(-80, Math.min(80, visualRotation));
            
            elPointer.style.transform = `rotate(${visualRotation}deg)`;
        }

    </script>
</body>
</html>