
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../BP/" rel="prev"/>
<link href="../SVM_SMO/" rel="next"/>
<link href="../../favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>RL学习笔记 - 上篇 - Dicaeopolis' Wiki</title>
<link href="../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../themes/css/custom.css" rel="stylesheet"/>
<link href="../../themes/css/simpleLightbox.min.css" rel="stylesheet"/>
<link href="../../themes/css/pied_piper.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" rel="stylesheet"/>
<link href="../../stylesheets/customize.css" rel="stylesheet"/>
<link href="../../assets/css/custom.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#rl-">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="Dicaeopolis' Wiki" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Dicaeopolis' Wiki">
<img alt="logo" src="../../favicon.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Dicaeopolis' Wiki
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              RL学习笔记 - 上篇
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg>
</label>
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../astronomy/">
          
  
  
    
  
  天文摄影理论和实践

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../campus-sources/">
          
  
  
    
  
  校内课程知识

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../">
          
  
  
    
  
  深度神经网络

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../misc/">
          
  
  
    
  
  配置和杂谈笔记

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../algorithm/">
          
  
  
    
  
  传统算法与性能

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Dicaeopolis' Wiki" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Dicaeopolis' Wiki">
<img alt="logo" src="../../favicon.png"/>
</a>
    Dicaeopolis' Wiki
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../astronomy/">
<span class="md-ellipsis">
    
  
    天文摄影理论和实践
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_1">
<span class="md-nav__icon md-icon"></span>
            
  
    天文摄影理论和实践
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../astronomy/gallery/">
<span class="md-ellipsis">
    
  
    深空影集
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../astronomy/polar/">
<span class="md-ellipsis">
    
  
    看不见北极星怎么办
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../astronomy/%E6%96%B9%E4%BD%8D%E8%B0%83%E8%8A%82/">
<span class="md-ellipsis">
    
  
    方位调节
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../astronomy/%E7%BA%AC%E5%BA%A6%E8%B0%83%E8%8A%82/">
<span class="md-ellipsis">
    
  
    纬度调节
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../campus-sources/">
<span class="md-ellipsis">
    
  
    校内课程知识
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            
  
    校内课程知识
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/SDC-exams/">
<span class="md-ellipsis">
    
  
    《计算机组成与设计》部分历年题目题解
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/Discrete_exams/">
<span class="md-ellipsis">
    
  
    《离散数学》部分期末题目题解
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/Discrete_notes/">
<span class="md-ellipsis">
    
  
    离散期末复习提纲
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/Descrete_assignments/">
<span class="md-ellipsis">
    
  
    《离散数学》课程作业与笔记归档
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/Prob_Stats_assignments/">
<span class="md-ellipsis">
    
  
    《概率论与数理统计》课程作业与笔记归档
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/SDC_assignments/">
<span class="md-ellipsis">
    
  
    《计算机组成原理》理论课程作业与笔记归档
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/PU_Bii_assignments/">
<span class="md-ellipsis">
    
  
    《大学物理B下》课程作业与笔记归档
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/binmul/">
<span class="md-ellipsis">
<i class="fas fa-calculator"></i> 二进制乘法可视化工具
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/textbook/">
<span class="md-ellipsis">
    
  
    本科教科书电子资源
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/ds-keynote/">
<span class="md-ellipsis">
    
  
    《数据结构》划重点笔记
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/ds-write-up/">
<span class="md-ellipsis">
    
  
    《数据结构》期末复习题题解
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../campus-sources/autosignin/">
<span class="md-ellipsis">
    
  
    自动签到脚本
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    深度神经网络
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    深度神经网络
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../match/">
<span class="md-ellipsis">
    
  
    如何做四六级考试的段落匹配题
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../BP/">
<span class="md-ellipsis">
    
  
    前馈神经网络的反向传播
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    RL学习笔记 - 上篇
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    RL学习笔记 - 上篇
  

    
  </span>
</a>
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
<span class="md-ellipsis">
      
        缘起
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      
        第一章
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      
        第二章
      
    </span>
</a>
<nav aria-label="第二章" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      
        问题的引入
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_5">
<span class="md-ellipsis">
      
        权衡
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_6">
<span class="md-ellipsis">
      
        平衡探索和利用
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_7">
<span class="md-ellipsis">
      
        总结
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_8">
<span class="md-ellipsis">
      
        第三章
      
    </span>
</a>
<nav aria-label="第三章" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mrp">
<span class="md-ellipsis">
      
        MRP
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mdp">
<span class="md-ellipsis">
      
        MDP
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_9">
<span class="md-ellipsis">
      
        第三点五章
      
    </span>
</a>
<nav aria-label="第三点五章" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_10">
<span class="md-ellipsis">
      
        回顾
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_11">
<span class="md-ellipsis">
      
        迁移
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_12">
<span class="md-ellipsis">
      
        算法
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_13">
<span class="md-ellipsis">
      
        第四章
      
    </span>
</a>
<nav aria-label="第四章" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_14">
<span class="md-ellipsis">
      
        策略迭代
      
    </span>
</a>
<nav aria-label="策略迭代" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_15">
<span class="md-ellipsis">
      
        策略评估
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_16">
<span class="md-ellipsis">
      
        策略提升
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_17">
<span class="md-ellipsis">
      
        价值迭代
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_18">
<span class="md-ellipsis">
      
        收敛性证明
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_19">
<span class="md-ellipsis">
      
        第五章
      
    </span>
</a>
<nav aria-label="第五章" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sarsa">
<span class="md-ellipsis">
      
        Sarsa 算法
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#q-learning">
<span class="md-ellipsis">
      
        Q-learning 算法
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_20">
<span class="md-ellipsis">
      
        在线和离线
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_21">
<span class="md-ellipsis">
      
        第六章
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_22">
<span class="md-ellipsis">
      
        第七章
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_23">
<span class="md-ellipsis">
      
        第八章
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../SVM_SMO/">
<span class="md-ellipsis">
    
  
    SMO 算法的推导
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Wp
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
            
  
    Wp
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../WP/aiwp/">
<span class="md-ellipsis">
    
  
    MISC-AI 方向 WriteUp
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_7" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../model-attack/">
<span class="md-ellipsis">
    
  
    深度学习模型攻击理论与复现归档
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_7">
<span class="md-nav__icon md-icon"></span>
            
  
    深度学习模型攻击理论与复现归档
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../model-attack/hsja/">
<span class="md-ellipsis">
    
  
    HSJA 攻击
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../model-attack/BadNets/">
<span class="md-ellipsis">
    
  
    BadNets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../model-attack/CandW/">
<span class="md-ellipsis">
    
  
    C&amp;W 攻击
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../model-attack/pgd/">
<span class="md-ellipsis">
    
  
    PGD 攻击
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../model-attack/fgsm/">
<span class="md-ellipsis">
    
  
    FGSM 攻击
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_8" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../model-expr/">
<span class="md-ellipsis">
    
  
    深度学习相关模型理论与复现归档
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_8_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_8">
<span class="md-nav__icon md-icon"></span>
            
  
    深度学习相关模型理论与复现归档
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../model-expr/DDPM/">
<span class="md-ellipsis">
    
  
    扩散模型理论篇: 从多阶段变分自编码器到概率流常微分方程采样器系列
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../model-expr/S-and-D-models-replication/">
<span class="md-ellipsis">
    
  
    图像语义分割和目标检测相关模型复现手记
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../model-expr/Image-models-replication/">
<span class="md-ellipsis">
    
  
    图像分类相关模型复现手记
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../model-expr/DC-GAN-%E8%80%81%E5%A9%86%E7%94%9F%E6%88%90%E5%99%A8/">
<span class="md-ellipsis">
    
  
    DC-GAN 老婆生成器
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_9" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../optimizer/">
<span class="md-ellipsis">
    
  
    优化器
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_9" id="__nav_3_9_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_9_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_9">
<span class="md-nav__icon md-icon"></span>
            
  
    优化器
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../optimizer/misc/">
<span class="md-ellipsis">
    
  
    后续的写作计划
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../optimizer/SignGD/">
<span class="md-ellipsis">
    
  
    符号梯度下降
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../optimizer/Adaptive/">
<span class="md-ellipsis">
    
  
    自适应学习率改进策略
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../optimizer/SGD/">
<span class="md-ellipsis">
    
  
    SGD 系列算法
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../misc/">
<span class="md-ellipsis">
    
  
    配置和杂谈笔记
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            
  
    配置和杂谈笔记
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../misc/test/">
<span class="md-ellipsis">
    
  
    功能测试页面
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../algorithm/">
<span class="md-ellipsis">
    
  
    传统算法与性能
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            
  
    传统算法与性能
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../algorithm/benchmark-on-stl/">
<span class="md-ellipsis">
    
  
    STL的一些性能测试
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../algorithm/stl-wheels/">
<span class="md-ellipsis">
    
  
    嗯造轮子
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../algorithm/template-on-numeric-ring/">
<span class="md-ellipsis">
    
  
    整数环取模模板
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
<span class="md-ellipsis">
      
        缘起
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      
        第一章
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      
        第二章
      
    </span>
</a>
<nav aria-label="第二章" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      
        问题的引入
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_5">
<span class="md-ellipsis">
      
        权衡
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_6">
<span class="md-ellipsis">
      
        平衡探索和利用
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_7">
<span class="md-ellipsis">
      
        总结
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_8">
<span class="md-ellipsis">
      
        第三章
      
    </span>
</a>
<nav aria-label="第三章" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mrp">
<span class="md-ellipsis">
      
        MRP
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mdp">
<span class="md-ellipsis">
      
        MDP
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_9">
<span class="md-ellipsis">
      
        第三点五章
      
    </span>
</a>
<nav aria-label="第三点五章" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_10">
<span class="md-ellipsis">
      
        回顾
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_11">
<span class="md-ellipsis">
      
        迁移
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_12">
<span class="md-ellipsis">
      
        算法
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_13">
<span class="md-ellipsis">
      
        第四章
      
    </span>
</a>
<nav aria-label="第四章" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_14">
<span class="md-ellipsis">
      
        策略迭代
      
    </span>
</a>
<nav aria-label="策略迭代" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_15">
<span class="md-ellipsis">
      
        策略评估
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_16">
<span class="md-ellipsis">
      
        策略提升
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_17">
<span class="md-ellipsis">
      
        价值迭代
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_18">
<span class="md-ellipsis">
      
        收敛性证明
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_19">
<span class="md-ellipsis">
      
        第五章
      
    </span>
</a>
<nav aria-label="第五章" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#sarsa">
<span class="md-ellipsis">
      
        Sarsa 算法
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#q-learning">
<span class="md-ellipsis">
      
        Q-learning 算法
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_20">
<span class="md-ellipsis">
      
        在线和离线
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_21">
<span class="md-ellipsis">
      
        第六章
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_22">
<span class="md-ellipsis">
      
        第七章
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_23">
<span class="md-ellipsis">
      
        第八章
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="rl-">RL学习笔记 - 上篇<a class="headerlink" href="#rl-" title="Permanent link">¶</a></h1>
<div class="admonition info">
<p class="admonition-title">📖 阅读信息</p>
<p>阅读时间约 <strong>75</strong> 分钟　|　约 <strong>8729</strong> 字　|　约 <strong>285</strong> 个公式　|　约 <strong>333</strong> 行代码</p>
</div>
<h2 id="_1">缘起<a class="headerlink" href="#_1" title="Permanent link">¶</a></h2>
<p>笔者国庆节返校的某个晚课上看<a href="https://hrl.boyuai.com/">动手学强化学习</a>看得要睡着了，因此准备在这里整理一下笔记让自己打起精神。</p>
<p>笔记的风格和我的其他博客差不多，以打通思路的推理为主，不会搞复制粘贴，因为我看那个教程后面写得有点点缺乏线索……</p>
<p>最近天天看网上 RL 来 RL 去的，一开始不知所云，现在力求搞懂，因此有空就来更新一下~</p>
<p>笔记主要是针对上面那个教程的，大体上也照着其思路写，但是调整了部分顺序和详略以符合我个人的思路线索，也参考了西湖大学赵世钰的《强化学习的数学原理》作为一部分的知识与理论补充。在此向诸位前辈以及 Anna's Archive 致敬。</p>
<p>如果本学期或以后有时间，可以搓一个自动躲弹幕的 THARL (TouHou Agent through Reinforced Learning) 项目来玩玩。</p>
<h2 id="_2">第一章<a class="headerlink" href="#_2" title="Permanent link">¶</a></h2>
<p>简单回顾一下一般的有监督学习任务，我们的目标是经验风险最小化，也就是</p>
<div class="arithmatex">\[
\mathrm{arg}\min_{\theta\quad} \mathbb{E}_{x,t\sim p(x,t)}[\mathcal{L(\theta;x,t)}]
\]</div>
<p>这里的 <span class="arithmatex">\(\theta\)</span> 就是网络参数，也就是我们的优化对象；<span class="arithmatex">\(x,t\sim p(x,t)\)</span> 就是从样本与标签的联合分布中采样一个（样本，标签）对，作为我们的训练数据。在这个数据上面，我们需要定义一个损失函数 <span class="arithmatex">\(\mathcal{L}(\theta;x,t)\)</span> 用来表征我们的网络 <span class="arithmatex">\(\theta\)</span> 能不能尽可能将 <span class="arithmatex">\(x\)</span> 映射到 <span class="arithmatex">\(t\)</span>。最后我们要针对全部（或者对于基于小批量梯度的优化器而言，只需要针对一部分）的经验样本计算出来的损失对其进行最小化。</p>
<p>而强化学习和它有相似也有不同。一个 Agent 处于某个状态 <span class="arithmatex">\(s_{t-1}\)</span>，基于自我策略 <span class="arithmatex">\(\pi\)</span> 做出动作 <span class="arithmatex">\(a_i\)</span>，从而转移到新的状态 <span class="arithmatex">\(s_t\)</span>。这个过程会得到对应的奖励或者惩罚，这种反馈是基于环境固有的。譬如一个下国际象棋的 Agent，会选择将某个位置的国王移到另外一个位置，如果它能够以此避开将军，则能获得一点奖励；如果不能避开或者陷入了不合法的移动，则获得负奖励也就是惩罚（这里的奖励是基于<strong>决策</strong>的）。通过象棋规则带来的约束，就可以使得该 Agent 高效进行学习规则。更进一步，通过设计子力，棋局价值等更高级的奖励（这里的奖励是基于<strong>状态</strong>的），我们就可以让这个 Agent 学习如何赢棋，最后打败国际象棋大师卡斯帕罗夫……</p>
<p>刚刚的过程就描述了 RL 的一步过程，模型探索并从错误中学习。我们现在就可以明确 RL 的目标所在——通过这样一个过程，不断<strong>优化</strong>策略使得自己每一次行动都能规避惩罚并获取<strong>最多</strong>奖励。当然模型的策略并不一定会均等地覆盖所有可能的动作空间，而是对不同的状态和行动有不同的概率出现，也就可以建模成一个分布，被称作其策略的占用度量 <span class="arithmatex">\(\rho_\pi\)</span>。我们希望在这个活动范围内，能够以优化策略的方式最大化奖励 <span class="arithmatex">\(r\)</span>，也就是</p>
<div class="arithmatex">\[
\mathrm{arg}\max_{\pi\quad} \mathbb{E}_{s,a\sim \rho_\pi(s,a)}[r(s,a)]
\]</div>
<p>很像吧，其实形式上可以说和有监督学习没有什么区别，但是区别还是比较大，比如说一个模型可以探索的策略的占用度量会随着策略改变而改变；而我们也不是基于奖励函数直接就来算梯度做梯度上升（有的操作可能没梯度呢）。</p>
<p>不过其实最大的区别是序列性，因为强化学习一步步的转移是有序的，不像端到端学习那样可以随机抽样本算梯度。</p>
<h2 id="_3">第二章<a class="headerlink" href="#_3" title="Permanent link">¶</a></h2>
<h3 id="_4">问题的引入<a class="headerlink" href="#_4" title="Permanent link">¶</a></h3>
<p>本章聚焦 RL 的第一个经典问题：多臂老虎机问题。但是我觉得这个其实不像老虎机，因为要老虎机付费使用但是这个问题赠送了免费额度，因此不如把这个问题建模如下：</p>
<p>你作为一个新人，被舞萌痴好友安利来到了机厅。舞萌的新人可以有免费打歌的额度，我们考虑你有 <span class="arithmatex">\(T\)</span> 次机会免费打歌。由于你是新人并不理解舞萌的谱面难度如何，但是那些简单铺面跟着按还是可以的，因此对于 <span class="arithmatex">\(K\)</span> 个谱面，你有 <span class="arithmatex">\(p_i\)</span> 的概率通过（<span class="arithmatex">\(i=1\dots K\)</span>），也就是服从伯努利分布，但是你并不知道这个概率具体的值，只有每一次玩某个谱面，通过和不通过的区别。</p>
<p>你仅仅是体验，所以只要通过谱面即可，现在你想要<strong>使你合计获得的的通过次数最大化</strong>，可以选择什么策略？</p>
<h3 id="_5">权衡<a class="headerlink" href="#_5" title="Permanent link">¶</a></h3>
<p>这里的权衡很简单，一方面，我们会消耗有限的机会去获取对谱面通过概率的估计值 <span class="arithmatex">\(\hat p_i\)</span>，但是一旦我们足够相信自己的估计，我们就可以逮着那个最大概率使劲薅~</p>
<p>我们可以控制一个比例 <span class="arithmatex">\(\epsilon\)</span> 来权衡到底是走稳健流去接着打自己目前估计出概率最高的谱子，或者探索一下其他谱子万一自己只是一开始手感不好呢……</p>
<p>所以我们每一步生成一个随机数 <span class="arithmatex">\(r\in U(0,1)\)</span>，然后根据 <span class="arithmatex">\(\epsilon\)</span>，进行下面的决策：</p>
<div class="arithmatex">\[
\mathrm{Choice\ of\ index}=
\begin{cases}
    i\mathrm{\ \ for\ \ arg}\max_{i} \hat p_i,\quad &amp;r&gt;\epsilon\\
    \mathrm{Randomly},&amp;r\le \epsilon
\end{cases}
\]</div>
<p>当然每一次选择之后要更新估计的概率池子。</p>
<p>我们怎么看这个策略是否足够好呢，其实可以量化它与我们先验知道的最优解之间的差距，这被称作<strong>懊悔（Regret）</strong>。</p>
<p>这个算法只有一个超参数可调，也就是 <span class="arithmatex">\(\epsilon\)</span>，首先我们可能会选择一个固定的值：</p>
<p><img alt="alt text" src="../image.png"/></p>
<p>但是可见，随着尝试次数的增加，懊悔值也在增加！为什么？当我们积累了足够多的尝试之后，其实已经有足够理由去认为频率是概率的合理估计了，这个时候还以一个固定比例进行随机尝试，就很愚蠢了，假设我们的估计已经收敛，但是每一步增长的懊悔值期望为 <span class="arithmatex">\(\epsilon\times\dfrac{K-1}{K}\)</span>，则总的懊悔值就是 <span class="arithmatex">\(\epsilon T\)</span> 的量级，随着尝试次数线性增长。</p>
<p>那怎么搞呢？我们肯定是让 <span class="arithmatex">\(\epsilon\)</span> 衰减，但是怎么衰减呢？</p>
<p>我们把总懊悔分割成两个部分，第一个是随机抽出来的懊悔，第二个是固定抽出来的懊悔。对于<strong>能够收敛到最优概率的情况</strong>，总懊悔就取决于第一部分，而第一部分能产生的懊悔期望值是固定可以计算的，即：</p>
<div class="arithmatex">\[
\sum_i^T \epsilon_i = O(F(T))\implies \mathrm{Acc.\ Reg.}=O(F(T))
\]</div>
<p>也就是说，我们选取 <span class="arithmatex">\(\epsilon_i\)</span> 作为收敛的级数，就可以让累积懊悔也收敛。</p>
<p>上面那个式子可以用实验验证，刚刚我们看到了 <span class="arithmatex">\(\epsilon\)</span> 是常数的情况，如果换成 <span class="arithmatex">\(\epsilon_i=1/i\)</span>，就可见累积懊悔是对数级增长，而换成 <span class="arithmatex">\(\epsilon_i=1/i^2\)</span> 或者 <span class="arithmatex">\(\epsilon_i=\exp(-i)\)</span> 就可以观察到累积懊悔收敛到常数。</p>
<p>但是前提是<strong>能够收敛到最优概率</strong>上！</p>
<p><img alt="alt text" src="../image-1.png"/></p>
<p>所以我认为课件上“很难找到合适的衰减规划”这句话只说了一半。这个问题的概率可能更加不确定，需要更稳健的打法（毕竟刚刚的分析建立在第二部分的懊悔收敛到0的情况，如果衰减太快可能没法收敛到最优，不能保证收敛性），而在差异大，更简单的情况下，我觉得取指数衰减基本上可以通杀了。</p>
<p>但问题没有消失：如果一开始陷入局部最优了，那你这不就炸了吗，所以有没有更稳健的打法，能够保证累积懊悔能够收敛到一个趋势呢。</p>
<h3 id="_6">平衡探索和利用<a class="headerlink" href="#_6" title="Permanent link">¶</a></h3>
<p>下面介绍 UCB 算法，也就是置信上界法，在引入这个方法之前，我们还是回到之前的那个问题，即：当我们有一系列抽样结果之后，我们是将其视作真实分布进行“利用”，还是认为证据不足而去“探索”新的数据呢？</p>
<p>这就引出了一个问题：怎么样刻画这个“认为证据不足”？也就是在多大的概率下，我们可以断言这个建模足够拟合原有分布？</p>
<p>我们有 Hoeffding's inequality，它能告诉我们答案：考虑 <span class="arithmatex">\([0,1]\)</span> 内独立同分布的随机变量 <span class="arithmatex">\(x_1,\dots, x_n\)</span>，以样本均值 <span class="arithmatex">\(\bar x\)</span> 为原分布均值 <span class="arithmatex">\(\mu\)</span> 的建模，并且引入容差或者说不确定度 <span class="arithmatex">\(u\)</span>，则有以下的概率不等式：</p>
<div class="arithmatex">\[
P(\mu &gt;\bar x + u) \le \exp(-2nu^2)
\]</div>
<p>把这个不等式翻译到问题里面，也就是对于某谱面 <span class="arithmatex">\(a\)</span>，为了控制估计值和真实值之差大于不确定度的概率 <span class="arithmatex">\(P(\mu_a &gt;\bar x_a + u_a)\)</span>，我们可以控制其上界 <span class="arithmatex">\(\exp(-2nu_a^2)\)</span>，把它限制在容忍的概率值 <span class="arithmatex">\(p\)</span> 内。</p>
<p>既然我们已经能够控制逼近均值的精度，那我们可以直接利用估计值的最大值 <span class="arithmatex">\(\mathrm{arg}\max_a\bar x_a + u_a\)</span> 来做选择，这就和前面的概率贪心做法有本质不同：即使最坏情况 <span class="arithmatex">\(\exp(-2nu_a^2)=p\)</span>，我们也可以取 <span class="arithmatex">\(u_a=\sqrt{- \dfrac{\log p}{2n}}\)</span>，随着 <span class="arithmatex">\(n\)</span> 的增长，让 <span class="arithmatex">\(p\to 0\)</span> 就可以实现对分布精确均值的收敛。</p>
<p>这就是 UCB 算法的流程了。具体而言：</p>
<ul>
<li>为了让 <span class="arithmatex">\(p\to 0\)</span>，我们取 <span class="arithmatex">\(p=1/n\)</span>，然后根据现有的均值计算这个<strong>期望奖励上界</strong> <span class="arithmatex">\(U_a(t)=\bar x_a(t)+u(t)=\bar x_a(t)+\sqrt{\dfrac{\log n}{2(n+1)}}\)</span>。</li>
<li>求使其最大的那个 <span class="arithmatex">\(i\)</span> 作为选择。</li>
<li>选择后，更新均值为 <span class="arithmatex">\(\bar x_i(t+1)\)</span>。</li>
</ul>
<p>自然我们也可以改变均值和不确定度两者的配比。</p>
<p><img alt="alt text" src="../image-4.png"/></p>
<p>课件里面给出了其累积懊悔是 <span class="arithmatex">\(O(\log n)\)</span> 级别的结论。事实上，我们对比一下先前的讨论，可以看到虽然其时间复杂度更高，但是可以保证渐进收敛不会炸，如果把一开始那个随机 ε-贪心策略的不收敛情况考虑进来，其实累积的期望懊悔也是线性增长的。有没有可能有更好的算法呢？</p>
<p>没可能了。Lai 和 Robbins 已经证明了<a href="[](https://appliedprobability.blog/2020/11/25/lai-robbins-lower-bound/)">累积懊悔的下界是对数级的</a>。我之前也考虑过让 <span class="arithmatex">\(p\)</span> 趋于 <span class="arithmatex">\(0\)</span> 的速度更快，理论和实验都表明但任何阶数更高的尝试都不能避免探索过少的问题。（如果想做实验的话可以把几个臂的概率差调小一点，这样就更容易让模型收敛到错误的臂上面）</p>
<p>也就是说这个问题是<strong>有解的</strong>，无论是 UCB 算法还是 ε-贪心策略，控制到对数阶就可以做到<strong>探索和利用的平衡</strong>。</p>
<p>教程最后还介绍了 Thompson 采样算法，其实有点像蒙特卡罗采样。刚刚我们是用样本均值估计实际分布均值，而这个算法是根据样本分布估计实际分布。我们的直觉是，<span class="arithmatex">\(\alpha+\beta -2\)</span> 次抽样里面，出现了 <span class="arithmatex">\(\alpha-1\)</span> 次通过和 <span class="arithmatex">\(\beta - 1\)</span> 次不通过，每一次服从概率 <span class="arithmatex">\(p\)</span> 的伯努利分布，那么总概率和 <span class="arithmatex">\(p^{\alpha-1}(1-p)^{\beta-1}\)</span> 成比例。这个形式和 Beta 分布也是成比例的，为此可以选择利用 Beta 分布为目标的概率分布进行建模，然后求均值，就可以找 argmax 做决策了。</p>
<p><img alt="alt text" src="../image-2.png"/></p>
<p>这个算法的想法就更精妙一些，不是先解耦探索和利用两步再进行平衡，而是通过引入一个优秀的归纳偏置，即 Beta 分布，而不同的抽取次数和结果对“探索”和“利用”的共同影响，自然在这个分布里面得到了一体化的建模。这个思想其实和从 GAN 到 VAE 的思想很像。</p>
<p><a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/thompson.pdf">这篇文章</a>表明了 Thompson 采样算法在阶数上也是渐进最优的，并且常数甚至还要低一些。</p>
<p><img alt="alt text" src="../image-3.png"/></p>
<h3 id="_7">总结<a class="headerlink" href="#_7" title="Permanent link">¶</a></h3>
<p>这个名叫<strong>多臂老虎机</strong>的问题展示了强化学习需要权衡的一个问题，感性地理解就是选择更激进或更保守的策略，用术语讲就叫平衡探索和利用。在端到端学习中，我们遇到的类似问题是收敛到鞍点或局部最小，为此我们引入了随机性来解决——可以看到，在强化学习中，我们也只不过是换了种利用随机性的方式而已。</p>
<h2 id="_8">第三章<a class="headerlink" href="#_8" title="Permanent link">¶</a></h2>
<p>第三章主要讲的是马尔可夫过程，首先是比较简单的 Markov 奖励过程 MRP。</p>
<h3 id="mrp">MRP<a class="headerlink" href="#mrp" title="Permanent link">¶</a></h3>
<p>我们考虑一个图 <span class="arithmatex">\(G\)</span>，使用邻接矩阵来 <span class="arithmatex">\(\mathcal{P}\)</span> 描述。具体而言，我们有节点列表 <span class="arithmatex">\(s_i\)</span> 代表当时的<strong>状态</strong>，而 <span class="arithmatex">\(\mathcal{P}_{ij}\)</span> 表征从状态 <span class="arithmatex">\(s_i\)</span> 跳到状态 <span class="arithmatex">\(s_j\)</span> 的概率。</p>
<p>对于每一个状态 <span class="arithmatex">\(s\)</span>，我们可以确定状态本身的奖励 <span class="arithmatex">\(R=r(s)\)</span>。也就是说我们有了一个带点权和边权的有向图。</p>
<p>由于转移概率已经给定，我们需要解决的问题是<strong>选择一个起始的状态，能够使得累积的期望奖励最大</strong>。</p>
<p>但是这个表述有一个隐含的问题：如果所有状态的奖励都是正数，并且大小不一，理论上所有状态累积的奖励都能无上限地增长！</p>
<p>因此我们需要引入一个<strong>衰减因子</strong> <span class="arithmatex">\(\gamma\)</span> 用来控制。具体而言，这个值越大，模型越关注长期奖励，越小模型越关注短期奖励。</p>
<p>这样，<span class="arithmatex">\(t\)</span> 时刻从某个状态 <span class="arithmatex">\(s\)</span> 出发，我们就能够产生一条路径。每一次走一步，就能够产生一个奖励的序列 <span class="arithmatex">\(R_t,R_{t+1},\dots\)</span>。而这条路径的奖励就是 <span class="arithmatex">\(G_t=R_t+\gamma R_{t+1}+\dots\)</span></p>
<p>由于状态的转移是基于概率的，因此每一次产生的路径都不一样，因此我们需要求期望。我们把这个目标叫做某个状态的<strong>价值</strong> <span class="arithmatex">\(V(s)\)</span>，也就是</p>
<div class="arithmatex">\[
\begin{align*}
    V(s)&amp;=\mathbb{E}[G_t|S_t=s]\\
    &amp;=\mathbb{E}[R_t+\gamma R_{t+1}+\dots|S_t=s]\\
    &amp;=R_t+\gamma\mathbb{E}[R_{t+1}+\gamma R_{t+2}+\dots|S_t=s]\\
    &amp;=R_t+\gamma\mathbb{E}[G_{t+1}+\dots|S_t=s]\\
    &amp;=R_t+\gamma\sum_{s_i\in S} p(s_i|s)V(s_i)
\end{align*}
\]</div>
<p>不好意思哈哈，你看这事搞得，怎么一不小心就把 MRP 的贝尔曼方程也一并推导了出来呢……</p>
<p>让我们来解读一下吧。<span class="arithmatex">\(R_t\)</span> 就是当前状态 <span class="arithmatex">\(s\)</span> 的奖励 <span class="arithmatex">\(r(s)\)</span>，而后面那个求和就是计算从当前状态转移到下一状态的概率乘以下一状态的价值函数，也就是所有下一个状态的<strong>期望价值</strong>，最后乘以衰减系数 <span class="arithmatex">\(\gamma\)</span>。</p>
<p>式子的意图还是相当明晰的，甚至我们可以基于转移矩阵把这个贝尔曼方程写成矩阵形式：</p>
<div class="arithmatex">\[
V=R+\gamma \mathcal PV\\
\implies V=(I-\gamma \mathcal P)^{-1}R
\]</div>
<p>这样我们就可以以 <span class="arithmatex">\(O(n^3)\)</span> 的时间复杂度精确求得 <span class="arithmatex">\(V\)</span> 而能够得到每个状态的期望价值了。</p>
<p>让我们假设一种单回合的塔防游戏，你有 <span class="arithmatex">\(n\)</span> 个格子，每个格子可以选择放 <span class="arithmatex">\(k\)</span> 种等级的防御塔，防御塔的等级之和不大于一个给定值。放好之后，敌人来袭，敌人的攻击有概率使得你的防御塔降级或者直接被破坏。需要求解一个最优的放置策略，让自己保留的防御塔等级之和最大。</p>
<p>这是一个非常贴合刚刚提到的 MRP 过程的场景。但是如果你要对此进行精确求解，计算量会达到 <span class="arithmatex">\(n^3k^3\)</span>，即使有 50 个格子 8 种等级，也至少需要计算 64M 次。</p>
<p>并且一开始我们还可能不知道毁伤和击毁的概率，这就需要更大量的计算进行采样。</p>
<p>因此我们需要更高效却不那么精确的算法！具体怎么搞，且听下回分解。</p>
<h3 id="mdp">MDP<a class="headerlink" href="#mdp" title="Permanent link">¶</a></h3>
<p>我们注意到 MRP 类似于“一锤子的买卖”，确定一个状态后，就随着状态转移矩阵在那里随波逐流了。能不能更有主见一点，让模型进行每一步的决策呢？可以的，这就是 Markov 决策过程 MDP。</p>
<p>从定义上，我们可以对刚刚的 MRP 进行修改。首先状态转移矩阵 <span class="arithmatex">\(\mathcal{P}\)</span> 就变成了一个形状为 <code>[N, N, A]</code> 的三维张量，用数学语言说就是 <span class="arithmatex">\(P(s_i|s_j,a)\)</span> 表示从 <span class="arithmatex">\(s_j\)</span> 出发采取动作 <span class="arithmatex">\(a\)</span> 能够到达的概率。我第一次看感觉很离谱，比如动作 <span class="arithmatex">\(a\)</span> 就是从 <span class="arithmatex">\(s_j\)</span> 到 <span class="arithmatex">\(s_i\)</span>，一个确定性的东西为什么要引入概率呢？其实有一个模型叫做冰湖模型，即使我们采取了这样直接的动作，也有可能滑到其他状态去。</p>
<p>对应的，我们也可以把奖励改成矩阵 <span class="arithmatex">\(r(s,a)\)</span>，通过增加对动作的奖励，我们可以修改模型对某些特定动作的偏好。当然我们也可以不加，纯目标导向。</p>
<p>接下来就涉及到最核心的部分：<strong>策略</strong>。智能体的策略是基于状态的行动，也就是 <span class="arithmatex">\(\pi(a|s)=P(A_t=a|S_t=s)\)</span>。如果智能体采用随机的策略，那 <span class="arithmatex">\(\pi\)</span> 就刻画其分布；如果智能体采用确定的策略，那这个分布就变成单点分布。这个分布将状态空间映射到动作空间，自然我们可以使用一个神经网络来拟合这个分布。这就是<strong>深度强化学习</strong>。</p>
<p>现在，我们可以写出基于策略 <span class="arithmatex">\(\pi\)</span> 的状态价值函数：</p>
<div class="arithmatex">\[
V^\pi(s)=\mathbb{E}_{a\sim\pi(a|s)}[G_t|S_t=s]
\]</div>
<p>然后我们可以把这个式子针对每个动作拆开，定义<strong>动作价值函数</strong>为某个动作的价值，也就是<strong>这个动作的回报</strong>加上<strong>动作之后的期望状态价值</strong>：</p>
<div class="arithmatex">\[
Q^\pi(s,a)=\mathbb{E}[G_t|S_t=s,A_t=a]=r(s,a)+\gamma\sum_{s_i\in S}p(s_i|s,a)V^\pi(s_i)
\]</div>
<p>注意到这个时候 <span class="arithmatex">\(Q^\pi\)</span> 和 <span class="arithmatex">\(V^\pi\)</span> 相互依赖，为了像之前的 MRP 一样能够写成方程的形式进行求解，我们需要改写成让它们<strong>依赖于自身</strong>的<strong>自举</strong>形式：</p>
<div class="arithmatex">\[
\begin{align*}
    V^\pi(s)&amp;=\sum_{a\in A}\pi(a|s)Q^\pi(s,a)\\
    &amp;=\sum_{a\in A}\pi(a|s)\left(r(s,a)+\gamma\sum_{s_i\in S}p(s_i|s,a)V^\pi(s_i)\right)\\
    Q^\pi(s,a)&amp;=r(s,a)+\gamma\sum_{s_i\in S}p(s_i|s,a)V^\pi(s_i)\\
    &amp;=r(s,a)+\gamma\sum_{s_i\in S}p(s_i|s,a)\sum_{a\in A}\pi(a|s_i)Q^\pi(s_i,a)
\end{align*}
\]</div>
<p>这被叫做<strong>贝尔曼期望方程</strong>。</p>
<p>对于一个确定的策略 <span class="arithmatex">\(\pi(a|s)\)</span>，我们可以通过<strong>边缘化</strong>的方式将 MDP 转换成已知求解方式的 MRP 来求解。具体而言，某个状态的期望奖励和期望的转移概率可以通过全期望（概率）公式进行计算：</p>
<div class="arithmatex">\[
\begin{align*}
    \hat r(s)&amp;=\sum_{a\in A}\pi(a|s)r(s,a)\\
    \hat P(s_i,s)&amp;=\sum_{a\in A}\pi(a|s)P(s_i|s,a)
\end{align*}
\]</div>
<p>简单说，就是利用分布 <span class="arithmatex">\(\pi(a|s)\)</span> 作为权重进行加权，将奖励矩阵的 <span class="arithmatex">\(a\)</span> 维度拍到 <span class="arithmatex">\(s\)</span> 维度上面，将转移张量的 <span class="arithmatex">\(a\)</span> 维度拍到 <span class="arithmatex">\(s\times s\)</span> 矩阵上面。这样我们就可以转化成 MDP 来求解每一个状态的价值了。</p>
<p>自然这样做需要我们明确除了 <span class="arithmatex">\(V^\pi\)</span> 和 <span class="arithmatex">\(Q^\pi\)</span> 外的策略分布、状态转移矩阵和奖励函数，但一般而言，这些东西基本上都是黑盒，因此我们需要进行采样。也就是基于策略 <span class="arithmatex">\(\pi\)</span> 采样状态路径，并计算估计的 <span class="arithmatex">\(V^\pi(s)\)</span>。</p>
<p>知道了某个策略 <span class="arithmatex">\(\pi\)</span> 对应的状态价值 <span class="arithmatex">\(V^\pi(s)\)</span> 之后，我们就可以考虑优化这个策略，让其价值尽可能高，也就是<strong>贝尔曼最优方程</strong>：</p>
<div class="arithmatex">\[
\begin{align*}
    V^*(s)&amp;=\max_{a\in A}\left(r(s,a)+\gamma\sum_{s_i\in S}p(s_i|s,a)V^*(s_i)\right)\\
    Q^*(s,a)&amp;=r(s,a)+\gamma\sum_{s_i\in S}p(s_i|s,a)\max_{a\in A}Q^*(s_i,a)
\end{align*}
\]</div>
<p>和之前的贝尔曼期望方程比较，其实就是把 <span class="arithmatex">\(\sum_{a\in A}\pi(a|s_i)\)</span> 换成了 <span class="arithmatex">\(\max_{a\in A}\)</span>，也就是从<strong>求期望</strong>变成了<strong>取最优</strong>。</p>
<p>下面的任务，就是对这个贝尔曼最优方程进行求解了。</p>
<p>精确解法请看第四章，基于随机化采样的各种算法请看第三点五章和第五章。</p>
<h2 id="_9">第三点五章<a class="headerlink" href="#_9" title="Permanent link">¶</a></h2>
<p>本章是补充内容，旨在补充讲解蒙特卡洛方法，对应原教程 3.5 节。《动手学强化学习》没有这一章特别详细的内容，提了一嘴之后就在那纠结占用度量，但是我觉得占用度量不是一个特别值得单独讨论的点，因此我就跳过了，本章基于《强化学习的数学原理》补充。</p>
<h3 id="_10">回顾<a class="headerlink" href="#_10" title="Permanent link">¶</a></h3>
<p>从最抽象的意义上说，假设我们有一个随机初始化的策略，怎么样找到最优策略呢？对于状态 <span class="arithmatex">\(s\)</span>，策略给出动作 <span class="arithmatex">\(a\)</span>，我们肯定首先要足够肯定<strong>当前状态对应这个动作的价值是多少</strong>，更要肯定<strong>这个动作是不是带来最大价值的动作</strong>。</p>
<p>回忆一下——这不就是第二章我们讨论过的<strong>多臂老虎机</strong>问题吗！</p>
<h3 id="_11">迁移<a class="headerlink" href="#_11" title="Permanent link">¶</a></h3>
<p>让我们试图把最简单的ε-贪婪算法迁移到这个场景来。</p>
<p>从一个初始的状态-动作组 <span class="arithmatex">\((s,a)\)</span> 开始，我们可以产生长度 <span class="arithmatex">\(T\)</span> 的一系列状态-动作组。倒过来看，我们可以层层向外去累计价值。具体而言，比如说状态-动作组 <span class="arithmatex">\((s_{t},a_{t})\)</span> 能产生的奖励 <span class="arithmatex">\(R_{t}\)</span> 就是 <span class="arithmatex">\(r(s_{t},a_{t})\)</span>，而此时的累积奖励 <span class="arithmatex">\(G_{t}=\gamma G_{t+1}+R_{t+1}\)</span>，就可以倒着一步步求出来。也就是说，走这一趟我们可以求得这个路径为状态-动作组 <span class="arithmatex">\((s_{t},a_{t})\)</span> 带来的总的奖励 <span class="arithmatex">\(R\)</span>。</p>
<p>进而，行动的价值函数 <span class="arithmatex">\(Q(s_t,a_t)\)</span> 就是状态-动作组 <span class="arithmatex">\((s_{t},a_{t})\)</span> 对应的 <span class="arithmatex">\(G\)</span> 的期望，那么计算路径访问的这个组的次数 <span class="arithmatex">\(N_{s_t,a_t}\)</span>，用 <span class="arithmatex">\(R\)</span> 除以这个次数，就可以得到 <span class="arithmatex">\(Q\)</span> 的期望值了。</p>
<p>按先前的贝尔曼最优方程，那我就直接选能使得 <span class="arithmatex">\(Q\)</span> 最大的行动就行了啊……对吗？</p>
<p>现在的问题是，对于状态 <span class="arithmatex">\(s_t\)</span>，我们可以计算对应各个动作估计的价值函数，但这终究是估计，需要<strong>平衡探索与利用</strong>，也就是说，我们不能硬取 <span class="arithmatex">\(\max\)</span> 变成纯贪心，而是选择采用<strong>ε-贪婪策略</strong>：把 <span class="arithmatex">\(\max\)</span> 的那个动作的概率设置成 <span class="arithmatex">\(1-\dfrac{|A(s_t)|-1}{|A(s_t)|}\epsilon\)</span>，其他动作的概率设置成 <span class="arithmatex">\(\dfrac{1}{|A(s_t)|}\epsilon\)</span>。</p>
<p>让我们来看看具体的算法流程吧：</p>
<h3 id="_12">算法<a class="headerlink" href="#_12" title="Permanent link">¶</a></h3>
<p>这个算法叫做 MC ε-Greedy。让我们理一下算法流程：</p>
<ul>
<li>需要策略 <span class="arithmatex">\(\pi\)</span>，动作价值函数 <span class="arithmatex">\(Q(s,a)\)</span>，每对的累计奖励 <span class="arithmatex">\(R(s,a)=0\)</span> 和计数函数 <span class="arithmatex">\(N(s,a)=0\)</span></li>
<li>开始采样：</li>
<li>从某个随机选择的状态-动作对 <span class="arithmatex">\((s_0,a_0)\)</span> 开始，采样一个长度为 <span class="arithmatex">\(T\)</span> 的序列。</li>
<li>初始化累计奖励 <span class="arithmatex">\(G=0\)</span><ul>
<li>对于 <span class="arithmatex">\(t=T-1,T-2,\dots,0\)</span>：</li>
<li>计算序列累计奖励 <span class="arithmatex">\(G\leftarrow \gamma G+r(s_t,a_t)\)</span></li>
<li>计算状态-动作对的累积奖励 <span class="arithmatex">\(R(s_t,a_t)\leftarrow R(s_t,a_t)+G\)</span>，更新计数函数 <span class="arithmatex">\(N(s_t,a_t)\leftarrow N(s_t,a_t)+1\)</span></li>
<li>计算期望值 <span class="arithmatex">\(Q(s_t,a_t)=\dfrac{R(s_t,a_t)}{N(s_t,a_t)}\)</span></li>
<li>改进策略：如果这个 <span class="arithmatex">\(a_t\)</span> 能够使 <span class="arithmatex">\(Q\)</span> 更大，就把这个动作的概率 <span class="arithmatex">\(\pi(a=a_t|s_t)\)</span> 设置成 <span class="arithmatex">\(1-\dfrac{|A(s_t)|-1}{|A(s_t)|}\epsilon\)</span>，其他动作的概率 <span class="arithmatex">\(\pi(a\ne a_t|s_t)\)</span> 设置成 <span class="arithmatex">\(\dfrac{1}{|A(s_t)|}\epsilon\)</span>。</li>
</ul>
</li>
<li>重复上述过程，达到设定的采样次数就停止。</li>
</ul>
<p>这个模型是<strong>无模型</strong>的策略改进算法。也就是说我们可以不先验地预知环境带来的状态转移概率，而是通过采样的序列和对应的奖励来进行学习。同时，我们不知道最后得到的策略是否是最优的。</p>
<p>接下来我们要看的算法是<strong>有模型</strong>的算法，基于给定的状态转移矩阵、奖励函数和策略分布。此时我们能够<strong>确定地</strong>得到最优策略。</p>
<h2 id="_13">第四章<a class="headerlink" href="#_13" title="Permanent link">¶</a></h2>
<p>本章介绍的是动态规划算法，虽然叫这个名字，但其实是贪心算法。</p>
<h3 id="_14">策略迭代<a class="headerlink" href="#_14" title="Permanent link">¶</a></h3>
<p>策略迭代分为两个过程：策略评估和策略提升。</p>
<h4 id="_15">策略评估<a class="headerlink" href="#_15" title="Permanent link">¶</a></h4>
<p>一开始的讨论中，我们得到了 MDP 的贝尔曼期望方程：</p>
<div class="arithmatex">\[
V^\pi(s)=\sum_{a\in A}\pi(a|s)\left(r(s,a)+\gamma\sum_{s_i\in S}p(s_i|s,a)V^\pi(s_i)\right)
\]</div>
<p>之前我们提到，要把这个贝尔曼期望方程写成<strong>自举</strong>的形式，尽管我们并不能像 MRP 一样直接进行解析求解，但注意到这个东西很像<strong>不动点迭代</strong>，也就是说，对于 <span class="arithmatex">\(V^\pi\)</span> 而言，我们根据上面的方程左边赋给右边，直到差值小于容差 <span class="arithmatex">\(\theta\)</span>，就可以计算出当前策略下的全部状态价值 <span class="arithmatex">\(V^*(s)\)</span> 了。</p>
<h4 id="_16">策略提升<a class="headerlink" href="#_16" title="Permanent link">¶</a></h4>
<p>这一步我们直接可以从贝尔曼最优方程导出，对于状态 <span class="arithmatex">\(s\)</span>：</p>
<div class="arithmatex">\[
\pi^*(a|s)=a\mathrm{\quad s.t.\quad}\max_{a\in A}\left(r(s,a)+\gamma\sum_{s_i\in S}p(s_i|s,a)V^*(s_i)\right)
\]</div>
<p>由于策略提升之后，基于策略的状态价值函数就改变了，因此需要重新进行策略评估。</p>
<p>策略提升的终点就是没有更优的策略可以提升了，也就是得到了最优策略。</p>
<h3 id="_17">价值迭代<a class="headerlink" href="#_17" title="Permanent link">¶</a></h3>
<p>我们重新审视一下刚刚利用贝尔曼最优方程的地方，可以发现我们其实把那个 <span class="arithmatex">\(\max\)</span> 的值给丢了，只去找最大的行动去了。</p>
<p>但其实这个值就是当前的最优价值！如果利用好这个信息参与迭代，肯定比重新来做策略评估快。</p>
<p>也就是说，我们只需要对刚刚的策略评估进行一点点修改：</p>
<div class="arithmatex">\[
V^*(s)=\max_{a\in A}\left(r(s,a)+\gamma\sum_{s_i\in S}p(s_i|s,a)V^*(s_i)\right)
\]</div>
<p>对这个状态价值函数进行不动点迭代，直到收敛，就能更快地收敛到最优价值。</p>
<p>最后，我们像先前的策略提升一样，求出这个 <span class="arithmatex">\(\max\)</span> 对应的各个状态的行动即可。</p>
<h3 id="_18">收敛性证明<a class="headerlink" href="#_18" title="Permanent link">¶</a></h3>
<p>请参阅任何一本强化学习教材。这里实在不想纠结于数学的细节了，实际应用上根本不可能有这么简单的白盒场景，而一般的深度强化学习方法还不一定保证收敛呢，这里推导这么多不是扯淡吗……</p>
<h2 id="_19">第五章<a class="headerlink" href="#_19" title="Permanent link">¶</a></h2>
<p>本章讲解时序差分算法，主要是 Sarsa 算法和 Q-learning 算法。在我看来，这两种算法都是基于先前的 MC ε-Greedy 算法的改进。在蒙特卡洛算法中，我们有下面的操作：</p>
<ul>
<li>计算序列累计奖励 <span class="arithmatex">\(G\leftarrow \gamma G+r(s_t,a_t)\)</span></li>
<li>计算状态-动作对的累积奖励 <span class="arithmatex">\(R(s_t,a_t)\leftarrow R(s_t,a_t)+G\)</span>，更新计数函数 <span class="arithmatex">\(N(s_t,a_t)\leftarrow N(s_t,a_t)+1\)</span></li>
<li>计算期望值 <span class="arithmatex">\(Q(s_t,a_t)=\dfrac{R(s_t,a_t)}{N(s_t,a_t)}\)</span></li>
</ul>
<p>实际上，<span class="arithmatex">\(Q\)</span> 的更新式子写开，就是：</p>
<div class="arithmatex">\[
\begin{align*}
    Q'(s_t,a_t)&amp;=\dfrac{R'(s_t,a_t)}{N'(s_t,a_t)}\\
    &amp;=\dfrac{R(s_t,a_t)+\gamma G+r(s_t,a_t)}{N'(s_t,a_t)}\\
    &amp;=\dfrac{N'(s_t,a_t)-1}{N'(s_t,a_t)}Q(s_t,a_t)+\dfrac{\gamma G+r(s_t,a_t)}{N'(s_t,a_t)}\\
    &amp;=Q(s_t,a_t)+\dfrac{1}{N'(s_t,a_t)}[\gamma G+r(s_t,a_t)-Q(s_t,a_t)]
\end{align*}
\]</div>
<p>考虑到我们不一定要像 MC ε-Greedy 那样倒着计算某个序列的累积奖励，这就意味着序列长度 <span class="arithmatex">\(N\)</span> 和累计奖励 <span class="arithmatex">\(G\)</span> 是难以获知的，为此，我们需要用一些已知量进行合理替代。</p>
<p>一方面，序列长度未知，我们就可以用一个类似端到端学习的学习率的量 <span class="arithmatex">\(\alpha\)</span> 来代替 <span class="arithmatex">\(\dfrac{1}{N'(s_t,a_t)}\)</span>。另一方面，既然 <span class="arithmatex">\(G\)</span> 是进行动作 <span class="arithmatex">\((s_t,a_t)\to s_{t+1}\)</span> 后的累积奖励，那么根据<strong>自举形式</strong>的贝尔曼方程，我们就可以利用目标状态 <span class="arithmatex">\(s_{t+1}\)</span> 的动作价值函数来估计这个累积奖励了。这就是<strong>时序差分算法</strong>的含义。也就是</p>
<div class="arithmatex">\[
Q'(s_t,a_t)=Q(s_t,a_t)+\alpha[\gamma Q(s_{t+1},a_{t+1})+r(s_t,a_t)-Q(s_t,a_t)]
\]</div>
<p>现在唯一不知道的就是 <span class="arithmatex">\(a_{t+1}\)</span> 怎么个取法了，而它的取法就基本上决定了本章的 Sarsa 算法和 Q-learning 算法的分野。</p>
<h3 id="sarsa">Sarsa 算法<a class="headerlink" href="#sarsa" title="Permanent link">¶</a></h3>
<p>Sarsa 算法的思想是，既然我要平衡探索和利用，那 <span class="arithmatex">\(a_{t+1}\)</span> 也可以利用 ε-Greedy 策略进行生成。具体而言的算法流程：</p>
<ul>
<li>初始化动作价值函数 <span class="arithmatex">\(Q(s,a)\)</span></li>
<li>基于给定的序列采样次数 <span class="arithmatex">\(T\)</span> 开始循环：<ul>
<li>选择初始状态 <span class="arithmatex">\(s\)</span></li>
<li>在 <span class="arithmatex">\(s\)</span> 的动作空间内，基于多臂老虎机的 ε-Greedy 策略选择一个动作 <span class="arithmatex">\(a\)</span>。</li>
<li>基于设定的时间步 <span class="arithmatex">\(N\)</span> 开始循环：</li>
<li>基于动作 <span class="arithmatex">\(a\)</span> 转移到状态 <span class="arithmatex">\(s'\)</span>，并获得环境奖励 <span class="arithmatex">\(r(s,a)\)</span></li>
<li>在 <span class="arithmatex">\(s'\)</span> 的动作空间内，基于多臂老虎机的 ε-Greedy 策略选择一个动作 <span class="arithmatex">\(a'\)</span>。</li>
<li>进行时序差分估计：<span class="arithmatex">\(Q(s,a)\leftarrow Q(s,a)+\alpha[\gamma Q(s',a')+r(s,a)-Q(s,a)]\)</span></li>
<li>执行更新：<span class="arithmatex">\(s\leftarrow s',a\leftarrow a'\)</span></li>
</ul>
</li>
</ul>
<p>利用 <span class="arithmatex">\(Q(s',a')\)</span> 对 <span class="arithmatex">\(Q(s_{t+1},a_{t+1})\)</span> 进行单步估计是相对比较“慢”的，这是因为 MC 方法固有的特性，因此为了获取更多的数据进行更准确的估计，我们可以把  <span class="arithmatex">\(Q(s_{t+1},a_{t+1})\)</span> 拆开：</p>
<div class="arithmatex">\[
\gamma Q(s_{t+1},a_{t+1})=\gamma r(s_{t+1},a_{t+1})+\gamma^2 (s_{t+2},a_{t+2})+\cdots+\gamma^n Q(s_{t+n},a_{t+n})
\]</div>
<p>这就是<strong>多步 Sarsa 算法</strong>。具体流程如下：</p>
<ul>
<li>初始化动作价值函数 <span class="arithmatex">\(Q(s,a)\)</span></li>
<li>基于给定的序列采样次数 <span class="arithmatex">\(T\)</span> 开始循环：<ul>
<li>选择初始状态 <span class="arithmatex">\(s\)</span></li>
<li>在 <span class="arithmatex">\(s\)</span> 的动作空间内，基于多臂老虎机的 ε-Greedy 策略选择一个动作 <span class="arithmatex">\(a\)</span>。</li>
<li>基于设定的总时间步 <span class="arithmatex">\(N\)</span> 开始循环：</li>
<li>初始化累积奖励 <span class="arithmatex">\(R=0\)</span></li>
<li>基于设定的 Sarsa 步数 <span class="arithmatex">\(n\)</span> 从 <span class="arithmatex">\(i = 1\)</span> 开始循环：<ul>
<li>基于动作 <span class="arithmatex">\(a\)</span> 转移到状态 <span class="arithmatex">\(s'\)</span>，并获得环境奖励 <span class="arithmatex">\(r(s_i,a_i)\)</span></li>
<li>在 <span class="arithmatex">\(s'\)</span> 的动作空间内，基于多臂老虎机的 ε-Greedy 策略选择一个动作 <span class="arithmatex">\(a'\)</span>。</li>
<li>执行更新：<span class="arithmatex">\(s\leftarrow s',a\leftarrow a'\)</span></li>
</ul>
</li>
<li>计算累计奖励 <span class="arithmatex">\(R=\gamma^{n+1}Q(s',a')+\sum_{i=1}^{n}\gamma^i r(s_i,a_i)\)</span></li>
<li>进行时序差分估计：<span class="arithmatex">\(Q(s,a)\leftarrow Q(s,a)+\alpha[R+r(s,a)-Q(s,a)]\)</span></li>
<li>执行更新：<span class="arithmatex">\(s\leftarrow s',a\leftarrow a'\)</span></li>
</ul>
</li>
</ul>
<p>可以看到总时间步不变但多步 Sarsa 算法的估计更精确，收敛也更快。</p>
<h3 id="q-learning">Q-learning 算法<a class="headerlink" href="#q-learning" title="Permanent link">¶</a></h3>
<p>Q-learning 算法选择直接基于贝尔曼最优方程进行估计，因此 <span class="arithmatex">\(a_{t+1}\)</span> 可以直接选择 <span class="arithmatex">\(\max_{a_{t+1}\in A(s_{t+1})} Q(s_{t+1},a_{t+1})\)</span>。但是你可能就要问，说好的“探索与利用的平衡”呢？别急，这就是它作为<strong>离线策略算法</strong>的精髓，先看算法：</p>
<ul>
<li>初始化动作价值函数 <span class="arithmatex">\(Q(s,a)\)</span></li>
<li>基于给定的序列采样次数 <span class="arithmatex">\(T\)</span> 开始循环：<ul>
<li>选择初始状态 <span class="arithmatex">\(s\)</span></li>
<li>基于设定的时间步 <span class="arithmatex">\(N\)</span> 开始循环：</li>
<li>在 <span class="arithmatex">\(s\)</span> 的动作空间内，基于多臂老虎机的 ε-Greedy 策略选择一个动作 <span class="arithmatex">\(a\)</span>。</li>
<li>基于动作 <span class="arithmatex">\(a\)</span> 转移到状态 <span class="arithmatex">\(s'\)</span>，并获得环境奖励 <span class="arithmatex">\(r(s,a)\)</span></li>
<li>进行时序差分估计：<span class="arithmatex">\(Q(s,a)\leftarrow Q(s,a)+\alpha[\gamma \max_{a'}Q(s',a')+r(s,a)-Q(s,a)]\)</span></li>
<li>执行更新：<span class="arithmatex">\(s\leftarrow s'\)</span></li>
</ul>
</li>
</ul>
<p>看，我们是通过第一个 ε-Greedy 策略来保证这个平衡的，因为<strong>你并没有用到这个 max 操作来进行动作选择，而只是去估计动作价值</strong>，这就意味着不会因为 max 而“有失偏颇”。回顾一下多臂老虎机里面，正是因为我们基于估计的最大值进行了<strong>选择</strong>，才会一步错步步错。</p>
<p>在这个场景里面，<strong>所有动作的选择都是基于正确的 ε-Greedy 策略进行的</strong>，而这才能够保证“探索与利用的平衡”。</p>
<h3 id="_20">在线和离线<a class="headerlink" href="#_20" title="Permanent link">¶</a></h3>
<p>这里的“在线”和“离线”其实和 OI 语境的用法类似。在 OI 里面对于多个查询，“离线”做法就是先暂存所有查询，通过分块排序等方式能够使得处理查询的效率更高（莫队算法）；“在线”做法就是强制一个查询对应一个结果，一般可以通过答案互相异或一下来保证查询到结果的顺序性。</p>
<p>在 RL 领域，刚刚提到的 Sarsa 算法就是一个<strong>在线策略算法</strong>，“在线”的意思就是必须直接利用当前的动作对 <span class="arithmatex">\(Q\)</span> 进行更新，也就是说更新 <span class="arithmatex">\(Q(s,a)\)</span> 需要 <span class="arithmatex">\((s,a,s',a',r)\)</span> 这个五元组，而 <span class="arithmatex">\((s',a')\)</span> 又会变成新的 <span class="arithmatex">\((s,a)\)</span>，这就要求一种顺序性。一条道走到黑，不撞南墙不回头。</p>
<p>而 Q-learning 对 <span class="arithmatex">\(Q(s,a)\)</span> 的更新只需要 <span class="arithmatex">\((s,a,s',r)\)</span> 四元组，我们<strong>不需要直接利用当前的动作来做更新</strong>，甚至我们可以通过多个并行的训练场获取大量的 <span class="arithmatex">\((s,a,s',r)\)</span> 四元组数据，然后相互交换数据，由于这种顺序性被打破了，因此就是<strong>离线策略算法</strong>。甚至我们可以手动采样这一四元组而不更新，最后再依靠数据计算 <span class="arithmatex">\(Q\)</span> 的估计值，这有点像先前的 MC ε-Greedy，但也是离线 RL 的雏形。</p>
<h2 id="_21">第六章<a class="headerlink" href="#_21" title="Permanent link">¶</a></h2>
<p>本章主要讲 Dyna-Q 算法，其实就是对 Q-learning 做一点修补。</p>
<p>我们仔细观察上面 Q-learning 的算法会发现，<strong>一个状态只能拿来更新一个 Q 值</strong>。但我们知道 Q-learning 是一个离线策略，有没有更好的办法呢？Dyna-Q 的思想是，既然和环境的交互具有序贯性而难以直接从给定和当前的 <span class="arithmatex">\((s,a)\)</span> 中拿到奖励，那就选择引入一个模型来模拟，即 <span class="arithmatex">\(M(s,a)\sim r(s,a)\)</span>。如果 <span class="arithmatex">\(r(s,a)\)</span> 已知或者容易被模拟，这个方法就能成。所以 Dyna-Q 是一个<strong>有模型版本的 Q-learning</strong>。</p>
<p>也就是说我们在执行状态转移的同时，利用模型来跑几轮模拟（被称作 <strong>Q-planning</strong>），那么在决策时，我们就能够基于更多经验，因而可能获得更准确的 Q 值估计。</p>
<p>所以我们只需要把 Q-planning 加入算法即可。</p>
<ul>
<li>初始化动作价值函数 <span class="arithmatex">\(Q(s,a)\)</span></li>
<li>基于给定的序列采样次数 <span class="arithmatex">\(T\)</span> 开始循环：<ul>
<li>选择初始状态 <span class="arithmatex">\(s\)</span></li>
<li>基于设定的时间步 <span class="arithmatex">\(N\)</span> 开始循环：</li>
<li>在 <span class="arithmatex">\(s\)</span> 的动作空间内，基于多臂老虎机的 ε-Greedy 策略选择一个动作 <span class="arithmatex">\(a\)</span>。</li>
<li>基于动作 <span class="arithmatex">\(a\)</span> 转移到状态 <span class="arithmatex">\(s'\)</span>，并获得环境奖励 <span class="arithmatex">\(r(s,a)\)</span></li>
<li>进行时序差分估计：<span class="arithmatex">\(Q(s,a)\leftarrow Q(s,a)+\alpha[\gamma \max_{a'}Q(s',a')+r(s,a)-Q(s,a)]\)</span></li>
<li>开始 Q-planning，循环指定的计划步数：<ul>
<li>随机选择先前访问过的状态 <span class="arithmatex">\(\hat s\)</span> 和在此状态下执行过的动作 <span class="arithmatex">\(\hat a\)</span>。</li>
<li>利用模型得到奖励 <span class="arithmatex">\(\hat r=M(\hat s,\hat a)\)</span></li>
<li>进行时序差分估计：<span class="arithmatex">\(Q(s,a)\leftarrow Q(s,a)+\alpha[\gamma \max_{a'}Q(s',a')+\hat r-Q(s,a)]\)</span></li>
</ul>
</li>
<li>执行更新：<span class="arithmatex">\(s\leftarrow s'\)</span></li>
</ul>
</li>
</ul>
<h2 id="_22">第七章<a class="headerlink" href="#_22" title="Permanent link">¶</a></h2>
<p>Q-learning 将状态-动作价值建立成一张表，称作** Q 表<strong>。但是对于一个相对复杂的游戏或者现实环境而言，其状态是相当多的。因此我们会遇到相当熟悉的</strong>维度灾难**，而解决方式就是引入神经网络。也就是说，我们引入 <span class="arithmatex">\(Q_\theta(s,a)\)</span> 来拟合状态-价值函数，并且利用神经网络的泛化性对没见过的状态进行合理的价值估计。下面的任务就是对这个网络的优化问题进行建模，然后利用端到端学习的知识进行训练和优化。</p>
<p>回顾 Q-learning 的时序差分公式：<span class="arithmatex">\(Q(s,a)\leftarrow Q(s,a)+\alpha[\gamma \max_{a'}Q(s',a')+r(s,a)-Q(s,a)]\)</span>，而最优策略会使得差分值为0，因此我们的目的就是最小化差分值，也就是把 Q 表换成 Q 网络，并使用 MSE 损失：</p>
<div class="arithmatex">\[
\mathrm{arg}\min_{\theta\quad}[\gamma \max_{a'}Q_\theta(s',a')+r(s,a)-Q_\theta(s,a)]^2
\]</div>
<p>自然我们也需要收集一个 mini-batch 的数据，但是一次状态转移只能产生一组 <span class="arithmatex">\((s',a')\)</span> 怎么办呢？</p>
<p>DQN 给出的解决方案是，我们存储最近 <span class="arithmatex">\(E\)</span> 次的状态转移四元组 <span class="arithmatex">\((s,a,s',a')\)</span>，每次从里面抽样即可。因为这看起来像是在“复习”最近的 <span class="arithmatex">\(E\)</span> 次操作，我们把它叫做<strong>经验重放</strong>，其实类似于有的人干了一天的活然后晚上躺床上像放电影一样回忆这几天的事情……</p>
<p>如果你觉得这就够了，那你可以试一下写写代码，包炸的。（我在这里就不放代码了，因为加了后面的缓解措施照样炸）</p>
<p>从理论分析的角度，原初的 Q-learning 迭代式是一个压缩映射，谱范数小于 1，因此能够收敛到确定值。但在 DQN 中我们是从 Q 网络得到数据拿来更新 Q 网络，而这一过程含有的噪音不一定能够使得迭代的谱范数小于 1，导致谱范数变大，并快速自我恶化。因此 DQN 选择减慢更新 Q 网络的频率，让它炸得不要那么快，最好在开始爆炸之前就训练好。</p>
<p>也就是说我们从经验重放中采样的数据并不会送入目标的 Q 网络 <span class="arithmatex">\(Q_\theta\)</span>，而是会输入一个略微过时的 Q 网络 <span class="arithmatex">\(\hat Q_\theta\)</span>，直到经过一定的时间步之后，再用 <span class="arithmatex">\(Q_\theta\)</span> 更新 <span class="arithmatex">\(\hat{Q}_\theta\)</span>。我们把那个过时一点的网络叫做<strong>目标网络</strong>。</p>
<p><strong>所以 DQN 不是不会训炸，而是有组织有计划、有纪律有目的地炸</strong>。请大家欣赏一下，我在 CartPole-v1 上，利用<strong>纯视觉输入</strong>训练 DQN 的爆炸现场：</p>
<p><img alt="alt text" src="../ema_1.png"/></p>
<p>你可能要问既然大家都用 CartPole 的状态向量喂给 DQN 为什么我要搞视觉模型呢？因为这<strong>更难</strong>，更容易看出模型和算法的缺陷。</p>
<p>不过在此之前，让我们看看算法：</p>
<ul>
<li>初始化动作价值网络 <span class="arithmatex">\(Q_\theta(s,a)\)</span> 和目标网络 <span class="arithmatex">\(\hat Q_\theta(s,a)\leftarrow Q_\theta(s,a)\)</span></li>
<li>基于给定的序列采样次数 <span class="arithmatex">\(T\)</span> 开始循环：<ul>
<li>选择初始状态 <span class="arithmatex">\(s\)</span></li>
<li>基于设定的时间步 <span class="arithmatex">\(N\)</span> 开始循环：</li>
<li>在 <span class="arithmatex">\(s\)</span> 的动作空间内，基于多臂老虎机的 ε-Greedy 策略，利用 <span class="arithmatex">\(Q_\theta\)</span> 选择一个动作 <span class="arithmatex">\(a\)</span>。</li>
<li>基于动作 <span class="arithmatex">\(a\)</span> 转移到状态 <span class="arithmatex">\(s'\)</span>，并获得环境奖励 <span class="arithmatex">\(r(s,a)\)</span>，并放入经验重放池。</li>
<li>在经验重放池里面进行 mini-batch 采样 <span class="arithmatex">\(B\)</span> 个样本，对当前网络 <span class="arithmatex">\(Q_\theta\)</span> 进行时序差分估计：<span class="arithmatex">\(\dfrac{1}{2B}\mathrm{arg}\min_{\theta}[\gamma \max_{a'}\hat Q_\theta(s',a')+r(s,a)-Q_\theta(s,a)]^2\)</span></li>
<li>若经过固定的同步时间，更新目标网络 <span class="arithmatex">\(\hat Q_\theta(s,a)\leftarrow Q_\theta(s,a)\)</span></li>
<li>执行更新：<span class="arithmatex">\(s\leftarrow s'\)</span></li>
</ul>
</li>
</ul>
<p>我们来看看代码实现：</p>
<details>
<summary> Original DQN </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">  1</a></span>
<span class="normal"><a href="#__codelineno-0-2">  2</a></span>
<span class="normal"><a href="#__codelineno-0-3">  3</a></span>
<span class="normal"><a href="#__codelineno-0-4">  4</a></span>
<span class="normal"><a href="#__codelineno-0-5">  5</a></span>
<span class="normal"><a href="#__codelineno-0-6">  6</a></span>
<span class="normal"><a href="#__codelineno-0-7">  7</a></span>
<span class="normal"><a href="#__codelineno-0-8">  8</a></span>
<span class="normal"><a href="#__codelineno-0-9">  9</a></span>
<span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">gymnasium</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gym</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="c1"># 设置随机种子</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImagePreprocessor</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="sd">"""图像预处理类"""</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">)):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="n">img_size</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frame_buffer</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rgb_array</span><span class="p">):</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">        </span><span class="sd">"""预处理单帧图像"""</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb_array</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="c1"># 转换为灰度图</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">'L'</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="c1"># 调整大小</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_size</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="c1"># 转换为numpy数组并归一化</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">img_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="k">return</span> <span class="n">img_array</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">        </span><span class="sd">"""重置帧缓冲区"""</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frame_buffer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="c1"># 用空白帧初始化</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">blank_frame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">frame_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blank_frame</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rgb_array</span><span class="p">):</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">        </span><span class="sd">"""获取当前状态（堆叠4帧）"""</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">processed_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">rgb_array</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frame_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed_frame</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="c1"># 堆叠帧</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_buffer</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Shape: (4, 84, 84)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="k">return</span> <span class="n">state</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="k">class</span><span class="w"> </span><span class="nc">DQN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">    </span><span class="sd">"""深度Q网络"""</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">):</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">DQN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="c1"># 计算卷积层输出尺寸</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">conv_out_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_conv_out</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">conv_out_size</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_conv_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="w">        </span><span class="sd">"""计算卷积层输出尺寸"""</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">shape</span><span class="p">))</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">conv_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">conv_out</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="k">class</span><span class="w"> </span><span class="nc">ReplayBuffer</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">    </span><span class="sd">"""经验回放缓冲区"""</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">):</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">capacity</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">))</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">batch</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">))</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="k">class</span><span class="w"> </span><span class="nc">DQNAgent</span><span class="p">:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">    </span><span class="sd">"""DQN代理"""</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_shape</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span> <span class="o">=</span> <span class="n">n_actions</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_min</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># 稍微降低最小探索率</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_decay</span> <span class="o">=</span> <span class="mf">0.995</span>  <span class="c1"># 保持较慢的衰减</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_target_freq</span> <span class="o">=</span> <span class="mi">500</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="c1"># 网络</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policy_net</span> <span class="o">=</span> <span class="n">DQN</span><span class="p">(</span><span class="n">state_shape</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_net</span> <span class="o">=</span> <span class="n">DQN</span><span class="p">(</span><span class="n">state_shape</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="c1"># 优化器</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="c1"># 经验回放</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">ReplayBuffer</span><span class="p">(</span><span class="mi">50000</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="c1"># 训练步数计数</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steps_done</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">select_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="w">        </span><span class="sd">"""选择动作"""</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="k">if</span> <span class="n">training</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="n">state_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="n">q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_net</span><span class="p">(</span><span class="n">state_tensor</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="k">return</span> <span class="n">q_values</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_epsilon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="w">        </span><span class="sd">"""更新探索率"""</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_decay</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="w">        </span><span class="sd">"""单步训练"""</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="k">return</span> <span class="mf">0.0</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="c1"># 从经验回放中采样</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">next_states</span><span class="p">,</span> <span class="n">dones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="c1"># 转换为张量</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">states</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="n">actions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">rewards</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">next_states</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">next_states</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">dones</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">(</span><span class="n">dones</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="c1"># 计算当前Q值</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">current_q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policy_net</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">actions</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="c1"># 计算目标Q值</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="n">next_q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_net</span><span class="p">(</span><span class="n">next_states</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="n">target_q_values</span> <span class="o">=</span> <span class="n">rewards</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">next_q_values</span> <span class="o">*</span> <span class="o">~</span><span class="n">dones</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="c1"># 计算损失</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">current_q_values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">target_q_values</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="c1"># 优化</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="c1"># 加强梯度裁剪</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="c1"># 更新目标网络</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steps_done</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_done</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_target_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">target_net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policy_net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="c1"># 更新探索率</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_epsilon</span><span class="p">()</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">return</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_dqn_optimized</span><span class="p">(</span><span class="n">total_steps</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="w">    </span><span class="sd">"""优化的训练函数"""</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="c1"># 初始化环境</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">'CartPole-v1'</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="s1">'rgb_array'</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="n">n_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="c1"># 初始化预处理器和代理</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ImagePreprocessor</span><span class="p">()</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="n">agent</span> <span class="o">=</span> <span class="n">DQNAgent</span><span class="p">(</span><span class="n">state_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">),</span> <span class="n">n_actions</span><span class="o">=</span><span class="n">n_actions</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="c1"># 训练变量</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="n">episode_rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="n">episode_losses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="n">current_episode_reward</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="n">current_episode_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="n">loss_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="n">episode_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="c1"># 时间统计</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="n">episode_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="n">last_episode_time</span> <span class="o">=</span> <span class="n">episode_start_time</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="n">state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="n">preprocessor</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="c1"># 获取初始状态</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="n">rgb_array</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="n">state_tensor</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">rgb_array</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"开始优化训练..."</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"初始参数: epsilon=</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">epsilon</span><span class="si">}</span><span class="s2">, lr=3e-5, batch_size=</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_steps</span><span class="p">):</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="c1"># 选择动作</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">select_action</span><span class="p">(</span><span class="n">state_tensor</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="c1"># 执行动作</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="n">next_state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="n">done</span> <span class="o">=</span> <span class="n">terminated</span> <span class="ow">or</span> <span class="n">truncated</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="n">current_episode_reward</span> <span class="o">+=</span> <span class="n">reward</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="c1"># 获取下一状态的图像</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="n">rgb_array</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="n">next_state_tensor</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">rgb_array</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="c1"># 存储经验</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="n">agent</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">state_tensor</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state_tensor</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="c1"># 训练</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">train_step</span><span class="p">()</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">if</span> <span class="n">loss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="n">current_episode_loss</span> <span class="o">+=</span> <span class="n">loss</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="n">loss_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="c1"># 更新状态</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">state_tensor</span> <span class="o">=</span> <span class="n">next_state_tensor</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="c1"># 环境重置</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>            <span class="n">episode_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">current_episode_loss</span> <span class="o">/</span> <span class="n">loss_count</span> <span class="k">if</span> <span class="n">loss_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="n">episode_rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_episode_reward</span><span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>            <span class="n">episode_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>            <span class="c1"># 每10个episode打印详细信息</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="k">if</span> <span class="n">episode_count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_episode_time</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                <span class="n">last_episode_time</span> <span class="o">=</span> <span class="n">current_time</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="n">avg_reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">episode_rewards</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Episode </span><span class="si">{</span><span class="n">episode_count</span><span class="si">}</span><span class="s2">: "</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                      <span class="sa">f</span><span class="s2">"Avg Reward = </span><span class="si">{</span><span class="n">avg_reward</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, "</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                      <span class="sa">f</span><span class="s2">"Epsilon = </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">epsilon</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, "</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                      <span class="sa">f</span><span class="s2">"Avg Loss = </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, "</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                      <span class="sa">f</span><span class="s2">"Time = </span><span class="si">{</span><span class="n">time_elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s"</span><span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="n">state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="n">preprocessor</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="n">rgb_array</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="n">state_tensor</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">rgb_array</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="n">current_episode_reward</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="n">current_episode_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="n">loss_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="k">return</span> <span class="n">agent</span><span class="p">,</span> <span class="n">episode_rewards</span><span class="p">,</span> <span class="n">episode_losses</span><span class="p">,</span> <span class="n">episode_count</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="k">def</span><span class="w"> </span><span class="nf">final_visualization</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="w">    </span><span class="sd">"""最终可视化演示"""</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">'CartPole-v1'</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="s1">'human'</span><span class="p">)</span>  <span class="c1"># 使用human模式进行可视化</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="n">state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>    <span class="n">preprocessor</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>    <span class="n">total_reward</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>    <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">开始最终可视化演示..."</span><span class="p">)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>    <span class="c1"># 切换到评估模式</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="n">agent</span><span class="o">.</span><span class="n">policy_net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="c1"># 运行一个完整回合</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="c1"># 渲染当前状态</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="c1"># 获取当前状态</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="n">rgb_array</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="n">state_tensor</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">rgb_array</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="c1"># 选择动作</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">select_action</span><span class="p">(</span><span class="n">state_tensor</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="c1"># 执行动作</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="n">done</span> <span class="o">=</span> <span class="n">terminated</span> <span class="ow">or</span> <span class="n">truncated</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="n">total_reward</span> <span class="o">+=</span> <span class="n">reward</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="c1"># 记录帧（用于后续分析）</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rgb_array</span><span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>            <span class="c1"># 添加小延迟以便观察</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                <span class="k">break</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"可视化演示结束，总奖励: </span><span class="si">{</span><span class="n">total_reward</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>    <span class="c1"># 切换回训练模式</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="n">agent</span><span class="o">.</span><span class="n">policy_net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="k">return</span> <span class="n">total_reward</span><span class="p">,</span> <span class="n">frames</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_and_save_training_progress</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">"optimized_training_progress.png"</span><span class="p">):</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="w">    </span><span class="sd">"""绘制并保存训练进度图"""</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="c1"># 原始奖励</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Training Rewards per Episode'</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Episode'</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Reward'</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="c1"># 滑动平均奖励</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="n">window</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">window</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="n">moving_avg</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">window</span><span class="p">:</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">))]</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">)),</span> <span class="n">moving_avg</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Moving Average Reward (window=</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">)'</span><span class="p">)</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Episode'</span><span class="p">)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Average Reward'</span><span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="c1"># 损失曲线</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="k">if</span> <span class="n">losses</span><span class="p">:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Training Loss per Episode'</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Episode'</span><span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Loss'</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>    <span class="c1"># 保存图像</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"训练进度图已保存为: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="c1"># 输出统计信息</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">训练统计:"</span><span class="p">)</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"总回合数: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"平均奖励: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"最大奖励: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"最小奖励: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"最近10回合平均奖励: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="c1"># ========== 一键切换设备 ==========</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="c1"># 只需修改下面这一行：</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">)</span>  <span class="c1"># 自动选择</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>    <span class="c1"># device = torch.device("cpu")  # 强制使用CPU</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="c1"># device = torch.device("cuda")  # 强制使用GPU（如果有）</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="c1"># ==================================</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"使用设备: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>    <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'cuda'</span><span class="p">:</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"GPU名称: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="c1"># 开始训练</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="n">trained_agent</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">episode_count</span> <span class="o">=</span> <span class="n">train_dqn_optimized</span><span class="p">(</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="n">total_steps</span><span class="o">=</span><span class="mi">400000</span><span class="p">,</span>  <span class="c1"># 增加总训练步数</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="n">device</span><span class="o">=</span><span class="n">device</span>  <span class="c1"># 传递设备参数</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="p">)</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">训练完成!"</span><span class="p">)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"总训练时间: </span><span class="si">{</span><span class="n">total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">秒"</span><span class="p">)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"总回合数: </span><span class="si">{</span><span class="n">episode_count</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"平均每回合时间: </span><span class="si">{</span><span class="n">total_time</span><span class="o">/</span><span class="n">episode_count</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">秒"</span><span class="p">)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="c1"># 绘制并保存训练进度</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="n">plot_and_save_training_progress</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="s2">"optimized_training_progress.png"</span><span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="c1"># 保存模型</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">trained_agent</span><span class="o">.</span><span class="n">policy_net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">'optimized_dqn_cartpole_model.pth'</span><span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"模型已保存为: optimized_dqn_cartpole_model.pth"</span><span class="p">)</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="c1"># 最终可视化演示</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ImagePreprocessor</span><span class="p">()</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="n">final_reward</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">final_visualization</span><span class="p">(</span><span class="n">trained_agent</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"最终可视化演示奖励: </span><span class="si">{</span><span class="n">final_reward</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">训练被用户中断"</span><span class="p">)</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"训练过程中出现错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<p>这是效果：</p>
<p><img alt="alt text" src="../best_cartpole_demo.gif"/></p>
<h2 id="_23">第八章<a class="headerlink" href="#_23" title="Permanent link">¶</a></h2>
<p><img alt="alt text" src="../image-5.png"/></p>
<div class="admonition info">
<p class="admonition-title">📝 如果您需要引用本文</p>
<p>Yan Li. (Oct. 22, 2025). RL学习笔记 - 上篇 [Blog post]. Retrieved from <a href="https://dicaeopolis.github.io/DNN/RL">https://dicaeopolis.github.io/DNN/RL</a></p>
<p>在 BibTeX 格式中：
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span>
<span class="normal"><a href="#__codelineno-1-5">5</a></span>
<span class="normal"><a href="#__codelineno-1-6">6</a></span>
<span class="normal"><a href="#__codelineno-1-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>@online{RL,
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    title={RL学习笔记 - 上篇},
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>    author={Yan Li},
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>    year={2025},
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>    month={Oct},
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>    url={\url{https://dicaeopolis.github.io/DNN/RL}},
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>}
</code></pre></div></td></tr></table></div></p>
</div>
<form class="md-feedback" hidden="" name="feedback">
<fieldset>
<legend class="md-feedback__title">
        Was this page helpful?
      </legend>
<div class="md-feedback__inner">
<div class="md-feedback__list">
<button class="md-feedback__icon md-icon" data-md-value="1" title="This page was helpful" type="submit">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"></path></svg>
</button>
<button class="md-feedback__icon md-icon" data-md-value="0" title="This page could be improved" type="submit">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"></path></svg>
</button>
</div>
<div class="md-feedback__note">
<div data-md-value="1" hidden="">
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
<div data-md-value="0" hidden="">
              
              
                
              
              
              
                
                
              
              Thanks for your feedback! Help us improve this page by using our <a href="..." rel="noopener" target="_blank">feedback form</a>.
            </div>
</div>
</div>
</fieldset>
</form>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "content.code.select", "navigation.titles", "navigation.tabs", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script src="../../assets/js/custom.js"></script>
<script src="../../themes/js/custom.js"></script>
<script src="../../themes/js/simpleLightbox.min.js"></script>
<script src="../../themes/js/optionalConfig.js"></script>
<script src="../../themes/js/mermaidloader.js"></script>
<script src="../../themes/js/umlconvert.js"></script>
<script src="../../themes/js/mathjax.js"></script>
<script src="../../themes/js/katex.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.17.1/flowchart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mermaid-js/mermaid-mindmap@9.3.0/dist/diagram-definition.0faef4c2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-plantuml@1.4.1/index.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml-full.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-svg-full.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
</body>
</html>