
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../S-and-D-models-replication/" rel="prev"/>
<link href="../DC-GAN-%E8%80%81%E5%A9%86%E7%94%9F%E6%88%90%E5%99%A8/" rel="next"/>
<link href="../../../favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.22" name="generator"/>
<title>图像分类相关模型复现手记 - Dicaeopolis' Wiki</title>
<link href="../../../assets/stylesheets/main.84d31ad4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../themes/css/custom.css" rel="stylesheet"/>
<link href="../../../themes/css/simpleLightbox.min.css" rel="stylesheet"/>
<link href="../../../themes/css/pied_piper.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" rel="stylesheet"/>
<link href="../../../stylesheets/customize.css" rel="stylesheet"/>
<link href="../../../assets/css/custom.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="Dicaeopolis' Wiki" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="Dicaeopolis' Wiki">
<img alt="logo" src="../../../favicon.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Dicaeopolis' Wiki
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              图像分类相关模型复现手记
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg>
</label>
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
    
  
  深度神经网络

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../campus-sources/">
          
  
  
    
  
  校内课程知识

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../misc/">
          
  
  
    
  
  配置和杂谈笔记

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../algorithm/">
          
  
  
    
  
  传统算法与性能

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Dicaeopolis' Wiki" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="Dicaeopolis' Wiki">
<img alt="logo" src="../../../favicon.png"/>
</a>
    Dicaeopolis' Wiki
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    深度神经网络
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_1_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_1">
<span class="md-nav__icon md-icon"></span>
            深度神经网络
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../RL/">
<span class="md-ellipsis">
    RL学习笔记 - 上篇
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../SVM_SMO/">
<span class="md-ellipsis">
    SMO 算法的推导
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="0">
<span class="md-ellipsis">
    Wp
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_4">
<span class="md-nav__icon md-icon"></span>
            Wp
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../WP/aiwp/">
<span class="md-ellipsis">
    MISC-AI 方向 WriteUp
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../model-attack/">
<span class="md-ellipsis">
    深度学习模型攻击理论与复现归档
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_5" id="__nav_1_5_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_5">
<span class="md-nav__icon md-icon"></span>
            深度学习模型攻击理论与复现归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/hsja/">
<span class="md-ellipsis">
    HSJA 攻击
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/BadNets/">
<span class="md-ellipsis">
    BadNets
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/CandW/">
<span class="md-ellipsis">
    C&amp;W 攻击
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/pgd/">
<span class="md-ellipsis">
    PGD 攻击
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/fgsm/">
<span class="md-ellipsis">
    FGSM 攻击
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_1_6" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    深度学习相关模型理论与复现归档
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_6" id="__nav_1_6_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_1_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_6">
<span class="md-nav__icon md-icon"></span>
            深度学习相关模型理论与复现归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../DDPM/">
<span class="md-ellipsis">
    扩散模型理论篇: 从多阶段变分自编码器到概率流常微分方程采样器系列
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../S-and-D-models-replication/">
<span class="md-ellipsis">
    图像语义分割和目标检测相关模型复现手记
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    图像分类相关模型复现手记
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    图像分类相关模型复现手记
    
  </span>
</a>
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      复现使用的代码框架
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mlp">
<span class="md-ellipsis">
      MLP
    </span>
</a>
<nav aria-label="MLP" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mlp_1">
<span class="md-ellipsis">
      MLP 模型的训练结果展示
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mlp_2">
<span class="md-ellipsis">
      对 MLP 模型的解读和评述
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cnn">
<span class="md-ellipsis">
      CNN
    </span>
</a>
<nav aria-label="CNN" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cnn_1">
<span class="md-ellipsis">
      CNN 模型的训练结果展示
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cnn_2">
<span class="md-ellipsis">
      对 CNN 模型的解读和评述
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resnet">
<span class="md-ellipsis">
      ResNet
    </span>
</a>
<nav aria-label="ResNet" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#resnet-18">
<span class="md-ellipsis">
      ResNet-18 模型的训练结果展示
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resnet-18_1">
<span class="md-ellipsis">
      对 ResNet-18 模型的解读和评述
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vit">
<span class="md-ellipsis">
      ViT
    </span>
</a>
<nav aria-label="ViT" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vit_1">
<span class="md-ellipsis">
      ViT 模型的训练结果展示
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vit_2">
<span class="md-ellipsis">
      对 ViT 模型的解读和评述
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#patch-based-lstm">
<span class="md-ellipsis">
      Patch based LSTM
    </span>
</a>
<nav aria-label="Patch based LSTM" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#patch-based-lstm_1">
<span class="md-ellipsis">
      Patch based LSTM 训练结果展示
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#patch-based-lstm_2">
<span class="md-ellipsis">
      对 Patch based LSTM 的解读和评述
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vae">
<span class="md-ellipsis">
      VAE
    </span>
</a>
<nav aria-label="VAE" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#aka">
<span class="md-ellipsis">
      动漫风格头像生成 a.k.a. 画老婆
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      无监督聚类
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cvae">
<span class="md-ellipsis">
      CVAE
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cvae_1">
<span class="md-ellipsis">
      CVAE 接分类头
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gan">
<span class="md-ellipsis">
      GAN
    </span>
</a>
<nav aria-label="GAN" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dc-gan">
<span class="md-ellipsis">
      拿 DC-GAN 画老婆
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ac-gan">
<span class="md-ellipsis">
      AC-GAN 分类
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      总结
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../DC-GAN-%E8%80%81%E5%A9%86%E7%94%9F%E6%88%90%E5%99%A8/">
<span class="md-ellipsis">
    DC-GAN 老婆生成器
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_7" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../optimizer/">
<span class="md-ellipsis">
    优化器
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_7" id="__nav_1_7_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_7">
<span class="md-nav__icon md-icon"></span>
            优化器
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/misc/">
<span class="md-ellipsis">
    后续的写作计划
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/SignGD/">
<span class="md-ellipsis">
    符号梯度下降
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/Adaptive/">
<span class="md-ellipsis">
    自适应学习率改进策略
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/SGD/">
<span class="md-ellipsis">
    SGD 系列算法
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../campus-sources/">
<span class="md-ellipsis">
    校内课程知识
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            校内课程知识
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/SDC_assignments/">
<span class="md-ellipsis">
    《计算机组成原理》理论课程作业与笔记归档
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/Descrete_assignments/">
<span class="md-ellipsis">
    《离散数学》课程作业与笔记归档
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/PU_Bii_assignments/">
<span class="md-ellipsis">
    《大学物理B下》课程作业与笔记归档
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/Prob_Stats_assignments/">
<span class="md-ellipsis">
    《概率论与数理统计》课程作业与笔记归档
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/binmul/">
<span class="md-ellipsis">
<i class="fas fa-calculator"></i> 二进制乘法可视化工具
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/textbook/">
<span class="md-ellipsis">
    本科教科书电子资源
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/ds-keynote/">
<span class="md-ellipsis">
    《数据结构》划重点笔记
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/ds-write-up/">
<span class="md-ellipsis">
    《数据结构》期末复习题题解
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/autosignin/">
<span class="md-ellipsis">
    自动签到脚本
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../misc/">
<span class="md-ellipsis">
    配置和杂谈笔记
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            配置和杂谈笔记
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../misc/test/">
<span class="md-ellipsis">
    功能测试页面
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../algorithm/">
<span class="md-ellipsis">
    传统算法与性能
    
  </span>
</a>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            传统算法与性能
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../algorithm/benchmark-on-stl/">
<span class="md-ellipsis">
    STL的一些性能测试
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../algorithm/stl-wheels/">
<span class="md-ellipsis">
    嗯造轮子
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../algorithm/template-on-numeric-ring/">
<span class="md-ellipsis">
    整数环取模模板
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      复现使用的代码框架
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mlp">
<span class="md-ellipsis">
      MLP
    </span>
</a>
<nav aria-label="MLP" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#mlp_1">
<span class="md-ellipsis">
      MLP 模型的训练结果展示
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mlp_2">
<span class="md-ellipsis">
      对 MLP 模型的解读和评述
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cnn">
<span class="md-ellipsis">
      CNN
    </span>
</a>
<nav aria-label="CNN" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cnn_1">
<span class="md-ellipsis">
      CNN 模型的训练结果展示
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cnn_2">
<span class="md-ellipsis">
      对 CNN 模型的解读和评述
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resnet">
<span class="md-ellipsis">
      ResNet
    </span>
</a>
<nav aria-label="ResNet" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#resnet-18">
<span class="md-ellipsis">
      ResNet-18 模型的训练结果展示
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resnet-18_1">
<span class="md-ellipsis">
      对 ResNet-18 模型的解读和评述
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vit">
<span class="md-ellipsis">
      ViT
    </span>
</a>
<nav aria-label="ViT" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vit_1">
<span class="md-ellipsis">
      ViT 模型的训练结果展示
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vit_2">
<span class="md-ellipsis">
      对 ViT 模型的解读和评述
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#patch-based-lstm">
<span class="md-ellipsis">
      Patch based LSTM
    </span>
</a>
<nav aria-label="Patch based LSTM" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#patch-based-lstm_1">
<span class="md-ellipsis">
      Patch based LSTM 训练结果展示
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#patch-based-lstm_2">
<span class="md-ellipsis">
      对 Patch based LSTM 的解读和评述
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#vae">
<span class="md-ellipsis">
      VAE
    </span>
</a>
<nav aria-label="VAE" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#aka">
<span class="md-ellipsis">
      动漫风格头像生成 a.k.a. 画老婆
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      无监督聚类
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cvae">
<span class="md-ellipsis">
      CVAE
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cvae_1">
<span class="md-ellipsis">
      CVAE 接分类头
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gan">
<span class="md-ellipsis">
      GAN
    </span>
</a>
<nav aria-label="GAN" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dc-gan">
<span class="md-ellipsis">
      拿 DC-GAN 画老婆
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ac-gan">
<span class="md-ellipsis">
      AC-GAN 分类
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      总结
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="_1">图像分类相关模型复现手记<a class="headerlink" href="#_1" title="Permanent link">¶</a></h1>
<div class="admonition info">
<p class="admonition-title">📖 阅读信息</p>
<p>阅读时间约 <strong>128</strong> 分钟　|　约 <strong>13908</strong> 字　⚠️ 万字长文，请慢慢阅读　|　约 <strong>223</strong> 个公式　|　约 <strong>3656</strong> 行代码</p>
</div>
<p>这是模型复现手记的第一篇，主要挑几个经典或者邪门的图像分类模型进行复现。相关模型的架构和理论在网上都有诸多的讨论了，本文就仅做简单的推导而已。</p>
<p>前面的 MLP, CNN, ResNet, ViT 都是经典的图像分类模型，后面准备介绍的是几个邪门的模型，即参考 ViT 思想的 Patch based LSTM 以及两个半监督的生成模型，即 VAE 和 AC-GAN。邪门模型之所以邪门，主要在于它能给我一种初看觉得 “卧槽这也能编码图像数据做分类” 而细看又觉得 “怎么这么合理啊” 的感觉。</p>
<p>而本文正是基于笔者对模型架构的认知，针对复现时遇到的许多现象提出自己的理解。因此必然会有值得商榷之处。也欢迎大家在评论区讨论。</p>
<h2 id="_2">复现使用的代码框架<a class="headerlink" href="#_2" title="Permanent link">¶</a></h2>
<p>除了后面的生成式模型，本文的一系列复现基于下面的代码，代码运行在 Kaggle 的 Jupyter Notebook 上面。所以我根据 Notebook 的每一个 Cell 来给出代码。</p>
<p>这个代码框架的大致介绍是：通过模型暴露的一个接口函数 <code>get_model_on_device()</code> 获取模型实例，然后使用 hyperopt 框架，在 CIFAR-10 数据集上分割 20% 数据用以对模型进行全局学习率和训练轮次的早停法调参；获取最优参数后，在全量数据上进行训练，最后收集训练信息得到结果和部分数据变化的可视化图像。</p>
<p>由于每一次都要花大量时间寻找合适的学习率，笔者花了一天时间研究了一下 muP（<a href="https://arxiv.org/abs/2203.03466">Paper link here</a>） 的原理以及怎样迁移学习率，结论：在已有数据上（MLP, CNN, ResNet-18）进行的实验和相关理论计算证明，模型架构（残差连接，BN 等）会影响损失地形（<a href="https://arxiv.org/pdf/1712.09913">Paper link here</a>），导致跨架构的学习率迁移失效。其实很明显，比如微调 ResNet 就比从零训练 ResNet 的 best LR更低，因为预训练权重已经在一个最小值附近了，损失地形比起随机点位更平坦。所以该花时间调参还得花时间调参。不过，可以考虑在小宽度模型上再 scale up，这样就符合 muP 的初心了。具体的实验过程，还请大家参阅后文。不过笔者在这上面探索不多，毕竟主要做的是跨架构的复现工作。后面的训练确实得花比较多的时间粗调学习率。</p>
<p>当然，这个框架也有缺陷，主要是它只能对端到端的网络进行一键式训练和评估，像 VAE 和 AC-GAN 这种标签辅助的生成网络，就需要自行修改了。</p>
<p>下面是每一个 Cell 的代码：</p>
<!-- 这里提供可供复制的折叠代码块模板。
<details>

<summary>  </summary>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>
</code></pre></div></td></tr></table></div>

</details>
-->
<details>
<summary> Cell 1: 引入必要的库以及设置设备 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">transforms</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">random_split</span><span class="p">,</span> <span class="n">Subset</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1"># 导入 hyperopt 用于超参数调优</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">hyperopt</span><span class="w"> </span><span class="kn">import</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">tpe</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">Trials</span><span class="p">,</span> <span class="n">STATUS_OK</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="c1"># 导入 tqdm，在 jupyter 中使用 notebook 版本</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="c1"># torch.manual_seed(3407) is all you need!</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="c1"># 为了实验复现性使用的手动种子。</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">3407</span><span class="p">)</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="c1"># 设置设备</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span><span class="p">)</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"using device: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> Cell 2: 调优和训练使用的参数 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># --- Hyperopt 调优参数 ---</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="n">TUNE_DATA_PERCENT</span> <span class="o">=</span> <span class="mf">0.2</span>     <span class="c1"># 使用 20% 的数据进行快速调优</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="n">TUNE_MAX_EPOCHS</span> <span class="o">=</span> <span class="mi">50</span>        <span class="c1"># 调优时，每个试验最多训练的 epoch 数</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="n">PATIENCE</span> <span class="o">=</span> <span class="mi">5</span>                <span class="c1"># 早停法：验证损失连续 5 个 epoch 没有改善就停止</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="n">MAX_EVALS</span> <span class="o">=</span> <span class="mi">20</span>              <span class="c1"># 调优总共尝试的次数</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="n">LR_SEARCH_RANGE</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># 学习率对数搜索范围，也就是 exp(-4)~exp(-10) 大概 2e-2 到4e-5 之间</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="c1"># --- 最终训练参数，这里只是声明，具体值由调优过程决定 ---</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="n">BEST_LEARNING_RATE</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="n">BEST_EPOCHS</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">128</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> Cell 3: 绘图和评估相关函数 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span>
<span class="normal"><a href="#__codelineno-3-29">29</a></span>
<span class="normal"><a href="#__codelineno-3-30">30</a></span>
<span class="normal"><a href="#__codelineno-3-31">31</a></span>
<span class="normal"><a href="#__codelineno-3-32">32</a></span>
<span class="normal"><a href="#__codelineno-3-33">33</a></span>
<span class="normal"><a href="#__codelineno-3-34">34</a></span>
<span class="normal"><a href="#__codelineno-3-35">35</a></span>
<span class="normal"><a href="#__codelineno-3-36">36</a></span>
<span class="normal"><a href="#__codelineno-3-37">37</a></span>
<span class="normal"><a href="#__codelineno-3-38">38</a></span>
<span class="normal"><a href="#__codelineno-3-39">39</a></span>
<span class="normal"><a href="#__codelineno-3-40">40</a></span>
<span class="normal"><a href="#__codelineno-3-41">41</a></span>
<span class="normal"><a href="#__codelineno-3-42">42</a></span>
<span class="normal"><a href="#__codelineno-3-43">43</a></span>
<span class="normal"><a href="#__codelineno-3-44">44</a></span>
<span class="normal"><a href="#__codelineno-3-45">45</a></span>
<span class="normal"><a href="#__codelineno-3-46">46</a></span>
<span class="normal"><a href="#__codelineno-3-47">47</a></span>
<span class="normal"><a href="#__codelineno-3-48">48</a></span>
<span class="normal"><a href="#__codelineno-3-49">49</a></span>
<span class="normal"><a href="#__codelineno-3-50">50</a></span>
<span class="normal"><a href="#__codelineno-3-51">51</a></span>
<span class="normal"><a href="#__codelineno-3-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="sd">"""评估模型，返回平均损失和准确率"""</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>            <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>            <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>            <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>            <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="n">total</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>    <span class="n">accuracy</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a>    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">accuracy</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">count_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="sd">"""计算模型的可训练参数数量"""</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_and_save_history</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">"training_curves.png"</span><span class="p">):</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">    </span><span class="sd">"""绘制并保存训练过程中的损失和准确率曲线"""</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a>
<a id="__codelineno-3-30" name="__codelineno-3-30"></a>    <span class="c1"># 绘制损失曲线 (训练 vs 验证/测试)</span>
<a id="__codelineno-3-31" name="__codelineno-3-31"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">'train_loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Training Loss'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
<a id="__codelineno-3-32" name="__codelineno-3-32"></a>    <span class="k">if</span> <span class="s1">'val_loss'</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
<a id="__codelineno-3-33" name="__codelineno-3-33"></a>        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Validation Loss'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
<a id="__codelineno-3-34" name="__codelineno-3-34"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Loss over Epochs'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-3-35" name="__codelineno-3-35"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Epoch'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<a id="__codelineno-3-36" name="__codelineno-3-36"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Loss'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<a id="__codelineno-3-37" name="__codelineno-3-37"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-38" name="__codelineno-3-38"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-3-39" name="__codelineno-3-39"></a>
<a id="__codelineno-3-40" name="__codelineno-3-40"></a>    <span class="c1"># 绘制准确率曲线</span>
<a id="__codelineno-3-41" name="__codelineno-3-41"></a>    <span class="k">if</span> <span class="s1">'val_accuracy'</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
<a id="__codelineno-3-42" name="__codelineno-3-42"></a>        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_accuracy'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Validation Accuracy'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'orange'</span><span class="p">)</span>
<a id="__codelineno-3-43" name="__codelineno-3-43"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Accuracy over Epochs'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-3-44" name="__codelineno-3-44"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Epoch'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<a id="__codelineno-3-45" name="__codelineno-3-45"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Accuracy (%)'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<a id="__codelineno-3-46" name="__codelineno-3-46"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-47" name="__codelineno-3-47"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-3-48" name="__codelineno-3-48"></a>
<a id="__codelineno-3-49" name="__codelineno-3-49"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-3-50" name="__codelineno-3-50"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
<a id="__codelineno-3-51" name="__codelineno-3-51"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Traing curve saved at </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-52" name="__codelineno-3-52"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> Cell 4: 定义模型 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="sd">"""</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="sd">这里使用 MLP 作为示例。为了保证框架和模型解耦，统一只暴露一个 get_model_on_device 的无参数函数用以返回新的模型实例。</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="sd">"""</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="c1"># 模型结构参数</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="n">INPUT_SIZE</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">3</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="n">HIDDEN_SIZE_1</span> <span class="o">=</span> <span class="mi">512</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="n">HIDDEN_SIZE_2</span> <span class="o">=</span> <span class="mi">256</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">MLP</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size_1</span><span class="p">,</span> <span class="n">hidden_size_2</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MLP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span> <span class="c1"># 将 3x32x32 的图像展平成一维向量</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size_1</span><span class="p">),</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size_1</span><span class="p">,</span> <span class="n">hidden_size_2</span><span class="p">),</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size_2</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>        <span class="p">)</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="c1"># 对外接口，方便后续实验改模型结构</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_model_on_device</span><span class="p">():</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>    <span class="k">return</span> <span class="n">MLP</span><span class="p">(</span><span class="n">INPUT_SIZE</span><span class="p">,</span> <span class="n">HIDDEN_SIZE_1</span><span class="p">,</span> <span class="n">HIDDEN_SIZE_2</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> Cell 5: 加载并划分数据集 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span>
<span class="normal"><a href="#__codelineno-5-32">32</a></span>
<span class="normal"><a href="#__codelineno-5-33">33</a></span>
<span class="normal"><a href="#__codelineno-5-34">34</a></span>
<span class="normal"><a href="#__codelineno-5-35">35</a></span>
<span class="normal"><a href="#__codelineno-5-36">36</a></span>
<span class="normal"><a href="#__codelineno-5-37">37</a></span>
<span class="normal"><a href="#__codelineno-5-38">38</a></span>
<span class="normal"><a href="#__codelineno-5-39">39</a></span>
<span class="normal"><a href="#__codelineno-5-40">40</a></span>
<span class="normal"><a href="#__codelineno-5-41">41</a></span>
<span class="normal"><a href="#__codelineno-5-42">42</a></span>
<span class="normal"><a href="#__codelineno-5-43">43</a></span>
<span class="normal"><a href="#__codelineno-5-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1"># 数据集参数</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="c1"># 定义数据预处理</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>        <span class="p">(</span><span class="mf">0.4914</span><span class="p">,</span> <span class="mf">0.4822</span><span class="p">,</span> <span class="mf">0.4465</span><span class="p">),</span> 
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>        <span class="p">(</span><span class="mf">0.2023</span><span class="p">,</span> <span class="mf">0.1994</span><span class="p">,</span> <span class="mf">0.2010</span><span class="p">)</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="p">)</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="p">])</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="c1"># 加载完整的 CIFAR-10 训练集</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="n">full_train_dataset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>    <span class="n">root</span><span class="o">=</span><span class="s1">'./data'</span><span class="p">,</span> 
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>    <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>    <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> 
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>    <span class="n">download</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="p">)</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="c1"># --- 为调优创建小规模数据集 ---</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="n">num_total_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_train_dataset</span><span class="p">)</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="n">tune_subset_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_total_train</span> <span class="o">*</span> <span class="n">TUNE_DATA_PERCENT</span><span class="p">)</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="c1"># 随机抽取 20% 的数据索引</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="n">num_total_train</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="n">tune_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">tune_subset_size</span><span class="p">]</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="c1"># 创建一个只包含这 20% 数据的数据集子集</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="n">tune_dataset</span> <span class="o">=</span> <span class="n">Subset</span><span class="p">(</span><span class="n">full_train_dataset</span><span class="p">,</span> <span class="n">tune_indices</span><span class="p">)</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="c1"># 将这个子集再划分为训练集和验证集 (80% train, 20% val)</span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="n">num_tune</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tune_dataset</span><span class="p">)</span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="n">val_size_tune</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_tune</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a><span class="n">train_size_tune</span> <span class="o">=</span> <span class="n">num_tune</span> <span class="o">-</span> <span class="n">val_size_tune</span>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a><span class="n">train_subset_tune</span><span class="p">,</span> <span class="n">val_subset_tune</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span><span class="n">tune_dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">train_size_tune</span><span class="p">,</span> <span class="n">val_size_tune</span><span class="p">])</span>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="c1"># 创建用于调优的数据加载器</span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="n">train_loader_tune</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_subset_tune</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="n">val_loader_tune</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">val_subset_tune</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-5-41" name="__codelineno-5-41"></a>
<a id="__codelineno-5-42" name="__codelineno-5-42"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"total samples being used for hyperopt: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tune_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-43" name="__codelineno-5-43"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Train set size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_subset_tune</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-44" name="__codelineno-5-44"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validation set size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_subset_tune</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> Cell 6: 使用 hyperopt 对模型进行超参数搜索 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span>
<span class="normal"><a href="#__codelineno-6-41">41</a></span>
<span class="normal"><a href="#__codelineno-6-42">42</a></span>
<span class="normal"><a href="#__codelineno-6-43">43</a></span>
<span class="normal"><a href="#__codelineno-6-44">44</a></span>
<span class="normal"><a href="#__codelineno-6-45">45</a></span>
<span class="normal"><a href="#__codelineno-6-46">46</a></span>
<span class="normal"><a href="#__codelineno-6-47">47</a></span>
<span class="normal"><a href="#__codelineno-6-48">48</a></span>
<span class="normal"><a href="#__codelineno-6-49">49</a></span>
<span class="normal"><a href="#__codelineno-6-50">50</a></span>
<span class="normal"><a href="#__codelineno-6-51">51</a></span>
<span class="normal"><a href="#__codelineno-6-52">52</a></span>
<span class="normal"><a href="#__codelineno-6-53">53</a></span>
<span class="normal"><a href="#__codelineno-6-54">54</a></span>
<span class="normal"><a href="#__codelineno-6-55">55</a></span>
<span class="normal"><a href="#__codelineno-6-56">56</a></span>
<span class="normal"><a href="#__codelineno-6-57">57</a></span>
<span class="normal"><a href="#__codelineno-6-58">58</a></span>
<span class="normal"><a href="#__codelineno-6-59">59</a></span>
<span class="normal"><a href="#__codelineno-6-60">60</a></span>
<span class="normal"><a href="#__codelineno-6-61">61</a></span>
<span class="normal"><a href="#__codelineno-6-62">62</a></span>
<span class="normal"><a href="#__codelineno-6-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="sd">"""Hyperopt 优化的目标函数"""</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>    <span class="n">lr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'lr'</span><span class="p">]</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">get_model_on_device</span><span class="p">()</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>    <span class="n">best_val_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'inf'</span><span class="p">)</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>    <span class="n">epochs_no_improve</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>    <span class="n">best_epoch</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>    <span class="c1"># 使用 tqdm 可视化每个 trial 的 epoch 进度</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>    <span class="n">epoch_iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">TUNE_MAX_EPOCHS</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"LR </span><span class="si">{</span><span class="n">lr</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epoch_iterator</span><span class="p">:</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">train_loader_tune</span><span class="p">:</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>            <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>        <span class="n">val_loss</span><span class="p">,</span> <span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader_tune</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a>        <span class="c1"># 更新进度条显示当前验证损失</span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a>        <span class="n">epoch_iterator</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s1">'val_loss'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">})</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a>        <span class="k">if</span> <span class="n">val_loss</span> <span class="o">&lt;</span> <span class="n">best_val_loss</span><span class="p">:</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a>            <span class="n">best_val_loss</span> <span class="o">=</span> <span class="n">val_loss</span>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a>            <span class="n">epochs_no_improve</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a>            <span class="n">best_epoch</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a>            <span class="n">epochs_no_improve</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a>        <span class="k">if</span> <span class="n">epochs_no_improve</span> <span class="o">==</span> <span class="n">PATIENCE</span><span class="p">:</span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Early stopping triggered at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a>            <span class="k">break</span>
<a id="__codelineno-6-40" name="__codelineno-6-40"></a>
<a id="__codelineno-6-41" name="__codelineno-6-41"></a>    <span class="k">return</span> <span class="p">{</span><span class="s1">'loss'</span><span class="p">:</span> <span class="n">best_val_loss</span><span class="p">,</span> <span class="s1">'status'</span><span class="p">:</span> <span class="n">STATUS_OK</span><span class="p">,</span> <span class="s1">'best_epoch'</span><span class="p">:</span> <span class="n">best_epoch</span><span class="p">}</span>
<a id="__codelineno-6-42" name="__codelineno-6-42"></a>
<a id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="c1"># 定义学习率的搜索空间</span>
<a id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="n">space</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'lr'</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">loguniform</span><span class="p">(</span><span class="s1">'lr'</span><span class="p">,</span> <span class="o">*</span><span class="n">LR_SEARCH_RANGE</span><span class="p">)}</span>
<a id="__codelineno-6-45" name="__codelineno-6-45"></a>
<a id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"--- Start finding best hyper parameters ---"</span><span class="p">)</span>
<a id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="n">trials</span> <span class="o">=</span> <span class="n">Trials</span><span class="p">()</span>
<a id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="n">best_params</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">(</span>
<a id="__codelineno-6-49" name="__codelineno-6-49"></a>    <span class="n">fn</span><span class="o">=</span><span class="n">objective</span><span class="p">,</span>
<a id="__codelineno-6-50" name="__codelineno-6-50"></a>    <span class="n">space</span><span class="o">=</span><span class="n">space</span><span class="p">,</span>
<a id="__codelineno-6-51" name="__codelineno-6-51"></a>    <span class="n">algo</span><span class="o">=</span><span class="n">tpe</span><span class="o">.</span><span class="n">suggest</span><span class="p">,</span>
<a id="__codelineno-6-52" name="__codelineno-6-52"></a>    <span class="n">max_evals</span><span class="o">=</span><span class="n">MAX_EVALS</span><span class="p">,</span>
<a id="__codelineno-6-53" name="__codelineno-6-53"></a>    <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span>
<a id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="p">)</span>
<a id="__codelineno-6-55" name="__codelineno-6-55"></a>
<a id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="c1"># 从 trials 对象中找到最佳试验的结果</span>
<a id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="n">best_trial</span> <span class="o">=</span> <span class="n">trials</span><span class="o">.</span><span class="n">best_trial</span>
<a id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="n">BEST_LEARNING_RATE</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">[</span><span class="s1">'lr'</span><span class="p">]</span>
<a id="__codelineno-6-59" name="__codelineno-6-59"></a><span class="n">BEST_EPOCHS</span> <span class="o">=</span> <span class="n">best_trial</span><span class="p">[</span><span class="s1">'result'</span><span class="p">][</span><span class="s1">'best_epoch'</span><span class="p">]</span>
<a id="__codelineno-6-60" name="__codelineno-6-60"></a>
<a id="__codelineno-6-61" name="__codelineno-6-61"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Best hyper parameters found ---"</span><span class="p">)</span>
<a id="__codelineno-6-62" name="__codelineno-6-62"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Best LR: </span><span class="si">{</span><span class="n">BEST_LEARNING_RATE</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-6-63" name="__codelineno-6-63"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Best epochs: </span><span class="si">{</span><span class="n">BEST_EPOCHS</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> Cell 7: 在完整训练集上进行训练并监控性能 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span>
<span class="normal"><a href="#__codelineno-7-45">45</a></span>
<span class="normal"><a href="#__codelineno-7-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Start training on full training set ---"</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="c1"># 使用完整的训练数据集 (50000张图片)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="n">full_train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">full_train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="c1"># 测试集加载器</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="c1"># 重新实例化模型和优化器</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="n">final_model</span> <span class="o">=</span> <span class="n">get_model_on_device</span><span class="p">()</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">final_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">BEST_LEARNING_RATE</span><span class="p">)</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'train_loss'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_loss'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_accuracy'</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BEST_EPOCHS</span><span class="p">):</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a>    <span class="c1"># --- 训练 ---</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>    <span class="n">final_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>    <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a>    <span class="n">train_iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">full_train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">BEST_EPOCHS</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">train_iterator</span><span class="p">:</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>        <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">final_model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a>        <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a>    <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="n">running_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'train_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_train_loss</span><span class="p">)</span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a>    <span class="c1"># --- 在测试集上评估以监控性能 ---</span>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a>    <span class="n">epoch_val_loss</span><span class="p">,</span> <span class="n">epoch_val_accuracy</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_val_loss</span><span class="p">)</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_accuracy'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_val_accuracy</span><span class="p">)</span>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a>
<a id="__codelineno-7-41" name="__codelineno-7-41"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Epoch [</span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">BEST_EPOCHS</span><span class="si">}</span><span class="s2">], Train Loss: </span><span class="si">{</span><span class="n">epoch_train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Test Loss: </span><span class="si">{</span><span class="n">epoch_val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Test Accuracy: </span><span class="si">{</span><span class="n">epoch_val_accuracy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
<a id="__codelineno-7-42" name="__codelineno-7-42"></a>
<a id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-7-44" name="__codelineno-7-44"></a><span class="n">training_duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-7-45" name="__codelineno-7-45"></a>
<a id="__codelineno-7-46" name="__codelineno-7-46"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"--- Over ---"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> Cell 8: 生成实验的结果报告 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c1"># 计算最终模型在测试集上的性能</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="n">final_test_loss</span><span class="p">,</span> <span class="n">final_test_accuracy</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">final_model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="c1"># 计算模型参数量</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="n">total_params</span> <span class="o">=</span> <span class="n">count_parameters</span><span class="p">(</span><span class="n">final_model</span><span class="p">)</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="c1"># 格式化训练时长</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="n">mins</span><span class="p">,</span> <span class="n">secs</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">training_duration</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="n">formatted_duration</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span><span class="si">}</span><span class="s2">m </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span><span class="si">}</span><span class="s2">s"</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="c1"># 绘制并保存性能曲线</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="n">report_history</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="s1">'train_loss'</span><span class="p">:</span> <span class="n">history</span><span class="p">[</span><span class="s1">'train_loss'</span><span class="p">],</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>    <span class="s1">'val_loss'</span><span class="p">:</span> <span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">],</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>    <span class="s1">'val_accuracy'</span><span class="p">:</span> <span class="n">history</span><span class="p">[</span><span class="s1">'val_accuracy'</span><span class="p">]</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="p">}</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="n">plot_and_save_history</span><span class="p">(</span><span class="n">report_history</span><span class="p">)</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="c1"># 打印报告</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="nb">print</span><span class="p">(</span><span class="s2">" "</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">+</span> <span class="s2">"Results"</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"="</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">[Hyper parameters]"</span><span class="p">)</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Best LR: </span><span class="si">{</span><span class="n">BEST_LEARNING_RATE</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Best epochs: </span><span class="si">{</span><span class="n">BEST_EPOCHS</span><span class="si">}</span><span class="s2"> epochs"</span><span class="p">)</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Batch size: </span><span class="si">{</span><span class="n">BATCH_SIZE</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">[Model structure]"</span><span class="p">)</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Model type: MLP"</span><span class="p">)</span>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Model structure:"</span><span class="p">)</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="nb">print</span><span class="p">(</span><span class="n">final_model</span><span class="p">)</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Total params: </span><span class="si">{</span><span class="n">total_params</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">[Training infomation]"</span><span class="p">)</span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Training duration on full training set: </span><span class="si">{</span><span class="n">formatted_duration</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a><span class="n">platform</span> <span class="o">=</span> <span class="s2">"Kaggle's free P100, Thank you Google!"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"some poor guy's broken Intel core"</span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Training device: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">[Benchmarks on test set]"</span><span class="p">)</span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Test loss: </span><span class="si">{</span><span class="n">final_test_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Test accuracy: </span><span class="si">{</span><span class="n">final_test_accuracy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h2 id="mlp">MLP<a class="headerlink" href="#mlp" title="Permanent link">¶</a></h2>
<h3 id="mlp_1">MLP 模型的训练结果展示<a class="headerlink" href="#mlp_1" title="Permanent link">¶</a></h3>
<details>
<summary> MLP 的训练结果 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span>
<span class="normal"><a href="#__codelineno-9-23">23</a></span>
<span class="normal"><a href="#__codelineno-9-24">24</a></span>
<span class="normal"><a href="#__codelineno-9-25">25</a></span>
<span class="normal"><a href="#__codelineno-9-26">26</a></span>
<span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span>
<span class="normal"><a href="#__codelineno-9-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a>==================================================
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>               Results
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>==================================================
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>[Hyper parameters]
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>  - Best LR: 0.000056
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>  - Best epochs: 13 epochs
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>  - Batch size: 128
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>[Model structure]
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>  - Model type: MLP
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>  - Model structure:
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>MLP(
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>  (network): Sequential(
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>    (0): Flatten(start_dim=1, end_dim=-1)
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>    (1): Linear(in_features=3072, out_features=512, bias=True)
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>    (2): ReLU()
<a id="__codelineno-9-18" name="__codelineno-9-18"></a>    (3): Linear(in_features=512, out_features=256, bias=True)
<a id="__codelineno-9-19" name="__codelineno-9-19"></a>    (4): ReLU()
<a id="__codelineno-9-20" name="__codelineno-9-20"></a>    (5): Linear(in_features=256, out_features=10, bias=True)
<a id="__codelineno-9-21" name="__codelineno-9-21"></a>  )
<a id="__codelineno-9-22" name="__codelineno-9-22"></a>)
<a id="__codelineno-9-23" name="__codelineno-9-23"></a>  - Total params: 1,707,274
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a>[Training infomation]
<a id="__codelineno-9-26" name="__codelineno-9-26"></a>  - Training duration on full training set: 2m 51s
<a id="__codelineno-9-27" name="__codelineno-9-27"></a>  - Training device: cuda on Kaggle's free P100, Thank you Google!
<a id="__codelineno-9-28" name="__codelineno-9-28"></a>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a>[Benchmarks on test set]
<a id="__codelineno-9-30" name="__codelineno-9-30"></a>  - Test loss: 1.3208
<a id="__codelineno-9-31" name="__codelineno-9-31"></a>  - Test accuracy: 54.44%
<a id="__codelineno-9-32" name="__codelineno-9-32"></a>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a>==================================================
</code></pre></div></td></tr></table></div>
</details>
<p>训练代码已经放在前面了，这里就不给出了。</p>
<h3 id="mlp_2">对 MLP 模型的解读和评述<a class="headerlink" href="#mlp_2" title="Permanent link">¶</a></h3>
<p>模型结构图：</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Graph direction and styling
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef result fill:#45475a,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4;

    %% Input Layer
    subgraph Input["Input Layer"]
        A[("RGB Image&lt;br&gt;3x32x32")]
    end
    class Input input;

    %% Flatten Layer
    subgraph Flatten["Flatten Layer"]
        B[("Flatten")]
    end
    A --&gt; |3 @ 32x32| B
    class Flatten box;

    %% Hidden Layer 1
    subgraph Hidden1["Hidden Layer 1"]
        C["Linear&lt;br&gt;3072x512"]
        D["ReLU"]
    end
    B --&gt;|3072| C --&gt; D
    class Hidden1 box;

    %% Hidden Layer 2
    subgraph Hidden2["Hidden Layer 2"]
        E["Linear&lt;br&gt;512x256"] 
        F["ReLU"]
    end
    D --&gt;|512| E --&gt; F
    class Hidden2 box;

    %% Output Layer
    subgraph Output["Output Layer"]
        G["Linear&lt;br&gt;256x10"]
    end
    F --&gt;|256| G
    class Output output;

    %% Classification Result
    subgraph Result["Classification Result"]
        H[("10 output logits")]
    end
    G --&gt;|10| H
    class Result result;

    %% Styling
    style A stroke-dasharray: 5 5
    style H stroke:#a6e3a1,stroke-width:3px</code></pre>
<p>MLP 是利用 <span class="arithmatex">\(\mathbb{R}^n\rightarrow\mathbb{R}^m\)</span> 的多重线性映射实现数据的降维，但是单纯的线性映射嵌套仍是 <span class="arithmatex">\(\mathbb{R}^{d_{in}}\rightarrow\mathbb{R}^{d_{out}}\)</span> 的线性映射，因此需要在层与层之间添加非线性的激活函数引入非线性。这样一个足够宽的两层全连接网络即可拟合任意函数。</p>
<p>在这个任务里面，我们使用一个三层的 MLP，并采用 ReLU 作为层间的激活函数，由于我们对 one-hot 向量进行分类，因此使用交叉熵损失，如果用 MSE 的话，求导之后会发现它是交叉熵的导数乘以权重，这就不适合梯度稳定更新。</p>
<p>输入上是将 3@32x32 的图像展平成 3072 维的向量。当然我觉得这很没道理，图像本身就有两个维度三个通道，这种“平面化”的信息，感觉就被一个 <code>nn.Flatten</code> 给丢弃了。虽然说理论上经过足够数据训练之后，一个 fc layer 足够有能力提取各个维度上的相关性（万能拟合定理），但是网络要足够宽，数据要足够多，正则化要足够充分，而如果不引入更多先验知识来捕捉图像信息的特征，训练效率和参数效率都是极其低下的。</p>
<p>这是一个三层的多层感知机，参数量 1.7M。第一次训练下来发现这点参数量反映下来就是即使是 P100 这种老 GPU 都根本没使劲，倒是 CPU 一直在满负荷发力，搬运数据。后来意识到，dataloader 里面可以写上 <code>num_workers=6</code> 以及 <code>pin_memory=True</code> 来提升访存效率，并且把 batch_size 调大（反正就 2 M不到的模型爆不了显存），训练效率高了很多啊。</p>
<p>经过 13 个 Epoch 的训练之后，模型在 CIFAR-10 上只取得了 54.44% 的准确率。增大模型的宽度和深度理论上可以改善，但是效率太低了（关于宽度和深度的思考，可以参考 EfficientNet 的论文）。因此需要发掘图像信息的特性，在模型结构上面引入更多先验信息，寻找能够更高效提取信息的架构。所以可以看到现在的网络架构中，MLP 仅仅是作为分类头出现的。</p>
<h2 id="cnn">CNN<a class="headerlink" href="#cnn" title="Permanent link">¶</a></h2>
<h3 id="cnn_1">CNN 模型的训练结果展示<a class="headerlink" href="#cnn_1" title="Permanent link">¶</a></h3>
<details>
<summary> CNN 的代码实现 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span>
<span class="normal"><a href="#__codelineno-10-38">38</a></span>
<span class="normal"><a href="#__codelineno-10-39">39</a></span>
<span class="normal"><a href="#__codelineno-10-40">40</a></span>
<span class="normal"><a href="#__codelineno-10-41">41</a></span>
<span class="normal"><a href="#__codelineno-10-42">42</a></span>
<span class="normal"><a href="#__codelineno-10-43">43</a></span>
<span class="normal"><a href="#__codelineno-10-44">44</a></span>
<span class="normal"><a href="#__codelineno-10-45">45</a></span>
<span class="normal"><a href="#__codelineno-10-46">46</a></span>
<span class="normal"><a href="#__codelineno-10-47">47</a></span>
<span class="normal"><a href="#__codelineno-10-48">48</a></span>
<span class="normal"><a href="#__codelineno-10-49">49</a></span>
<span class="normal"><a href="#__codelineno-10-50">50</a></span>
<span class="normal"><a href="#__codelineno-10-51">51</a></span>
<span class="normal"><a href="#__codelineno-10-52">52</a></span>
<span class="normal"><a href="#__codelineno-10-53">53</a></span>
<span class="normal"><a href="#__codelineno-10-54">54</a></span>
<span class="normal"><a href="#__codelineno-10-55">55</a></span>
<span class="normal"><a href="#__codelineno-10-56">56</a></span>
<span class="normal"><a href="#__codelineno-10-57">57</a></span>
<span class="normal"><a href="#__codelineno-10-58">58</a></span>
<span class="normal"><a href="#__codelineno-10-59">59</a></span>
<span class="normal"><a href="#__codelineno-10-60">60</a></span>
<span class="normal"><a href="#__codelineno-10-61">61</a></span>
<span class="normal"><a href="#__codelineno-10-62">62</a></span>
<span class="normal"><a href="#__codelineno-10-63">63</a></span>
<span class="normal"><a href="#__codelineno-10-64">64</a></span>
<span class="normal"><a href="#__codelineno-10-65">65</a></span>
<span class="normal"><a href="#__codelineno-10-66">66</a></span>
<span class="normal"><a href="#__codelineno-10-67">67</a></span>
<span class="normal"><a href="#__codelineno-10-68">68</a></span>
<span class="normal"><a href="#__codelineno-10-69">69</a></span>
<span class="normal"><a href="#__codelineno-10-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>                 <span class="n">input_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>                 <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>                 <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>   <span class="c1"># 每个卷积块的输出通道数</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>                 <span class="n">kernel_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>   <span class="c1"># 每个卷积层的 kernel 大小</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>                 <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>         <span class="c1"># dropout 概率</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>                 <span class="n">use_batchnorm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>      <span class="c1"># 是否使用批归一化</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">CNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>        <span class="c1"># 存储配置参数</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>            <span class="s1">'input_channels'</span><span class="p">:</span> <span class="n">input_channels</span><span class="p">,</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>            <span class="s1">'num_classes'</span><span class="p">:</span> <span class="n">num_classes</span><span class="p">,</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>            <span class="s1">'channels'</span><span class="p">:</span> <span class="n">channels</span><span class="p">,</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>            <span class="s1">'kernel_sizes'</span><span class="p">:</span> <span class="n">kernel_sizes</span><span class="p">,</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a>            <span class="s1">'dropout_rate'</span><span class="p">:</span> <span class="n">dropout_rate</span><span class="p">,</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a>            <span class="s1">'use_batchnorm'</span><span class="p">:</span> <span class="n">use_batchnorm</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a>        <span class="p">}</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a>        <span class="c1"># 确保卷积层数量与 kernel 大小数量一致</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kernel_sizes</span><span class="p">),</span> \
<a id="__codelineno-10-23" name="__codelineno-10-23"></a>            <span class="s2">"通道数列表与kernel大小列表长度必须一致"</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a>        <span class="c1"># 构建卷积层</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a>        <span class="n">in_channels</span> <span class="o">=</span> <span class="n">input_channels</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">kernel_sizes</span><span class="p">)):</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a>            <span class="c1"># 卷积层</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>                <span class="sa">f</span><span class="s1">'conv</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a>                <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">kernel_size</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>            <span class="p">)</span>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a>            <span class="c1"># 批归一化层（可选）</span>
<a id="__codelineno-10-37" name="__codelineno-10-37"></a>            <span class="k">if</span> <span class="n">use_batchnorm</span><span class="p">:</span>
<a id="__codelineno-10-38" name="__codelineno-10-38"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
<a id="__codelineno-10-39" name="__codelineno-10-39"></a>                    <span class="sa">f</span><span class="s1">'bn</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
<a id="__codelineno-10-40" name="__codelineno-10-40"></a>                    <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_channels</span><span class="p">)</span>
<a id="__codelineno-10-41" name="__codelineno-10-41"></a>                <span class="p">)</span>
<a id="__codelineno-10-42" name="__codelineno-10-42"></a>
<a id="__codelineno-10-43" name="__codelineno-10-43"></a>            <span class="c1"># 激活函数</span>
<a id="__codelineno-10-44" name="__codelineno-10-44"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="sa">f</span><span class="s1">'relu</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-10-45" name="__codelineno-10-45"></a>
<a id="__codelineno-10-46" name="__codelineno-10-46"></a>            <span class="c1"># 池化层</span>
<a id="__codelineno-10-47" name="__codelineno-10-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="sa">f</span><span class="s1">'pool</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-10-48" name="__codelineno-10-48"></a>
<a id="__codelineno-10-49" name="__codelineno-10-49"></a>            <span class="n">in_channels</span> <span class="o">=</span> <span class="n">out_channels</span>
<a id="__codelineno-10-50" name="__codelineno-10-50"></a>
<a id="__codelineno-10-51" name="__codelineno-10-51"></a>        <span class="c1"># 计算卷积层输出后的特征图尺寸</span>
<a id="__codelineno-10-52" name="__codelineno-10-52"></a>        <span class="c1"># CIFAR-10输入为32x32，经过n次池化后尺寸为32/(2^n)</span>
<a id="__codelineno-10-53" name="__codelineno-10-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">feature_size</span> <span class="o">=</span> <span class="n">in_channels</span> <span class="o">*</span> <span class="p">(</span><span class="mi">32</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)))</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-10-54" name="__codelineno-10-54"></a>
<a id="__codelineno-10-55" name="__codelineno-10-55"></a>        <span class="c1"># 构建全连接层</span>
<a id="__codelineno-10-56" name="__codelineno-10-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-10-57" name="__codelineno-10-57"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_size</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
<a id="__codelineno-10-58" name="__codelineno-10-58"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-10-59" name="__codelineno-10-59"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">),</span>
<a id="__codelineno-10-60" name="__codelineno-10-60"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<a id="__codelineno-10-61" name="__codelineno-10-61"></a>        <span class="p">)</span>
<a id="__codelineno-10-62" name="__codelineno-10-62"></a>
<a id="__codelineno-10-63" name="__codelineno-10-63"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-10-64" name="__codelineno-10-64"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-10-65" name="__codelineno-10-65"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 展平特征图</span>
<a id="__codelineno-10-66" name="__codelineno-10-66"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-10-67" name="__codelineno-10-67"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-10-68" name="__codelineno-10-68"></a>
<a id="__codelineno-10-69" name="__codelineno-10-69"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_model_on_device</span><span class="p">():</span>
<a id="__codelineno-10-70" name="__codelineno-10-70"></a>    <span class="k">return</span> <span class="n">CNN</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> CNN 的训练结果 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span>
<span class="normal"><a href="#__codelineno-11-43">43</a></span>
<span class="normal"><a href="#__codelineno-11-44">44</a></span>
<span class="normal"><a href="#__codelineno-11-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a>==================================================
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>               Results
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>==================================================
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>[Hyper parameters]
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>  - Best LR: 0.000199
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>  - Best epochs: 16 epochs
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>  - Batch size: 128
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>[Model structure]
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>  - Model type: CNN
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>  - Model structure:
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>CNN(
<a id="__codelineno-11-14" name="__codelineno-11-14"></a>  (features): Sequential(
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>    (conv1): Conv2d(3, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>    (bn1): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>    (relu1): ReLU(inplace=True)
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>    (pool1): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>    (conv2): Conv2d(32, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
<a id="__codelineno-11-20" name="__codelineno-11-20"></a>    (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>    (relu2): ReLU(inplace=True)
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>    (pool2): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>    (conv3): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
<a id="__codelineno-11-24" name="__codelineno-11-24"></a>    (bn3): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-11-25" name="__codelineno-11-25"></a>    (relu3): ReLU(inplace=True)
<a id="__codelineno-11-26" name="__codelineno-11-26"></a>    (pool3): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>  )
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>  (classifier): Sequential(
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>    (0): Linear(in_features=2048, out_features=512, bias=True)
<a id="__codelineno-11-30" name="__codelineno-11-30"></a>    (1): ReLU(inplace=True)
<a id="__codelineno-11-31" name="__codelineno-11-31"></a>    (2): Dropout(p=0.5, inplace=False)
<a id="__codelineno-11-32" name="__codelineno-11-32"></a>    (3): Linear(in_features=512, out_features=10, bias=True)
<a id="__codelineno-11-33" name="__codelineno-11-33"></a>  )
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>)
<a id="__codelineno-11-35" name="__codelineno-11-35"></a>  - Total params: 1,147,914
<a id="__codelineno-11-36" name="__codelineno-11-36"></a>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a>[Training infomation]
<a id="__codelineno-11-38" name="__codelineno-11-38"></a>  - Training duration on full training set: 4m 7s
<a id="__codelineno-11-39" name="__codelineno-11-39"></a>  - Training device: cuda on Kaggle's free P100, Thank you Google!
<a id="__codelineno-11-40" name="__codelineno-11-40"></a>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a>[Benchmarks on test set]
<a id="__codelineno-11-42" name="__codelineno-11-42"></a>  - Test loss: 0.7026
<a id="__codelineno-11-43" name="__codelineno-11-43"></a>  - Test accuracy: 77.33%
<a id="__codelineno-11-44" name="__codelineno-11-44"></a>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a>==================================================
</code></pre></div></td></tr></table></div>
</details>
<h3 id="cnn_2">对 CNN 模型的解读和评述<a class="headerlink" href="#cnn_2" title="Permanent link">¶</a></h3>
<p>结构图（请放大观看）：</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef result fill:#45475a,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4;
    classDef conv fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;

    %% Input Layer
    subgraph Input["Input"]
        A[("3@32×32")]
    end
    class Input input;

    %% Feature Extractor
    %% -- Conv Block 1 --
    subgraph Block1["Conv Block 1"]
        B["Conv2d&lt;br&gt; 3x32 x 3×3 kernel"] 
        C["BatchNorm2d&lt;br&gt; 32 channels"]
        D["ReLU"]
        E["MaxPool2d&lt;br&gt; 2×2/2"]
    end
    A --&gt; B
    B --&gt;|32 @ 32x32| C --&gt; D --&gt; E
    class Block1 conv;

    %% -- Conv Block 2 --
    subgraph Block2["Conv Block 2"]
        F["Conv2d&lt;br&gt; 32x64 x 3×3 kernel"] 
        G["BatchNorm2d&lt;br&gt; 64 channels"]
        H["ReLU"]
        I["MaxPool2d&lt;br&gt; 2×2/2"]
    end
    E --&gt; |32 @ 16×16| F
    F --&gt; |64 @ 16×16| G --&gt; H --&gt; I
    class Block2 conv;

    %% -- Conv Block 3 --
    subgraph Block3["Conv Block 3"]
        J["Conv2d&lt;br&gt; 64x128 x 3×3 kernel"]
        K["BatchNorm2d&lt;br&gt; 128 channels"]
        L["ReLU"]
        M["MaxPool2d&lt;br&gt; 2×2/2"]
    end
    I --&gt; |64 @ 8×8| J
    J --&gt; |128 @ 8×8| K --&gt; L --&gt; M
    class Block3 conv;

    %% Feature Flattening
    subgraph Flatten["Flatten"]
        N[("2048")]
    end
    M --&gt; |128 @ 4×4| N
    class Flatten box;

    %% Classifier
    subgraph Classifier["Classifier"]
        O["Linear&lt;br&gt; 2048x512"]
        P["ReLU"]
        Q["Dropout&lt;br&gt; p = 0.5"]
        R["Linear&lt;br&gt; 512x10"]
    end
    N --&gt; O
    O --&gt; P --&gt; Q --&gt; R
    class Classifier box;

    %% Output Layer
    subgraph Output["Classification Result"]
        S[("10 output logits")]
    end
    R --&gt; S
    class Output output;

    %% Styling
    style A stroke-dasharray: 5 5
    style S stroke:#a6e3a1,stroke-width:3px</code></pre>
<p><code>conv2d</code> 就是卷积操作，本质上是从输入张量 <code>(batch_size, in_channel, H, W)</code> 到输出张量 <code>(batch_size, out_channel, H, W)</code> 的一个利用四维张量 <code>(in_channel, out_channel, H', W')</code> 的卷积核进行的卷积操作，具体是对于单张图像的各个通道进行填充后，将自定义的 <code>in_channel@H'xW'</code> 的矩阵在其上一一对应进行滑动覆盖，并对覆盖到的区域进行逐元素求积并求和，得到了单个新矩阵，如此共选取 <code>out_channel</code> 次自定义矩阵，就得到了输出张量 <code>(batch_size, out_channel, H, W)</code> 这是任意一本深度学习教材都会讲解的内容。</p>
<p>CNN 通过先验引入稀疏连接（也就是 <code>conv2d</code> ）不仅可以实现对更大规模网络的稀疏近似，满足图像的平移不变性，还具有很好的可解释性（卷积核对应一个小面积的感受野，解决之前提到 MLP 的展平操作的问题，并且不同的卷积核提取不同的特征）。因此相当适合图像处理。当然最后还是得依靠一个 MLP 作为分类头，不过这里的展平操作就合理多了，因为经过多次 <code>conv2d</code> 之后，模型提取到的都是空间上弱相关的深层次（抽象）特征了。在这些特征之间进行组合就非常合理且直观了。在很长的一段时间内，CNN 作为高效的特征提取器，一直都是各种 CV 网络的砖石。</p>
<p>这个网络虽然参数量不如先前的 MLP，但是宽度要宽一些（我理解的网络宽度即通道数，因为这决定了模型捕获的特征数量），根据 muP 的理论，学习率可以翻 4 倍（MLP隐藏层维度 512， CNN 最大通道数 128），结论大致符合预期。CNN 的高效性正在于其中，以更低的参数量获得更优的效果。</p>
<p>后面的 NiN, VGG, GoogLeNet 等都是基于卷积摆放位置和多少以及并行度的差异，详细的复现敬请期待。</p>
<h2 id="resnet">ResNet<a class="headerlink" href="#resnet" title="Permanent link">¶</a></h2>
<h3 id="resnet-18">ResNet-18 模型的训练结果展示<a class="headerlink" href="#resnet-18" title="Permanent link">¶</a></h3>
<details>
<summary> 代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">resnet18</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResNet18</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">ResNet18</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>        <span class="c1"># 加载预训练或随机初始化的ResNet-18</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resnet</span> <span class="o">=</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="n">pretrained</span><span class="p">)</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>        <span class="c1"># 调整第一个卷积层以适应32x32输入</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>        <span class="c1"># 原始ResNet-18的第一个卷积层是7x7, stride=2, padding=3</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>        <span class="c1"># 对于32x32图像，我们改为3x3, stride=1, padding=1</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resnet</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a>            <span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a>        <span class="p">)</span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a>        <span class="c1"># 调整最大池化层，不需要下采样太多</span>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resnet</span><span class="o">.</span><span class="n">maxpool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>  <span class="c1"># 移除最大池化层</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a>        <span class="c1"># 调整最后一个全连接层以适应CIFAR-10的10个类别</span>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a>        <span class="n">in_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resnet</span><span class="o">.</span><span class="n">fc</span><span class="o">.</span><span class="n">in_features</span>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resnet</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<a id="__codelineno-12-21" name="__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-12-23" name="__codelineno-12-23"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resnet</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-12-24" name="__codelineno-12-24"></a>
<a id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_model_on_device</span><span class="p">():</span>
<a id="__codelineno-12-26" name="__codelineno-12-26"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">ResNet18</span><span class="p">()</span><span class="c1"># pretrained=True 使用预训练权重，反之不使用。</span>
<a id="__codelineno-12-27" name="__codelineno-12-27"></a>    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> 从零训练结果 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">  1</a></span>
<span class="normal"><a href="#__codelineno-13-2">  2</a></span>
<span class="normal"><a href="#__codelineno-13-3">  3</a></span>
<span class="normal"><a href="#__codelineno-13-4">  4</a></span>
<span class="normal"><a href="#__codelineno-13-5">  5</a></span>
<span class="normal"><a href="#__codelineno-13-6">  6</a></span>
<span class="normal"><a href="#__codelineno-13-7">  7</a></span>
<span class="normal"><a href="#__codelineno-13-8">  8</a></span>
<span class="normal"><a href="#__codelineno-13-9">  9</a></span>
<span class="normal"><a href="#__codelineno-13-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-13-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-13-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-13-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-13-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-13-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-13-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-13-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-13-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-13-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-13-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-13-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-13-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-13-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-13-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-13-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-13-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-13-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-13-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-13-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-13-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-13-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-13-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-13-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-13-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-13-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-13-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-13-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-13-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-13-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-13-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-13-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-13-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-13-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-13-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-13-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-13-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-13-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-13-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-13-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-13-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-13-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-13-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-13-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-13-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-13-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-13-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-13-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-13-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-13-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-13-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-13-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-13-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-13-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-13-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-13-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-13-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-13-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-13-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-13-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-13-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-13-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-13-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-13-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-13-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-13-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-13-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-13-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-13-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-13-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-13-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-13-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-13-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-13-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-13-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-13-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-13-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-13-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-13-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-13-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-13-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-13-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-13-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-13-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-13-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-13-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-13-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-13-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-13-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-13-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-13-100">100</a></span>
<span class="normal"><a href="#__codelineno-13-101">101</a></span>
<span class="normal"><a href="#__codelineno-13-102">102</a></span>
<span class="normal"><a href="#__codelineno-13-103">103</a></span>
<span class="normal"><a href="#__codelineno-13-104">104</a></span>
<span class="normal"><a href="#__codelineno-13-105">105</a></span>
<span class="normal"><a href="#__codelineno-13-106">106</a></span>
<span class="normal"><a href="#__codelineno-13-107">107</a></span>
<span class="normal"><a href="#__codelineno-13-108">108</a></span>
<span class="normal"><a href="#__codelineno-13-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a>==================================================
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>               Results
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>==================================================
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>[Hyper parameters]
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>  - Best LR: 0.002787
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>  - Best epochs: 8 epochs
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>  - Batch size: 128
<a id="__codelineno-13-9" name="__codelineno-13-9"></a>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>[Model structure]
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>  - Model type: ResNet18 from scrach
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>  - Model structure:
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>ResNet18(
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>  (resnet): ResNet(
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>    (conv1): Conv2d(3, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>    (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-17" name="__codelineno-13-17"></a>    (relu): ReLU(inplace=True)
<a id="__codelineno-13-18" name="__codelineno-13-18"></a>    (maxpool): Identity()
<a id="__codelineno-13-19" name="__codelineno-13-19"></a>    (layer1): Sequential(
<a id="__codelineno-13-20" name="__codelineno-13-20"></a>      (0): BasicBlock(
<a id="__codelineno-13-21" name="__codelineno-13-21"></a>        (conv1): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-22" name="__codelineno-13-22"></a>        (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-23" name="__codelineno-13-23"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-13-24" name="__codelineno-13-24"></a>        (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-25" name="__codelineno-13-25"></a>        (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-26" name="__codelineno-13-26"></a>      )
<a id="__codelineno-13-27" name="__codelineno-13-27"></a>      (1): BasicBlock(
<a id="__codelineno-13-28" name="__codelineno-13-28"></a>        (conv1): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-29" name="__codelineno-13-29"></a>        (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-30" name="__codelineno-13-30"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-13-31" name="__codelineno-13-31"></a>        (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-32" name="__codelineno-13-32"></a>        (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-33" name="__codelineno-13-33"></a>      )
<a id="__codelineno-13-34" name="__codelineno-13-34"></a>    )
<a id="__codelineno-13-35" name="__codelineno-13-35"></a>    (layer2): Sequential(
<a id="__codelineno-13-36" name="__codelineno-13-36"></a>      (0): BasicBlock(
<a id="__codelineno-13-37" name="__codelineno-13-37"></a>        (conv1): Conv2d(64, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
<a id="__codelineno-13-38" name="__codelineno-13-38"></a>        (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-39" name="__codelineno-13-39"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-13-40" name="__codelineno-13-40"></a>        (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-41" name="__codelineno-13-41"></a>        (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-42" name="__codelineno-13-42"></a>        (downsample): Sequential(
<a id="__codelineno-13-43" name="__codelineno-13-43"></a>          (0): Conv2d(64, 128, kernel_size=(1, 1), stride=(2, 2), bias=False)
<a id="__codelineno-13-44" name="__codelineno-13-44"></a>          (1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-45" name="__codelineno-13-45"></a>        )
<a id="__codelineno-13-46" name="__codelineno-13-46"></a>      )
<a id="__codelineno-13-47" name="__codelineno-13-47"></a>      (1): BasicBlock(
<a id="__codelineno-13-48" name="__codelineno-13-48"></a>        (conv1): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-49" name="__codelineno-13-49"></a>        (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-50" name="__codelineno-13-50"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-13-51" name="__codelineno-13-51"></a>        (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-52" name="__codelineno-13-52"></a>        (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-53" name="__codelineno-13-53"></a>      )
<a id="__codelineno-13-54" name="__codelineno-13-54"></a>    )
<a id="__codelineno-13-55" name="__codelineno-13-55"></a>    (layer3): Sequential(
<a id="__codelineno-13-56" name="__codelineno-13-56"></a>      (0): BasicBlock(
<a id="__codelineno-13-57" name="__codelineno-13-57"></a>        (conv1): Conv2d(128, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
<a id="__codelineno-13-58" name="__codelineno-13-58"></a>        (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-59" name="__codelineno-13-59"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-13-60" name="__codelineno-13-60"></a>        (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-61" name="__codelineno-13-61"></a>        (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-62" name="__codelineno-13-62"></a>        (downsample): Sequential(
<a id="__codelineno-13-63" name="__codelineno-13-63"></a>          (0): Conv2d(128, 256, kernel_size=(1, 1), stride=(2, 2), bias=False)
<a id="__codelineno-13-64" name="__codelineno-13-64"></a>          (1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-65" name="__codelineno-13-65"></a>        )
<a id="__codelineno-13-66" name="__codelineno-13-66"></a>      )
<a id="__codelineno-13-67" name="__codelineno-13-67"></a>      (1): BasicBlock(
<a id="__codelineno-13-68" name="__codelineno-13-68"></a>        (conv1): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-69" name="__codelineno-13-69"></a>        (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-70" name="__codelineno-13-70"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-13-71" name="__codelineno-13-71"></a>        (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-72" name="__codelineno-13-72"></a>        (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-73" name="__codelineno-13-73"></a>      )
<a id="__codelineno-13-74" name="__codelineno-13-74"></a>    )
<a id="__codelineno-13-75" name="__codelineno-13-75"></a>    (layer4): Sequential(
<a id="__codelineno-13-76" name="__codelineno-13-76"></a>      (0): BasicBlock(
<a id="__codelineno-13-77" name="__codelineno-13-77"></a>        (conv1): Conv2d(256, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
<a id="__codelineno-13-78" name="__codelineno-13-78"></a>        (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-79" name="__codelineno-13-79"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-13-80" name="__codelineno-13-80"></a>        (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-81" name="__codelineno-13-81"></a>        (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-82" name="__codelineno-13-82"></a>        (downsample): Sequential(
<a id="__codelineno-13-83" name="__codelineno-13-83"></a>          (0): Conv2d(256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False)
<a id="__codelineno-13-84" name="__codelineno-13-84"></a>          (1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-85" name="__codelineno-13-85"></a>        )
<a id="__codelineno-13-86" name="__codelineno-13-86"></a>      )
<a id="__codelineno-13-87" name="__codelineno-13-87"></a>      (1): BasicBlock(
<a id="__codelineno-13-88" name="__codelineno-13-88"></a>        (conv1): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-89" name="__codelineno-13-89"></a>        (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-90" name="__codelineno-13-90"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-13-91" name="__codelineno-13-91"></a>        (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-13-92" name="__codelineno-13-92"></a>        (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-13-93" name="__codelineno-13-93"></a>      )
<a id="__codelineno-13-94" name="__codelineno-13-94"></a>    )
<a id="__codelineno-13-95" name="__codelineno-13-95"></a>    (avgpool): AdaptiveAvgPool2d(output_size=(1, 1))
<a id="__codelineno-13-96" name="__codelineno-13-96"></a>    (fc): Linear(in_features=512, out_features=10, bias=True)
<a id="__codelineno-13-97" name="__codelineno-13-97"></a>  )
<a id="__codelineno-13-98" name="__codelineno-13-98"></a>)
<a id="__codelineno-13-99" name="__codelineno-13-99"></a>  - Total params: 11,173,962
<a id="__codelineno-13-100" name="__codelineno-13-100"></a>
<a id="__codelineno-13-101" name="__codelineno-13-101"></a>[Training infomation]
<a id="__codelineno-13-102" name="__codelineno-13-102"></a>  - Training duration on full training set: 5m 8s
<a id="__codelineno-13-103" name="__codelineno-13-103"></a>  - Training device: cuda on Kaggle's free P100, Thank you Google!
<a id="__codelineno-13-104" name="__codelineno-13-104"></a>
<a id="__codelineno-13-105" name="__codelineno-13-105"></a>[Benchmarks on test set]
<a id="__codelineno-13-106" name="__codelineno-13-106"></a>  - Test loss: 0.5767
<a id="__codelineno-13-107" name="__codelineno-13-107"></a>  - Test accuracy: 83.46%
<a id="__codelineno-13-108" name="__codelineno-13-108"></a>
<a id="__codelineno-13-109" name="__codelineno-13-109"></a>==================================================
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> 微调结果 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">  1</a></span>
<span class="normal"><a href="#__codelineno-14-2">  2</a></span>
<span class="normal"><a href="#__codelineno-14-3">  3</a></span>
<span class="normal"><a href="#__codelineno-14-4">  4</a></span>
<span class="normal"><a href="#__codelineno-14-5">  5</a></span>
<span class="normal"><a href="#__codelineno-14-6">  6</a></span>
<span class="normal"><a href="#__codelineno-14-7">  7</a></span>
<span class="normal"><a href="#__codelineno-14-8">  8</a></span>
<span class="normal"><a href="#__codelineno-14-9">  9</a></span>
<span class="normal"><a href="#__codelineno-14-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-14-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-14-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-14-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-14-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-14-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-14-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-14-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-14-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-14-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-14-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-14-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-14-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-14-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-14-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-14-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-14-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-14-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-14-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-14-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-14-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-14-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-14-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-14-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-14-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-14-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-14-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-14-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-14-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-14-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-14-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-14-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-14-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-14-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-14-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-14-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-14-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-14-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-14-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-14-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-14-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-14-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-14-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-14-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-14-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-14-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-14-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-14-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-14-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-14-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-14-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-14-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-14-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-14-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-14-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-14-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-14-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-14-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-14-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-14-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-14-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-14-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-14-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-14-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-14-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-14-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-14-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-14-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-14-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-14-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-14-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-14-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-14-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-14-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-14-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-14-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-14-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-14-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-14-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-14-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-14-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-14-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-14-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-14-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-14-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-14-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-14-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-14-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-14-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-14-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-14-100">100</a></span>
<span class="normal"><a href="#__codelineno-14-101">101</a></span>
<span class="normal"><a href="#__codelineno-14-102">102</a></span>
<span class="normal"><a href="#__codelineno-14-103">103</a></span>
<span class="normal"><a href="#__codelineno-14-104">104</a></span>
<span class="normal"><a href="#__codelineno-14-105">105</a></span>
<span class="normal"><a href="#__codelineno-14-106">106</a></span>
<span class="normal"><a href="#__codelineno-14-107">107</a></span>
<span class="normal"><a href="#__codelineno-14-108">108</a></span>
<span class="normal"><a href="#__codelineno-14-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a>==================================================
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>               Results
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>==================================================
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>[Hyper parameters]
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>  - Best LR: 0.000330
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>  - Best epochs: 3 epochs
<a id="__codelineno-14-8" name="__codelineno-14-8"></a>  - Batch size: 128
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a>[Model structure]
<a id="__codelineno-14-11" name="__codelineno-14-11"></a>  - Model type: Pretrained ResNet18
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>  - Model structure:
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>ResNet18(
<a id="__codelineno-14-14" name="__codelineno-14-14"></a>  (resnet): ResNet(
<a id="__codelineno-14-15" name="__codelineno-14-15"></a>    (conv1): Conv2d(3, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-16" name="__codelineno-14-16"></a>    (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-17" name="__codelineno-14-17"></a>    (relu): ReLU(inplace=True)
<a id="__codelineno-14-18" name="__codelineno-14-18"></a>    (maxpool): Identity()
<a id="__codelineno-14-19" name="__codelineno-14-19"></a>    (layer1): Sequential(
<a id="__codelineno-14-20" name="__codelineno-14-20"></a>      (0): BasicBlock(
<a id="__codelineno-14-21" name="__codelineno-14-21"></a>        (conv1): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-22" name="__codelineno-14-22"></a>        (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-23" name="__codelineno-14-23"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-14-24" name="__codelineno-14-24"></a>        (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-25" name="__codelineno-14-25"></a>        (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-26" name="__codelineno-14-26"></a>      )
<a id="__codelineno-14-27" name="__codelineno-14-27"></a>      (1): BasicBlock(
<a id="__codelineno-14-28" name="__codelineno-14-28"></a>        (conv1): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-29" name="__codelineno-14-29"></a>        (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-30" name="__codelineno-14-30"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-14-31" name="__codelineno-14-31"></a>        (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-32" name="__codelineno-14-32"></a>        (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-33" name="__codelineno-14-33"></a>      )
<a id="__codelineno-14-34" name="__codelineno-14-34"></a>    )
<a id="__codelineno-14-35" name="__codelineno-14-35"></a>    (layer2): Sequential(
<a id="__codelineno-14-36" name="__codelineno-14-36"></a>      (0): BasicBlock(
<a id="__codelineno-14-37" name="__codelineno-14-37"></a>        (conv1): Conv2d(64, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
<a id="__codelineno-14-38" name="__codelineno-14-38"></a>        (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-39" name="__codelineno-14-39"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-14-40" name="__codelineno-14-40"></a>        (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-41" name="__codelineno-14-41"></a>        (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-42" name="__codelineno-14-42"></a>        (downsample): Sequential(
<a id="__codelineno-14-43" name="__codelineno-14-43"></a>          (0): Conv2d(64, 128, kernel_size=(1, 1), stride=(2, 2), bias=False)
<a id="__codelineno-14-44" name="__codelineno-14-44"></a>          (1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-45" name="__codelineno-14-45"></a>        )
<a id="__codelineno-14-46" name="__codelineno-14-46"></a>      )
<a id="__codelineno-14-47" name="__codelineno-14-47"></a>      (1): BasicBlock(
<a id="__codelineno-14-48" name="__codelineno-14-48"></a>        (conv1): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-49" name="__codelineno-14-49"></a>        (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-50" name="__codelineno-14-50"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-14-51" name="__codelineno-14-51"></a>        (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-52" name="__codelineno-14-52"></a>        (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-53" name="__codelineno-14-53"></a>      )
<a id="__codelineno-14-54" name="__codelineno-14-54"></a>    )
<a id="__codelineno-14-55" name="__codelineno-14-55"></a>    (layer3): Sequential(
<a id="__codelineno-14-56" name="__codelineno-14-56"></a>      (0): BasicBlock(
<a id="__codelineno-14-57" name="__codelineno-14-57"></a>        (conv1): Conv2d(128, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
<a id="__codelineno-14-58" name="__codelineno-14-58"></a>        (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-59" name="__codelineno-14-59"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-14-60" name="__codelineno-14-60"></a>        (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-61" name="__codelineno-14-61"></a>        (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-62" name="__codelineno-14-62"></a>        (downsample): Sequential(
<a id="__codelineno-14-63" name="__codelineno-14-63"></a>          (0): Conv2d(128, 256, kernel_size=(1, 1), stride=(2, 2), bias=False)
<a id="__codelineno-14-64" name="__codelineno-14-64"></a>          (1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-65" name="__codelineno-14-65"></a>        )
<a id="__codelineno-14-66" name="__codelineno-14-66"></a>      )
<a id="__codelineno-14-67" name="__codelineno-14-67"></a>      (1): BasicBlock(
<a id="__codelineno-14-68" name="__codelineno-14-68"></a>        (conv1): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-69" name="__codelineno-14-69"></a>        (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-70" name="__codelineno-14-70"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-14-71" name="__codelineno-14-71"></a>        (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-72" name="__codelineno-14-72"></a>        (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-73" name="__codelineno-14-73"></a>      )
<a id="__codelineno-14-74" name="__codelineno-14-74"></a>    )
<a id="__codelineno-14-75" name="__codelineno-14-75"></a>    (layer4): Sequential(
<a id="__codelineno-14-76" name="__codelineno-14-76"></a>      (0): BasicBlock(
<a id="__codelineno-14-77" name="__codelineno-14-77"></a>        (conv1): Conv2d(256, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
<a id="__codelineno-14-78" name="__codelineno-14-78"></a>        (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-79" name="__codelineno-14-79"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-14-80" name="__codelineno-14-80"></a>        (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-81" name="__codelineno-14-81"></a>        (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-82" name="__codelineno-14-82"></a>        (downsample): Sequential(
<a id="__codelineno-14-83" name="__codelineno-14-83"></a>          (0): Conv2d(256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False)
<a id="__codelineno-14-84" name="__codelineno-14-84"></a>          (1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-85" name="__codelineno-14-85"></a>        )
<a id="__codelineno-14-86" name="__codelineno-14-86"></a>      )
<a id="__codelineno-14-87" name="__codelineno-14-87"></a>      (1): BasicBlock(
<a id="__codelineno-14-88" name="__codelineno-14-88"></a>        (conv1): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-89" name="__codelineno-14-89"></a>        (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-90" name="__codelineno-14-90"></a>        (relu): ReLU(inplace=True)
<a id="__codelineno-14-91" name="__codelineno-14-91"></a>        (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
<a id="__codelineno-14-92" name="__codelineno-14-92"></a>        (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
<a id="__codelineno-14-93" name="__codelineno-14-93"></a>      )
<a id="__codelineno-14-94" name="__codelineno-14-94"></a>    )
<a id="__codelineno-14-95" name="__codelineno-14-95"></a>    (avgpool): AdaptiveAvgPool2d(output_size=(1, 1))
<a id="__codelineno-14-96" name="__codelineno-14-96"></a>    (fc): Linear(in_features=512, out_features=10, bias=True)
<a id="__codelineno-14-97" name="__codelineno-14-97"></a>  )
<a id="__codelineno-14-98" name="__codelineno-14-98"></a>)
<a id="__codelineno-14-99" name="__codelineno-14-99"></a>  - Total params: 11,173,962
<a id="__codelineno-14-100" name="__codelineno-14-100"></a>
<a id="__codelineno-14-101" name="__codelineno-14-101"></a>[Training infomation]
<a id="__codelineno-14-102" name="__codelineno-14-102"></a>  - Training duration on full training set: 1m 55s
<a id="__codelineno-14-103" name="__codelineno-14-103"></a>  - Training device: cuda on Kaggle's free P100, Thank you Google!
<a id="__codelineno-14-104" name="__codelineno-14-104"></a>
<a id="__codelineno-14-105" name="__codelineno-14-105"></a>[Benchmarks on test set]
<a id="__codelineno-14-106" name="__codelineno-14-106"></a>  - Test loss: 0.3450
<a id="__codelineno-14-107" name="__codelineno-14-107"></a>  - Test accuracy: 89.06%
<a id="__codelineno-14-108" name="__codelineno-14-108"></a>
<a id="__codelineno-14-109" name="__codelineno-14-109"></a>==================================================
</code></pre></div></td></tr></table></div>
</details>
<h3 id="resnet-18_1">对 ResNet-18 模型的解读和评述<a class="headerlink" href="#resnet-18_1" title="Permanent link">¶</a></h3>
<p>考虑到笔者使用的 GPU 性能较弱，本次使用的是 ResNet-18 架构，这是一个相对浅的 ResNet，相比于 ResNet-50 等基于 BottleNeck 块的网络，ResNet-18 由稍有不同的 BasicBlock 组成。</p>
<p>ResNet-18 的结构如下所示：</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef result fill:#45475a,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4;
    classDef conv fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;

    %% Input Layer
    subgraph Input["Input"]
        A[("3 @ 32×32")]
    end
    class Input input;

    %% Initial Convolution
    subgraph InitConv["Initial Convolution"]
        B["Conv2d &lt;br&gt; 3x64 x 3×3"] 
        C["BatchNorm2d &lt;br&gt; 64 channels"]
        D["ReLU"]
    end
    A --&gt; B
    B --&gt; C --&gt; D
    class InitConv conv;

    %% Layer 1 (2× BasicBlock without downsample)
    subgraph Layer1["Layer1 (2×BasicBlock)"]
        F["BasicBlock 1"]
        G["BasicBlock 1"]
    end
    D --&gt; |64 @ 32×32| F
    F --&gt; |64 @ 32×32| G
    class Layer1 box;

    %% Layer 2 (2× BasicBlock with downsample in first block)
    subgraph Layer2["Layer2 (2×BasicBlock)"]
        H["BasicBlock 2"]
        I["BasicBlock 1"]
    end
    G --&gt; |64 @ 32×32| H
    H --&gt; |128 @ 16×16| I
    class Layer2 box;

    %% Layer 3 (2× BasicBlock with downsample in first block)
    subgraph Layer3["Layer3 (2×BasicBlock)"]
        J["BasicBlock 2"]
        K["BasicBlock 1"]
    end
    I --&gt; |128 @ 16×16| J
    J --&gt; |256 @ 8×8| K
    class Layer3 box;

    %% Layer 4 (2× BasicBlock with downsample in first block)
    subgraph Layer4["Layer4 (2×BasicBlock)"]
        L["BasicBlock 2"]
        M["BasicBlock 1"]
    end
    K --&gt; |256 @ 8×8| L
    L --&gt; |512 @ 4×4| M
    class Layer4 box;

    %% Global Pooling and FC
    subgraph PoolFC["GAP &amp; Classfiaction"]
        N["AdaptiveAvgPool2d &lt;br&gt; 1×1"]
        O["Flatten &lt;br&gt; 512-dim vec"]
        P["Linear &lt;br&gt; 512x10"]
    end
    M --&gt; |512 @ 4×4| N --&gt; |512 @ 1×1| O --&gt; |512| P
    class PoolFC box;

    %% Output Layer
    subgraph Output["output"]
        Q[("10")]
    end
    P --&gt; Q
    class Output output;

    %% Styling
    style A stroke-dasharray: 5 5
    style Q stroke:#a6e3a1,stroke-width:3px</code></pre>
<p>其中，Basic block 1 是不带降采样的残差连接：</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef residual fill:#313244,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;

    %% BasicBlock Structure (No Downsample)
    subgraph BasicBlockNoDS["BasicBlock 1"]
        A["Conv2d &lt;br&gt; 64x64 x 3×3"] 
        B["BatchNorm2d &lt;br&gt; 64 channels"]
        C["ReLU"]
        D["Conv2d &lt;br&gt; 64x64 x 3×3"] 
        E["BatchNorm2d &lt;br&gt; 64 channels"]
        F(("+"))
        G["ReLU"]
    end

    %% Input
    Input[("64 @ H×W")] --&gt; A
    Input --&gt; F

    %% Connections
    A --&gt; B --&gt; C --&gt; D --&gt; E --&gt; F
    F --&gt; G

    %% Output
    G --&gt; Output[("64 @ H×W")]

    class BasicBlockNoDS residual;</code></pre>
<p>Basic block 2 是带降采样的残差连接：</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef residual fill:#313244,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;
    classDef downsample fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;

    %% BasicBlock Structure (With Downsample)
    subgraph BasicBlockWithDS["BasicBlock 2"]
        A["Conv2d &lt;br&gt; 64x128 x 3×3 /2"] 
        B["BatchNorm2d &lt;br&gt; 128 channels"]
        C["ReLU"]
        D["Conv2d: 128x128 x 3×3"] 
        E["BatchNorm2d &lt;br&gt; 128 channels"]
        F(("+"))
        G["ReLU"]

        subgraph Downsample["Downsampling"]
            H["Conv2d: 64x128 x 1×1 /2"]
            I["BatchNorm2d &lt;br&gt; 128 channels"]
        end
    end

    %% Input
    Input[("64 @ H×W")] --&gt; A
    Input --&gt; H

    %% Connections
    A --&gt; B --&gt; C --&gt; D --&gt; E --&gt; F
    H --&gt; I --&gt; F
    F --&gt; G

    %% Output
    G --&gt; Output[("128 @ H/2×W/2")]

    class BasicBlockWithDS residual;
    class Downsample downsample;</code></pre>
<p>ResNet-18 的结构（在长宽维度）正如一个漏斗一样，除了初始化层和 Layer 1 以外，其余的 Layer 都是 Basic block 2 -&gt; Basic block 1 的结构，也就是归纳特征到提取特征的一个顺序。最后使用自适应性池化来应对不同的输入。因为 torch 提供的 ResNet-18 是基于 ImageNet 设计的，输入是 3@224x224，利用自适应性池化，就可以只用修改对输入的处理了。</p>
<p>除此之外，ResNet 使用了多种技术才使如此深层的网络成为可能。</p>
<p>一是使用 ReLU 激活。其他激活函数如 sigmoid，其导数在 <span class="arithmatex">\([-1,1]\)</span> 之间，这就导致梯度向深层流动的时候不断被一个绝对值小于 <span class="arithmatex">\(1\)</span> 的数乘起来，逐渐消失。ReLU 求导要么 <span class="arithmatex">\(0\)</span> 要么 <span class="arithmatex">\(1\)</span>，也就是梯度要么在负数输出处停止流动要么就直接原封不动传下去。</p>
<p>二是使用 BatchNorm2d。批归一化试图将数据拉回标准正态分布，这解耦了层与层之间的输入依赖，相当于每一层都只用将一批标准正态数据映射到标准正态数据，独立性大大增强，反映到损失地形上，就是对模型的微扰（也就是优化器带来的参数更新）带来的（可能的）巨大扰动（即崎岖的损失地形）给平坦化了。</p>
<p>当然上面的两点在一般的 CNN 中都有使用，像 GoogLeNet 这种基于 Inception 的网络也只有 22 层，但是基于 ResNet 的网络可以轻松达到成百上千层，关键在于——</p>
<p>三是残差连接。Kaiming 意识到以下对比：考虑一般的神经网络单层</p>
<div class="arithmatex">\[
y=\phi (\mathrm{Layer}(x))
\]</div>
<p>其中 <span class="arithmatex">\(y\)</span> 为输出，<span class="arithmatex">\(\phi\)</span> 为激活函数，<span class="arithmatex">\(\mathrm{Layer}\)</span> 为对输入 <span class="arithmatex">\(x\)</span> 做的操作，比如矩阵乘法或者卷积等。</p>
<p>那么向前传递的梯度为</p>
<div class="arithmatex">\[
\dfrac{\partial y}{\partial x}=\dfrac{\partial \mathrm{Layer}}{\partial x}\phi' (\mathrm{Layer}(x))
\]</div>
<p>也就是一个数乘以小于等于 <span class="arithmatex">\(1\)</span> 的数。但是，如果我们考虑这样的单层：</p>
<div class="arithmatex">\[
y=\phi (x+\mathrm{Layer}(x))
\]</div>
<p>那么向前传递的梯度为</p>
<div class="arithmatex">\[
\dfrac{\partial y}{\partial x}=(1+\dfrac{\partial \mathrm{Layer}}{\partial x})\phi' (\mathrm{Layer}(x))
\]</div>
<p>嗯，这样传递到的梯度确实变多了，但是还是受制于激活函数的导数啊，感觉……用处不大？</p>
<p>呵呵，事情没有那么简单。要不回头看看网络结构里面<strong>ReLU的位置到底在哪里</strong>呢？</p>
<p>是在两个 conv2d 的中间！也就是说，事实上顺序应该是</p>
<div class="arithmatex">\[
y=x+\phi (\mathrm{Layer}(x))
\]</div>
<p>那么向前传递的梯度为</p>
<div class="arithmatex">\[
\dfrac{\partial y}{\partial x}=1+\dfrac{\partial \mathrm{Layer}}{\partial x}\phi' (\mathrm{Layer}(x))
\]</div>
<p>这样，不管自己梯度多少，深层的梯度就都能顺畅流动到浅层了。</p>
<p>当然 Kaiming 在论文里面的观点是恒等变换不易学习所以转而学习残差，这样即使什么都没有学到，至少还能保留恒等映射的能力。不过我更喜欢从数学角度推导咯~</p>
<p>最后可以看到 ResNet-18 虽然宽度比 CNN 大一倍，但是居然可以承受比 CNN 大好几个数量级的学习率，原因就在于这几个方案使得损失地形极度平滑，参数更新量即使比较大，也不会有特别大的震荡。然后 muP 的理论在这里就完全失效了，毕竟 muP 研究的是同一模型不同尺度的参数调整规律。</p>
<p>后面我使用 torch 官方提供的在 ImageNet 上预训练的权重，使用更小的学习率就可以得到更加的效果，果然预训练就是最佳的参数初始化策略啊。</p>
<p>可以看到 ResNet 的测试准确率有上了一个台阶。网上也是到处都有 ResNet 爆改 YOLOv8 骨干网络的博客，看来大家都很喜欢残差连接啊。</p>
<p>ResNet-50, ResNeXt, DenseNet, EfficientNet 等架构中也是将残差连接作为基础（DenseNet 更是扩展了这一思路）。这些网络的复现和讲解敬请期待。</p>
<p>下面的 Transformer 模型也利用了残差连接。甚至 FCN 和 U-Net 等也汲取了类似的思路引入了跳跃连接。这一部分的复现请参考本系列博客的 <a href="https://dicaeopolis.github.io/DNN/model-expr/S-and-D-models-replication/">第二篇</a>。</p>
<p>毕竟参数量够大，Scaling law 持续发力中......不过提到 Scaling law，怎么能不请出我们的 Transformer 模型呢？</p>
<h2 id="vit">ViT<a class="headerlink" href="#vit" title="Permanent link">¶</a></h2>
<h3 id="vit_1">ViT 模型的训练结果展示<a class="headerlink" href="#vit_1" title="Permanent link">¶</a></h3>
<details>
<summary> nanoViT 的训练代码</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">  1</a></span>
<span class="normal"><a href="#__codelineno-15-2">  2</a></span>
<span class="normal"><a href="#__codelineno-15-3">  3</a></span>
<span class="normal"><a href="#__codelineno-15-4">  4</a></span>
<span class="normal"><a href="#__codelineno-15-5">  5</a></span>
<span class="normal"><a href="#__codelineno-15-6">  6</a></span>
<span class="normal"><a href="#__codelineno-15-7">  7</a></span>
<span class="normal"><a href="#__codelineno-15-8">  8</a></span>
<span class="normal"><a href="#__codelineno-15-9">  9</a></span>
<span class="normal"><a href="#__codelineno-15-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-15-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-15-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-15-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-15-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-15-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-15-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-15-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-15-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-15-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-15-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-15-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-15-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-15-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-15-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-15-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-15-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-15-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-15-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-15-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-15-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-15-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-15-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-15-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-15-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-15-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-15-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-15-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-15-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-15-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-15-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-15-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-15-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-15-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-15-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-15-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-15-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-15-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-15-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-15-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-15-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-15-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-15-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-15-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-15-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-15-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-15-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-15-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-15-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-15-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-15-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-15-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-15-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-15-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-15-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-15-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-15-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-15-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-15-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-15-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-15-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-15-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-15-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-15-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-15-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-15-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-15-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-15-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-15-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-15-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-15-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-15-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-15-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-15-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-15-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-15-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-15-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-15-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-15-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-15-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-15-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-15-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-15-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-15-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-15-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-15-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-15-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-15-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-15-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-15-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-15-100">100</a></span>
<span class="normal"><a href="#__codelineno-15-101">101</a></span>
<span class="normal"><a href="#__codelineno-15-102">102</a></span>
<span class="normal"><a href="#__codelineno-15-103">103</a></span>
<span class="normal"><a href="#__codelineno-15-104">104</a></span>
<span class="normal"><a href="#__codelineno-15-105">105</a></span>
<span class="normal"><a href="#__codelineno-15-106">106</a></span>
<span class="normal"><a href="#__codelineno-15-107">107</a></span>
<span class="normal"><a href="#__codelineno-15-108">108</a></span>
<span class="normal"><a href="#__codelineno-15-109">109</a></span>
<span class="normal"><a href="#__codelineno-15-110">110</a></span>
<span class="normal"><a href="#__codelineno-15-111">111</a></span>
<span class="normal"><a href="#__codelineno-15-112">112</a></span>
<span class="normal"><a href="#__codelineno-15-113">113</a></span>
<span class="normal"><a href="#__codelineno-15-114">114</a></span>
<span class="normal"><a href="#__codelineno-15-115">115</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">PatchEmbedding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="sd">"""将图像分割为补丁并进行嵌入"""</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="n">img_size</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patch_size</span> <span class="o">=</span> <span class="n">patch_size</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a>        <span class="c1"># 计算补丁数量</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_patches</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_size</span> <span class="o">//</span> <span class="n">patch_size</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a>        <span class="c1"># 使用卷积层实现补丁嵌入 (等价于每个补丁应用一个卷积核)</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a>            <span class="n">in_channels</span><span class="p">,</span> 
<a id="__codelineno-15-15" name="__codelineno-15-15"></a>            <span class="n">embed_dim</span><span class="p">,</span> 
<a id="__codelineno-15-16" name="__codelineno-15-16"></a>            <span class="n">kernel_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span> 
<a id="__codelineno-15-17" name="__codelineno-15-17"></a>            <span class="n">stride</span><span class="o">=</span><span class="n">patch_size</span>
<a id="__codelineno-15-18" name="__codelineno-15-18"></a>        <span class="p">)</span>
<a id="__codelineno-15-19" name="__codelineno-15-19"></a>
<a id="__codelineno-15-20" name="__codelineno-15-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-15-21" name="__codelineno-15-21"></a>        <span class="c1"># x形状: (batch_size, in_channels, img_size, img_size)</span>
<a id="__codelineno-15-22" name="__codelineno-15-22"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># 输出形状: (batch_size, embed_dim, num_patches^(1/2), num_patches^(1/2))</span>
<a id="__codelineno-15-23" name="__codelineno-15-23"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 输出形状: (batch_size, embed_dim, num_patches)</span>
<a id="__codelineno-15-24" name="__codelineno-15-24"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 输出形状: (batch_size, num_patches, embed_dim)</span>
<a id="__codelineno-15-25" name="__codelineno-15-25"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-15-26" name="__codelineno-15-26"></a>
<a id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">TransformerClassifier</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="w">    </span><span class="sd">"""用于CIFAR-10分类的Transformer模型"""</span>
<a id="__codelineno-15-29" name="__codelineno-15-29"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-15-30" name="__codelineno-15-30"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-15-31" name="__codelineno-15-31"></a>        <span class="n">img_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-15-32" name="__codelineno-15-32"></a>        <span class="n">patch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-15-33" name="__codelineno-15-33"></a>        <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-15-34" name="__codelineno-15-34"></a>        <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-15-35" name="__codelineno-15-35"></a>        <span class="n">embed_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-15-36" name="__codelineno-15-36"></a>        <span class="n">depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>          <span class="c1"># Transformer编码器层数</span>
<a id="__codelineno-15-37" name="__codelineno-15-37"></a>        <span class="n">num_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>      <span class="c1"># 注意力头数</span>
<a id="__codelineno-15-38" name="__codelineno-15-38"></a>        <span class="n">mlp_ratio</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>    <span class="c1"># MLP隐藏层维度比例</span>
<a id="__codelineno-15-39" name="__codelineno-15-39"></a>        <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>      <span class="c1"># Dropout概率</span>
<a id="__codelineno-15-40" name="__codelineno-15-40"></a>    <span class="p">):</span>
<a id="__codelineno-15-41" name="__codelineno-15-41"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-15-42" name="__codelineno-15-42"></a>
<a id="__codelineno-15-43" name="__codelineno-15-43"></a>        <span class="c1"># 补丁嵌入</span>
<a id="__codelineno-15-44" name="__codelineno-15-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span> <span class="o">=</span> <span class="n">PatchEmbedding</span><span class="p">(</span>
<a id="__codelineno-15-45" name="__codelineno-15-45"></a>            <span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span>
<a id="__codelineno-15-46" name="__codelineno-15-46"></a>            <span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span>
<a id="__codelineno-15-47" name="__codelineno-15-47"></a>            <span class="n">in_channels</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span>
<a id="__codelineno-15-48" name="__codelineno-15-48"></a>            <span class="n">embed_dim</span><span class="o">=</span><span class="n">embed_dim</span>
<a id="__codelineno-15-49" name="__codelineno-15-49"></a>        <span class="p">)</span>
<a id="__codelineno-15-50" name="__codelineno-15-50"></a>        <span class="n">num_patches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="o">.</span><span class="n">num_patches</span>
<a id="__codelineno-15-51" name="__codelineno-15-51"></a>
<a id="__codelineno-15-52" name="__codelineno-15-52"></a>        <span class="c1"># 类别令牌 (用于最终分类)</span>
<a id="__codelineno-15-53" name="__codelineno-15-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">class_token</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">))</span>
<a id="__codelineno-15-54" name="__codelineno-15-54"></a>
<a id="__codelineno-15-55" name="__codelineno-15-55"></a>        <span class="c1"># 位置嵌入 (可学习)</span>
<a id="__codelineno-15-56" name="__codelineno-15-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_patches</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">))</span>
<a id="__codelineno-15-57" name="__codelineno-15-57"></a>
<a id="__codelineno-15-58" name="__codelineno-15-58"></a>        <span class="c1"># Dropout层</span>
<a id="__codelineno-15-59" name="__codelineno-15-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-15-60" name="__codelineno-15-60"></a>
<a id="__codelineno-15-61" name="__codelineno-15-61"></a>        <span class="c1"># Transformer编码器</span>
<a id="__codelineno-15-62" name="__codelineno-15-62"></a>        <span class="n">encoder_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
<a id="__codelineno-15-63" name="__codelineno-15-63"></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">,</span>
<a id="__codelineno-15-64" name="__codelineno-15-64"></a>            <span class="n">nhead</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span>
<a id="__codelineno-15-65" name="__codelineno-15-65"></a>            <span class="n">dim_feedforward</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">embed_dim</span> <span class="o">*</span> <span class="n">mlp_ratio</span><span class="p">),</span>
<a id="__codelineno-15-66" name="__codelineno-15-66"></a>            <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
<a id="__codelineno-15-67" name="__codelineno-15-67"></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 批处理维度在前</span>
<a id="__codelineno-15-68" name="__codelineno-15-68"></a>        <span class="p">)</span>
<a id="__codelineno-15-69" name="__codelineno-15-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer_encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">encoder_layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">depth</span><span class="p">)</span>
<a id="__codelineno-15-70" name="__codelineno-15-70"></a>
<a id="__codelineno-15-71" name="__codelineno-15-71"></a>        <span class="c1"># 分类头</span>
<a id="__codelineno-15-72" name="__codelineno-15-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-15-73" name="__codelineno-15-73"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">),</span>
<a id="__codelineno-15-74" name="__codelineno-15-74"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<a id="__codelineno-15-75" name="__codelineno-15-75"></a>        <span class="p">)</span>
<a id="__codelineno-15-76" name="__codelineno-15-76"></a>
<a id="__codelineno-15-77" name="__codelineno-15-77"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-15-78" name="__codelineno-15-78"></a>        <span class="c1"># x形状: (batch_size, 3, 32, 32)</span>
<a id="__codelineno-15-79" name="__codelineno-15-79"></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-15-80" name="__codelineno-15-80"></a>
<a id="__codelineno-15-81" name="__codelineno-15-81"></a>        <span class="c1"># 补丁嵌入</span>
<a id="__codelineno-15-82" name="__codelineno-15-82"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># 输出形状: (batch_size, num_patches, embed_dim)</span>
<a id="__codelineno-15-83" name="__codelineno-15-83"></a>
<a id="__codelineno-15-84" name="__codelineno-15-84"></a>        <span class="c1"># 扩展类别令牌到批次大小</span>
<a id="__codelineno-15-85" name="__codelineno-15-85"></a>        <span class="n">class_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_token</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 形状: (batch_size, 1, embed_dim)</span>
<a id="__codelineno-15-86" name="__codelineno-15-86"></a>
<a id="__codelineno-15-87" name="__codelineno-15-87"></a>        <span class="c1"># 将类别令牌与补丁嵌入拼接</span>
<a id="__codelineno-15-88" name="__codelineno-15-88"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">class_tokens</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 形状: (batch_size, num_patches + 1, embed_dim)</span>
<a id="__codelineno-15-89" name="__codelineno-15-89"></a>
<a id="__codelineno-15-90" name="__codelineno-15-90"></a>        <span class="c1"># 添加位置嵌入并应用dropout</span>
<a id="__codelineno-15-91" name="__codelineno-15-91"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span>
<a id="__codelineno-15-92" name="__codelineno-15-92"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_drop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-15-93" name="__codelineno-15-93"></a>
<a id="__codelineno-15-94" name="__codelineno-15-94"></a>        <span class="c1"># Transformer编码</span>
<a id="__codelineno-15-95" name="__codelineno-15-95"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># 形状: (batch_size, num_patches + 1, embed_dim)</span>
<a id="__codelineno-15-96" name="__codelineno-15-96"></a>
<a id="__codelineno-15-97" name="__codelineno-15-97"></a>        <span class="c1"># 使用类别令牌的输出进行分类</span>
<a id="__codelineno-15-98" name="__codelineno-15-98"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># 取类别令牌对应的输出，形状: (batch_size, embed_dim)</span>
<a id="__codelineno-15-99" name="__codelineno-15-99"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># 形状: (batch_size, num_classes)</span>
<a id="__codelineno-15-100" name="__codelineno-15-100"></a>
<a id="__codelineno-15-101" name="__codelineno-15-101"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-15-102" name="__codelineno-15-102"></a>
<a id="__codelineno-15-103" name="__codelineno-15-103"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_model_on_device</span><span class="p">():</span>
<a id="__codelineno-15-104" name="__codelineno-15-104"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">TransformerClassifier</span><span class="p">(</span>
<a id="__codelineno-15-105" name="__codelineno-15-105"></a>        <span class="n">img_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-15-106" name="__codelineno-15-106"></a>        <span class="n">patch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-15-107" name="__codelineno-15-107"></a>        <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-15-108" name="__codelineno-15-108"></a>        <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-15-109" name="__codelineno-15-109"></a>        <span class="n">embed_dim</span><span class="o">=</span><span class="mi">192</span><span class="p">,</span>
<a id="__codelineno-15-110" name="__codelineno-15-110"></a>        <span class="n">depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-15-111" name="__codelineno-15-111"></a>        <span class="n">num_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<a id="__codelineno-15-112" name="__codelineno-15-112"></a>        <span class="n">mlp_ratio</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
<a id="__codelineno-15-113" name="__codelineno-15-113"></a>        <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span>
<a id="__codelineno-15-114" name="__codelineno-15-114"></a>    <span class="p">)</span>
<a id="__codelineno-15-115" name="__codelineno-15-115"></a>    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> ViT-B-16 的微调代码（原理）</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span>
<span class="normal"><a href="#__codelineno-16-40">40</a></span>
<span class="normal"><a href="#__codelineno-16-41">41</a></span>
<span class="normal"><a href="#__codelineno-16-42">42</a></span>
<span class="normal"><a href="#__codelineno-16-43">43</a></span>
<span class="normal"><a href="#__codelineno-16-44">44</a></span>
<span class="normal"><a href="#__codelineno-16-45">45</a></span>
<span class="normal"><a href="#__codelineno-16-46">46</a></span>
<span class="normal"><a href="#__codelineno-16-47">47</a></span>
<span class="normal"><a href="#__codelineno-16-48">48</a></span>
<span class="normal"><a href="#__codelineno-16-49">49</a></span>
<span class="normal"><a href="#__codelineno-16-50">50</a></span>
<span class="normal"><a href="#__codelineno-16-51">51</a></span>
<span class="normal"><a href="#__codelineno-16-52">52</a></span>
<span class="normal"><a href="#__codelineno-16-53">53</a></span>
<span class="normal"><a href="#__codelineno-16-54">54</a></span>
<span class="normal"><a href="#__codelineno-16-55">55</a></span>
<span class="normal"><a href="#__codelineno-16-56">56</a></span>
<span class="normal"><a href="#__codelineno-16-57">57</a></span>
<span class="normal"><a href="#__codelineno-16-58">58</a></span>
<span class="normal"><a href="#__codelineno-16-59">59</a></span>
<span class="normal"><a href="#__codelineno-16-60">60</a></span>
<span class="normal"><a href="#__codelineno-16-61">61</a></span>
<span class="normal"><a href="#__codelineno-16-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">models</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">T</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ViT_B_16_Weights</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">ViT_Cifar10</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="sd">    一个真正“即插即用”的ViT-B/16模型，专门用于CIFAR-10。</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="sd">    这个类会自动处理输入尺寸不匹配的问题：</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="sd">    1. 内置一个上采样层，在前向传播时自动将输入的32x32图像放大到224x224。</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="sd">    2. 加载在ImageNet上预训练的ViT-B/16权重。</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="sd">    3. 将分类头替换为适用于CIFAR-10的10个类别。</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="sd">    """</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a>        <span class="c1"># 步骤1: 定义一个上采样/调整大小的层</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a>        <span class="c1"># T.Resize 是 torchvision.transforms 中的一个类，它可以作为 nn.Module 使用</span>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">upsampler</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span> <span class="n">antialias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a>        <span class="c1"># 步骤2: 加载预训练的ViT模型</span>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vit</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">vit_b_16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">ViT_B_16_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span><span class="p">)</span>
<a id="__codelineno-16-25" name="__codelineno-16-25"></a>
<a id="__codelineno-16-26" name="__codelineno-16-26"></a>        <span class="c1"># 步骤3: 冻结主干网络的所有参数</span>
<a id="__codelineno-16-27" name="__codelineno-16-27"></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vit</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-16-28" name="__codelineno-16-28"></a>            <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-16-29" name="__codelineno-16-29"></a>
<a id="__codelineno-16-30" name="__codelineno-16-30"></a>        <span class="c1"># 步骤4: 替换分类头</span>
<a id="__codelineno-16-31" name="__codelineno-16-31"></a>        <span class="n">in_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vit</span><span class="o">.</span><span class="n">heads</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">in_features</span>
<a id="__codelineno-16-32" name="__codelineno-16-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vit</span><span class="o">.</span><span class="n">heads</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="n">num_classes</span><span class="p">)</span>
<a id="__codelineno-16-33" name="__codelineno-16-33"></a>
<a id="__codelineno-16-34" name="__codelineno-16-34"></a>        <span class="c1"># 确保新分类头的参数是可训练的</span>
<a id="__codelineno-16-35" name="__codelineno-16-35"></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vit</span><span class="o">.</span><span class="n">heads</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-16-36" name="__codelineno-16-36"></a>            <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-16-37" name="__codelineno-16-37"></a>
<a id="__codelineno-16-38" name="__codelineno-16-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-16-39" name="__codelineno-16-39"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-16-40" name="__codelineno-16-40"></a><span class="sd">        定义模型的前向传播。</span>
<a id="__codelineno-16-41" name="__codelineno-16-41"></a>
<a id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="sd">        Args:</span>
<a id="__codelineno-16-43" name="__codelineno-16-43"></a><span class="sd">            x (torch.Tensor): 输入的图像张量，可以是 (B, 3, 32, 32)</span>
<a id="__codelineno-16-44" name="__codelineno-16-44"></a>
<a id="__codelineno-16-45" name="__codelineno-16-45"></a><span class="sd">        Returns:</span>
<a id="__codelineno-16-46" name="__codelineno-16-46"></a><span class="sd">            torch.Tensor: 模型输出的logits，形状为 (B, num_classes)</span>
<a id="__codelineno-16-47" name="__codelineno-16-47"></a><span class="sd">        """</span>
<a id="__codelineno-16-48" name="__codelineno-16-48"></a>        <span class="c1"># --- 关键改动 ---</span>
<a id="__codelineno-16-49" name="__codelineno-16-49"></a>        <span class="c1"># 在送入ViT之前，首先将输入图像上采样到224x224</span>
<a id="__codelineno-16-50" name="__codelineno-16-50"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upsampler</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-16-51" name="__codelineno-16-51"></a>
<a id="__codelineno-16-52" name="__codelineno-16-52"></a>        <span class="c1"># 现在，尺寸匹配了，可以安全地调用ViT</span>
<a id="__codelineno-16-53" name="__codelineno-16-53"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-16-54" name="__codelineno-16-54"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_model_on_device</span><span class="p">():</span>
<a id="__codelineno-16-55" name="__codelineno-16-55"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-16-56" name="__codelineno-16-56"></a><span class="sd">    实例化ViTForCifar10模型，并将其移动到在主作用域中定义的设备上。</span>
<a id="__codelineno-16-57" name="__codelineno-16-57"></a>
<a id="__codelineno-16-58" name="__codelineno-16-58"></a><span class="sd">    Returns:</span>
<a id="__codelineno-16-59" name="__codelineno-16-59"></a><span class="sd">        ViTForCifar10: 配置好并移动到设备上的模型实例。</span>
<a id="__codelineno-16-60" name="__codelineno-16-60"></a><span class="sd">    """</span>
<a id="__codelineno-16-61" name="__codelineno-16-61"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">ViT_Cifar10</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-16-62" name="__codelineno-16-62"></a>    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> nanoViT 的训练结果</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span>
<span class="normal"><a href="#__codelineno-17-31">31</a></span>
<span class="normal"><a href="#__codelineno-17-32">32</a></span>
<span class="normal"><a href="#__codelineno-17-33">33</a></span>
<span class="normal"><a href="#__codelineno-17-34">34</a></span>
<span class="normal"><a href="#__codelineno-17-35">35</a></span>
<span class="normal"><a href="#__codelineno-17-36">36</a></span>
<span class="normal"><a href="#__codelineno-17-37">37</a></span>
<span class="normal"><a href="#__codelineno-17-38">38</a></span>
<span class="normal"><a href="#__codelineno-17-39">39</a></span>
<span class="normal"><a href="#__codelineno-17-40">40</a></span>
<span class="normal"><a href="#__codelineno-17-41">41</a></span>
<span class="normal"><a href="#__codelineno-17-42">42</a></span>
<span class="normal"><a href="#__codelineno-17-43">43</a></span>
<span class="normal"><a href="#__codelineno-17-44">44</a></span>
<span class="normal"><a href="#__codelineno-17-45">45</a></span>
<span class="normal"><a href="#__codelineno-17-46">46</a></span>
<span class="normal"><a href="#__codelineno-17-47">47</a></span>
<span class="normal"><a href="#__codelineno-17-48">48</a></span>
<span class="normal"><a href="#__codelineno-17-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a>==================================================
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>               Results
<a id="__codelineno-17-3" name="__codelineno-17-3"></a>==================================================
<a id="__codelineno-17-4" name="__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>[Hyper parameters]
<a id="__codelineno-17-6" name="__codelineno-17-6"></a>  - Best LR: 0.000232
<a id="__codelineno-17-7" name="__codelineno-17-7"></a>  - Best epochs: 16 epochs
<a id="__codelineno-17-8" name="__codelineno-17-8"></a>  - Batch size: 128
<a id="__codelineno-17-9" name="__codelineno-17-9"></a>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>[Model structure]
<a id="__codelineno-17-11" name="__codelineno-17-11"></a>  - Model type: ViT
<a id="__codelineno-17-12" name="__codelineno-17-12"></a>  - Model structure:
<a id="__codelineno-17-13" name="__codelineno-17-13"></a>TransformerClassifier(
<a id="__codelineno-17-14" name="__codelineno-17-14"></a>  (patch_embed): PatchEmbedding(
<a id="__codelineno-17-15" name="__codelineno-17-15"></a>    (proj): Conv2d(3, 192, kernel_size=(2, 2), stride=(2, 2))
<a id="__codelineno-17-16" name="__codelineno-17-16"></a>  )
<a id="__codelineno-17-17" name="__codelineno-17-17"></a>  (pos_drop): Dropout(p=0.1, inplace=False)
<a id="__codelineno-17-18" name="__codelineno-17-18"></a>  (transformer_encoder): TransformerEncoder(
<a id="__codelineno-17-19" name="__codelineno-17-19"></a>    (layers): ModuleList(
<a id="__codelineno-17-20" name="__codelineno-17-20"></a>      (0-3): 4 x TransformerEncoderLayer(
<a id="__codelineno-17-21" name="__codelineno-17-21"></a>        (self_attn): MultiheadAttention(
<a id="__codelineno-17-22" name="__codelineno-17-22"></a>          (out_proj): NonDynamicallyQuantizableLinear(in_features=192, out_features=192, bias=True)
<a id="__codelineno-17-23" name="__codelineno-17-23"></a>        )
<a id="__codelineno-17-24" name="__codelineno-17-24"></a>        (linear1): Linear(in_features=192, out_features=384, bias=True)
<a id="__codelineno-17-25" name="__codelineno-17-25"></a>        (dropout): Dropout(p=0.1, inplace=False)
<a id="__codelineno-17-26" name="__codelineno-17-26"></a>        (linear2): Linear(in_features=384, out_features=192, bias=True)
<a id="__codelineno-17-27" name="__codelineno-17-27"></a>        (norm1): LayerNorm((192,), eps=1e-05, elementwise_affine=True)
<a id="__codelineno-17-28" name="__codelineno-17-28"></a>        (norm2): LayerNorm((192,), eps=1e-05, elementwise_affine=True)
<a id="__codelineno-17-29" name="__codelineno-17-29"></a>        (dropout1): Dropout(p=0.1, inplace=False)
<a id="__codelineno-17-30" name="__codelineno-17-30"></a>        (dropout2): Dropout(p=0.1, inplace=False)
<a id="__codelineno-17-31" name="__codelineno-17-31"></a>      )
<a id="__codelineno-17-32" name="__codelineno-17-32"></a>    )
<a id="__codelineno-17-33" name="__codelineno-17-33"></a>  )
<a id="__codelineno-17-34" name="__codelineno-17-34"></a>  (classifier): Sequential(
<a id="__codelineno-17-35" name="__codelineno-17-35"></a>    (0): LayerNorm((192,), eps=1e-05, elementwise_affine=True)
<a id="__codelineno-17-36" name="__codelineno-17-36"></a>    (1): Linear(in_features=192, out_features=10, bias=True)
<a id="__codelineno-17-37" name="__codelineno-17-37"></a>  )
<a id="__codelineno-17-38" name="__codelineno-17-38"></a>)
<a id="__codelineno-17-39" name="__codelineno-17-39"></a>  - Total params: 1,242,442
<a id="__codelineno-17-40" name="__codelineno-17-40"></a>
<a id="__codelineno-17-41" name="__codelineno-17-41"></a>[Training infomation]
<a id="__codelineno-17-42" name="__codelineno-17-42"></a>  - Training duration on full training set: 19m 55s
<a id="__codelineno-17-43" name="__codelineno-17-43"></a>  - Training device: cuda on Kaggle's free P100, Thank you Google!
<a id="__codelineno-17-44" name="__codelineno-17-44"></a>
<a id="__codelineno-17-45" name="__codelineno-17-45"></a>[Benchmarks on test set]
<a id="__codelineno-17-46" name="__codelineno-17-46"></a>  - Test loss: 0.7802
<a id="__codelineno-17-47" name="__codelineno-17-47"></a>  - Test accuracy: 73.24%
<a id="__codelineno-17-48" name="__codelineno-17-48"></a>
<a id="__codelineno-17-49" name="__codelineno-17-49"></a>==================================================
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> ViT-B-16 的微调结果 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">  1</a></span>
<span class="normal"><a href="#__codelineno-18-2">  2</a></span>
<span class="normal"><a href="#__codelineno-18-3">  3</a></span>
<span class="normal"><a href="#__codelineno-18-4">  4</a></span>
<span class="normal"><a href="#__codelineno-18-5">  5</a></span>
<span class="normal"><a href="#__codelineno-18-6">  6</a></span>
<span class="normal"><a href="#__codelineno-18-7">  7</a></span>
<span class="normal"><a href="#__codelineno-18-8">  8</a></span>
<span class="normal"><a href="#__codelineno-18-9">  9</a></span>
<span class="normal"><a href="#__codelineno-18-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-18-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-18-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-18-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-18-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-18-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-18-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-18-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-18-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-18-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-18-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-18-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-18-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-18-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-18-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-18-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-18-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-18-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-18-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-18-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-18-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-18-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-18-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-18-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-18-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-18-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-18-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-18-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-18-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-18-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-18-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-18-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-18-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-18-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-18-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-18-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-18-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-18-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-18-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-18-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-18-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-18-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-18-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-18-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-18-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-18-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-18-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-18-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-18-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-18-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-18-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-18-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-18-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-18-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-18-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-18-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-18-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-18-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-18-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-18-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-18-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-18-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-18-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-18-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-18-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-18-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-18-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-18-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-18-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-18-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-18-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-18-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-18-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-18-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-18-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-18-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-18-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-18-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-18-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-18-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-18-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-18-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-18-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-18-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-18-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-18-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-18-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-18-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-18-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-18-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-18-100">100</a></span>
<span class="normal"><a href="#__codelineno-18-101">101</a></span>
<span class="normal"><a href="#__codelineno-18-102">102</a></span>
<span class="normal"><a href="#__codelineno-18-103">103</a></span>
<span class="normal"><a href="#__codelineno-18-104">104</a></span>
<span class="normal"><a href="#__codelineno-18-105">105</a></span>
<span class="normal"><a href="#__codelineno-18-106">106</a></span>
<span class="normal"><a href="#__codelineno-18-107">107</a></span>
<span class="normal"><a href="#__codelineno-18-108">108</a></span>
<span class="normal"><a href="#__codelineno-18-109">109</a></span>
<span class="normal"><a href="#__codelineno-18-110">110</a></span>
<span class="normal"><a href="#__codelineno-18-111">111</a></span>
<span class="normal"><a href="#__codelineno-18-112">112</a></span>
<span class="normal"><a href="#__codelineno-18-113">113</a></span>
<span class="normal"><a href="#__codelineno-18-114">114</a></span>
<span class="normal"><a href="#__codelineno-18-115">115</a></span>
<span class="normal"><a href="#__codelineno-18-116">116</a></span>
<span class="normal"><a href="#__codelineno-18-117">117</a></span>
<span class="normal"><a href="#__codelineno-18-118">118</a></span>
<span class="normal"><a href="#__codelineno-18-119">119</a></span>
<span class="normal"><a href="#__codelineno-18-120">120</a></span>
<span class="normal"><a href="#__codelineno-18-121">121</a></span>
<span class="normal"><a href="#__codelineno-18-122">122</a></span>
<span class="normal"><a href="#__codelineno-18-123">123</a></span>
<span class="normal"><a href="#__codelineno-18-124">124</a></span>
<span class="normal"><a href="#__codelineno-18-125">125</a></span>
<span class="normal"><a href="#__codelineno-18-126">126</a></span>
<span class="normal"><a href="#__codelineno-18-127">127</a></span>
<span class="normal"><a href="#__codelineno-18-128">128</a></span>
<span class="normal"><a href="#__codelineno-18-129">129</a></span>
<span class="normal"><a href="#__codelineno-18-130">130</a></span>
<span class="normal"><a href="#__codelineno-18-131">131</a></span>
<span class="normal"><a href="#__codelineno-18-132">132</a></span>
<span class="normal"><a href="#__codelineno-18-133">133</a></span>
<span class="normal"><a href="#__codelineno-18-134">134</a></span>
<span class="normal"><a href="#__codelineno-18-135">135</a></span>
<span class="normal"><a href="#__codelineno-18-136">136</a></span>
<span class="normal"><a href="#__codelineno-18-137">137</a></span>
<span class="normal"><a href="#__codelineno-18-138">138</a></span>
<span class="normal"><a href="#__codelineno-18-139">139</a></span>
<span class="normal"><a href="#__codelineno-18-140">140</a></span>
<span class="normal"><a href="#__codelineno-18-141">141</a></span>
<span class="normal"><a href="#__codelineno-18-142">142</a></span>
<span class="normal"><a href="#__codelineno-18-143">143</a></span>
<span class="normal"><a href="#__codelineno-18-144">144</a></span>
<span class="normal"><a href="#__codelineno-18-145">145</a></span>
<span class="normal"><a href="#__codelineno-18-146">146</a></span>
<span class="normal"><a href="#__codelineno-18-147">147</a></span>
<span class="normal"><a href="#__codelineno-18-148">148</a></span>
<span class="normal"><a href="#__codelineno-18-149">149</a></span>
<span class="normal"><a href="#__codelineno-18-150">150</a></span>
<span class="normal"><a href="#__codelineno-18-151">151</a></span>
<span class="normal"><a href="#__codelineno-18-152">152</a></span>
<span class="normal"><a href="#__codelineno-18-153">153</a></span>
<span class="normal"><a href="#__codelineno-18-154">154</a></span>
<span class="normal"><a href="#__codelineno-18-155">155</a></span>
<span class="normal"><a href="#__codelineno-18-156">156</a></span>
<span class="normal"><a href="#__codelineno-18-157">157</a></span>
<span class="normal"><a href="#__codelineno-18-158">158</a></span>
<span class="normal"><a href="#__codelineno-18-159">159</a></span>
<span class="normal"><a href="#__codelineno-18-160">160</a></span>
<span class="normal"><a href="#__codelineno-18-161">161</a></span>
<span class="normal"><a href="#__codelineno-18-162">162</a></span>
<span class="normal"><a href="#__codelineno-18-163">163</a></span>
<span class="normal"><a href="#__codelineno-18-164">164</a></span>
<span class="normal"><a href="#__codelineno-18-165">165</a></span>
<span class="normal"><a href="#__codelineno-18-166">166</a></span>
<span class="normal"><a href="#__codelineno-18-167">167</a></span>
<span class="normal"><a href="#__codelineno-18-168">168</a></span>
<span class="normal"><a href="#__codelineno-18-169">169</a></span>
<span class="normal"><a href="#__codelineno-18-170">170</a></span>
<span class="normal"><a href="#__codelineno-18-171">171</a></span>
<span class="normal"><a href="#__codelineno-18-172">172</a></span>
<span class="normal"><a href="#__codelineno-18-173">173</a></span>
<span class="normal"><a href="#__codelineno-18-174">174</a></span>
<span class="normal"><a href="#__codelineno-18-175">175</a></span>
<span class="normal"><a href="#__codelineno-18-176">176</a></span>
<span class="normal"><a href="#__codelineno-18-177">177</a></span>
<span class="normal"><a href="#__codelineno-18-178">178</a></span>
<span class="normal"><a href="#__codelineno-18-179">179</a></span>
<span class="normal"><a href="#__codelineno-18-180">180</a></span>
<span class="normal"><a href="#__codelineno-18-181">181</a></span>
<span class="normal"><a href="#__codelineno-18-182">182</a></span>
<span class="normal"><a href="#__codelineno-18-183">183</a></span>
<span class="normal"><a href="#__codelineno-18-184">184</a></span>
<span class="normal"><a href="#__codelineno-18-185">185</a></span>
<span class="normal"><a href="#__codelineno-18-186">186</a></span>
<span class="normal"><a href="#__codelineno-18-187">187</a></span>
<span class="normal"><a href="#__codelineno-18-188">188</a></span>
<span class="normal"><a href="#__codelineno-18-189">189</a></span>
<span class="normal"><a href="#__codelineno-18-190">190</a></span>
<span class="normal"><a href="#__codelineno-18-191">191</a></span>
<span class="normal"><a href="#__codelineno-18-192">192</a></span>
<span class="normal"><a href="#__codelineno-18-193">193</a></span>
<span class="normal"><a href="#__codelineno-18-194">194</a></span>
<span class="normal"><a href="#__codelineno-18-195">195</a></span>
<span class="normal"><a href="#__codelineno-18-196">196</a></span>
<span class="normal"><a href="#__codelineno-18-197">197</a></span>
<span class="normal"><a href="#__codelineno-18-198">198</a></span>
<span class="normal"><a href="#__codelineno-18-199">199</a></span>
<span class="normal"><a href="#__codelineno-18-200">200</a></span>
<span class="normal"><a href="#__codelineno-18-201">201</a></span>
<span class="normal"><a href="#__codelineno-18-202">202</a></span>
<span class="normal"><a href="#__codelineno-18-203">203</a></span>
<span class="normal"><a href="#__codelineno-18-204">204</a></span>
<span class="normal"><a href="#__codelineno-18-205">205</a></span>
<span class="normal"><a href="#__codelineno-18-206">206</a></span>
<span class="normal"><a href="#__codelineno-18-207">207</a></span>
<span class="normal"><a href="#__codelineno-18-208">208</a></span>
<span class="normal"><a href="#__codelineno-18-209">209</a></span>
<span class="normal"><a href="#__codelineno-18-210">210</a></span>
<span class="normal"><a href="#__codelineno-18-211">211</a></span>
<span class="normal"><a href="#__codelineno-18-212">212</a></span>
<span class="normal"><a href="#__codelineno-18-213">213</a></span>
<span class="normal"><a href="#__codelineno-18-214">214</a></span>
<span class="normal"><a href="#__codelineno-18-215">215</a></span>
<span class="normal"><a href="#__codelineno-18-216">216</a></span>
<span class="normal"><a href="#__codelineno-18-217">217</a></span>
<span class="normal"><a href="#__codelineno-18-218">218</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a>==================================================
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>               Results
<a id="__codelineno-18-3" name="__codelineno-18-3"></a>==================================================
<a id="__codelineno-18-4" name="__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a>[Hyper parameters]
<a id="__codelineno-18-6" name="__codelineno-18-6"></a>  - Best LR: 0.000308
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>  - Best epochs: 45 epochs
<a id="__codelineno-18-8" name="__codelineno-18-8"></a>  - Batch size: 128
<a id="__codelineno-18-9" name="__codelineno-18-9"></a>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a>[Model structure]
<a id="__codelineno-18-11" name="__codelineno-18-11"></a>  - Model type: ViT
<a id="__codelineno-18-12" name="__codelineno-18-12"></a>  - Model structure:
<a id="__codelineno-18-13" name="__codelineno-18-13"></a>ViT_Cifar10(
<a id="__codelineno-18-14" name="__codelineno-18-14"></a>  (upsampler): Resize(size=(224, 224), interpolation=bilinear, max_size=None, antialias=True)
<a id="__codelineno-18-15" name="__codelineno-18-15"></a>  (vit): VisionTransformer(
<a id="__codelineno-18-16" name="__codelineno-18-16"></a>    (conv_proj): Conv2d(3, 768, kernel_size=(16, 16), stride=(16, 16))
<a id="__codelineno-18-17" name="__codelineno-18-17"></a>    (encoder): Encoder(
<a id="__codelineno-18-18" name="__codelineno-18-18"></a>      (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-19" name="__codelineno-18-19"></a>      (layers): Sequential(
<a id="__codelineno-18-20" name="__codelineno-18-20"></a>        (encoder_layer_0): EncoderBlock(
<a id="__codelineno-18-21" name="__codelineno-18-21"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-22" name="__codelineno-18-22"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-23" name="__codelineno-18-23"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-24" name="__codelineno-18-24"></a>          )
<a id="__codelineno-18-25" name="__codelineno-18-25"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-26" name="__codelineno-18-26"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-27" name="__codelineno-18-27"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-28" name="__codelineno-18-28"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-29" name="__codelineno-18-29"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-30" name="__codelineno-18-30"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-31" name="__codelineno-18-31"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-32" name="__codelineno-18-32"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-33" name="__codelineno-18-33"></a>          )
<a id="__codelineno-18-34" name="__codelineno-18-34"></a>        )
<a id="__codelineno-18-35" name="__codelineno-18-35"></a>        (encoder_layer_1): EncoderBlock(
<a id="__codelineno-18-36" name="__codelineno-18-36"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-37" name="__codelineno-18-37"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-38" name="__codelineno-18-38"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-39" name="__codelineno-18-39"></a>          )
<a id="__codelineno-18-40" name="__codelineno-18-40"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-41" name="__codelineno-18-41"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-42" name="__codelineno-18-42"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-43" name="__codelineno-18-43"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-44" name="__codelineno-18-44"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-45" name="__codelineno-18-45"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-46" name="__codelineno-18-46"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-47" name="__codelineno-18-47"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-48" name="__codelineno-18-48"></a>          )
<a id="__codelineno-18-49" name="__codelineno-18-49"></a>        )
<a id="__codelineno-18-50" name="__codelineno-18-50"></a>        (encoder_layer_2): EncoderBlock(
<a id="__codelineno-18-51" name="__codelineno-18-51"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-52" name="__codelineno-18-52"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-53" name="__codelineno-18-53"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-54" name="__codelineno-18-54"></a>          )
<a id="__codelineno-18-55" name="__codelineno-18-55"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-56" name="__codelineno-18-56"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-57" name="__codelineno-18-57"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-58" name="__codelineno-18-58"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-59" name="__codelineno-18-59"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-60" name="__codelineno-18-60"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-61" name="__codelineno-18-61"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-62" name="__codelineno-18-62"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-63" name="__codelineno-18-63"></a>          )
<a id="__codelineno-18-64" name="__codelineno-18-64"></a>        )
<a id="__codelineno-18-65" name="__codelineno-18-65"></a>        (encoder_layer_3): EncoderBlock(
<a id="__codelineno-18-66" name="__codelineno-18-66"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-67" name="__codelineno-18-67"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-68" name="__codelineno-18-68"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-69" name="__codelineno-18-69"></a>          )
<a id="__codelineno-18-70" name="__codelineno-18-70"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-71" name="__codelineno-18-71"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-72" name="__codelineno-18-72"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-73" name="__codelineno-18-73"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-74" name="__codelineno-18-74"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-75" name="__codelineno-18-75"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-76" name="__codelineno-18-76"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-77" name="__codelineno-18-77"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-78" name="__codelineno-18-78"></a>          )
<a id="__codelineno-18-79" name="__codelineno-18-79"></a>        )
<a id="__codelineno-18-80" name="__codelineno-18-80"></a>        (encoder_layer_4): EncoderBlock(
<a id="__codelineno-18-81" name="__codelineno-18-81"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-82" name="__codelineno-18-82"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-83" name="__codelineno-18-83"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-84" name="__codelineno-18-84"></a>          )
<a id="__codelineno-18-85" name="__codelineno-18-85"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-86" name="__codelineno-18-86"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-87" name="__codelineno-18-87"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-88" name="__codelineno-18-88"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-89" name="__codelineno-18-89"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-90" name="__codelineno-18-90"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-91" name="__codelineno-18-91"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-92" name="__codelineno-18-92"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-93" name="__codelineno-18-93"></a>          )
<a id="__codelineno-18-94" name="__codelineno-18-94"></a>        )
<a id="__codelineno-18-95" name="__codelineno-18-95"></a>        (encoder_layer_5): EncoderBlock(
<a id="__codelineno-18-96" name="__codelineno-18-96"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-97" name="__codelineno-18-97"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-98" name="__codelineno-18-98"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-99" name="__codelineno-18-99"></a>          )
<a id="__codelineno-18-100" name="__codelineno-18-100"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-101" name="__codelineno-18-101"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-102" name="__codelineno-18-102"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-103" name="__codelineno-18-103"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-104" name="__codelineno-18-104"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-105" name="__codelineno-18-105"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-106" name="__codelineno-18-106"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-107" name="__codelineno-18-107"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-108" name="__codelineno-18-108"></a>          )
<a id="__codelineno-18-109" name="__codelineno-18-109"></a>        )
<a id="__codelineno-18-110" name="__codelineno-18-110"></a>        (encoder_layer_6): EncoderBlock(
<a id="__codelineno-18-111" name="__codelineno-18-111"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-112" name="__codelineno-18-112"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-113" name="__codelineno-18-113"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-114" name="__codelineno-18-114"></a>          )
<a id="__codelineno-18-115" name="__codelineno-18-115"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-116" name="__codelineno-18-116"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-117" name="__codelineno-18-117"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-118" name="__codelineno-18-118"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-119" name="__codelineno-18-119"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-120" name="__codelineno-18-120"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-121" name="__codelineno-18-121"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-122" name="__codelineno-18-122"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-123" name="__codelineno-18-123"></a>          )
<a id="__codelineno-18-124" name="__codelineno-18-124"></a>        )
<a id="__codelineno-18-125" name="__codelineno-18-125"></a>        (encoder_layer_7): EncoderBlock(
<a id="__codelineno-18-126" name="__codelineno-18-126"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-127" name="__codelineno-18-127"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-128" name="__codelineno-18-128"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-129" name="__codelineno-18-129"></a>          )
<a id="__codelineno-18-130" name="__codelineno-18-130"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-131" name="__codelineno-18-131"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-132" name="__codelineno-18-132"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-133" name="__codelineno-18-133"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-134" name="__codelineno-18-134"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-135" name="__codelineno-18-135"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-136" name="__codelineno-18-136"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-137" name="__codelineno-18-137"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-138" name="__codelineno-18-138"></a>          )
<a id="__codelineno-18-139" name="__codelineno-18-139"></a>        )
<a id="__codelineno-18-140" name="__codelineno-18-140"></a>        (encoder_layer_8): EncoderBlock(
<a id="__codelineno-18-141" name="__codelineno-18-141"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-142" name="__codelineno-18-142"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-143" name="__codelineno-18-143"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-144" name="__codelineno-18-144"></a>          )
<a id="__codelineno-18-145" name="__codelineno-18-145"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-146" name="__codelineno-18-146"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-147" name="__codelineno-18-147"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-148" name="__codelineno-18-148"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-149" name="__codelineno-18-149"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-150" name="__codelineno-18-150"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-151" name="__codelineno-18-151"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-152" name="__codelineno-18-152"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-153" name="__codelineno-18-153"></a>          )
<a id="__codelineno-18-154" name="__codelineno-18-154"></a>        )
<a id="__codelineno-18-155" name="__codelineno-18-155"></a>        (encoder_layer_9): EncoderBlock(
<a id="__codelineno-18-156" name="__codelineno-18-156"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-157" name="__codelineno-18-157"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-158" name="__codelineno-18-158"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-159" name="__codelineno-18-159"></a>          )
<a id="__codelineno-18-160" name="__codelineno-18-160"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-161" name="__codelineno-18-161"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-162" name="__codelineno-18-162"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-163" name="__codelineno-18-163"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-164" name="__codelineno-18-164"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-165" name="__codelineno-18-165"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-166" name="__codelineno-18-166"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-167" name="__codelineno-18-167"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-168" name="__codelineno-18-168"></a>          )
<a id="__codelineno-18-169" name="__codelineno-18-169"></a>        )
<a id="__codelineno-18-170" name="__codelineno-18-170"></a>        (encoder_layer_10): EncoderBlock(
<a id="__codelineno-18-171" name="__codelineno-18-171"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-172" name="__codelineno-18-172"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-173" name="__codelineno-18-173"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-174" name="__codelineno-18-174"></a>          )
<a id="__codelineno-18-175" name="__codelineno-18-175"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-176" name="__codelineno-18-176"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-177" name="__codelineno-18-177"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-178" name="__codelineno-18-178"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-179" name="__codelineno-18-179"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-180" name="__codelineno-18-180"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-181" name="__codelineno-18-181"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-182" name="__codelineno-18-182"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-183" name="__codelineno-18-183"></a>          )
<a id="__codelineno-18-184" name="__codelineno-18-184"></a>        )
<a id="__codelineno-18-185" name="__codelineno-18-185"></a>        (encoder_layer_11): EncoderBlock(
<a id="__codelineno-18-186" name="__codelineno-18-186"></a>          (ln_1): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-187" name="__codelineno-18-187"></a>          (self_attention): MultiheadAttention(
<a id="__codelineno-18-188" name="__codelineno-18-188"></a>            (out_proj): NonDynamicallyQuantizableLinear(in_features=768, out_features=768, bias=True)
<a id="__codelineno-18-189" name="__codelineno-18-189"></a>          )
<a id="__codelineno-18-190" name="__codelineno-18-190"></a>          (dropout): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-191" name="__codelineno-18-191"></a>          (ln_2): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-192" name="__codelineno-18-192"></a>          (mlp): MLPBlock(
<a id="__codelineno-18-193" name="__codelineno-18-193"></a>            (0): Linear(in_features=768, out_features=3072, bias=True)
<a id="__codelineno-18-194" name="__codelineno-18-194"></a>            (1): GELU(approximate='none')
<a id="__codelineno-18-195" name="__codelineno-18-195"></a>            (2): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-196" name="__codelineno-18-196"></a>            (3): Linear(in_features=3072, out_features=768, bias=True)
<a id="__codelineno-18-197" name="__codelineno-18-197"></a>            (4): Dropout(p=0.0, inplace=False)
<a id="__codelineno-18-198" name="__codelineno-18-198"></a>          )
<a id="__codelineno-18-199" name="__codelineno-18-199"></a>        )
<a id="__codelineno-18-200" name="__codelineno-18-200"></a>      )
<a id="__codelineno-18-201" name="__codelineno-18-201"></a>      (ln): LayerNorm((768,), eps=1e-06, elementwise_affine=True)
<a id="__codelineno-18-202" name="__codelineno-18-202"></a>    )
<a id="__codelineno-18-203" name="__codelineno-18-203"></a>    (heads): Sequential(
<a id="__codelineno-18-204" name="__codelineno-18-204"></a>      (head): Linear(in_features=768, out_features=10, bias=True)
<a id="__codelineno-18-205" name="__codelineno-18-205"></a>    )
<a id="__codelineno-18-206" name="__codelineno-18-206"></a>  )
<a id="__codelineno-18-207" name="__codelineno-18-207"></a>)
<a id="__codelineno-18-208" name="__codelineno-18-208"></a>  - Total params: 7,690
<a id="__codelineno-18-209" name="__codelineno-18-209"></a>
<a id="__codelineno-18-210" name="__codelineno-18-210"></a>[Training infomation]
<a id="__codelineno-18-211" name="__codelineno-18-211"></a>  - Training duration on full training set: 265m 15s
<a id="__codelineno-18-212" name="__codelineno-18-212"></a>  - Training device: cuda on Kaggle's free P100, Thank you Google!
<a id="__codelineno-18-213" name="__codelineno-18-213"></a>
<a id="__codelineno-18-214" name="__codelineno-18-214"></a>[Benchmarks on test set]
<a id="__codelineno-18-215" name="__codelineno-18-215"></a>  - Test loss: 0.1402
<a id="__codelineno-18-216" name="__codelineno-18-216"></a>  - Test accuracy: 95.42%
<a id="__codelineno-18-217" name="__codelineno-18-217"></a>
<a id="__codelineno-18-218" name="__codelineno-18-218"></a>==================================================
</code></pre></div></td></tr></table></div>
</details>
<h3 id="vit_2">对 ViT 模型的解读和评述<a class="headerlink" href="#vit_2" title="Permanent link">¶</a></h3>
<p>本次实验仍然是从零训练+微调。从零训练使用展示的一个 nanoViT，微调使用的是 torchvision 提供的预训练权重 <code>ViT_B_16_Weights.IMAGENET1K_V1</code>，通过冻结骨干网络替换分类头的方式进行微调。</p>
<p>叫 nanoViT 是为了向 Karpathy 的 nanoGPT 致敬，其他网络都在卷花活的时候，Transformer 真的是大力出奇迹。</p>
<p>下面是 nanoViT 的结构示意，我们从宏观到微观来拆解。</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef result fill:#45475a,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4;
    classDef conv fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;
    classDef transformer fill:#313244,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;

    %% Input Layer
    subgraph Input["Input"]
        A[("3@32×32")]
    end
    class Input input;

    %% Patch Embedding
    subgraph PatchEmbed["Patch Embedding"]
        B["Conv2d&lt;br&gt; 3x192 x 2×2 / 2"]
        C["Dropout&lt;br&gt; p=0.1"]
        U["CLS token&lt;br&gt;192 dim vector"]
        V[("contact")]
    end
    U --&gt; V
    A --&gt; B --&gt; V
    V --&gt; C
    class PatchEmbed conv;

    %% Positional Encoding
    subgraph PosEnc["Postional Encoding"]
        S["Parameter Matrix&lt;br&gt;(256+1) x 192&lt;br&gt;1 for CLS token"]
    end
    class PosEnc conv;

    T["Dropout&lt;br&gt;p=0.1"]
    D[("+")]
    S --&gt; D --&gt; T
    C --&gt;|257 tokens or patches&lt;br&gt;embedded into 192 dim per patch| D
    %% Transformer Encoder
    subgraph TransformerEncoder["Transformer Encoder"]
        E["Encoder Layer 1"]
        F["Encoder Layer 2"]
        G["Encoder Layer 3"]
        H["Encoder Layer 4"]
    end
    T --&gt;|257x192| E --&gt; F --&gt; G --&gt; H
    class TransformerEncoder transformer;

    %% Extract [CLS] Token
    I["Extract CLS token"]
    H --&gt;|257x192| I

    %% Classification Head
    subgraph Classifier["MLP Head"]
        J["LayerNorm&lt;br&gt;192 dim"]
        K["Linear&lt;br&gt;192x10"]
    end
    I --&gt;|192 dim vector| J --&gt; K
    class Classifier box;

    %% Output Layer
    subgraph Output["Output"]
        L[("10")]
    end
    K --&gt; L
    class Output output;

    %% Styling
    style A stroke-dasharray: 5 5
    style L stroke:#a6e3a1,stroke-width:3px</code></pre>
<p>这里利用卷积操作，将 3@32x32 的图像变成 192@16x16 的图像补丁，并将后两个维度展平，就得到 192x256 的矩阵，其中 256 是补丁的个数，192 是通道数（提取的特征数量），也就是每个补丁可以映射到 192 维的嵌入空间里面。选 192 是为了控制参数量在 1M 的数量级，其实应该更大的，具体可见下面的讨论。因此我们将矩阵转置为 256x192，也就是输入序列长度乘以嵌入维数，这就和 TrasformerEncoder 的要求匹配了。选择 2x2 的补丁一方面有受到 ViT 论文标题 An image is worth 16x16 words 的影响，毕竟 32 / 2 = 16，另一方面就是类比卷积神经网络的 3x3 卷积核，所以考虑在 2x2 和 4x4 中间选，因为先前测试过 4x4 的 patch_size 效果不如 2x2 好，于是就定下来是 2x2 了。</p>
<p>我们知道注意力矩阵不包含位置信息，所以需要位置编码来对不同位置的同一个 token 进行区分。ViT 的作者尝试了 1-D, 2-D 固定位置编码以及可学习的位置编码，效果都差不多，因此在这里使用可学习的位置编码。</p>
<p>但是由于我们需要对图像进行有监督分类，单纯对图像进行注意力操作是不会利用到任何标签信息的，所以还需要增加一个单独的 token，这个 token 用来捕获分类的结果。由于 TrasformerEncoder 不会改变输入的形状和位置关系，所以只需要在最后提取这个分类 token，并将其投影到 10 个类别上面即可实现端到端的学习。</p>
<p>下面是每一个 TrasformerEncoder 层的细节实现。值得注意的是两个残差连接，分别跨越了多头注意力模块和前馈神经网络模块。残差连接的作用之前已经详细阐述，此处不必多说。</p>
<p>这里的前馈神经网络实现和一般的 MLP head 不大一样。之前我们看到的 MLP head 都是漏斗型的，这里的 FFN 却是先升维再降维。因为此处 FFN 只是对拼接的多头注意力进行混合，不是压缩而是混合特征，因此需要在高维度区分特征，另一方面是，加入激活函数的 FFN 在升维的时候基本上不会因为 ReLU 或者 GELU 等其他激活函数的死连接而导致信息的损失（也就是降秩）。</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef attention fill:#313244,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;
    classDef ffn fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;

    %% Input
    Input[("T×192")] --&gt; Norm1["LayerNorm&lt;br&gt;192 dim"]

    %% Multi-head Attention (8 heads)
    subgraph SelfAttn["Multi-Head Attention"]
        subgraph SA["Multi-Head Self Attention"]
            Z1["Attention Head 0&lt;br&gt;Tx192-&gt;Tx24"]
            Z2["......"]
            Z3["Attention Head 7&lt;br&gt;Tx192-&gt;Tx24"]
        end
        Conc["Contact"]
        Proj["Linear&lt;br&gt; 192x192"]
    end
    Norm1 --&gt; Z1
    Norm1 --&gt; Z2
    Norm1 --&gt; Z3
    Z1 --&gt; Conc
    Z2 --&gt; Conc
    Z3 --&gt; Conc
    Conc --&gt;|Tx192| Proj
    class SelfAttn attention;

    %% Residual Connection 1
    Proj --&gt; Dropout1["Dropout: p=0.1"]
    Dropout1 --&gt; Add1(("+"))
    Input --&gt; Add1

    %% Feed Forward Network
    Add1 --&gt; Norm2["LayerNorm&lt;br&gt;192 dims"]

    subgraph FFN["Feed Forward Network"]
        Linear1["Linear&lt;br&gt; 192x384"]
        Dropout2["Dropout&lt;br&gt; p=0.1"]
        Linear2["Linear&lt;br&gt; 384x192"]
    end
    Norm2 --&gt; Linear1 --&gt; Dropout2 --&gt; Linear2
    class FFN ffn;

    %% Residual Connection 2
    Linear2 --&gt; Dropout3["Dropout&lt;br&gt;p=0.1"]
    Dropout3 --&gt; Add2(("+"))
    Add1 --&gt; Add2

    %% Output
    Add2 --&gt; Output[("T×192")]</code></pre>
<p>下面是多头自注意力每一个头的计算过程。其实我认为这里的头数类似于 conv2d 的通道数，衡量获取特征的多少；但是另一方面又被嵌入维度所限制，因为头数一多，分给每个头的投影维度就少了，信息也变少了。图上面的头数为 8 是我随意设置的，不过苏剑林有一个维度公式 <a href="https://kexue.fm/archives/8711">n &gt; 8.33 log N</a> 对于注意力机制而言，N 就是预训练的序列长度 T 也就是 256，n 就是每个注意力头的维度，算出来要大于 <span class="arithmatex">\(8.33 \times \log_2 256\approx 66.64\)</span> 才能够在每个头里面有效定位 token，所以这里的 num_heads 设置成 3 理论上看似会好一点。实际上回到之前的讨论，虽然维度够了，但是提取的特征不够，所以还是差一点，训练出来 loss = 0.9111 而 acc 很遗憾地只有 69.17%。所以回过头来，如果我们综合刚刚的讨论把 num_heads 设置到 8 而每个头的维度设置成 64……诶，这不就接近 ViT-B-16 使用的嵌入维度 768 嘛！</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef transform fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;
    classDef attention fill:#313244,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;

    %% Input
    subgraph Input["Input sequence"]
        A[("T×embed_dim&lt;br&gt;T = 257&lt;br&gt;embed_dim = 192")]
    end
    class Input input;

    %% Linear Transformations
    subgraph Transformations["Linear proj for head_i"]
        B["Projection matrix W_q_i&lt;br&gt; embed_dim×d_q = 192 x 24"]
        C["Projection matrix W_k_i&lt;br&gt; embed_dim×d_k = 192 x 24"]
        D["Projection matrix W_v_i&lt;br&gt; embed_dim×d_v = 192 x 24"]
    end
    A --&gt; B
    A --&gt; C
    A --&gt; D
    class Transformations transform;

    %% Transformed Representations
    E["Q_i = XW_q_i&lt;br&gt;T×d_q"]
    F["K_i = XW_k_i&lt;br&gt;T×d_k"]
    G["V_i = XW_v_i&lt;br&gt;T×d_v"]

    B --&gt; E
    C --&gt; F
    D --&gt; G

    %% Attention Score Calculation
    subgraph ScoreCalc["Attention Score"]
        H["Q_i K_iᵀ &lt;br&gt;-------&lt;br&gt; √(d_k)"]
        I["Softmax&lt;br&gt;Row-wise Norm"]
    end
    E --&gt; H
    F --&gt; H
    H --&gt;|T x T| I

    %% Output Calculation
    subgraph OutputCalc["Attention Result"]
        J["Attention_i = O_i V_i"]
    end
    I --&gt;|Attention Score O_i&lt;br&gt;T x T| J
    G --&gt; J

    %% Output
    subgraph Output["Output for head_i"]
        K[("T×d_v")]
    end
    J --&gt; K
    class Output output;

    %% Styling
    style A stroke-dasharray: 5 5</code></pre>
<p>注意力这个词其实很形象，它通过计算得知“图像的哪一部分是重要的”。具体而言，由于我们需要的是自己添加的分类 token，所以让我们可视化一下这个 token 相对整张图片的注意力，也就能够得知“模型靠什么辨认出该标签”：</p>
<p><img alt="ViT_visualization" src="../Image-models-replication-assets/ViT_visualization.jpg.png"/></p>
<p>可以看到底层的注意力提取的信息偏向于明度信息，对较暗的如草坪阴影和狗头等具有较多关注度，后面的层关注点逐渐抽象，开始聚焦身体、四肢和尾巴等的特征。为何模型不再关注背景的草坪呢？考虑同时有两张图片，一张是猫在草坪上另一张是狗在草坪上，如果模型未能分割出草坪，则其就会将两者混为一谈，损失变大，若想降低损失，模型必须要捕获到两者的差别，即猫和狗身形或四肢等的差异，才能正确提取抽象特征进行分类。</p>
<p>总的 TransformerEncoder 计算时间复杂度为 <span class="arithmatex">\(O(T^2d+kd^2)\)</span>。其中 <span class="arithmatex">\(T\)</span> 是序列长度，<span class="arithmatex">\(d\)</span> 是嵌入维度而 <span class="arithmatex">\(k\)</span> 是注意力前的投影，注意力后的 FFN 等多个线性操作带来的倍率因子。在这个场景下序列长度不长，计算时间复杂度可以接受，高分辨率图片或者 LLM 里面的长上下文就难搞咯。</p>
<p>最后训练出来的 nanoViT 在 CIFAR-10 上获得了 73.24% 的准确率，和朴素 CNN 的准确率在一个水平。因为 Transformer 要大量数据投喂，所以不 Scale 怎么能行呢？</p>
<p>于是我选择一个大一点的，在 ImageNet 上已经预训练过的模型进行微调，也就是 <code>ViT_B_16_Weights.IMAGENET1K_V1</code> 这个模型权重，<a href="https://docs.pytorch.ac.cn/vision/stable/models.html#table-of-all-available-classification-weights">文档在此</a>。这个神经网络基本上和刚刚的 nanoViT 完全一样，只不过扩大了对应的参数量，将编码器增加到了 12 个，而 FFN 层间激活函数使用了 GELU 而已。</p>
<p>微调的方法就是先把 32x32 的图像上采样到 224x224，就能和为 ImageNet 预训练的输入匹配了，然后冻结骨干网络，只需要替换分类头，训练好这个 MLP 分类分类头即可。由于这个模型的嵌入维度是 768，所以我们只需要对一个 7690 个参数进行微调就行了，按理说很快，不过……</p>
<p>由于笔者采用的是一个即插即用的端到端网络训练和评估框架，所以我想，定义模型的时候，<code>__init__</code>里面声明一下冻结骨干网，替换一下分类头，然后在<code>forward</code>里面上采样一下就行了。结果就是，对这 7690 个参数的微调，算上 5 次在训练子集上调参和一次全量数据的微调，一共花（浪费了）10 小时。所以大家不要直接复制上面的那个微调原理代码，会很浪费时间（和电，如果你使用云端收费 GPU 的话还很浪费钱）。</p>
<p>这是怎么回事呢？消耗时间的大头竟是<strong>前向传播</strong>也就是推理！实际上因为每一个 epoch 都需要对全部训练样本都完整走一遍前向过程，所以在找超参数的时候我重复进行了 <span class="arithmatex">\(\dfrac{1}{5}(52+34+31+91+65)=54.6\)</span> 次全量数据的前向传播，但实际上我们已经冻结了骨干网络，所以只需要走一次全量数据前向传播，得到它们最后输出的 784 维编码向量即可！也就是说整个训练流程其实只需要十来分钟就可以完成的……</p>
<p>无论如何微调结果是相当棒的，准确率达到了 95% 以上，可以 <del>在 osu! 里面拿到 S 评级了</del> 和那些 SOTA 模型坐一桌了。</p>
<p>将图像利用 Patch 来转换成嵌入序列的方式很有意思！既然 Transformer 的注意力计算是 <span class="arithmatex">\(O(T^2d)\)</span> 的，为何不请出序列数据处理（和线性注意力）的元祖，宝刀未老的 RNN 系列模型呢？（好吧 RNN 因为严重的梯度爆炸/消失问题尚能饭否还得打个问号，我们实际上使用 LSTM）</p>
<h2 id="patch-based-lstm">Patch based LSTM<a class="headerlink" href="#patch-based-lstm" title="Permanent link">¶</a></h2>
<h3 id="patch-based-lstm_1">Patch based LSTM 训练结果展示<a class="headerlink" href="#patch-based-lstm_1" title="Permanent link">¶</a></h3>
<details>
<summary> 训练使用的代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">  1</a></span>
<span class="normal"><a href="#__codelineno-19-2">  2</a></span>
<span class="normal"><a href="#__codelineno-19-3">  3</a></span>
<span class="normal"><a href="#__codelineno-19-4">  4</a></span>
<span class="normal"><a href="#__codelineno-19-5">  5</a></span>
<span class="normal"><a href="#__codelineno-19-6">  6</a></span>
<span class="normal"><a href="#__codelineno-19-7">  7</a></span>
<span class="normal"><a href="#__codelineno-19-8">  8</a></span>
<span class="normal"><a href="#__codelineno-19-9">  9</a></span>
<span class="normal"><a href="#__codelineno-19-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-19-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-19-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-19-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-19-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-19-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-19-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-19-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-19-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-19-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-19-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-19-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-19-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-19-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-19-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-19-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-19-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-19-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-19-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-19-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-19-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-19-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-19-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-19-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-19-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-19-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-19-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-19-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-19-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-19-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-19-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-19-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-19-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-19-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-19-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-19-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-19-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-19-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-19-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-19-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-19-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-19-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-19-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-19-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-19-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-19-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-19-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-19-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-19-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-19-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-19-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-19-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-19-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-19-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-19-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-19-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-19-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-19-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-19-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-19-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-19-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-19-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-19-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-19-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-19-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-19-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-19-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-19-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-19-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-19-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-19-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-19-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-19-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-19-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-19-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-19-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-19-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-19-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-19-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-19-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-19-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-19-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-19-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-19-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-19-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-19-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-19-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-19-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-19-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-19-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-19-100">100</a></span>
<span class="normal"><a href="#__codelineno-19-101">101</a></span>
<span class="normal"><a href="#__codelineno-19-102">102</a></span>
<span class="normal"><a href="#__codelineno-19-103">103</a></span>
<span class="normal"><a href="#__codelineno-19-104">104</a></span>
<span class="normal"><a href="#__codelineno-19-105">105</a></span>
<span class="normal"><a href="#__codelineno-19-106">106</a></span>
<span class="normal"><a href="#__codelineno-19-107">107</a></span>
<span class="normal"><a href="#__codelineno-19-108">108</a></span>
<span class="normal"><a href="#__codelineno-19-109">109</a></span>
<span class="normal"><a href="#__codelineno-19-110">110</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">PatchEmbedding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">    </span><span class="sd">"""将图像分割为补丁并进行嵌入"""</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="n">img_size</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patch_size</span> <span class="o">=</span> <span class="n">patch_size</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a>        <span class="c1"># 计算补丁数量</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_patches</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_size</span> <span class="o">//</span> <span class="n">patch_size</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a>        <span class="c1"># 使用卷积层实现补丁嵌入 (等价于每个补丁应用一个卷积核)</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a>            <span class="n">in_channels</span><span class="p">,</span> 
<a id="__codelineno-19-19" name="__codelineno-19-19"></a>            <span class="n">embed_dim</span><span class="p">,</span> 
<a id="__codelineno-19-20" name="__codelineno-19-20"></a>            <span class="n">kernel_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span> 
<a id="__codelineno-19-21" name="__codelineno-19-21"></a>            <span class="n">stride</span><span class="o">=</span><span class="n">patch_size</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a>        <span class="p">)</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a>        <span class="c1"># x形状: (batch_size, in_channels, img_size, img_size)</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># 输出形状: (batch_size, embed_dim, num_patches^(1/2), num_patches^(1/2))</span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 输出形状: (batch_size, embed_dim, num_patches)</span>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 输出形状: (batch_size, num_patches, embed_dim)</span>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">PatchLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-19-32" name="__codelineno-19-32"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
<a id="__codelineno-19-33" name="__codelineno-19-33"></a>                 <span class="n">embed_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
<a id="__codelineno-19-34" name="__codelineno-19-34"></a>                 <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<a id="__codelineno-19-35" name="__codelineno-19-35"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">PatchLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-19-36" name="__codelineno-19-36"></a>
<a id="__codelineno-19-37" name="__codelineno-19-37"></a>        <span class="c1"># 使用卷积Patch嵌入层</span>
<a id="__codelineno-19-38" name="__codelineno-19-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span> <span class="o">=</span> <span class="n">PatchEmbedding</span><span class="p">(</span>
<a id="__codelineno-19-39" name="__codelineno-19-39"></a>            <span class="n">img_size</span><span class="o">=</span><span class="n">img_size</span><span class="p">,</span>
<a id="__codelineno-19-40" name="__codelineno-19-40"></a>            <span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span>
<a id="__codelineno-19-41" name="__codelineno-19-41"></a>            <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-19-42" name="__codelineno-19-42"></a>            <span class="n">embed_dim</span><span class="o">=</span><span class="n">embed_dim</span>
<a id="__codelineno-19-43" name="__codelineno-19-43"></a>        <span class="p">)</span>
<a id="__codelineno-19-44" name="__codelineno-19-44"></a>
<a id="__codelineno-19-45" name="__codelineno-19-45"></a>        <span class="c1"># 计算patch数量</span>
<a id="__codelineno-19-46" name="__codelineno-19-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_patches</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_size</span> <span class="o">//</span> <span class="n">patch_size</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-19-47" name="__codelineno-19-47"></a>
<a id="__codelineno-19-48" name="__codelineno-19-48"></a>        <span class="c1"># 可学习的位置编码</span>
<a id="__codelineno-19-49" name="__codelineno-19-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_patches</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">))</span>
<a id="__codelineno-19-50" name="__codelineno-19-50"></a>
<a id="__codelineno-19-51" name="__codelineno-19-51"></a>        <span class="c1"># Dropout层</span>
<a id="__codelineno-19-52" name="__codelineno-19-52"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-19-53" name="__codelineno-19-53"></a>
<a id="__codelineno-19-54" name="__codelineno-19-54"></a>        <span class="c1"># RNN主干网络 (使用LSTM)</span>
<a id="__codelineno-19-55" name="__codelineno-19-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
<a id="__codelineno-19-56" name="__codelineno-19-56"></a>            <span class="n">input_size</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">,</span>
<a id="__codelineno-19-57" name="__codelineno-19-57"></a>            <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
<a id="__codelineno-19-58" name="__codelineno-19-58"></a>            <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span>
<a id="__codelineno-19-59" name="__codelineno-19-59"></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-19-60" name="__codelineno-19-60"></a>            <span class="n">bidirectional</span><span class="o">=</span><span class="n">bidirectional</span><span class="p">,</span>
<a id="__codelineno-19-61" name="__codelineno-19-61"></a>            <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span> <span class="k">if</span> <span class="n">num_layers</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-19-62" name="__codelineno-19-62"></a>        <span class="p">)</span>
<a id="__codelineno-19-63" name="__codelineno-19-63"></a>
<a id="__codelineno-19-64" name="__codelineno-19-64"></a>        <span class="c1"># 分类头</span>
<a id="__codelineno-19-65" name="__codelineno-19-65"></a>        <span class="n">rnn_output_size</span> <span class="o">=</span> <span class="n">hidden_size</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">bidirectional</span> <span class="k">else</span> <span class="n">hidden_size</span>
<a id="__codelineno-19-66" name="__codelineno-19-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-19-67" name="__codelineno-19-67"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">rnn_output_size</span><span class="p">),</span>
<a id="__codelineno-19-68" name="__codelineno-19-68"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">rnn_output_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">),</span>
<a id="__codelineno-19-69" name="__codelineno-19-69"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">GELU</span><span class="p">(),</span>
<a id="__codelineno-19-70" name="__codelineno-19-70"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">),</span>
<a id="__codelineno-19-71" name="__codelineno-19-71"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<a id="__codelineno-19-72" name="__codelineno-19-72"></a>        <span class="p">)</span>
<a id="__codelineno-19-73" name="__codelineno-19-73"></a>
<a id="__codelineno-19-74" name="__codelineno-19-74"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-19-75" name="__codelineno-19-75"></a>        <span class="c1"># x形状: [B, 3, 32, 32]</span>
<a id="__codelineno-19-76" name="__codelineno-19-76"></a>
<a id="__codelineno-19-77" name="__codelineno-19-77"></a>        <span class="c1"># 1. 使用卷积层进行patch嵌入</span>
<a id="__codelineno-19-78" name="__codelineno-19-78"></a>        <span class="n">patch_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_embed</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># [B, num_patches, embed_dim]</span>
<a id="__codelineno-19-79" name="__codelineno-19-79"></a>
<a id="__codelineno-19-80" name="__codelineno-19-80"></a>        <span class="c1"># 2. 添加位置编码</span>
<a id="__codelineno-19-81" name="__codelineno-19-81"></a>        <span class="n">patch_embeddings</span> <span class="o">=</span> <span class="n">patch_embeddings</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span>
<a id="__codelineno-19-82" name="__codelineno-19-82"></a>
<a id="__codelineno-19-83" name="__codelineno-19-83"></a>        <span class="c1"># 3. 应用dropout</span>
<a id="__codelineno-19-84" name="__codelineno-19-84"></a>        <span class="n">patch_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">patch_embeddings</span><span class="p">)</span>
<a id="__codelineno-19-85" name="__codelineno-19-85"></a>
<a id="__codelineno-19-86" name="__codelineno-19-86"></a>        <span class="c1"># 4. 通过RNN处理序列</span>
<a id="__codelineno-19-87" name="__codelineno-19-87"></a>        <span class="n">rnn_output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">patch_embeddings</span><span class="p">)</span>  <span class="c1"># [B, num_patches, hidden_size * num_directions]</span>
<a id="__codelineno-19-88" name="__codelineno-19-88"></a>
<a id="__codelineno-19-89" name="__codelineno-19-89"></a>        <span class="c1"># 5. 取序列的最后一个输出（考虑了双向信息）</span>
<a id="__codelineno-19-90" name="__codelineno-19-90"></a>        <span class="n">sequence_representation</span> <span class="o">=</span> <span class="n">rnn_output</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># [B, hidden_size * num_directions]</span>
<a id="__codelineno-19-91" name="__codelineno-19-91"></a>
<a id="__codelineno-19-92" name="__codelineno-19-92"></a>        <span class="c1"># 6. 分类</span>
<a id="__codelineno-19-93" name="__codelineno-19-93"></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">sequence_representation</span><span class="p">)</span>
<a id="__codelineno-19-94" name="__codelineno-19-94"></a>        <span class="k">return</span> <span class="n">logits</span>
<a id="__codelineno-19-95" name="__codelineno-19-95"></a>
<a id="__codelineno-19-96" name="__codelineno-19-96"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_model_on_device</span><span class="p">():</span>
<a id="__codelineno-19-97" name="__codelineno-19-97"></a>    <span class="c1"># 创建模型实例</span>
<a id="__codelineno-19-98" name="__codelineno-19-98"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">PatchLSTM</span><span class="p">(</span>
<a id="__codelineno-19-99" name="__codelineno-19-99"></a>        <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>        <span class="c1"># CIFAR-10有10个类别</span>
<a id="__codelineno-19-100" name="__codelineno-19-100"></a>        <span class="n">img_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>           <span class="c1"># CIFAR-10图像尺寸</span>
<a id="__codelineno-19-101" name="__codelineno-19-101"></a>        <span class="n">patch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>          <span class="c1"># 2x2的patch</span>
<a id="__codelineno-19-102" name="__codelineno-19-102"></a>        <span class="n">embed_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>         <span class="c1"># 嵌入维度</span>
<a id="__codelineno-19-103" name="__codelineno-19-103"></a>        <span class="n">hidden_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>       <span class="c1"># RNN隐藏状态维度</span>
<a id="__codelineno-19-104" name="__codelineno-19-104"></a>        <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>          <span class="c1"># RNN层数</span>
<a id="__codelineno-19-105" name="__codelineno-19-105"></a>        <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>    <span class="c1"># 使用双向RNN</span>
<a id="__codelineno-19-106" name="__codelineno-19-106"></a>        <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span>            <span class="c1"># Dropout率</span>
<a id="__codelineno-19-107" name="__codelineno-19-107"></a>    <span class="p">)</span>
<a id="__codelineno-19-108" name="__codelineno-19-108"></a>
<a id="__codelineno-19-109" name="__codelineno-19-109"></a>    <span class="c1"># 将模型移动到指定设备</span>
<a id="__codelineno-19-110" name="__codelineno-19-110"></a>    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<details>
<summary> Patch based LSTM 的训练结果 </summary>

![plstm_result](./image.png)

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span>
<span class="normal"><a href="#__codelineno-20-21">21</a></span>
<span class="normal"><a href="#__codelineno-20-22">22</a></span>
<span class="normal"><a href="#__codelineno-20-23">23</a></span>
<span class="normal"><a href="#__codelineno-20-24">24</a></span>
<span class="normal"><a href="#__codelineno-20-25">25</a></span>
<span class="normal"><a href="#__codelineno-20-26">26</a></span>
<span class="normal"><a href="#__codelineno-20-27">27</a></span>
<span class="normal"><a href="#__codelineno-20-28">28</a></span>
<span class="normal"><a href="#__codelineno-20-29">29</a></span>
<span class="normal"><a href="#__codelineno-20-30">30</a></span>
<span class="normal"><a href="#__codelineno-20-31">31</a></span>
<span class="normal"><a href="#__codelineno-20-32">32</a></span>
<span class="normal"><a href="#__codelineno-20-33">33</a></span>
<span class="normal"><a href="#__codelineno-20-34">34</a></span>
<span class="normal"><a href="#__codelineno-20-35">35</a></span>
<span class="normal"><a href="#__codelineno-20-36">36</a></span>
<span class="normal"><a href="#__codelineno-20-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a>==================================================
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>               Results
<a id="__codelineno-20-3" name="__codelineno-20-3"></a>==================================================
<a id="__codelineno-20-4" name="__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a>[Hyper parameters]
<a id="__codelineno-20-6" name="__codelineno-20-6"></a>  - Best LR: 0.000425
<a id="__codelineno-20-7" name="__codelineno-20-7"></a>  - Best epochs: 20 epochs
<a id="__codelineno-20-8" name="__codelineno-20-8"></a>  - Batch size: 128
<a id="__codelineno-20-9" name="__codelineno-20-9"></a>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a>[Model structure]
<a id="__codelineno-20-11" name="__codelineno-20-11"></a>  - Model type: Patch based LSTM
<a id="__codelineno-20-12" name="__codelineno-20-12"></a>  - Model structure:
<a id="__codelineno-20-13" name="__codelineno-20-13"></a>PatchRNN(
<a id="__codelineno-20-14" name="__codelineno-20-14"></a>  (patch_embed): PatchEmbedding(
<a id="__codelineno-20-15" name="__codelineno-20-15"></a>    (proj): Conv2d(3, 128, kernel_size=(2, 2), stride=(2, 2))
<a id="__codelineno-20-16" name="__codelineno-20-16"></a>  )
<a id="__codelineno-20-17" name="__codelineno-20-17"></a>  (dropout): Dropout(p=0.1, inplace=False)
<a id="__codelineno-20-18" name="__codelineno-20-18"></a>  (rnn): LSTM(128, 256, num_layers=2, batch_first=True, dropout=0.1, bidirectional=True)
<a id="__codelineno-20-19" name="__codelineno-20-19"></a>  (classifier): Sequential(
<a id="__codelineno-20-20" name="__codelineno-20-20"></a>    (0): LayerNorm((512,), eps=1e-05, elementwise_affine=True)
<a id="__codelineno-20-21" name="__codelineno-20-21"></a>    (1): Linear(in_features=512, out_features=256, bias=True)
<a id="__codelineno-20-22" name="__codelineno-20-22"></a>    (2): GELU(approximate='none')
<a id="__codelineno-20-23" name="__codelineno-20-23"></a>    (3): Dropout(p=0.1, inplace=False)
<a id="__codelineno-20-24" name="__codelineno-20-24"></a>    (4): Linear(in_features=256, out_features=10, bias=True)
<a id="__codelineno-20-25" name="__codelineno-20-25"></a>  )
<a id="__codelineno-20-26" name="__codelineno-20-26"></a>)
<a id="__codelineno-20-27" name="__codelineno-20-27"></a>  - Total params: 2,536,842
<a id="__codelineno-20-28" name="__codelineno-20-28"></a>
<a id="__codelineno-20-29" name="__codelineno-20-29"></a>[Training infomation]
<a id="__codelineno-20-30" name="__codelineno-20-30"></a>  - Training duration on full training set: 20m 27s
<a id="__codelineno-20-31" name="__codelineno-20-31"></a>  - Training device: cuda on Kaggle's free P100, Thank you Google!
<a id="__codelineno-20-32" name="__codelineno-20-32"></a>
<a id="__codelineno-20-33" name="__codelineno-20-33"></a>[Benchmarks on test set]
<a id="__codelineno-20-34" name="__codelineno-20-34"></a>  - Test loss: 1.1816
<a id="__codelineno-20-35" name="__codelineno-20-35"></a>  - Test accuracy: 68.11%
<a id="__codelineno-20-36" name="__codelineno-20-36"></a>
<a id="__codelineno-20-37" name="__codelineno-20-37"></a>==================================================
</code></pre></div></td></tr></table></div>
</details>
<h3 id="patch-based-lstm_2">对 Patch based LSTM 的解读和评述<a class="headerlink" href="#patch-based-lstm_2" title="Permanent link">¶</a></h3>
<p>下面是总的模型结构图，使用了双层的双向 LSTM 作为编码器。其实双向仍然在提取位置关系上还是不够充分的，因为尽管图像 Patch 化了，其关联仍然不是纯线性序列的，所以还是加上了可学习的位置编码。这里的结构其实就是类似于把 nanoViT 的四个 TransformerEncoder 换成了基于 LSTM 的 RNN Encoder。至于为什么输入序列维度 128 过了这个编码器之后就变成 512 了呢？且看后面对这个编码器的拆解。</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef conv fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;
    classDef rnn fill:#313244,stroke:#f9e2af,stroke-width:2px,color:#cdd6f4;

    %% Input Layer
    subgraph Input["Input"]
        A[("3@32×32")]
    end
    class Input input;

    %% Patch Embedding
    subgraph PatchEmbed["Patch Embedding"]
        B["Conv2d&lt;br&gt; 3x128 x 2×2 / 2"]
    end
    A --&gt;|Image| B
    class PatchEmbed conv;

    %% Positional Encoding
    subgraph PosEnc["Positional Encoding"]
        S["Parameter Matrix&lt;br&gt;256 x 128"]
    end
    class PosEnc conv;

    D[("+")]
    S --&gt; D
    B --&gt;|256 patches&lt;br&gt;128 dim per patch| D

    %% Dropout
    T["Dropout&lt;br&gt;p=0.1"]
    D --&gt; T

    %% RNN Encoder
    subgraph RnnEncoder["RNN Encoder"]
        E["2-Layer Bi-LSTM&lt;br&gt;hidden=256"]
    end
    T --&gt;|256x128| E
    class RnnEncoder rnn;

    %% Extract Last Output
    I["Extract Last&lt;br&gt;Time Step's Output"]
    E --&gt;|Sequence Output&lt;br&gt;256x512| I

    %% Classification Head
    subgraph Classifier["MLP Head"]
        J["LayerNorm&lt;br&gt;512 dim"]
        K["Linear&lt;br&gt;512x256"]
        L["GELU"]
        M["Dropout&lt;br&gt;p=0.1"]
        N["Linear&lt;br&gt;256x10"]
    end
    I --&gt;|Vector&lt;br&gt;512 dim| J --&gt; K --&gt; L --&gt; M --&gt; N
    class Classifier box;

    %% Output Layer
    subgraph OutputLayer["Output"]
        O[("10")]
    end
    N --&gt; O
    class OutputLayer output;

    %% Styling
    style A stroke-dasharray: 5 5
    style O stroke:#a6e3a1,stroke-width:3px</code></pre>
<p>下面是具体的编码器架构。输入序列是一个长度 256，嵌入维度 128 的序列，分别输入到正向和反向的 LSTM 里面，取输出也就是隐藏层状态 <span class="arithmatex">\(h\)</span>，在嵌入维度上拼到一起，得到新的序列，也就是隐藏层的维度 256，然后再过一遍正反向 LSTM，维度再翻一倍，得到输出的维度 512。所以双向 LSTM 输出维度是隐藏状态维度的两倍。</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef rnn fill:#313244,stroke:#f9e2af,stroke-width:2px,color:#cdd6f4;

    %% Input
    Input[("Input Sequence&lt;br&gt;256 × 128")]
    class Input input

    %% Layer 1
    subgraph LSTM_Layer_1 ["LSTM Layer 1"]
        direction LR
        Fwd1["Forward LSTM&lt;br&gt;h=256"]
        Bwd1["Backward LSTM&lt;br&gt;h=256"]
    end

    Concat1["Concatenate&lt;br&gt;Outputs"]

    Input --&gt; Fwd1
    Input --&gt; Bwd1
    Fwd1 --&gt; |256x256| Concat1
    Bwd1 --&gt; |256x256| Concat1

    %% Dropout between layers
    Drop["Dropout&lt;br&gt;p=0.1"]
    Concat1 --&gt; |256x512| Drop

    %% Layer 2
    subgraph LSTM_Layer_2 ["LSTM Layer 2"]
        direction LR
        Fwd2["Forward LSTM&lt;br&gt;h=256"]
        Bwd2["Backward LSTM&lt;br&gt;h=256"]
    end

    Concat2["Concatenate&lt;br&gt;Outputs"]

    Drop --&gt; Fwd2
    Drop --&gt; Bwd2
    Fwd2 --&gt; |256x256| Concat2
    Bwd2 --&gt; |256x256| Concat2

    %% Output
    Output[("Output Sequence&lt;br&gt;256 × 512")]
    class Output output

    Concat2 --&gt; |256x512| Output

    %% Styling
    class LSTM_Layer_1,LSTM_Layer_2 rnn</code></pre>
<p>下面是 LSTM 的具体结构。</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR

    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef gate fill:#313244,stroke:#89dceb,stroke-width:2px,color:#cdd6f4;
    classDef cell fill:#313244,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4;
    classDef op fill:#45475a,stroke:#cdd6f4,stroke-width:1px,shape:circle;
    classDef transform fill:#313244,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;
    classDef title fill:#1e1e2e,stroke:#cba6f7,stroke-width:1px,color:#cba6f7;

    %% Inputs
    subgraph Inputs
        direction LR
        Xt["Input x_t&lt;br&gt;dim: 128"]
        Ht_1["Hidden h_t-1&lt;br&gt;dim: 256"]
    end
    Ct_1["Cell c_t-1&lt;br&gt;dim: 256"]

    %% Concatenation
    Concat["Concatenate [h_t-1, x_t]&lt;br&gt;dim: 256 + 128 = 384"]
    Ht_1 --&gt; Concat
    Xt --&gt; Concat

    %% Linear Transformation
    subgraph LinearProj ["Gate &amp; Cell Candidate Projections"]
        W["Linear &lt;br&gt;input: 384&lt;br&gt;output: 4 * 256 = 1024&lt;br&gt;(Effectively 4 parallel Linear(384, 256) layers)"]
    end
    Concat --&gt; W
    class LinearProj transform;

    %% Gate Activations
    subgraph GateActivations ["Gate Activations"]
        direction LR
        subgraph ForgetGate["Forget Gate"]
            S_f["Sigmoid"]
        end
        subgraph InputGate["Input Gate"]
            S_i["Sigmoid"]
        end
        subgraph CellCandidate["Cell Candidate"]
            T_g["tanh"]
        end
        subgraph OutputGate["Output Gate"]
            S_o["Sigmoid"]
        end
    end
    W --&gt; |Linear proj for f_t| S_f
    W --&gt; |Linear proj for i_t| S_i
    W --&gt; |Linear proj for g_t| T_g
    W --&gt; |Linear proj for o_t| S_o

    %% Cell State Update
    subgraph CellState["Cell State Update"]
        Mul1("⊙")
        Mul2("⊙")
        Add("+")
    end

    subgraph state["States of this time step"]
        Ct_1
        Concat
    end

    S_f --&gt; |f_t&lt;br&gt;dim: 256| Mul1
    Ct_1 --&gt; Mul1

    S_i --&gt; |i_t&lt;br&gt;dim: 256| Mul2
    T_g --&gt; |g_t&lt;br&gt;dim: 256| Mul2

    Mul1 --&gt; Add
    Mul2 --&gt; Add

    Ct["New Cell c_t&lt;br&gt;dim: 256"]
    Add --&gt; Ct

    %% Hidden State Update
    subgraph HiddenState["Hidden State Update"]
        T_c["tanh"]
        Mul3("⊙")
    end

    Ct --&gt; T_c
    S_o --&gt; |o_t&lt;br&gt;dim: 256| Mul3
    T_c --&gt; Mul3

    Ht["New Hidden h_t&lt;br&gt;dim: 256"]
    Mul3 --&gt; Ht

    %% Recurrent Connections to next time step
    Ct ---&gt; nCt_1
    Ht  ---&gt; nHt_1
    nXt_1 --&gt; nHt_1

    subgraph nip["Input of the next time step"]
        nXt_1["Input x_t+1&lt;br&gt;dim: 256"]
        Ht
    end

    subgraph nst["States of the next time step"]
        nCt_1["Cell c_t&lt;br&gt;dim: 256"]
        nHt_1["Concatenated vector&lt;br&gt;dim: 384"]
    end

    %% Styling
    class Title title;
    class Inputs,nip input;
    class Ht,Ct output;
    class GateActivations gate;
    class CellState,HiddenState cell;
    class Mul1,Mul2,Mul3,Add op;</code></pre>
<p>可以看到每一个时间步下，先将输入和隐藏状态拼接，由这个 384 维的拼接向量经过一个 4 倍隐藏维度的投影层，很自然的就可以把投影向量分成四份。每一份是都对当前状态和当前隐藏状态的特征进行映射的向量。这些向量要负责结合细胞状态来控制状态的更新和输出。其实这一步很像优化器的流程，事实上已经有关于 RNN 和优化器的一些对比讨论了。</p>
<p>首先来看第一个投影向量 <span class="arithmatex">\(f_t\)</span>，经过 Sigmoid 激活后，将其与细胞状态 <span class="arithmatex">\(c_{t-1}\)</span> 相乘，也就是通过 <span class="arithmatex">\(f_t\)</span> 来控制哪些分量应该忘掉，也就是激活后得到 0 的位置。</p>
<p>既然有遗忘，那也需要记忆。这就交给 <span class="arithmatex">\(i_t\)</span> 和 <span class="arithmatex">\(g_t\)</span>。由于 <span class="arithmatex">\(i_t\)</span> 是特征经过 Sigmoid 激活的结果，恒为正，因此可以作为纯输入的信息。而 <span class="arithmatex">\(g_t\)</span> 经过的是 tanh 激活，有正有负，和 <span class="arithmatex">\(i_t\)</span> 相乘之后，一方面可以说是增加网络的宽度，另一方面也对输入信息提供合理的抑制，防止其单调递增。最后和遗忘门的结果加起来，就可以得到新的细胞状态 <span class="arithmatex">\(c_t\)</span> 了。这里的细胞状态通过门控决定自己应该保留多少、更新多少，作用就和朴素 RNN 的隐藏状态是一致的。</p>
<p>但是 LSTM 里面也出现了一个隐藏状态，按我的理解，其实 LSTM 区分细胞状态和隐藏状态是一种对 RNN 隐藏状态的功能解耦。因为一方面，隐藏状态要负责记忆先前的序列信息，另一方面，隐藏状态还要肩负起提取序列特征输出的作用，所以 LSTM 采用了细胞状态记忆序列信息，而和输入一起丢进来的那个所谓的隐藏状态，起到的就是提取特征的作用。何以见得？让我们看看输出的计算。</p>
<p>这里仍然是特征经过 Sigmoid 激活后得到向量 <span class="arithmatex">\(o_t\)</span>，然后需要和 tanh 激活后的新细胞状态相乘——也就是说，为了得到新的隐藏状态，需要参考目前的记忆，来选择性提取当前输入带来的特征。</p>
<p>因此 LSTM 也可以解决 RNN 的梯度爆炸/消失的问题。RNN 因为是对记忆的全量更新，很容易遗忘早期信息，同时也在这种全量更新上累积梯度，成了等比数列；而 LSTM 只不过引入门控来限制更新，就可以增强记忆力而缓解梯度问题。</p>
<p>当然最后训练出来一个参数量 2M 的 LSTM，还是没能打败 nanoViT。毕竟二维的注意力矩阵，对长距离/空间上的特征依赖效果必然好于仅靠一两个隐藏状态建模记忆力的 LSTM 好。不过，我们也没有必要勉强它，毕竟，图像任务从来都不是擅长序列建模的 RNN 的强项。至少我们证明了，在图像分类任务上使用 RNN 是可行的。</p>
<h2 id="vae">VAE<a class="headerlink" href="#vae" title="Permanent link">¶</a></h2>
<p>这里笔者使用了三种利用 VAE （准确说是 β-VAE）进行图像分类的方法， <del>让我们按照从夯到拉的顺序评鉴一下</del> 思路各异：</p>
<ul>
<li>在隐空间进行 K-means 聚类，按标签投票成为该聚类的标签。</li>
<li>CVAE，即拼接图像和标签，再给隐空间加个标签维度，这样甚至可以带标签生成。</li>
<li>还是 CVAE 的思路，但是借用编码器的特征提取器，训练一个分类头，将分类损失缩放一个比例掺到总损失里面（或许可以叫 γ-C-β-VAE？），其实有点类似用 VAE 给编码器做正则化。</li>
</ul>
<p>由于 CIFAR-10 的训练集风格差异很大且数据量也不够，所以在介绍将 VAE 接入分类任务之前，先让我们尝试一下 VAE 的本门功夫——图像生成。</p>
<h3 id="aka">动漫风格头像生成 a.k.a. 画老婆<a class="headerlink" href="#aka" title="Permanent link">¶</a></h3>
<p>本次使用的数据集是 Kaggle 上面的 Anime Face Dataset，是基于 Danbooru 的一个 63k 张图像的子集，但是 GitHub 上的数据貌似因为版权原因被拿下了。不过我本来一直都在 Kaggle 的 GPU 上面训练所以也没多大影响。</p>
<p>数据集是不带标签的 3@64x64 图像，下面是一些样本：</p>
<p><img alt="waifus!" src="../image-1.png"/></p>
<p>（第五排从左往右第三个是 galgame "Island" 的女主御原凛音的立绘，大家都来玩啊~ <del>现在知道为什么这个数据集在GitHub上因为版权问题被拿下了吧</del> ）</p>
<p>我们现在的任务就是根据已经有的头像，画出新的头像。也就是 <span class="arithmatex">\(y=f(x)\)</span> 其中 <span class="arithmatex">\(y\)</span> 是我们的生成图片， <span class="arithmatex">\(x\)</span> 是原始图片。为了避免乱生成，其实需要最小化 <span class="arithmatex">\(y\)</span> 和 <span class="arithmatex">\(x\)</span> 的偏差。——这不是 ResNet 干的活吗？因此在这里我们需要澄清一点：</p>
<p>我们并不是取学习某一张图片，而是所有训练图片构成的<strong>概率分布</strong>！了解了这个概率分布的形状之后，我们就可以在里面采样，得到生成的图片了。而 ResNet 只会把输入数据原样返回。</p>
<p>我们假设输入的数据为 <span class="arithmatex">\(x\)</span> 而概率分布为 <span class="arithmatex">\(p(x)\)</span>，我们需要找到一个方式去（近似）描述 <span class="arithmatex">\(p(x)\)</span>。由于数据维度很高，且维度之间有复杂的相互关联，因此直接寻找是相当复杂的，那怎么办呢？</p>
<p>诶，当我们需要在复杂任务里面找规律的时候，第一时间想到的是什么？降维！具体而言，就是考虑这个目标分布是输入通过编码再解码的结果，而编码的过程，就是对特征和规律进行降维、压缩、提取的过程：</p>
<div class="arithmatex">\[
p(x)\approx q(x)=\int q(x|z)q(z)\mathrm d z
\]</div>
<p>这里，<span class="arithmatex">\(x\)</span> 是输入，<span class="arithmatex">\(q(x)\)</span> 是我们对目标函数 <span class="arithmatex">\(p(x)\)</span> 的拟合尝试，<span class="arithmatex">\(z\)</span> 是降维后的<strong>隐变量</strong>，<span class="arithmatex">\(q(z)\)</span> 就是隐变量的分布，而 <span class="arithmatex">\(q(x|z)\)</span>  就是从隐变量生成图片的解码器。这个式子很好理解，里面的等式就是全概率公式。</p>
<p>下面我们要解决这样几个问题：</p>
<ul>
<li>怎么获取编码器，也就是从原始的图像得到隐变量的分布？</li>
<li>怎么衡量两个分布的近似程度来得到损失函数？</li>
</ul>
<p>第一个问题比较核心，也涉及到 VAE 的生图风格，我们等会再聊。第二个问题，大家基本上都能脱口而出——使用 KL 散度不就行了吗。</p>
<p>但是这里如果计算 <span class="arithmatex">\(p(x)\)</span> 和 <span class="arithmatex">\(q(x)\)</span> 的 KL 散度，其实很不方便，因为一是这些式子都比较原子化拆不开就不好化简（更何况 <span class="arithmatex">\(p(x)\)</span> 都不知道，没办法算），二是刚刚费力引入的 <span class="arithmatex">\(z\)</span> 没用上。</p>
<p>因此我们考虑对联合分布 <span class="arithmatex">\(p(x,z)\)</span> 和 <span class="arithmatex">\(q(x,z)\)</span> 计算 KL 散度，也就是说利用隐变量相对 <span class="arithmatex">\(p\)</span> 与 <span class="arithmatex">\(q\)</span> 的关系：（推导略长但是不难，下面有 Hint）</p>
<div class="arithmatex">\[
\begin{align*}
  KL\left(p(x,z)||q(x,z)\right)&amp;=\int\int p(x,z) \log \dfrac{p(x,z)}{q(x,z)} \mathrm d x \mathrm d z\\
  &amp;= \int\int p(x)p(z|x) \log\dfrac{p(x)p(z|x)}{q(x,z)} \mathrm d z \mathrm d x\\
  &amp;=\int p(x)[\int p(z|x)\log\dfrac{p(x)p(z|x)}{q(x,z)} \mathrm d z]\mathrm d x\\
  &amp;=\mathbb E_{x\sim p(x)}[\int p(z|x)[\log p(x) + \log p(z|x)- \log q(x,z)] \mathrm d z]\\
  &amp;=\mathbb E_{x\sim p(x)}[\log p(x)+\int p(z|x)\log\dfrac{p(z|x)}{q(z)q(x|z)}\mathrm d z]\\
  &amp;=\mathbb E_{x\sim p(x)}[\log p(x)-\int p(z|x)\log q(x|z)\mathrm d z+\int p(z|x)\log\dfrac{p(z|x)}{q(z)}\mathrm d z]\\
  &amp;=\mathbb E_{x\sim p(x)}[\log p(x)-\mathbb E_{z\sim p(z|x)}[\log q(x|z)]+\int p(z|x)\log\dfrac{p(z|x)}{q(z)}\mathrm d z]\\
  &amp;=\mathbb E_{x\sim p(x)}[\log p(x)-\mathbb E_{z\sim p(z|x)}[\log q(x|z)]+KL(p(z|x) || q(z))]\\
  &amp;=\mathbb E_{x\sim p(x)}[\log p(x)]+\mathbb E_{x\sim p(x)}[-\mathbb E_{z\sim p(z|x)}[\log q(x|z)]+KL(p(z|x) || q(z))]\\
  &amp;=\mathrm{Constant.}+\mathbb E_{x\sim p(x)}[-ELBO]
\end{align*}
\]</div>
<p>这就是我们得到的损失函数。推导时应用了期望的性质和条件概率公式以及 KL 散度的定义，第五行消掉第一项的 <span class="arithmatex">\(p(z|x)\)</span> 是用的概率的归一化性质。里面的 <span class="arithmatex">\(ELBO\)</span> 这个马甲的意思叫 Evidence Lower Bound，即证据下界，因为这一联合分布的 KL 散度恒大于之前提到的边际分布的 KL 散度，所以叫做下界，其实证据下界就是对近似程度的衡量，简单说就是要最大化的量。整个推导的目标很明确，尽量不要让含有 <span class="arithmatex">\(p\)</span> 的函数参与到最后的式子里面，利用好已有的 <span class="arithmatex">\(q\)</span> 相关的函数。而且要让结果靠近对“编码器”和“解码器”的损失计算。于是乎，我们只需要最大化 <span class="arithmatex">\(ELBO\)</span> 即可。关于 <span class="arithmatex">\(ELBO\)</span>，可以拆开：</p>
<div class="arithmatex">\[
\begin{align*}
  ELBO&amp;=\mathbb E_{z\sim p(z|x)}[\log q(x|z)]-KL(p(z|x) || q(z))
\end{align*}
\]</div>
<p>第一项的意思是是<strong>重构误差</strong>，衡量解码器 <span class="arithmatex">\(q(x|z)\)</span> 的结果对原图 <span class="arithmatex">\(x\)</span> 的差异程度；第二项的意思是<strong>衡量编码器对隐变量分布的近似程度</strong>。</p>
<p>实际上我们可以将两项解耦，来分配不同的权重，也就是可以写成</p>
<div class="arithmatex">\[
\begin{align*}
  ELBO&amp;=\mathbb E_{z\sim p(z|x)}[\log q(x|z)]-\beta KL(p(z|x) || q(z))
\end{align*}
\]</div>
<p>这叫做 β-VAE，后面我们会看到这样做的理由和意义。</p>
<p>为了计算 <span class="arithmatex">\(ELBO\)</span>，<span class="arithmatex">\(q(x|z)\)</span> 自然是对隐变量 <span class="arithmatex">\(z\)</span> 解码到 <span class="arithmatex">\(x\)</span> 上的神经网络，而 VAE 的作者对隐变量分布 <span class="arithmatex">\(q(z)\)</span> 和编码器 <span class="arithmatex">\(p(z|x)\)</span> 给了个很激进的方案：默认它们是正态分布！这似乎听起来有点理由但又有点武断，其实后面我们将会看到，对 VAE 而言，成也正态分布，败也正态分布。</p>
<p>具体而言，对 <span class="arithmatex">\(q(z)\)</span> 我们可以直接假定为标准正态分布 <span class="arithmatex">\(N(0,I)\)</span>，但是 <span class="arithmatex">\(p(z|x)\)</span> 是个条件分布，怎么搞呢？事实上回忆一下多元正态函数的定义：</p>
<div class="arithmatex">\[
p(z|x)=\dfrac{\exp{\left(-0.5\left |\dfrac{z-\mu}{\sigma}\right |^2\right)}}{\prod \sqrt{2\pi\sigma_i^2}}
\]</div>
<p>这里的 <span class="arithmatex">\(\mu\)</span> 和 <span class="arithmatex">\(\sigma\)</span> 都是和隐变量 <span class="arithmatex">\(z\)</span> 维度一致的向量，也就是说可以用神经网络来压缩！</p>
<p>那么 KL 散度项就可以很轻松解决了：</p>
<div class="arithmatex">\[
\begin{align*}
  KL &amp;= \int p(z|x)\log\dfrac{p(z|x)}{q(z)}\mathrm d z\\
  &amp;=\mathbb{E}_{z\sim p(z|x)}[\log \dfrac{p(z|x)}{q(z)}]\\
  &amp;=\mathbb{E}_{z\sim p(z|x)}[\log\dfrac{\exp{\left(-0.5\left |\dfrac{z-\mu}{\sigma}\right |^2\right)}}{\prod \sqrt{2\pi\sigma_i^2}}\times \dfrac{\prod \sqrt{2\pi}}{\exp{(-0.5 |z|^2)}}]\\
  &amp;=\mathbb{E}_{z\sim p(z|x)}[0.5|z|^2-0.5\left |\dfrac{z-\mu}{\sigma}\right |^2-\sum \log \sigma_i]\\
  &amp;=\dfrac 12 \sum \sigma_i^2 +\mu_i^2-1-\log \sigma_i
\end{align*}
\]</div>
<p>最后一步使用了正态分布二阶矩的性质：<span class="arithmatex">\(\mathbb{E}[x^2]=\mu^2+\sigma^2\)</span>。</p>
<p>对于重构误差项，我们可能会想到利用 MSE 来衡量重构误差，但是这样做是否有理论依据呢？事实上如果考虑解码器 <span class="arithmatex">\(q(x|z)\)</span> 和编码器一样服从正态分布，也就是：</p>
<div class="arithmatex">\[
\begin{align*}
  \mathbb E_{z\sim p(z|x)}[\log q(x|z)]&amp;=\mathbb E_{z\sim p(z|x)}[\log \dfrac{\exp{\left(-0.5\left |\dfrac{x-\mu'}{\sigma'}\right |^2\right)}}{\prod \sqrt{2\pi{\sigma'}_i^2}}]\\
  &amp;=-\dfrac{1}{2|\sigma'|^2}|x-\mu'|^2-\sum\log \sqrt{2\pi{\sigma'}_i^2}
\end{align*}
\]</div>
<p>这里的 <span class="arithmatex">\(\mu'\)</span> 即解码的均值其实就是输出的图像的均值。如果取 <span class="arithmatex">\(\sigma'\)</span> 是固定的向量，那就得到 MSE 了。事实上，这里 <span class="arithmatex">\(\sigma'\)</span> 的大小估计就和 β-VAE 的思想等价，都是来调控两种损失的比例的。因此我们就估计出了最终的损失函数：</p>
<div class="arithmatex">\[
\begin{align*}
  \mathcal{L}&amp;=-\mathbb E_{x\sim p(x)}[ELBO]\\
  &amp;=-\mathbb E_{x\sim p(x)}[\mathbb E_{z\sim p(z|x)}[\log q(x|z)]-\beta KL(p(z|x) || q(z))]\\
  &amp;=\mathbb E_{x\sim p(x)}[\dfrac{1}{2}|x-\mu'|^2-\beta\dfrac 12 \sum \sigma_i^2 +\mu_i^2-1-\log \sigma_i]\\
  &amp;=\mathbb E_{x\sim p(x)}[MSE -\beta KLD]\\
  &amp;=\dfrac 1n \sum_i^n (MSE_{x_i}-\beta KLD_{x_i})
\end{align*}
\]</div>
<p>最后一步，就是通过采样近似期望。实际上我们进行的是批量训练，因此，每次只需要对输入采样一个隐变量 <span class="arithmatex">\(z\)</span> 即可。也就是说最终我们得到了可以计算的损失函数！</p>
<div class="arithmatex">\[
\mathcal{L(x)}=MSE_{x}-\beta KLD_{x}
\]</div>
<p>但是还有一个问题：虽然这是可以计算的，但 <span class="arithmatex">\(\mu\)</span> 和 <span class="arithmatex">\(\sigma\)</span> 的值会随着参数的变化而变化，进而影响到分布 <span class="arithmatex">\(q(z)\)</span>，也就是说带参数的正态分布是无法直接进行微分来反向传播的。这一问题有一个很好的解决方案：重参数化。</p>
<p>也就是从分布 <span class="arithmatex">\(N(\mu,\sigma^2)\)</span> 采样其实就是一个平移加缩放，只需要在标准分布 <span class="arithmatex">\(N(0,1)\)</span> 里面采样 <span class="arithmatex">\(y\)</span>，然后计算 <span class="arithmatex">\(y'=\mu+\sigma y\)</span> 就可以得到从分布 <span class="arithmatex">\(N(\mu,\sigma^2)\)</span> 采样的结果了。由于线性变换可微，就可以交给优化器做更新了。</p>
<p>现在回顾一下整个 VAE 的训练流程：</p>
<ul>
<li>输入 <span class="arithmatex">\(x\)</span> 通过编码器得到两个和 <span class="arithmatex">\(z\)</span> 维度一致的向量 <span class="arithmatex">\(\mu\)</span> 和 <span class="arithmatex">\(\sigma\)</span>。</li>
<li>在标准正态分布下采样向量 <span class="arithmatex">\(\epsilon\)</span> 然后计算 <span class="arithmatex">\(z=\mu + \epsilon\odot\sigma\)</span>。</li>
<li>将 <span class="arithmatex">\(z\)</span> 输入到解码器得到重构图像 <span class="arithmatex">\(x'\)</span>。</li>
<li>根据 <span class="arithmatex">\(\mu\)</span>、<span class="arithmatex">\(\sigma\)</span> 和 <span class="arithmatex">\(x\)</span> 以及 <span class="arithmatex">\(x'\)</span>，使用损失函数 <span class="arithmatex">\(\mathcal{L(x)}=MSE_{x}-\beta KLD_{x}\)</span> 计算梯度并反向传播更新参数。</li>
</ul>
<p>如此，通往 VAE 的道路已经铺好，让我们编写代码吧。</p>
<details>
<summary> 加载数据集使用的代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span>
<span class="normal"><a href="#__codelineno-21-19">19</a></span>
<span class="normal"><a href="#__codelineno-21-20">20</a></span>
<span class="normal"><a href="#__codelineno-21-21">21</a></span>
<span class="normal"><a href="#__codelineno-21-22">22</a></span>
<span class="normal"><a href="#__codelineno-21-23">23</a></span>
<span class="normal"><a href="#__codelineno-21-24">24</a></span>
<span class="normal"><a href="#__codelineno-21-25">25</a></span>
<span class="normal"><a href="#__codelineno-21-26">26</a></span>
<span class="normal"><a href="#__codelineno-21-27">27</a></span>
<span class="normal"><a href="#__codelineno-21-28">28</a></span>
<span class="normal"><a href="#__codelineno-21-29">29</a></span>
<span class="normal"><a href="#__codelineno-21-30">30</a></span>
<span class="normal"><a href="#__codelineno-21-31">31</a></span>
<span class="normal"><a href="#__codelineno-21-32">32</a></span>
<span class="normal"><a href="#__codelineno-21-33">33</a></span>
<span class="normal"><a href="#__codelineno-21-34">34</a></span>
<span class="normal"><a href="#__codelineno-21-35">35</a></span>
<span class="normal"><a href="#__codelineno-21-36">36</a></span>
<span class="normal"><a href="#__codelineno-21-37">37</a></span>
<span class="normal"><a href="#__codelineno-21-38">38</a></span>
<span class="normal"><a href="#__codelineno-21-39">39</a></span>
<span class="normal"><a href="#__codelineno-21-40">40</a></span>
<span class="normal"><a href="#__codelineno-21-41">41</a></span>
<span class="normal"><a href="#__codelineno-21-42">42</a></span>
<span class="normal"><a href="#__codelineno-21-43">43</a></span>
<span class="normal"><a href="#__codelineno-21-44">44</a></span>
<span class="normal"><a href="#__codelineno-21-45">45</a></span>
<span class="normal"><a href="#__codelineno-21-46">46</a></span>
<span class="normal"><a href="#__codelineno-21-47">47</a></span>
<span class="normal"><a href="#__codelineno-21-48">48</a></span>
<span class="normal"><a href="#__codelineno-21-49">49</a></span>
<span class="normal"><a href="#__codelineno-21-50">50</a></span>
<span class="normal"><a href="#__codelineno-21-51">51</a></span>
<span class="normal"><a href="#__codelineno-21-52">52</a></span>
<span class="normal"><a href="#__codelineno-21-53">53</a></span>
<span class="normal"><a href="#__codelineno-21-54">54</a></span>
<span class="normal"><a href="#__codelineno-21-55">55</a></span>
<span class="normal"><a href="#__codelineno-21-56">56</a></span>
<span class="normal"><a href="#__codelineno-21-57">57</a></span>
<span class="normal"><a href="#__codelineno-21-58">58</a></span>
<span class="normal"><a href="#__codelineno-21-59">59</a></span>
<span class="normal"><a href="#__codelineno-21-60">60</a></span>
<span class="normal"><a href="#__codelineno-21-61">61</a></span>
<span class="normal"><a href="#__codelineno-21-62">62</a></span>
<span class="normal"><a href="#__codelineno-21-63">63</a></span>
<span class="normal"><a href="#__codelineno-21-64">64</a></span>
<span class="normal"><a href="#__codelineno-21-65">65</a></span>
<span class="normal"><a href="#__codelineno-21-66">66</a></span>
<span class="normal"><a href="#__codelineno-21-67">67</a></span>
<span class="normal"><a href="#__codelineno-21-68">68</a></span>
<span class="normal"><a href="#__codelineno-21-69">69</a></span>
<span class="normal"><a href="#__codelineno-21-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.utils</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">vutils</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="c1"># 数据集所在的路径</span>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s1">'/kaggle/input/animefacedataset/images/'</span>
<a id="__codelineno-21-12" name="__codelineno-21-12"></a>
<a id="__codelineno-21-13" name="__codelineno-21-13"></a><span class="c1"># 定义超参数</span>
<a id="__codelineno-21-14" name="__codelineno-21-14"></a><span class="n">IMAGE_SIZE</span> <span class="o">=</span> <span class="mi">64</span>    <span class="c1"># 图像将被调整到的大小</span>
<a id="__codelineno-21-15" name="__codelineno-21-15"></a><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">256</span>   <span class="c1"># 每个批次加载的图像数量，最好和下面训练的 bs 一致</span>
<a id="__codelineno-21-16" name="__codelineno-21-16"></a><span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">6</span>    <span class="c1"># 加载数据的工作进程数，虽然 Kaggle 会报 warning 但是实测 6 比 4 好。</span>
<a id="__codelineno-21-17" name="__codelineno-21-17"></a>
<a id="__codelineno-21-18" name="__codelineno-21-18"></a><span class="c1"># 定义图像预处理/变换</span>
<a id="__codelineno-21-19" name="__codelineno-21-19"></a><span class="c1"># 1. Resize: 缩放到 IMAGE_SIZE</span>
<a id="__codelineno-21-20" name="__codelineno-21-20"></a><span class="c1"># 2. ToTensor: 转换为 PyTorch Tensor，并将像素值从 [0, 255] 归一化到 [0.0, 1.0]</span>
<a id="__codelineno-21-21" name="__codelineno-21-21"></a><span class="c1"># 3. Normalize: 将 [0.0, 1.0] 的数据标准化到 [-1.0, 1.0]，这是训练 GAN 的标准做法</span>
<a id="__codelineno-21-22" name="__codelineno-21-22"></a><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<a id="__codelineno-21-23" name="__codelineno-21-23"></a>    <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">IMAGE_SIZE</span><span class="p">),</span>
<a id="__codelineno-21-24" name="__codelineno-21-24"></a>    <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">IMAGE_SIZE</span><span class="p">),</span>
<a id="__codelineno-21-25" name="__codelineno-21-25"></a>    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<a id="__codelineno-21-26" name="__codelineno-21-26"></a>    <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<a id="__codelineno-21-27" name="__codelineno-21-27"></a><span class="p">])</span>
<a id="__codelineno-21-28" name="__codelineno-21-28"></a>
<a id="__codelineno-21-29" name="__codelineno-21-29"></a><span class="k">class</span><span class="w"> </span><span class="nc">AnimeFaceDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-21-30" name="__codelineno-21-30"></a><span class="w">    </span><span class="sd">"""自定义动漫人脸数据集"""</span>
<a id="__codelineno-21-31" name="__codelineno-21-31"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-21-32" name="__codelineno-21-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>
<a id="__codelineno-21-33" name="__codelineno-21-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
<a id="__codelineno-21-34" name="__codelineno-21-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)]</span>
<a id="__codelineno-21-35" name="__codelineno-21-35"></a>
<a id="__codelineno-21-36" name="__codelineno-21-36"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-37" name="__codelineno-21-37"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_files</span><span class="p">)</span>
<a id="__codelineno-21-38" name="__codelineno-21-38"></a>
<a id="__codelineno-21-39" name="__codelineno-21-39"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-21-40" name="__codelineno-21-40"></a>        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_files</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<a id="__codelineno-21-41" name="__codelineno-21-41"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">'RGB'</span><span class="p">)</span>
<a id="__codelineno-21-42" name="__codelineno-21-42"></a>
<a id="__codelineno-21-43" name="__codelineno-21-43"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
<a id="__codelineno-21-44" name="__codelineno-21-44"></a>            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-21-45" name="__codelineno-21-45"></a>
<a id="__codelineno-21-46" name="__codelineno-21-46"></a>        <span class="k">return</span> <span class="n">image</span>
<a id="__codelineno-21-47" name="__codelineno-21-47"></a>
<a id="__codelineno-21-48" name="__codelineno-21-48"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"loading dataset"</span><span class="p">)</span>
<a id="__codelineno-21-49" name="__codelineno-21-49"></a><span class="c1"># 实例化数据集</span>
<a id="__codelineno-21-50" name="__codelineno-21-50"></a><span class="n">anime_dataset</span> <span class="o">=</span> <span class="n">AnimeFaceDataset</span><span class="p">(</span><span class="n">root_dir</span><span class="o">=</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<a id="__codelineno-21-51" name="__codelineno-21-51"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Dataset size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">anime_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> pictures."</span><span class="p">)</span>
<a id="__codelineno-21-52" name="__codelineno-21-52"></a>
<a id="__codelineno-21-53" name="__codelineno-21-53"></a><span class="c1"># 实例化 DataLoader</span>
<a id="__codelineno-21-54" name="__codelineno-21-54"></a><span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<a id="__codelineno-21-55" name="__codelineno-21-55"></a>    <span class="n">dataset</span><span class="o">=</span><span class="n">anime_dataset</span><span class="p">,</span>
<a id="__codelineno-21-56" name="__codelineno-21-56"></a>    <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
<a id="__codelineno-21-57" name="__codelineno-21-57"></a>    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-21-58" name="__codelineno-21-58"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span>
<a id="__codelineno-21-59" name="__codelineno-21-59"></a>    <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-21-60" name="__codelineno-21-60"></a><span class="p">)</span>
<a id="__codelineno-21-61" name="__codelineno-21-61"></a><span class="n">real_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
<a id="__codelineno-21-62" name="__codelineno-21-62"></a>
<a id="__codelineno-21-63" name="__codelineno-21-63"></a><span class="c1"># 设置绘图</span>
<a id="__codelineno-21-64" name="__codelineno-21-64"></a><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-21-65" name="__codelineno-21-65"></a><span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<a id="__codelineno-21-66" name="__codelineno-21-66"></a><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Training Images"</span><span class="p">)</span>
<a id="__codelineno-21-67" name="__codelineno-21-67"></a>
<a id="__codelineno-21-68" name="__codelineno-21-68"></a><span class="n">grid</span> <span class="o">=</span> <span class="n">vutils</span><span class="o">.</span><span class="n">make_grid</span><span class="p">(</span><span class="n">real_batch</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-21-69" name="__codelineno-21-69"></a><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="c1"># 从 (C, H, W) 转为 (H, W, C)</span>
<a id="__codelineno-21-70" name="__codelineno-21-70"></a><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<p>默认一发 64 抽，可以看看抽出来的有没有认识的（）</p>
<p>下面就可以愉快训练了。</p>
<details>
<summary> 训练使用的代码</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">  1</a></span>
<span class="normal"><a href="#__codelineno-22-2">  2</a></span>
<span class="normal"><a href="#__codelineno-22-3">  3</a></span>
<span class="normal"><a href="#__codelineno-22-4">  4</a></span>
<span class="normal"><a href="#__codelineno-22-5">  5</a></span>
<span class="normal"><a href="#__codelineno-22-6">  6</a></span>
<span class="normal"><a href="#__codelineno-22-7">  7</a></span>
<span class="normal"><a href="#__codelineno-22-8">  8</a></span>
<span class="normal"><a href="#__codelineno-22-9">  9</a></span>
<span class="normal"><a href="#__codelineno-22-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-22-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-22-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-22-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-22-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-22-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-22-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-22-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-22-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-22-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-22-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-22-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-22-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-22-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-22-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-22-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-22-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-22-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-22-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-22-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-22-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-22-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-22-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-22-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-22-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-22-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-22-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-22-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-22-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-22-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-22-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-22-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-22-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-22-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-22-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-22-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-22-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-22-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-22-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-22-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-22-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-22-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-22-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-22-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-22-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-22-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-22-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-22-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-22-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-22-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-22-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-22-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-22-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-22-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-22-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-22-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-22-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-22-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-22-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-22-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-22-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-22-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-22-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-22-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-22-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-22-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-22-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-22-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-22-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-22-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-22-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-22-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-22-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-22-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-22-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-22-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-22-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-22-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-22-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-22-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-22-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-22-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-22-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-22-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-22-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-22-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-22-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-22-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-22-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-22-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-22-100">100</a></span>
<span class="normal"><a href="#__codelineno-22-101">101</a></span>
<span class="normal"><a href="#__codelineno-22-102">102</a></span>
<span class="normal"><a href="#__codelineno-22-103">103</a></span>
<span class="normal"><a href="#__codelineno-22-104">104</a></span>
<span class="normal"><a href="#__codelineno-22-105">105</a></span>
<span class="normal"><a href="#__codelineno-22-106">106</a></span>
<span class="normal"><a href="#__codelineno-22-107">107</a></span>
<span class="normal"><a href="#__codelineno-22-108">108</a></span>
<span class="normal"><a href="#__codelineno-22-109">109</a></span>
<span class="normal"><a href="#__codelineno-22-110">110</a></span>
<span class="normal"><a href="#__codelineno-22-111">111</a></span>
<span class="normal"><a href="#__codelineno-22-112">112</a></span>
<span class="normal"><a href="#__codelineno-22-113">113</a></span>
<span class="normal"><a href="#__codelineno-22-114">114</a></span>
<span class="normal"><a href="#__codelineno-22-115">115</a></span>
<span class="normal"><a href="#__codelineno-22-116">116</a></span>
<span class="normal"><a href="#__codelineno-22-117">117</a></span>
<span class="normal"><a href="#__codelineno-22-118">118</a></span>
<span class="normal"><a href="#__codelineno-22-119">119</a></span>
<span class="normal"><a href="#__codelineno-22-120">120</a></span>
<span class="normal"><a href="#__codelineno-22-121">121</a></span>
<span class="normal"><a href="#__codelineno-22-122">122</a></span>
<span class="normal"><a href="#__codelineno-22-123">123</a></span>
<span class="normal"><a href="#__codelineno-22-124">124</a></span>
<span class="normal"><a href="#__codelineno-22-125">125</a></span>
<span class="normal"><a href="#__codelineno-22-126">126</a></span>
<span class="normal"><a href="#__codelineno-22-127">127</a></span>
<span class="normal"><a href="#__codelineno-22-128">128</a></span>
<span class="normal"><a href="#__codelineno-22-129">129</a></span>
<span class="normal"><a href="#__codelineno-22-130">130</a></span>
<span class="normal"><a href="#__codelineno-22-131">131</a></span>
<span class="normal"><a href="#__codelineno-22-132">132</a></span>
<span class="normal"><a href="#__codelineno-22-133">133</a></span>
<span class="normal"><a href="#__codelineno-22-134">134</a></span>
<span class="normal"><a href="#__codelineno-22-135">135</a></span>
<span class="normal"><a href="#__codelineno-22-136">136</a></span>
<span class="normal"><a href="#__codelineno-22-137">137</a></span>
<span class="normal"><a href="#__codelineno-22-138">138</a></span>
<span class="normal"><a href="#__codelineno-22-139">139</a></span>
<span class="normal"><a href="#__codelineno-22-140">140</a></span>
<span class="normal"><a href="#__codelineno-22-141">141</a></span>
<span class="normal"><a href="#__codelineno-22-142">142</a></span>
<span class="normal"><a href="#__codelineno-22-143">143</a></span>
<span class="normal"><a href="#__codelineno-22-144">144</a></span>
<span class="normal"><a href="#__codelineno-22-145">145</a></span>
<span class="normal"><a href="#__codelineno-22-146">146</a></span>
<span class="normal"><a href="#__codelineno-22-147">147</a></span>
<span class="normal"><a href="#__codelineno-22-148">148</a></span>
<span class="normal"><a href="#__codelineno-22-149">149</a></span>
<span class="normal"><a href="#__codelineno-22-150">150</a></span>
<span class="normal"><a href="#__codelineno-22-151">151</a></span>
<span class="normal"><a href="#__codelineno-22-152">152</a></span>
<span class="normal"><a href="#__codelineno-22-153">153</a></span>
<span class="normal"><a href="#__codelineno-22-154">154</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_grid</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="s2">"METHOD_NAME"</span><span class="p">:</span> <span class="s2">"VAE"</span><span class="p">,</span>
<a id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="s2">"LATENT_DIM"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="s2">"BATCH_SIZE"</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
<a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="s2">"EPOCHS"</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="s2">"LR"</span><span class="p">:</span> <span class="mf">1e-4</span><span class="p">,</span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="s2">"BETA"</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
<a id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="s2">"DEVICE"</span><span class="p">:</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">,</span>
<a id="__codelineno-22-20" name="__codelineno-22-20"></a><span class="s2">"DATA_PATH"</span><span class="p">:</span> <span class="s2">"./data"</span><span class="p">,</span>
<a id="__codelineno-22-21" name="__codelineno-22-21"></a><span class="s2">"OUTPUT_PATH"</span><span class="p">:</span> <span class="s2">"./output"</span>
<a id="__codelineno-22-22" name="__codelineno-22-22"></a><span class="p">}</span>
<a id="__codelineno-22-23" name="__codelineno-22-23"></a><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"OUTPUT_PATH"</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">"METHOD_NAME"</span><span class="p">])</span>
<a id="__codelineno-22-24" name="__codelineno-22-24"></a><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-22-25" name="__codelineno-22-25"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using device: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'DEVICE'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-22-26" name="__codelineno-22-26"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running with Beta = </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'BETA'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-22-27" name="__codelineno-22-27"></a>
<a id="__codelineno-22-28" name="__codelineno-22-28"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">dataloader</span>
<a id="__codelineno-22-29" name="__codelineno-22-29"></a>
<a id="__codelineno-22-30" name="__codelineno-22-30"></a><span class="c1"># --- 2. 模型定义 ---</span>
<a id="__codelineno-22-31" name="__codelineno-22-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">VAE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-22-32" name="__codelineno-22-32"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">):</span>
<a id="__codelineno-22-33" name="__codelineno-22-33"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">VAE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-22-34" name="__codelineno-22-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span> <span class="o">=</span> <span class="n">latent_dim</span>
<a id="__codelineno-22-35" name="__codelineno-22-35"></a>
<a id="__codelineno-22-36" name="__codelineno-22-36"></a>        <span class="c1"># Encoder (64x64 -&gt; 8x8)</span>
<a id="__codelineno-22-37" name="__codelineno-22-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_features</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-22-38" name="__codelineno-22-38"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-22-39" name="__codelineno-22-39"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-22-40" name="__codelineno-22-40"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-22-41" name="__codelineno-22-41"></a>        <span class="p">)</span>
<a id="__codelineno-22-42" name="__codelineno-22-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_mu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">)</span>
<a id="__codelineno-22-43" name="__codelineno-22-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_log_var</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">)</span>
<a id="__codelineno-22-44" name="__codelineno-22-44"></a>
<a id="__codelineno-22-45" name="__codelineno-22-45"></a>        <span class="c1"># Decoder (latent_dim -&gt; 64x64)</span>
<a id="__codelineno-22-46" name="__codelineno-22-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">latent_dim</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-22-47" name="__codelineno-22-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-22-48" name="__codelineno-22-48"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-22-49" name="__codelineno-22-49"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-22-50" name="__codelineno-22-50"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-22-51" name="__codelineno-22-51"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span> <span class="c1"># 输出范围 [-1, 1]，匹配数据归一化</span>
<a id="__codelineno-22-52" name="__codelineno-22-52"></a>        <span class="p">)</span>
<a id="__codelineno-22-53" name="__codelineno-22-53"></a>
<a id="__codelineno-22-54" name="__codelineno-22-54"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-22-55" name="__codelineno-22-55"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-22-56" name="__codelineno-22-56"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-22-57" name="__codelineno-22-57"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_mu</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_log_var</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-22-58" name="__codelineno-22-58"></a>
<a id="__codelineno-22-59" name="__codelineno-22-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reparameterize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">):</span>
<a id="__codelineno-22-60" name="__codelineno-22-60"></a>        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-22-61" name="__codelineno-22-61"></a>        <span class="n">eps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
<a id="__codelineno-22-62" name="__codelineno-22-62"></a>        <span class="k">return</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">std</span>
<a id="__codelineno-22-63" name="__codelineno-22-63"></a>
<a id="__codelineno-22-64" name="__codelineno-22-64"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<a id="__codelineno-22-65" name="__codelineno-22-65"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_fc</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<a id="__codelineno-22-66" name="__codelineno-22-66"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-22-67" name="__codelineno-22-67"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_conv</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-22-68" name="__codelineno-22-68"></a>
<a id="__codelineno-22-69" name="__codelineno-22-69"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-22-70" name="__codelineno-22-70"></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-22-71" name="__codelineno-22-71"></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparameterize</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-22-72" name="__codelineno-22-72"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span>
<a id="__codelineno-22-73" name="__codelineno-22-73"></a>
<a id="__codelineno-22-74" name="__codelineno-22-74"></a><span class="c1"># --- 3. 损失函数 ---</span>
<a id="__codelineno-22-75" name="__codelineno-22-75"></a><span class="k">def</span><span class="w"> </span><span class="nf">vae_loss_function</span><span class="p">(</span><span class="n">recon_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">):</span>
<a id="__codelineno-22-76" name="__codelineno-22-76"></a>    <span class="n">MSE</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">recon_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">'sum'</span><span class="p">)</span>
<a id="__codelineno-22-77" name="__codelineno-22-77"></a>    <span class="n">KLD</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">log_var</span> <span class="o">-</span> <span class="n">mu</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_var</span><span class="o">.</span><span class="n">exp</span><span class="p">())</span>
<a id="__codelineno-22-78" name="__codelineno-22-78"></a>    <span class="k">return</span> <span class="n">MSE</span><span class="p">,</span> <span class="n">KLD</span>
<a id="__codelineno-22-79" name="__codelineno-22-79"></a>
<a id="__codelineno-22-80" name="__codelineno-22-80"></a><span class="c1"># 用于存储指标的字典</span>
<a id="__codelineno-22-81" name="__codelineno-22-81"></a><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-22-82" name="__codelineno-22-82"></a>    <span class="s1">'MSE loss'</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-22-83" name="__codelineno-22-83"></a>    <span class="s1">'KLD loss'</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-22-84" name="__codelineno-22-84"></a>    <span class="s1">'Total loss'</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-22-85" name="__codelineno-22-85"></a><span class="p">}</span>
<a id="__codelineno-22-86" name="__codelineno-22-86"></a>
<a id="__codelineno-22-87" name="__codelineno-22-87"></a><span class="c1"># --- 4. 训练循环 ---</span>
<a id="__codelineno-22-88" name="__codelineno-22-88"></a><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<a id="__codelineno-22-89" name="__codelineno-22-89"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-22-90" name="__codelineno-22-90"></a>    <span class="n">total_loss</span><span class="p">,</span> <span class="n">tot_mse</span><span class="p">,</span> <span class="n">tot_kld</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<a id="__codelineno-22-91" name="__codelineno-22-91"></a>    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'EPOCHS'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-22-92" name="__codelineno-22-92"></a>    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-22-93" name="__codelineno-22-93"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-22-94" name="__codelineno-22-94"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-22-95" name="__codelineno-22-95"></a>        <span class="n">recon_batch</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-22-96" name="__codelineno-22-96"></a>        <span class="n">mse_loss</span><span class="p">,</span> <span class="n">kld_loss</span> <span class="o">=</span> <span class="n">vae_loss_function</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-22-97" name="__codelineno-22-97"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">mse_loss</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"BETA"</span><span class="p">]</span> <span class="o">*</span> <span class="n">kld_loss</span>
<a id="__codelineno-22-98" name="__codelineno-22-98"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-22-99" name="__codelineno-22-99"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-22-100" name="__codelineno-22-100"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-22-101" name="__codelineno-22-101"></a>        <span class="n">tot_mse</span> <span class="o">+=</span> <span class="n">mse_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-22-102" name="__codelineno-22-102"></a>        <span class="n">tot_kld</span> <span class="o">+=</span> <span class="n">kld_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-22-103" name="__codelineno-22-103"></a>        <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<a id="__codelineno-22-104" name="__codelineno-22-104"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-22-105" name="__codelineno-22-105"></a>    <span class="n">avg_mse</span> <span class="o">=</span> <span class="n">tot_mse</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-22-106" name="__codelineno-22-106"></a>    <span class="n">avg_kld</span> <span class="o">=</span> <span class="n">tot_kld</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-22-107" name="__codelineno-22-107"></a>    <span class="n">metrics</span><span class="p">[</span><span class="s2">"Total loss"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">)</span>
<a id="__codelineno-22-108" name="__codelineno-22-108"></a>    <span class="n">metrics</span><span class="p">[</span><span class="s2">"MSE loss"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_mse</span><span class="p">)</span>
<a id="__codelineno-22-109" name="__codelineno-22-109"></a>    <span class="n">metrics</span><span class="p">[</span><span class="s2">"KLD loss"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_kld</span><span class="p">)</span>
<a id="__codelineno-22-110" name="__codelineno-22-110"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'====&gt; Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1"> Average MSE loss:</span><span class="si">{</span><span class="n">avg_mse</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, KLD loss:</span><span class="si">{</span><span class="n">avg_kld</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, total loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<a id="__codelineno-22-111" name="__codelineno-22-111"></a>
<a id="__codelineno-22-112" name="__codelineno-22-112"></a><span class="c1"># --- 5. 生成函数  ---</span>
<a id="__codelineno-22-113" name="__codelineno-22-113"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_and_save_images</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
<a id="__codelineno-22-114" name="__codelineno-22-114"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-22-115" name="__codelineno-22-115"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-22-116" name="__codelineno-22-116"></a>        <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">"LATENT_DIM"</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-22-117" name="__codelineno-22-117"></a>        <span class="n">generated_images</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-22-118" name="__codelineno-22-118"></a>        <span class="n">grid</span> <span class="o">=</span> <span class="n">make_grid</span><span class="p">(</span><span class="n">generated_images</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-22-119" name="__codelineno-22-119"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-22-120" name="__codelineno-22-120"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-22-121" name="__codelineno-22-121"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<a id="__codelineno-22-122" name="__codelineno-22-122"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Generated Images from VAE"</span><span class="p">)</span>
<a id="__codelineno-22-123" name="__codelineno-22-123"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
<a id="__codelineno-22-124" name="__codelineno-22-124"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-22-125" name="__codelineno-22-125"></a>
<a id="__codelineno-22-126" name="__codelineno-22-126"></a><span class="c1"># --- 6. 训练指标绘图 ---</span>
<a id="__codelineno-22-127" name="__codelineno-22-127"></a><span class="k">def</span><span class="w"> </span><span class="nf">loss_visualization</span><span class="p">():</span>
<a id="__codelineno-22-128" name="__codelineno-22-128"></a>    <span class="c1"># 训练完成后绘制指标图表</span>
<a id="__codelineno-22-129" name="__codelineno-22-129"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a id="__codelineno-22-130" name="__codelineno-22-130"></a>
<a id="__codelineno-22-131" name="__codelineno-22-131"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'MSE loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'MSE Loss'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
<a id="__codelineno-22-132" name="__codelineno-22-132"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'KLD loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'KL Divergence Loss'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">)</span>
<a id="__codelineno-22-133" name="__codelineno-22-133"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">'Total loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Total Loss'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'green'</span><span class="p">)</span>
<a id="__codelineno-22-134" name="__codelineno-22-134"></a>
<a id="__codelineno-22-135" name="__codelineno-22-135"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">'MSE, KLD and total Loss, beta = </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">"BETA"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<a id="__codelineno-22-136" name="__codelineno-22-136"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Epoch'</span><span class="p">)</span>
<a id="__codelineno-22-137" name="__codelineno-22-137"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Loss'</span><span class="p">)</span>
<a id="__codelineno-22-138" name="__codelineno-22-138"></a>
<a id="__codelineno-22-139" name="__codelineno-22-139"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-22-140" name="__codelineno-22-140"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-22-141" name="__codelineno-22-141"></a>
<a id="__codelineno-22-142" name="__codelineno-22-142"></a><span class="c1"># --- 主程序 ---</span>
<a id="__codelineno-22-143" name="__codelineno-22-143"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-22-144" name="__codelineno-22-144"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">VAE</span><span class="p">(</span><span class="n">latent_dim</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LATENT_DIM"</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-22-145" name="__codelineno-22-145"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LR"</span><span class="p">])</span>
<a id="__codelineno-22-146" name="__codelineno-22-146"></a>
<a id="__codelineno-22-147" name="__codelineno-22-147"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"--- Training VAE Model ---"</span><span class="p">)</span>
<a id="__codelineno-22-148" name="__codelineno-22-148"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"EPOCHS"</span><span class="p">]):</span>
<a id="__codelineno-22-149" name="__codelineno-22-149"></a>        <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
<a id="__codelineno-22-150" name="__codelineno-22-150"></a>
<a id="__codelineno-22-151" name="__codelineno-22-151"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Generating Images from Trained VAE ---"</span><span class="p">)</span>
<a id="__codelineno-22-152" name="__codelineno-22-152"></a>    <span class="n">gen_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"generated_images.png"</span><span class="p">)</span>
<a id="__codelineno-22-153" name="__codelineno-22-153"></a>    <span class="n">generate_and_save_images</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">gen_save_path</span><span class="p">)</span>
<a id="__codelineno-22-154" name="__codelineno-22-154"></a>    <span class="n">loss_visualization</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<p>这是 VAE 的总的架构，这里把 KL 取了个负号所以最后是加法：</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef conv fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;
    classDef latent fill:#313244,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;
    classDef loss fill:#313244,stroke:#f2cdcd,stroke-width:2px,color:#cdd6f4;

    %% Input
    subgraph InputGraph["Input"]
        A[("Image&lt;br&gt;3@64x64")]
    end
    class InputGraph input;

    %% Encoder
    subgraph Encoder["Encoder"]
        B["Feature Extractor&lt;br&gt;map: 3@64x64→latent dim"]
    end
    A --&gt; B
    class Encoder conv;

    %% Latent Space Distribution
    subgraph LatentDistribution["Latent Distribution"]
        mu["μ &lt;br&gt;latent dim"]
        logvar["log(σ²)&lt;br&gt;latent dim"]
    end
    B --&gt;|latent dim vector| mu
    B --&gt;|latent dim vector| logvar
    class LatentDistribution latent;

    %% Reparameterization Trick
    subgraph ReparamTrick["Reparameterization"]
        C["z = μ + ε * σ&lt;br&gt;ε~N(0,I)"]
    end
    mu --&gt; C
    logvar --&gt; C
    class ReparamTrick latent;

    %% Decoder
    subgraph Decoder["Decoder"]
        D["Latent vector decoder"]
    end
    C --&gt; |sample vector z&lt;br&gt;latent dim| D
    class Decoder conv;

    %% Output
    subgraph OutputGraph["Output"]
        E[("Reconstructed Image&lt;br&gt;3@64x64")]
    end
    D --&gt; E
    class OutputGraph output;

    %% Loss Calculation
    subgraph LossCalc["Loss Calculation"]
        L["Loss = MSE + β * KLD"]
        M["MSE"]
        N["KLD"]
    end
    E --&gt; |Reconstruction| M
    A --&gt; |Original| M
    mu --&gt; |Distribution| N
    logvar --&gt; |Distribution| N
    M --&gt; L
    N --&gt; L
    class LossCalc loss;</code></pre>
<p>其中，编码器使用三层的卷积神经网络，并使用了池化来缩小特征图，这也是“糊”的一部分原因，在后面的 GAN 复现中，我们采用了全卷积的架构，因为缩小特征图必不一定非要池化，还可以改变步长。下面是编码器的具体架构：</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef latent fill:#313244,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;
    classDef fc fill:#313244,stroke:#cba6f7,stroke-width:2px,color:#cdd6f4;
    classDef convBlock fill:#1e1e2e,stroke:#89dceb,stroke-width:1px,color:#89dceb;

    %% Input
    Input[("Input Image&lt;br&gt;3@64x64")]
    class Input input;

    %% Encoder Block 1
    subgraph EncoderBlock1 ["Encoder Block 1"]
        direction LR
        Conv1["Conv2d &lt;br&gt; 3x64 x 3x3 /1"]
        BN1["BatchNorm2d&lt;br&gt;64"]
        ReLU1["ReLU"]
        Pool1["MaxPool2d&lt;br&gt;2x2 /2"]
        Conv1 --&gt; BN1 --&gt; ReLU1 --&gt; Pool1
    end

    %% Encoder Block 2
    subgraph EncoderBlock2 ["Encoder Block 2"]
        direction LR
        Conv2["Conv2d &lt;br&gt; 64x128 x 3x3 /1"]
        BN2["BatchNorm2d&lt;br&gt;128"]
        ReLU2["ReLU"]
        Pool2["MaxPool2d&lt;br&gt;2x2 /2"]
        Conv2 --&gt; BN2 --&gt; ReLU2 --&gt; Pool2
    end

    %% Encoder Block 3
    subgraph EncoderBlock3 ["Encoder Block 3"]
        direction LR
        Conv3["Conv2d &lt;br&gt; 128x256 x 3x3 /1"]
        BN3["BatchNorm2d&lt;br&gt;256"]
        ReLU3["ReLU"]
        Pool3["MaxPool2d&lt;br&gt;2x2 /2"]
        Conv3 --&gt; BN3 --&gt; ReLU3 --&gt; Pool3
    end

    %% Flatten and FC layers
    Flatten["Flatten"]
    FC_mu["Linear&lt;br&gt;16384 x latent dim"]
    FC_logvar["Linear&lt;br&gt;16384 x latent dim"]

    %% Outputs
    mu["μ&lt;br&gt;latent dim"]
    logvar["log(σ²)&lt;br&gt;latent dim"]

    %% Connections
    Input --&gt; EncoderBlock1
    EncoderBlock1 --&gt; |64 @ 32x32| EncoderBlock2
    EncoderBlock2 --&gt; |128 @ 16x16| EncoderBlock3
    EncoderBlock3 --&gt; |256 @ 8x8| Flatten
    Flatten --&gt; |16384| FC_mu --&gt; mu
    Flatten --&gt; |16384| FC_logvar --&gt; logvar

    %% Styling
    class EncoderBlock1,EncoderBlock2,EncoderBlock3 convBlock;
    class FC_mu,FC_logvar fc;
    class mu,logvar latent;</code></pre>
<p>解码器和编码器的配置基本上一致，只不过使用了反卷积。</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef fc fill:#313244,stroke:#cba6f7,stroke-width:2px,color:#cdd6f4;
    classDef deconvBlock fill:#1e1e2e,stroke:#a6e3a1,stroke-width:1px,color:#a6e3a1;

    %% Input
    Input[("Sample z&lt;br&gt;latent dim")]
    class Input input;

    %% FC and Reshape
    FC_dec["Linear&lt;br&gt;latent_dim x 16384"]
    Reshape["Reshape"]

    %% Decoder Block 1
    subgraph DecoderBlock1 ["Decoder Block 1"]
        direction LR
        ConvT1["ConvTranspose2d&lt;br&gt;256x128 x 4x4 x 2"]
        BN1["BatchNorm2d"]
        ReLU1["ReLU"]
        ConvT1 --&gt; BN1 --&gt; ReLU1
    end

    %% Decoder Block 2
    subgraph DecoderBlock2 ["Decoder Block 2"]
        direction LR
        ConvT2["ConvTranspose2d&lt;br&gt;128x64 x 4x4 x 2"]
        BN2["BatchNorm2d"]
        ReLU2["ReLU"]
        ConvT2 --&gt; BN2 --&gt; ReLU2
    end

    %% Final Conv and Activation
    ConvT3["ConvTranspose2d&lt;br&gt;64x3 x 4x4 x 2"]
    Tanh["Tanh"]

    %% Output
    Output[("Reconstructed Image&lt;br&gt;3@64x64")]

    %% Connections
    Input --&gt; FC_dec
    FC_dec --&gt; |16384| Reshape
    Reshape --&gt; |256 @ 8x8| DecoderBlock1
    DecoderBlock1 --&gt; |128 @ 16x16| DecoderBlock2
    DecoderBlock2 --&gt; |64 @ 32x32| ConvT3
    ConvT3 --&gt; Tanh --&gt; Output

    %% Styling
    class FC_dec fc;
    class DecoderBlock1,DecoderBlock2 deconvBlock;
    class Output output;</code></pre>
<p>经过一段时间的等待之后，就可以看到生成的图像了，有的还是挺像模像样的。让我们调整 β 多试几次：</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;">β = 1.5</th>
<th style="text-align: center;">β = 1</th>
<th style="text-align: center;">β = 0.5</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">生成图像</td>
<td style="text-align: center;"><img alt="alt text" src="../image-2.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-4.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-6.png"/></td>
</tr>
<tr>
<td style="text-align: center;">损失变化</td>
<td style="text-align: center;"><img alt="alt text" src="../image-3.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-5.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-7.png"/></td>
</tr>
</tbody>
</table>
<p>可以看到其实 MSE 和 KLD 是按下葫芦浮起瓢的关系，因为 MSE 对应解码器的重构误差，KLD 对应编码器的建模误差，因此两边都能得到有效的训练。</p>
<p>对比 β = 1.5 的情况，β = 1 时确实有一点点更清晰了，但是图片更脏了。网上很多讨论说降低 β 可以提升清晰度，其实这并不一定对。事实上我降低了 β 貌似可以进一步改善 MSE 损失提升重建相似度，但其实在这个训练数据下 MSE 损失相比于 KLD 损失更容易下降，所以可以看到 β = 1 相比 β = 1.5，MSE 虽然略有下降但是 KLD 涨了一大截。而 β = 0.5 的时候，KLD 直接就翻倍了。</p>
<p>可以看到，当 β 比较大的时候，图像倒是有鼻子有眼，就是很糊；β 比较小，图像又开始脏起来了，变得不可名状。</p>
<p>我们思考 β 的作用：β 可以衡量输出图像的方差，β 越大则 KL 散度项占比越大，这就对应增大重构误差的方差估计，也就是说大 β 会让编码器的输出尽可能平滑，从而导致图像能够找到所有人脸的共同特征，但是没法生成具体的精细特征，简单说就是糊；而小 β 对应的就是不那么糊的图片，但是一直被重构误差牵着走，虽然重构误差小能够让图像更清晰，但却也没法对输入进行特别有效的编码，从而导致特征混起来了，输出就会比较脏。</p>
<p>所以说朴素的 VAE 糊，主要还是因为这些原因：</p>
<ul>
<li>对隐变量、编码器和解码器的建模太武断，既然为了推导使用了正态分布，就要吃这个带来的后果。</li>
<li>压缩太严重。建模时极其容易平滑掉图像的高频信息。</li>
</ul>
<p>介绍了 VAE 的本门功夫——图像生成之后，我们来看看怎么拿 VAE 进行邪修，也就是做图像分类。</p>
<h3 id="_3">无监督聚类<a class="headerlink" href="#_3" title="Permanent link">¶</a></h3>
<p>第一个想法相当自然，既然我们使用隐变量分布 <span class="arithmatex">\(q(z)\)</span> 来对原有图像做压缩之后的表征，那么我们只需要对每一个输入 <span class="arithmatex">\(x\)</span>，计算其对应的隐变量分布 <span class="arithmatex">\(q(z)\)</span> 的均值 <span class="arithmatex">\(\mu\)</span>，就可以将输入压缩到隐空间内。按理说，这个空间是提取了 <span class="arithmatex">\(x\)</span> 的特征信息的，因此在这个空间里面做无监督的聚类，就可以进行分类了。</p>
<p>具体而言，我们使用 K-means 作为聚类手段，对每个类别进行投票，得票最高的标签代表本类别的标签。最后，对得到的隐空间做 t-SNE 可视化。下面是结果：</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align: center;">β = 0.1</th>
<th style="text-align: center;">β = 1</th>
<th style="text-align: center;">β = 10</th>
</tr>
</thead>
<tbody>
<tr>
<td>准确率</td>
<td style="text-align: center;">23.59%</td>
<td style="text-align: center;">24.64%</td>
<td style="text-align: center;">24.01%</td>
</tr>
<tr>
<td>t-SNE可视化</td>
<td style="text-align: center;"><img alt="alt text" src="../image-8.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-16.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-10.png"/></td>
</tr>
<tr>
<td>生成图像</td>
<td style="text-align: center;"><img alt="alt text" src="../image-9.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-17.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-11.png"/></td>
</tr>
</tbody>
</table>
<p>准确率大概是 24% 左右，还是很合理的，因为标签信息只占了图像语义信息的一小部分，因此聚类得到的边界基本上是多种语义特征的混合（举例：我不仅可以按物体类别聚类，还可以按照背景色调聚类，既然没有标签带来的分类惩罚，我就可以随心所欲），自然不能和标签信息完全对应。比如说，截至本文写作时间，目前最强大的开源自监督视觉模型 DINOv3 在 ImageNet 上自监督聚类的准确率也只有 75% 左右。但是加上标签信息之后，准确率就可以突飞猛进了。</p>
<p>可以看到，β 基本上对准确率没有影响，因为我们是不带标签信息完全无监督地进行训练的，但是越大的 β 可视化出来的簇越集中，这就意味着增大 KL 散度项的权重，相当有利于数据降维压缩，但是对应图像也越糊，因为这一压缩过程是不可逆的，输出也被过度平滑了。</p>
<details>
<summary> 无监督聚类 VAE 使用的代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">  1</a></span>
<span class="normal"><a href="#__codelineno-23-2">  2</a></span>
<span class="normal"><a href="#__codelineno-23-3">  3</a></span>
<span class="normal"><a href="#__codelineno-23-4">  4</a></span>
<span class="normal"><a href="#__codelineno-23-5">  5</a></span>
<span class="normal"><a href="#__codelineno-23-6">  6</a></span>
<span class="normal"><a href="#__codelineno-23-7">  7</a></span>
<span class="normal"><a href="#__codelineno-23-8">  8</a></span>
<span class="normal"><a href="#__codelineno-23-9">  9</a></span>
<span class="normal"><a href="#__codelineno-23-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-23-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-23-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-23-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-23-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-23-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-23-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-23-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-23-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-23-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-23-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-23-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-23-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-23-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-23-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-23-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-23-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-23-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-23-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-23-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-23-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-23-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-23-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-23-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-23-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-23-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-23-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-23-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-23-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-23-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-23-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-23-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-23-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-23-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-23-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-23-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-23-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-23-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-23-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-23-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-23-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-23-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-23-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-23-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-23-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-23-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-23-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-23-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-23-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-23-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-23-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-23-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-23-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-23-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-23-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-23-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-23-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-23-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-23-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-23-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-23-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-23-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-23-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-23-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-23-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-23-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-23-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-23-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-23-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-23-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-23-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-23-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-23-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-23-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-23-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-23-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-23-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-23-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-23-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-23-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-23-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-23-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-23-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-23-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-23-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-23-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-23-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-23-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-23-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-23-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-23-100">100</a></span>
<span class="normal"><a href="#__codelineno-23-101">101</a></span>
<span class="normal"><a href="#__codelineno-23-102">102</a></span>
<span class="normal"><a href="#__codelineno-23-103">103</a></span>
<span class="normal"><a href="#__codelineno-23-104">104</a></span>
<span class="normal"><a href="#__codelineno-23-105">105</a></span>
<span class="normal"><a href="#__codelineno-23-106">106</a></span>
<span class="normal"><a href="#__codelineno-23-107">107</a></span>
<span class="normal"><a href="#__codelineno-23-108">108</a></span>
<span class="normal"><a href="#__codelineno-23-109">109</a></span>
<span class="normal"><a href="#__codelineno-23-110">110</a></span>
<span class="normal"><a href="#__codelineno-23-111">111</a></span>
<span class="normal"><a href="#__codelineno-23-112">112</a></span>
<span class="normal"><a href="#__codelineno-23-113">113</a></span>
<span class="normal"><a href="#__codelineno-23-114">114</a></span>
<span class="normal"><a href="#__codelineno-23-115">115</a></span>
<span class="normal"><a href="#__codelineno-23-116">116</a></span>
<span class="normal"><a href="#__codelineno-23-117">117</a></span>
<span class="normal"><a href="#__codelineno-23-118">118</a></span>
<span class="normal"><a href="#__codelineno-23-119">119</a></span>
<span class="normal"><a href="#__codelineno-23-120">120</a></span>
<span class="normal"><a href="#__codelineno-23-121">121</a></span>
<span class="normal"><a href="#__codelineno-23-122">122</a></span>
<span class="normal"><a href="#__codelineno-23-123">123</a></span>
<span class="normal"><a href="#__codelineno-23-124">124</a></span>
<span class="normal"><a href="#__codelineno-23-125">125</a></span>
<span class="normal"><a href="#__codelineno-23-126">126</a></span>
<span class="normal"><a href="#__codelineno-23-127">127</a></span>
<span class="normal"><a href="#__codelineno-23-128">128</a></span>
<span class="normal"><a href="#__codelineno-23-129">129</a></span>
<span class="normal"><a href="#__codelineno-23-130">130</a></span>
<span class="normal"><a href="#__codelineno-23-131">131</a></span>
<span class="normal"><a href="#__codelineno-23-132">132</a></span>
<span class="normal"><a href="#__codelineno-23-133">133</a></span>
<span class="normal"><a href="#__codelineno-23-134">134</a></span>
<span class="normal"><a href="#__codelineno-23-135">135</a></span>
<span class="normal"><a href="#__codelineno-23-136">136</a></span>
<span class="normal"><a href="#__codelineno-23-137">137</a></span>
<span class="normal"><a href="#__codelineno-23-138">138</a></span>
<span class="normal"><a href="#__codelineno-23-139">139</a></span>
<span class="normal"><a href="#__codelineno-23-140">140</a></span>
<span class="normal"><a href="#__codelineno-23-141">141</a></span>
<span class="normal"><a href="#__codelineno-23-142">142</a></span>
<span class="normal"><a href="#__codelineno-23-143">143</a></span>
<span class="normal"><a href="#__codelineno-23-144">144</a></span>
<span class="normal"><a href="#__codelineno-23-145">145</a></span>
<span class="normal"><a href="#__codelineno-23-146">146</a></span>
<span class="normal"><a href="#__codelineno-23-147">147</a></span>
<span class="normal"><a href="#__codelineno-23-148">148</a></span>
<span class="normal"><a href="#__codelineno-23-149">149</a></span>
<span class="normal"><a href="#__codelineno-23-150">150</a></span>
<span class="normal"><a href="#__codelineno-23-151">151</a></span>
<span class="normal"><a href="#__codelineno-23-152">152</a></span>
<span class="normal"><a href="#__codelineno-23-153">153</a></span>
<span class="normal"><a href="#__codelineno-23-154">154</a></span>
<span class="normal"><a href="#__codelineno-23-155">155</a></span>
<span class="normal"><a href="#__codelineno-23-156">156</a></span>
<span class="normal"><a href="#__codelineno-23-157">157</a></span>
<span class="normal"><a href="#__codelineno-23-158">158</a></span>
<span class="normal"><a href="#__codelineno-23-159">159</a></span>
<span class="normal"><a href="#__codelineno-23-160">160</a></span>
<span class="normal"><a href="#__codelineno-23-161">161</a></span>
<span class="normal"><a href="#__codelineno-23-162">162</a></span>
<span class="normal"><a href="#__codelineno-23-163">163</a></span>
<span class="normal"><a href="#__codelineno-23-164">164</a></span>
<span class="normal"><a href="#__codelineno-23-165">165</a></span>
<span class="normal"><a href="#__codelineno-23-166">166</a></span>
<span class="normal"><a href="#__codelineno-23-167">167</a></span>
<span class="normal"><a href="#__codelineno-23-168">168</a></span>
<span class="normal"><a href="#__codelineno-23-169">169</a></span>
<span class="normal"><a href="#__codelineno-23-170">170</a></span>
<span class="normal"><a href="#__codelineno-23-171">171</a></span>
<span class="normal"><a href="#__codelineno-23-172">172</a></span>
<span class="normal"><a href="#__codelineno-23-173">173</a></span>
<span class="normal"><a href="#__codelineno-23-174">174</a></span>
<span class="normal"><a href="#__codelineno-23-175">175</a></span>
<span class="normal"><a href="#__codelineno-23-176">176</a></span>
<span class="normal"><a href="#__codelineno-23-177">177</a></span>
<span class="normal"><a href="#__codelineno-23-178">178</a></span>
<span class="normal"><a href="#__codelineno-23-179">179</a></span>
<span class="normal"><a href="#__codelineno-23-180">180</a></span>
<span class="normal"><a href="#__codelineno-23-181">181</a></span>
<span class="normal"><a href="#__codelineno-23-182">182</a></span>
<span class="normal"><a href="#__codelineno-23-183">183</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMeans</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">mode</span>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="c1"># --- 1. 配置参数 ---</span>
<a id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-23-18" name="__codelineno-23-18"></a>    <span class="s2">"METHOD_NAME"</span><span class="p">:</span> <span class="s2">"VAE"</span><span class="p">,</span>
<a id="__codelineno-23-19" name="__codelineno-23-19"></a>    <span class="s2">"LATENT_DIM"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-23-20" name="__codelineno-23-20"></a>    <span class="s2">"NUM_CLUSTERS"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-23-21" name="__codelineno-23-21"></a>    <span class="s2">"BATCH_SIZE"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-23-22" name="__codelineno-23-22"></a>    <span class="s2">"EPOCHS"</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-23-23" name="__codelineno-23-23"></a>    <span class="s2">"LR"</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
<a id="__codelineno-23-24" name="__codelineno-23-24"></a>    <span class="s2">"BETA"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
<a id="__codelineno-23-25" name="__codelineno-23-25"></a>    <span class="s2">"DEVICE"</span><span class="p">:</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">,</span>
<a id="__codelineno-23-26" name="__codelineno-23-26"></a>    <span class="s2">"DATA_PATH"</span><span class="p">:</span> <span class="s2">"./data"</span><span class="p">,</span>
<a id="__codelineno-23-27" name="__codelineno-23-27"></a>    <span class="s2">"OUTPUT_PATH"</span><span class="p">:</span> <span class="s2">"./output"</span>
<a id="__codelineno-23-28" name="__codelineno-23-28"></a><span class="p">}</span>
<a id="__codelineno-23-29" name="__codelineno-23-29"></a>
<a id="__codelineno-23-30" name="__codelineno-23-30"></a><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"OUTPUT_PATH"</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">"METHOD_NAME"</span><span class="p">])</span>
<a id="__codelineno-23-31" name="__codelineno-23-31"></a><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-23-32" name="__codelineno-23-32"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using device: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'DEVICE'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-23-33" name="__codelineno-23-33"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running with Beta = </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'BETA'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-23-34" name="__codelineno-23-34"></a>
<a id="__codelineno-23-35" name="__codelineno-23-35"></a><span class="c1"># --- 2. 数据加载 ---</span>
<a id="__codelineno-23-36" name="__codelineno-23-36"></a><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span>
<a id="__codelineno-23-37" name="__codelineno-23-37"></a><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"DATA_PATH"</span><span class="p">],</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-23-38" name="__codelineno-23-38"></a><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"DATA_PATH"</span><span class="p">],</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-23-39" name="__codelineno-23-39"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"BATCH_SIZE"</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-23-40" name="__codelineno-23-40"></a><span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"BATCH_SIZE"</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-23-41" name="__codelineno-23-41"></a><span class="n">classes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'plane'</span><span class="p">,</span> <span class="s1">'car'</span><span class="p">,</span> <span class="s1">'bird'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'deer'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'frog'</span><span class="p">,</span> <span class="s1">'horse'</span><span class="p">,</span> <span class="s1">'ship'</span><span class="p">,</span> <span class="s1">'truck'</span><span class="p">)</span>
<a id="__codelineno-23-42" name="__codelineno-23-42"></a>
<a id="__codelineno-23-43" name="__codelineno-23-43"></a><span class="c1"># --- 3. 模型定义: VAE ---</span>
<a id="__codelineno-23-44" name="__codelineno-23-44"></a><span class="k">class</span><span class="w"> </span><span class="nc">VAE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-23-45" name="__codelineno-23-45"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">):</span>
<a id="__codelineno-23-46" name="__codelineno-23-46"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">VAE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-23-47" name="__codelineno-23-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span> <span class="o">=</span> <span class="n">latent_dim</span>
<a id="__codelineno-23-48" name="__codelineno-23-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_features</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-23-49" name="__codelineno-23-49"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-23-50" name="__codelineno-23-50"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-23-51" name="__codelineno-23-51"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-23-52" name="__codelineno-23-52"></a>        <span class="p">)</span>
<a id="__codelineno-23-53" name="__codelineno-23-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_mu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">)</span>
<a id="__codelineno-23-54" name="__codelineno-23-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_log_var</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">)</span>
<a id="__codelineno-23-55" name="__codelineno-23-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">latent_dim</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-23-56" name="__codelineno-23-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-23-57" name="__codelineno-23-57"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-23-58" name="__codelineno-23-58"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-23-59" name="__codelineno-23-59"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
<a id="__codelineno-23-60" name="__codelineno-23-60"></a>        <span class="p">)</span>
<a id="__codelineno-23-61" name="__codelineno-23-61"></a>
<a id="__codelineno-23-62" name="__codelineno-23-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-23-63" name="__codelineno-23-63"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-23-64" name="__codelineno-23-64"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-23-65" name="__codelineno-23-65"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_mu</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_log_var</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-23-66" name="__codelineno-23-66"></a>
<a id="__codelineno-23-67" name="__codelineno-23-67"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reparameterize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">):</span>
<a id="__codelineno-23-68" name="__codelineno-23-68"></a>        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-23-69" name="__codelineno-23-69"></a>        <span class="n">eps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
<a id="__codelineno-23-70" name="__codelineno-23-70"></a>        <span class="k">return</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">std</span>
<a id="__codelineno-23-71" name="__codelineno-23-71"></a>
<a id="__codelineno-23-72" name="__codelineno-23-72"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<a id="__codelineno-23-73" name="__codelineno-23-73"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_fc</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<a id="__codelineno-23-74" name="__codelineno-23-74"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-23-75" name="__codelineno-23-75"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_conv</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-23-76" name="__codelineno-23-76"></a>
<a id="__codelineno-23-77" name="__codelineno-23-77"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-23-78" name="__codelineno-23-78"></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-23-79" name="__codelineno-23-79"></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparameterize</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-23-80" name="__codelineno-23-80"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span>
<a id="__codelineno-23-81" name="__codelineno-23-81"></a>
<a id="__codelineno-23-82" name="__codelineno-23-82"></a><span class="c1"># --- 4. 损失函数 ---</span>
<a id="__codelineno-23-83" name="__codelineno-23-83"></a><span class="k">def</span><span class="w"> </span><span class="nf">vae_loss_function</span><span class="p">(</span><span class="n">recon_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">):</span>
<a id="__codelineno-23-84" name="__codelineno-23-84"></a>    <span class="n">MSE</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">recon_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">'sum'</span><span class="p">)</span>
<a id="__codelineno-23-85" name="__codelineno-23-85"></a>    <span class="n">KLD</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">log_var</span> <span class="o">-</span> <span class="n">mu</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_var</span><span class="o">.</span><span class="n">exp</span><span class="p">())</span>
<a id="__codelineno-23-86" name="__codelineno-23-86"></a>    <span class="k">return</span> <span class="n">MSE</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"BETA"</span><span class="p">]</span> <span class="o">*</span> <span class="n">KLD</span> 
<a id="__codelineno-23-87" name="__codelineno-23-87"></a>
<a id="__codelineno-23-88" name="__codelineno-23-88"></a><span class="c1"># --- 5. 训练循环 ---</span>
<a id="__codelineno-23-89" name="__codelineno-23-89"></a><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<a id="__codelineno-23-90" name="__codelineno-23-90"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-23-91" name="__codelineno-23-91"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-23-92" name="__codelineno-23-92"></a>    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'EPOCHS'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-23-93" name="__codelineno-23-93"></a>    <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-23-94" name="__codelineno-23-94"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-23-95" name="__codelineno-23-95"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-23-96" name="__codelineno-23-96"></a>        <span class="n">recon_batch</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-23-97" name="__codelineno-23-97"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">vae_loss_function</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-23-98" name="__codelineno-23-98"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-23-99" name="__codelineno-23-99"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-23-100" name="__codelineno-23-100"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-23-101" name="__codelineno-23-101"></a>        <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<a id="__codelineno-23-102" name="__codelineno-23-102"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-23-103" name="__codelineno-23-103"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'====&gt; Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1"> Average loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<a id="__codelineno-23-104" name="__codelineno-23-104"></a>
<a id="__codelineno-23-105" name="__codelineno-23-105"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_and_show_accuracy</span><span class="p">(</span><span class="n">cluster_labels</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">):</span>
<a id="__codelineno-23-106" name="__codelineno-23-106"></a>    <span class="n">cluster_map</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-23-107" name="__codelineno-23-107"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLUSTERS"</span><span class="p">]):</span>
<a id="__codelineno-23-108" name="__codelineno-23-108"></a>        <span class="n">labels_in_cluster</span> <span class="o">=</span> <span class="n">true_labels</span><span class="p">[</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
<a id="__codelineno-23-109" name="__codelineno-23-109"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_in_cluster</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-23-110" name="__codelineno-23-110"></a>            <span class="n">cluster_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
<a id="__codelineno-23-111" name="__codelineno-23-111"></a>            <span class="k">continue</span>
<a id="__codelineno-23-112" name="__codelineno-23-112"></a>        <span class="n">most_common_label</span> <span class="o">=</span> <span class="n">mode</span><span class="p">(</span><span class="n">labels_in_cluster</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-23-113" name="__codelineno-23-113"></a>        <span class="n">cluster_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">most_common_label</span>
<a id="__codelineno-23-114" name="__codelineno-23-114"></a>    <span class="n">predicted_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cluster_map</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cluster_labels</span><span class="p">])</span>
<a id="__codelineno-23-115" name="__codelineno-23-115"></a>    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predicted_labels</span> <span class="o">==</span> <span class="n">true_labels</span><span class="p">)</span>
<a id="__codelineno-23-116" name="__codelineno-23-116"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Clustering Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
<a id="__codelineno-23-117" name="__codelineno-23-117"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Cluster to Label Mapping:"</span><span class="p">)</span>
<a id="__codelineno-23-118" name="__codelineno-23-118"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLUSTERS"</span><span class="p">]):</span>
<a id="__codelineno-23-119" name="__codelineno-23-119"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Cluster </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> -&gt; '</span><span class="si">{</span><span class="n">classes</span><span class="p">[</span><span class="n">cluster_map</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<a id="__codelineno-23-120" name="__codelineno-23-120"></a>    <span class="k">return</span> <span class="n">cluster_map</span>
<a id="__codelineno-23-121" name="__codelineno-23-121"></a>
<a id="__codelineno-23-122" name="__codelineno-23-122"></a><span class="k">def</span><span class="w"> </span><span class="nf">cluster_and_visualize_kmeans</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
<a id="__codelineno-23-123" name="__codelineno-23-123"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-23-124" name="__codelineno-23-124"></a>    <span class="n">all_latents</span><span class="p">,</span> <span class="n">all_true_labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-23-125" name="__codelineno-23-125"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-23-126" name="__codelineno-23-126"></a>        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Encoding data for clustering"</span><span class="p">):</span>
<a id="__codelineno-23-127" name="__codelineno-23-127"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-23-128" name="__codelineno-23-128"></a>            <span class="n">mu</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-23-129" name="__codelineno-23-129"></a>            <span class="n">all_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a id="__codelineno-23-130" name="__codelineno-23-130"></a>            <span class="n">all_true_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a id="__codelineno-23-131" name="__codelineno-23-131"></a>    <span class="n">all_latents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_latents</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-23-132" name="__codelineno-23-132"></a>    <span class="n">all_true_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_true_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-23-133" name="__codelineno-23-133"></a>
<a id="__codelineno-23-134" name="__codelineno-23-134"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"Performing K-Means clustering..."</span><span class="p">)</span>
<a id="__codelineno-23-135" name="__codelineno-23-135"></a>    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLUSTERS"</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">)</span>
<a id="__codelineno-23-136" name="__codelineno-23-136"></a>    <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">all_latents</span><span class="p">)</span>
<a id="__codelineno-23-137" name="__codelineno-23-137"></a>    <span class="n">cluster_map</span> <span class="o">=</span> <span class="n">calculate_and_show_accuracy</span><span class="p">(</span><span class="n">cluster_labels</span><span class="p">,</span> <span class="n">all_true_labels</span><span class="p">)</span>
<a id="__codelineno-23-138" name="__codelineno-23-138"></a>
<a id="__codelineno-23-139" name="__codelineno-23-139"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"Performing t-SNE..."</span><span class="p">)</span>
<a id="__codelineno-23-140" name="__codelineno-23-140"></a>    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<a id="__codelineno-23-141" name="__codelineno-23-141"></a>    <span class="n">latents_2d</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">all_latents</span><span class="p">)</span>
<a id="__codelineno-23-142" name="__codelineno-23-142"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<a id="__codelineno-23-143" name="__codelineno-23-143"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">latents_2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">latents_2d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">cluster_labels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'tab10'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-23-144" name="__codelineno-23-144"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'VAE + K-Means Clustering Visualization'</span><span class="p">)</span>
<a id="__codelineno-23-145" name="__codelineno-23-145"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"cluster_visualization.png"</span><span class="p">))</span>
<a id="__codelineno-23-146" name="__codelineno-23-146"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-23-147" name="__codelineno-23-147"></a>    <span class="k">return</span> <span class="n">kmeans</span><span class="p">,</span> <span class="n">cluster_map</span>
<a id="__codelineno-23-148" name="__codelineno-23-148"></a>
<a id="__codelineno-23-149" name="__codelineno-23-149"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_labeled_images_kmeans</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">kmeans</span><span class="p">,</span> <span class="n">cluster_map</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-23-150" name="__codelineno-23-150"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-23-151" name="__codelineno-23-151"></a>    <span class="n">centers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-23-152" name="__codelineno-23-152"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLUSTERS"</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a id="__codelineno-23-153" name="__codelineno-23-153"></a>    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"Generated Samples per Cluster"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-23-154" name="__codelineno-23-154"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-23-155" name="__codelineno-23-155"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLUSTERS"</span><span class="p">]):</span>
<a id="__codelineno-23-156" name="__codelineno-23-156"></a>            <span class="n">center_i</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-23-157" name="__codelineno-23-157"></a>            <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">center_i</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
<a id="__codelineno-23-158" name="__codelineno-23-158"></a>            <span class="n">samples</span> <span class="o">=</span> <span class="n">center_i</span> <span class="o">+</span> <span class="n">noise</span>
<a id="__codelineno-23-159" name="__codelineno-23-159"></a>            <span class="n">generated_images</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-23-160" name="__codelineno-23-160"></a>            <span class="n">label_name</span> <span class="o">=</span> <span class="n">classes</span><span class="p">[</span><span class="n">cluster_map</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
<a id="__codelineno-23-161" name="__codelineno-23-161"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cluster </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s2"> -&gt; '</span><span class="si">{</span><span class="n">label_name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<a id="__codelineno-23-162" name="__codelineno-23-162"></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
<a id="__codelineno-23-163" name="__codelineno-23-163"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">generated_images</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-23-164" name="__codelineno-23-164"></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-23-165" name="__codelineno-23-165"></a>                <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<a id="__codelineno-23-166" name="__codelineno-23-166"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
<a id="__codelineno-23-167" name="__codelineno-23-167"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
<a id="__codelineno-23-168" name="__codelineno-23-168"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-23-169" name="__codelineno-23-169"></a>
<a id="__codelineno-23-170" name="__codelineno-23-170"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-23-171" name="__codelineno-23-171"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">VAE</span><span class="p">(</span><span class="n">latent_dim</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LATENT_DIM"</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-23-172" name="__codelineno-23-172"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LR"</span><span class="p">])</span>
<a id="__codelineno-23-173" name="__codelineno-23-173"></a>
<a id="__codelineno-23-174" name="__codelineno-23-174"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"--- Training VAE Model ---"</span><span class="p">)</span>
<a id="__codelineno-23-175" name="__codelineno-23-175"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"EPOCHS"</span><span class="p">]):</span>
<a id="__codelineno-23-176" name="__codelineno-23-176"></a>        <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
<a id="__codelineno-23-177" name="__codelineno-23-177"></a>
<a id="__codelineno-23-178" name="__codelineno-23-178"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Clustering, Visualization, and Accuracy ---"</span><span class="p">)</span>
<a id="__codelineno-23-179" name="__codelineno-23-179"></a>    <span class="n">kmeans_model</span><span class="p">,</span> <span class="n">cluster_to_label_map</span> <span class="o">=</span> <span class="n">cluster_and_visualize_kmeans</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
<a id="__codelineno-23-180" name="__codelineno-23-180"></a>
<a id="__codelineno-23-181" name="__codelineno-23-181"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Generating Labeled Images ---"</span><span class="p">)</span>
<a id="__codelineno-23-182" name="__codelineno-23-182"></a>    <span class="n">gen_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"generated_labeled_images.png"</span><span class="p">)</span>
<a id="__codelineno-23-183" name="__codelineno-23-183"></a>    <span class="n">generate_labeled_images_kmeans</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">kmeans_model</span><span class="p">,</span> <span class="n">cluster_to_label_map</span><span class="p">,</span> <span class="n">gen_save_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h3 id="cvae">CVAE<a class="headerlink" href="#cvae" title="Permanent link">¶</a></h3>
<p>CVAE 即条件 VAE。CVAE 的目标本不是解决分类任务，而是利用标签来限定生成。这是本系列博客中，我们接触到的第一个文生图（T2I）模型。为此，首先需要输入带标签的训练数据——这个简单，只需要提取输入特征之后，拼接上标签向量即可，然后压缩到 <span class="arithmatex">\(\mu\)</span> 和 <span class="arithmatex">\(\sigma\)</span> 的分布上。然后解码器部分，对隐变量 <span class="arithmatex">\(z\)</span> 也拼接上标签向量。就完了。</p>
<p>为何？我们最开始是对隐变量 <span class="arithmatex">\(z\)</span> 进行随机采样的，这就意味着 <span class="arithmatex">\(z\)</span> 不带有任何标签信息，如果我们给它加上标签信息，也就是说，我们给定标签 <span class="arithmatex">\(y\)</span>，要重建的是基于这个标签的条件分布 <span class="arithmatex">\(q(z|y)\)</span>。对于编码器而言，因为标签 <span class="arithmatex">\(y\)</span> 已知，所以直接利用联合条件分布 <span class="arithmatex">\(p(z|x,y)\)</span> 来压缩到 <span class="arithmatex">\(z\)</span> 上，而对解码器而言，也是一个联合的条件分布 <span class="arithmatex">\(q(x|z,y)\)</span> 来从隐变量的条件分布来输出服从标签的条件分布。也就是下面的 <span class="arithmatex">\(ELBO\)</span>。</p>
<div class="arithmatex">\[
\begin{align*}
  ELBO&amp;=\mathbb E_{z\sim p(z|x)}[\log q(x|z,y)]-\beta KL(p(z|x,y) || q(z|y))
\end{align*}
\]</div>
<p>而分类方案就是对单个样本取所有标签，计算损失最小的那一个。</p>
<p>CVAE 利用标签的效率好不好呢？让我们看看下面的结果。</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align: center;">β = 0.1</th>
<th style="text-align: center;">β = 1</th>
<th style="text-align: center;">β = 10</th>
</tr>
</thead>
<tbody>
<tr>
<td>准确率变化</td>
<td style="text-align: center;"><img alt="alt text" src="../image-22.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-18.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-12.png"/></td>
</tr>
<tr>
<td>生成图像</td>
<td style="text-align: center;"><img alt="alt text" src="../image-23.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-19.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-13.png"/></td>
</tr>
</tbody>
</table>
<p>可以看到不管 β 调多少，基本上只能比随机基线的 10% 高一丢丢，说明标签在其中的贡献相当小！这说明模型基本上忽略了条件信息，基本上没有将其参与进图像重构中。换句话说，就是原来的 VAE 提供的信息和损失已经足够丰富，使得模型可以基本上直接无视分类的条件。事实上，这就是 VAE 的一个缺陷——当解码器过于强大，它会直接无视隐变量提供的信息来生成（类似于编码器退化掉，解码器变成 GAN 的生成器而重构误差项就是判别器），这被称作<strong>后验崩塌</strong>。</p>
<p>VQ-VAE 可以缓解这一问题。由于这不是本文的主题，仅在此简单介绍：VQ-VAE 抛弃了对隐空间 <span class="arithmatex">\(q(z)\)</span> 的过强的正态分布假设，它过度平滑，因此考虑使用一个 <code>d @ m x m</code> 的张量（被称作码表），或者说是 <span class="arithmatex">\(m \times m\)</span> 个排成矩阵的 <span class="arithmatex">\(d\)</span> 维向量，来对隐空间做离散的建模，这样，CNN 输出的特征图 <span class="arithmatex">\(z\)</span> 就可以和这个张量做映射，具体而言是抽取某个像素位置的所有通道特征得到一个 <span class="arithmatex">\(d\)</span> 维向量，然后找到之前那个张量里面和这个 <span class="arithmatex">\(d\)</span> 维向量最接近的那个 <span class="arithmatex">\(d\)</span> 维向量，进行替换，也就是用码表去近似特征。然后替换后得到的特征图 <span class="arithmatex">\(z_q\)</span> 就可以使用反卷积进行解码了。VQ-VAE 另一个创新就是在码表替换的时候，由于这一过程无法求梯度，于是作者设计了这样的损失项</p>
<div class="arithmatex">\[
\mathcal L=|x-D(z+\mathrm{sg}[z_q-z])|^2 + \gamma |z-\mathrm{sg}[z_q]|^2+\beta |z_q-\mathrm{sg}[z]|^2
\]</div>
<p>这里 <span class="arithmatex">\(\mathrm{sg}[z]\)</span> 的意思是，前向传播照常计算，反向传播丢弃梯度（stop gradient），这样前向传播的时候，就通过 <span class="arithmatex">\(z_q\)</span> 进行生成，而反向传播的时候，重构误差依靠 <span class="arithmatex">\(z\)</span> 计算梯度，而为了让梯度正常更新，又需要 <span class="arithmatex">\(z_q\)</span> 尽量接近 <span class="arithmatex">\(z\)</span>，就有了后面两项，通过参数大小来分配码表和编码器的参数更新，这就对应 VAE 里面的 KLD，只不过这次我们没有强制对齐到正态分布了。</p>
<p>这里跑题挺远，扯回正题，下面是代码：</p>
<details>
<summary> CVAE 的代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">  1</a></span>
<span class="normal"><a href="#__codelineno-24-2">  2</a></span>
<span class="normal"><a href="#__codelineno-24-3">  3</a></span>
<span class="normal"><a href="#__codelineno-24-4">  4</a></span>
<span class="normal"><a href="#__codelineno-24-5">  5</a></span>
<span class="normal"><a href="#__codelineno-24-6">  6</a></span>
<span class="normal"><a href="#__codelineno-24-7">  7</a></span>
<span class="normal"><a href="#__codelineno-24-8">  8</a></span>
<span class="normal"><a href="#__codelineno-24-9">  9</a></span>
<span class="normal"><a href="#__codelineno-24-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-24-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-24-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-24-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-24-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-24-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-24-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-24-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-24-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-24-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-24-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-24-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-24-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-24-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-24-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-24-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-24-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-24-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-24-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-24-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-24-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-24-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-24-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-24-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-24-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-24-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-24-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-24-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-24-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-24-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-24-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-24-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-24-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-24-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-24-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-24-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-24-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-24-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-24-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-24-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-24-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-24-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-24-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-24-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-24-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-24-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-24-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-24-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-24-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-24-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-24-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-24-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-24-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-24-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-24-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-24-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-24-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-24-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-24-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-24-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-24-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-24-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-24-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-24-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-24-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-24-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-24-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-24-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-24-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-24-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-24-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-24-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-24-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-24-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-24-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-24-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-24-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-24-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-24-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-24-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-24-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-24-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-24-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-24-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-24-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-24-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-24-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-24-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-24-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-24-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-24-100">100</a></span>
<span class="normal"><a href="#__codelineno-24-101">101</a></span>
<span class="normal"><a href="#__codelineno-24-102">102</a></span>
<span class="normal"><a href="#__codelineno-24-103">103</a></span>
<span class="normal"><a href="#__codelineno-24-104">104</a></span>
<span class="normal"><a href="#__codelineno-24-105">105</a></span>
<span class="normal"><a href="#__codelineno-24-106">106</a></span>
<span class="normal"><a href="#__codelineno-24-107">107</a></span>
<span class="normal"><a href="#__codelineno-24-108">108</a></span>
<span class="normal"><a href="#__codelineno-24-109">109</a></span>
<span class="normal"><a href="#__codelineno-24-110">110</a></span>
<span class="normal"><a href="#__codelineno-24-111">111</a></span>
<span class="normal"><a href="#__codelineno-24-112">112</a></span>
<span class="normal"><a href="#__codelineno-24-113">113</a></span>
<span class="normal"><a href="#__codelineno-24-114">114</a></span>
<span class="normal"><a href="#__codelineno-24-115">115</a></span>
<span class="normal"><a href="#__codelineno-24-116">116</a></span>
<span class="normal"><a href="#__codelineno-24-117">117</a></span>
<span class="normal"><a href="#__codelineno-24-118">118</a></span>
<span class="normal"><a href="#__codelineno-24-119">119</a></span>
<span class="normal"><a href="#__codelineno-24-120">120</a></span>
<span class="normal"><a href="#__codelineno-24-121">121</a></span>
<span class="normal"><a href="#__codelineno-24-122">122</a></span>
<span class="normal"><a href="#__codelineno-24-123">123</a></span>
<span class="normal"><a href="#__codelineno-24-124">124</a></span>
<span class="normal"><a href="#__codelineno-24-125">125</a></span>
<span class="normal"><a href="#__codelineno-24-126">126</a></span>
<span class="normal"><a href="#__codelineno-24-127">127</a></span>
<span class="normal"><a href="#__codelineno-24-128">128</a></span>
<span class="normal"><a href="#__codelineno-24-129">129</a></span>
<span class="normal"><a href="#__codelineno-24-130">130</a></span>
<span class="normal"><a href="#__codelineno-24-131">131</a></span>
<span class="normal"><a href="#__codelineno-24-132">132</a></span>
<span class="normal"><a href="#__codelineno-24-133">133</a></span>
<span class="normal"><a href="#__codelineno-24-134">134</a></span>
<span class="normal"><a href="#__codelineno-24-135">135</a></span>
<span class="normal"><a href="#__codelineno-24-136">136</a></span>
<span class="normal"><a href="#__codelineno-24-137">137</a></span>
<span class="normal"><a href="#__codelineno-24-138">138</a></span>
<span class="normal"><a href="#__codelineno-24-139">139</a></span>
<span class="normal"><a href="#__codelineno-24-140">140</a></span>
<span class="normal"><a href="#__codelineno-24-141">141</a></span>
<span class="normal"><a href="#__codelineno-24-142">142</a></span>
<span class="normal"><a href="#__codelineno-24-143">143</a></span>
<span class="normal"><a href="#__codelineno-24-144">144</a></span>
<span class="normal"><a href="#__codelineno-24-145">145</a></span>
<span class="normal"><a href="#__codelineno-24-146">146</a></span>
<span class="normal"><a href="#__codelineno-24-147">147</a></span>
<span class="normal"><a href="#__codelineno-24-148">148</a></span>
<span class="normal"><a href="#__codelineno-24-149">149</a></span>
<span class="normal"><a href="#__codelineno-24-150">150</a></span>
<span class="normal"><a href="#__codelineno-24-151">151</a></span>
<span class="normal"><a href="#__codelineno-24-152">152</a></span>
<span class="normal"><a href="#__codelineno-24-153">153</a></span>
<span class="normal"><a href="#__codelineno-24-154">154</a></span>
<span class="normal"><a href="#__codelineno-24-155">155</a></span>
<span class="normal"><a href="#__codelineno-24-156">156</a></span>
<span class="normal"><a href="#__codelineno-24-157">157</a></span>
<span class="normal"><a href="#__codelineno-24-158">158</a></span>
<span class="normal"><a href="#__codelineno-24-159">159</a></span>
<span class="normal"><a href="#__codelineno-24-160">160</a></span>
<span class="normal"><a href="#__codelineno-24-161">161</a></span>
<span class="normal"><a href="#__codelineno-24-162">162</a></span>
<span class="normal"><a href="#__codelineno-24-163">163</a></span>
<span class="normal"><a href="#__codelineno-24-164">164</a></span>
<span class="normal"><a href="#__codelineno-24-165">165</a></span>
<span class="normal"><a href="#__codelineno-24-166">166</a></span>
<span class="normal"><a href="#__codelineno-24-167">167</a></span>
<span class="normal"><a href="#__codelineno-24-168">168</a></span>
<span class="normal"><a href="#__codelineno-24-169">169</a></span>
<span class="normal"><a href="#__codelineno-24-170">170</a></span>
<span class="normal"><a href="#__codelineno-24-171">171</a></span>
<span class="normal"><a href="#__codelineno-24-172">172</a></span>
<span class="normal"><a href="#__codelineno-24-173">173</a></span>
<span class="normal"><a href="#__codelineno-24-174">174</a></span>
<span class="normal"><a href="#__codelineno-24-175">175</a></span>
<span class="normal"><a href="#__codelineno-24-176">176</a></span>
<span class="normal"><a href="#__codelineno-24-177">177</a></span>
<span class="normal"><a href="#__codelineno-24-178">178</a></span>
<span class="normal"><a href="#__codelineno-24-179">179</a></span>
<span class="normal"><a href="#__codelineno-24-180">180</a></span>
<span class="normal"><a href="#__codelineno-24-181">181</a></span>
<span class="normal"><a href="#__codelineno-24-182">182</a></span>
<span class="normal"><a href="#__codelineno-24-183">183</a></span>
<span class="normal"><a href="#__codelineno-24-184">184</a></span>
<span class="normal"><a href="#__codelineno-24-185">185</a></span>
<span class="normal"><a href="#__codelineno-24-186">186</a></span>
<span class="normal"><a href="#__codelineno-24-187">187</a></span>
<span class="normal"><a href="#__codelineno-24-188">188</a></span>
<span class="normal"><a href="#__codelineno-24-189">189</a></span>
<span class="normal"><a href="#__codelineno-24-190">190</a></span>
<span class="normal"><a href="#__codelineno-24-191">191</a></span>
<span class="normal"><a href="#__codelineno-24-192">192</a></span>
<span class="normal"><a href="#__codelineno-24-193">193</a></span>
<span class="normal"><a href="#__codelineno-24-194">194</a></span>
<span class="normal"><a href="#__codelineno-24-195">195</a></span>
<span class="normal"><a href="#__codelineno-24-196">196</a></span>
<span class="normal"><a href="#__codelineno-24-197">197</a></span>
<span class="normal"><a href="#__codelineno-24-198">198</a></span>
<span class="normal"><a href="#__codelineno-24-199">199</a></span>
<span class="normal"><a href="#__codelineno-24-200">200</a></span>
<span class="normal"><a href="#__codelineno-24-201">201</a></span>
<span class="normal"><a href="#__codelineno-24-202">202</a></span>
<span class="normal"><a href="#__codelineno-24-203">203</a></span>
<span class="normal"><a href="#__codelineno-24-204">204</a></span>
<span class="normal"><a href="#__codelineno-24-205">205</a></span>
<span class="normal"><a href="#__codelineno-24-206">206</a></span>
<span class="normal"><a href="#__codelineno-24-207">207</a></span>
<span class="normal"><a href="#__codelineno-24-208">208</a></span>
<span class="normal"><a href="#__codelineno-24-209">209</a></span>
<span class="normal"><a href="#__codelineno-24-210">210</a></span>
<span class="normal"><a href="#__codelineno-24-211">211</a></span>
<span class="normal"><a href="#__codelineno-24-212">212</a></span>
<span class="normal"><a href="#__codelineno-24-213">213</a></span>
<span class="normal"><a href="#__codelineno-24-214">214</a></span>
<span class="normal"><a href="#__codelineno-24-215">215</a></span>
<span class="normal"><a href="#__codelineno-24-216">216</a></span>
<span class="normal"><a href="#__codelineno-24-217">217</a></span>
<span class="normal"><a href="#__codelineno-24-218">218</a></span>
<span class="normal"><a href="#__codelineno-24-219">219</a></span>
<span class="normal"><a href="#__codelineno-24-220">220</a></span>
<span class="normal"><a href="#__codelineno-24-221">221</a></span>
<span class="normal"><a href="#__codelineno-24-222">222</a></span>
<span class="normal"><a href="#__codelineno-24-223">223</a></span>
<span class="normal"><a href="#__codelineno-24-224">224</a></span>
<span class="normal"><a href="#__codelineno-24-225">225</a></span>
<span class="normal"><a href="#__codelineno-24-226">226</a></span>
<span class="normal"><a href="#__codelineno-24-227">227</a></span>
<span class="normal"><a href="#__codelineno-24-228">228</a></span>
<span class="normal"><a href="#__codelineno-24-229">229</a></span>
<span class="normal"><a href="#__codelineno-24-230">230</a></span>
<span class="normal"><a href="#__codelineno-24-231">231</a></span>
<span class="normal"><a href="#__codelineno-24-232">232</a></span>
<span class="normal"><a href="#__codelineno-24-233">233</a></span>
<span class="normal"><a href="#__codelineno-24-234">234</a></span>
<span class="normal"><a href="#__codelineno-24-235">235</a></span>
<span class="normal"><a href="#__codelineno-24-236">236</a></span>
<span class="normal"><a href="#__codelineno-24-237">237</a></span>
<span class="normal"><a href="#__codelineno-24-238">238</a></span>
<span class="normal"><a href="#__codelineno-24-239">239</a></span>
<span class="normal"><a href="#__codelineno-24-240">240</a></span>
<span class="normal"><a href="#__codelineno-24-241">241</a></span>
<span class="normal"><a href="#__codelineno-24-242">242</a></span>
<span class="normal"><a href="#__codelineno-24-243">243</a></span>
<span class="normal"><a href="#__codelineno-24-244">244</a></span>
<span class="normal"><a href="#__codelineno-24-245">245</a></span>
<span class="normal"><a href="#__codelineno-24-246">246</a></span>
<span class="normal"><a href="#__codelineno-24-247">247</a></span>
<span class="normal"><a href="#__codelineno-24-248">248</a></span>
<span class="normal"><a href="#__codelineno-24-249">249</a></span>
<span class="normal"><a href="#__codelineno-24-250">250</a></span>
<span class="normal"><a href="#__codelineno-24-251">251</a></span>
<span class="normal"><a href="#__codelineno-24-252">252</a></span>
<span class="normal"><a href="#__codelineno-24-253">253</a></span>
<span class="normal"><a href="#__codelineno-24-254">254</a></span>
<span class="normal"><a href="#__codelineno-24-255">255</a></span>
<span class="normal"><a href="#__codelineno-24-256">256</a></span>
<span class="normal"><a href="#__codelineno-24-257">257</a></span>
<span class="normal"><a href="#__codelineno-24-258">258</a></span>
<span class="normal"><a href="#__codelineno-24-259">259</a></span>
<span class="normal"><a href="#__codelineno-24-260">260</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-24-13" name="__codelineno-24-13"></a>
<a id="__codelineno-24-14" name="__codelineno-24-14"></a><span class="c1"># --- 1. 配置参数 ---</span>
<a id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-24-16" name="__codelineno-24-16"></a>    <span class="s2">"METHOD_NAME"</span><span class="p">:</span> <span class="s2">"CVAE"</span><span class="p">,</span>
<a id="__codelineno-24-17" name="__codelineno-24-17"></a>    <span class="s2">"LATENT_DIM"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-24-18" name="__codelineno-24-18"></a>    <span class="s2">"NUM_CLASSES"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-24-19" name="__codelineno-24-19"></a>    <span class="s2">"BATCH_SIZE"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-24-20" name="__codelineno-24-20"></a>    <span class="s2">"EPOCHS"</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-24-21" name="__codelineno-24-21"></a>    <span class="s2">"LR"</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
<a id="__codelineno-24-22" name="__codelineno-24-22"></a>    <span class="s2">"BETA"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
<a id="__codelineno-24-23" name="__codelineno-24-23"></a>    <span class="s2">"DEVICE"</span><span class="p">:</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">,</span>
<a id="__codelineno-24-24" name="__codelineno-24-24"></a>    <span class="s2">"DATA_PATH"</span><span class="p">:</span> <span class="s2">"./data"</span><span class="p">,</span>
<a id="__codelineno-24-25" name="__codelineno-24-25"></a>    <span class="s2">"OUTPUT_PATH"</span><span class="p">:</span> <span class="s2">"./output"</span>
<a id="__codelineno-24-26" name="__codelineno-24-26"></a><span class="p">}</span>
<a id="__codelineno-24-27" name="__codelineno-24-27"></a>
<a id="__codelineno-24-28" name="__codelineno-24-28"></a><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"OUTPUT_PATH"</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">"METHOD_NAME"</span><span class="p">])</span>
<a id="__codelineno-24-29" name="__codelineno-24-29"></a><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-24-30" name="__codelineno-24-30"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using device: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'DEVICE'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-24-31" name="__codelineno-24-31"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running with Beta = </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'BETA'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-24-32" name="__codelineno-24-32"></a>
<a id="__codelineno-24-33" name="__codelineno-24-33"></a><span class="c1"># --- 2. 数据加载 ---</span>
<a id="__codelineno-24-34" name="__codelineno-24-34"></a><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span>
<a id="__codelineno-24-35" name="__codelineno-24-35"></a><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"DATA_PATH"</span><span class="p">],</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-24-36" name="__codelineno-24-36"></a><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"DATA_PATH"</span><span class="p">],</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-24-37" name="__codelineno-24-37"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"BATCH_SIZE"</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-24-38" name="__codelineno-24-38"></a><span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"BATCH_SIZE"</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-24-39" name="__codelineno-24-39"></a><span class="n">classes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'plane'</span><span class="p">,</span> <span class="s1">'car'</span><span class="p">,</span> <span class="s1">'bird'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'deer'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'frog'</span><span class="p">,</span> <span class="s1">'horse'</span><span class="p">,</span> <span class="s1">'ship'</span><span class="p">,</span> <span class="s1">'truck'</span><span class="p">)</span>
<a id="__codelineno-24-40" name="__codelineno-24-40"></a>
<a id="__codelineno-24-41" name="__codelineno-24-41"></a><span class="c1"># --- 3. 模型定义: CVAE ---</span>
<a id="__codelineno-24-42" name="__codelineno-24-42"></a><span class="k">class</span><span class="w"> </span><span class="nc">CVAE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-24-43" name="__codelineno-24-43"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-24-44" name="__codelineno-24-44"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">CVAE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-24-45" name="__codelineno-24-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span> <span class="o">=</span> <span class="n">latent_dim</span>
<a id="__codelineno-24-46" name="__codelineno-24-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">num_classes</span>
<a id="__codelineno-24-47" name="__codelineno-24-47"></a>
<a id="__codelineno-24-48" name="__codelineno-24-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_features</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-24-49" name="__codelineno-24-49"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-24-50" name="__codelineno-24-50"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-24-51" name="__codelineno-24-51"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-24-52" name="__codelineno-24-52"></a>        <span class="p">)</span>
<a id="__codelineno-24-53" name="__codelineno-24-53"></a>
<a id="__codelineno-24-54" name="__codelineno-24-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_mu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">)</span>
<a id="__codelineno-24-55" name="__codelineno-24-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_log_var</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">)</span>
<a id="__codelineno-24-56" name="__codelineno-24-56"></a>
<a id="__codelineno-24-57" name="__codelineno-24-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">latent_dim</span> <span class="o">+</span> <span class="n">num_classes</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-24-58" name="__codelineno-24-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-24-59" name="__codelineno-24-59"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-24-60" name="__codelineno-24-60"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-24-61" name="__codelineno-24-61"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
<a id="__codelineno-24-62" name="__codelineno-24-62"></a>        <span class="p">)</span>
<a id="__codelineno-24-63" name="__codelineno-24-63"></a>
<a id="__codelineno-24-64" name="__codelineno-24-64"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">):</span>
<a id="__codelineno-24-65" name="__codelineno-24-65"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-24-66" name="__codelineno-24-66"></a>        <span class="n">h_flat</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-67" name="__codelineno-24-67"></a>        <span class="n">h_combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">h_flat</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-68" name="__codelineno-24-68"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_mu</span><span class="p">(</span><span class="n">h_combined</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_log_var</span><span class="p">(</span><span class="n">h_combined</span><span class="p">)</span>
<a id="__codelineno-24-69" name="__codelineno-24-69"></a>
<a id="__codelineno-24-70" name="__codelineno-24-70"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reparameterize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">):</span>
<a id="__codelineno-24-71" name="__codelineno-24-71"></a>        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-24-72" name="__codelineno-24-72"></a>        <span class="n">eps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
<a id="__codelineno-24-73" name="__codelineno-24-73"></a>        <span class="k">return</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">std</span>
<a id="__codelineno-24-74" name="__codelineno-24-74"></a>
<a id="__codelineno-24-75" name="__codelineno-24-75"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">):</span>
<a id="__codelineno-24-76" name="__codelineno-24-76"></a>        <span class="n">z_combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">z</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-77" name="__codelineno-24-77"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_fc</span><span class="p">(</span><span class="n">z_combined</span><span class="p">)</span>
<a id="__codelineno-24-78" name="__codelineno-24-78"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-24-79" name="__codelineno-24-79"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_conv</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-24-80" name="__codelineno-24-80"></a>
<a id="__codelineno-24-81" name="__codelineno-24-81"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">):</span>
<a id="__codelineno-24-82" name="__codelineno-24-82"></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">)</span>
<a id="__codelineno-24-83" name="__codelineno-24-83"></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparameterize</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-24-84" name="__codelineno-24-84"></a>        <span class="n">recon_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">)</span>
<a id="__codelineno-24-85" name="__codelineno-24-85"></a>        <span class="k">return</span> <span class="n">recon_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span>
<a id="__codelineno-24-86" name="__codelineno-24-86"></a>
<a id="__codelineno-24-87" name="__codelineno-24-87"></a><span class="c1"># --- 4. 损失函数 ---</span>
<a id="__codelineno-24-88" name="__codelineno-24-88"></a><span class="k">def</span><span class="w"> </span><span class="nf">cvae_loss_function</span><span class="p">(</span><span class="n">recon_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">):</span>
<a id="__codelineno-24-89" name="__codelineno-24-89"></a>    <span class="n">MSE</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">recon_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">'sum'</span><span class="p">)</span>
<a id="__codelineno-24-90" name="__codelineno-24-90"></a>    <span class="n">KLD</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">log_var</span> <span class="o">-</span> <span class="n">mu</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_var</span><span class="o">.</span><span class="n">exp</span><span class="p">())</span>
<a id="__codelineno-24-91" name="__codelineno-24-91"></a>    <span class="k">return</span> <span class="n">MSE</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"BETA"</span><span class="p">]</span> <span class="o">*</span> <span class="n">KLD</span>
<a id="__codelineno-24-92" name="__codelineno-24-92"></a>
<a id="__codelineno-24-93" name="__codelineno-24-93"></a><span class="c1"># --- 5. 训练与测试循环 ---</span>
<a id="__codelineno-24-94" name="__codelineno-24-94"></a><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<a id="__codelineno-24-95" name="__codelineno-24-95"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-24-96" name="__codelineno-24-96"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-24-97" name="__codelineno-24-97"></a>    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Train Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'EPOCHS'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-24-98" name="__codelineno-24-98"></a>    <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-24-99" name="__codelineno-24-99"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-24-100" name="__codelineno-24-100"></a>        <span class="n">labels_onehot</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-24-101" name="__codelineno-24-101"></a>
<a id="__codelineno-24-102" name="__codelineno-24-102"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-24-103" name="__codelineno-24-103"></a>        <span class="n">recon_batch</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_onehot</span><span class="p">)</span>
<a id="__codelineno-24-104" name="__codelineno-24-104"></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">cvae_loss_function</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-24-105" name="__codelineno-24-105"></a>        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-24-106" name="__codelineno-24-106"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-24-107" name="__codelineno-24-107"></a>
<a id="__codelineno-24-108" name="__codelineno-24-108"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-24-109" name="__codelineno-24-109"></a>        <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<a id="__codelineno-24-110" name="__codelineno-24-110"></a>
<a id="__codelineno-24-111" name="__codelineno-24-111"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-24-112" name="__codelineno-24-112"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'====&gt; Train Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1"> | Avg Loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<a id="__codelineno-24-113" name="__codelineno-24-113"></a>    <span class="k">return</span> <span class="n">avg_loss</span>
<a id="__codelineno-24-114" name="__codelineno-24-114"></a>
<a id="__codelineno-24-115" name="__codelineno-24-115"></a><span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<a id="__codelineno-24-116" name="__codelineno-24-116"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-24-117" name="__codelineno-24-117"></a>    <span class="n">test_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-24-118" name="__codelineno-24-118"></a>    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-24-119" name="__codelineno-24-119"></a>
<a id="__codelineno-24-120" name="__codelineno-24-120"></a>    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Test Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'EPOCHS'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-24-121" name="__codelineno-24-121"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-24-122" name="__codelineno-24-122"></a>        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-24-123" name="__codelineno-24-123"></a>            <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">]),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-24-124" name="__codelineno-24-124"></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-24-125" name="__codelineno-24-125"></a>
<a id="__codelineno-24-126" name="__codelineno-24-126"></a>            <span class="c1"># 存储每个样本在每个候选类别下的损失</span>
<a id="__codelineno-24-127" name="__codelineno-24-127"></a>            <span class="n">losses_per_class</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-24-128" name="__codelineno-24-128"></a>
<a id="__codelineno-24-129" name="__codelineno-24-129"></a>            <span class="c1"># 遍历所有可能的类别</span>
<a id="__codelineno-24-130" name="__codelineno-24-130"></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">]):</span>
<a id="__codelineno-24-131" name="__codelineno-24-131"></a>                <span class="c1"># 为整个batch创建同一个类别的one-hot标签</span>
<a id="__codelineno-24-132" name="__codelineno-24-132"></a>                <span class="n">class_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-24-133" name="__codelineno-24-133"></a>                <span class="n">class_onehot</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">class_labels</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-24-134" name="__codelineno-24-134"></a>
<a id="__codelineno-24-135" name="__codelineno-24-135"></a>                <span class="c1"># 计算损失</span>
<a id="__codelineno-24-136" name="__codelineno-24-136"></a>                <span class="n">recon_batch</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">class_onehot</span><span class="p">)</span>
<a id="__codelineno-24-137" name="__codelineno-24-137"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">cvae_loss_function</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-24-138" name="__codelineno-24-138"></a>
<a id="__codelineno-24-139" name="__codelineno-24-139"></a>                <span class="c1"># VAE损失是整个batch的总和，我们需要每个样本的损失</span>
<a id="__codelineno-24-140" name="__codelineno-24-140"></a>                <span class="c1"># 这里用平均损失进行近似</span>
<a id="__codelineno-24-141" name="__codelineno-24-141"></a>                <span class="n">losses_per_class</span><span class="p">[:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="n">batch_size</span>
<a id="__codelineno-24-142" name="__codelineno-24-142"></a>
<a id="__codelineno-24-143" name="__codelineno-24-143"></a>            <span class="c1"># 找到每个样本损失最小的类别作为预测结果</span>
<a id="__codelineno-24-144" name="__codelineno-24-144"></a>            <span class="n">pred</span> <span class="o">=</span> <span class="n">losses_per_class</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-145" name="__codelineno-24-145"></a>            <span class="n">correct</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-24-146" name="__codelineno-24-146"></a>
<a id="__codelineno-24-147" name="__codelineno-24-147"></a>            <span class="c1"># 计算测试损失时，我们使用真实标签</span>
<a id="__codelineno-24-148" name="__codelineno-24-148"></a>            <span class="n">true_labels_onehot</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-24-149" name="__codelineno-24-149"></a>            <span class="n">recon_true</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mu_true</span><span class="p">,</span> <span class="n">log_var_true</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">true_labels_onehot</span><span class="p">)</span>
<a id="__codelineno-24-150" name="__codelineno-24-150"></a>            <span class="n">test_loss</span> <span class="o">+=</span> <span class="n">cvae_loss_function</span><span class="p">(</span><span class="n">recon_true</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mu_true</span><span class="p">,</span> <span class="n">log_var_true</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-24-151" name="__codelineno-24-151"></a>
<a id="__codelineno-24-152" name="__codelineno-24-152"></a>            <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">acc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="mf">100.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
<a id="__codelineno-24-153" name="__codelineno-24-153"></a>
<a id="__codelineno-24-154" name="__codelineno-24-154"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">test_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-24-155" name="__codelineno-24-155"></a>    <span class="n">accuracy</span> <span class="o">=</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-24-156" name="__codelineno-24-156"></a>
<a id="__codelineno-24-157" name="__codelineno-24-157"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'====&gt; Test set | Avg Loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> | Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%'</span><span class="p">)</span>
<a id="__codelineno-24-158" name="__codelineno-24-158"></a>    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">accuracy</span>
<a id="__codelineno-24-159" name="__codelineno-24-159"></a>
<a id="__codelineno-24-160" name="__codelineno-24-160"></a>
<a id="__codelineno-24-161" name="__codelineno-24-161"></a><span class="c1"># --- 6. 可视化函数 ---</span>
<a id="__codelineno-24-162" name="__codelineno-24-162"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_latent_space</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
<a id="__codelineno-24-163" name="__codelineno-24-163"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-24-164" name="__codelineno-24-164"></a>    <span class="n">all_latents</span><span class="p">,</span> <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-24-165" name="__codelineno-24-165"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-24-166" name="__codelineno-24-166"></a>        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Encoding data for visualization"</span><span class="p">):</span>
<a id="__codelineno-24-167" name="__codelineno-24-167"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-24-168" name="__codelineno-24-168"></a>            <span class="n">labels_onehot</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-24-169" name="__codelineno-24-169"></a>            <span class="n">mu</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_onehot</span><span class="p">)</span>
<a id="__codelineno-24-170" name="__codelineno-24-170"></a>            <span class="n">all_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a id="__codelineno-24-171" name="__codelineno-24-171"></a>            <span class="n">all_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a id="__codelineno-24-172" name="__codelineno-24-172"></a>
<a id="__codelineno-24-173" name="__codelineno-24-173"></a>    <span class="n">all_latents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_latents</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-24-174" name="__codelineno-24-174"></a>    <span class="n">all_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-24-175" name="__codelineno-24-175"></a>
<a id="__codelineno-24-176" name="__codelineno-24-176"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"Performing t-SNE..."</span><span class="p">)</span>
<a id="__codelineno-24-177" name="__codelineno-24-177"></a>    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-178" name="__codelineno-24-178"></a>    <span class="n">latents_2d</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">all_latents</span><span class="p">)</span>
<a id="__codelineno-24-179" name="__codelineno-24-179"></a>
<a id="__codelineno-24-180" name="__codelineno-24-180"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-24-181" name="__codelineno-24-181"></a>    <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">latents_2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">latents_2d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'tab10'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-24-182" name="__codelineno-24-182"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-24-183" name="__codelineno-24-183"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'t-SNE of Latent Space (Colored by True Class)'</span><span class="p">)</span>
<a id="__codelineno-24-184" name="__codelineno-24-184"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"latent_space_true_labels.png"</span><span class="p">))</span>
<a id="__codelineno-24-185" name="__codelineno-24-185"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-24-186" name="__codelineno-24-186"></a>
<a id="__codelineno-24-187" name="__codelineno-24-187"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_images_by_class</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-24-188" name="__codelineno-24-188"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-24-189" name="__codelineno-24-189"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-24-190" name="__codelineno-24-190"></a>    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"Generated Samples by Class"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-24-191" name="__codelineno-24-191"></a>
<a id="__codelineno-24-192" name="__codelineno-24-192"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-24-193" name="__codelineno-24-193"></a>        <span class="k">for</span> <span class="n">class_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">]):</span>
<a id="__codelineno-24-194" name="__codelineno-24-194"></a>            <span class="n">class_onehot</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">class_idx</span><span class="p">]),</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-24-195" name="__codelineno-24-195"></a>            <span class="n">class_onehot</span> <span class="o">=</span> <span class="n">class_onehot</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-24-196" name="__codelineno-24-196"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">"LATENT_DIM"</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-24-197" name="__codelineno-24-197"></a>            <span class="n">generated_images</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">class_onehot</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-24-198" name="__codelineno-24-198"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="n">classes</span><span class="p">[</span><span class="n">class_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<a id="__codelineno-24-199" name="__codelineno-24-199"></a>            <span class="k">for</span> <span class="n">sample_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
<a id="__codelineno-24-200" name="__codelineno-24-200"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">generated_images</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-24-201" name="__codelineno-24-201"></a>                <span class="n">axes</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-24-202" name="__codelineno-24-202"></a>                <span class="n">axes</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<a id="__codelineno-24-203" name="__codelineno-24-203"></a>
<a id="__codelineno-24-204" name="__codelineno-24-204"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
<a id="__codelineno-24-205" name="__codelineno-24-205"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"generated_images_by_class.png"</span><span class="p">))</span>
<a id="__codelineno-24-206" name="__codelineno-24-206"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-24-207" name="__codelineno-24-207"></a>
<a id="__codelineno-24-208" name="__codelineno-24-208"></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_curves</span><span class="p">(</span><span class="n">train_losses</span><span class="p">,</span> <span class="n">test_losses</span><span class="p">,</span> <span class="n">test_accuracies</span><span class="p">):</span>
<a id="__codelineno-24-209" name="__codelineno-24-209"></a>    <span class="n">epochs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_losses</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-210" name="__codelineno-24-210"></a>
<a id="__codelineno-24-211" name="__codelineno-24-211"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a id="__codelineno-24-212" name="__codelineno-24-212"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-213" name="__codelineno-24-213"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">train_losses</span><span class="p">,</span> <span class="s1">'bo-'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Training Loss'</span><span class="p">)</span>
<a id="__codelineno-24-214" name="__codelineno-24-214"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">test_losses</span><span class="p">,</span> <span class="s1">'ro-'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Test Loss'</span><span class="p">)</span>
<a id="__codelineno-24-215" name="__codelineno-24-215"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Training and Test Loss'</span><span class="p">)</span>
<a id="__codelineno-24-216" name="__codelineno-24-216"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Epochs'</span><span class="p">)</span>
<a id="__codelineno-24-217" name="__codelineno-24-217"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Loss'</span><span class="p">)</span>
<a id="__codelineno-24-218" name="__codelineno-24-218"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-24-219" name="__codelineno-24-219"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-24-220" name="__codelineno-24-220"></a>
<a id="__codelineno-24-221" name="__codelineno-24-221"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-24-222" name="__codelineno-24-222"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">test_accuracies</span><span class="p">,</span> <span class="s1">'go-'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Test Accuracy'</span><span class="p">)</span>
<a id="__codelineno-24-223" name="__codelineno-24-223"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Test Accuracy'</span><span class="p">)</span>
<a id="__codelineno-24-224" name="__codelineno-24-224"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Epochs'</span><span class="p">)</span>
<a id="__codelineno-24-225" name="__codelineno-24-225"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Accuracy (%)'</span><span class="p">)</span>
<a id="__codelineno-24-226" name="__codelineno-24-226"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-24-227" name="__codelineno-24-227"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-24-228" name="__codelineno-24-228"></a>
<a id="__codelineno-24-229" name="__codelineno-24-229"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">'Training Metrics'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-24-230" name="__codelineno-24-230"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<a id="__codelineno-24-231" name="__codelineno-24-231"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"training_curves.png"</span><span class="p">))</span>
<a id="__codelineno-24-232" name="__codelineno-24-232"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-24-233" name="__codelineno-24-233"></a>
<a id="__codelineno-24-234" name="__codelineno-24-234"></a>
<a id="__codelineno-24-235" name="__codelineno-24-235"></a><span class="c1"># --- 主程序 ---</span>
<a id="__codelineno-24-236" name="__codelineno-24-236"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-24-237" name="__codelineno-24-237"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">CVAE</span><span class="p">(</span><span class="n">latent_dim</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LATENT_DIM"</span><span class="p">],</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-24-238" name="__codelineno-24-238"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LR"</span><span class="p">])</span>
<a id="__codelineno-24-239" name="__codelineno-24-239"></a>
<a id="__codelineno-24-240" name="__codelineno-24-240"></a>    <span class="n">train_losses</span><span class="p">,</span> <span class="n">test_losses</span><span class="p">,</span> <span class="n">test_accuracies</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-24-241" name="__codelineno-24-241"></a>
<a id="__codelineno-24-242" name="__codelineno-24-242"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"--- Training Pure CVAE Model for Classification ---"</span><span class="p">)</span>
<a id="__codelineno-24-243" name="__codelineno-24-243"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"EPOCHS"</span><span class="p">]):</span>
<a id="__codelineno-24-244" name="__codelineno-24-244"></a>        <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
<a id="__codelineno-24-245" name="__codelineno-24-245"></a>        <span class="n">test_loss</span><span class="p">,</span> <span class="n">test_acc</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
<a id="__codelineno-24-246" name="__codelineno-24-246"></a>
<a id="__codelineno-24-247" name="__codelineno-24-247"></a>        <span class="n">train_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
<a id="__codelineno-24-248" name="__codelineno-24-248"></a>        <span class="n">test_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_loss</span><span class="p">)</span>
<a id="__codelineno-24-249" name="__codelineno-24-249"></a>        <span class="n">test_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_acc</span><span class="p">)</span>
<a id="__codelineno-24-250" name="__codelineno-24-250"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"-"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-24-251" name="__codelineno-24-251"></a>
<a id="__codelineno-24-252" name="__codelineno-24-252"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Plotting Training Curves ---"</span><span class="p">)</span>
<a id="__codelineno-24-253" name="__codelineno-24-253"></a>
<a id="__codelineno-24-254" name="__codelineno-24-254"></a>    <span class="n">plot_curves</span><span class="p">(</span><span class="n">train_losses</span><span class="p">,</span> <span class="n">test_losses</span><span class="p">,</span> <span class="n">test_accuracies</span><span class="p">)</span>
<a id="__codelineno-24-255" name="__codelineno-24-255"></a>
<a id="__codelineno-24-256" name="__codelineno-24-256"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Visualizing Latent Space ---"</span><span class="p">)</span>
<a id="__codelineno-24-257" name="__codelineno-24-257"></a>    <span class="n">visualize_latent_space</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
<a id="__codelineno-24-258" name="__codelineno-24-258"></a>
<a id="__codelineno-24-259" name="__codelineno-24-259"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Generating Images by Class ---"</span><span class="p">)</span>
<a id="__codelineno-24-260" name="__codelineno-24-260"></a>    <span class="n">generate_images_by_class</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h3 id="cvae_1">CVAE 接分类头<a class="headerlink" href="#cvae_1" title="Permanent link">¶</a></h3>
<p>最后一个方案比较工程，既然我们的编码器已经实现了一个特征提取器，为什么不直接在这个特征提取器上面训练分类头，最后将分类损失和 VAE 的损失汇总呢？也就是</p>
<div class="arithmatex">\[
\mathcal L= \gamma CE-ELBO
\]</div>
<p>但是我们也可以换个视角，我们不将其看作是 CVAE 的魔改，而是一个 CNN 的魔改：对一个 CNN 接了个 CVAE 的支线，这样 <span class="arithmatex">\(-ELBO\)</span> 就是对 CNN 原有交叉熵损失函数的正则化项！而这样的正则化极其有道理——我们并不是像 <span class="arithmatex">\(L_2\)</span> 正则化一样约束参数大小，而是基于其图像本身和预测类别，来进一步约束特征提取器。当然，我们可以通过调节 <span class="arithmatex">\(\beta\)</span> 和 <span class="arithmatex">\(\gamma\)</span> 来控制正则化惩罚的强度。</p>
<p>这是目前三种尝试里面最好的效果，能够达到分类准确率 82% 以上，这还只是一个简单的 3 层 CNN，效果就已经接近之前从零训练的 ResNet-18 了。</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align: center;">β = 0.1</th>
<th style="text-align: center;">β = 1</th>
<th style="text-align: center;">β = 10</th>
</tr>
</thead>
<tbody>
<tr>
<td>训练指标曲线</td>
<td style="text-align: center;"><img alt="alt text" src="../image-24.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-20.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-14.png"/></td>
</tr>
<tr>
<td>生成图像</td>
<td style="text-align: center;"><img alt="alt text" src="../image-25.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-21.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../image-15.png"/></td>
</tr>
</tbody>
</table>
<details>
<summary> 带分类头的 CVAE 的训练代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">  1</a></span>
<span class="normal"><a href="#__codelineno-25-2">  2</a></span>
<span class="normal"><a href="#__codelineno-25-3">  3</a></span>
<span class="normal"><a href="#__codelineno-25-4">  4</a></span>
<span class="normal"><a href="#__codelineno-25-5">  5</a></span>
<span class="normal"><a href="#__codelineno-25-6">  6</a></span>
<span class="normal"><a href="#__codelineno-25-7">  7</a></span>
<span class="normal"><a href="#__codelineno-25-8">  8</a></span>
<span class="normal"><a href="#__codelineno-25-9">  9</a></span>
<span class="normal"><a href="#__codelineno-25-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-25-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-25-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-25-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-25-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-25-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-25-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-25-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-25-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-25-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-25-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-25-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-25-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-25-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-25-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-25-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-25-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-25-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-25-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-25-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-25-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-25-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-25-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-25-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-25-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-25-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-25-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-25-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-25-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-25-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-25-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-25-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-25-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-25-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-25-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-25-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-25-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-25-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-25-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-25-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-25-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-25-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-25-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-25-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-25-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-25-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-25-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-25-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-25-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-25-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-25-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-25-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-25-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-25-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-25-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-25-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-25-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-25-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-25-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-25-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-25-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-25-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-25-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-25-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-25-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-25-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-25-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-25-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-25-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-25-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-25-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-25-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-25-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-25-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-25-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-25-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-25-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-25-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-25-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-25-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-25-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-25-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-25-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-25-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-25-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-25-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-25-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-25-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-25-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-25-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-25-100">100</a></span>
<span class="normal"><a href="#__codelineno-25-101">101</a></span>
<span class="normal"><a href="#__codelineno-25-102">102</a></span>
<span class="normal"><a href="#__codelineno-25-103">103</a></span>
<span class="normal"><a href="#__codelineno-25-104">104</a></span>
<span class="normal"><a href="#__codelineno-25-105">105</a></span>
<span class="normal"><a href="#__codelineno-25-106">106</a></span>
<span class="normal"><a href="#__codelineno-25-107">107</a></span>
<span class="normal"><a href="#__codelineno-25-108">108</a></span>
<span class="normal"><a href="#__codelineno-25-109">109</a></span>
<span class="normal"><a href="#__codelineno-25-110">110</a></span>
<span class="normal"><a href="#__codelineno-25-111">111</a></span>
<span class="normal"><a href="#__codelineno-25-112">112</a></span>
<span class="normal"><a href="#__codelineno-25-113">113</a></span>
<span class="normal"><a href="#__codelineno-25-114">114</a></span>
<span class="normal"><a href="#__codelineno-25-115">115</a></span>
<span class="normal"><a href="#__codelineno-25-116">116</a></span>
<span class="normal"><a href="#__codelineno-25-117">117</a></span>
<span class="normal"><a href="#__codelineno-25-118">118</a></span>
<span class="normal"><a href="#__codelineno-25-119">119</a></span>
<span class="normal"><a href="#__codelineno-25-120">120</a></span>
<span class="normal"><a href="#__codelineno-25-121">121</a></span>
<span class="normal"><a href="#__codelineno-25-122">122</a></span>
<span class="normal"><a href="#__codelineno-25-123">123</a></span>
<span class="normal"><a href="#__codelineno-25-124">124</a></span>
<span class="normal"><a href="#__codelineno-25-125">125</a></span>
<span class="normal"><a href="#__codelineno-25-126">126</a></span>
<span class="normal"><a href="#__codelineno-25-127">127</a></span>
<span class="normal"><a href="#__codelineno-25-128">128</a></span>
<span class="normal"><a href="#__codelineno-25-129">129</a></span>
<span class="normal"><a href="#__codelineno-25-130">130</a></span>
<span class="normal"><a href="#__codelineno-25-131">131</a></span>
<span class="normal"><a href="#__codelineno-25-132">132</a></span>
<span class="normal"><a href="#__codelineno-25-133">133</a></span>
<span class="normal"><a href="#__codelineno-25-134">134</a></span>
<span class="normal"><a href="#__codelineno-25-135">135</a></span>
<span class="normal"><a href="#__codelineno-25-136">136</a></span>
<span class="normal"><a href="#__codelineno-25-137">137</a></span>
<span class="normal"><a href="#__codelineno-25-138">138</a></span>
<span class="normal"><a href="#__codelineno-25-139">139</a></span>
<span class="normal"><a href="#__codelineno-25-140">140</a></span>
<span class="normal"><a href="#__codelineno-25-141">141</a></span>
<span class="normal"><a href="#__codelineno-25-142">142</a></span>
<span class="normal"><a href="#__codelineno-25-143">143</a></span>
<span class="normal"><a href="#__codelineno-25-144">144</a></span>
<span class="normal"><a href="#__codelineno-25-145">145</a></span>
<span class="normal"><a href="#__codelineno-25-146">146</a></span>
<span class="normal"><a href="#__codelineno-25-147">147</a></span>
<span class="normal"><a href="#__codelineno-25-148">148</a></span>
<span class="normal"><a href="#__codelineno-25-149">149</a></span>
<span class="normal"><a href="#__codelineno-25-150">150</a></span>
<span class="normal"><a href="#__codelineno-25-151">151</a></span>
<span class="normal"><a href="#__codelineno-25-152">152</a></span>
<span class="normal"><a href="#__codelineno-25-153">153</a></span>
<span class="normal"><a href="#__codelineno-25-154">154</a></span>
<span class="normal"><a href="#__codelineno-25-155">155</a></span>
<span class="normal"><a href="#__codelineno-25-156">156</a></span>
<span class="normal"><a href="#__codelineno-25-157">157</a></span>
<span class="normal"><a href="#__codelineno-25-158">158</a></span>
<span class="normal"><a href="#__codelineno-25-159">159</a></span>
<span class="normal"><a href="#__codelineno-25-160">160</a></span>
<span class="normal"><a href="#__codelineno-25-161">161</a></span>
<span class="normal"><a href="#__codelineno-25-162">162</a></span>
<span class="normal"><a href="#__codelineno-25-163">163</a></span>
<span class="normal"><a href="#__codelineno-25-164">164</a></span>
<span class="normal"><a href="#__codelineno-25-165">165</a></span>
<span class="normal"><a href="#__codelineno-25-166">166</a></span>
<span class="normal"><a href="#__codelineno-25-167">167</a></span>
<span class="normal"><a href="#__codelineno-25-168">168</a></span>
<span class="normal"><a href="#__codelineno-25-169">169</a></span>
<span class="normal"><a href="#__codelineno-25-170">170</a></span>
<span class="normal"><a href="#__codelineno-25-171">171</a></span>
<span class="normal"><a href="#__codelineno-25-172">172</a></span>
<span class="normal"><a href="#__codelineno-25-173">173</a></span>
<span class="normal"><a href="#__codelineno-25-174">174</a></span>
<span class="normal"><a href="#__codelineno-25-175">175</a></span>
<span class="normal"><a href="#__codelineno-25-176">176</a></span>
<span class="normal"><a href="#__codelineno-25-177">177</a></span>
<span class="normal"><a href="#__codelineno-25-178">178</a></span>
<span class="normal"><a href="#__codelineno-25-179">179</a></span>
<span class="normal"><a href="#__codelineno-25-180">180</a></span>
<span class="normal"><a href="#__codelineno-25-181">181</a></span>
<span class="normal"><a href="#__codelineno-25-182">182</a></span>
<span class="normal"><a href="#__codelineno-25-183">183</a></span>
<span class="normal"><a href="#__codelineno-25-184">184</a></span>
<span class="normal"><a href="#__codelineno-25-185">185</a></span>
<span class="normal"><a href="#__codelineno-25-186">186</a></span>
<span class="normal"><a href="#__codelineno-25-187">187</a></span>
<span class="normal"><a href="#__codelineno-25-188">188</a></span>
<span class="normal"><a href="#__codelineno-25-189">189</a></span>
<span class="normal"><a href="#__codelineno-25-190">190</a></span>
<span class="normal"><a href="#__codelineno-25-191">191</a></span>
<span class="normal"><a href="#__codelineno-25-192">192</a></span>
<span class="normal"><a href="#__codelineno-25-193">193</a></span>
<span class="normal"><a href="#__codelineno-25-194">194</a></span>
<span class="normal"><a href="#__codelineno-25-195">195</a></span>
<span class="normal"><a href="#__codelineno-25-196">196</a></span>
<span class="normal"><a href="#__codelineno-25-197">197</a></span>
<span class="normal"><a href="#__codelineno-25-198">198</a></span>
<span class="normal"><a href="#__codelineno-25-199">199</a></span>
<span class="normal"><a href="#__codelineno-25-200">200</a></span>
<span class="normal"><a href="#__codelineno-25-201">201</a></span>
<span class="normal"><a href="#__codelineno-25-202">202</a></span>
<span class="normal"><a href="#__codelineno-25-203">203</a></span>
<span class="normal"><a href="#__codelineno-25-204">204</a></span>
<span class="normal"><a href="#__codelineno-25-205">205</a></span>
<span class="normal"><a href="#__codelineno-25-206">206</a></span>
<span class="normal"><a href="#__codelineno-25-207">207</a></span>
<span class="normal"><a href="#__codelineno-25-208">208</a></span>
<span class="normal"><a href="#__codelineno-25-209">209</a></span>
<span class="normal"><a href="#__codelineno-25-210">210</a></span>
<span class="normal"><a href="#__codelineno-25-211">211</a></span>
<span class="normal"><a href="#__codelineno-25-212">212</a></span>
<span class="normal"><a href="#__codelineno-25-213">213</a></span>
<span class="normal"><a href="#__codelineno-25-214">214</a></span>
<span class="normal"><a href="#__codelineno-25-215">215</a></span>
<span class="normal"><a href="#__codelineno-25-216">216</a></span>
<span class="normal"><a href="#__codelineno-25-217">217</a></span>
<span class="normal"><a href="#__codelineno-25-218">218</a></span>
<span class="normal"><a href="#__codelineno-25-219">219</a></span>
<span class="normal"><a href="#__codelineno-25-220">220</a></span>
<span class="normal"><a href="#__codelineno-25-221">221</a></span>
<span class="normal"><a href="#__codelineno-25-222">222</a></span>
<span class="normal"><a href="#__codelineno-25-223">223</a></span>
<span class="normal"><a href="#__codelineno-25-224">224</a></span>
<span class="normal"><a href="#__codelineno-25-225">225</a></span>
<span class="normal"><a href="#__codelineno-25-226">226</a></span>
<span class="normal"><a href="#__codelineno-25-227">227</a></span>
<span class="normal"><a href="#__codelineno-25-228">228</a></span>
<span class="normal"><a href="#__codelineno-25-229">229</a></span>
<span class="normal"><a href="#__codelineno-25-230">230</a></span>
<span class="normal"><a href="#__codelineno-25-231">231</a></span>
<span class="normal"><a href="#__codelineno-25-232">232</a></span>
<span class="normal"><a href="#__codelineno-25-233">233</a></span>
<span class="normal"><a href="#__codelineno-25-234">234</a></span>
<span class="normal"><a href="#__codelineno-25-235">235</a></span>
<span class="normal"><a href="#__codelineno-25-236">236</a></span>
<span class="normal"><a href="#__codelineno-25-237">237</a></span>
<span class="normal"><a href="#__codelineno-25-238">238</a></span>
<span class="normal"><a href="#__codelineno-25-239">239</a></span>
<span class="normal"><a href="#__codelineno-25-240">240</a></span>
<span class="normal"><a href="#__codelineno-25-241">241</a></span>
<span class="normal"><a href="#__codelineno-25-242">242</a></span>
<span class="normal"><a href="#__codelineno-25-243">243</a></span>
<span class="normal"><a href="#__codelineno-25-244">244</a></span>
<span class="normal"><a href="#__codelineno-25-245">245</a></span>
<span class="normal"><a href="#__codelineno-25-246">246</a></span>
<span class="normal"><a href="#__codelineno-25-247">247</a></span>
<span class="normal"><a href="#__codelineno-25-248">248</a></span>
<span class="normal"><a href="#__codelineno-25-249">249</a></span>
<span class="normal"><a href="#__codelineno-25-250">250</a></span>
<span class="normal"><a href="#__codelineno-25-251">251</a></span>
<span class="normal"><a href="#__codelineno-25-252">252</a></span>
<span class="normal"><a href="#__codelineno-25-253">253</a></span>
<span class="normal"><a href="#__codelineno-25-254">254</a></span>
<span class="normal"><a href="#__codelineno-25-255">255</a></span>
<span class="normal"><a href="#__codelineno-25-256">256</a></span>
<span class="normal"><a href="#__codelineno-25-257">257</a></span>
<span class="normal"><a href="#__codelineno-25-258">258</a></span>
<span class="normal"><a href="#__codelineno-25-259">259</a></span>
<span class="normal"><a href="#__codelineno-25-260">260</a></span>
<span class="normal"><a href="#__codelineno-25-261">261</a></span>
<span class="normal"><a href="#__codelineno-25-262">262</a></span>
<span class="normal"><a href="#__codelineno-25-263">263</a></span>
<span class="normal"><a href="#__codelineno-25-264">264</a></span>
<span class="normal"><a href="#__codelineno-25-265">265</a></span>
<span class="normal"><a href="#__codelineno-25-266">266</a></span>
<span class="normal"><a href="#__codelineno-25-267">267</a></span>
<span class="normal"><a href="#__codelineno-25-268">268</a></span>
<span class="normal"><a href="#__codelineno-25-269">269</a></span>
<span class="normal"><a href="#__codelineno-25-270">270</a></span>
<span class="normal"><a href="#__codelineno-25-271">271</a></span>
<span class="normal"><a href="#__codelineno-25-272">272</a></span>
<span class="normal"><a href="#__codelineno-25-273">273</a></span>
<span class="normal"><a href="#__codelineno-25-274">274</a></span>
<span class="normal"><a href="#__codelineno-25-275">275</a></span>
<span class="normal"><a href="#__codelineno-25-276">276</a></span>
<span class="normal"><a href="#__codelineno-25-277">277</a></span>
<span class="normal"><a href="#__codelineno-25-278">278</a></span>
<span class="normal"><a href="#__codelineno-25-279">279</a></span>
<span class="normal"><a href="#__codelineno-25-280">280</a></span>
<span class="normal"><a href="#__codelineno-25-281">281</a></span>
<span class="normal"><a href="#__codelineno-25-282">282</a></span>
<span class="normal"><a href="#__codelineno-25-283">283</a></span>
<span class="normal"><a href="#__codelineno-25-284">284</a></span>
<span class="normal"><a href="#__codelineno-25-285">285</a></span>
<span class="normal"><a href="#__codelineno-25-286">286</a></span>
<span class="normal"><a href="#__codelineno-25-287">287</a></span>
<span class="normal"><a href="#__codelineno-25-288">288</a></span>
<span class="normal"><a href="#__codelineno-25-289">289</a></span>
<span class="normal"><a href="#__codelineno-25-290">290</a></span>
<span class="normal"><a href="#__codelineno-25-291">291</a></span>
<span class="normal"><a href="#__codelineno-25-292">292</a></span>
<span class="normal"><a href="#__codelineno-25-293">293</a></span>
<span class="normal"><a href="#__codelineno-25-294">294</a></span>
<span class="normal"><a href="#__codelineno-25-295">295</a></span>
<span class="normal"><a href="#__codelineno-25-296">296</a></span>
<span class="normal"><a href="#__codelineno-25-297">297</a></span>
<span class="normal"><a href="#__codelineno-25-298">298</a></span>
<span class="normal"><a href="#__codelineno-25-299">299</a></span>
<span class="normal"><a href="#__codelineno-25-300">300</a></span>
<span class="normal"><a href="#__codelineno-25-301">301</a></span>
<span class="normal"><a href="#__codelineno-25-302">302</a></span>
<span class="normal"><a href="#__codelineno-25-303">303</a></span>
<span class="normal"><a href="#__codelineno-25-304">304</a></span>
<span class="normal"><a href="#__codelineno-25-305">305</a></span>
<span class="normal"><a href="#__codelineno-25-306">306</a></span>
<span class="normal"><a href="#__codelineno-25-307">307</a></span>
<span class="normal"><a href="#__codelineno-25-308">308</a></span>
<span class="normal"><a href="#__codelineno-25-309">309</a></span>
<span class="normal"><a href="#__codelineno-25-310">310</a></span>
<span class="normal"><a href="#__codelineno-25-311">311</a></span>
<span class="normal"><a href="#__codelineno-25-312">312</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>
<a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-25-13" name="__codelineno-25-13"></a>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a><span class="c1"># --- 1. 配置参数 ---</span>
<a id="__codelineno-25-15" name="__codelineno-25-15"></a><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-25-16" name="__codelineno-25-16"></a>    <span class="s2">"METHOD_NAME"</span><span class="p">:</span> <span class="s2">"CVAE_Classifier"</span><span class="p">,</span>
<a id="__codelineno-25-17" name="__codelineno-25-17"></a>    <span class="s2">"LATENT_DIM"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-25-18" name="__codelineno-25-18"></a>    <span class="s2">"NUM_CLASSES"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-25-19" name="__codelineno-25-19"></a>    <span class="s2">"BATCH_SIZE"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-25-20" name="__codelineno-25-20"></a>    <span class="s2">"EPOCHS"</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-25-21" name="__codelineno-25-21"></a>    <span class="s2">"LR"</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
<a id="__codelineno-25-22" name="__codelineno-25-22"></a>    <span class="s2">"BETA"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
<a id="__codelineno-25-23" name="__codelineno-25-23"></a>    <span class="s2">"GAMMA"</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-25-24" name="__codelineno-25-24"></a>    <span class="s2">"DEVICE"</span><span class="p">:</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">,</span>
<a id="__codelineno-25-25" name="__codelineno-25-25"></a>    <span class="s2">"DATA_PATH"</span><span class="p">:</span> <span class="s2">"./data"</span><span class="p">,</span>
<a id="__codelineno-25-26" name="__codelineno-25-26"></a>    <span class="s2">"OUTPUT_PATH"</span><span class="p">:</span> <span class="s2">"./output"</span>
<a id="__codelineno-25-27" name="__codelineno-25-27"></a><span class="p">}</span>
<a id="__codelineno-25-28" name="__codelineno-25-28"></a>
<a id="__codelineno-25-29" name="__codelineno-25-29"></a><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"OUTPUT_PATH"</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">"METHOD_NAME"</span><span class="p">])</span>
<a id="__codelineno-25-30" name="__codelineno-25-30"></a><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-25-31" name="__codelineno-25-31"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using device: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'DEVICE'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-25-32" name="__codelineno-25-32"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running with Beta = </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'BETA'</span><span class="p">]</span><span class="si">}</span><span class="s2">, Gamma = </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'GAMMA'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-25-33" name="__codelineno-25-33"></a>
<a id="__codelineno-25-34" name="__codelineno-25-34"></a><span class="c1"># --- 2. 数据加载 ---</span>
<a id="__codelineno-25-35" name="__codelineno-25-35"></a><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span>
<a id="__codelineno-25-36" name="__codelineno-25-36"></a><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"DATA_PATH"</span><span class="p">],</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-25-37" name="__codelineno-25-37"></a><span class="n">test_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"DATA_PATH"</span><span class="p">],</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-25-38" name="__codelineno-25-38"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"BATCH_SIZE"</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-25-39" name="__codelineno-25-39"></a><span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"BATCH_SIZE"</span><span class="p">],</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-25-40" name="__codelineno-25-40"></a><span class="n">classes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'plane'</span><span class="p">,</span> <span class="s1">'car'</span><span class="p">,</span> <span class="s1">'bird'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">,</span> <span class="s1">'deer'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">,</span> <span class="s1">'frog'</span><span class="p">,</span> <span class="s1">'horse'</span><span class="p">,</span> <span class="s1">'ship'</span><span class="p">,</span> <span class="s1">'truck'</span><span class="p">)</span>
<a id="__codelineno-25-41" name="__codelineno-25-41"></a>
<a id="__codelineno-25-42" name="__codelineno-25-42"></a><span class="c1"># --- 3. 模型定义: CVAE + 分类器 ---</span>
<a id="__codelineno-25-43" name="__codelineno-25-43"></a><span class="k">class</span><span class="w"> </span><span class="nc">CVAE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-25-44" name="__codelineno-25-44"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-25-45" name="__codelineno-25-45"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">CVAE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-25-46" name="__codelineno-25-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span> <span class="o">=</span> <span class="n">latent_dim</span>
<a id="__codelineno-25-47" name="__codelineno-25-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">num_classes</span>
<a id="__codelineno-25-48" name="__codelineno-25-48"></a>
<a id="__codelineno-25-49" name="__codelineno-25-49"></a>        <span class="c1"># 编码器</span>
<a id="__codelineno-25-50" name="__codelineno-25-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_features</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-25-51" name="__codelineno-25-51"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-25-52" name="__codelineno-25-52"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-25-53" name="__codelineno-25-53"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-25-54" name="__codelineno-25-54"></a>        <span class="p">)</span>
<a id="__codelineno-25-55" name="__codelineno-25-55"></a>
<a id="__codelineno-25-56" name="__codelineno-25-56"></a>        <span class="c1"># 分类头从图像特征直接进行分类</span>
<a id="__codelineno-25-57" name="__codelineno-25-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<a id="__codelineno-25-58" name="__codelineno-25-58"></a>
<a id="__codelineno-25-59" name="__codelineno-25-59"></a>        <span class="c1"># VAE部分</span>
<a id="__codelineno-25-60" name="__codelineno-25-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_mu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">)</span>
<a id="__codelineno-25-61" name="__codelineno-25-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc_log_var</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">)</span>
<a id="__codelineno-25-62" name="__codelineno-25-62"></a>
<a id="__codelineno-25-63" name="__codelineno-25-63"></a>        <span class="c1"># 解码器</span>
<a id="__codelineno-25-64" name="__codelineno-25-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">latent_dim</span> <span class="o">+</span> <span class="n">num_classes</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-25-65" name="__codelineno-25-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-25-66" name="__codelineno-25-66"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-25-67" name="__codelineno-25-67"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-25-68" name="__codelineno-25-68"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
<a id="__codelineno-25-69" name="__codelineno-25-69"></a>        <span class="p">)</span>
<a id="__codelineno-25-70" name="__codelineno-25-70"></a>
<a id="__codelineno-25-71" name="__codelineno-25-71"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">):</span>
<a id="__codelineno-25-72" name="__codelineno-25-72"></a>        <span class="c1"># 提取图像特征</span>
<a id="__codelineno-25-73" name="__codelineno-25-73"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-25-74" name="__codelineno-25-74"></a>        <span class="n">h_flat</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-25-75" name="__codelineno-25-75"></a>
<a id="__codelineno-25-76" name="__codelineno-25-76"></a>        <span class="c1"># --- 分类预测 ---</span>
<a id="__codelineno-25-77" name="__codelineno-25-77"></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">h_flat</span><span class="p">)</span>
<a id="__codelineno-25-78" name="__codelineno-25-78"></a>
<a id="__codelineno-25-79" name="__codelineno-25-79"></a>        <span class="c1"># 将图像特征与标签信息拼接用于VAE</span>
<a id="__codelineno-25-80" name="__codelineno-25-80"></a>        <span class="n">h_combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">h_flat</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-25-81" name="__codelineno-25-81"></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_mu</span><span class="p">(</span><span class="n">h_combined</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_log_var</span><span class="p">(</span><span class="n">h_combined</span><span class="p">)</span>
<a id="__codelineno-25-82" name="__codelineno-25-82"></a>        <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">,</span> <span class="n">logits</span>
<a id="__codelineno-25-83" name="__codelineno-25-83"></a>
<a id="__codelineno-25-84" name="__codelineno-25-84"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reparameterize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">):</span>
<a id="__codelineno-25-85" name="__codelineno-25-85"></a>        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-25-86" name="__codelineno-25-86"></a>        <span class="n">eps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
<a id="__codelineno-25-87" name="__codelineno-25-87"></a>        <span class="k">return</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">std</span>
<a id="__codelineno-25-88" name="__codelineno-25-88"></a>
<a id="__codelineno-25-89" name="__codelineno-25-89"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">):</span>
<a id="__codelineno-25-90" name="__codelineno-25-90"></a>        <span class="c1"># 将潜在变量与标签信息拼接</span>
<a id="__codelineno-25-91" name="__codelineno-25-91"></a>        <span class="n">z_combined</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">z</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-25-92" name="__codelineno-25-92"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_fc</span><span class="p">(</span><span class="n">z_combined</span><span class="p">)</span>
<a id="__codelineno-25-93" name="__codelineno-25-93"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-25-94" name="__codelineno-25-94"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder_conv</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-25-95" name="__codelineno-25-95"></a>
<a id="__codelineno-25-96" name="__codelineno-25-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">):</span>
<a id="__codelineno-25-97" name="__codelineno-25-97"></a>        <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">)</span>
<a id="__codelineno-25-98" name="__codelineno-25-98"></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparameterize</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">)</span>
<a id="__codelineno-25-99" name="__codelineno-25-99"></a>        <span class="n">recon_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y_onehot</span><span class="p">)</span>
<a id="__codelineno-25-100" name="__codelineno-25-100"></a>        <span class="k">return</span> <span class="n">recon_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">,</span> <span class="n">logits</span>
<a id="__codelineno-25-101" name="__codelineno-25-101"></a>
<a id="__codelineno-25-102" name="__codelineno-25-102"></a><span class="c1"># --- 4. 损失函数 ---</span>
<a id="__codelineno-25-103" name="__codelineno-25-103"></a><span class="k">def</span><span class="w"> </span><span class="nf">loss_function</span><span class="p">(</span><span class="n">recon_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
<a id="__codelineno-25-104" name="__codelineno-25-104"></a>    <span class="c1"># VAE损失</span>
<a id="__codelineno-25-105" name="__codelineno-25-105"></a>    <span class="n">MSE</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">recon_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">'sum'</span><span class="p">)</span>
<a id="__codelineno-25-106" name="__codelineno-25-106"></a>    <span class="n">KLD</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">log_var</span> <span class="o">-</span> <span class="n">mu</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_var</span><span class="o">.</span><span class="n">exp</span><span class="p">())</span>
<a id="__codelineno-25-107" name="__codelineno-25-107"></a>    <span class="n">vae_loss</span> <span class="o">=</span> <span class="n">MSE</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"BETA"</span><span class="p">]</span> <span class="o">*</span> <span class="n">KLD</span>
<a id="__codelineno-25-108" name="__codelineno-25-108"></a>
<a id="__codelineno-25-109" name="__codelineno-25-109"></a>    <span class="c1"># 分类损失</span>
<a id="__codelineno-25-110" name="__codelineno-25-110"></a>    <span class="n">class_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">'sum'</span><span class="p">)</span>
<a id="__codelineno-25-111" name="__codelineno-25-111"></a>
<a id="__codelineno-25-112" name="__codelineno-25-112"></a>    <span class="c1"># 总损失</span>
<a id="__codelineno-25-113" name="__codelineno-25-113"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="n">vae_loss</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">"GAMMA"</span><span class="p">]</span> <span class="o">*</span> <span class="n">class_loss</span>
<a id="__codelineno-25-114" name="__codelineno-25-114"></a>
<a id="__codelineno-25-115" name="__codelineno-25-115"></a>    <span class="k">return</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">vae_loss</span><span class="p">,</span> <span class="n">class_loss</span>
<a id="__codelineno-25-116" name="__codelineno-25-116"></a>
<a id="__codelineno-25-117" name="__codelineno-25-117"></a><span class="c1"># --- 5. 训练与测试循环 ---</span>
<a id="__codelineno-25-118" name="__codelineno-25-118"></a><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<a id="__codelineno-25-119" name="__codelineno-25-119"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-25-120" name="__codelineno-25-120"></a>    <span class="n">total_loss</span><span class="p">,</span> <span class="n">total_vae_loss</span><span class="p">,</span> <span class="n">total_class_loss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<a id="__codelineno-25-121" name="__codelineno-25-121"></a>    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-25-122" name="__codelineno-25-122"></a>    <span class="n">total_samples</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-25-123" name="__codelineno-25-123"></a>
<a id="__codelineno-25-124" name="__codelineno-25-124"></a>    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Train Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'EPOCHS'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-25-125" name="__codelineno-25-125"></a>    <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
<a id="__codelineno-25-126" name="__codelineno-25-126"></a>        <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">]),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-25-127" name="__codelineno-25-127"></a>
<a id="__codelineno-25-128" name="__codelineno-25-128"></a>        <span class="c1"># 创建one-hot标签</span>
<a id="__codelineno-25-129" name="__codelineno-25-129"></a>        <span class="n">labels_onehot</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-25-130" name="__codelineno-25-130"></a>
<a id="__codelineno-25-131" name="__codelineno-25-131"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-25-132" name="__codelineno-25-132"></a>        <span class="n">recon_batch</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_onehot</span><span class="p">)</span>
<a id="__codelineno-25-133" name="__codelineno-25-133"></a>
<a id="__codelineno-25-134" name="__codelineno-25-134"></a>        <span class="c1"># 计算损失</span>
<a id="__codelineno-25-135" name="__codelineno-25-135"></a>        <span class="n">t_loss</span><span class="p">,</span> <span class="n">v_loss</span><span class="p">,</span> <span class="n">c_loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-25-136" name="__codelineno-25-136"></a>
<a id="__codelineno-25-137" name="__codelineno-25-137"></a>        <span class="n">t_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-25-138" name="__codelineno-25-138"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-25-139" name="__codelineno-25-139"></a>
<a id="__codelineno-25-140" name="__codelineno-25-140"></a>        <span class="c1"># 累加损失和正确分类数</span>
<a id="__codelineno-25-141" name="__codelineno-25-141"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">t_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-25-142" name="__codelineno-25-142"></a>        <span class="n">total_vae_loss</span> <span class="o">+=</span> <span class="n">v_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-25-143" name="__codelineno-25-143"></a>        <span class="n">total_class_loss</span> <span class="o">+=</span> <span class="n">c_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-25-144" name="__codelineno-25-144"></a>
<a id="__codelineno-25-145" name="__codelineno-25-145"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-25-146" name="__codelineno-25-146"></a>        <span class="n">correct</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-25-147" name="__codelineno-25-147"></a>        <span class="n">total_samples</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-25-148" name="__codelineno-25-148"></a>
<a id="__codelineno-25-149" name="__codelineno-25-149"></a>        <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span>
<a id="__codelineno-25-150" name="__codelineno-25-150"></a>            <span class="n">loss</span><span class="o">=</span><span class="n">t_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> 
<a id="__codelineno-25-151" name="__codelineno-25-151"></a>            <span class="n">acc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="mf">100.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total_samples</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%"</span>
<a id="__codelineno-25-152" name="__codelineno-25-152"></a>        <span class="p">)</span>
<a id="__codelineno-25-153" name="__codelineno-25-153"></a>
<a id="__codelineno-25-154" name="__codelineno-25-154"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-25-155" name="__codelineno-25-155"></a>    <span class="n">avg_vae_loss</span> <span class="o">=</span> <span class="n">total_vae_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-25-156" name="__codelineno-25-156"></a>    <span class="n">avg_class_loss</span> <span class="o">=</span> <span class="n">total_class_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-25-157" name="__codelineno-25-157"></a>    <span class="n">accuracy</span> <span class="o">=</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-25-158" name="__codelineno-25-158"></a>
<a id="__codelineno-25-159" name="__codelineno-25-159"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'====&gt; Train Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1"> | Avg Loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> | VAE Loss: </span><span class="si">{</span><span class="n">avg_vae_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> | Class Loss: </span><span class="si">{</span><span class="n">avg_class_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> | Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%'</span><span class="p">)</span>
<a id="__codelineno-25-160" name="__codelineno-25-160"></a>    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">accuracy</span>
<a id="__codelineno-25-161" name="__codelineno-25-161"></a>
<a id="__codelineno-25-162" name="__codelineno-25-162"></a><span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<a id="__codelineno-25-163" name="__codelineno-25-163"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-25-164" name="__codelineno-25-164"></a>    <span class="n">total_loss</span><span class="p">,</span> <span class="n">total_vae_loss</span><span class="p">,</span> <span class="n">total_class_loss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<a id="__codelineno-25-165" name="__codelineno-25-165"></a>    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-25-166" name="__codelineno-25-166"></a>
<a id="__codelineno-25-167" name="__codelineno-25-167"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-25-168" name="__codelineno-25-168"></a>        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
<a id="__codelineno-25-169" name="__codelineno-25-169"></a>            <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">]),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-25-170" name="__codelineno-25-170"></a>            <span class="n">labels_onehot</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-25-171" name="__codelineno-25-171"></a>
<a id="__codelineno-25-172" name="__codelineno-25-172"></a>            <span class="n">recon_batch</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_onehot</span><span class="p">)</span>
<a id="__codelineno-25-173" name="__codelineno-25-173"></a>            <span class="n">t_loss</span><span class="p">,</span> <span class="n">v_loss</span><span class="p">,</span> <span class="n">c_loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">recon_batch</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_var</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-25-174" name="__codelineno-25-174"></a>
<a id="__codelineno-25-175" name="__codelineno-25-175"></a>            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">t_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-25-176" name="__codelineno-25-176"></a>            <span class="n">total_vae_loss</span> <span class="o">+=</span> <span class="n">v_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-25-177" name="__codelineno-25-177"></a>            <span class="n">total_class_loss</span> <span class="o">+=</span> <span class="n">c_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-25-178" name="__codelineno-25-178"></a>
<a id="__codelineno-25-179" name="__codelineno-25-179"></a>            <span class="n">pred</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-25-180" name="__codelineno-25-180"></a>            <span class="n">correct</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-25-181" name="__codelineno-25-181"></a>
<a id="__codelineno-25-182" name="__codelineno-25-182"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-25-183" name="__codelineno-25-183"></a>    <span class="n">avg_vae_loss</span> <span class="o">=</span> <span class="n">total_vae_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-25-184" name="__codelineno-25-184"></a>    <span class="n">avg_class_loss</span> <span class="o">=</span> <span class="n">total_class_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-25-185" name="__codelineno-25-185"></a>    <span class="n">accuracy</span> <span class="o">=</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-25-186" name="__codelineno-25-186"></a>
<a id="__codelineno-25-187" name="__codelineno-25-187"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'====&gt; Test set | Avg Loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> | VAE Loss: </span><span class="si">{</span><span class="n">avg_vae_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> | Class Loss: </span><span class="si">{</span><span class="n">avg_class_loss</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> | Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%'</span><span class="p">)</span>
<a id="__codelineno-25-188" name="__codelineno-25-188"></a>    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">accuracy</span>
<a id="__codelineno-25-189" name="__codelineno-25-189"></a>
<a id="__codelineno-25-190" name="__codelineno-25-190"></a><span class="c1"># --- 6. 可视化函数 ---</span>
<a id="__codelineno-25-191" name="__codelineno-25-191"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_latent_space</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
<a id="__codelineno-25-192" name="__codelineno-25-192"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-25-193" name="__codelineno-25-193"></a>    <span class="n">all_latents</span><span class="p">,</span> <span class="n">all_labels</span><span class="p">,</span> <span class="n">all_preds</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-25-194" name="__codelineno-25-194"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-25-195" name="__codelineno-25-195"></a>        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Encoding data for visualization"</span><span class="p">):</span>
<a id="__codelineno-25-196" name="__codelineno-25-196"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-25-197" name="__codelineno-25-197"></a>            <span class="n">labels_onehot</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-25-198" name="__codelineno-25-198"></a>
<a id="__codelineno-25-199" name="__codelineno-25-199"></a>            <span class="n">mu</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels_onehot</span><span class="p">)</span>
<a id="__codelineno-25-200" name="__codelineno-25-200"></a>
<a id="__codelineno-25-201" name="__codelineno-25-201"></a>            <span class="n">all_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a id="__codelineno-25-202" name="__codelineno-25-202"></a>            <span class="n">all_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a id="__codelineno-25-203" name="__codelineno-25-203"></a>            <span class="n">all_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<a id="__codelineno-25-204" name="__codelineno-25-204"></a>
<a id="__codelineno-25-205" name="__codelineno-25-205"></a>    <span class="n">all_latents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_latents</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-25-206" name="__codelineno-25-206"></a>    <span class="n">all_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-25-207" name="__codelineno-25-207"></a>    <span class="n">all_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">all_preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-25-208" name="__codelineno-25-208"></a>
<a id="__codelineno-25-209" name="__codelineno-25-209"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"Performing t-SNE..."</span><span class="p">)</span>
<a id="__codelineno-25-210" name="__codelineno-25-210"></a>    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-25-211" name="__codelineno-25-211"></a>    <span class="n">latents_2d</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">all_latents</span><span class="p">)</span>
<a id="__codelineno-25-212" name="__codelineno-25-212"></a>
<a id="__codelineno-25-213" name="__codelineno-25-213"></a>    <span class="c1"># 按真实标签可视化</span>
<a id="__codelineno-25-214" name="__codelineno-25-214"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-25-215" name="__codelineno-25-215"></a>    <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">latents_2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">latents_2d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'tab10'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-25-216" name="__codelineno-25-216"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-25-217" name="__codelineno-25-217"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'t-SNE of Latent Space (Colored by True Class)'</span><span class="p">)</span>
<a id="__codelineno-25-218" name="__codelineno-25-218"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"latent_space_true_labels.png"</span><span class="p">))</span>
<a id="__codelineno-25-219" name="__codelineno-25-219"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-25-220" name="__codelineno-25-220"></a>
<a id="__codelineno-25-221" name="__codelineno-25-221"></a>    <span class="c1"># 按预测标签可视化</span>
<a id="__codelineno-25-222" name="__codelineno-25-222"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-25-223" name="__codelineno-25-223"></a>    <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">latents_2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">latents_2d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">all_preds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'tab10'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-25-224" name="__codelineno-25-224"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-25-225" name="__codelineno-25-225"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'t-SNE of Latent Space (Colored by Predicted Class)'</span><span class="p">)</span>
<a id="__codelineno-25-226" name="__codelineno-25-226"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"latent_space_predicted_labels.png"</span><span class="p">))</span>
<a id="__codelineno-25-227" name="__codelineno-25-227"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-25-228" name="__codelineno-25-228"></a>
<a id="__codelineno-25-229" name="__codelineno-25-229"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_images_by_class</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-25-230" name="__codelineno-25-230"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-25-231" name="__codelineno-25-231"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-25-232" name="__codelineno-25-232"></a>    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">"Generated Samples by Class"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-25-233" name="__codelineno-25-233"></a>
<a id="__codelineno-25-234" name="__codelineno-25-234"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-25-235" name="__codelineno-25-235"></a>        <span class="k">for</span> <span class="n">class_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">]):</span>
<a id="__codelineno-25-236" name="__codelineno-25-236"></a>            <span class="n">class_onehot</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">class_idx</span><span class="p">]),</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-25-237" name="__codelineno-25-237"></a>            <span class="n">class_onehot</span> <span class="o">=</span> <span class="n">class_onehot</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-25-238" name="__codelineno-25-238"></a>
<a id="__codelineno-25-239" name="__codelineno-25-239"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">"LATENT_DIM"</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-25-240" name="__codelineno-25-240"></a>            <span class="n">generated_images</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">class_onehot</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-25-241" name="__codelineno-25-241"></a>
<a id="__codelineno-25-242" name="__codelineno-25-242"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="n">classes</span><span class="p">[</span><span class="n">class_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
<a id="__codelineno-25-243" name="__codelineno-25-243"></a>
<a id="__codelineno-25-244" name="__codelineno-25-244"></a>            <span class="k">for</span> <span class="n">sample_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
<a id="__codelineno-25-245" name="__codelineno-25-245"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">generated_images</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-25-246" name="__codelineno-25-246"></a>                <span class="n">axes</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-25-247" name="__codelineno-25-247"></a>                <span class="n">axes</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<a id="__codelineno-25-248" name="__codelineno-25-248"></a>
<a id="__codelineno-25-249" name="__codelineno-25-249"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
<a id="__codelineno-25-250" name="__codelineno-25-250"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"generated_images_by_class.png"</span><span class="p">))</span>
<a id="__codelineno-25-251" name="__codelineno-25-251"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-25-252" name="__codelineno-25-252"></a>
<a id="__codelineno-25-253" name="__codelineno-25-253"></a><span class="c1"># --- 绘制训练曲线的函数 ---</span>
<a id="__codelineno-25-254" name="__codelineno-25-254"></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_curves</span><span class="p">(</span><span class="n">train_losses</span><span class="p">,</span> <span class="n">test_losses</span><span class="p">,</span> <span class="n">train_accuracies</span><span class="p">,</span> <span class="n">test_accuracies</span><span class="p">):</span>
<a id="__codelineno-25-255" name="__codelineno-25-255"></a>    <span class="n">epochs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_losses</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-25-256" name="__codelineno-25-256"></a>
<a id="__codelineno-25-257" name="__codelineno-25-257"></a>    <span class="c1"># 创建一个figure，包含两个子图</span>
<a id="__codelineno-25-258" name="__codelineno-25-258"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a id="__codelineno-25-259" name="__codelineno-25-259"></a>
<a id="__codelineno-25-260" name="__codelineno-25-260"></a>    <span class="c1"># 子图1: 损失曲线</span>
<a id="__codelineno-25-261" name="__codelineno-25-261"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-25-262" name="__codelineno-25-262"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">train_losses</span><span class="p">,</span> <span class="s1">'bo-'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Training Loss'</span><span class="p">)</span>
<a id="__codelineno-25-263" name="__codelineno-25-263"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">test_losses</span><span class="p">,</span> <span class="s1">'ro-'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Test Loss'</span><span class="p">)</span>
<a id="__codelineno-25-264" name="__codelineno-25-264"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Training and Test Loss'</span><span class="p">)</span>
<a id="__codelineno-25-265" name="__codelineno-25-265"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Epochs'</span><span class="p">)</span>
<a id="__codelineno-25-266" name="__codelineno-25-266"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Loss'</span><span class="p">)</span>
<a id="__codelineno-25-267" name="__codelineno-25-267"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-25-268" name="__codelineno-25-268"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-25-269" name="__codelineno-25-269"></a>
<a id="__codelineno-25-270" name="__codelineno-25-270"></a>    <span class="c1"># 子图2: 准确率曲线</span>
<a id="__codelineno-25-271" name="__codelineno-25-271"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-25-272" name="__codelineno-25-272"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">train_accuracies</span><span class="p">,</span> <span class="s1">'bo-'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Training Accuracy'</span><span class="p">)</span>
<a id="__codelineno-25-273" name="__codelineno-25-273"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">test_accuracies</span><span class="p">,</span> <span class="s1">'ro-'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Test Accuracy'</span><span class="p">)</span>
<a id="__codelineno-25-274" name="__codelineno-25-274"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Training and Test Accuracy'</span><span class="p">)</span>
<a id="__codelineno-25-275" name="__codelineno-25-275"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Epochs'</span><span class="p">)</span>
<a id="__codelineno-25-276" name="__codelineno-25-276"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Accuracy (%)'</span><span class="p">)</span>
<a id="__codelineno-25-277" name="__codelineno-25-277"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-25-278" name="__codelineno-25-278"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-25-279" name="__codelineno-25-279"></a>
<a id="__codelineno-25-280" name="__codelineno-25-280"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">'Training Metrics'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-25-281" name="__codelineno-25-281"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<a id="__codelineno-25-282" name="__codelineno-25-282"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"training_curves.png"</span><span class="p">))</span>
<a id="__codelineno-25-283" name="__codelineno-25-283"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-25-284" name="__codelineno-25-284"></a>
<a id="__codelineno-25-285" name="__codelineno-25-285"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-25-286" name="__codelineno-25-286"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">CVAE</span><span class="p">(</span><span class="n">latent_dim</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LATENT_DIM"</span><span class="p">],</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"NUM_CLASSES"</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-25-287" name="__codelineno-25-287"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LR"</span><span class="p">])</span>
<a id="__codelineno-25-288" name="__codelineno-25-288"></a>
<a id="__codelineno-25-289" name="__codelineno-25-289"></a>    <span class="c1"># 用于记录历史数据</span>
<a id="__codelineno-25-290" name="__codelineno-25-290"></a>    <span class="n">train_losses</span><span class="p">,</span> <span class="n">test_losses</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-25-291" name="__codelineno-25-291"></a>    <span class="n">train_accuracies</span><span class="p">,</span> <span class="n">test_accuracies</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-25-292" name="__codelineno-25-292"></a>
<a id="__codelineno-25-293" name="__codelineno-25-293"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"--- Training CVAE with Classifier ---"</span><span class="p">)</span>
<a id="__codelineno-25-294" name="__codelineno-25-294"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"EPOCHS"</span><span class="p">]):</span>
<a id="__codelineno-25-295" name="__codelineno-25-295"></a>        <span class="n">train_loss</span><span class="p">,</span> <span class="n">train_acc</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
<a id="__codelineno-25-296" name="__codelineno-25-296"></a>        <span class="n">test_loss</span><span class="p">,</span> <span class="n">test_acc</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
<a id="__codelineno-25-297" name="__codelineno-25-297"></a>
<a id="__codelineno-25-298" name="__codelineno-25-298"></a>        <span class="c1"># 记录数据</span>
<a id="__codelineno-25-299" name="__codelineno-25-299"></a>        <span class="n">train_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
<a id="__codelineno-25-300" name="__codelineno-25-300"></a>        <span class="n">train_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_acc</span><span class="p">)</span>
<a id="__codelineno-25-301" name="__codelineno-25-301"></a>        <span class="n">test_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_loss</span><span class="p">)</span>
<a id="__codelineno-25-302" name="__codelineno-25-302"></a>        <span class="n">test_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_acc</span><span class="p">)</span>
<a id="__codelineno-25-303" name="__codelineno-25-303"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"-"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-25-304" name="__codelineno-25-304"></a>
<a id="__codelineno-25-305" name="__codelineno-25-305"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Plotting Training Curves ---"</span><span class="p">)</span>
<a id="__codelineno-25-306" name="__codelineno-25-306"></a>    <span class="n">plot_curves</span><span class="p">(</span><span class="n">train_losses</span><span class="p">,</span> <span class="n">test_losses</span><span class="p">,</span> <span class="n">train_accuracies</span><span class="p">,</span> <span class="n">test_accuracies</span><span class="p">)</span>
<a id="__codelineno-25-307" name="__codelineno-25-307"></a>
<a id="__codelineno-25-308" name="__codelineno-25-308"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Visualizing Latent Space ---"</span><span class="p">)</span>
<a id="__codelineno-25-309" name="__codelineno-25-309"></a>    <span class="n">visualize_latent_space</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
<a id="__codelineno-25-310" name="__codelineno-25-310"></a>
<a id="__codelineno-25-311" name="__codelineno-25-311"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Generating Images by Class ---"</span><span class="p">)</span>
<a id="__codelineno-25-312" name="__codelineno-25-312"></a>    <span class="n">generate_images_by_class</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h2 id="gan">GAN<a class="headerlink" href="#gan" title="Permanent link">¶</a></h2>
<h3 id="dc-gan">拿 DC-GAN 画老婆<a class="headerlink" href="#dc-gan" title="Permanent link">¶</a></h3>
<p>虽然推出 GAN 框架的方法有很多，比如博弈论（即一开始提出 GAN 的论文的思路）和能量视角等，不过，我个人更倾向于接着 VAE 的思路，用变分推断的框架去推导 GAN。</p>
<p>书接上回，我们知道 VAE 假定目标分布 <span class="arithmatex">\(p(x)\)</span> 可以被两步拟合而成，也就是预期 <span class="arithmatex">\(p(x)\approx\int q(x|z)q(z)\mathrm dz\)</span>。<span class="arithmatex">\(q(z)\)</span> 即为隐变量分布，而 <span class="arithmatex">\(q(x|z)\)</span> 是从采样生成图片的解码器——或者我们可以换个名字，叫做生成器，也就是 <span class="arithmatex">\(G(z)\)</span>。</p>
<p>但是由于 VAE 引入的正态分布先验过多，导致朴素 VAE 出图很糊，于是我们考虑，至少和出图直接相关的生成器，可以改成非正态分布。怎么改呢？GAN 认为，可以直接建立随机变量 <span class="arithmatex">\(z\)</span> 到 <span class="arithmatex">\(x\)</span> 的一一对应！</p>
<div class="arithmatex">\[
q(x|z)=\delta(x-G(z))
\]</div>
<p>这里用到了 Dirac's Delta 函数，就是要建立这种一一对应。由于我们没有强制假设正态性，所以现在也不好说 <span class="arithmatex">\(z\)</span> 是隐变量，同时后验分布 <span class="arithmatex">\(p(z|x)\)</span> 也不好推知了（在 VAE 里面，是一个正态分布）。至少我们没有强制用先验的正态分布，不会那么“糊”了。</p>
<p>我们知道无论如何变分推断的目的，是将不好推导的 <span class="arithmatex">\(KL(q(x)||p(x))\)</span> 通过引入隐变量 <span class="arithmatex">\(y\)</span>，转化成更强也更容易推导的 <span class="arithmatex">\(KL(q(x,y)||p(x,y))\)</span>。</p>
<p>GAN 认为，这个隐变量是一个<strong>二元的标签向量</strong>，也就是用来区分哪些是从 <span class="arithmatex">\(q(x|z)q(z)\)</span> 生成的，哪些是 <span class="arithmatex">\(p(x)\)</span> 本来的分布。也就是说：</p>
<div class="arithmatex">\[
q(x,y)=\left\{
  \begin{align*}
    &amp;\dfrac 12\ p(x),\ y = 1\\
    &amp;\dfrac 12\ q(x),\ y = 0
  \end{align*}
\right.
\]</div>
<p>以及</p>
<div class="arithmatex">\[
p(x,y)=p(y|x)p(x)
\]</div>
<p>这里的 <span class="arithmatex">\(\dfrac 12\)</span> 主要是起一个归一化的作用。下面的式子是变分推断框架的一部分，我们在 VAE 的理论推导中就见过了，只不过，在 VAE 里面，它的意思是编码器，这里编的是什么码呢？是<strong>对图像来源进行判别得到的标签编码</strong>。也就是说，我们可以把 <span class="arithmatex">\(p(1|x)\)</span> 看作一个分辨图像是否服从原分布的<strong>判别器</strong>，记作 <span class="arithmatex">\(D(x)\)</span></p>
<p>然后很机械地我们带入 KL 散度的计算式里面：</p>
<div class="arithmatex">\[
\begin{align*}
  KL(q(x,y)||p(x,y))&amp;=\sum_y\int q(x,y) \log \dfrac{q(x,y)}{p(x,y)} \mathrm d x\\
  &amp;=\int q(x,1) \log \dfrac{q(x,1)}{p(x,1)} \mathrm d x+\int q(x,0) \log \dfrac{q(x,0)}{p(x,0)} \mathrm d x\\
  &amp;=\int \dfrac 12 p(x) \log \dfrac{\frac 12 p(x)}{p(1|x)p(x)}\mathrm dx+\int \dfrac 12 q(x) \log \dfrac{\frac 12 q(x)}{p(0|x)p(x)}\mathrm dx\\
  &amp;=-\log 2-\dfrac 12 \int p(x) \log p(1|x)\mathrm dx+\dfrac 12 \int q(x)\log \dfrac{q(x)}{p(0|x)p(x)}\mathrm dx\\
  &amp;=-\log 2-\dfrac 12 \int p(x) \log p(1|x)\mathrm dx+\dfrac 12 \int q(x)\log q(x)\mathrm dx-\dfrac 12 \int q(x)\log p(0|x)p(x)\mathrm dx
\end{align*}
\]</div>
<p>丢掉常数和系数。由于里面既有生成器 <span class="arithmatex">\(G\)</span> 又有判别器 <span class="arithmatex">\(D\)</span>，因此，我们每一次优化分两步进行，也就是 EM 算法。</p>
<p>首先，固定生成器 <span class="arithmatex">\(G\)</span> 也就是说现在生成的分布 <span class="arithmatex">\(q(x)\)</span> 不变，同时真实分布 <span class="arithmatex">\(p(x)\)</span> 不可能变；我们优化判别器 <span class="arithmatex">\(D\)</span>，写成期望形式:</p>
<div class="arithmatex">\[
-\mathbb E_{x\sim p(x)}[\log D(x)]+\mathrm{Constant.}-\mathbb E_{x\sim q(x)}[\log (1-D(x))]-\int q(x) \log p(x) \mathrm dx
\]</div>
<p>第二项和第四项都是常数，我们由此得到了判别器的优化目标，也就是损失函数：</p>
<div class="arithmatex">\[
\begin{align*}
  \mathcal L_D&amp;= - \mathbb E_{x\sim p(x)}[\log D(x)] - \mathbb E_{x\sim q(x)}[\log (1-D(x))]\\
  &amp;= - \mathbb E_{x\sim p(x)}[\log D(x)] - \mathbb E_{z\sim q(z)}[\log (1-D(G(z)))]
\end{align*}
\]</div>
<p>下面我们固定判别器，也就是 <span class="arithmatex">\(p(1|x)\)</span> 固定，上式就剩下下面两项不是常数：</p>
<div class="arithmatex">\[
\int q(x)\log q(x)\mathrm dx-\int q(x)\log p(0|x)p(x)\mathrm dx
\]</div>
<p>这里 <span class="arithmatex">\(p(x)\)</span> 不知道，怎么办？事实上考虑一个好的判别器 <span class="arithmatex">\(D=p(1|x)\)</span> 应该能完美区分来自 <span class="arithmatex">\(p(x)\)</span> 的原始图像和来自 <span class="arithmatex">\(q(x)\)</span> 的伪造图像，也就是说：</p>
<div class="arithmatex">\[
D(x)=\dfrac{p(x)}{p(x)+\hat q(x)}
\]</div>
<p>就可以表征在 <span class="arithmatex">\(p(x)\)</span> 和 <span class="arithmatex">\(q(x)\)</span> 的混合下精准识别出真实样本。这里使用 <span class="arithmatex">\(\hat q(x)\)</span> 是因为我们是分步进行的，这一步刚好要对生成器 <span class="arithmatex">\(G(z)=q(x|z)\)</span> 更新，所以出现的 <span class="arithmatex">\(q(x)\)</span> 必须是上一步的伪造分布。解出 <span class="arithmatex">\(p(x)\)</span> 可得：</p>
<div class="arithmatex">\[
p(x)=\hat q(x)\dfrac{D(x)}{1-D(x)}
\]</div>
<p>代入即可：</p>
<div class="arithmatex">\[
\begin{align*}
  \mathcal L_G&amp;=\int q(x)\log q(x)\mathrm dx-\int q(x)\log p(0|x)p(x)\mathrm dx\\
  &amp;=\int q(x)\log q(x)\mathrm dx-\int q(x)\log [(1-D(x))\hat q(x)\dfrac{D(x)}{1-D(x)}]\mathrm dx\\
  &amp;=\int q(x)\log q(x)\mathrm dx-\int q(x)\log \hat q(x)\mathrm dx-\int q(x)\log D(x)\mathrm dx\\
  &amp;=-\mathbb E_{x\sim q(x)}[\log D(x)]+\int q(x)\log \dfrac{q(x)}{\hat q(x)}\mathrm dx\\
  &amp;=-\mathbb E_{z\sim q(z)}[\log D(G(z))]+KL(q(x)||\hat q(x))
\end{align*}
\]</div>
<p>事实上，<span class="arithmatex">\(KL(q(x)||\hat q(x))\)</span> 可以说是对参数更新幅度的正则化约束，它要求理想情况下，<span class="arithmatex">\(q\)</span> 的变动尽可能小。这其实就引出了各种操作，比如加上 BatchNorm，或者使用梯度惩罚等方法。当然本文的复现不涉及 WGAN，所以就不深挖，只讲一下后面会用到的谱归一化。</p>
<p>为了不训炸，控制参数更新量，我们应该对网络结构做出一定的光滑性约束。这样就引入了 Lipschitz 连续性的条件，也就是对于 <span class="arithmatex">\(f(x)\)</span> 而言要求存在 <span class="arithmatex">\(K\)</span> 使得</p>
<div class="arithmatex">\[
|f(x_1)-f(x_2)|\leq K|x_1-x_2|
\]</div>
<p>对于单个线性层 <span class="arithmatex">\(f(x)=Wx\)</span> 而言，<span class="arithmatex">\(K\)</span> 其实衡量的是 <span class="arithmatex">\(W\)</span> 能把 <span class="arithmatex">\(x\)</span> 映射多“远”的能力，显然从几何意义上，我们可以对 <span class="arithmatex">\(W\)</span> 做一个 SVD 也就是 <span class="arithmatex">\(W=U\Sigma V^\top\)</span>，由于 <span class="arithmatex">\(U\)</span> 和 <span class="arithmatex">\(V\)</span> 都是正交阵，<span class="arithmatex">\(K\)</span> 其实就是对应缩放矩阵 <span class="arithmatex">\(\Sigma\)</span> 里面最大的那个奇异值（这被称作该矩阵的<strong>谱范数</strong>）。那这不就好办了：对于每一层，我们都强制限制矩阵参数除以谱范数，就可以把每一层的 Lipschitz 条件控制到 <span class="arithmatex">\(K=1\)</span> 因此整个网络的 <span class="arithmatex">\(K\)</span> 也就限制到 <span class="arithmatex">\(1\)</span> 了。这一操作称作<strong>谱归一化</strong>。</p>
<p>这样我们就从变分推断框架和 EM 算法得到了 GAN 的训练过程：</p>
<ul>
<li>加载一批真实样本，计算 <span class="arithmatex">\(\mathbb E_{x\sim p(x)}[\log D(x)]\)</span></li>
<li>生成一批随机种子，然后交给 <span class="arithmatex">\(G\)</span> 进行伪造生成后再判别，进而计算 <span class="arithmatex">\(\mathbb E_{z\sim q(z)}[\log (1-D(G(z)))]\)</span> 和 <span class="arithmatex">\(\mathbb E_{z\sim q(z)}[\log D(G(z))]\)</span></li>
<li>计算判别器的损失并进行优化：<span class="arithmatex">\(\mathcal L_D= - \mathbb E_{x\sim p(x)}[\log D(x)] - \mathbb E_{z\sim q(z)}[\log (1-D(G(z)))]\)</span></li>
<li>计算生成器的损失并进行优化：<span class="arithmatex">\(\mathcal L_G=-\mathbb E_{z\sim q(z)}[\log D(G(z))]\)</span></li>
</ul>
<p>下面就是整体的网络结构图了。</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313444', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef gen fill:#313244,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4;
    classDef disc fill:#313244,stroke:#f9e2af,stroke-width:2px,color:#cdd6f4;
    classDef loss fill:#313244,stroke:#f2cdcd,stroke-width:2px,color:#cdd6f4;
    classDef op fill:#313244,stroke:#89dceb,stroke-width:2px,color:#cdd6f4;
    classDef step fill:#45475a,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4,radius:16px;
    classDef addOp fill:#45475a,stroke:#cdd6f4,stroke-width:1px,shape:circle;

    %% --- Data Generation ---
    subgraph DataGen [Data Generation]
        direction LR
        Noise[("Latent Noise&lt;br&gt;z")] --&gt; |latent_dim| G[("Generator&lt;br&gt;G")] --&gt; |3 @ 64x64| FakeImg[("Fake Image&lt;br&gt;G(z)")]
        RealImg[("Real Image&lt;br&gt;x")]
    end

    %% --- Discriminator Update Phase ---
    subgraph Phase1 [Update Discriminator]
        direction LR
        D1[("Discriminator&lt;br&gt;D")]

        subgraph LossCalcD [Loss Calculation]
            Loss_D_Fake["Fake loss =&lt;br&gt;-E[log(1-D(G(z)))]"]
            Loss_D_Real["Real loss =&lt;br&gt;-E[log D(x)]"]
            Add_D_Loss[(+)]
            Loss_D_Real --&gt; Add_D_Loss
            Loss_D_Fake --&gt; Add_D_Loss
        end
        Add_D_Loss --&gt; L_D["D loss =&lt;br&gt; Real loss + Fake loss"]
    end

    %% --- Generator Update Phase ---
    subgraph Phase2 [Update Generator]
        direction LR
        D2[("Discriminator&lt;br&gt;D")]
        Loss_G["G loss =-E[log D(G(z))]"]
    end

    %% --- Connecting the Phases ---
    %% Connections for Discriminator training
    Detach["Detach&lt;br&gt;Gradient"]
    FakeImg --&gt; Detach --&gt; |3 @ 64x64| D1 -- "Score D(G(z))" --&gt; Loss_D_Fake

    FakeImg --&gt; |3 @ 64x64| D2 -- "Score D(G(z))" --&gt; Loss_G
    RealImg --&gt; |3 @ 64x64| D1 -- "Score D(x)" --&gt; Loss_D_Real

    %% Connection for Generator training

    %% Set flow from left to right


    %% Styling
    class G gen;
    class D1,D2 disc;
    class Detach op;
    class Add_D_Loss addOp;
    class Noise,RealImg input;
    class Loss_D_Real, Loss_D_Fake;
    class Step_D,Step_G,Backward_D,Backward_G step;</code></pre>
<p>需要注意的是，在对判别器计算损失并更新的时候，有一个 detach 的操作，这就是防止梯度回传到生成器。生成器有自己的损失函数用来更新。其他的部分和刚刚推导的无异。</p>
<p>这个图还有一个值得一提的点：<strong>生成器的梯度完全由判别器回传而来</strong>，也就是说有可能会发生之前在 VAE 里面提到的<strong>后验崩塌</strong>问题，即判别器过于强大，导致无法向生成器回传梯度。有一个巧妙的训练策略可以缓解这个问题：TTUR (Two Time-scale Update Rule)，也就是给生成器更高的学习率，让它在判别器尚未充分强大的时候先变强。可以看到无论是 TTUR 还是谱归一化，抑或是理论里面推导到的 KL 散度项，都是在防止判别器太快地变得过强。</p>
<p>下面是生成器模块。</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef deconvBlock fill:#1e1e2e,stroke:#a6e3a1,stroke-width:1px,color:#a6e3a1;

    %% Input
    Input[("Latent Vector z&lt;br&gt;latent_dim")]
    Reshape["Reshape to&lt;br&gt;latent_dim@1x1"]

    %% Upsample Block 1
    subgraph UpsampleBlock1 ["Upsample Block 1"]
        direction LR
        ConvTranspose2d1["ConvTranspose2d&lt;br&gt; latent_dim x 512 x 4x4 / 1"]
        BN1["BatchNorm2d"]
        ReLU1["ReLU"]
        ConvTranspose2d1 --&gt; BN1 --&gt; ReLU1
    end

    %% Upsample Block 2
    subgraph UpsampleBlock2 ["Upsample Block 2"]
        direction LR
        ConvTranspose2d2["ConvTranspose2d&lt;br&gt;512x256 x 4x4 / 2"]
        BN2["BatchNorm2d"]
        ReLU2["ReLU"]
        ConvTranspose2d2 --&gt; BN2 --&gt; ReLU2
    end

    %% Upsample Block 3
    subgraph UpsampleBlock3 ["Upsample Block 3"]
        direction LR
        ConvTranspose2d3["ConvTranspose2d&lt;br&gt;256x128 x 4x4 / 2"]
        BN3["BatchNorm2d"]
        ReLU3["ReLU"]
        ConvTranspose2d3 --&gt; BN3 --&gt; ReLU3
    end

    %% Upsample Block 4
    subgraph UpsampleBlock4 ["Upsample Block 4"]
        direction LR
        ConvTranspose2d4["ConvTranspose2d&lt;br&gt;128x64 x 4x4 / 2"]
        BN4["BatchNorm2d"]
        ReLU4["ReLU"]
        ConvTranspose2d4 --&gt; BN4 --&gt; ReLU4
    end

    %% Final Conv and Activation
    ConvTranspose2d5["ConvTranspose2dranspose2d&lt;br&gt;64x3 x 4x4 / 2"]
    Tanh["Tanh"]
    Output[("Generated Image&lt;br&gt;3@64x64")]

    %% Connections
    Input --&gt; Reshape
    Reshape --&gt; UpsampleBlock1
    UpsampleBlock1 --&gt; |512 @4x4| UpsampleBlock2
    UpsampleBlock2 --&gt; |256 @8x8| UpsampleBlock3
    UpsampleBlock3 --&gt; |128 @16x16| UpsampleBlock4
    UpsampleBlock4 --&gt; |64 @32x32| ConvTranspose2d5
    ConvTranspose2d5 --&gt; Tanh --&gt; Output

    %% Styling
    class Input input;
    class Output output;
    class UpsampleBlock1,UpsampleBlock2,UpsampleBlock3,UpsampleBlock4 deconvBlock;</code></pre>
<p>下面是判别器模块。</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef convBlock fill:#1e1e2e,stroke:#f9e2af,stroke-width:1px,color:#f9e2af;

    %% Input
    Input[("Input Image&lt;br&gt;3@64x64")]

    %% Downsample Block 1
    subgraph DownsampleBlock1 ["Downsample Block 1"]
        direction LR
        Conv1["Conv2d&lt;br&gt;3x64 x 4x4 / 2"]
        LReLU1["LeakyReLU(0.2)"]
        Conv1 --&gt; LReLU1
    end

    %% Downsample Block 2
    subgraph DownsampleBlock2 ["Downsample Block 2"]
        direction LR
        Conv2["Conv2d&lt;br&gt;64x128 x 4x4 / 2"]
        BN2["BatchNorm2d"]
        LReLU2["LeakyReLU(0.2)"]
        Conv2 --&gt; BN2 --&gt; LReLU2
    end

    %% Downsample Block 3
    subgraph DownsampleBlock3 ["Downsample Block 3"]
        direction LR
        Conv3["Conv2d&lt;br&gt;128x256 x 4x4 / 2"]
        BN3["BatchNorm2d"]
        LReLU3["LeakyReLU(0.2)"]
        Conv3 --&gt; BN3 --&gt; LReLU3
    end

    %% Downsample Block 4
    subgraph DownsampleBlock4 ["Downsample Block 4"]
        direction LR
        Conv4["Conv2d&lt;br&gt;256x512 x 4x4 / 2"]
        BN4["BatchNorm2d"]
        LReLU4["LeakyReLU(0.2)"]
        Conv4 --&gt; BN4 --&gt; LReLU4
    end

    %% Final Conv and Activation
    Conv5["Conv2d&lt;br&gt;512x1 x 4x4 / 4"]
    Sigmoid["Sigmoid"]
    Output[("Output Probability&lt;br&gt;Scalar")]

    %% Connections
    Input --&gt; DownsampleBlock1
    DownsampleBlock1 --&gt; |64 @32x32| DownsampleBlock2
    DownsampleBlock2 --&gt; |128 @16x16| DownsampleBlock3
    DownsampleBlock3 --&gt; |256 @8x8| DownsampleBlock4
    DownsampleBlock4 --&gt; |512 @4x4| Conv5
    Conv5 --&gt; |1 @1x1| Sigmoid --&gt; Output

    %% Styling
    class Input input;
    class Output output;
    class DownsampleBlock1,DownsampleBlock2,DownsampleBlock3,DownsampleBlock4 convBlock;</code></pre>
<p>可见，这里的生成器和判别器都是<strong>全卷积网络</strong>，并且都使用了 BatchNorm2d 来稳定梯度。全卷积的作用在于不会因为池化的降采样而损失细节。</p>
<p>下面放出代码：</p>
<details>
<summary> 训练 DC-GAN 使用的代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">  1</a></span>
<span class="normal"><a href="#__codelineno-26-2">  2</a></span>
<span class="normal"><a href="#__codelineno-26-3">  3</a></span>
<span class="normal"><a href="#__codelineno-26-4">  4</a></span>
<span class="normal"><a href="#__codelineno-26-5">  5</a></span>
<span class="normal"><a href="#__codelineno-26-6">  6</a></span>
<span class="normal"><a href="#__codelineno-26-7">  7</a></span>
<span class="normal"><a href="#__codelineno-26-8">  8</a></span>
<span class="normal"><a href="#__codelineno-26-9">  9</a></span>
<span class="normal"><a href="#__codelineno-26-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-26-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-26-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-26-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-26-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-26-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-26-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-26-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-26-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-26-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-26-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-26-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-26-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-26-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-26-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-26-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-26-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-26-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-26-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-26-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-26-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-26-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-26-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-26-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-26-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-26-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-26-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-26-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-26-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-26-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-26-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-26-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-26-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-26-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-26-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-26-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-26-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-26-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-26-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-26-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-26-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-26-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-26-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-26-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-26-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-26-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-26-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-26-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-26-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-26-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-26-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-26-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-26-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-26-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-26-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-26-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-26-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-26-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-26-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-26-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-26-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-26-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-26-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-26-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-26-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-26-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-26-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-26-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-26-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-26-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-26-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-26-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-26-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-26-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-26-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-26-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-26-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-26-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-26-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-26-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-26-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-26-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-26-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-26-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-26-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-26-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-26-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-26-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-26-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-26-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-26-100">100</a></span>
<span class="normal"><a href="#__codelineno-26-101">101</a></span>
<span class="normal"><a href="#__codelineno-26-102">102</a></span>
<span class="normal"><a href="#__codelineno-26-103">103</a></span>
<span class="normal"><a href="#__codelineno-26-104">104</a></span>
<span class="normal"><a href="#__codelineno-26-105">105</a></span>
<span class="normal"><a href="#__codelineno-26-106">106</a></span>
<span class="normal"><a href="#__codelineno-26-107">107</a></span>
<span class="normal"><a href="#__codelineno-26-108">108</a></span>
<span class="normal"><a href="#__codelineno-26-109">109</a></span>
<span class="normal"><a href="#__codelineno-26-110">110</a></span>
<span class="normal"><a href="#__codelineno-26-111">111</a></span>
<span class="normal"><a href="#__codelineno-26-112">112</a></span>
<span class="normal"><a href="#__codelineno-26-113">113</a></span>
<span class="normal"><a href="#__codelineno-26-114">114</a></span>
<span class="normal"><a href="#__codelineno-26-115">115</a></span>
<span class="normal"><a href="#__codelineno-26-116">116</a></span>
<span class="normal"><a href="#__codelineno-26-117">117</a></span>
<span class="normal"><a href="#__codelineno-26-118">118</a></span>
<span class="normal"><a href="#__codelineno-26-119">119</a></span>
<span class="normal"><a href="#__codelineno-26-120">120</a></span>
<span class="normal"><a href="#__codelineno-26-121">121</a></span>
<span class="normal"><a href="#__codelineno-26-122">122</a></span>
<span class="normal"><a href="#__codelineno-26-123">123</a></span>
<span class="normal"><a href="#__codelineno-26-124">124</a></span>
<span class="normal"><a href="#__codelineno-26-125">125</a></span>
<span class="normal"><a href="#__codelineno-26-126">126</a></span>
<span class="normal"><a href="#__codelineno-26-127">127</a></span>
<span class="normal"><a href="#__codelineno-26-128">128</a></span>
<span class="normal"><a href="#__codelineno-26-129">129</a></span>
<span class="normal"><a href="#__codelineno-26-130">130</a></span>
<span class="normal"><a href="#__codelineno-26-131">131</a></span>
<span class="normal"><a href="#__codelineno-26-132">132</a></span>
<span class="normal"><a href="#__codelineno-26-133">133</a></span>
<span class="normal"><a href="#__codelineno-26-134">134</a></span>
<span class="normal"><a href="#__codelineno-26-135">135</a></span>
<span class="normal"><a href="#__codelineno-26-136">136</a></span>
<span class="normal"><a href="#__codelineno-26-137">137</a></span>
<span class="normal"><a href="#__codelineno-26-138">138</a></span>
<span class="normal"><a href="#__codelineno-26-139">139</a></span>
<span class="normal"><a href="#__codelineno-26-140">140</a></span>
<span class="normal"><a href="#__codelineno-26-141">141</a></span>
<span class="normal"><a href="#__codelineno-26-142">142</a></span>
<span class="normal"><a href="#__codelineno-26-143">143</a></span>
<span class="normal"><a href="#__codelineno-26-144">144</a></span>
<span class="normal"><a href="#__codelineno-26-145">145</a></span>
<span class="normal"><a href="#__codelineno-26-146">146</a></span>
<span class="normal"><a href="#__codelineno-26-147">147</a></span>
<span class="normal"><a href="#__codelineno-26-148">148</a></span>
<span class="normal"><a href="#__codelineno-26-149">149</a></span>
<span class="normal"><a href="#__codelineno-26-150">150</a></span>
<span class="normal"><a href="#__codelineno-26-151">151</a></span>
<span class="normal"><a href="#__codelineno-26-152">152</a></span>
<span class="normal"><a href="#__codelineno-26-153">153</a></span>
<span class="normal"><a href="#__codelineno-26-154">154</a></span>
<span class="normal"><a href="#__codelineno-26-155">155</a></span>
<span class="normal"><a href="#__codelineno-26-156">156</a></span>
<span class="normal"><a href="#__codelineno-26-157">157</a></span>
<span class="normal"><a href="#__codelineno-26-158">158</a></span>
<span class="normal"><a href="#__codelineno-26-159">159</a></span>
<span class="normal"><a href="#__codelineno-26-160">160</a></span>
<span class="normal"><a href="#__codelineno-26-161">161</a></span>
<span class="normal"><a href="#__codelineno-26-162">162</a></span>
<span class="normal"><a href="#__codelineno-26-163">163</a></span>
<span class="normal"><a href="#__codelineno-26-164">164</a></span>
<span class="normal"><a href="#__codelineno-26-165">165</a></span>
<span class="normal"><a href="#__codelineno-26-166">166</a></span>
<span class="normal"><a href="#__codelineno-26-167">167</a></span>
<span class="normal"><a href="#__codelineno-26-168">168</a></span>
<span class="normal"><a href="#__codelineno-26-169">169</a></span>
<span class="normal"><a href="#__codelineno-26-170">170</a></span>
<span class="normal"><a href="#__codelineno-26-171">171</a></span>
<span class="normal"><a href="#__codelineno-26-172">172</a></span>
<span class="normal"><a href="#__codelineno-26-173">173</a></span>
<span class="normal"><a href="#__codelineno-26-174">174</a></span>
<span class="normal"><a href="#__codelineno-26-175">175</a></span>
<span class="normal"><a href="#__codelineno-26-176">176</a></span>
<span class="normal"><a href="#__codelineno-26-177">177</a></span>
<span class="normal"><a href="#__codelineno-26-178">178</a></span>
<span class="normal"><a href="#__codelineno-26-179">179</a></span>
<span class="normal"><a href="#__codelineno-26-180">180</a></span>
<span class="normal"><a href="#__codelineno-26-181">181</a></span>
<span class="normal"><a href="#__codelineno-26-182">182</a></span>
<span class="normal"><a href="#__codelineno-26-183">183</a></span>
<span class="normal"><a href="#__codelineno-26-184">184</a></span>
<span class="normal"><a href="#__codelineno-26-185">185</a></span>
<span class="normal"><a href="#__codelineno-26-186">186</a></span>
<span class="normal"><a href="#__codelineno-26-187">187</a></span>
<span class="normal"><a href="#__codelineno-26-188">188</a></span>
<span class="normal"><a href="#__codelineno-26-189">189</a></span>
<span class="normal"><a href="#__codelineno-26-190">190</a></span>
<span class="normal"><a href="#__codelineno-26-191">191</a></span>
<span class="normal"><a href="#__codelineno-26-192">192</a></span>
<span class="normal"><a href="#__codelineno-26-193">193</a></span>
<span class="normal"><a href="#__codelineno-26-194">194</a></span>
<span class="normal"><a href="#__codelineno-26-195">195</a></span>
<span class="normal"><a href="#__codelineno-26-196">196</a></span>
<span class="normal"><a href="#__codelineno-26-197">197</a></span>
<span class="normal"><a href="#__codelineno-26-198">198</a></span>
<span class="normal"><a href="#__codelineno-26-199">199</a></span>
<span class="normal"><a href="#__codelineno-26-200">200</a></span>
<span class="normal"><a href="#__codelineno-26-201">201</a></span>
<span class="normal"><a href="#__codelineno-26-202">202</a></span>
<span class="normal"><a href="#__codelineno-26-203">203</a></span>
<span class="normal"><a href="#__codelineno-26-204">204</a></span>
<span class="normal"><a href="#__codelineno-26-205">205</a></span>
<span class="normal"><a href="#__codelineno-26-206">206</a></span>
<span class="normal"><a href="#__codelineno-26-207">207</a></span>
<span class="normal"><a href="#__codelineno-26-208">208</a></span>
<span class="normal"><a href="#__codelineno-26-209">209</a></span>
<span class="normal"><a href="#__codelineno-26-210">210</a></span>
<span class="normal"><a href="#__codelineno-26-211">211</a></span>
<span class="normal"><a href="#__codelineno-26-212">212</a></span>
<span class="normal"><a href="#__codelineno-26-213">213</a></span>
<span class="normal"><a href="#__codelineno-26-214">214</a></span>
<span class="normal"><a href="#__codelineno-26-215">215</a></span>
<span class="normal"><a href="#__codelineno-26-216">216</a></span>
<span class="normal"><a href="#__codelineno-26-217">217</a></span>
<span class="normal"><a href="#__codelineno-26-218">218</a></span>
<span class="normal"><a href="#__codelineno-26-219">219</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_grid</span><span class="p">,</span> <span class="n">save_image</span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a>
<a id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-26-15" name="__codelineno-26-15"></a>    <span class="s2">"METHOD_NAME"</span><span class="p">:</span> <span class="s2">"DC-GAN"</span><span class="p">,</span>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a>    <span class="s2">"LATENT_DIM"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-26-17" name="__codelineno-26-17"></a>    <span class="s2">"BATCH_SIZE"</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
<a id="__codelineno-26-18" name="__codelineno-26-18"></a>    <span class="s2">"EPOCHS"</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-26-19" name="__codelineno-26-19"></a>    <span class="s2">"LR"</span><span class="p">:</span> <span class="mf">2e-4</span><span class="p">,</span>
<a id="__codelineno-26-20" name="__codelineno-26-20"></a>    <span class="s2">"BETA1"</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Adam优化器的beta1参数</span>
<a id="__codelineno-26-21" name="__codelineno-26-21"></a>    <span class="s2">"DEVICE"</span><span class="p">:</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span><span class="p">,</span>
<a id="__codelineno-26-22" name="__codelineno-26-22"></a>    <span class="s2">"DATA_PATH"</span><span class="p">:</span> <span class="s2">"./data"</span><span class="p">,</span>
<a id="__codelineno-26-23" name="__codelineno-26-23"></a>    <span class="s2">"OUTPUT_PATH"</span><span class="p">:</span> <span class="s2">"./output"</span>
<a id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="p">}</span>
<a id="__codelineno-26-25" name="__codelineno-26-25"></a><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"OUTPUT_PATH"</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">"METHOD_NAME"</span><span class="p">])</span>
<a id="__codelineno-26-26" name="__codelineno-26-26"></a><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-26-27" name="__codelineno-26-27"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using device: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'DEVICE'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-26-28" name="__codelineno-26-28"></a>
<a id="__codelineno-26-29" name="__codelineno-26-29"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">dataloader</span>
<a id="__codelineno-26-30" name="__codelineno-26-30"></a>
<a id="__codelineno-26-31" name="__codelineno-26-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">Generator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-26-32" name="__codelineno-26-32"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">):</span>
<a id="__codelineno-26-33" name="__codelineno-26-33"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Generator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-26-34" name="__codelineno-26-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span> <span class="o">=</span> <span class="n">latent_dim</span>
<a id="__codelineno-26-35" name="__codelineno-26-35"></a>
<a id="__codelineno-26-36" name="__codelineno-26-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-26-37" name="__codelineno-26-37"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">latent_dim</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-26-38" name="__codelineno-26-38"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<a id="__codelineno-26-39" name="__codelineno-26-39"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-26-40" name="__codelineno-26-40"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-26-41" name="__codelineno-26-41"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<a id="__codelineno-26-42" name="__codelineno-26-42"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-26-43" name="__codelineno-26-43"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-26-44" name="__codelineno-26-44"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<a id="__codelineno-26-45" name="__codelineno-26-45"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-26-46" name="__codelineno-26-46"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-26-47" name="__codelineno-26-47"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
<a id="__codelineno-26-48" name="__codelineno-26-48"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-26-49" name="__codelineno-26-49"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-26-50" name="__codelineno-26-50"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span>
<a id="__codelineno-26-51" name="__codelineno-26-51"></a>        <span class="p">)</span>
<a id="__codelineno-26-52" name="__codelineno-26-52"></a>
<a id="__codelineno-26-53" name="__codelineno-26-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<a id="__codelineno-26-54" name="__codelineno-26-54"></a>        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-26-55" name="__codelineno-26-55"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-26-56" name="__codelineno-26-56"></a>
<a id="__codelineno-26-57" name="__codelineno-26-57"></a>
<a id="__codelineno-26-58" name="__codelineno-26-58"></a><span class="k">class</span><span class="w"> </span><span class="nc">Discriminator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-26-59" name="__codelineno-26-59"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-26-60" name="__codelineno-26-60"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Discriminator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-26-61" name="__codelineno-26-61"></a>
<a id="__codelineno-26-62" name="__codelineno-26-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-26-63" name="__codelineno-26-63"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-26-64" name="__codelineno-26-64"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-26-65" name="__codelineno-26-65"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-26-66" name="__codelineno-26-66"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<a id="__codelineno-26-67" name="__codelineno-26-67"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-26-68" name="__codelineno-26-68"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-26-69" name="__codelineno-26-69"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<a id="__codelineno-26-70" name="__codelineno-26-70"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-26-71" name="__codelineno-26-71"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-26-72" name="__codelineno-26-72"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<a id="__codelineno-26-73" name="__codelineno-26-73"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-26-74" name="__codelineno-26-74"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-26-75" name="__codelineno-26-75"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
<a id="__codelineno-26-76" name="__codelineno-26-76"></a>        <span class="p">)</span>
<a id="__codelineno-26-77" name="__codelineno-26-77"></a>
<a id="__codelineno-26-78" name="__codelineno-26-78"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<a id="__codelineno-26-79" name="__codelineno-26-79"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-26-80" name="__codelineno-26-80"></a>
<a id="__codelineno-26-81" name="__codelineno-26-81"></a><span class="c1"># --- 3. 初始化模型和优化器 ---</span>
<a id="__codelineno-26-82" name="__codelineno-26-82"></a><span class="k">def</span><span class="w"> </span><span class="nf">weights_init</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<a id="__codelineno-26-83" name="__codelineno-26-83"></a>    <span class="n">classname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
<a id="__codelineno-26-84" name="__codelineno-26-84"></a>    <span class="k">if</span> <span class="n">classname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'Conv'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-26-85" name="__codelineno-26-85"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
<a id="__codelineno-26-86" name="__codelineno-26-86"></a>    <span class="k">elif</span> <span class="n">classname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'BatchNorm'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-26-87" name="__codelineno-26-87"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
<a id="__codelineno-26-88" name="__codelineno-26-88"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-26-89" name="__codelineno-26-89"></a>
<a id="__codelineno-26-90" name="__codelineno-26-90"></a><span class="c1"># --- 4. 训练循环 ---</span>
<a id="__codelineno-26-91" name="__codelineno-26-91"></a><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">discriminator</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">g_optimizer</span><span class="p">,</span> <span class="n">d_optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<a id="__codelineno-26-92" name="__codelineno-26-92"></a>    <span class="n">generator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-26-93" name="__codelineno-26-93"></a>    <span class="n">discriminator</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-26-94" name="__codelineno-26-94"></a>
<a id="__codelineno-26-95" name="__codelineno-26-95"></a>    <span class="n">real_label</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-26-96" name="__codelineno-26-96"></a>    <span class="n">fake_label</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-26-97" name="__codelineno-26-97"></a>
<a id="__codelineno-26-98" name="__codelineno-26-98"></a>    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">'EPOCHS'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-26-99" name="__codelineno-26-99"></a>
<a id="__codelineno-26-100" name="__codelineno-26-100"></a>    <span class="n">d_losses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-26-101" name="__codelineno-26-101"></a>    <span class="n">g_losses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-26-102" name="__codelineno-26-102"></a>
<a id="__codelineno-26-103" name="__codelineno-26-103"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pbar</span><span class="p">):</span>
<a id="__codelineno-26-104" name="__codelineno-26-104"></a>        <span class="c1"># 训练判别器</span>
<a id="__codelineno-26-105" name="__codelineno-26-105"></a>        <span class="c1"># 使用真实图像</span>
<a id="__codelineno-26-106" name="__codelineno-26-106"></a>        <span class="n">real_images</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-26-107" name="__codelineno-26-107"></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">real_images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-26-108" name="__codelineno-26-108"></a>        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">real_label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-26-109" name="__codelineno-26-109"></a>
<a id="__codelineno-26-110" name="__codelineno-26-110"></a>        <span class="n">discriminator</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-26-111" name="__codelineno-26-111"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="n">real_images</span><span class="p">)</span>
<a id="__codelineno-26-112" name="__codelineno-26-112"></a>        <span class="n">errD_real</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
<a id="__codelineno-26-113" name="__codelineno-26-113"></a>        <span class="n">errD_real</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-26-114" name="__codelineno-26-114"></a>        <span class="n">D_x</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-26-115" name="__codelineno-26-115"></a>
<a id="__codelineno-26-116" name="__codelineno-26-116"></a>        <span class="c1"># 使用生成图像</span>
<a id="__codelineno-26-117" name="__codelineno-26-117"></a>        <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">"LATENT_DIM"</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-26-118" name="__codelineno-26-118"></a>        <span class="n">fake_images</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>
<a id="__codelineno-26-119" name="__codelineno-26-119"></a>        <span class="n">label</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">fake_label</span><span class="p">)</span>
<a id="__codelineno-26-120" name="__codelineno-26-120"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="n">fake_images</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
<a id="__codelineno-26-121" name="__codelineno-26-121"></a>        <span class="n">errD_fake</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
<a id="__codelineno-26-122" name="__codelineno-26-122"></a>        <span class="n">errD_fake</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-26-123" name="__codelineno-26-123"></a>        <span class="n">D_G_z1</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-26-124" name="__codelineno-26-124"></a>        <span class="n">errD</span> <span class="o">=</span> <span class="n">errD_real</span> <span class="o">+</span> <span class="n">errD_fake</span>
<a id="__codelineno-26-125" name="__codelineno-26-125"></a>        <span class="n">d_optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-26-126" name="__codelineno-26-126"></a>
<a id="__codelineno-26-127" name="__codelineno-26-127"></a>        <span class="c1"># 训练生成器</span>
<a id="__codelineno-26-128" name="__codelineno-26-128"></a>        <span class="n">generator</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-26-129" name="__codelineno-26-129"></a>        <span class="n">label</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">real_label</span><span class="p">)</span>  <span class="c1"># 生成器希望判别器将假图像判断为真</span>
<a id="__codelineno-26-130" name="__codelineno-26-130"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="n">fake_images</span><span class="p">)</span>
<a id="__codelineno-26-131" name="__codelineno-26-131"></a>        <span class="n">errG</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
<a id="__codelineno-26-132" name="__codelineno-26-132"></a>        <span class="n">errG</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-26-133" name="__codelineno-26-133"></a>        <span class="n">D_G_z2</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-26-134" name="__codelineno-26-134"></a>        <span class="n">g_optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-26-135" name="__codelineno-26-135"></a>
<a id="__codelineno-26-136" name="__codelineno-26-136"></a>        <span class="c1"># 记录损失</span>
<a id="__codelineno-26-137" name="__codelineno-26-137"></a>        <span class="n">d_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errD</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-26-138" name="__codelineno-26-138"></a>        <span class="n">g_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errG</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-26-139" name="__codelineno-26-139"></a>
<a id="__codelineno-26-140" name="__codelineno-26-140"></a>        <span class="c1"># 更新进度条</span>
<a id="__codelineno-26-141" name="__codelineno-26-141"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-26-142" name="__codelineno-26-142"></a>            <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span>
<a id="__codelineno-26-143" name="__codelineno-26-143"></a>                <span class="s1">'D_loss'</span><span class="p">:</span> <span class="n">errD</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> 
<a id="__codelineno-26-144" name="__codelineno-26-144"></a>                <span class="s1">'G_loss'</span><span class="p">:</span> <span class="n">errG</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
<a id="__codelineno-26-145" name="__codelineno-26-145"></a>                <span class="s1">'D(x)'</span><span class="p">:</span> <span class="n">D_x</span><span class="p">,</span>
<a id="__codelineno-26-146" name="__codelineno-26-146"></a>                <span class="s1">'D(G(z))'</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">D_G_z1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">D_G_z2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-26-147" name="__codelineno-26-147"></a>            <span class="p">})</span>
<a id="__codelineno-26-148" name="__codelineno-26-148"></a>
<a id="__codelineno-26-149" name="__codelineno-26-149"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d_losses</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">g_losses</span><span class="p">)</span>
<a id="__codelineno-26-150" name="__codelineno-26-150"></a>
<a id="__codelineno-26-151" name="__codelineno-26-151"></a><span class="c1"># --- 5. 生成函数 ---</span>
<a id="__codelineno-26-152" name="__codelineno-26-152"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_and_save_images</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
<a id="__codelineno-26-153" name="__codelineno-26-153"></a>    <span class="n">generator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-26-154" name="__codelineno-26-154"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-26-155" name="__codelineno-26-155"></a>        <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">"LATENT_DIM"</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-26-156" name="__codelineno-26-156"></a>        <span class="n">generated_images</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-26-157" name="__codelineno-26-157"></a>        <span class="n">grid</span> <span class="o">=</span> <span class="n">make_grid</span><span class="p">(</span><span class="n">generated_images</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-26-158" name="__codelineno-26-158"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-26-159" name="__codelineno-26-159"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-26-160" name="__codelineno-26-160"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<a id="__codelineno-26-161" name="__codelineno-26-161"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Generated Images from DC-GAN"</span><span class="p">)</span>
<a id="__codelineno-26-162" name="__codelineno-26-162"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
<a id="__codelineno-26-163" name="__codelineno-26-163"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-26-164" name="__codelineno-26-164"></a>
<a id="__codelineno-26-165" name="__codelineno-26-165"></a>        <span class="c1"># 同时保存图像文件</span>
<a id="__codelineno-26-166" name="__codelineno-26-166"></a>        <span class="n">save_image</span><span class="p">(</span><span class="n">generated_images</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"generated_samples.png"</span><span class="p">),</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-26-167" name="__codelineno-26-167"></a>
<a id="__codelineno-26-168" name="__codelineno-26-168"></a><span class="c1"># --- 6. 训练指标绘图 ---</span>
<a id="__codelineno-26-169" name="__codelineno-26-169"></a><span class="k">def</span><span class="w"> </span><span class="nf">loss_visualization</span><span class="p">(</span><span class="n">d_losses</span><span class="p">,</span> <span class="n">g_losses</span><span class="p">):</span>
<a id="__codelineno-26-170" name="__codelineno-26-170"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a id="__codelineno-26-171" name="__codelineno-26-171"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Discriminator Loss'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">)</span>
<a id="__codelineno-26-172" name="__codelineno-26-172"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Generator Loss'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">)</span>
<a id="__codelineno-26-173" name="__codelineno-26-173"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'DC-GAN Training Loss'</span><span class="p">)</span>
<a id="__codelineno-26-174" name="__codelineno-26-174"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Epoch'</span><span class="p">)</span>
<a id="__codelineno-26-175" name="__codelineno-26-175"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Loss'</span><span class="p">)</span>
<a id="__codelineno-26-176" name="__codelineno-26-176"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-26-177" name="__codelineno-26-177"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"training_loss.png"</span><span class="p">))</span>
<a id="__codelineno-26-178" name="__codelineno-26-178"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-26-179" name="__codelineno-26-179"></a>
<a id="__codelineno-26-180" name="__codelineno-26-180"></a><span class="c1"># --- 主程序 ---</span>
<a id="__codelineno-26-181" name="__codelineno-26-181"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-26-182" name="__codelineno-26-182"></a>    <span class="c1"># 初始化模型</span>
<a id="__codelineno-26-183" name="__codelineno-26-183"></a>    <span class="n">generator</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="n">latent_dim</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LATENT_DIM"</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-26-184" name="__codelineno-26-184"></a>    <span class="n">discriminator</span> <span class="o">=</span> <span class="n">Discriminator</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"DEVICE"</span><span class="p">])</span>
<a id="__codelineno-26-185" name="__codelineno-26-185"></a>
<a id="__codelineno-26-186" name="__codelineno-26-186"></a>    <span class="c1"># 应用权重初始化</span>
<a id="__codelineno-26-187" name="__codelineno-26-187"></a>    <span class="n">generator</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">weights_init</span><span class="p">)</span>
<a id="__codelineno-26-188" name="__codelineno-26-188"></a>    <span class="n">discriminator</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">weights_init</span><span class="p">)</span>
<a id="__codelineno-26-189" name="__codelineno-26-189"></a>
<a id="__codelineno-26-190" name="__codelineno-26-190"></a>    <span class="c1"># 初始化优化器</span>
<a id="__codelineno-26-191" name="__codelineno-26-191"></a>    <span class="n">g_optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LR"</span><span class="p">],</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"BETA1"</span><span class="p">],</span> <span class="mf">0.999</span><span class="p">))</span>
<a id="__codelineno-26-192" name="__codelineno-26-192"></a>    <span class="n">d_optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">discriminator</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">"LR"</span><span class="p">],</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"BETA1"</span><span class="p">],</span> <span class="mf">0.999</span><span class="p">))</span>
<a id="__codelineno-26-193" name="__codelineno-26-193"></a>
<a id="__codelineno-26-194" name="__codelineno-26-194"></a>    <span class="c1"># 用于存储损失</span>
<a id="__codelineno-26-195" name="__codelineno-26-195"></a>    <span class="n">d_losses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-26-196" name="__codelineno-26-196"></a>    <span class="n">g_losses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-26-197" name="__codelineno-26-197"></a>
<a id="__codelineno-26-198" name="__codelineno-26-198"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"--- Training DC-GAN Model ---"</span><span class="p">)</span>
<a id="__codelineno-26-199" name="__codelineno-26-199"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">"EPOCHS"</span><span class="p">]):</span>
<a id="__codelineno-26-200" name="__codelineno-26-200"></a>        <span class="n">d_loss</span><span class="p">,</span> <span class="n">g_loss</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">discriminator</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">g_optimizer</span><span class="p">,</span> <span class="n">d_optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
<a id="__codelineno-26-201" name="__codelineno-26-201"></a>        <span class="n">d_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_loss</span><span class="p">)</span>
<a id="__codelineno-26-202" name="__codelineno-26-202"></a>        <span class="n">g_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g_loss</span><span class="p">)</span>
<a id="__codelineno-26-203" name="__codelineno-26-203"></a>
<a id="__codelineno-26-204" name="__codelineno-26-204"></a>        <span class="c1"># 每5个epoch保存一次生成图像</span>
<a id="__codelineno-26-205" name="__codelineno-26-205"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-26-206" name="__codelineno-26-206"></a>            <span class="n">gen_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"generated_images_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
<a id="__codelineno-26-207" name="__codelineno-26-207"></a>            <span class="n">generate_and_save_images</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">gen_save_path</span><span class="p">)</span>
<a id="__codelineno-26-208" name="__codelineno-26-208"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"generator_</span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pth"</span><span class="p">))</span>
<a id="__codelineno-26-209" name="__codelineno-26-209"></a>
<a id="__codelineno-26-210" name="__codelineno-26-210"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- Generating Images from Trained DC-GAN ---"</span><span class="p">)</span>
<a id="__codelineno-26-211" name="__codelineno-26-211"></a>    <span class="n">gen_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"final_generated_images.png"</span><span class="p">)</span>
<a id="__codelineno-26-212" name="__codelineno-26-212"></a>    <span class="n">generate_and_save_images</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">gen_save_path</span><span class="p">)</span>
<a id="__codelineno-26-213" name="__codelineno-26-213"></a>
<a id="__codelineno-26-214" name="__codelineno-26-214"></a>    <span class="c1"># 保存模型</span>
<a id="__codelineno-26-215" name="__codelineno-26-215"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"generator.pth"</span><span class="p">))</span>
<a id="__codelineno-26-216" name="__codelineno-26-216"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">discriminator</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"discriminator.pth"</span><span class="p">))</span>
<a id="__codelineno-26-217" name="__codelineno-26-217"></a>
<a id="__codelineno-26-218" name="__codelineno-26-218"></a>    <span class="c1"># 绘制损失曲线</span>
<a id="__codelineno-26-219" name="__codelineno-26-219"></a>    <span class="n">loss_visualization</span><span class="p">(</span><span class="n">d_losses</span><span class="p">,</span> <span class="n">g_losses</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<p>跑了 50 个 Epoch，损失曲线如下：</p>
<p><img alt="loss curve" src="../Image-models-replication-assets/training_loss.png"/></p>
<p>生成的图像随着 Epoch 变化如下：</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Epoch</th>
<th style="text-align: center;">5</th>
<th style="text-align: center;">10</th>
<th style="text-align: center;">20</th>
<th style="text-align: center;">30</th>
<th style="text-align: center;">40</th>
<th style="text-align: center;">50</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">生成图像</td>
<td style="text-align: center;"><img alt="image" src="../Image-models-replication-assets/generated_images_epoch_5.png"/></td>
<td style="text-align: center;"><img alt="image" src="../Image-models-replication-assets/generated_images_epoch_10.png"/></td>
<td style="text-align: center;"><img alt="image" src="../Image-models-replication-assets/generated_images_epoch_20.png"/></td>
<td style="text-align: center;"><img alt="image" src="../Image-models-replication-assets/generated_images_epoch_30.png"/></td>
<td style="text-align: center;"><img alt="image" src="../Image-models-replication-assets/generated_images_epoch_40.png"/></td>
<td style="text-align: center;"><img alt="image" src="../Image-models-replication-assets/generated_images_epoch_50.png"/></td>
</tr>
</tbody>
</table>
<p>50 个 Epoch 后的图像：</p>
<p><img alt="image" src="../Image-models-replication-assets/generated_images_epoch_50.png"/></p>
<p>可以看到损失下降的同时，图像也越来越有模有样，同时也不“糊”了。</p>
<p>为了演示这个模型，我做了一个 demo，就部署在本博客上面：<a href="https://dicaeopolis.github.io/DNN/model-expr/DC-GAN-%E8%80%81%E5%A9%86%E7%94%9F%E6%88%90%E5%99%A8/">老婆生成器</a>。推理使用的是 TensorFlow.js，完全在网页端进行的推理。加载模型需要一段时间，因为训练用图像都是 64x64 的，因此不会吃太多性能。</p>
<p>下面让我们看看怎么用 GAN 做分类吧。</p>
<h3 id="ac-gan">AC-GAN 分类<a class="headerlink" href="#ac-gan" title="Permanent link">¶</a></h3>
<p>AC-GAN 是我们遇到的第二个 T2I 模型。其核心思想和 CVAE 差不多：首先在采样生成的时候，同时拼接一个标签信息，最后在判别的时候，在输出真伪概率的同时，也输出分类结果。这样，通过人为控制标签，就可以实现条件生成。对于损失函数，加上分类损失即可。</p>
<ul>
<li>判别器的损失：</li>
</ul>
<div class="arithmatex">\[
\begin{align*}
\mathcal L_D=&amp; - \mathbb E_{x\sim p(x)}[\log D_{\mathrm{score}}(x)] + CE(D_{\mathrm{tag}}(x)||\mathrm{real\ tag}) \\&amp;- \mathbb E_{z\sim q(z)}[\log (1-D_{\mathrm{score}}(G(z)))] + CE(D_{\mathrm{tag}}(G(z))||\mathrm{fake\ tag})
\end{align*}
\]</div>
<ul>
<li>生成器的损失：</li>
</ul>
<div class="arithmatex">\[
\mathcal L_G=-\mathbb E_{z\sim q(z)}[\log D_{\mathrm{score}}(G(z))]+ CE(D_{\mathrm{tag}}(G(z))||\mathrm{fake\ tag})
\]</div>
<p>其中 <span class="arithmatex">\(D_{\mathrm{score}}\)</span> 是输出真伪概率的判别器，<span class="arithmatex">\(D_{\mathrm{tag}}\)</span> 是输出分类信息的分类判别器，<span class="arithmatex">\(CE\)</span> 是交叉熵损失，分类任务的标配。在实现上，可以共用一个特征提取的骨干网络，替换不同维度的投影头即可。</p>
<p>下面看看代码：</p>
<details>
<summary> AC-GAN 的初版训练代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">  1</a></span>
<span class="normal"><a href="#__codelineno-27-2">  2</a></span>
<span class="normal"><a href="#__codelineno-27-3">  3</a></span>
<span class="normal"><a href="#__codelineno-27-4">  4</a></span>
<span class="normal"><a href="#__codelineno-27-5">  5</a></span>
<span class="normal"><a href="#__codelineno-27-6">  6</a></span>
<span class="normal"><a href="#__codelineno-27-7">  7</a></span>
<span class="normal"><a href="#__codelineno-27-8">  8</a></span>
<span class="normal"><a href="#__codelineno-27-9">  9</a></span>
<span class="normal"><a href="#__codelineno-27-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-27-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-27-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-27-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-27-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-27-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-27-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-27-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-27-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-27-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-27-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-27-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-27-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-27-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-27-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-27-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-27-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-27-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-27-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-27-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-27-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-27-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-27-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-27-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-27-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-27-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-27-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-27-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-27-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-27-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-27-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-27-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-27-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-27-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-27-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-27-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-27-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-27-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-27-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-27-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-27-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-27-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-27-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-27-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-27-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-27-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-27-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-27-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-27-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-27-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-27-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-27-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-27-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-27-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-27-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-27-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-27-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-27-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-27-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-27-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-27-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-27-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-27-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-27-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-27-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-27-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-27-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-27-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-27-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-27-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-27-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-27-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-27-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-27-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-27-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-27-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-27-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-27-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-27-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-27-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-27-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-27-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-27-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-27-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-27-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-27-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-27-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-27-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-27-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-27-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-27-100">100</a></span>
<span class="normal"><a href="#__codelineno-27-101">101</a></span>
<span class="normal"><a href="#__codelineno-27-102">102</a></span>
<span class="normal"><a href="#__codelineno-27-103">103</a></span>
<span class="normal"><a href="#__codelineno-27-104">104</a></span>
<span class="normal"><a href="#__codelineno-27-105">105</a></span>
<span class="normal"><a href="#__codelineno-27-106">106</a></span>
<span class="normal"><a href="#__codelineno-27-107">107</a></span>
<span class="normal"><a href="#__codelineno-27-108">108</a></span>
<span class="normal"><a href="#__codelineno-27-109">109</a></span>
<span class="normal"><a href="#__codelineno-27-110">110</a></span>
<span class="normal"><a href="#__codelineno-27-111">111</a></span>
<span class="normal"><a href="#__codelineno-27-112">112</a></span>
<span class="normal"><a href="#__codelineno-27-113">113</a></span>
<span class="normal"><a href="#__codelineno-27-114">114</a></span>
<span class="normal"><a href="#__codelineno-27-115">115</a></span>
<span class="normal"><a href="#__codelineno-27-116">116</a></span>
<span class="normal"><a href="#__codelineno-27-117">117</a></span>
<span class="normal"><a href="#__codelineno-27-118">118</a></span>
<span class="normal"><a href="#__codelineno-27-119">119</a></span>
<span class="normal"><a href="#__codelineno-27-120">120</a></span>
<span class="normal"><a href="#__codelineno-27-121">121</a></span>
<span class="normal"><a href="#__codelineno-27-122">122</a></span>
<span class="normal"><a href="#__codelineno-27-123">123</a></span>
<span class="normal"><a href="#__codelineno-27-124">124</a></span>
<span class="normal"><a href="#__codelineno-27-125">125</a></span>
<span class="normal"><a href="#__codelineno-27-126">126</a></span>
<span class="normal"><a href="#__codelineno-27-127">127</a></span>
<span class="normal"><a href="#__codelineno-27-128">128</a></span>
<span class="normal"><a href="#__codelineno-27-129">129</a></span>
<span class="normal"><a href="#__codelineno-27-130">130</a></span>
<span class="normal"><a href="#__codelineno-27-131">131</a></span>
<span class="normal"><a href="#__codelineno-27-132">132</a></span>
<span class="normal"><a href="#__codelineno-27-133">133</a></span>
<span class="normal"><a href="#__codelineno-27-134">134</a></span>
<span class="normal"><a href="#__codelineno-27-135">135</a></span>
<span class="normal"><a href="#__codelineno-27-136">136</a></span>
<span class="normal"><a href="#__codelineno-27-137">137</a></span>
<span class="normal"><a href="#__codelineno-27-138">138</a></span>
<span class="normal"><a href="#__codelineno-27-139">139</a></span>
<span class="normal"><a href="#__codelineno-27-140">140</a></span>
<span class="normal"><a href="#__codelineno-27-141">141</a></span>
<span class="normal"><a href="#__codelineno-27-142">142</a></span>
<span class="normal"><a href="#__codelineno-27-143">143</a></span>
<span class="normal"><a href="#__codelineno-27-144">144</a></span>
<span class="normal"><a href="#__codelineno-27-145">145</a></span>
<span class="normal"><a href="#__codelineno-27-146">146</a></span>
<span class="normal"><a href="#__codelineno-27-147">147</a></span>
<span class="normal"><a href="#__codelineno-27-148">148</a></span>
<span class="normal"><a href="#__codelineno-27-149">149</a></span>
<span class="normal"><a href="#__codelineno-27-150">150</a></span>
<span class="normal"><a href="#__codelineno-27-151">151</a></span>
<span class="normal"><a href="#__codelineno-27-152">152</a></span>
<span class="normal"><a href="#__codelineno-27-153">153</a></span>
<span class="normal"><a href="#__codelineno-27-154">154</a></span>
<span class="normal"><a href="#__codelineno-27-155">155</a></span>
<span class="normal"><a href="#__codelineno-27-156">156</a></span>
<span class="normal"><a href="#__codelineno-27-157">157</a></span>
<span class="normal"><a href="#__codelineno-27-158">158</a></span>
<span class="normal"><a href="#__codelineno-27-159">159</a></span>
<span class="normal"><a href="#__codelineno-27-160">160</a></span>
<span class="normal"><a href="#__codelineno-27-161">161</a></span>
<span class="normal"><a href="#__codelineno-27-162">162</a></span>
<span class="normal"><a href="#__codelineno-27-163">163</a></span>
<span class="normal"><a href="#__codelineno-27-164">164</a></span>
<span class="normal"><a href="#__codelineno-27-165">165</a></span>
<span class="normal"><a href="#__codelineno-27-166">166</a></span>
<span class="normal"><a href="#__codelineno-27-167">167</a></span>
<span class="normal"><a href="#__codelineno-27-168">168</a></span>
<span class="normal"><a href="#__codelineno-27-169">169</a></span>
<span class="normal"><a href="#__codelineno-27-170">170</a></span>
<span class="normal"><a href="#__codelineno-27-171">171</a></span>
<span class="normal"><a href="#__codelineno-27-172">172</a></span>
<span class="normal"><a href="#__codelineno-27-173">173</a></span>
<span class="normal"><a href="#__codelineno-27-174">174</a></span>
<span class="normal"><a href="#__codelineno-27-175">175</a></span>
<span class="normal"><a href="#__codelineno-27-176">176</a></span>
<span class="normal"><a href="#__codelineno-27-177">177</a></span>
<span class="normal"><a href="#__codelineno-27-178">178</a></span>
<span class="normal"><a href="#__codelineno-27-179">179</a></span>
<span class="normal"><a href="#__codelineno-27-180">180</a></span>
<span class="normal"><a href="#__codelineno-27-181">181</a></span>
<span class="normal"><a href="#__codelineno-27-182">182</a></span>
<span class="normal"><a href="#__codelineno-27-183">183</a></span>
<span class="normal"><a href="#__codelineno-27-184">184</a></span>
<span class="normal"><a href="#__codelineno-27-185">185</a></span>
<span class="normal"><a href="#__codelineno-27-186">186</a></span>
<span class="normal"><a href="#__codelineno-27-187">187</a></span>
<span class="normal"><a href="#__codelineno-27-188">188</a></span>
<span class="normal"><a href="#__codelineno-27-189">189</a></span>
<span class="normal"><a href="#__codelineno-27-190">190</a></span>
<span class="normal"><a href="#__codelineno-27-191">191</a></span>
<span class="normal"><a href="#__codelineno-27-192">192</a></span>
<span class="normal"><a href="#__codelineno-27-193">193</a></span>
<span class="normal"><a href="#__codelineno-27-194">194</a></span>
<span class="normal"><a href="#__codelineno-27-195">195</a></span>
<span class="normal"><a href="#__codelineno-27-196">196</a></span>
<span class="normal"><a href="#__codelineno-27-197">197</a></span>
<span class="normal"><a href="#__codelineno-27-198">198</a></span>
<span class="normal"><a href="#__codelineno-27-199">199</a></span>
<span class="normal"><a href="#__codelineno-27-200">200</a></span>
<span class="normal"><a href="#__codelineno-27-201">201</a></span>
<span class="normal"><a href="#__codelineno-27-202">202</a></span>
<span class="normal"><a href="#__codelineno-27-203">203</a></span>
<span class="normal"><a href="#__codelineno-27-204">204</a></span>
<span class="normal"><a href="#__codelineno-27-205">205</a></span>
<span class="normal"><a href="#__codelineno-27-206">206</a></span>
<span class="normal"><a href="#__codelineno-27-207">207</a></span>
<span class="normal"><a href="#__codelineno-27-208">208</a></span>
<span class="normal"><a href="#__codelineno-27-209">209</a></span>
<span class="normal"><a href="#__codelineno-27-210">210</a></span>
<span class="normal"><a href="#__codelineno-27-211">211</a></span>
<span class="normal"><a href="#__codelineno-27-212">212</a></span>
<span class="normal"><a href="#__codelineno-27-213">213</a></span>
<span class="normal"><a href="#__codelineno-27-214">214</a></span>
<span class="normal"><a href="#__codelineno-27-215">215</a></span>
<span class="normal"><a href="#__codelineno-27-216">216</a></span>
<span class="normal"><a href="#__codelineno-27-217">217</a></span>
<span class="normal"><a href="#__codelineno-27-218">218</a></span>
<span class="normal"><a href="#__codelineno-27-219">219</a></span>
<span class="normal"><a href="#__codelineno-27-220">220</a></span>
<span class="normal"><a href="#__codelineno-27-221">221</a></span>
<span class="normal"><a href="#__codelineno-27-222">222</a></span>
<span class="normal"><a href="#__codelineno-27-223">223</a></span>
<span class="normal"><a href="#__codelineno-27-224">224</a></span>
<span class="normal"><a href="#__codelineno-27-225">225</a></span>
<span class="normal"><a href="#__codelineno-27-226">226</a></span>
<span class="normal"><a href="#__codelineno-27-227">227</a></span>
<span class="normal"><a href="#__codelineno-27-228">228</a></span>
<span class="normal"><a href="#__codelineno-27-229">229</a></span>
<span class="normal"><a href="#__codelineno-27-230">230</a></span>
<span class="normal"><a href="#__codelineno-27-231">231</a></span>
<span class="normal"><a href="#__codelineno-27-232">232</a></span>
<span class="normal"><a href="#__codelineno-27-233">233</a></span>
<span class="normal"><a href="#__codelineno-27-234">234</a></span>
<span class="normal"><a href="#__codelineno-27-235">235</a></span>
<span class="normal"><a href="#__codelineno-27-236">236</a></span>
<span class="normal"><a href="#__codelineno-27-237">237</a></span>
<span class="normal"><a href="#__codelineno-27-238">238</a></span>
<span class="normal"><a href="#__codelineno-27-239">239</a></span>
<span class="normal"><a href="#__codelineno-27-240">240</a></span>
<span class="normal"><a href="#__codelineno-27-241">241</a></span>
<span class="normal"><a href="#__codelineno-27-242">242</a></span>
<span class="normal"><a href="#__codelineno-27-243">243</a></span>
<span class="normal"><a href="#__codelineno-27-244">244</a></span>
<span class="normal"><a href="#__codelineno-27-245">245</a></span>
<span class="normal"><a href="#__codelineno-27-246">246</a></span>
<span class="normal"><a href="#__codelineno-27-247">247</a></span>
<span class="normal"><a href="#__codelineno-27-248">248</a></span>
<span class="normal"><a href="#__codelineno-27-249">249</a></span>
<span class="normal"><a href="#__codelineno-27-250">250</a></span>
<span class="normal"><a href="#__codelineno-27-251">251</a></span>
<span class="normal"><a href="#__codelineno-27-252">252</a></span>
<span class="normal"><a href="#__codelineno-27-253">253</a></span>
<span class="normal"><a href="#__codelineno-27-254">254</a></span>
<span class="normal"><a href="#__codelineno-27-255">255</a></span>
<span class="normal"><a href="#__codelineno-27-256">256</a></span>
<span class="normal"><a href="#__codelineno-27-257">257</a></span>
<span class="normal"><a href="#__codelineno-27-258">258</a></span>
<span class="normal"><a href="#__codelineno-27-259">259</a></span>
<span class="normal"><a href="#__codelineno-27-260">260</a></span>
<span class="normal"><a href="#__codelineno-27-261">261</a></span>
<span class="normal"><a href="#__codelineno-27-262">262</a></span>
<span class="normal"><a href="#__codelineno-27-263">263</a></span>
<span class="normal"><a href="#__codelineno-27-264">264</a></span>
<span class="normal"><a href="#__codelineno-27-265">265</a></span>
<span class="normal"><a href="#__codelineno-27-266">266</a></span>
<span class="normal"><a href="#__codelineno-27-267">267</a></span>
<span class="normal"><a href="#__codelineno-27-268">268</a></span>
<span class="normal"><a href="#__codelineno-27-269">269</a></span>
<span class="normal"><a href="#__codelineno-27-270">270</a></span>
<span class="normal"><a href="#__codelineno-27-271">271</a></span>
<span class="normal"><a href="#__codelineno-27-272">272</a></span>
<span class="normal"><a href="#__codelineno-27-273">273</a></span>
<span class="normal"><a href="#__codelineno-27-274">274</a></span>
<span class="normal"><a href="#__codelineno-27-275">275</a></span>
<span class="normal"><a href="#__codelineno-27-276">276</a></span>
<span class="normal"><a href="#__codelineno-27-277">277</a></span>
<span class="normal"><a href="#__codelineno-27-278">278</a></span>
<span class="normal"><a href="#__codelineno-27-279">279</a></span>
<span class="normal"><a href="#__codelineno-27-280">280</a></span>
<span class="normal"><a href="#__codelineno-27-281">281</a></span>
<span class="normal"><a href="#__codelineno-27-282">282</a></span>
<span class="normal"><a href="#__codelineno-27-283">283</a></span>
<span class="normal"><a href="#__codelineno-27-284">284</a></span>
<span class="normal"><a href="#__codelineno-27-285">285</a></span>
<span class="normal"><a href="#__codelineno-27-286">286</a></span>
<span class="normal"><a href="#__codelineno-27-287">287</a></span>
<span class="normal"><a href="#__codelineno-27-288">288</a></span>
<span class="normal"><a href="#__codelineno-27-289">289</a></span>
<span class="normal"><a href="#__codelineno-27-290">290</a></span>
<span class="normal"><a href="#__codelineno-27-291">291</a></span>
<span class="normal"><a href="#__codelineno-27-292">292</a></span>
<span class="normal"><a href="#__codelineno-27-293">293</a></span>
<span class="normal"><a href="#__codelineno-27-294">294</a></span>
<span class="normal"><a href="#__codelineno-27-295">295</a></span>
<span class="normal"><a href="#__codelineno-27-296">296</a></span>
<span class="normal"><a href="#__codelineno-27-297">297</a></span>
<span class="normal"><a href="#__codelineno-27-298">298</a></span>
<span class="normal"><a href="#__codelineno-27-299">299</a></span>
<span class="normal"><a href="#__codelineno-27-300">300</a></span>
<span class="normal"><a href="#__codelineno-27-301">301</a></span>
<span class="normal"><a href="#__codelineno-27-302">302</a></span>
<span class="normal"><a href="#__codelineno-27-303">303</a></span>
<span class="normal"><a href="#__codelineno-27-304">304</a></span>
<span class="normal"><a href="#__codelineno-27-305">305</a></span>
<span class="normal"><a href="#__codelineno-27-306">306</a></span>
<span class="normal"><a href="#__codelineno-27-307">307</a></span>
<span class="normal"><a href="#__codelineno-27-308">308</a></span>
<span class="normal"><a href="#__codelineno-27-309">309</a></span>
<span class="normal"><a href="#__codelineno-27-310">310</a></span>
<span class="normal"><a href="#__codelineno-27-311">311</a></span>
<span class="normal"><a href="#__codelineno-27-312">312</a></span>
<span class="normal"><a href="#__codelineno-27-313">313</a></span>
<span class="normal"><a href="#__codelineno-27-314">314</a></span>
<span class="normal"><a href="#__codelineno-27-315">315</a></span>
<span class="normal"><a href="#__codelineno-27-316">316</a></span>
<span class="normal"><a href="#__codelineno-27-317">317</a></span>
<span class="normal"><a href="#__codelineno-27-318">318</a></span>
<span class="normal"><a href="#__codelineno-27-319">319</a></span>
<span class="normal"><a href="#__codelineno-27-320">320</a></span>
<span class="normal"><a href="#__codelineno-27-321">321</a></span>
<span class="normal"><a href="#__codelineno-27-322">322</a></span>
<span class="normal"><a href="#__codelineno-27-323">323</a></span>
<span class="normal"><a href="#__codelineno-27-324">324</a></span>
<span class="normal"><a href="#__codelineno-27-325">325</a></span>
<span class="normal"><a href="#__codelineno-27-326">326</a></span>
<span class="normal"><a href="#__codelineno-27-327">327</a></span>
<span class="normal"><a href="#__codelineno-27-328">328</a></span>
<span class="normal"><a href="#__codelineno-27-329">329</a></span>
<span class="normal"><a href="#__codelineno-27-330">330</a></span>
<span class="normal"><a href="#__codelineno-27-331">331</a></span>
<span class="normal"><a href="#__codelineno-27-332">332</a></span>
<span class="normal"><a href="#__codelineno-27-333">333</a></span>
<span class="normal"><a href="#__codelineno-27-334">334</a></span>
<span class="normal"><a href="#__codelineno-27-335">335</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.backends.cudnn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cudnn</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">T</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_grid</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-27-13" name="__codelineno-27-13"></a>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-15" name="__codelineno-27-15"></a><span class="c1"># Configs &amp; utils</span>
<a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="n">seed</span> <span class="o">=</span> <span class="mi">3407</span>
<a id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span> <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-27-19" name="__codelineno-27-19"></a>
<a id="__codelineno-27-20" name="__codelineno-27-20"></a><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span><span class="p">)</span>
<a id="__codelineno-27-21" name="__codelineno-27-21"></a>
<a id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="c1"># cuDNN 加速</span>
<a id="__codelineno-27-23" name="__codelineno-27-23"></a><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-27-24" name="__codelineno-27-24"></a><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-27-25" name="__codelineno-27-25"></a>
<a id="__codelineno-27-26" name="__codelineno-27-26"></a><span class="c1"># 显式禁用 TF32（P100 不支持；此设置在 P100 上为 no-op）</span>
<a id="__codelineno-27-27" name="__codelineno-27-27"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-27-28" name="__codelineno-27-28"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">matmul</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-27-29" name="__codelineno-27-29"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-27-30" name="__codelineno-27-30"></a><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-27-31" name="__codelineno-27-31"></a>    <span class="k">pass</span>
<a id="__codelineno-27-32" name="__codelineno-27-32"></a>
<a id="__codelineno-27-33" name="__codelineno-27-33"></a><span class="c1"># Hyper-params</span>
<a id="__codelineno-27-34" name="__codelineno-27-34"></a><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-27-35" name="__codelineno-27-35"></a><span class="n">image_size</span> <span class="o">=</span> <span class="mi">32</span>
<a id="__codelineno-27-36" name="__codelineno-27-36"></a><span class="n">z_dim</span> <span class="o">=</span> <span class="mi">128</span>
<a id="__codelineno-27-37" name="__codelineno-27-37"></a><span class="n">g_embed_dim</span> <span class="o">=</span> <span class="mi">128</span>
<a id="__codelineno-27-38" name="__codelineno-27-38"></a><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span>
<a id="__codelineno-27-39" name="__codelineno-27-39"></a><span class="n">lr</span> <span class="o">=</span> <span class="mf">2e-4</span>
<a id="__codelineno-27-40" name="__codelineno-27-40"></a><span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.999</span>
<a id="__codelineno-27-41" name="__codelineno-27-41"></a><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">250</span>
<a id="__codelineno-27-42" name="__codelineno-27-42"></a><span class="n">use_amp</span> <span class="o">=</span> <span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'cuda'</span><span class="p">)</span>  <span class="c1"># P100 支持 FP16（无 TensorCores）</span>
<a id="__codelineno-27-43" name="__codelineno-27-43"></a><span class="n">use_channels_last</span> <span class="o">=</span> <span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'cuda'</span><span class="p">)</span>
<a id="__codelineno-27-44" name="__codelineno-27-44"></a><span class="n">real_label_smooth</span> <span class="o">=</span> <span class="mf">0.9</span>
<a id="__codelineno-27-45" name="__codelineno-27-45"></a>
<a id="__codelineno-27-46" name="__codelineno-27-46"></a><span class="c1"># Data transforms: 无训练增广；仅归一化到 [-1, 1]</span>
<a id="__codelineno-27-47" name="__codelineno-27-47"></a><span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-27-48" name="__codelineno-27-48"></a><span class="n">std</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-27-49" name="__codelineno-27-49"></a><span class="n">train_tfms</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<a id="__codelineno-27-50" name="__codelineno-27-50"></a>    <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<a id="__codelineno-27-51" name="__codelineno-27-51"></a>    <span class="n">T</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">),</span>
<a id="__codelineno-27-52" name="__codelineno-27-52"></a><span class="p">])</span>
<a id="__codelineno-27-53" name="__codelineno-27-53"></a><span class="n">test_tfms</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<a id="__codelineno-27-54" name="__codelineno-27-54"></a>    <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<a id="__codelineno-27-55" name="__codelineno-27-55"></a>    <span class="n">T</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">),</span>
<a id="__codelineno-27-56" name="__codelineno-27-56"></a><span class="p">])</span>
<a id="__codelineno-27-57" name="__codelineno-27-57"></a>
<a id="__codelineno-27-58" name="__codelineno-27-58"></a><span class="c1"># Datasets &amp; Dataloaders</span>
<a id="__codelineno-27-59" name="__codelineno-27-59"></a><span class="n">train_set</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">train_tfms</span><span class="p">)</span>
<a id="__codelineno-27-60" name="__codelineno-27-60"></a><span class="n">test_set</span>  <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">test_tfms</span><span class="p">)</span>
<a id="__codelineno-27-61" name="__codelineno-27-61"></a>
<a id="__codelineno-27-62" name="__codelineno-27-62"></a><span class="n">loader_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<a id="__codelineno-27-63" name="__codelineno-27-63"></a>    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-27-64" name="__codelineno-27-64"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
<a id="__codelineno-27-65" name="__codelineno-27-65"></a>    <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-27-66" name="__codelineno-27-66"></a>    <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 若在 notebook 反复运行报错，可改为 False</span>
<a id="__codelineno-27-67" name="__codelineno-27-67"></a>    <span class="n">prefetch_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-27-68" name="__codelineno-27-68"></a><span class="p">)</span>
<a id="__codelineno-27-69" name="__codelineno-27-69"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">loader_kwargs</span><span class="p">)</span>
<a id="__codelineno-27-70" name="__codelineno-27-70"></a><span class="n">test_loader</span>  <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">loader_kwargs</span><span class="p">)</span>
<a id="__codelineno-27-71" name="__codelineno-27-71"></a>
<a id="__codelineno-27-72" name="__codelineno-27-72"></a><span class="n">classes</span> <span class="o">=</span> <span class="n">train_set</span><span class="o">.</span><span class="n">classes</span>
<a id="__codelineno-27-73" name="__codelineno-27-73"></a>
<a id="__codelineno-27-74" name="__codelineno-27-74"></a><span class="c1"># AMP autocast context</span>
<a id="__codelineno-27-75" name="__codelineno-27-75"></a><span class="n">amp_ctx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_amp</span> <span class="k">else</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">()</span>
<a id="__codelineno-27-76" name="__codelineno-27-76"></a>
<a id="__codelineno-27-77" name="__codelineno-27-77"></a><span class="k">def</span><span class="w"> </span><span class="nf">denorm</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="__codelineno-27-78" name="__codelineno-27-78"></a>    <span class="c1"># [-1, 1] -&gt; [0, 1]</span>
<a id="__codelineno-27-79" name="__codelineno-27-79"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-80" name="__codelineno-27-80"></a>
<a id="__codelineno-27-81" name="__codelineno-27-81"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-82" name="__codelineno-27-82"></a><span class="c1"># Models</span>
<a id="__codelineno-27-83" name="__codelineno-27-83"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-84" name="__codelineno-27-84"></a><span class="k">class</span><span class="w"> </span><span class="nc">Generator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-27-85" name="__codelineno-27-85"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">base_ch</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
<a id="__codelineno-27-86" name="__codelineno-27-86"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-27-87" name="__codelineno-27-87"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
<a id="__codelineno-27-88" name="__codelineno-27-88"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">z_dim</span> <span class="o">+</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">base_ch</span><span class="p">)</span>
<a id="__codelineno-27-89" name="__codelineno-27-89"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-27-90" name="__codelineno-27-90"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">base_ch</span><span class="p">),</span>
<a id="__codelineno-27-91" name="__codelineno-27-91"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-27-92" name="__codelineno-27-92"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">base_ch</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># 8x8</span>
<a id="__codelineno-27-93" name="__codelineno-27-93"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-27-94" name="__codelineno-27-94"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-27-95" name="__codelineno-27-95"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># 16x16</span>
<a id="__codelineno-27-96" name="__codelineno-27-96"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">4</span><span class="p">),</span>
<a id="__codelineno-27-97" name="__codelineno-27-97"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-27-98" name="__codelineno-27-98"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># 32x32</span>
<a id="__codelineno-27-99" name="__codelineno-27-99"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),</span>
<a id="__codelineno-27-100" name="__codelineno-27-100"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-27-101" name="__codelineno-27-101"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-27-102" name="__codelineno-27-102"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span>
<a id="__codelineno-27-103" name="__codelineno-27-103"></a>        <span class="p">)</span>
<a id="__codelineno-27-104" name="__codelineno-27-104"></a>
<a id="__codelineno-27-105" name="__codelineno-27-105"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a id="__codelineno-27-106" name="__codelineno-27-106"></a>        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-27-107" name="__codelineno-27-107"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">z</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-108" name="__codelineno-27-108"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-27-109" name="__codelineno-27-109"></a>        <span class="c1"># 用 reshape（兼容 channels_last / 非连续内存）</span>
<a id="__codelineno-27-110" name="__codelineno-27-110"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-27-111" name="__codelineno-27-111"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-27-112" name="__codelineno-27-112"></a>
<a id="__codelineno-27-113" name="__codelineno-27-113"></a><span class="k">class</span><span class="w"> </span><span class="nc">Discriminator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-27-114" name="__codelineno-27-114"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">base_ch</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
<a id="__codelineno-27-115" name="__codelineno-27-115"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-27-116" name="__codelineno-27-116"></a>        <span class="n">sn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">spectral_norm</span>  <span class="c1"># 稳定训练</span>
<a id="__codelineno-27-117" name="__codelineno-27-117"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-27-118" name="__codelineno-27-118"></a>            <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">base_ch</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>   <span class="c1"># 16x16</span>
<a id="__codelineno-27-119" name="__codelineno-27-119"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-27-120" name="__codelineno-27-120"></a>            <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base_ch</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>  <span class="c1"># 8x8</span>
<a id="__codelineno-27-121" name="__codelineno-27-121"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-27-122" name="__codelineno-27-122"></a>            <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>  <span class="c1"># 4x4</span>
<a id="__codelineno-27-123" name="__codelineno-27-123"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-27-124" name="__codelineno-27-124"></a>            <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>  <span class="c1"># 2x2</span>
<a id="__codelineno-27-125" name="__codelineno-27-125"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-27-126" name="__codelineno-27-126"></a>        <span class="p">)</span>
<a id="__codelineno-27-127" name="__codelineno-27-127"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">flatten_dim</span> <span class="o">=</span> <span class="n">base_ch</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span>
<a id="__codelineno-27-128" name="__codelineno-27-128"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">src_head</span> <span class="o">=</span> <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>            <span class="c1"># real/fake</span>
<a id="__codelineno-27-129" name="__codelineno-27-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cls_head</span> <span class="o">=</span> <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten_dim</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">))</span>  <span class="c1"># class logits</span>
<a id="__codelineno-27-130" name="__codelineno-27-130"></a>
<a id="__codelineno-27-131" name="__codelineno-27-131"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-27-132" name="__codelineno-27-132"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-27-133" name="__codelineno-27-133"></a>        <span class="c1"># 用 flatten（兼容 channels_last）</span>
<a id="__codelineno-27-134" name="__codelineno-27-134"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-135" name="__codelineno-27-135"></a>        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_head</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-27-136" name="__codelineno-27-136"></a>        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_head</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-27-137" name="__codelineno-27-137"></a>        <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="bp">cls</span>
<a id="__codelineno-27-138" name="__codelineno-27-138"></a>
<a id="__codelineno-27-139" name="__codelineno-27-139"></a><span class="k">def</span><span class="w"> </span><span class="nf">weights_init</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<a id="__codelineno-27-140" name="__codelineno-27-140"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">)):</span>
<a id="__codelineno-27-141" name="__codelineno-27-141"></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-27-142" name="__codelineno-27-142"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
<a id="__codelineno-27-143" name="__codelineno-27-143"></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">'bias'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-27-144" name="__codelineno-27-144"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
<a id="__codelineno-27-145" name="__codelineno-27-145"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
<a id="__codelineno-27-146" name="__codelineno-27-146"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
<a id="__codelineno-27-147" name="__codelineno-27-147"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
<a id="__codelineno-27-148" name="__codelineno-27-148"></a>
<a id="__codelineno-27-149" name="__codelineno-27-149"></a><span class="n">G</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">g_embed_dim</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-27-150" name="__codelineno-27-150"></a><span class="n">D</span> <span class="o">=</span> <span class="n">Discriminator</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-27-151" name="__codelineno-27-151"></a>
<a id="__codelineno-27-152" name="__codelineno-27-152"></a><span class="k">if</span> <span class="n">use_channels_last</span><span class="p">:</span>
<a id="__codelineno-27-153" name="__codelineno-27-153"></a>    <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
<a id="__codelineno-27-154" name="__codelineno-27-154"></a>    <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
<a id="__codelineno-27-155" name="__codelineno-27-155"></a>
<a id="__codelineno-27-156" name="__codelineno-27-156"></a><span class="n">G</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">weights_init</span><span class="p">)</span>
<a id="__codelineno-27-157" name="__codelineno-27-157"></a><span class="n">D</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">weights_init</span><span class="p">)</span>
<a id="__codelineno-27-158" name="__codelineno-27-158"></a>
<a id="__codelineno-27-159" name="__codelineno-27-159"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-160" name="__codelineno-27-160"></a><span class="c1"># Optimizers &amp; Losses</span>
<a id="__codelineno-27-161" name="__codelineno-27-161"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-162" name="__codelineno-27-162"></a><span class="n">opt_G</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span><span class="p">))</span>
<a id="__codelineno-27-163" name="__codelineno-27-163"></a><span class="n">opt_D</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span><span class="p">))</span>
<a id="__codelineno-27-164" name="__codelineno-27-164"></a>
<a id="__codelineno-27-165" name="__codelineno-27-165"></a><span class="n">bce</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">()</span>
<a id="__codelineno-27-166" name="__codelineno-27-166"></a><span class="n">ce</span>  <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<a id="__codelineno-27-167" name="__codelineno-27-167"></a>
<a id="__codelineno-27-168" name="__codelineno-27-168"></a><span class="n">scaler_G</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="n">use_amp</span><span class="p">)</span>
<a id="__codelineno-27-169" name="__codelineno-27-169"></a><span class="n">scaler_D</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="n">use_amp</span><span class="p">)</span>
<a id="__codelineno-27-170" name="__codelineno-27-170"></a>
<a id="__codelineno-27-171" name="__codelineno-27-171"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-172" name="__codelineno-27-172"></a><span class="c1"># Eval: classifier accuracy on test set</span>
<a id="__codelineno-27-173" name="__codelineno-27-173"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-174" name="__codelineno-27-174"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-27-175" name="__codelineno-27-175"></a><span class="k">def</span><span class="w"> </span><span class="nf">eval_test_accuracy</span><span class="p">():</span>
<a id="__codelineno-27-176" name="__codelineno-27-176"></a>    <span class="n">D</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-27-177" name="__codelineno-27-177"></a>    <span class="n">total</span><span class="p">,</span> <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<a id="__codelineno-27-178" name="__codelineno-27-178"></a>    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
<a id="__codelineno-27-179" name="__codelineno-27-179"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-27-180" name="__codelineno-27-180"></a>        <span class="k">if</span> <span class="n">use_channels_last</span><span class="p">:</span>
<a id="__codelineno-27-181" name="__codelineno-27-181"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
<a id="__codelineno-27-182" name="__codelineno-27-182"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-27-183" name="__codelineno-27-183"></a>        <span class="k">with</span> <span class="n">amp_ctx</span><span class="p">:</span>
<a id="__codelineno-27-184" name="__codelineno-27-184"></a>            <span class="n">_</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-27-185" name="__codelineno-27-185"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-186" name="__codelineno-27-186"></a>        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-27-187" name="__codelineno-27-187"></a>        <span class="n">total</span> <span class="o">+=</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-27-188" name="__codelineno-27-188"></a>    <span class="n">acc</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
<a id="__codelineno-27-189" name="__codelineno-27-189"></a>    <span class="k">return</span> <span class="n">acc</span>
<a id="__codelineno-27-190" name="__codelineno-27-190"></a>
<a id="__codelineno-27-191" name="__codelineno-27-191"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-192" name="__codelineno-27-192"></a><span class="c1"># Training loop</span>
<a id="__codelineno-27-193" name="__codelineno-27-193"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-194" name="__codelineno-27-194"></a><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">():</span>
<a id="__codelineno-27-195" name="__codelineno-27-195"></a>    <span class="n">G</span><span class="o">.</span><span class="n">train</span><span class="p">();</span> <span class="n">D</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-27-196" name="__codelineno-27-196"></a>    <span class="n">hist_loss_D</span><span class="p">,</span> <span class="n">hist_loss_G</span><span class="p">,</span> <span class="n">hist_acc</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-27-197" name="__codelineno-27-197"></a>
<a id="__codelineno-27-198" name="__codelineno-27-198"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-27-199" name="__codelineno-27-199"></a>        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">'Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-27-200" name="__codelineno-27-200"></a>        <span class="n">running_D</span><span class="p">,</span> <span class="n">running_G</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
<a id="__codelineno-27-201" name="__codelineno-27-201"></a>
<a id="__codelineno-27-202" name="__codelineno-27-202"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pbar</span><span class="p">):</span>
<a id="__codelineno-27-203" name="__codelineno-27-203"></a>            <span class="n">x_real</span> <span class="o">=</span> <span class="n">x_real</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-27-204" name="__codelineno-27-204"></a>            <span class="k">if</span> <span class="n">use_channels_last</span><span class="p">:</span>
<a id="__codelineno-27-205" name="__codelineno-27-205"></a>                <span class="n">x_real</span> <span class="o">=</span> <span class="n">x_real</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
<a id="__codelineno-27-206" name="__codelineno-27-206"></a>            <span class="n">y_real</span> <span class="o">=</span> <span class="n">y_real</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-27-207" name="__codelineno-27-207"></a>
<a id="__codelineno-27-208" name="__codelineno-27-208"></a>            <span class="n">bsz</span> <span class="o">=</span> <span class="n">x_real</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-27-209" name="__codelineno-27-209"></a>            <span class="n">valid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">bsz</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">real_label_smooth</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-27-210" name="__codelineno-27-210"></a>            <span class="n">fake</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-27-211" name="__codelineno-27-211"></a>
<a id="__codelineno-27-212" name="__codelineno-27-212"></a>            <span class="c1"># -----------------</span>
<a id="__codelineno-27-213" name="__codelineno-27-213"></a>            <span class="c1"># Train Discriminator</span>
<a id="__codelineno-27-214" name="__codelineno-27-214"></a>            <span class="c1"># -----------------</span>
<a id="__codelineno-27-215" name="__codelineno-27-215"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-27-216" name="__codelineno-27-216"></a>            <span class="n">y_fake</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="p">(</span><span class="n">bsz</span><span class="p">,),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-27-217" name="__codelineno-27-217"></a>
<a id="__codelineno-27-218" name="__codelineno-27-218"></a>            <span class="k">with</span> <span class="n">amp_ctx</span><span class="p">:</span>
<a id="__codelineno-27-219" name="__codelineno-27-219"></a>                <span class="n">x_fake</span> <span class="o">=</span> <span class="n">G</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y_fake</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-27-220" name="__codelineno-27-220"></a>                <span class="n">d_src_real</span><span class="p">,</span> <span class="n">d_cls_real</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">x_real</span><span class="p">)</span>
<a id="__codelineno-27-221" name="__codelineno-27-221"></a>                <span class="n">d_src_fake</span><span class="p">,</span> <span class="n">d_cls_fake</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">x_fake</span><span class="p">)</span>
<a id="__codelineno-27-222" name="__codelineno-27-222"></a>                <span class="n">d_loss_real</span> <span class="o">=</span> <span class="n">bce</span><span class="p">(</span><span class="n">d_src_real</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">+</span> <span class="n">ce</span><span class="p">(</span><span class="n">d_cls_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">)</span>
<a id="__codelineno-27-223" name="__codelineno-27-223"></a>                <span class="n">d_loss_fake</span> <span class="o">=</span> <span class="n">bce</span><span class="p">(</span><span class="n">d_src_fake</span><span class="p">,</span> <span class="n">fake</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ce</span><span class="p">(</span><span class="n">d_cls_fake</span><span class="p">,</span> <span class="n">y_fake</span><span class="p">)</span>
<a id="__codelineno-27-224" name="__codelineno-27-224"></a>                <span class="n">d_loss</span> <span class="o">=</span> <span class="n">d_loss_real</span> <span class="o">+</span> <span class="n">d_loss_fake</span>
<a id="__codelineno-27-225" name="__codelineno-27-225"></a>
<a id="__codelineno-27-226" name="__codelineno-27-226"></a>            <span class="n">opt_D</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-27-227" name="__codelineno-27-227"></a>            <span class="n">scaler_D</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">d_loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-27-228" name="__codelineno-27-228"></a>            <span class="n">scaler_D</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">opt_D</span><span class="p">)</span>
<a id="__codelineno-27-229" name="__codelineno-27-229"></a>            <span class="n">scaler_D</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<a id="__codelineno-27-230" name="__codelineno-27-230"></a>
<a id="__codelineno-27-231" name="__codelineno-27-231"></a>            <span class="c1"># -----------------</span>
<a id="__codelineno-27-232" name="__codelineno-27-232"></a>            <span class="c1"># Train Generator</span>
<a id="__codelineno-27-233" name="__codelineno-27-233"></a>            <span class="c1"># -----------------</span>
<a id="__codelineno-27-234" name="__codelineno-27-234"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-27-235" name="__codelineno-27-235"></a>            <span class="n">y_fake</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="p">(</span><span class="n">bsz</span><span class="p">,),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-27-236" name="__codelineno-27-236"></a>            <span class="k">with</span> <span class="n">amp_ctx</span><span class="p">:</span>
<a id="__codelineno-27-237" name="__codelineno-27-237"></a>                <span class="n">gen</span> <span class="o">=</span> <span class="n">G</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y_fake</span><span class="p">)</span>
<a id="__codelineno-27-238" name="__codelineno-27-238"></a>                <span class="n">g_src</span><span class="p">,</span> <span class="n">g_cls</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
<a id="__codelineno-27-239" name="__codelineno-27-239"></a>                <span class="n">g_loss</span> <span class="o">=</span> <span class="n">bce</span><span class="p">(</span><span class="n">g_src</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">+</span> <span class="n">ce</span><span class="p">(</span><span class="n">g_cls</span><span class="p">,</span> <span class="n">y_fake</span><span class="p">)</span>
<a id="__codelineno-27-240" name="__codelineno-27-240"></a>
<a id="__codelineno-27-241" name="__codelineno-27-241"></a>            <span class="n">opt_G</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-27-242" name="__codelineno-27-242"></a>            <span class="n">scaler_G</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">g_loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-27-243" name="__codelineno-27-243"></a>            <span class="n">scaler_G</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">opt_G</span><span class="p">)</span>
<a id="__codelineno-27-244" name="__codelineno-27-244"></a>            <span class="n">scaler_G</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<a id="__codelineno-27-245" name="__codelineno-27-245"></a>
<a id="__codelineno-27-246" name="__codelineno-27-246"></a>            <span class="n">running_D</span> <span class="o">+=</span> <span class="n">d_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-27-247" name="__codelineno-27-247"></a>            <span class="n">running_G</span> <span class="o">+=</span> <span class="n">g_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-27-248" name="__codelineno-27-248"></a>
<a id="__codelineno-27-249" name="__codelineno-27-249"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-27-250" name="__codelineno-27-250"></a>                <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span>
<a id="__codelineno-27-251" name="__codelineno-27-251"></a>                    <span class="s1">'loss_D'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">running_D</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
<a id="__codelineno-27-252" name="__codelineno-27-252"></a>                    <span class="s1">'loss_G'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">running_G</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span>
<a id="__codelineno-27-253" name="__codelineno-27-253"></a>                <span class="p">})</span>
<a id="__codelineno-27-254" name="__codelineno-27-254"></a>
<a id="__codelineno-27-255" name="__codelineno-27-255"></a>        <span class="c1"># epoch 平均损失</span>
<a id="__codelineno-27-256" name="__codelineno-27-256"></a>        <span class="n">epoch_loss_D</span> <span class="o">=</span> <span class="n">running_D</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<a id="__codelineno-27-257" name="__codelineno-27-257"></a>        <span class="n">epoch_loss_G</span> <span class="o">=</span> <span class="n">running_G</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<a id="__codelineno-27-258" name="__codelineno-27-258"></a>        <span class="n">hist_loss_D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss_D</span><span class="p">)</span>
<a id="__codelineno-27-259" name="__codelineno-27-259"></a>        <span class="n">hist_loss_G</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss_G</span><span class="p">)</span>
<a id="__codelineno-27-260" name="__codelineno-27-260"></a>
<a id="__codelineno-27-261" name="__codelineno-27-261"></a>        <span class="c1"># 评估测试集准确率（判别器的辅助分类头）</span>
<a id="__codelineno-27-262" name="__codelineno-27-262"></a>        <span class="n">acc</span> <span class="o">=</span> <span class="n">eval_test_accuracy</span><span class="p">()</span>
<a id="__codelineno-27-263" name="__codelineno-27-263"></a>        <span class="n">hist_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
<a id="__codelineno-27-264" name="__codelineno-27-264"></a>
<a id="__codelineno-27-265" name="__codelineno-27-265"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'[Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">] loss_D=</span><span class="si">{</span><span class="n">epoch_loss_D</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> loss_G=</span><span class="si">{</span><span class="n">epoch_loss_G</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> | Test Acc=</span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%'</span><span class="p">)</span>
<a id="__codelineno-27-266" name="__codelineno-27-266"></a>
<a id="__codelineno-27-267" name="__codelineno-27-267"></a>        <span class="c1"># 继续训练模式</span>
<a id="__codelineno-27-268" name="__codelineno-27-268"></a>        <span class="n">D</span><span class="o">.</span><span class="n">train</span><span class="p">();</span> <span class="n">G</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-27-269" name="__codelineno-27-269"></a>
<a id="__codelineno-27-270" name="__codelineno-27-270"></a>    <span class="k">return</span> <span class="n">hist_loss_D</span><span class="p">,</span> <span class="n">hist_loss_G</span><span class="p">,</span> <span class="n">hist_acc</span>
<a id="__codelineno-27-271" name="__codelineno-27-271"></a>
<a id="__codelineno-27-272" name="__codelineno-27-272"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-273" name="__codelineno-27-273"></a><span class="c1"># Plot: 损失曲线 + 准确率曲线</span>
<a id="__codelineno-27-274" name="__codelineno-27-274"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-275" name="__codelineno-27-275"></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_history</span><span class="p">(</span><span class="n">loss_D</span><span class="p">,</span> <span class="n">loss_G</span><span class="p">,</span> <span class="n">acc</span><span class="p">):</span>
<a id="__codelineno-27-276" name="__codelineno-27-276"></a>    <span class="n">epochs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">loss_D</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-277" name="__codelineno-27-277"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-27-278" name="__codelineno-27-278"></a>    <span class="c1"># 损失</span>
<a id="__codelineno-27-279" name="__codelineno-27-279"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-280" name="__codelineno-27-280"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">loss_D</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'D loss'</span><span class="p">)</span>
<a id="__codelineno-27-281" name="__codelineno-27-281"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">loss_G</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'G loss'</span><span class="p">)</span>
<a id="__codelineno-27-282" name="__codelineno-27-282"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Epoch'</span><span class="p">)</span>
<a id="__codelineno-27-283" name="__codelineno-27-283"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Loss'</span><span class="p">)</span>
<a id="__codelineno-27-284" name="__codelineno-27-284"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'AC-GAN Training Loss'</span><span class="p">)</span>
<a id="__codelineno-27-285" name="__codelineno-27-285"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-27-286" name="__codelineno-27-286"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-27-287" name="__codelineno-27-287"></a>    <span class="c1"># 准确率</span>
<a id="__codelineno-27-288" name="__codelineno-27-288"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-27-289" name="__codelineno-27-289"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'tab:green'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Test Acc (%)'</span><span class="p">)</span>
<a id="__codelineno-27-290" name="__codelineno-27-290"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Epoch'</span><span class="p">)</span>
<a id="__codelineno-27-291" name="__codelineno-27-291"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Accuracy (%)'</span><span class="p">)</span>
<a id="__codelineno-27-292" name="__codelineno-27-292"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Aux Classifier Test Accuracy'</span><span class="p">)</span>
<a id="__codelineno-27-293" name="__codelineno-27-293"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-27-294" name="__codelineno-27-294"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-27-295" name="__codelineno-27-295"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-27-296" name="__codelineno-27-296"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-27-297" name="__codelineno-27-297"></a>
<a id="__codelineno-27-298" name="__codelineno-27-298"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-299" name="__codelineno-27-299"></a><span class="c1"># Generate: 10 classes, 5 images each, grid 10x5</span>
<a id="__codelineno-27-300" name="__codelineno-27-300"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-301" name="__codelineno-27-301"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-27-302" name="__codelineno-27-302"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_grid_horizontal_labeled</span><span class="p">(</span><span class="n">n_per</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-27-303" name="__codelineno-27-303"></a>    <span class="n">G</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-27-304" name="__codelineno-27-304"></a>    <span class="n">imgs_by_class</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-27-305" name="__codelineno-27-305"></a>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-27-306" name="__codelineno-27-306"></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_per</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-27-307" name="__codelineno-27-307"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_per</span><span class="p">,),</span> <span class="n">c</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-27-308" name="__codelineno-27-308"></a>        <span class="c1"># 关闭 autocast 或显示前转 float32，避免 matplotlib 不支持 float16</span>
<a id="__codelineno-27-309" name="__codelineno-27-309"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_amp</span> <span class="k">else</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">():</span>
<a id="__codelineno-27-310" name="__codelineno-27-310"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">G</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-27-311" name="__codelineno-27-311"></a>        <span class="n">imgs_by_class</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>  <span class="c1"># [n_per, 3, 32, 32]</span>
<a id="__codelineno-27-312" name="__codelineno-27-312"></a>
<a id="__codelineno-27-313" name="__codelineno-27-313"></a>    <span class="c1"># 画成 5 行 × 10 列</span>
<a id="__codelineno-27-314" name="__codelineno-27-314"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_per</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_classes</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">,</span> <span class="n">n_per</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">))</span>
<a id="__codelineno-27-315" name="__codelineno-27-315"></a>    <span class="k">if</span> <span class="n">n_per</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-27-316" name="__codelineno-27-316"></a>        <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 兼容 n_per=1 的索引</span>
<a id="__codelineno-27-317" name="__codelineno-27-317"></a>
<a id="__codelineno-27-318" name="__codelineno-27-318"></a>    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-27-319" name="__codelineno-27-319"></a>        <span class="c1"># 顶部列标题（类别名）</span>
<a id="__codelineno-27-320" name="__codelineno-27-320"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-27-321" name="__codelineno-27-321"></a>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_per</span><span class="p">):</span>
<a id="__codelineno-27-322" name="__codelineno-27-322"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">denorm</span><span class="p">(</span><span class="n">imgs_by_class</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">row</span><span class="p">])</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>  <span class="c1"># HWC float32</span>
<a id="__codelineno-27-323" name="__codelineno-27-323"></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
<a id="__codelineno-27-324" name="__codelineno-27-324"></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-27-325" name="__codelineno-27-325"></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-27-326" name="__codelineno-27-326"></a>
<a id="__codelineno-27-327" name="__codelineno-27-327"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">w_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">h_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-27-328" name="__codelineno-27-328"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-27-329" name="__codelineno-27-329"></a>
<a id="__codelineno-27-330" name="__codelineno-27-330"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-331" name="__codelineno-27-331"></a><span class="c1"># Run</span>
<a id="__codelineno-27-332" name="__codelineno-27-332"></a><span class="c1"># -------------------</span>
<a id="__codelineno-27-333" name="__codelineno-27-333"></a><span class="n">loss_D_hist</span><span class="p">,</span> <span class="n">loss_G_hist</span><span class="p">,</span> <span class="n">acc_hist</span> <span class="o">=</span> <span class="n">train</span><span class="p">()</span>
<a id="__codelineno-27-334" name="__codelineno-27-334"></a><span class="n">plot_history</span><span class="p">(</span><span class="n">loss_D_hist</span><span class="p">,</span> <span class="n">loss_G_hist</span><span class="p">,</span> <span class="n">acc_hist</span><span class="p">)</span>
<a id="__codelineno-27-335" name="__codelineno-27-335"></a><span class="n">generate_grid_horizontal_labeled</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<p><img alt="ver1_loss" src="../Image-models-replication-assets/ver1_loss.png"/></p>
<p><img alt="ver1_gen" src="../Image-models-replication-assets/ver1_gen.png"/></p>
<p>虽然准确率最终稳定在了 66% 左右，但是可见出现了一个很大的问题。虽然 loss 一直很稳没有炸，但是同一类别下，不同种子生成的图像全都一个样。</p>
<p>这意味着出现了<strong>模式崩塌</strong>，其实问题还是出在结构上面：生成器得到的梯度完全是从判别器回传得到的，这就说明我的生成器可以偷个懒，只打磨那么一个可以骗过判别器的输出，然后就可以专心去应对分类损失项了，这其实有点 reward hacking 的味道了，因此我们还需要加入一个改进，强迫生成器生成更多样化的样本。</p>
<p>对样本的多样化程度该如何衡量？从统计学意义上讲，使用<strong>标准差</strong>即可。也就是说，我们可以将这个 batch 里面的所有样本计算一个标准差，再拼接到特征图后面。这样，判别器就可以根据这一线索来对生成器的偷懒行为做出反应。这个叫做 Mini-Batch StdDev 策略。另一方面，我们可以在训练一开始对样本加入少量噪声，这样一开始就可以强迫生成器输出更多样的内容（熵更高），后面再衰减。</p>
<p>结合上之前稳定训练的 TTUR 和谱归一化，我们就可以写出下面的代码了：</p>
<details>
<summary> 训练 AC-GAN 的代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">  1</a></span>
<span class="normal"><a href="#__codelineno-28-2">  2</a></span>
<span class="normal"><a href="#__codelineno-28-3">  3</a></span>
<span class="normal"><a href="#__codelineno-28-4">  4</a></span>
<span class="normal"><a href="#__codelineno-28-5">  5</a></span>
<span class="normal"><a href="#__codelineno-28-6">  6</a></span>
<span class="normal"><a href="#__codelineno-28-7">  7</a></span>
<span class="normal"><a href="#__codelineno-28-8">  8</a></span>
<span class="normal"><a href="#__codelineno-28-9">  9</a></span>
<span class="normal"><a href="#__codelineno-28-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-28-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-28-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-28-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-28-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-28-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-28-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-28-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-28-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-28-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-28-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-28-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-28-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-28-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-28-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-28-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-28-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-28-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-28-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-28-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-28-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-28-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-28-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-28-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-28-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-28-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-28-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-28-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-28-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-28-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-28-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-28-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-28-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-28-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-28-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-28-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-28-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-28-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-28-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-28-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-28-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-28-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-28-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-28-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-28-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-28-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-28-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-28-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-28-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-28-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-28-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-28-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-28-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-28-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-28-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-28-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-28-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-28-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-28-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-28-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-28-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-28-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-28-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-28-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-28-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-28-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-28-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-28-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-28-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-28-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-28-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-28-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-28-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-28-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-28-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-28-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-28-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-28-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-28-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-28-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-28-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-28-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-28-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-28-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-28-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-28-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-28-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-28-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-28-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-28-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-28-100">100</a></span>
<span class="normal"><a href="#__codelineno-28-101">101</a></span>
<span class="normal"><a href="#__codelineno-28-102">102</a></span>
<span class="normal"><a href="#__codelineno-28-103">103</a></span>
<span class="normal"><a href="#__codelineno-28-104">104</a></span>
<span class="normal"><a href="#__codelineno-28-105">105</a></span>
<span class="normal"><a href="#__codelineno-28-106">106</a></span>
<span class="normal"><a href="#__codelineno-28-107">107</a></span>
<span class="normal"><a href="#__codelineno-28-108">108</a></span>
<span class="normal"><a href="#__codelineno-28-109">109</a></span>
<span class="normal"><a href="#__codelineno-28-110">110</a></span>
<span class="normal"><a href="#__codelineno-28-111">111</a></span>
<span class="normal"><a href="#__codelineno-28-112">112</a></span>
<span class="normal"><a href="#__codelineno-28-113">113</a></span>
<span class="normal"><a href="#__codelineno-28-114">114</a></span>
<span class="normal"><a href="#__codelineno-28-115">115</a></span>
<span class="normal"><a href="#__codelineno-28-116">116</a></span>
<span class="normal"><a href="#__codelineno-28-117">117</a></span>
<span class="normal"><a href="#__codelineno-28-118">118</a></span>
<span class="normal"><a href="#__codelineno-28-119">119</a></span>
<span class="normal"><a href="#__codelineno-28-120">120</a></span>
<span class="normal"><a href="#__codelineno-28-121">121</a></span>
<span class="normal"><a href="#__codelineno-28-122">122</a></span>
<span class="normal"><a href="#__codelineno-28-123">123</a></span>
<span class="normal"><a href="#__codelineno-28-124">124</a></span>
<span class="normal"><a href="#__codelineno-28-125">125</a></span>
<span class="normal"><a href="#__codelineno-28-126">126</a></span>
<span class="normal"><a href="#__codelineno-28-127">127</a></span>
<span class="normal"><a href="#__codelineno-28-128">128</a></span>
<span class="normal"><a href="#__codelineno-28-129">129</a></span>
<span class="normal"><a href="#__codelineno-28-130">130</a></span>
<span class="normal"><a href="#__codelineno-28-131">131</a></span>
<span class="normal"><a href="#__codelineno-28-132">132</a></span>
<span class="normal"><a href="#__codelineno-28-133">133</a></span>
<span class="normal"><a href="#__codelineno-28-134">134</a></span>
<span class="normal"><a href="#__codelineno-28-135">135</a></span>
<span class="normal"><a href="#__codelineno-28-136">136</a></span>
<span class="normal"><a href="#__codelineno-28-137">137</a></span>
<span class="normal"><a href="#__codelineno-28-138">138</a></span>
<span class="normal"><a href="#__codelineno-28-139">139</a></span>
<span class="normal"><a href="#__codelineno-28-140">140</a></span>
<span class="normal"><a href="#__codelineno-28-141">141</a></span>
<span class="normal"><a href="#__codelineno-28-142">142</a></span>
<span class="normal"><a href="#__codelineno-28-143">143</a></span>
<span class="normal"><a href="#__codelineno-28-144">144</a></span>
<span class="normal"><a href="#__codelineno-28-145">145</a></span>
<span class="normal"><a href="#__codelineno-28-146">146</a></span>
<span class="normal"><a href="#__codelineno-28-147">147</a></span>
<span class="normal"><a href="#__codelineno-28-148">148</a></span>
<span class="normal"><a href="#__codelineno-28-149">149</a></span>
<span class="normal"><a href="#__codelineno-28-150">150</a></span>
<span class="normal"><a href="#__codelineno-28-151">151</a></span>
<span class="normal"><a href="#__codelineno-28-152">152</a></span>
<span class="normal"><a href="#__codelineno-28-153">153</a></span>
<span class="normal"><a href="#__codelineno-28-154">154</a></span>
<span class="normal"><a href="#__codelineno-28-155">155</a></span>
<span class="normal"><a href="#__codelineno-28-156">156</a></span>
<span class="normal"><a href="#__codelineno-28-157">157</a></span>
<span class="normal"><a href="#__codelineno-28-158">158</a></span>
<span class="normal"><a href="#__codelineno-28-159">159</a></span>
<span class="normal"><a href="#__codelineno-28-160">160</a></span>
<span class="normal"><a href="#__codelineno-28-161">161</a></span>
<span class="normal"><a href="#__codelineno-28-162">162</a></span>
<span class="normal"><a href="#__codelineno-28-163">163</a></span>
<span class="normal"><a href="#__codelineno-28-164">164</a></span>
<span class="normal"><a href="#__codelineno-28-165">165</a></span>
<span class="normal"><a href="#__codelineno-28-166">166</a></span>
<span class="normal"><a href="#__codelineno-28-167">167</a></span>
<span class="normal"><a href="#__codelineno-28-168">168</a></span>
<span class="normal"><a href="#__codelineno-28-169">169</a></span>
<span class="normal"><a href="#__codelineno-28-170">170</a></span>
<span class="normal"><a href="#__codelineno-28-171">171</a></span>
<span class="normal"><a href="#__codelineno-28-172">172</a></span>
<span class="normal"><a href="#__codelineno-28-173">173</a></span>
<span class="normal"><a href="#__codelineno-28-174">174</a></span>
<span class="normal"><a href="#__codelineno-28-175">175</a></span>
<span class="normal"><a href="#__codelineno-28-176">176</a></span>
<span class="normal"><a href="#__codelineno-28-177">177</a></span>
<span class="normal"><a href="#__codelineno-28-178">178</a></span>
<span class="normal"><a href="#__codelineno-28-179">179</a></span>
<span class="normal"><a href="#__codelineno-28-180">180</a></span>
<span class="normal"><a href="#__codelineno-28-181">181</a></span>
<span class="normal"><a href="#__codelineno-28-182">182</a></span>
<span class="normal"><a href="#__codelineno-28-183">183</a></span>
<span class="normal"><a href="#__codelineno-28-184">184</a></span>
<span class="normal"><a href="#__codelineno-28-185">185</a></span>
<span class="normal"><a href="#__codelineno-28-186">186</a></span>
<span class="normal"><a href="#__codelineno-28-187">187</a></span>
<span class="normal"><a href="#__codelineno-28-188">188</a></span>
<span class="normal"><a href="#__codelineno-28-189">189</a></span>
<span class="normal"><a href="#__codelineno-28-190">190</a></span>
<span class="normal"><a href="#__codelineno-28-191">191</a></span>
<span class="normal"><a href="#__codelineno-28-192">192</a></span>
<span class="normal"><a href="#__codelineno-28-193">193</a></span>
<span class="normal"><a href="#__codelineno-28-194">194</a></span>
<span class="normal"><a href="#__codelineno-28-195">195</a></span>
<span class="normal"><a href="#__codelineno-28-196">196</a></span>
<span class="normal"><a href="#__codelineno-28-197">197</a></span>
<span class="normal"><a href="#__codelineno-28-198">198</a></span>
<span class="normal"><a href="#__codelineno-28-199">199</a></span>
<span class="normal"><a href="#__codelineno-28-200">200</a></span>
<span class="normal"><a href="#__codelineno-28-201">201</a></span>
<span class="normal"><a href="#__codelineno-28-202">202</a></span>
<span class="normal"><a href="#__codelineno-28-203">203</a></span>
<span class="normal"><a href="#__codelineno-28-204">204</a></span>
<span class="normal"><a href="#__codelineno-28-205">205</a></span>
<span class="normal"><a href="#__codelineno-28-206">206</a></span>
<span class="normal"><a href="#__codelineno-28-207">207</a></span>
<span class="normal"><a href="#__codelineno-28-208">208</a></span>
<span class="normal"><a href="#__codelineno-28-209">209</a></span>
<span class="normal"><a href="#__codelineno-28-210">210</a></span>
<span class="normal"><a href="#__codelineno-28-211">211</a></span>
<span class="normal"><a href="#__codelineno-28-212">212</a></span>
<span class="normal"><a href="#__codelineno-28-213">213</a></span>
<span class="normal"><a href="#__codelineno-28-214">214</a></span>
<span class="normal"><a href="#__codelineno-28-215">215</a></span>
<span class="normal"><a href="#__codelineno-28-216">216</a></span>
<span class="normal"><a href="#__codelineno-28-217">217</a></span>
<span class="normal"><a href="#__codelineno-28-218">218</a></span>
<span class="normal"><a href="#__codelineno-28-219">219</a></span>
<span class="normal"><a href="#__codelineno-28-220">220</a></span>
<span class="normal"><a href="#__codelineno-28-221">221</a></span>
<span class="normal"><a href="#__codelineno-28-222">222</a></span>
<span class="normal"><a href="#__codelineno-28-223">223</a></span>
<span class="normal"><a href="#__codelineno-28-224">224</a></span>
<span class="normal"><a href="#__codelineno-28-225">225</a></span>
<span class="normal"><a href="#__codelineno-28-226">226</a></span>
<span class="normal"><a href="#__codelineno-28-227">227</a></span>
<span class="normal"><a href="#__codelineno-28-228">228</a></span>
<span class="normal"><a href="#__codelineno-28-229">229</a></span>
<span class="normal"><a href="#__codelineno-28-230">230</a></span>
<span class="normal"><a href="#__codelineno-28-231">231</a></span>
<span class="normal"><a href="#__codelineno-28-232">232</a></span>
<span class="normal"><a href="#__codelineno-28-233">233</a></span>
<span class="normal"><a href="#__codelineno-28-234">234</a></span>
<span class="normal"><a href="#__codelineno-28-235">235</a></span>
<span class="normal"><a href="#__codelineno-28-236">236</a></span>
<span class="normal"><a href="#__codelineno-28-237">237</a></span>
<span class="normal"><a href="#__codelineno-28-238">238</a></span>
<span class="normal"><a href="#__codelineno-28-239">239</a></span>
<span class="normal"><a href="#__codelineno-28-240">240</a></span>
<span class="normal"><a href="#__codelineno-28-241">241</a></span>
<span class="normal"><a href="#__codelineno-28-242">242</a></span>
<span class="normal"><a href="#__codelineno-28-243">243</a></span>
<span class="normal"><a href="#__codelineno-28-244">244</a></span>
<span class="normal"><a href="#__codelineno-28-245">245</a></span>
<span class="normal"><a href="#__codelineno-28-246">246</a></span>
<span class="normal"><a href="#__codelineno-28-247">247</a></span>
<span class="normal"><a href="#__codelineno-28-248">248</a></span>
<span class="normal"><a href="#__codelineno-28-249">249</a></span>
<span class="normal"><a href="#__codelineno-28-250">250</a></span>
<span class="normal"><a href="#__codelineno-28-251">251</a></span>
<span class="normal"><a href="#__codelineno-28-252">252</a></span>
<span class="normal"><a href="#__codelineno-28-253">253</a></span>
<span class="normal"><a href="#__codelineno-28-254">254</a></span>
<span class="normal"><a href="#__codelineno-28-255">255</a></span>
<span class="normal"><a href="#__codelineno-28-256">256</a></span>
<span class="normal"><a href="#__codelineno-28-257">257</a></span>
<span class="normal"><a href="#__codelineno-28-258">258</a></span>
<span class="normal"><a href="#__codelineno-28-259">259</a></span>
<span class="normal"><a href="#__codelineno-28-260">260</a></span>
<span class="normal"><a href="#__codelineno-28-261">261</a></span>
<span class="normal"><a href="#__codelineno-28-262">262</a></span>
<span class="normal"><a href="#__codelineno-28-263">263</a></span>
<span class="normal"><a href="#__codelineno-28-264">264</a></span>
<span class="normal"><a href="#__codelineno-28-265">265</a></span>
<span class="normal"><a href="#__codelineno-28-266">266</a></span>
<span class="normal"><a href="#__codelineno-28-267">267</a></span>
<span class="normal"><a href="#__codelineno-28-268">268</a></span>
<span class="normal"><a href="#__codelineno-28-269">269</a></span>
<span class="normal"><a href="#__codelineno-28-270">270</a></span>
<span class="normal"><a href="#__codelineno-28-271">271</a></span>
<span class="normal"><a href="#__codelineno-28-272">272</a></span>
<span class="normal"><a href="#__codelineno-28-273">273</a></span>
<span class="normal"><a href="#__codelineno-28-274">274</a></span>
<span class="normal"><a href="#__codelineno-28-275">275</a></span>
<span class="normal"><a href="#__codelineno-28-276">276</a></span>
<span class="normal"><a href="#__codelineno-28-277">277</a></span>
<span class="normal"><a href="#__codelineno-28-278">278</a></span>
<span class="normal"><a href="#__codelineno-28-279">279</a></span>
<span class="normal"><a href="#__codelineno-28-280">280</a></span>
<span class="normal"><a href="#__codelineno-28-281">281</a></span>
<span class="normal"><a href="#__codelineno-28-282">282</a></span>
<span class="normal"><a href="#__codelineno-28-283">283</a></span>
<span class="normal"><a href="#__codelineno-28-284">284</a></span>
<span class="normal"><a href="#__codelineno-28-285">285</a></span>
<span class="normal"><a href="#__codelineno-28-286">286</a></span>
<span class="normal"><a href="#__codelineno-28-287">287</a></span>
<span class="normal"><a href="#__codelineno-28-288">288</a></span>
<span class="normal"><a href="#__codelineno-28-289">289</a></span>
<span class="normal"><a href="#__codelineno-28-290">290</a></span>
<span class="normal"><a href="#__codelineno-28-291">291</a></span>
<span class="normal"><a href="#__codelineno-28-292">292</a></span>
<span class="normal"><a href="#__codelineno-28-293">293</a></span>
<span class="normal"><a href="#__codelineno-28-294">294</a></span>
<span class="normal"><a href="#__codelineno-28-295">295</a></span>
<span class="normal"><a href="#__codelineno-28-296">296</a></span>
<span class="normal"><a href="#__codelineno-28-297">297</a></span>
<span class="normal"><a href="#__codelineno-28-298">298</a></span>
<span class="normal"><a href="#__codelineno-28-299">299</a></span>
<span class="normal"><a href="#__codelineno-28-300">300</a></span>
<span class="normal"><a href="#__codelineno-28-301">301</a></span>
<span class="normal"><a href="#__codelineno-28-302">302</a></span>
<span class="normal"><a href="#__codelineno-28-303">303</a></span>
<span class="normal"><a href="#__codelineno-28-304">304</a></span>
<span class="normal"><a href="#__codelineno-28-305">305</a></span>
<span class="normal"><a href="#__codelineno-28-306">306</a></span>
<span class="normal"><a href="#__codelineno-28-307">307</a></span>
<span class="normal"><a href="#__codelineno-28-308">308</a></span>
<span class="normal"><a href="#__codelineno-28-309">309</a></span>
<span class="normal"><a href="#__codelineno-28-310">310</a></span>
<span class="normal"><a href="#__codelineno-28-311">311</a></span>
<span class="normal"><a href="#__codelineno-28-312">312</a></span>
<span class="normal"><a href="#__codelineno-28-313">313</a></span>
<span class="normal"><a href="#__codelineno-28-314">314</a></span>
<span class="normal"><a href="#__codelineno-28-315">315</a></span>
<span class="normal"><a href="#__codelineno-28-316">316</a></span>
<span class="normal"><a href="#__codelineno-28-317">317</a></span>
<span class="normal"><a href="#__codelineno-28-318">318</a></span>
<span class="normal"><a href="#__codelineno-28-319">319</a></span>
<span class="normal"><a href="#__codelineno-28-320">320</a></span>
<span class="normal"><a href="#__codelineno-28-321">321</a></span>
<span class="normal"><a href="#__codelineno-28-322">322</a></span>
<span class="normal"><a href="#__codelineno-28-323">323</a></span>
<span class="normal"><a href="#__codelineno-28-324">324</a></span>
<span class="normal"><a href="#__codelineno-28-325">325</a></span>
<span class="normal"><a href="#__codelineno-28-326">326</a></span>
<span class="normal"><a href="#__codelineno-28-327">327</a></span>
<span class="normal"><a href="#__codelineno-28-328">328</a></span>
<span class="normal"><a href="#__codelineno-28-329">329</a></span>
<span class="normal"><a href="#__codelineno-28-330">330</a></span>
<span class="normal"><a href="#__codelineno-28-331">331</a></span>
<span class="normal"><a href="#__codelineno-28-332">332</a></span>
<span class="normal"><a href="#__codelineno-28-333">333</a></span>
<span class="normal"><a href="#__codelineno-28-334">334</a></span>
<span class="normal"><a href="#__codelineno-28-335">335</a></span>
<span class="normal"><a href="#__codelineno-28-336">336</a></span>
<span class="normal"><a href="#__codelineno-28-337">337</a></span>
<span class="normal"><a href="#__codelineno-28-338">338</a></span>
<span class="normal"><a href="#__codelineno-28-339">339</a></span>
<span class="normal"><a href="#__codelineno-28-340">340</a></span>
<span class="normal"><a href="#__codelineno-28-341">341</a></span>
<span class="normal"><a href="#__codelineno-28-342">342</a></span>
<span class="normal"><a href="#__codelineno-28-343">343</a></span>
<span class="normal"><a href="#__codelineno-28-344">344</a></span>
<span class="normal"><a href="#__codelineno-28-345">345</a></span>
<span class="normal"><a href="#__codelineno-28-346">346</a></span>
<span class="normal"><a href="#__codelineno-28-347">347</a></span>
<span class="normal"><a href="#__codelineno-28-348">348</a></span>
<span class="normal"><a href="#__codelineno-28-349">349</a></span>
<span class="normal"><a href="#__codelineno-28-350">350</a></span>
<span class="normal"><a href="#__codelineno-28-351">351</a></span>
<span class="normal"><a href="#__codelineno-28-352">352</a></span>
<span class="normal"><a href="#__codelineno-28-353">353</a></span>
<span class="normal"><a href="#__codelineno-28-354">354</a></span>
<span class="normal"><a href="#__codelineno-28-355">355</a></span>
<span class="normal"><a href="#__codelineno-28-356">356</a></span>
<span class="normal"><a href="#__codelineno-28-357">357</a></span>
<span class="normal"><a href="#__codelineno-28-358">358</a></span>
<span class="normal"><a href="#__codelineno-28-359">359</a></span>
<span class="normal"><a href="#__codelineno-28-360">360</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.backends.cudnn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cudnn</span>
<a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
<a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">T</span>
<a id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_grid</span>
<a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-28-13" name="__codelineno-28-13"></a>
<a id="__codelineno-28-14" name="__codelineno-28-14"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-15" name="__codelineno-28-15"></a><span class="c1"># Configs &amp; utils</span>
<a id="__codelineno-28-16" name="__codelineno-28-16"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-17" name="__codelineno-28-17"></a><span class="n">seed</span> <span class="o">=</span> <span class="mi">3407</span>
<a id="__codelineno-28-18" name="__codelineno-28-18"></a><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span> <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-28-19" name="__codelineno-28-19"></a>
<a id="__codelineno-28-20" name="__codelineno-28-20"></a><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span><span class="p">)</span>
<a id="__codelineno-28-21" name="__codelineno-28-21"></a>
<a id="__codelineno-28-22" name="__codelineno-28-22"></a><span class="c1"># cuDNN 加速</span>
<a id="__codelineno-28-23" name="__codelineno-28-23"></a><span class="n">cudnn</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-28-24" name="__codelineno-28-24"></a><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-28-25" name="__codelineno-28-25"></a>
<a id="__codelineno-28-26" name="__codelineno-28-26"></a><span class="c1"># 显式禁用 TF32</span>
<a id="__codelineno-28-27" name="__codelineno-28-27"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-28-28" name="__codelineno-28-28"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">matmul</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-28-29" name="__codelineno-28-29"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">allow_tf32</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-28-30" name="__codelineno-28-30"></a><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-28-31" name="__codelineno-28-31"></a>    <span class="k">pass</span>
<a id="__codelineno-28-32" name="__codelineno-28-32"></a>
<a id="__codelineno-28-33" name="__codelineno-28-33"></a><span class="c1"># Hyper-params</span>
<a id="__codelineno-28-34" name="__codelineno-28-34"></a><span class="n">num_classes</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-28-35" name="__codelineno-28-35"></a><span class="n">image_size</span> <span class="o">=</span> <span class="mi">32</span>
<a id="__codelineno-28-36" name="__codelineno-28-36"></a><span class="n">z_dim</span> <span class="o">=</span> <span class="mi">128</span>
<a id="__codelineno-28-37" name="__codelineno-28-37"></a><span class="n">g_embed_dim</span> <span class="o">=</span> <span class="mi">128</span>
<a id="__codelineno-28-38" name="__codelineno-28-38"></a><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span>
<a id="__codelineno-28-39" name="__codelineno-28-39"></a><span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.999</span>
<a id="__codelineno-28-40" name="__codelineno-28-40"></a><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">250</span>
<a id="__codelineno-28-41" name="__codelineno-28-41"></a><span class="n">use_amp</span> <span class="o">=</span> <span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'cuda'</span><span class="p">)</span> 
<a id="__codelineno-28-42" name="__codelineno-28-42"></a><span class="n">use_channels_last</span> <span class="o">=</span> <span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">'cuda'</span><span class="p">)</span>
<a id="__codelineno-28-43" name="__codelineno-28-43"></a>
<a id="__codelineno-28-44" name="__codelineno-28-44"></a><span class="c1"># 抑制模式崩塌的关键超参</span>
<a id="__codelineno-28-45" name="__codelineno-28-45"></a><span class="n">real_label_smooth</span> <span class="o">=</span> <span class="mf">0.9</span>
<a id="__codelineno-28-46" name="__codelineno-28-46"></a><span class="n">lambda_cls</span> <span class="o">=</span> <span class="mf">0.5</span>                 <span class="c1"># 分类损失权重（AC-GAN 的 CE）</span>
<a id="__codelineno-28-47" name="__codelineno-28-47"></a><span class="n">lr_G</span><span class="p">,</span> <span class="n">lr_D</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">2e-4</span>          <span class="c1"># TTUR</span>
<a id="__codelineno-28-48" name="__codelineno-28-48"></a><span class="n">inst_noise_start</span> <span class="o">=</span> <span class="mf">0.1</span>           <span class="c1"># instance noise 初始标准差</span>
<a id="__codelineno-28-49" name="__codelineno-28-49"></a><span class="n">inst_noise_stop_frac</span> <span class="o">=</span> <span class="mf">0.5</span>       <span class="c1"># 在前 50% epoch 线性衰减到 0</span>
<a id="__codelineno-28-50" name="__codelineno-28-50"></a>
<a id="__codelineno-28-51" name="__codelineno-28-51"></a><span class="c1"># Data transforms: 无训练增广；仅归一化到 [-1, 1]</span>
<a id="__codelineno-28-52" name="__codelineno-28-52"></a><span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-28-53" name="__codelineno-28-53"></a><span class="n">std</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-28-54" name="__codelineno-28-54"></a><span class="n">train_tfms</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<a id="__codelineno-28-55" name="__codelineno-28-55"></a>    <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<a id="__codelineno-28-56" name="__codelineno-28-56"></a>    <span class="n">T</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">),</span>
<a id="__codelineno-28-57" name="__codelineno-28-57"></a><span class="p">])</span>
<a id="__codelineno-28-58" name="__codelineno-28-58"></a><span class="n">test_tfms</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<a id="__codelineno-28-59" name="__codelineno-28-59"></a>    <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<a id="__codelineno-28-60" name="__codelineno-28-60"></a>    <span class="n">T</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">),</span>
<a id="__codelineno-28-61" name="__codelineno-28-61"></a><span class="p">])</span>
<a id="__codelineno-28-62" name="__codelineno-28-62"></a>
<a id="__codelineno-28-63" name="__codelineno-28-63"></a><span class="c1"># Datasets &amp; Dataloaders</span>
<a id="__codelineno-28-64" name="__codelineno-28-64"></a><span class="n">train_set</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">train_tfms</span><span class="p">)</span>
<a id="__codelineno-28-65" name="__codelineno-28-65"></a><span class="n">test_set</span>  <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">test_tfms</span><span class="p">)</span>
<a id="__codelineno-28-66" name="__codelineno-28-66"></a>
<a id="__codelineno-28-67" name="__codelineno-28-67"></a><span class="n">loader_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<a id="__codelineno-28-68" name="__codelineno-28-68"></a>    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-28-69" name="__codelineno-28-69"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
<a id="__codelineno-28-70" name="__codelineno-28-70"></a>    <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-28-71" name="__codelineno-28-71"></a>    <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 若在 notebook 反复运行报错，可改为 False</span>
<a id="__codelineno-28-72" name="__codelineno-28-72"></a>    <span class="n">prefetch_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-28-73" name="__codelineno-28-73"></a><span class="p">)</span>
<a id="__codelineno-28-74" name="__codelineno-28-74"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">loader_kwargs</span><span class="p">)</span>
<a id="__codelineno-28-75" name="__codelineno-28-75"></a><span class="n">test_loader</span>  <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">loader_kwargs</span><span class="p">)</span>
<a id="__codelineno-28-76" name="__codelineno-28-76"></a>
<a id="__codelineno-28-77" name="__codelineno-28-77"></a><span class="n">classes</span> <span class="o">=</span> <span class="n">train_set</span><span class="o">.</span><span class="n">classes</span>
<a id="__codelineno-28-78" name="__codelineno-28-78"></a>
<a id="__codelineno-28-79" name="__codelineno-28-79"></a><span class="c1"># AMP autocast context</span>
<a id="__codelineno-28-80" name="__codelineno-28-80"></a><span class="n">amp_ctx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_amp</span> <span class="k">else</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">()</span>
<a id="__codelineno-28-81" name="__codelineno-28-81"></a>
<a id="__codelineno-28-82" name="__codelineno-28-82"></a><span class="k">def</span><span class="w"> </span><span class="nf">denorm</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="__codelineno-28-83" name="__codelineno-28-83"></a>    <span class="c1"># [-1, 1] -&gt; [0, 1]</span>
<a id="__codelineno-28-84" name="__codelineno-28-84"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-28-85" name="__codelineno-28-85"></a>
<a id="__codelineno-28-86" name="__codelineno-28-86"></a><span class="c1"># 训练用：在 D 输入侧加入 Instance Noise</span>
<a id="__codelineno-28-87" name="__codelineno-28-87"></a><span class="k">def</span><span class="w"> </span><span class="nf">add_instance_noise</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">start_std</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">stop_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<a id="__codelineno-28-88" name="__codelineno-28-88"></a>    <span class="n">stop_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_epochs</span> <span class="o">*</span> <span class="n">stop_frac</span><span class="p">)</span>
<a id="__codelineno-28-89" name="__codelineno-28-89"></a>    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="n">stop_epoch</span> <span class="ow">or</span> <span class="n">start_std</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-28-90" name="__codelineno-28-90"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-28-91" name="__codelineno-28-91"></a>    <span class="c1"># 线性衰减</span>
<a id="__codelineno-28-92" name="__codelineno-28-92"></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop_epoch</span><span class="p">)</span>
<a id="__codelineno-28-93" name="__codelineno-28-93"></a>    <span class="n">std</span> <span class="o">=</span> <span class="n">start_std</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>
<a id="__codelineno-28-94" name="__codelineno-28-94"></a>    <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">std</span>
<a id="__codelineno-28-95" name="__codelineno-28-95"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">noise</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-28-96" name="__codelineno-28-96"></a>
<a id="__codelineno-28-97" name="__codelineno-28-97"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-98" name="__codelineno-28-98"></a><span class="c1"># Models</span>
<a id="__codelineno-28-99" name="__codelineno-28-99"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-100" name="__codelineno-28-100"></a><span class="k">class</span><span class="w"> </span><span class="nc">Generator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-28-101" name="__codelineno-28-101"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">base_ch</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
<a id="__codelineno-28-102" name="__codelineno-28-102"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-28-103" name="__codelineno-28-103"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embed</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)</span>
<a id="__codelineno-28-104" name="__codelineno-28-104"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">z_dim</span> <span class="o">+</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">base_ch</span><span class="p">)</span>
<a id="__codelineno-28-105" name="__codelineno-28-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-28-106" name="__codelineno-28-106"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">base_ch</span><span class="p">),</span>
<a id="__codelineno-28-107" name="__codelineno-28-107"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-28-108" name="__codelineno-28-108"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">base_ch</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># 8x8</span>
<a id="__codelineno-28-109" name="__codelineno-28-109"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-28-110" name="__codelineno-28-110"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-28-111" name="__codelineno-28-111"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># 16x16</span>
<a id="__codelineno-28-112" name="__codelineno-28-112"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">4</span><span class="p">),</span>
<a id="__codelineno-28-113" name="__codelineno-28-113"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-28-114" name="__codelineno-28-114"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="c1"># 32x32</span>
<a id="__codelineno-28-115" name="__codelineno-28-115"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),</span>
<a id="__codelineno-28-116" name="__codelineno-28-116"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-28-117" name="__codelineno-28-117"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-28-118" name="__codelineno-28-118"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span>
<a id="__codelineno-28-119" name="__codelineno-28-119"></a>        <span class="p">)</span>
<a id="__codelineno-28-120" name="__codelineno-28-120"></a>
<a id="__codelineno-28-121" name="__codelineno-28-121"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a id="__codelineno-28-122" name="__codelineno-28-122"></a>        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-28-123" name="__codelineno-28-123"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">z</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-28-124" name="__codelineno-28-124"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-28-125" name="__codelineno-28-125"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># 兼容 channels_last</span>
<a id="__codelineno-28-126" name="__codelineno-28-126"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-28-127" name="__codelineno-28-127"></a>
<a id="__codelineno-28-128" name="__codelineno-28-128"></a><span class="k">class</span><span class="w"> </span><span class="nc">MinibatchStdDev</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-28-129" name="__codelineno-28-129"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
<a id="__codelineno-28-130" name="__codelineno-28-130"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-28-131" name="__codelineno-28-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
<a id="__codelineno-28-132" name="__codelineno-28-132"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-28-133" name="__codelineno-28-133"></a>        <span class="c1"># 计算批内标准差的均值，作为1个额外通道</span>
<a id="__codelineno-28-134" name="__codelineno-28-134"></a>        <span class="c1"># x: [N, C, H, W]</span>
<a id="__codelineno-28-135" name="__codelineno-28-135"></a>        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">unbiased</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>  <span class="c1"># [C, H, W]</span>
<a id="__codelineno-28-136" name="__codelineno-28-136"></a>        <span class="n">mean_std</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a id="__codelineno-28-137" name="__codelineno-28-137"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">mean_std</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-28-138" name="__codelineno-28-138"></a>
<a id="__codelineno-28-139" name="__codelineno-28-139"></a><span class="k">class</span><span class="w"> </span><span class="nc">Discriminator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-28-140" name="__codelineno-28-140"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">base_ch</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
<a id="__codelineno-28-141" name="__codelineno-28-141"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-28-142" name="__codelineno-28-142"></a>        <span class="n">sn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">spectral_norm</span>  <span class="c1"># 稳定训练</span>
<a id="__codelineno-28-143" name="__codelineno-28-143"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-28-144" name="__codelineno-28-144"></a>            <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">base_ch</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>                  <span class="c1"># 16x16</span>
<a id="__codelineno-28-145" name="__codelineno-28-145"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-28-146" name="__codelineno-28-146"></a>            <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base_ch</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>        <span class="c1"># 8x8</span>
<a id="__codelineno-28-147" name="__codelineno-28-147"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-28-148" name="__codelineno-28-148"></a>            <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>    <span class="c1"># 4x4</span>
<a id="__codelineno-28-149" name="__codelineno-28-149"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-28-150" name="__codelineno-28-150"></a>            <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">base_ch</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">base_ch</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>    <span class="c1"># 2x2</span>
<a id="__codelineno-28-151" name="__codelineno-28-151"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-28-152" name="__codelineno-28-152"></a>            <span class="n">MinibatchStdDev</span><span class="p">(),</span>                                               <span class="c1"># +1 通道</span>
<a id="__codelineno-28-153" name="__codelineno-28-153"></a>        <span class="p">)</span>
<a id="__codelineno-28-154" name="__codelineno-28-154"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">flatten_dim</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_ch</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span>
<a id="__codelineno-28-155" name="__codelineno-28-155"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">src_head</span> <span class="o">=</span> <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>            <span class="c1"># real/fake</span>
<a id="__codelineno-28-156" name="__codelineno-28-156"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cls_head</span> <span class="o">=</span> <span class="n">sn</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten_dim</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">))</span>  <span class="c1"># class logits</span>
<a id="__codelineno-28-157" name="__codelineno-28-157"></a>
<a id="__codelineno-28-158" name="__codelineno-28-158"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-28-159" name="__codelineno-28-159"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-28-160" name="__codelineno-28-160"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 兼容 channels_last</span>
<a id="__codelineno-28-161" name="__codelineno-28-161"></a>        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_head</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-28-162" name="__codelineno-28-162"></a>        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_head</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-28-163" name="__codelineno-28-163"></a>        <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="bp">cls</span>
<a id="__codelineno-28-164" name="__codelineno-28-164"></a>
<a id="__codelineno-28-165" name="__codelineno-28-165"></a><span class="k">def</span><span class="w"> </span><span class="nf">weights_init</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<a id="__codelineno-28-166" name="__codelineno-28-166"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">)):</span>
<a id="__codelineno-28-167" name="__codelineno-28-167"></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-28-168" name="__codelineno-28-168"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
<a id="__codelineno-28-169" name="__codelineno-28-169"></a>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">'bias'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-28-170" name="__codelineno-28-170"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
<a id="__codelineno-28-171" name="__codelineno-28-171"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
<a id="__codelineno-28-172" name="__codelineno-28-172"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
<a id="__codelineno-28-173" name="__codelineno-28-173"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
<a id="__codelineno-28-174" name="__codelineno-28-174"></a>
<a id="__codelineno-28-175" name="__codelineno-28-175"></a><span class="n">G</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="n">z_dim</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">g_embed_dim</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-28-176" name="__codelineno-28-176"></a><span class="n">D</span> <span class="o">=</span> <span class="n">Discriminator</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-28-177" name="__codelineno-28-177"></a>
<a id="__codelineno-28-178" name="__codelineno-28-178"></a><span class="k">if</span> <span class="n">use_channels_last</span><span class="p">:</span>
<a id="__codelineno-28-179" name="__codelineno-28-179"></a>    <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
<a id="__codelineno-28-180" name="__codelineno-28-180"></a>    <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
<a id="__codelineno-28-181" name="__codelineno-28-181"></a>
<a id="__codelineno-28-182" name="__codelineno-28-182"></a><span class="n">G</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">weights_init</span><span class="p">)</span>
<a id="__codelineno-28-183" name="__codelineno-28-183"></a><span class="n">D</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">weights_init</span><span class="p">)</span>
<a id="__codelineno-28-184" name="__codelineno-28-184"></a>
<a id="__codelineno-28-185" name="__codelineno-28-185"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-186" name="__codelineno-28-186"></a><span class="c1"># Optimizers &amp; Losses</span>
<a id="__codelineno-28-187" name="__codelineno-28-187"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-188" name="__codelineno-28-188"></a><span class="n">opt_G</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_G</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span><span class="p">))</span>  <span class="c1"># TTUR</span>
<a id="__codelineno-28-189" name="__codelineno-28-189"></a><span class="n">opt_D</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr_D</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span><span class="p">))</span>
<a id="__codelineno-28-190" name="__codelineno-28-190"></a>
<a id="__codelineno-28-191" name="__codelineno-28-191"></a><span class="n">bce</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">()</span>
<a id="__codelineno-28-192" name="__codelineno-28-192"></a><span class="n">ce</span>  <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<a id="__codelineno-28-193" name="__codelineno-28-193"></a>
<a id="__codelineno-28-194" name="__codelineno-28-194"></a><span class="n">scaler_G</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="n">use_amp</span><span class="p">)</span>
<a id="__codelineno-28-195" name="__codelineno-28-195"></a><span class="n">scaler_D</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="n">use_amp</span><span class="p">)</span>
<a id="__codelineno-28-196" name="__codelineno-28-196"></a>
<a id="__codelineno-28-197" name="__codelineno-28-197"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-198" name="__codelineno-28-198"></a><span class="c1"># Eval: classifier accuracy on test set</span>
<a id="__codelineno-28-199" name="__codelineno-28-199"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-200" name="__codelineno-28-200"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-28-201" name="__codelineno-28-201"></a><span class="k">def</span><span class="w"> </span><span class="nf">eval_test_accuracy</span><span class="p">():</span>
<a id="__codelineno-28-202" name="__codelineno-28-202"></a>    <span class="n">D</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-28-203" name="__codelineno-28-203"></a>    <span class="n">total</span><span class="p">,</span> <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<a id="__codelineno-28-204" name="__codelineno-28-204"></a>    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
<a id="__codelineno-28-205" name="__codelineno-28-205"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-206" name="__codelineno-28-206"></a>        <span class="k">if</span> <span class="n">use_channels_last</span><span class="p">:</span>
<a id="__codelineno-28-207" name="__codelineno-28-207"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
<a id="__codelineno-28-208" name="__codelineno-28-208"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-209" name="__codelineno-28-209"></a>        <span class="k">with</span> <span class="n">amp_ctx</span><span class="p">:</span>
<a id="__codelineno-28-210" name="__codelineno-28-210"></a>            <span class="n">_</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># 评估时不加噪声</span>
<a id="__codelineno-28-211" name="__codelineno-28-211"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-28-212" name="__codelineno-28-212"></a>        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-28-213" name="__codelineno-28-213"></a>        <span class="n">total</span> <span class="o">+=</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-28-214" name="__codelineno-28-214"></a>    <span class="n">acc</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
<a id="__codelineno-28-215" name="__codelineno-28-215"></a>    <span class="k">return</span> <span class="n">acc</span>
<a id="__codelineno-28-216" name="__codelineno-28-216"></a>
<a id="__codelineno-28-217" name="__codelineno-28-217"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-218" name="__codelineno-28-218"></a><span class="c1"># Training loop</span>
<a id="__codelineno-28-219" name="__codelineno-28-219"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-220" name="__codelineno-28-220"></a><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">():</span>
<a id="__codelineno-28-221" name="__codelineno-28-221"></a>    <span class="n">G</span><span class="o">.</span><span class="n">train</span><span class="p">();</span> <span class="n">D</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-28-222" name="__codelineno-28-222"></a>    <span class="n">hist_loss_D</span><span class="p">,</span> <span class="n">hist_loss_G</span><span class="p">,</span> <span class="n">hist_acc</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-28-223" name="__codelineno-28-223"></a>
<a id="__codelineno-28-224" name="__codelineno-28-224"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-28-225" name="__codelineno-28-225"></a>        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">'Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-226" name="__codelineno-28-226"></a>        <span class="n">running_D</span><span class="p">,</span> <span class="n">running_G</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
<a id="__codelineno-28-227" name="__codelineno-28-227"></a>
<a id="__codelineno-28-228" name="__codelineno-28-228"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pbar</span><span class="p">):</span>
<a id="__codelineno-28-229" name="__codelineno-28-229"></a>            <span class="n">x_real</span> <span class="o">=</span> <span class="n">x_real</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-230" name="__codelineno-28-230"></a>            <span class="k">if</span> <span class="n">use_channels_last</span><span class="p">:</span>
<a id="__codelineno-28-231" name="__codelineno-28-231"></a>                <span class="n">x_real</span> <span class="o">=</span> <span class="n">x_real</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">channels_last</span><span class="p">)</span>
<a id="__codelineno-28-232" name="__codelineno-28-232"></a>            <span class="n">y_real</span> <span class="o">=</span> <span class="n">y_real</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-233" name="__codelineno-28-233"></a>
<a id="__codelineno-28-234" name="__codelineno-28-234"></a>            <span class="n">bsz</span> <span class="o">=</span> <span class="n">x_real</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-28-235" name="__codelineno-28-235"></a>            <span class="n">valid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">bsz</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">real_label_smooth</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-28-236" name="__codelineno-28-236"></a>            <span class="n">fake</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-28-237" name="__codelineno-28-237"></a>
<a id="__codelineno-28-238" name="__codelineno-28-238"></a>            <span class="c1"># -----------------</span>
<a id="__codelineno-28-239" name="__codelineno-28-239"></a>            <span class="c1"># Train Discriminator</span>
<a id="__codelineno-28-240" name="__codelineno-28-240"></a>            <span class="c1"># -----------------</span>
<a id="__codelineno-28-241" name="__codelineno-28-241"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-28-242" name="__codelineno-28-242"></a>            <span class="n">y_fake</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="p">(</span><span class="n">bsz</span><span class="p">,),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-28-243" name="__codelineno-28-243"></a>
<a id="__codelineno-28-244" name="__codelineno-28-244"></a>            <span class="k">with</span> <span class="n">amp_ctx</span><span class="p">:</span>
<a id="__codelineno-28-245" name="__codelineno-28-245"></a>                <span class="n">x_fake</span> <span class="o">=</span> <span class="n">G</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y_fake</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-28-246" name="__codelineno-28-246"></a>
<a id="__codelineno-28-247" name="__codelineno-28-247"></a>                <span class="c1"># Instance noise（仅训练使用）</span>
<a id="__codelineno-28-248" name="__codelineno-28-248"></a>                <span class="n">x_real_in</span> <span class="o">=</span> <span class="n">add_instance_noise</span><span class="p">(</span><span class="n">x_real</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">inst_noise_start</span><span class="p">,</span> <span class="n">inst_noise_stop_frac</span><span class="p">)</span>
<a id="__codelineno-28-249" name="__codelineno-28-249"></a>                <span class="n">x_fake_in</span> <span class="o">=</span> <span class="n">add_instance_noise</span><span class="p">(</span><span class="n">x_fake</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">inst_noise_start</span><span class="p">,</span> <span class="n">inst_noise_stop_frac</span><span class="p">)</span>
<a id="__codelineno-28-250" name="__codelineno-28-250"></a>
<a id="__codelineno-28-251" name="__codelineno-28-251"></a>                <span class="n">d_src_real</span><span class="p">,</span> <span class="n">d_cls_real</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">x_real_in</span><span class="p">)</span>
<a id="__codelineno-28-252" name="__codelineno-28-252"></a>                <span class="n">d_src_fake</span><span class="p">,</span> <span class="n">d_cls_fake</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">x_fake_in</span><span class="p">)</span>
<a id="__codelineno-28-253" name="__codelineno-28-253"></a>
<a id="__codelineno-28-254" name="__codelineno-28-254"></a>                <span class="n">d_loss_real</span> <span class="o">=</span> <span class="n">bce</span><span class="p">(</span><span class="n">d_src_real</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">+</span> <span class="n">lambda_cls</span> <span class="o">*</span> <span class="n">ce</span><span class="p">(</span><span class="n">d_cls_real</span><span class="p">,</span> <span class="n">y_real</span><span class="p">)</span>
<a id="__codelineno-28-255" name="__codelineno-28-255"></a>                <span class="n">d_loss_fake</span> <span class="o">=</span> <span class="n">bce</span><span class="p">(</span><span class="n">d_src_fake</span><span class="p">,</span> <span class="n">fake</span><span class="p">)</span>  <span class="o">+</span> <span class="n">lambda_cls</span> <span class="o">*</span> <span class="n">ce</span><span class="p">(</span><span class="n">d_cls_fake</span><span class="p">,</span> <span class="n">y_fake</span><span class="p">)</span>
<a id="__codelineno-28-256" name="__codelineno-28-256"></a>                <span class="n">d_loss</span> <span class="o">=</span> <span class="n">d_loss_real</span> <span class="o">+</span> <span class="n">d_loss_fake</span>
<a id="__codelineno-28-257" name="__codelineno-28-257"></a>
<a id="__codelineno-28-258" name="__codelineno-28-258"></a>            <span class="n">opt_D</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-259" name="__codelineno-28-259"></a>            <span class="n">scaler_D</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">d_loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-28-260" name="__codelineno-28-260"></a>            <span class="n">scaler_D</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">opt_D</span><span class="p">)</span>
<a id="__codelineno-28-261" name="__codelineno-28-261"></a>            <span class="n">scaler_D</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<a id="__codelineno-28-262" name="__codelineno-28-262"></a>
<a id="__codelineno-28-263" name="__codelineno-28-263"></a>            <span class="c1"># -----------------</span>
<a id="__codelineno-28-264" name="__codelineno-28-264"></a>            <span class="c1"># Train Generator</span>
<a id="__codelineno-28-265" name="__codelineno-28-265"></a>            <span class="c1"># -----------------</span>
<a id="__codelineno-28-266" name="__codelineno-28-266"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-28-267" name="__codelineno-28-267"></a>            <span class="n">y_fake</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="p">(</span><span class="n">bsz</span><span class="p">,),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-28-268" name="__codelineno-28-268"></a>            <span class="k">with</span> <span class="n">amp_ctx</span><span class="p">:</span>
<a id="__codelineno-28-269" name="__codelineno-28-269"></a>                <span class="n">gen</span> <span class="o">=</span> <span class="n">G</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y_fake</span><span class="p">)</span>
<a id="__codelineno-28-270" name="__codelineno-28-270"></a>                <span class="c1"># G 反传路径也加同样的 instance noise</span>
<a id="__codelineno-28-271" name="__codelineno-28-271"></a>                <span class="n">gen_in</span> <span class="o">=</span> <span class="n">add_instance_noise</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">inst_noise_start</span><span class="p">,</span> <span class="n">inst_noise_stop_frac</span><span class="p">)</span>
<a id="__codelineno-28-272" name="__codelineno-28-272"></a>                <span class="n">g_src</span><span class="p">,</span> <span class="n">g_cls</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="n">gen_in</span><span class="p">)</span>
<a id="__codelineno-28-273" name="__codelineno-28-273"></a>                <span class="n">g_loss</span> <span class="o">=</span> <span class="n">bce</span><span class="p">(</span><span class="n">g_src</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span> <span class="o">+</span> <span class="n">lambda_cls</span> <span class="o">*</span> <span class="n">ce</span><span class="p">(</span><span class="n">g_cls</span><span class="p">,</span> <span class="n">y_fake</span><span class="p">)</span>
<a id="__codelineno-28-274" name="__codelineno-28-274"></a>
<a id="__codelineno-28-275" name="__codelineno-28-275"></a>            <span class="n">opt_G</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-276" name="__codelineno-28-276"></a>            <span class="n">scaler_G</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">g_loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-28-277" name="__codelineno-28-277"></a>            <span class="n">scaler_G</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">opt_G</span><span class="p">)</span>
<a id="__codelineno-28-278" name="__codelineno-28-278"></a>            <span class="n">scaler_G</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<a id="__codelineno-28-279" name="__codelineno-28-279"></a>
<a id="__codelineno-28-280" name="__codelineno-28-280"></a>            <span class="n">running_D</span> <span class="o">+=</span> <span class="n">d_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-28-281" name="__codelineno-28-281"></a>            <span class="n">running_G</span> <span class="o">+=</span> <span class="n">g_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-28-282" name="__codelineno-28-282"></a>
<a id="__codelineno-28-283" name="__codelineno-28-283"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-28-284" name="__codelineno-28-284"></a>                <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span>
<a id="__codelineno-28-285" name="__codelineno-28-285"></a>                    <span class="s1">'loss_D'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">running_D</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
<a id="__codelineno-28-286" name="__codelineno-28-286"></a>                    <span class="s1">'loss_G'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">running_G</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span>
<a id="__codelineno-28-287" name="__codelineno-28-287"></a>                <span class="p">})</span>
<a id="__codelineno-28-288" name="__codelineno-28-288"></a>
<a id="__codelineno-28-289" name="__codelineno-28-289"></a>        <span class="c1"># epoch 平均损失</span>
<a id="__codelineno-28-290" name="__codelineno-28-290"></a>        <span class="n">epoch_loss_D</span> <span class="o">=</span> <span class="n">running_D</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<a id="__codelineno-28-291" name="__codelineno-28-291"></a>        <span class="n">epoch_loss_G</span> <span class="o">=</span> <span class="n">running_G</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<a id="__codelineno-28-292" name="__codelineno-28-292"></a>        <span class="n">hist_loss_D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss_D</span><span class="p">)</span>
<a id="__codelineno-28-293" name="__codelineno-28-293"></a>        <span class="n">hist_loss_G</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss_G</span><span class="p">)</span>
<a id="__codelineno-28-294" name="__codelineno-28-294"></a>
<a id="__codelineno-28-295" name="__codelineno-28-295"></a>        <span class="c1"># 评估测试集准确率（判别器的辅助分类头）</span>
<a id="__codelineno-28-296" name="__codelineno-28-296"></a>        <span class="n">acc</span> <span class="o">=</span> <span class="n">eval_test_accuracy</span><span class="p">()</span>
<a id="__codelineno-28-297" name="__codelineno-28-297"></a>        <span class="n">hist_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
<a id="__codelineno-28-298" name="__codelineno-28-298"></a>
<a id="__codelineno-28-299" name="__codelineno-28-299"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'[Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">] loss_D=</span><span class="si">{</span><span class="n">epoch_loss_D</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> loss_G=</span><span class="si">{</span><span class="n">epoch_loss_G</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> | Test Acc=</span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%'</span><span class="p">)</span>
<a id="__codelineno-28-300" name="__codelineno-28-300"></a>
<a id="__codelineno-28-301" name="__codelineno-28-301"></a>        <span class="c1"># 继续训练模式</span>
<a id="__codelineno-28-302" name="__codelineno-28-302"></a>        <span class="n">D</span><span class="o">.</span><span class="n">train</span><span class="p">();</span> <span class="n">G</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-28-303" name="__codelineno-28-303"></a>
<a id="__codelineno-28-304" name="__codelineno-28-304"></a>    <span class="k">return</span> <span class="n">hist_loss_D</span><span class="p">,</span> <span class="n">hist_loss_G</span><span class="p">,</span> <span class="n">hist_acc</span>
<a id="__codelineno-28-305" name="__codelineno-28-305"></a>
<a id="__codelineno-28-306" name="__codelineno-28-306"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-307" name="__codelineno-28-307"></a><span class="c1"># Plot: 损失曲线 + 准确率曲线</span>
<a id="__codelineno-28-308" name="__codelineno-28-308"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-309" name="__codelineno-28-309"></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_history</span><span class="p">(</span><span class="n">loss_D</span><span class="p">,</span> <span class="n">loss_G</span><span class="p">,</span> <span class="n">acc</span><span class="p">):</span>
<a id="__codelineno-28-310" name="__codelineno-28-310"></a>    <span class="n">epochs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">loss_D</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-28-311" name="__codelineno-28-311"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-28-312" name="__codelineno-28-312"></a>    <span class="c1"># 损失</span>
<a id="__codelineno-28-313" name="__codelineno-28-313"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-28-314" name="__codelineno-28-314"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">loss_D</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'D loss'</span><span class="p">)</span>
<a id="__codelineno-28-315" name="__codelineno-28-315"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">loss_G</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'G loss'</span><span class="p">)</span>
<a id="__codelineno-28-316" name="__codelineno-28-316"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Epoch'</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Loss'</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'AC-GAN Training Loss'</span><span class="p">)</span>
<a id="__codelineno-28-317" name="__codelineno-28-317"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-28-318" name="__codelineno-28-318"></a>    <span class="c1"># 准确率</span>
<a id="__codelineno-28-319" name="__codelineno-28-319"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-28-320" name="__codelineno-28-320"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'tab:green'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Test Acc (%)'</span><span class="p">)</span>
<a id="__codelineno-28-321" name="__codelineno-28-321"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Epoch'</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Accuracy (%)'</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Aux Classifier Test Accuracy'</span><span class="p">)</span>
<a id="__codelineno-28-322" name="__codelineno-28-322"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-28-323" name="__codelineno-28-323"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-28-324" name="__codelineno-28-324"></a>
<a id="__codelineno-28-325" name="__codelineno-28-325"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-326" name="__codelineno-28-326"></a><span class="c1"># Generate: 横向 10 类 × 每类 5 张，列顶显示标签</span>
<a id="__codelineno-28-327" name="__codelineno-28-327"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-328" name="__codelineno-28-328"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-28-329" name="__codelineno-28-329"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_grid_horizontal_labeled</span><span class="p">(</span><span class="n">n_per</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-28-330" name="__codelineno-28-330"></a>    <span class="n">G</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-28-331" name="__codelineno-28-331"></a>    <span class="n">imgs_by_class</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-28-332" name="__codelineno-28-332"></a>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-28-333" name="__codelineno-28-333"></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_per</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-28-334" name="__codelineno-28-334"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_per</span><span class="p">,),</span> <span class="n">c</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-28-335" name="__codelineno-28-335"></a>        <span class="c1"># 关闭 autocast 或显示前转 float32，避免 matplotlib 不支持 float16</span>
<a id="__codelineno-28-336" name="__codelineno-28-336"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_amp</span> <span class="k">else</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">():</span>
<a id="__codelineno-28-337" name="__codelineno-28-337"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">G</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-28-338" name="__codelineno-28-338"></a>        <span class="n">imgs_by_class</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>  <span class="c1"># [n_per, 3, 32, 32]</span>
<a id="__codelineno-28-339" name="__codelineno-28-339"></a>
<a id="__codelineno-28-340" name="__codelineno-28-340"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_per</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_classes</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">,</span> <span class="n">n_per</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">))</span>
<a id="__codelineno-28-341" name="__codelineno-28-341"></a>    <span class="k">if</span> <span class="n">n_per</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-28-342" name="__codelineno-28-342"></a>        <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-28-343" name="__codelineno-28-343"></a>
<a id="__codelineno-28-344" name="__codelineno-28-344"></a>    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-28-345" name="__codelineno-28-345"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-28-346" name="__codelineno-28-346"></a>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_per</span><span class="p">):</span>
<a id="__codelineno-28-347" name="__codelineno-28-347"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">denorm</span><span class="p">(</span><span class="n">imgs_by_class</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">row</span><span class="p">])</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-28-348" name="__codelineno-28-348"></a>            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
<a id="__codelineno-28-349" name="__codelineno-28-349"></a>            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-28-350" name="__codelineno-28-350"></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-28-351" name="__codelineno-28-351"></a>
<a id="__codelineno-28-352" name="__codelineno-28-352"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">w_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">h_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-28-353" name="__codelineno-28-353"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-28-354" name="__codelineno-28-354"></a>
<a id="__codelineno-28-355" name="__codelineno-28-355"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-356" name="__codelineno-28-356"></a><span class="c1"># Run</span>
<a id="__codelineno-28-357" name="__codelineno-28-357"></a><span class="c1"># -------------------</span>
<a id="__codelineno-28-358" name="__codelineno-28-358"></a><span class="n">loss_D_hist</span><span class="p">,</span> <span class="n">loss_G_hist</span><span class="p">,</span> <span class="n">acc_hist</span> <span class="o">=</span> <span class="n">train</span><span class="p">()</span>
<a id="__codelineno-28-359" name="__codelineno-28-359"></a><span class="n">plot_history</span><span class="p">(</span><span class="n">loss_D_hist</span><span class="p">,</span> <span class="n">loss_G_hist</span><span class="p">,</span> <span class="n">acc_hist</span><span class="p">)</span>
<a id="__codelineno-28-360" name="__codelineno-28-360"></a><span class="n">generate_grid_horizontal_labeled</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<p>可以看到，模型训练相当稳定，准确率也比之前高了一些，达到了 69% 的水准。</p>
<p><img alt="loss" src="../Image-models-replication-assets/ver2_loss.png"/></p>
<p>生成的图像里面，也有很多是挺像模像样的。</p>
<p><img alt="gen" src="../Image-models-replication-assets/ver2_gen.png"/></p>
<h2 id="_4">总结<a class="headerlink" href="#_4" title="Permanent link">¶</a></h2>
<p>通过本次对多个经典及探索性模型的复现之旅，我们从最基础的 MLP 一路走到复杂的生成式网络，不仅观察了它们在 CIFAR-10 数据集上的性能差异，更深入体会了其设计哲学背后的演变逻辑。这些实验告诉我们，模型的选择绝非简单的性能排行榜，而是一场在<strong>精度、效率、数据依赖性和架构复杂性</strong>之间的多维权衡。</p>
<p>最初的 MLP 像是一把万能钥匙，试图用巨量的参数强行拟合所有问题，但它忽略了图像最基本的空间结构信息，效率低下，最终结果也难尽如人意。<strong>CNN 的引入是一个革命性的突破</strong>，它通过卷积、池化等操作巧妙地注入了“平移不变性”和“局部性”的先验知识，使得网络能够更高效地捕捉图像特征。我们的复现也印证了这一点，一个参数量更少的简单 CNN 取得了远优于 MLP 的效果。而 <strong>ResNet 及其残差连接</strong>则进一步解决了深层网络的梯度传递难题，让网络能够向更深、更强大的方向发展，成为此后多年来的中流砥柱。</p>
<p><strong>Transformer 的出现改变了游戏规则</strong>。ViT 将图像拆分为 Patch，并利用自注意力机制进行全局建模，这种“无先验”的设计使其在大规模数据上展现了惊人的 Scaling Law。我们的实验清晰展示了这一点：在小规模从头训练的 nanoViT 表现平平，但其大型预训练版本（ViT-B）通过微调便能达到惊人的性能，这揭示了“预训练+微调”范式在当今 AI 领域的绝对统治力。</p>
<p>而那些“邪门”的探索，如 PatchLSTM、VAE 和 AC-GAN，则从另一个维度拓展了我们的视野。它们证明了图像的表示和学习方式可以多种多样——无论是用序列模型处理，还是通过学习数据分布本身来获得强大的特征表示。特别是将 VAE 作为正则化器与分类器联合训练的思路，在数据稀缺的场景下显示出独特的价值。</p>
<p>为了更直观地对比，我们将本次复现的核心结果归纳如下表：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">模型</th>
<th style="text-align: left;">参数量</th>
<th style="text-align: left;">测试准确率</th>
<th style="text-align: left;">特点与适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>MLP</strong></td>
<td style="text-align: left;">~1.7M</td>
<td style="text-align: left;">54.44%</td>
<td style="text-align: left;">基线模型，忽略空间结构，效率低，仅用于教学和理解。</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CNN</strong></td>
<td style="text-align: left;">~1.1M</td>
<td style="text-align: left;">77.33%</td>
<td style="text-align: left;">架构高效，引入局部性与平移不变性先验，精度与速度的良好平衡。</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ResNet-18 (从零训练)</strong></td>
<td style="text-align: left;">~11.2M</td>
<td style="text-align: left;">83.46%</td>
<td style="text-align: left;">深层网络典范，残差连接解决梯度问题，通用性强。</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ResNet-18 (微调)</strong></td>
<td style="text-align: left;">~11.2M</td>
<td style="text-align: left;">89.06%</td>
<td style="text-align: left;"><strong>预训练+微调</strong>范式的体现，利用迁移学习获得优异性能。</td>
</tr>
<tr>
<td style="text-align: left;"><strong>nanoViT (从零训练)</strong></td>
<td style="text-align: left;">~1.2M</td>
<td style="text-align: left;">73.24%</td>
<td style="text-align: left;">数据不足时易过拟合，但展现了全局建模的潜力。</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ViT-B/16 (微调)</strong></td>
<td style="text-align: left;">&gt;86M</td>
<td style="text-align: left;"><strong>95.42%</strong></td>
<td style="text-align: left;"><strong>大数据预训练</strong>力量的证明，当前 SOTA 的代表，精度天花板高。</td>
</tr>
<tr>
<td style="text-align: left;"><strong>PatchLSTM</strong></td>
<td style="text-align: left;">~2.5M</td>
<td style="text-align: left;">68.11%</td>
<td style="text-align: left;">将图像视为序列的探索性尝试，性能通常不如CNN，效率较低。</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VAE (无监督聚类)</strong></td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">~24%</td>
<td style="text-align: left;">验证了隐空间特征的有效性，但无监督分类与语义标签有天然差距。</td>
</tr>
<tr>
<td style="text-align: left;"><strong>VAE + 分类头</strong></td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">~82%</td>
<td style="text-align: left;">生成式损失作为正则项，<strong>在数据稀缺时</strong>是提升泛化的有效手段。</td>
</tr>
<tr>
<td style="text-align: left;"><strong>AC-GAN</strong></td>
<td style="text-align: left;">-</td>
<td style="text-align: left;">~69%</td>
<td style="text-align: left;">兼具生成与分类能力，适用于<strong>半监督学习</strong>和需要生成能力的场景。</td>
</tr>
</tbody>
</table>
<p>纵观上表，我们可以得出更贴近实践的结论：</p>
<ul>
<li><strong>若追求极致精度且资源充足</strong>：<strong>大规模预训练模型（如 ViT, ResNet）微调</strong>是毋庸置疑的首选，这是当前应用和研究的主流。</li>
<li><strong>若需从零开始训练</strong>：<strong>CNN 及它的现代变体（如 ResNet 等）</strong> 仍然是稳健和高效的选择，在精度、速度和可靠性之间取得了最佳平衡。</li>
<li><strong>若面临数据稀缺的挑战</strong>：<strong>生成式模型（如 VAE 和 GAN）</strong> 提供了一条不同的思路。将其作为特征提取器或正则化器与分类任务联合训练，往往能通过利用数据本身分布来提升模型泛化能力。</li>
<li><strong>若进行模型探索与研究</strong>：Transformer、基于序列的模型乃至生成对抗网络，为我们打开了新的可能性，但它们通常需要更多的数据、调优技巧和计算资源，也面临未知的性能上限和更具挑战性的过程。</li>
</ul>
<p>本文是复现笔记系列的第一篇。图像分类很简单也很经典，但也催生了诸多高效的模型。希望本篇文章的复现经历与对比分析，能为各位看官的选择提供一份有价值的参考。作者功力尚陋，不足之处请在下方评论区批评指正，切磋交流。感谢您的阅读。</p>
<div class="admonition info">
<p class="admonition-title">📝 如果您需要引用本文</p>
<p>Yan Li. (Sep. 8, 2025). 图像分类相关模型复现手记 [Blog post]. Retrieved from <a href="https://dicaeopolis.github.io/DNN/model-expr/Image-models-replication">https://dicaeopolis.github.io/DNN/model-expr/Image-models-replication</a></p>
<p>在 BibTeX 格式中：
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span>
<span class="normal"><a href="#__codelineno-29-4">4</a></span>
<span class="normal"><a href="#__codelineno-29-5">5</a></span>
<span class="normal"><a href="#__codelineno-29-6">6</a></span>
<span class="normal"><a href="#__codelineno-29-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a>@online{Image-models-replication,
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>    title={图像分类相关模型复现手记},
<a id="__codelineno-29-3" name="__codelineno-29-3"></a>    author={Yan Li},
<a id="__codelineno-29-4" name="__codelineno-29-4"></a>    year={2025},
<a id="__codelineno-29-5" name="__codelineno-29-5"></a>    month={Sep},
<a id="__codelineno-29-6" name="__codelineno-29-6"></a>    url={\url{https://dicaeopolis.github.io/DNN/model-expr/Image-models-replication}},
<a id="__codelineno-29-7" name="__codelineno-29-7"></a>}
</code></pre></div></td></tr></table></div></p>
</div>
<form class="md-feedback" hidden="" name="feedback">
<fieldset>
<legend class="md-feedback__title">
        Was this page helpful?
      </legend>
<div class="md-feedback__inner">
<div class="md-feedback__list">
<button class="md-feedback__icon md-icon" data-md-value="1" title="This page was helpful" type="submit">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"></path></svg>
</button>
<button class="md-feedback__icon md-icon" data-md-value="0" title="This page could be improved" type="submit">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"></path></svg>
</button>
</div>
<div class="md-feedback__note">
<div data-md-value="1" hidden="">
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
<div data-md-value="0" hidden="">
              
              
                
              
              
              
                
                
              
              Thanks for your feedback! Help us improve this page by using our <a href="..." rel="noopener" target="_blank">feedback form</a>.
            </div>
</div>
</div>
</fieldset>
</form>
<h2 id="__comments">评论</h2>
<!-- Giscus 脚本粘贴在这里 -->
<script async="" crossorigin="anonymous" data-category="Comments" data-category-id="DIC_kwDOOfbpCM4CtuiH" data-emit-metadata="0" data-input-position="bottom" data-lang="zh-CN" data-mapping="pathname" data-reactions-enabled="1" data-repo="dicaeopolis/dicaeopolis.github.io" data-repo-id="R_kgDOOfbpCA" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js">
</script>
<!-- 这段脚本用于同步 Giscus 和 mkdocs-material 的主题 -->
<script>
    var giscus = document.querySelector("script[src*=giscus]");
    document.addEventListener("DOMContentLoaded", function () {
      var palette = __md_get("__palette");
      if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "transparent_dark" : "light";
        giscus.setAttribute("data-theme", theme);
      }
      var ref = document.querySelector("[data-md-component=palette]");
      ref.addEventListener("change", function () {
        var palette = __md_get("__palette");
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "transparent_dark" : "light";
          var message = { setConfig: { theme: theme } };
          var frame = document.querySelector(".giscus-frame");
          frame.contentWindow.postMessage({ giscus: message }, "https://giscus.app");
        }
      });
    });
  </script>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "content.code.select", "navigation.titles", "navigation.tabs", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
<script src="../../../assets/js/custom.js"></script>
<script src="../../../themes/js/custom.js"></script>
<script src="../../../themes/js/simpleLightbox.min.js"></script>
<script src="../../../themes/js/optionalConfig.js"></script>
<script src="../../../themes/js/mermaidloader.js"></script>
<script src="../../../themes/js/umlconvert.js"></script>
<script src="../../../themes/js/mathjax.js"></script>
<script src="../../../themes/js/katex.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.17.1/flowchart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mermaid-js/mermaid-mindmap@9.3.0/dist/diagram-definition.0faef4c2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-plantuml@1.4.1/index.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml-full.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-svg-full.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
</body>
</html>