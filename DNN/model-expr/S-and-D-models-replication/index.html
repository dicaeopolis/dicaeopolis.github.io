
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../DDPM/" rel="prev"/>
<link href="../Image-models-replication/" rel="next"/>
<link href="../../../favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>å›¾åƒè¯­ä¹‰åˆ†å‰²å’Œç›®æ ‡æ£€æµ‹ç›¸å…³æ¨¡å‹å¤ç°æ‰‹è®° - Dicaeopolis' Wiki</title>
<link href="../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../themes/css/custom.css" rel="stylesheet"/>
<link href="../../../themes/css/simpleLightbox.min.css" rel="stylesheet"/>
<link href="../../../themes/css/pied_piper.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" rel="stylesheet"/>
<link href="../../../stylesheets/customize.css" rel="stylesheet"/>
<link href="../../../assets/css/custom.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          è·³è½¬è‡³
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="é¡µçœ‰" class="md-header__inner md-grid">
<a aria-label="Dicaeopolis' Wiki" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="Dicaeopolis' Wiki">
<img alt="logo" src="../../../favicon.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Dicaeopolis' Wiki
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              å›¾åƒè¯­ä¹‰åˆ†å‰²å’Œç›®æ ‡æ£€æµ‹ç›¸å…³æ¨¡å‹å¤ç°æ‰‹è®°
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg>
</label>
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="æœç´¢" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="æœç´¢" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="æŸ¥æ‰¾" class="md-search__options">
<button aria-label="æ¸…ç©ºå½“å‰å†…å®¹" class="md-search__icon md-icon" tabindex="-1" title="æ¸…ç©ºå½“å‰å†…å®¹" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="æ ‡ç­¾" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../astronomy/">
          
  
  
    
  
  å¤©æ–‡æ‘„å½±ç†è®ºå’Œå®è·µ

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../campus-sources/">
          
  
  
    
  
  æ ¡å†…è¯¾ç¨‹çŸ¥è¯†

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
    
  
  æ·±åº¦ç¥ç»ç½‘ç»œ

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../misc/">
          
  
  
    
  
  é…ç½®å’Œæ‚è°ˆç¬”è®°

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../algorithm/">
          
  
  
    
  
  ä¼ ç»Ÿç®—æ³•ä¸æ€§èƒ½

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="å¯¼èˆªæ " class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Dicaeopolis' Wiki" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="Dicaeopolis' Wiki">
<img alt="logo" src="../../../favicon.png"/>
</a>
    Dicaeopolis' Wiki
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../astronomy/">
<span class="md-ellipsis">
    
  
    å¤©æ–‡æ‘„å½±ç†è®ºå’Œå®è·µ
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_1">
<span class="md-nav__icon md-icon"></span>
            
  
    å¤©æ–‡æ‘„å½±ç†è®ºå’Œå®è·µ
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../astronomy/gallery/">
<span class="md-ellipsis">
    
  
    æ·±ç©ºå½±é›†
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../astronomy/polar/">
<span class="md-ellipsis">
    
  
    çœ‹ä¸è§åŒ—ææ˜Ÿæ€ä¹ˆåŠ
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../astronomy/%E6%96%B9%E4%BD%8D%E8%B0%83%E8%8A%82/">
<span class="md-ellipsis">
    
  
    æ–¹ä½è°ƒèŠ‚
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../astronomy/%E7%BA%AC%E5%BA%A6%E8%B0%83%E8%8A%82/">
<span class="md-ellipsis">
    
  
    çº¬åº¦è°ƒèŠ‚
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../campus-sources/">
<span class="md-ellipsis">
    
  
    æ ¡å†…è¯¾ç¨‹çŸ¥è¯†
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            
  
    æ ¡å†…è¯¾ç¨‹çŸ¥è¯†
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/SDC-exams/">
<span class="md-ellipsis">
    
  
    ã€Šè®¡ç®—æœºç»„æˆä¸è®¾è®¡ã€‹éƒ¨åˆ†å†å¹´é¢˜ç›®é¢˜è§£
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/Discrete_exams/">
<span class="md-ellipsis">
    
  
    ã€Šç¦»æ•£æ•°å­¦ã€‹éƒ¨åˆ†æœŸæœ«é¢˜ç›®é¢˜è§£
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/Discrete_notes/">
<span class="md-ellipsis">
    
  
    ç¦»æ•£æœŸæœ«å¤ä¹ æçº²
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/Descrete_assignments/">
<span class="md-ellipsis">
    
  
    ã€Šç¦»æ•£æ•°å­¦ã€‹è¯¾ç¨‹ä½œä¸šä¸ç¬”è®°å½’æ¡£
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/Prob_Stats_assignments/">
<span class="md-ellipsis">
    
  
    ã€Šæ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡ã€‹è¯¾ç¨‹ä½œä¸šä¸ç¬”è®°å½’æ¡£
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/SDC_assignments/">
<span class="md-ellipsis">
    
  
    ã€Šè®¡ç®—æœºç»„æˆåŸç†ã€‹ç†è®ºè¯¾ç¨‹ä½œä¸šä¸ç¬”è®°å½’æ¡£
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/PU_Bii_assignments/">
<span class="md-ellipsis">
    
  
    ã€Šå¤§å­¦ç‰©ç†Bä¸‹ã€‹è¯¾ç¨‹ä½œä¸šä¸ç¬”è®°å½’æ¡£
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/binmul/">
<span class="md-ellipsis">
<i class="fas fa-calculator"></i> äºŒè¿›åˆ¶ä¹˜æ³•å¯è§†åŒ–å·¥å…·
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/textbook/">
<span class="md-ellipsis">
    
  
    æœ¬ç§‘æ•™ç§‘ä¹¦ç”µå­èµ„æº
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/ds-keynote/">
<span class="md-ellipsis">
    
  
    ã€Šæ•°æ®ç»“æ„ã€‹åˆ’é‡ç‚¹ç¬”è®°
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/ds-write-up/">
<span class="md-ellipsis">
    
  
    ã€Šæ•°æ®ç»“æ„ã€‹æœŸæœ«å¤ä¹ é¢˜é¢˜è§£
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/autosignin/">
<span class="md-ellipsis">
    
  
    è‡ªåŠ¨ç­¾åˆ°è„šæœ¬
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    æ·±åº¦ç¥ç»ç½‘ç»œ
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    æ·±åº¦ç¥ç»ç½‘ç»œ
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../match/">
<span class="md-ellipsis">
    
  
    å¦‚ä½•åšå››å…­çº§è€ƒè¯•çš„æ®µè½åŒ¹é…é¢˜
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../BP/">
<span class="md-ellipsis">
    
  
    å‰é¦ˆç¥ç»ç½‘ç»œçš„åå‘ä¼ æ’­
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../RL/">
<span class="md-ellipsis">
    
  
    RLå­¦ä¹ ç¬”è®° - ä¸Šç¯‡
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../SVM_SMO/">
<span class="md-ellipsis">
    
  
    SMO ç®—æ³•çš„æ¨å¯¼
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Wp
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
            
  
    Wp
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../WP/aiwp/">
<span class="md-ellipsis">
    
  
    MISC-AI æ–¹å‘ WriteUp
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_7" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../model-attack/">
<span class="md-ellipsis">
    
  
    æ·±åº¦å­¦ä¹ æ¨¡å‹æ”»å‡»ç†è®ºä¸å¤ç°å½’æ¡£
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_7">
<span class="md-nav__icon md-icon"></span>
            
  
    æ·±åº¦å­¦ä¹ æ¨¡å‹æ”»å‡»ç†è®ºä¸å¤ç°å½’æ¡£
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/hsja/">
<span class="md-ellipsis">
    
  
    HSJA æ”»å‡»
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/BadNets/">
<span class="md-ellipsis">
    
  
    BadNets
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/CandW/">
<span class="md-ellipsis">
    
  
    C&amp;W æ”»å‡»
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/pgd/">
<span class="md-ellipsis">
    
  
    PGD æ”»å‡»
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/fgsm/">
<span class="md-ellipsis">
    
  
    FGSM æ”»å‡»
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_8" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    
  
    æ·±åº¦å­¦ä¹ ç›¸å…³æ¨¡å‹ç†è®ºä¸å¤ç°å½’æ¡£
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_3_8_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_8">
<span class="md-nav__icon md-icon"></span>
            
  
    æ·±åº¦å­¦ä¹ ç›¸å…³æ¨¡å‹ç†è®ºä¸å¤ç°å½’æ¡£
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../DDPM/">
<span class="md-ellipsis">
    
  
    æ‰©æ•£æ¨¡å‹ç†è®ºç¯‡: ä»å¤šé˜¶æ®µå˜åˆ†è‡ªç¼–ç å™¨åˆ°æ¦‚ç‡æµå¸¸å¾®åˆ†æ–¹ç¨‹é‡‡æ ·å™¨ç³»åˆ—
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    å›¾åƒè¯­ä¹‰åˆ†å‰²å’Œç›®æ ‡æ£€æµ‹ç›¸å…³æ¨¡å‹å¤ç°æ‰‹è®°
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    å›¾åƒè¯­ä¹‰åˆ†å‰²å’Œç›®æ ‡æ£€æµ‹ç›¸å…³æ¨¡å‹å¤ç°æ‰‹è®°
  

    
  </span>
</a>
<nav aria-label="ç›®å½•" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      
        è¯­ä¹‰åˆ†å‰²
      
    </span>
</a>
<nav aria-label="è¯­ä¹‰åˆ†å‰²" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fcn">
<span class="md-ellipsis">
      
        FCN
      
    </span>
</a>
<nav aria-label="FCN" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      
        æ¶æ„
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      
        æŒ‡æ ‡
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_5">
<span class="md-ellipsis">
      
        å®ç°ç»†èŠ‚
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_6">
<span class="md-ellipsis">
      
        è®­ç»ƒç»“æœ
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#u-net">
<span class="md-ellipsis">
      
        U-Net
      
    </span>
</a>
<nav aria-label="U-Net" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_7">
<span class="md-ellipsis">
      
        åŸç†
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_8">
<span class="md-ellipsis">
      
        è®­ç»ƒä»£ç 
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_9">
<span class="md-ellipsis">
      
        ç»“æœ
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_10">
<span class="md-ellipsis">
      
        ç¢ç¢å¿µ
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_11">
<span class="md-ellipsis">
      
        ç›®æ ‡æ£€æµ‹
      
    </span>
</a>
<nav aria-label="ç›®æ ‡æ£€æµ‹" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#yolo-v1">
<span class="md-ellipsis">
      
        YOLO v1
      
    </span>
</a>
<nav aria-label="YOLO v1" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_12">
<span class="md-ellipsis">
      
        æ¨¡å‹æ¶æ„
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_13">
<span class="md-ellipsis">
      
        æŸå¤±å‡½æ•°
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_14">
<span class="md-ellipsis">
      
        ç½‘ç»œç»“æ„
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#map">
<span class="md-ellipsis">
      
        mAP
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_15">
<span class="md-ellipsis">
      
        è®­ç»ƒ
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_16">
<span class="md-ellipsis">
      
        æ¨ç†ä¸è¯„ä¼°
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_17">
<span class="md-ellipsis">
      
        å¯è§†åŒ–
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Image-models-replication/">
<span class="md-ellipsis">
    
  
    å›¾åƒåˆ†ç±»ç›¸å…³æ¨¡å‹å¤ç°æ‰‹è®°
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../DC-GAN-%E8%80%81%E5%A9%86%E7%94%9F%E6%88%90%E5%99%A8/">
<span class="md-ellipsis">
    
  
    DC-GAN è€å©†ç”Ÿæˆå™¨
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_9" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../optimizer/">
<span class="md-ellipsis">
    
  
    ä¼˜åŒ–å™¨
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_3_9" id="__nav_3_9_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_9_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_9">
<span class="md-nav__icon md-icon"></span>
            
  
    ä¼˜åŒ–å™¨
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/misc/">
<span class="md-ellipsis">
    
  
    åç»­çš„å†™ä½œè®¡åˆ’
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/SignGD/">
<span class="md-ellipsis">
    
  
    ç¬¦å·æ¢¯åº¦ä¸‹é™
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/Adaptive/">
<span class="md-ellipsis">
    
  
    è‡ªé€‚åº”å­¦ä¹ ç‡æ”¹è¿›ç­–ç•¥
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/SGD/">
<span class="md-ellipsis">
    
  
    SGD ç³»åˆ—ç®—æ³•
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../misc/">
<span class="md-ellipsis">
    
  
    é…ç½®å’Œæ‚è°ˆç¬”è®°
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            
  
    é…ç½®å’Œæ‚è°ˆç¬”è®°
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../misc/test/">
<span class="md-ellipsis">
    
  
    åŠŸèƒ½æµ‹è¯•é¡µé¢
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../algorithm/">
<span class="md-ellipsis">
    
  
    ä¼ ç»Ÿç®—æ³•ä¸æ€§èƒ½
  

    
  </span>
</a>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            
  
    ä¼ ç»Ÿç®—æ³•ä¸æ€§èƒ½
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../algorithm/benchmark-on-stl/">
<span class="md-ellipsis">
    
  
    STLçš„ä¸€äº›æ€§èƒ½æµ‹è¯•
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../algorithm/stl-wheels/">
<span class="md-ellipsis">
    
  
    å—¯é€ è½®å­
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../algorithm/template-on-numeric-ring/">
<span class="md-ellipsis">
    
  
    æ•´æ•°ç¯å–æ¨¡æ¨¡æ¿
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="ç›®å½•" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      
        è¯­ä¹‰åˆ†å‰²
      
    </span>
</a>
<nav aria-label="è¯­ä¹‰åˆ†å‰²" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fcn">
<span class="md-ellipsis">
      
        FCN
      
    </span>
</a>
<nav aria-label="FCN" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      
        æ¶æ„
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      
        æŒ‡æ ‡
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_5">
<span class="md-ellipsis">
      
        å®ç°ç»†èŠ‚
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_6">
<span class="md-ellipsis">
      
        è®­ç»ƒç»“æœ
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#u-net">
<span class="md-ellipsis">
      
        U-Net
      
    </span>
</a>
<nav aria-label="U-Net" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_7">
<span class="md-ellipsis">
      
        åŸç†
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_8">
<span class="md-ellipsis">
      
        è®­ç»ƒä»£ç 
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_9">
<span class="md-ellipsis">
      
        ç»“æœ
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_10">
<span class="md-ellipsis">
      
        ç¢ç¢å¿µ
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_11">
<span class="md-ellipsis">
      
        ç›®æ ‡æ£€æµ‹
      
    </span>
</a>
<nav aria-label="ç›®æ ‡æ£€æµ‹" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#yolo-v1">
<span class="md-ellipsis">
      
        YOLO v1
      
    </span>
</a>
<nav aria-label="YOLO v1" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_12">
<span class="md-ellipsis">
      
        æ¨¡å‹æ¶æ„
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_13">
<span class="md-ellipsis">
      
        æŸå¤±å‡½æ•°
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_14">
<span class="md-ellipsis">
      
        ç½‘ç»œç»“æ„
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#map">
<span class="md-ellipsis">
      
        mAP
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_15">
<span class="md-ellipsis">
      
        è®­ç»ƒ
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_16">
<span class="md-ellipsis">
      
        æ¨ç†ä¸è¯„ä¼°
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_17">
<span class="md-ellipsis">
      
        å¯è§†åŒ–
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="_1">å›¾åƒè¯­ä¹‰åˆ†å‰²å’Œç›®æ ‡æ£€æµ‹ç›¸å…³æ¨¡å‹å¤ç°æ‰‹è®°<a class="headerlink" href="#_1" title="Permanent link">Â¶</a></h1>
<div class="admonition info">
<p class="admonition-title">ğŸ“– é˜…è¯»ä¿¡æ¯</p>
<p>é˜…è¯»æ—¶é—´çº¦ <strong>57</strong> åˆ†é’Ÿã€€|ã€€çº¦ <strong>6436</strong> å­—ã€€|ã€€çº¦ <strong>59</strong> ä¸ªå…¬å¼ã€€|ã€€çº¦ <strong>2069</strong> è¡Œä»£ç </p>
</div>
<h2 id="_2">è¯­ä¹‰åˆ†å‰²<a class="headerlink" href="#_2" title="Permanent link">Â¶</a></h2>
<p>è¯­ä¹‰åˆ†å‰²çš„éš¾ç‚¹åœ¨äºè¾“å‡ºåˆ°å’ŒåŸå›¾<strong>åˆ†è¾¨ç‡ä¸€è‡´</strong>çš„ç‰¹å¾å›¾ã€‚å› æ­¤ä¸ç®¡æ˜¯ FCN, U-Net è¿˜æ˜¯ Deeplab ç­‰ç½‘ç»œï¼Œå…³é”®ç‚¹ä¸»è¦åœ¨äº<strong>ä¸‹é‡‡æ ·å’Œä¸Šé‡‡æ ·çš„ä¿¡æ¯æµåŠ¨</strong>ã€‚ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨ä¸‹é‡‡æ ·æ¥è·å–ç‰¹å¾å›¾è¿›è¡Œåˆ†å‰²åˆ†ç±»ï¼Œè¿™è¦æ±‚ä¸‹é‡‡æ ·è¿‡ç¨‹èƒ½å¤Ÿé«˜æ•ˆæå–ä¿¡æ¯ï¼›å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹ä¸‹é‡‡æ ·ä¹‹åçš„ç»“æœè¿›è¡Œè§£ç ï¼Œè¿™åˆè¦æ±‚ä¸‹é‡‡æ ·ä¸èƒ½ä¸¢å¼ƒå¤ªå¤šä¿¡æ¯ï¼ŒåŒæ—¶è¿˜éœ€è¦å¼•å…¥ç¼–ç å™¨çš„ä¸­é—´ç»“æœæ¥æä¾›é¢å¤–çš„ä¿¡æ¯ã€‚ä¸ºæ­¤ä¾¿æœ‰äº†è·³è·ƒè¿æ¥ã€ç©ºæ´å·ç§¯ç­‰æ ¸å¿ƒæ“ä½œã€‚</p>
<p>è™½ç„¶éƒ½æ˜¯æŸç§æ„ä¹‰ä¸Šçš„â€œç”Ÿæˆæ¨¡å‹â€ï¼Œè¿™ä¸€éƒ¨åˆ†çš„æ¨¡å‹å°±æ²¡æœ‰ VAE ç­‰æ¨¡å‹é‚£æ ·å¼ºçš„æ•°å­¦ï¼Œè€Œæ˜¯åé‡äºå·¥ç¨‹å®ç°ã€‚</p>
<p>æœ¬æ–‡å¯¹è¯­ä¹‰åˆ†å‰²ä¸»è¦ä»‹ç» FCNã€U-Net ç­‰ã€‚</p>
<h3 id="fcn">FCN<a class="headerlink" href="#fcn" title="Permanent link">Â¶</a></h3>
<h4 id="_3">æ¶æ„<a class="headerlink" href="#_3" title="Permanent link">Â¶</a></h4>
<p>ï¼ˆå…¶å®æˆ‘æœ¬æ¥æƒ³ç›´æ¥ä¸Š U-Net çš„ï¼Œå› ä¸ºæˆ‘ä¸€å¼€å§‹è¯» FCN æ–‡ç« çš„æ—¶å€™å°±å¯¹è¿™ä¸ªæ¶æ„æœ‰ä¸¤ä¸ªç–‘ç‚¹ï¼Œç»“æœå‘ç° U-Net éƒ½èƒ½è§£å†³â€¦â€¦ï¼‰</p>
<p>æœ¬æ–‡ä¸»è¦å¤ç°çš„æ˜¯ FCN-8sã€‚å®ƒçš„å‰åŠæˆªç¼–ç å™¨éƒ¨åˆ†æ˜¯ VGG-16ï¼Œäºæ˜¯æˆ‘ä»¬åˆå¯ä»¥å¿«ä¹åœ°ä½¿ç”¨ ImageNet é¢„è®­ç»ƒæƒé‡äº†ã€‚å…ˆå›é¡¾ä¸€ä¸‹ VGG-16 çš„ç»“æ„ï¼š</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef result fill:#45475a,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4;
    classDef conv fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;

    %% Input Layer
    subgraph Input["Input"]
        A[("3 @ 224Ã—224")]
    end
    class Input input;

    %% Initial Convolution
    subgraph InitConv["Convolution Block 1"]
        B["Conv2d &lt;br&gt; 3x64 x 3Ã—3"] 
        C["Conv2d &lt;br&gt; 64x64 x 3Ã—3"] 
        D["Maxpool 1&lt;br&gt;stride = 2"]
    end
    A --&gt; B
    B --&gt; C --&gt; D
    class InitConv conv;

    %% Layer 1 (2Ã— BasicBlock without downsample)
    subgraph Layer1["Convolution Block 2"]
        F["Conv2d &lt;br&gt; 64x128 x 3Ã—3"] 
        GG["Conv2d &lt;br&gt; 128x128 x 3Ã—3"] 
        G["Maxpool 2&lt;br&gt;stride = 2"]
    end
    D --&gt; |64 @ 112Ã—112| F
    F --&gt; GG --&gt; G
    class Layer1 conv;

    %% Layer 2 (2Ã— BasicBlock with downsample in first block)
    subgraph Layer2["Convolution Block 3"]
        H["Conv2d &lt;br&gt; 128x256 x 3Ã—3"]
        I["Conv2d &lt;br&gt; 256x256 x 3Ã—3"]
        J["Maxpool 3&lt;br&gt;stride = 2"]
    end
    G --&gt; |128 @ 56Ã—56| H
    H --&gt; I --&gt; J
    class Layer2 conv;

    %% Layer 3 (2Ã— BasicBlock with downsample in first block)
    subgraph Layer3["Convolution Block 4"]
        K["Conv2d &lt;br&gt; 256x512 x 3Ã—3"]
        L["Conv2d &lt;br&gt; 512x512 x 3Ã—3"]
        M["Maxpool 4&lt;br&gt;stride = 2"]
    end
    J --&gt; |256 @ 28Ã—28| K
    K --&gt; L --&gt; M
    class Layer3 conv;

    %% Layer 4 (2Ã— BasicBlock with downsample in first block)
    subgraph Layer4["Convolution Block 5"]
        N["Conv2d &lt;br&gt; 512x512 x 3Ã—3"]
        O["Conv2d &lt;br&gt; 512x512 x 3Ã—3"]
        P["Maxpool 5&lt;br&gt;stride = 2"]
    end
    M --&gt; |512 @ 14Ã—14| N
    N --&gt; O --&gt; P
    class Layer4 conv;

    %% Global Pooling and FC
    subgraph PoolFC["GAP &amp; Classfiaction"]
        Q["Flatten &lt;br&gt; or GAP"]
        S["Linear Layers"]
    end
    P --&gt; |512 @ 7x7| Q --&gt; S
    class PoolFC box;

    %% Output Layer
    subgraph Output["output"]
        T[("1000")]
    end
    S --&gt; T
    class Output output;

    %% Styling
    style A stroke-dasharray: 5 5
    style T stroke:#a6e3a1,stroke-width:3px</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬å–åˆ° <code>Maxpool 5</code> ä¹‹å‰çš„åœ°æ–¹å°±å¤Ÿäº†ï¼Œè¿™æ · VGG-16 çš„è¾“å‡ºå°±æ˜¯ä¸€å¼  <code>512@7x7</code> çš„ä½åˆ†è¾¨ç‡ç‰¹å¾å›¾ã€‚ç„¶å FCN åœ¨è¿™é‡Œå°±å‡ºç°äº†å‡ ä¸ªå˜ä½“ï¼ˆæˆ–è€…è¯´ä¸€ä¸ªæ¼”è¿›çš„è¿‡ç¨‹ï¼‰ï¼š</p>
<p>é¦–å…ˆè€ƒè™‘æŠŠè¿™ä¸ªç‰¹å¾å›¾ç›´æ¥ä¸Šé‡‡æ ·åˆ° 224x224ï¼Œæˆ‘ä»¬è‚¯å®šä¸èƒ½ç›´æ¥ç”¨ä»€ä¹ˆçº¿æ€§æ’å€¼ã€ç«‹æ–¹æ’å€¼ã€Lanczos æ’å€¼ç­‰ç®—æ³•ï¼Œå› ä¸ºå®ƒåªæ˜¯æ’å€¼è€Œä¸å¼•å…¥æ–°ä¿¡æ¯ã€‚è¿™å°±è¦ç¥­å‡ºæˆ‘ä»¬åœ¨ DC-GAN ä»¥åŠ SRCNN ç­‰ç”Ÿæˆå¼æ¨¡å‹é‡Œé¢è§åˆ°çš„ <code>ConvTranspose2d</code> äº†ã€‚ä¹‹å‰åœ¨åˆ†ç±»æ¨¡å‹ä¸‹é¢æ²¡æœ‰ç»†è®²ï¼Œè¿™é‡Œç®€è¦ä»‹ç»ä¸€ä¸‹ï¼š<code>ConvTranspose2d</code> çš„åŸç†æ˜¯åœ¨åŸæœ‰åƒç´ çš„å››å‘¨å‡åŒ€æ’ 0 å¾—åˆ°å’Œç›®æ ‡å¤§å°ä¸€è‡´çš„å¤§å›¾ï¼Œç„¶åå†åœ¨è¿™ä¸ªå¤§å›¾ä¸Šé¢åšæ­£å¸¸å·ç§¯ã€‚</p>
<p>äºæ˜¯æˆ‘ä»¬é€šè¿‡æ­¥é•¿ä¸º 32 çš„è½¬ç½®å·ç§¯ä¸€æ¬¡æ€§å°† <code>512@7x7</code> çš„ç‰¹å¾å›¾ä¸Šé‡‡æ ·åˆ° <code>n@224x224</code>ï¼Œå¾—åˆ°æˆ‘ä»¬çš„ç›®æ ‡å›¾åƒã€‚è¿™ä¾¿æ˜¯ FCN-32sã€‚è¿™é‡Œçš„ 32 å°±æ˜¯è½¬ç½®å·ç§¯çš„æ­¥é•¿ï¼Œs å°±æ˜¯ stride çš„æ„æ€ã€‚</p>
<p>å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ª <code>512@7x7</code> çš„ç‰¹å¾å›¾å‰©ä¸‹çš„ä¿¡æ¯ç›¸æ¯”äºåŸå›¾å·²ç»å¾ˆå°‘äº†ï¼Œè€Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è¦å®ç°<strong>åƒç´ çº§</strong>çš„åˆ†å‰²ï¼Œä¸ºæ­¤ï¼ŒFCN æå‡ºäº†è·³è·ƒè¿æ¥çš„æ¦‚å¿µï¼šæ—¢ç„¶ç¼–ç å™¨åƒä¸€ä¸ªâ€œæ¼æ–—â€ä¸€æ ·å»å‹æ¦¨ç‰¹å¾ï¼Œé‚£ä¹ˆæˆ‘å–å‹æ¦¨ä¹‹å‰å…·æœ‰æ›´ä¸°å¯Œä¿¡æ¯çš„ç‰¹å¾å›¾ï¼Œå’Œæˆ‘åé¢è½¬ç½®å·ç§¯ä¸Šé‡‡æ ·å¾—åˆ°çš„ç‰¹å¾å›¾ä¸€èåˆï¼Œä¸å°±è¡Œäº†å˜›ã€‚è¿™ä¾¿æ˜¯ FCN æå‡ºçš„è·³è·ƒè¿æ¥æ€æƒ³ã€‚ï¼ˆå…¶å®å’Œ ResNet çš„æ®‹å·®è¿æ¥æœ‰ç‚¹åƒï¼‰</p>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±ä¸ä¸€æ¬¡æ€§æš´åŠ›æ¢å¤ï¼Œè€Œæ˜¯å…ˆåˆ©ç”¨æ­¥é•¿ä¸º 2 çš„è½¬ç½®å·ç§¯å°† <code>512@7x7</code> çš„ç‰¹å¾å›¾ä¸Šé‡‡æ ·åˆ° <code>n@14x14</code>ï¼Œå…¶ä¸­ n æ˜¯ç±»åˆ«æ•°ï¼Œä¹Ÿå°±æ˜¯å’Œ <code>Maxpool 4</code> çš„è¾“å‡ºå°ºå¯¸ä¸€è‡´ã€‚è¿™æ ·ï¼Œå‰ä¸€ä¸ªé˜¶æ®µçš„ä¿¡æ¯ç»è¿‡ä¸€ä¸ª 1x1 å·ç§¯åˆå¹¶é€šé“ä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥èåˆäº†ã€‚è€Œè¿™å¼•å‘äº†æˆ‘å¯¹äº FCN æ¶æ„çš„ç¬¬ä¸€ä¸ªç–‘ç‚¹â€”â€”FCN çš„è®ºæ–‡è¯´æ˜¯å°†ä¸¤ä¸ªç‰¹å¾å›¾<strong>ç›¸åŠ </strong>ã€‚ä½†æ˜¯æˆ‘è®¤ä¸ºåœ¨é€šé“ç»´ç›´æ¥<strong>æ‹¼æ¥</strong>ï¼Œå¯èƒ½æ•ˆæœæ›´å¥½ï¼Œå› ä¸ºå¯¹äºç‰¹å¾å›¾ç›¸åŠ ä¹‹åè¿›è¡Œçš„å·ç§¯æ“ä½œ C1 è€Œè¨€ï¼Œæˆ‘ä»¬æ€»èƒ½è®¾è®¡ä¸€ä¸ªå·ç§¯æ ¸ä½¿å¾—æ‹¼æ¥ç‰¹å¾å›¾å†è¿›è¡Œå·ç§¯æ“ä½œ C2 çš„è¾“å‡ºå’Œç›¸åŠ åè¿›è¡Œ C1 çš„è¾“å‡ºå®Œå…¨ä¸€æ ·ï¼Œè¿™æ„å‘³ç€æ‹¼æ¥å†å·ç§¯ä½œä¸ºä¸€ä¸ªå¼ é‡åˆ°å¼ é‡çš„æ˜ å°„é›†åˆï¼Œå…¶â€œç»´åº¦â€æ˜¯å¤§äºç›¸åŠ å†å·ç§¯çš„ï¼Œå› è€Œæœ‰èƒ½åŠ›æ‰¿è½½æ›´å¤šçš„ç‰¹å¾ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬å…ˆæŒ‰ç…§åŸè®ºæ–‡æ¥ï¼Œè¿›è¡Œç›¸åŠ æ“ä½œï¼Œå¾—åˆ° <code>n@14x14</code> çš„ç‰¹å¾å›¾ã€‚æœ€åï¼Œæˆ‘ä»¬å®æ–½ä¸€æ¬¡æ­¥é•¿ä¸º 16 çš„è½¬ç½®å·ç§¯ï¼Œä¸Šé‡‡æ ·åˆ° <code>n@224x224</code>ï¼Œç”±äºè¿™ä¸€æ­¥æ­¥é•¿ä¸º 16ï¼Œæ‰€ä»¥å« FCN-16sã€‚</p>
<p>è¿™æ ·ï¼ŒFCN-8s çš„æ„æ€å°±å¾ˆç®€å•äº†ã€‚æˆ‘ä»¬å¯¹ <code>n@14x14</code> çš„ç‰¹å¾å›¾è¿›è¡Œä¸€æ¬¡æ­¥é•¿ä¸º 2 çš„è½¬ç½®å·ç§¯ï¼Œå†åŒ <code>Maxpool 3</code> çš„è¾“å‡ºç‰¹å¾å›¾ç›¸åŠ å¾—åˆ° <code>n@28x28</code> çš„ç‰¹å¾å›¾ï¼Œå†å®æ–½ä¸€æ¬¡æ­¥é•¿ä¸º 8 çš„è½¬ç½®å·ç§¯ï¼Œä¸Šé‡‡æ ·åˆ° <code>n@224x224</code> å³å¯ã€‚</p>
<p>FCN çš„è®ºæ–‡åªåšåˆ° 8sï¼Œä¸ºä»€ä¹ˆä¸æ¥ç€å¾€åé¢åšå‘¢ï¼Ÿè¿™å°±æ˜¯æˆ‘çš„ç¬¬äºŒä¸ªç–‘ç‚¹ã€‚å¦‚æœé€å±‚åº”ç”¨è·³è·ƒè¿æ¥ï¼Œä¹Ÿå°±æ˜¯ <code>n@28x28</code> åˆ° <code>n@56x56</code> åˆ° <code>n@112x112</code> å†åˆ° <code>n@224x224</code>ï¼Œæ¯ä¸€æ­¥éƒ½ä»¥<strong>æ‹¼æ¥</strong>çš„æ–¹å¼å®ç°è·³è·ƒè¿æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å‡ ä¹å°±å‘æ˜äº† U-Netã€‚</p>
<p>ä¸‹é¢æ˜¯ FCN-8s çš„æ¶æ„ï¼š</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef result fill:#45475a,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4;
    classDef conv fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;
    classDef skip fill:#313244,stroke:#cba6f7,stroke-width:2px,color:#cdd6f4;
    classDef upsample fill:#313244,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;

    %% Input Layer
    subgraph Input["Input"]
        A[("3 @ 224Ã—224")]
    end
    class Input input;

    %% VGG-16 Backbone (until pool5)
    subgraph Backbone["VGG-16 Backbone"]
        %% Block 1
        subgraph Block1["Block 1"]
            B["Conv 3x64&lt;br&gt;3Ã—3"]
            C["Conv 64x64&lt;br&gt;3Ã—3"]
            D["MaxPool&lt;br&gt;2Ã—2 stride=2"]
        end

        %% Block 2
        subgraph Block2["Block 2"]
            E["Conv 64x128&lt;br&gt;3Ã—3"]
            F["Conv 128x128&lt;br&gt;3Ã—3"]
            G["MaxPool&lt;br&gt;2Ã—2 stride=2"]
        end

        %% Block 3
        subgraph Block3["Block 3"]
            H["Conv 128x256&lt;br&gt;3Ã—3"]
            I["Conv 256x256&lt;br&gt;3Ã—3"]
            J["Conv 256x256&lt;br&gt;3Ã—3"]
            K["MaxPool&lt;br&gt;2Ã—2 stride=2&lt;br&gt;(pool3)"]
        end

        %% Block 4
        subgraph Block4["Block 4"]
            L["Conv 256x512&lt;br&gt;3Ã—3"]
            M["Conv 512x512&lt;br&gt;3Ã—3"]
            N["Conv 512x512&lt;br&gt;3Ã—3"]
            O["MaxPool&lt;br&gt;2Ã—2 stride=2&lt;br&gt;(pool4)"]
        end

        %% Block 5
        subgraph Block5["Block 5"]
            P["Conv 512x512&lt;br&gt;3Ã—3"]
            Q["Conv 512x512&lt;br&gt;3Ã—3"]
            R["Conv 512x512&lt;br&gt;3Ã—3"]
            S["MaxPool&lt;br&gt;2Ã—2 stride=2&lt;br&gt;(pool5)"]
        end
    end

    A --&gt; B
    B --&gt; C --&gt; D
    D --&gt; E
    E --&gt; F --&gt; G
    G --&gt; H
    H --&gt; I --&gt; J --&gt; K
    K --&gt; L
    L --&gt; M --&gt; N --&gt; O
    O --&gt; P
    P --&gt; Q --&gt; R --&gt; S

    class Backbone conv;
    class Block1,Block2,Block3,Block4,Block5 box;

    %% FCN-8s Specific Layers
    subgraph FCN["FCN-8s Head"]
        %% 1x1 Convs to reduce channels to num_classes
        T["1Ã—1 Conv&lt;br&gt;512â†’n"]
        U["1Ã—1 Conv&lt;br&gt;512â†’n"]
        V["1Ã—1 Conv&lt;br&gt;256â†’n"]

        %% 2x Upsampling
        W["2x Upsample&lt;br&gt;transposed conv"]
        X["2x Upsample&lt;br&gt;transposed conv"]

        %% Skip connections and addition
        Y["Add&lt;br&gt;pool4 + 2x(pool5)"]
        Z["Add&lt;br&gt;pool3 + 2x(combined)"]

        %% Final 8x Upsampling
        AA["8x Upsample&lt;br&gt;transposed conv"]
    end

    S --&gt; T
    O --&gt; U
    K --&gt; V
    T --&gt; W
    W --&gt; Y
    U --&gt; Y
    Y --&gt; X
    X --&gt; Z
    V --&gt; Z
    Z --&gt; AA

    class FCN skip;
    class T,U,V conv;
    class W,X,AA upsample;
    class Y,Z result;

    %% Output Layer
    subgraph Output["Output"]
        AB[("n @ 224Ã—224&lt;br&gt;(Segmentation Mask)")]
    end
    AA --&gt; AB
    class Output output;

    %% Styling
    style A stroke-dasharray: 5 5
    style AB stroke:#a6e3a1,stroke-width:3px

    %% Skip connection annotations
    linkStyle 15 stroke:#cba6f7,stroke-width:2px,stroke-dasharray: 5 5;
    linkStyle 16 stroke:#cba6f7,stroke-width:2px,stroke-dasharray: 5 5;</code></pre>
<h4 id="_4">æŒ‡æ ‡<a class="headerlink" href="#_4" title="Permanent link">Â¶</a></h4>
<p>å…ˆå‰çš„å›¾åƒåˆ†ç±»ä»»åŠ¡é‡Œé¢ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šæ²¡æœ‰å»è¡¡é‡é™¤äº†å‡†ç¡®ç‡å’ŒæŸå¤±ä¹‹å¤–çš„å…¶ä»–æŒ‡æ ‡ï¼Œä½†æ˜¯è¯­ä¹‰åˆ†å‰²å’Œç›®æ ‡æ£€æµ‹è¿™ä¸€å—ï¼Œæˆ‘ä»¬å°±ä¸ä»…è¦å…³æ³¨ç±»åˆ«å¯¹ä¸å¯¹ï¼Œæ›´è¦å…³æ³¨åˆ†å‰²/æ£€æµ‹æ˜¯å¦åˆ°ä½ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹æ¦‚ç‡è®ºè¯¾ç¨‹ä¸­çš„å‚æ•°æ¨æ–­ï¼Œé‡Œé¢æåˆ°ä¸¤ç§é”™è¯¯ï¼š<strong>æ‹’çœŸ</strong>å’Œ<strong>å–ä¼ª</strong>ï¼ˆæˆ–è€…å«å‡é˜³å‡é˜´æˆ–è€…ç¬¬ä¸€ç±»é”™è¯¯ç¬¬äºŒç±»é”™è¯¯ä»€ä¹ˆçš„ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸¤ç§é”™è¯¯çš„é¢‘æ•°å’Œä¸¤ç§æ­£ç¡®çš„é¢‘æ•°æ”¾åˆ°ä¸€èµ·ï¼Œå°±å¾—åˆ°äº†<strong>æ··æ·†çŸ©é˜µ</strong>ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;">é¢„æµ‹ä¸ºçœŸ</th>
<th style="text-align: center;">é¢„æµ‹ä¸ºå‡</th>
<th style="text-align: center;">æ€»å’Œ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">å®é™…ä¸ºçœŸ</td>
<td style="text-align: center;">çœŸé˜³æ€§ TP</td>
<td style="text-align: center;">å‡é˜´æ€§ FN</td>
<td style="text-align: center;">çœŸæ ·æœ¬æ•° T</td>
</tr>
<tr>
<td style="text-align: center;">å®é™…ä¸ºå‡</td>
<td style="text-align: center;">å‡é˜³æ€§ FP</td>
<td style="text-align: center;">çœŸé˜´æ€§ TN</td>
<td style="text-align: center;">å‡æ ·æœ¬æ•° F</td>
</tr>
<tr>
<td style="text-align: center;">æ€»å’Œ</td>
<td style="text-align: center;">é˜³æ€§æ•° P</td>
<td style="text-align: center;">é˜´æ€§æ•° N</td>
<td style="text-align: center;">æ€»æ•° S</td>
</tr>
</tbody>
</table>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»¥æ­¤æ¥è¯„ä¼°æ¨¡å‹æ€§èƒ½äº†ï¼š</p>
<div class="arithmatex">\[
\begin{align*}
    \mathrm{Acc.}&amp;=\frac{\mathrm{TP}+\mathrm{TN}}{\mathrm{S}}\\
    \mathrm{Prec.}&amp;=\frac{\mathrm{TP}}{\mathrm{P}}=1-\frac{\mathrm{FP}}{\mathrm{P}}\\
    \mathrm{Recall}&amp;=\frac{\mathrm{TP}}{\mathrm{TP}+\mathrm{FN}}
\end{align*}
\]</div>
<p>ç¬¬ä¸€ä¸ªæ˜¯<strong>å‡†ç¡®ç‡</strong>å³é¢„æµ‹æ­£ç¡®å æ€»æ•°çš„æ¯”ä¾‹ã€‚ç¬¬äºŒä¸ªæ˜¯<strong>ç²¾å‡†ç‡</strong>ï¼Œè¶Šé«˜è¯´æ˜å‡é˜´æ€§/å‡é˜³æ€§çš„å æ¯”è¶Šä½ã€‚æœ€åä¸€ä¸ªæ˜¯<strong>å¬å›ç‡</strong>ï¼Œå¯ä»¥ç†è§£æˆåœ¨é¢„æµ‹æ­£ç¡®çš„æƒ…å†µä¸‹ï¼Œæ¨¡å‹æœ‰å¤šå¤§æ„æ„¿ç»™å‡ºé˜´æ€§/é˜³æ€§ç»“æœã€‚åœ¨è¯­ä¹‰åˆ†å‰²çš„è¯­å¢ƒä¸‹ï¼Œæˆ‘ä»¬åœ¨å•å¼ å›¾ç‰‡çš„åƒç´ æ„ä¹‰ä¸Šè®¡ç®—è¿™äº›æŒ‡æ ‡ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥å¾—åˆ°åƒç´ å‡†ç¡®ç‡ PAã€‚</p>
<p><img alt="alt text" src="../image-26.png"/></p>
<p>å¦‚å›¾ï¼Œå‡è®¾é»‘åœˆæ˜¯ ground truth è€Œç™½åœˆæ˜¯ predictionï¼Œé‚£ä¹ˆä»¥ä¸Šä¸‰ä¸ªç‡å°±èƒ½å¯è§†åŒ–äº†ã€‚</p>
<p>å¦‚æœåšçš„æ˜¯åƒ Pascal VOC è¿™æ ·çš„å¤šç±»åˆ«è¯­ä¹‰åˆ†å‰²ï¼Œæˆ‘ä»¬ç»™æ¯ä¸ªç±»åˆ«éƒ½è®¡ç®— PAï¼Œç„¶åæ±‚å¹³å‡ï¼Œå°±å¾—åˆ°ä¸€ä¸ªæ€»çš„è®¡ç®—å‡†ç¡®ç‡çš„æŒ‡æ ‡ï¼šå¹³å‡ç±»åˆ«åƒç´ å‡†ç¡®ç‡ mPAã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å…¶å®å¸Œæœ›ç™½åœˆå’Œé»‘åœˆå°½å¯èƒ½é‡åˆï¼Œå…¶å®å°±æ˜¯<strong>ç›¸äº¤å¾—æ›´å¤šï¼Œä¸å±äºç›¸äº¤çš„éƒ¨åˆ†æ›´å°‘</strong>ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ªæŒ‡æ ‡æ¥è¡¡é‡ï¼šäº¤å¹¶æ¯” IoUï¼Œä¹Ÿå°±æ˜¯ II åŒºåŸŸçš„é¢ç§¯é™¤ä»¥ Iã€II å’Œ III åŒºåŸŸçš„é¢ç§¯ä¹‹å’Œã€‚</p>
<div class="arithmatex">\[
\mathrm{IoU}=\dfrac{\mathrm{TP}}{\mathrm{T}+\mathrm{P}-\mathrm{TP}}
\]</div>
<p>åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—ç±»åˆ«å¹³å‡äº¤å¹¶æ¯” mIoUã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å°±å®ç°äº†åŸºäºæ··æ·†çŸ©é˜µè®¡ç®— PA å’Œ mIoUã€‚</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="n">pixel_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># å¯¹è§’çº¿å…ƒç´ éƒ½æ˜¯é¢„æµ‹æ­£ç¡®çš„</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="c1"># å¿½ç•¥NaNå€¼ï¼ˆä¾‹å¦‚æŸä¸ªç±»åˆ«åœ¨éªŒè¯é›†ä¸­ä»æœªå‡ºç°è¿‡ï¼‰</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="n">miou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="k">return</span> <span class="n">pixel_accuracy</span><span class="p">,</span> <span class="n">miou</span>
</code></pre></div></td></tr></table></div>
<p>FCN çš„æŸå¤±å‡½æ•°å½“ç®€å•ï¼šå…¶å®æˆ‘ä»¬ç­‰äºæ˜¯<strong>å¯¹ä¸€ä¸ªå’ŒåŸå›¾å°ºå¯¸ä¸€è‡´çš„åƒç´ é˜µåˆ—åšç‹¬ç«‹çš„åˆ†ç±»</strong>ï¼Œé‚£ä¹ˆå’Œåˆ†ç±»ä»»åŠ¡ä¸€æ ·ï¼Œ<strong>ç›´æ¥æ²¿ç”¨äº¤å‰ç†µæŸå¤±å³å¯</strong>ï¼</p>
<h4 id="_5">å®ç°ç»†èŠ‚<a class="headerlink" href="#_5" title="Permanent link">Â¶</a></h4>
<p>è¿™é‡Œçš„ç»†èŠ‚ä¸»è¦æ˜¯æ¥è®² FCN-8s è¿™ä¸ªç±»çš„å…·ä½“å®ç°ã€‚</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span>
<span class="normal"><a href="#__codelineno-1-32">32</a></span>
<span class="normal"><a href="#__codelineno-1-33">33</a></span>
<span class="normal"><a href="#__codelineno-1-34">34</a></span>
<span class="normal"><a href="#__codelineno-1-35">35</a></span>
<span class="normal"><a href="#__codelineno-1-36">36</a></span>
<span class="normal"><a href="#__codelineno-1-37">37</a></span>
<span class="normal"><a href="#__codelineno-1-38">38</a></span>
<span class="normal"><a href="#__codelineno-1-39">39</a></span>
<span class="normal"><a href="#__codelineno-1-40">40</a></span>
<span class="normal"><a href="#__codelineno-1-41">41</a></span>
<span class="normal"><a href="#__codelineno-1-42">42</a></span>
<span class="normal"><a href="#__codelineno-1-43">43</a></span>
<span class="normal"><a href="#__codelineno-1-44">44</a></span>
<span class="normal"><a href="#__codelineno-1-45">45</a></span>
<span class="normal"><a href="#__codelineno-1-46">46</a></span>
<span class="normal"><a href="#__codelineno-1-47">47</a></span>
<span class="normal"><a href="#__codelineno-1-48">48</a></span>
<span class="normal"><a href="#__codelineno-1-49">49</a></span>
<span class="normal"><a href="#__codelineno-1-50">50</a></span>
<span class="normal"><a href="#__codelineno-1-51">51</a></span>
<span class="normal"><a href="#__codelineno-1-52">52</a></span>
<span class="normal"><a href="#__codelineno-1-53">53</a></span>
<span class="normal"><a href="#__codelineno-1-54">54</a></span>
<span class="normal"><a href="#__codelineno-1-55">55</a></span>
<span class="normal"><a href="#__codelineno-1-56">56</a></span>
<span class="normal"><a href="#__codelineno-1-57">57</a></span>
<span class="normal"><a href="#__codelineno-1-58">58</a></span>
<span class="normal"><a href="#__codelineno-1-59">59</a></span>
<span class="normal"><a href="#__codelineno-1-60">60</a></span>
<span class="normal"><a href="#__codelineno-1-61">61</a></span>
<span class="normal"><a href="#__codelineno-1-62">62</a></span>
<span class="normal"><a href="#__codelineno-1-63">63</a></span>
<span class="normal"><a href="#__codelineno-1-64">64</a></span>
<span class="normal"><a href="#__codelineno-1-65">65</a></span>
<span class="normal"><a href="#__codelineno-1-66">66</a></span>
<span class="normal"><a href="#__codelineno-1-67">67</a></span>
<span class="normal"><a href="#__codelineno-1-68">68</a></span>
<span class="normal"><a href="#__codelineno-1-69">69</a></span>
<span class="normal"><a href="#__codelineno-1-70">70</a></span>
<span class="normal"><a href="#__codelineno-1-71">71</a></span>
<span class="normal"><a href="#__codelineno-1-72">72</a></span>
<span class="normal"><a href="#__codelineno-1-73">73</a></span>
<span class="normal"><a href="#__codelineno-1-74">74</a></span>
<span class="normal"><a href="#__codelineno-1-75">75</a></span>
<span class="normal"><a href="#__codelineno-1-76">76</a></span>
<span class="normal"><a href="#__codelineno-1-77">77</a></span>
<span class="normal"><a href="#__codelineno-1-78">78</a></span>
<span class="normal"><a href="#__codelineno-1-79">79</a></span>
<span class="normal"><a href="#__codelineno-1-80">80</a></span>
<span class="normal"><a href="#__codelineno-1-81">81</a></span>
<span class="normal"><a href="#__codelineno-1-82">82</a></span>
<span class="normal"><a href="#__codelineno-1-83">83</a></span>
<span class="normal"><a href="#__codelineno-1-84">84</a></span>
<span class="normal"><a href="#__codelineno-1-85">85</a></span>
<span class="normal"><a href="#__codelineno-1-86">86</a></span>
<span class="normal"><a href="#__codelineno-1-87">87</a></span>
<span class="normal"><a href="#__codelineno-1-88">88</a></span>
<span class="normal"><a href="#__codelineno-1-89">89</a></span>
<span class="normal"><a href="#__codelineno-1-90">90</a></span>
<span class="normal"><a href="#__codelineno-1-91">91</a></span>
<span class="normal"><a href="#__codelineno-1-92">92</a></span>
<span class="normal"><a href="#__codelineno-1-93">93</a></span>
<span class="normal"><a href="#__codelineno-1-94">94</a></span>
<span class="normal"><a href="#__codelineno-1-95">95</a></span>
<span class="normal"><a href="#__codelineno-1-96">96</a></span>
<span class="normal"><a href="#__codelineno-1-97">97</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">FCN8s</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">FCN8s</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>        <span class="c1"># é¢„è®­ç»ƒ VGG16</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>        <span class="n">vgg</span> <span class="o">=</span> <span class="n">vgg16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">VGG16_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">features</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>        <span class="c1"># æå–ä¸åŒé˜¶æ®µçš„ç‰¹å¾å›¾</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="c1"># åœ¨ PyTorch çš„å®ç°ä¸­ï¼ŒVGG çš„è¿ç»­å·ç§¯-æ± åŒ–æ“ä½œæ˜¯ä¿å­˜åœ¨ vgg.features è¿™ä¸ª list é‡Œé¢</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>        <span class="c1"># [64, 64, 'M', 128, 128, 'M', 256, 256, 256, 'M', 512, 512, 512, 'M', 512, 512, 512, 'M'] å…¶ä¸­ M å°±æ˜¯ Maxpool</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="c1"># ç”±äºè¿™ä¸ª list è¢«å°å°è¿› nn.Sequnential é‡Œé¢ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œè¾“å‡ºå°±æ˜¯ç‰¹å¾å›¾</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool3_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span>   <span class="c1"># åˆ° pool3</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool4_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span> <span class="c1"># åˆ° pool4</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool5_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">24</span><span class="p">:]</span>   <span class="c1"># åˆ° pool5</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>        <span class="c1"># å…¨è¿æ¥å±‚æ”¹ä¸ºå·ç§¯å±‚ï¼ˆFCNï¼‰</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>        <span class="c1"># VGG çš„ç¬¬ä¸€ä¸ª Linear: 512@7x7 -&gt; 4096@7x7</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>        <span class="c1"># å½“ç„¶è¿™é‡Œä¸ºäº†é€‚åº”ä»»æ„å®½åº¦çš„è¾“å‡ºï¼Œå¯ä»¥ä½¿ç”¨ GAP</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a>        <span class="c1"># ä¸è¿‡æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸Š VGG çš„é¢„è®­ç»ƒæƒé‡ï¼Œæ¯”èµ·é‡æ–°è®­æ•ˆæœè‚¯å®šæ›´å¥½</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drop6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">()</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>        <span class="c1"># VGG çš„ç¬¬äºŒä¸ª Linear: 4096@7x7 -&gt; 4096@7x7</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a>        <span class="c1"># ä»ç„¶æ˜¯æ‹·è´æƒé‡ç„¶å reshape åˆ°å·ç§¯æ ¸</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drop7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">()</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a>        <span class="c1"># ä»ç„¶æ˜¯é  1x1 å·ç§¯è´Ÿè´£å¾—åˆ°ä¸€ä¸ª num_classes@7x7 çš„åˆ†ç±»å¾—åˆ†</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_fr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a>        <span class="c1"># é€šè¿‡ 1x1 å·ç§¯å¾—åˆ° num_classes@HxW çš„ç‰¹å¾å›¾ç”¨äºè·³è·ƒè¿æ¥</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_pool3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_pool4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a>        <span class="c1"># ä¸Šé‡‡æ ·å±‚</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a>        <span class="c1"># å°† VGG classifier çš„ fc6/fc7 é¢„è®­ç»ƒæƒé‡æ‹·è´åˆ°å·ç§¯å±‚</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a>            <span class="c1"># vgg.classifier: [Linear(25088,4096), ReLU, Dropout, Linear(4096,4096), ReLU, Dropout, Linear(4096,1000)]</span>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a>            <span class="c1"># view(4096, 512, 7, 7) æ“ä½œå°±æ˜¯æŠŠ 25088x4096 çš„çº¿æ€§å±‚ reshape åˆ°è¿™ä¸ªå½¢çŠ¶çš„å¼ é‡</span>
<a id="__codelineno-1-45" name="__codelineno-1-45"></a>            <span class="n">fc6_w</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a id="__codelineno-1-46" name="__codelineno-1-46"></a>            <span class="n">fc6_b</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span>
<a id="__codelineno-1-47" name="__codelineno-1-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc6_w</span><span class="p">)</span>
<a id="__codelineno-1-48" name="__codelineno-1-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc6_b</span><span class="p">)</span>
<a id="__codelineno-1-49" name="__codelineno-1-49"></a>
<a id="__codelineno-1-50" name="__codelineno-1-50"></a>            <span class="c1"># è¿™é‡Œä¹Ÿæ˜¯åŒæ ·çš„æ“ä½œè½¬æ¢æˆå¼ é‡</span>
<a id="__codelineno-1-51" name="__codelineno-1-51"></a>            <span class="n">fc7_w</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-52" name="__codelineno-1-52"></a>            <span class="n">fc7_b</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span>
<a id="__codelineno-1-53" name="__codelineno-1-53"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc7_w</span><span class="p">)</span>
<a id="__codelineno-1-54" name="__codelineno-1-54"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc7_b</span><span class="p">)</span>
<a id="__codelineno-1-55" name="__codelineno-1-55"></a>
<a id="__codelineno-1-56" name="__codelineno-1-56"></a>        <span class="c1"># åå·ç§¯å±‚ç”¨åŒçº¿æ€§æ’å€¼è¿›è¡Œåˆå§‹åŒ–</span>
<a id="__codelineno-1-57" name="__codelineno-1-57"></a>        <span class="c1"># åå·ç§¯çš„åˆå§‹åŒ–çš„ç»†èŠ‚åœ¨åé¢è¯´æ˜</span>
<a id="__codelineno-1-58" name="__codelineno-1-58"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-1-59" name="__codelineno-1-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">bilinear_kernel</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-1-60" name="__codelineno-1-60"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">bilinear_kernel</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-1-61" name="__codelineno-1-61"></a>
<a id="__codelineno-1-62" name="__codelineno-1-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-1-63" name="__codelineno-1-63"></a>        <span class="n">input_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="c1"># (B, C, H, W) -&gt; (H, W)</span>
<a id="__codelineno-1-64" name="__codelineno-1-64"></a>
<a id="__codelineno-1-65" name="__codelineno-1-65"></a>        <span class="c1"># ç›´æ¥å¾—åˆ° pool3, pool4, pool5 åçš„ç‰¹å¾å›¾</span>
<a id="__codelineno-1-66" name="__codelineno-1-66"></a>        <span class="n">pool3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool3_features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-1-67" name="__codelineno-1-67"></a>        <span class="n">pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool4_features</span><span class="p">(</span><span class="n">pool3</span><span class="p">)</span>
<a id="__codelineno-1-68" name="__codelineno-1-68"></a>        <span class="n">pool5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool5_features</span><span class="p">(</span><span class="n">pool4</span><span class="p">)</span>
<a id="__codelineno-1-69" name="__codelineno-1-69"></a>
<a id="__codelineno-1-70" name="__codelineno-1-70"></a>        <span class="c1"># 1x1 å·ç§¯å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„ num_classes@7x7 çš„ç‰¹å¾å›¾</span>
<a id="__codelineno-1-71" name="__codelineno-1-71"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu6</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="p">(</span><span class="n">pool5</span><span class="p">))</span>
<a id="__codelineno-1-72" name="__codelineno-1-72"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop6</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-73" name="__codelineno-1-73"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu7</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
<a id="__codelineno-1-74" name="__codelineno-1-74"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop7</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-75" name="__codelineno-1-75"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_fr</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-76" name="__codelineno-1-76"></a>
<a id="__codelineno-1-77" name="__codelineno-1-77"></a>        <span class="c1"># ç¬¬ä¸€æ¬¡ä¸Šé‡‡æ ·é€šè¿‡è½¬ç½®å·ç§¯è¾“å‡ºå®½é«˜æ‰©å¼ ä¸€å€çš„ç‰¹å¾å›¾</span>
<a id="__codelineno-1-78" name="__codelineno-1-78"></a>        <span class="n">upscore2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-79" name="__codelineno-1-79"></a>
<a id="__codelineno-1-80" name="__codelineno-1-80"></a>        <span class="c1"># è·³è¿ pool4</span>
<a id="__codelineno-1-81" name="__codelineno-1-81"></a>        <span class="n">score_pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_pool4</span><span class="p">(</span><span class="n">pool4</span><span class="p">)</span>
<a id="__codelineno-1-82" name="__codelineno-1-82"></a>        <span class="c1"># è¿™é‡Œç”¨åŒçº¿æ€§æ’å€¼é€‚åº”ç‰¹å¾å›¾å¤§å°</span>
<a id="__codelineno-1-83" name="__codelineno-1-83"></a>        <span class="n">upscore2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">upscore2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">score_pool4</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-84" name="__codelineno-1-84"></a>        <span class="n">fuse_pool4</span> <span class="o">=</span> <span class="n">upscore2</span> <span class="o">+</span> <span class="n">score_pool4</span>
<a id="__codelineno-1-85" name="__codelineno-1-85"></a>
<a id="__codelineno-1-86" name="__codelineno-1-86"></a>        <span class="c1"># ç¬¬äºŒæ¬¡ä¸Šé‡‡æ ·é€šè¿‡è½¬ç½®å·ç§¯è¾“å‡ºå®½é«˜æ‰©å¼ ä¸€å€çš„ç‰¹å¾å›¾</span>
<a id="__codelineno-1-87" name="__codelineno-1-87"></a>        <span class="n">upscore_pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span><span class="p">(</span><span class="n">fuse_pool4</span><span class="p">)</span>
<a id="__codelineno-1-88" name="__codelineno-1-88"></a>
<a id="__codelineno-1-89" name="__codelineno-1-89"></a>        <span class="c1"># è·³è¿ pool3</span>
<a id="__codelineno-1-90" name="__codelineno-1-90"></a>        <span class="n">score_pool3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_pool3</span><span class="p">(</span><span class="n">pool3</span><span class="p">)</span>
<a id="__codelineno-1-91" name="__codelineno-1-91"></a>        <span class="c1"># åŒæ ·ä½¿ç”¨åŒçº¿æ€§æ’å€¼é€‚åº”å¤§å°</span>
<a id="__codelineno-1-92" name="__codelineno-1-92"></a>        <span class="n">upscore_pool4</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">upscore_pool4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">score_pool3</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-93" name="__codelineno-1-93"></a>        <span class="n">fuse_pool3</span> <span class="o">=</span> <span class="n">upscore_pool4</span> <span class="o">+</span> <span class="n">score_pool3</span>
<a id="__codelineno-1-94" name="__codelineno-1-94"></a>
<a id="__codelineno-1-95" name="__codelineno-1-95"></a>        <span class="c1"># æœ€ç»ˆä¸Šé‡‡æ ·åˆ°è¾“å…¥å°ºå¯¸ï¼Œç›´æ¥æ’å€¼ï¼Œçœæ—¶é«˜æ•ˆ</span>
<a id="__codelineno-1-96" name="__codelineno-1-96"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">fuse_pool3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-97" name="__codelineno-1-97"></a>        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
<p>å¯ä»¥çœ‹åˆ°é™¤å¼€ä¹‹å‰æåˆ°çš„æ•´ä½“æ¶æ„ä»¥å¤–ï¼Œä»£ç è¿˜æœ‰ä¸€äº›å°ç»†èŠ‚ã€‚</p>
<p>é¦–å…ˆæ˜¯<strong>åå·ç§¯çš„åŒçº¿æ€§æ’å€¼åˆå§‹åŒ–</strong>ã€‚è¿™ä¸€éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">bilinear_kernel</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="sd">"""ç”ŸæˆåŒçº¿æ€§æ’å€¼çš„åå·ç§¯åˆå§‹åŒ–æƒé‡"""</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>    <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="k">if</span> <span class="n">kernel_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">-</span> <span class="mf">0.5</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>    <span class="n">og</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">kernel_size</span><span class="p">,</span> <span class="p">:</span><span class="n">kernel_size</span><span class="p">]</span> <span class="c1"># ç”Ÿæˆä¸¤ä¸ªäºŒç»´æ•°ç»„ï¼Œåˆ†åˆ«è¡¨ç¤ºè¡Œå’Œåˆ—çš„ç´¢å¼•ç½‘æ ¼ã€‚</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>    <span class="n">filt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)):</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>        <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">filt</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>è¿™é‡Œå…³é”®æ˜¯ <code>filt</code> çš„è®¡ç®—ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å·ç§¯æ ¸å†…éƒ¨è®¡ç®—å¯¹åº”çš„è¡Œåˆ°è¾¹ç•Œçš„å½’ä¸€åŒ–æ›¼å“ˆé¡¿è·ç¦»ä¹˜ä»¥å¯¹åº”çš„åˆ—åˆ°è¾¹ç•Œçš„å½’ä¸€åŒ–æ›¼å“ˆé¡¿è·ç¦»ã€‚å¯¹äºä»å°å›¾åˆ°å¤§å›¾çš„è½¬ç½®å·ç§¯è€Œè¨€ï¼Œå¤§å›¾é‡Œé¢ä¸¤ä¸ªæºäºå°å›¾çš„åƒç´ ä¹‹é—´çš„åƒç´ ï¼Œå°±å¯ä»¥æ ¹æ®åˆ°è¿™ä¸¤ä¸ªåƒç´ çš„æ›¼å“ˆé¡¿è·ç¦»ä½œä¸ºæ¯”ä¾‹æ¥æ··åˆå¾—åˆ°ã€‚ä¹Ÿå°±æ˜¯è¯´å³ä½¿æˆ‘ä»¬è¿˜æ²¡æœ‰ä»ç½‘ç»œé‡Œé¢å­¦åˆ°ä»»ä½•çŸ¥è¯†ï¼Œè¿™ä¸ªå·ç§¯æ ¸è‡³å°‘è¿˜å¯ä»¥ä¸ç ´ååŸæœ‰ä¿¡æ¯è€Œç›´æ¥æ’å€¼æ”¾å¤§ã€‚åŒæ—¶æœ¬æ¥ FCN çš„å·ç§¯æ ¸å°±éœ€è¦å¯¹ç‰¹å¾å›¾è¿›è¡Œæ”¾å¤§ï¼Œè¿™æ— ç–‘æ˜¯ç›¸æ¯”éšæœºåˆå§‹åŒ–æ›´é«˜æ•ˆçš„åˆå§‹åŒ–æ–¹æ³•ã€‚</p>
<p>ä¸‹é¢æ˜¯å®Œæ•´çš„è®­ç»ƒä»£ç ï¼Œå…³äºæ•°æ®åŠ è½½å’Œå¢å¼ºçš„å¤§é‡å·¥ç¨‹æ€§ä»£ç å°±ä¸ç»†è®²äº†ã€‚ä¸è¿‡ï¼Œä»£ç é‡Œçš„æ•°æ®å¢å¼ºè¿˜æ˜¯æ¯”è¾ƒæœ‰æ•ˆã€‚</p>
<details>
<summary> FCN-8s å®Œæ•´è®­ç»ƒä»£ç  </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">  1</a></span>
<span class="normal"><a href="#__codelineno-3-2">  2</a></span>
<span class="normal"><a href="#__codelineno-3-3">  3</a></span>
<span class="normal"><a href="#__codelineno-3-4">  4</a></span>
<span class="normal"><a href="#__codelineno-3-5">  5</a></span>
<span class="normal"><a href="#__codelineno-3-6">  6</a></span>
<span class="normal"><a href="#__codelineno-3-7">  7</a></span>
<span class="normal"><a href="#__codelineno-3-8">  8</a></span>
<span class="normal"><a href="#__codelineno-3-9">  9</a></span>
<span class="normal"><a href="#__codelineno-3-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-3-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-3-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-3-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-3-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-3-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-3-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-3-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-3-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-3-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-3-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-3-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-3-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-3-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-3-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-3-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-3-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-3-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-3-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-3-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-3-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-3-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-3-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-3-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-3-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-3-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-3-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-3-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-3-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-3-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-3-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-3-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-3-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-3-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-3-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-3-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-3-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-3-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-3-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-3-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-3-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-3-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-3-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-3-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-3-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-3-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-3-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-3-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-3-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-3-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-3-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-3-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-3-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-3-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-3-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-3-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-3-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-3-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-3-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-3-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-3-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-3-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-3-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-3-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-3-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-3-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-3-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-3-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-3-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-3-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-3-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-3-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-3-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-3-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-3-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-3-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-3-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-3-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-3-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-3-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-3-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-3-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-3-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-3-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-3-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-3-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-3-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-3-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-3-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-3-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-3-100">100</a></span>
<span class="normal"><a href="#__codelineno-3-101">101</a></span>
<span class="normal"><a href="#__codelineno-3-102">102</a></span>
<span class="normal"><a href="#__codelineno-3-103">103</a></span>
<span class="normal"><a href="#__codelineno-3-104">104</a></span>
<span class="normal"><a href="#__codelineno-3-105">105</a></span>
<span class="normal"><a href="#__codelineno-3-106">106</a></span>
<span class="normal"><a href="#__codelineno-3-107">107</a></span>
<span class="normal"><a href="#__codelineno-3-108">108</a></span>
<span class="normal"><a href="#__codelineno-3-109">109</a></span>
<span class="normal"><a href="#__codelineno-3-110">110</a></span>
<span class="normal"><a href="#__codelineno-3-111">111</a></span>
<span class="normal"><a href="#__codelineno-3-112">112</a></span>
<span class="normal"><a href="#__codelineno-3-113">113</a></span>
<span class="normal"><a href="#__codelineno-3-114">114</a></span>
<span class="normal"><a href="#__codelineno-3-115">115</a></span>
<span class="normal"><a href="#__codelineno-3-116">116</a></span>
<span class="normal"><a href="#__codelineno-3-117">117</a></span>
<span class="normal"><a href="#__codelineno-3-118">118</a></span>
<span class="normal"><a href="#__codelineno-3-119">119</a></span>
<span class="normal"><a href="#__codelineno-3-120">120</a></span>
<span class="normal"><a href="#__codelineno-3-121">121</a></span>
<span class="normal"><a href="#__codelineno-3-122">122</a></span>
<span class="normal"><a href="#__codelineno-3-123">123</a></span>
<span class="normal"><a href="#__codelineno-3-124">124</a></span>
<span class="normal"><a href="#__codelineno-3-125">125</a></span>
<span class="normal"><a href="#__codelineno-3-126">126</a></span>
<span class="normal"><a href="#__codelineno-3-127">127</a></span>
<span class="normal"><a href="#__codelineno-3-128">128</a></span>
<span class="normal"><a href="#__codelineno-3-129">129</a></span>
<span class="normal"><a href="#__codelineno-3-130">130</a></span>
<span class="normal"><a href="#__codelineno-3-131">131</a></span>
<span class="normal"><a href="#__codelineno-3-132">132</a></span>
<span class="normal"><a href="#__codelineno-3-133">133</a></span>
<span class="normal"><a href="#__codelineno-3-134">134</a></span>
<span class="normal"><a href="#__codelineno-3-135">135</a></span>
<span class="normal"><a href="#__codelineno-3-136">136</a></span>
<span class="normal"><a href="#__codelineno-3-137">137</a></span>
<span class="normal"><a href="#__codelineno-3-138">138</a></span>
<span class="normal"><a href="#__codelineno-3-139">139</a></span>
<span class="normal"><a href="#__codelineno-3-140">140</a></span>
<span class="normal"><a href="#__codelineno-3-141">141</a></span>
<span class="normal"><a href="#__codelineno-3-142">142</a></span>
<span class="normal"><a href="#__codelineno-3-143">143</a></span>
<span class="normal"><a href="#__codelineno-3-144">144</a></span>
<span class="normal"><a href="#__codelineno-3-145">145</a></span>
<span class="normal"><a href="#__codelineno-3-146">146</a></span>
<span class="normal"><a href="#__codelineno-3-147">147</a></span>
<span class="normal"><a href="#__codelineno-3-148">148</a></span>
<span class="normal"><a href="#__codelineno-3-149">149</a></span>
<span class="normal"><a href="#__codelineno-3-150">150</a></span>
<span class="normal"><a href="#__codelineno-3-151">151</a></span>
<span class="normal"><a href="#__codelineno-3-152">152</a></span>
<span class="normal"><a href="#__codelineno-3-153">153</a></span>
<span class="normal"><a href="#__codelineno-3-154">154</a></span>
<span class="normal"><a href="#__codelineno-3-155">155</a></span>
<span class="normal"><a href="#__codelineno-3-156">156</a></span>
<span class="normal"><a href="#__codelineno-3-157">157</a></span>
<span class="normal"><a href="#__codelineno-3-158">158</a></span>
<span class="normal"><a href="#__codelineno-3-159">159</a></span>
<span class="normal"><a href="#__codelineno-3-160">160</a></span>
<span class="normal"><a href="#__codelineno-3-161">161</a></span>
<span class="normal"><a href="#__codelineno-3-162">162</a></span>
<span class="normal"><a href="#__codelineno-3-163">163</a></span>
<span class="normal"><a href="#__codelineno-3-164">164</a></span>
<span class="normal"><a href="#__codelineno-3-165">165</a></span>
<span class="normal"><a href="#__codelineno-3-166">166</a></span>
<span class="normal"><a href="#__codelineno-3-167">167</a></span>
<span class="normal"><a href="#__codelineno-3-168">168</a></span>
<span class="normal"><a href="#__codelineno-3-169">169</a></span>
<span class="normal"><a href="#__codelineno-3-170">170</a></span>
<span class="normal"><a href="#__codelineno-3-171">171</a></span>
<span class="normal"><a href="#__codelineno-3-172">172</a></span>
<span class="normal"><a href="#__codelineno-3-173">173</a></span>
<span class="normal"><a href="#__codelineno-3-174">174</a></span>
<span class="normal"><a href="#__codelineno-3-175">175</a></span>
<span class="normal"><a href="#__codelineno-3-176">176</a></span>
<span class="normal"><a href="#__codelineno-3-177">177</a></span>
<span class="normal"><a href="#__codelineno-3-178">178</a></span>
<span class="normal"><a href="#__codelineno-3-179">179</a></span>
<span class="normal"><a href="#__codelineno-3-180">180</a></span>
<span class="normal"><a href="#__codelineno-3-181">181</a></span>
<span class="normal"><a href="#__codelineno-3-182">182</a></span>
<span class="normal"><a href="#__codelineno-3-183">183</a></span>
<span class="normal"><a href="#__codelineno-3-184">184</a></span>
<span class="normal"><a href="#__codelineno-3-185">185</a></span>
<span class="normal"><a href="#__codelineno-3-186">186</a></span>
<span class="normal"><a href="#__codelineno-3-187">187</a></span>
<span class="normal"><a href="#__codelineno-3-188">188</a></span>
<span class="normal"><a href="#__codelineno-3-189">189</a></span>
<span class="normal"><a href="#__codelineno-3-190">190</a></span>
<span class="normal"><a href="#__codelineno-3-191">191</a></span>
<span class="normal"><a href="#__codelineno-3-192">192</a></span>
<span class="normal"><a href="#__codelineno-3-193">193</a></span>
<span class="normal"><a href="#__codelineno-3-194">194</a></span>
<span class="normal"><a href="#__codelineno-3-195">195</a></span>
<span class="normal"><a href="#__codelineno-3-196">196</a></span>
<span class="normal"><a href="#__codelineno-3-197">197</a></span>
<span class="normal"><a href="#__codelineno-3-198">198</a></span>
<span class="normal"><a href="#__codelineno-3-199">199</a></span>
<span class="normal"><a href="#__codelineno-3-200">200</a></span>
<span class="normal"><a href="#__codelineno-3-201">201</a></span>
<span class="normal"><a href="#__codelineno-3-202">202</a></span>
<span class="normal"><a href="#__codelineno-3-203">203</a></span>
<span class="normal"><a href="#__codelineno-3-204">204</a></span>
<span class="normal"><a href="#__codelineno-3-205">205</a></span>
<span class="normal"><a href="#__codelineno-3-206">206</a></span>
<span class="normal"><a href="#__codelineno-3-207">207</a></span>
<span class="normal"><a href="#__codelineno-3-208">208</a></span>
<span class="normal"><a href="#__codelineno-3-209">209</a></span>
<span class="normal"><a href="#__codelineno-3-210">210</a></span>
<span class="normal"><a href="#__codelineno-3-211">211</a></span>
<span class="normal"><a href="#__codelineno-3-212">212</a></span>
<span class="normal"><a href="#__codelineno-3-213">213</a></span>
<span class="normal"><a href="#__codelineno-3-214">214</a></span>
<span class="normal"><a href="#__codelineno-3-215">215</a></span>
<span class="normal"><a href="#__codelineno-3-216">216</a></span>
<span class="normal"><a href="#__codelineno-3-217">217</a></span>
<span class="normal"><a href="#__codelineno-3-218">218</a></span>
<span class="normal"><a href="#__codelineno-3-219">219</a></span>
<span class="normal"><a href="#__codelineno-3-220">220</a></span>
<span class="normal"><a href="#__codelineno-3-221">221</a></span>
<span class="normal"><a href="#__codelineno-3-222">222</a></span>
<span class="normal"><a href="#__codelineno-3-223">223</a></span>
<span class="normal"><a href="#__codelineno-3-224">224</a></span>
<span class="normal"><a href="#__codelineno-3-225">225</a></span>
<span class="normal"><a href="#__codelineno-3-226">226</a></span>
<span class="normal"><a href="#__codelineno-3-227">227</a></span>
<span class="normal"><a href="#__codelineno-3-228">228</a></span>
<span class="normal"><a href="#__codelineno-3-229">229</a></span>
<span class="normal"><a href="#__codelineno-3-230">230</a></span>
<span class="normal"><a href="#__codelineno-3-231">231</a></span>
<span class="normal"><a href="#__codelineno-3-232">232</a></span>
<span class="normal"><a href="#__codelineno-3-233">233</a></span>
<span class="normal"><a href="#__codelineno-3-234">234</a></span>
<span class="normal"><a href="#__codelineno-3-235">235</a></span>
<span class="normal"><a href="#__codelineno-3-236">236</a></span>
<span class="normal"><a href="#__codelineno-3-237">237</a></span>
<span class="normal"><a href="#__codelineno-3-238">238</a></span>
<span class="normal"><a href="#__codelineno-3-239">239</a></span>
<span class="normal"><a href="#__codelineno-3-240">240</a></span>
<span class="normal"><a href="#__codelineno-3-241">241</a></span>
<span class="normal"><a href="#__codelineno-3-242">242</a></span>
<span class="normal"><a href="#__codelineno-3-243">243</a></span>
<span class="normal"><a href="#__codelineno-3-244">244</a></span>
<span class="normal"><a href="#__codelineno-3-245">245</a></span>
<span class="normal"><a href="#__codelineno-3-246">246</a></span>
<span class="normal"><a href="#__codelineno-3-247">247</a></span>
<span class="normal"><a href="#__codelineno-3-248">248</a></span>
<span class="normal"><a href="#__codelineno-3-249">249</a></span>
<span class="normal"><a href="#__codelineno-3-250">250</a></span>
<span class="normal"><a href="#__codelineno-3-251">251</a></span>
<span class="normal"><a href="#__codelineno-3-252">252</a></span>
<span class="normal"><a href="#__codelineno-3-253">253</a></span>
<span class="normal"><a href="#__codelineno-3-254">254</a></span>
<span class="normal"><a href="#__codelineno-3-255">255</a></span>
<span class="normal"><a href="#__codelineno-3-256">256</a></span>
<span class="normal"><a href="#__codelineno-3-257">257</a></span>
<span class="normal"><a href="#__codelineno-3-258">258</a></span>
<span class="normal"><a href="#__codelineno-3-259">259</a></span>
<span class="normal"><a href="#__codelineno-3-260">260</a></span>
<span class="normal"><a href="#__codelineno-3-261">261</a></span>
<span class="normal"><a href="#__codelineno-3-262">262</a></span>
<span class="normal"><a href="#__codelineno-3-263">263</a></span>
<span class="normal"><a href="#__codelineno-3-264">264</a></span>
<span class="normal"><a href="#__codelineno-3-265">265</a></span>
<span class="normal"><a href="#__codelineno-3-266">266</a></span>
<span class="normal"><a href="#__codelineno-3-267">267</a></span>
<span class="normal"><a href="#__codelineno-3-268">268</a></span>
<span class="normal"><a href="#__codelineno-3-269">269</a></span>
<span class="normal"><a href="#__codelineno-3-270">270</a></span>
<span class="normal"><a href="#__codelineno-3-271">271</a></span>
<span class="normal"><a href="#__codelineno-3-272">272</a></span>
<span class="normal"><a href="#__codelineno-3-273">273</a></span>
<span class="normal"><a href="#__codelineno-3-274">274</a></span>
<span class="normal"><a href="#__codelineno-3-275">275</a></span>
<span class="normal"><a href="#__codelineno-3-276">276</a></span>
<span class="normal"><a href="#__codelineno-3-277">277</a></span>
<span class="normal"><a href="#__codelineno-3-278">278</a></span>
<span class="normal"><a href="#__codelineno-3-279">279</a></span>
<span class="normal"><a href="#__codelineno-3-280">280</a></span>
<span class="normal"><a href="#__codelineno-3-281">281</a></span>
<span class="normal"><a href="#__codelineno-3-282">282</a></span>
<span class="normal"><a href="#__codelineno-3-283">283</a></span>
<span class="normal"><a href="#__codelineno-3-284">284</a></span>
<span class="normal"><a href="#__codelineno-3-285">285</a></span>
<span class="normal"><a href="#__codelineno-3-286">286</a></span>
<span class="normal"><a href="#__codelineno-3-287">287</a></span>
<span class="normal"><a href="#__codelineno-3-288">288</a></span>
<span class="normal"><a href="#__codelineno-3-289">289</a></span>
<span class="normal"><a href="#__codelineno-3-290">290</a></span>
<span class="normal"><a href="#__codelineno-3-291">291</a></span>
<span class="normal"><a href="#__codelineno-3-292">292</a></span>
<span class="normal"><a href="#__codelineno-3-293">293</a></span>
<span class="normal"><a href="#__codelineno-3-294">294</a></span>
<span class="normal"><a href="#__codelineno-3-295">295</a></span>
<span class="normal"><a href="#__codelineno-3-296">296</a></span>
<span class="normal"><a href="#__codelineno-3-297">297</a></span>
<span class="normal"><a href="#__codelineno-3-298">298</a></span>
<span class="normal"><a href="#__codelineno-3-299">299</a></span>
<span class="normal"><a href="#__codelineno-3-300">300</a></span>
<span class="normal"><a href="#__codelineno-3-301">301</a></span>
<span class="normal"><a href="#__codelineno-3-302">302</a></span>
<span class="normal"><a href="#__codelineno-3-303">303</a></span>
<span class="normal"><a href="#__codelineno-3-304">304</a></span>
<span class="normal"><a href="#__codelineno-3-305">305</a></span>
<span class="normal"><a href="#__codelineno-3-306">306</a></span>
<span class="normal"><a href="#__codelineno-3-307">307</a></span>
<span class="normal"><a href="#__codelineno-3-308">308</a></span>
<span class="normal"><a href="#__codelineno-3-309">309</a></span>
<span class="normal"><a href="#__codelineno-3-310">310</a></span>
<span class="normal"><a href="#__codelineno-3-311">311</a></span>
<span class="normal"><a href="#__codelineno-3-312">312</a></span>
<span class="normal"><a href="#__codelineno-3-313">313</a></span>
<span class="normal"><a href="#__codelineno-3-314">314</a></span>
<span class="normal"><a href="#__codelineno-3-315">315</a></span>
<span class="normal"><a href="#__codelineno-3-316">316</a></span>
<span class="normal"><a href="#__codelineno-3-317">317</a></span>
<span class="normal"><a href="#__codelineno-3-318">318</a></span>
<span class="normal"><a href="#__codelineno-3-319">319</a></span>
<span class="normal"><a href="#__codelineno-3-320">320</a></span>
<span class="normal"><a href="#__codelineno-3-321">321</a></span>
<span class="normal"><a href="#__codelineno-3-322">322</a></span>
<span class="normal"><a href="#__codelineno-3-323">323</a></span>
<span class="normal"><a href="#__codelineno-3-324">324</a></span>
<span class="normal"><a href="#__codelineno-3-325">325</a></span>
<span class="normal"><a href="#__codelineno-3-326">326</a></span>
<span class="normal"><a href="#__codelineno-3-327">327</a></span>
<span class="normal"><a href="#__codelineno-3-328">328</a></span>
<span class="normal"><a href="#__codelineno-3-329">329</a></span>
<span class="normal"><a href="#__codelineno-3-330">330</a></span>
<span class="normal"><a href="#__codelineno-3-331">331</a></span>
<span class="normal"><a href="#__codelineno-3-332">332</a></span>
<span class="normal"><a href="#__codelineno-3-333">333</a></span>
<span class="normal"><a href="#__codelineno-3-334">334</a></span>
<span class="normal"><a href="#__codelineno-3-335">335</a></span>
<span class="normal"><a href="#__codelineno-3-336">336</a></span>
<span class="normal"><a href="#__codelineno-3-337">337</a></span>
<span class="normal"><a href="#__codelineno-3-338">338</a></span>
<span class="normal"><a href="#__codelineno-3-339">339</a></span>
<span class="normal"><a href="#__codelineno-3-340">340</a></span>
<span class="normal"><a href="#__codelineno-3-341">341</a></span>
<span class="normal"><a href="#__codelineno-3-342">342</a></span>
<span class="normal"><a href="#__codelineno-3-343">343</a></span>
<span class="normal"><a href="#__codelineno-3-344">344</a></span>
<span class="normal"><a href="#__codelineno-3-345">345</a></span>
<span class="normal"><a href="#__codelineno-3-346">346</a></span>
<span class="normal"><a href="#__codelineno-3-347">347</a></span>
<span class="normal"><a href="#__codelineno-3-348">348</a></span>
<span class="normal"><a href="#__codelineno-3-349">349</a></span>
<span class="normal"><a href="#__codelineno-3-350">350</a></span>
<span class="normal"><a href="#__codelineno-3-351">351</a></span>
<span class="normal"><a href="#__codelineno-3-352">352</a></span>
<span class="normal"><a href="#__codelineno-3-353">353</a></span>
<span class="normal"><a href="#__codelineno-3-354">354</a></span>
<span class="normal"><a href="#__codelineno-3-355">355</a></span>
<span class="normal"><a href="#__codelineno-3-356">356</a></span>
<span class="normal"><a href="#__codelineno-3-357">357</a></span>
<span class="normal"><a href="#__codelineno-3-358">358</a></span>
<span class="normal"><a href="#__codelineno-3-359">359</a></span>
<span class="normal"><a href="#__codelineno-3-360">360</a></span>
<span class="normal"><a href="#__codelineno-3-361">361</a></span>
<span class="normal"><a href="#__codelineno-3-362">362</a></span>
<span class="normal"><a href="#__codelineno-3-363">363</a></span>
<span class="normal"><a href="#__codelineno-3-364">364</a></span>
<span class="normal"><a href="#__codelineno-3-365">365</a></span>
<span class="normal"><a href="#__codelineno-3-366">366</a></span>
<span class="normal"><a href="#__codelineno-3-367">367</a></span>
<span class="normal"><a href="#__codelineno-3-368">368</a></span>
<span class="normal"><a href="#__codelineno-3-369">369</a></span>
<span class="normal"><a href="#__codelineno-3-370">370</a></span>
<span class="normal"><a href="#__codelineno-3-371">371</a></span>
<span class="normal"><a href="#__codelineno-3-372">372</a></span>
<span class="normal"><a href="#__codelineno-3-373">373</a></span>
<span class="normal"><a href="#__codelineno-3-374">374</a></span>
<span class="normal"><a href="#__codelineno-3-375">375</a></span>
<span class="normal"><a href="#__codelineno-3-376">376</a></span>
<span class="normal"><a href="#__codelineno-3-377">377</a></span>
<span class="normal"><a href="#__codelineno-3-378">378</a></span>
<span class="normal"><a href="#__codelineno-3-379">379</a></span>
<span class="normal"><a href="#__codelineno-3-380">380</a></span>
<span class="normal"><a href="#__codelineno-3-381">381</a></span>
<span class="normal"><a href="#__codelineno-3-382">382</a></span>
<span class="normal"><a href="#__codelineno-3-383">383</a></span>
<span class="normal"><a href="#__codelineno-3-384">384</a></span>
<span class="normal"><a href="#__codelineno-3-385">385</a></span>
<span class="normal"><a href="#__codelineno-3-386">386</a></span>
<span class="normal"><a href="#__codelineno-3-387">387</a></span>
<span class="normal"><a href="#__codelineno-3-388">388</a></span>
<span class="normal"><a href="#__codelineno-3-389">389</a></span>
<span class="normal"><a href="#__codelineno-3-390">390</a></span>
<span class="normal"><a href="#__codelineno-3-391">391</a></span>
<span class="normal"><a href="#__codelineno-3-392">392</a></span>
<span class="normal"><a href="#__codelineno-3-393">393</a></span>
<span class="normal"><a href="#__codelineno-3-394">394</a></span>
<span class="normal"><a href="#__codelineno-3-395">395</a></span>
<span class="normal"><a href="#__codelineno-3-396">396</a></span>
<span class="normal"><a href="#__codelineno-3-397">397</a></span>
<span class="normal"><a href="#__codelineno-3-398">398</a></span>
<span class="normal"><a href="#__codelineno-3-399">399</a></span>
<span class="normal"><a href="#__codelineno-3-400">400</a></span>
<span class="normal"><a href="#__codelineno-3-401">401</a></span>
<span class="normal"><a href="#__codelineno-3-402">402</a></span>
<span class="normal"><a href="#__codelineno-3-403">403</a></span>
<span class="normal"><a href="#__codelineno-3-404">404</a></span>
<span class="normal"><a href="#__codelineno-3-405">405</a></span>
<span class="normal"><a href="#__codelineno-3-406">406</a></span>
<span class="normal"><a href="#__codelineno-3-407">407</a></span>
<span class="normal"><a href="#__codelineno-3-408">408</a></span>
<span class="normal"><a href="#__codelineno-3-409">409</a></span>
<span class="normal"><a href="#__codelineno-3-410">410</a></span>
<span class="normal"><a href="#__codelineno-3-411">411</a></span>
<span class="normal"><a href="#__codelineno-3-412">412</a></span>
<span class="normal"><a href="#__codelineno-3-413">413</a></span>
<span class="normal"><a href="#__codelineno-3-414">414</a></span>
<span class="normal"><a href="#__codelineno-3-415">415</a></span>
<span class="normal"><a href="#__codelineno-3-416">416</a></span>
<span class="normal"><a href="#__codelineno-3-417">417</a></span>
<span class="normal"><a href="#__codelineno-3-418">418</a></span>
<span class="normal"><a href="#__codelineno-3-419">419</a></span>
<span class="normal"><a href="#__codelineno-3-420">420</a></span>
<span class="normal"><a href="#__codelineno-3-421">421</a></span>
<span class="normal"><a href="#__codelineno-3-422">422</a></span>
<span class="normal"><a href="#__codelineno-3-423">423</a></span>
<span class="normal"><a href="#__codelineno-3-424">424</a></span>
<span class="normal"><a href="#__codelineno-3-425">425</a></span>
<span class="normal"><a href="#__codelineno-3-426">426</a></span>
<span class="normal"><a href="#__codelineno-3-427">427</a></span>
<span class="normal"><a href="#__codelineno-3-428">428</a></span>
<span class="normal"><a href="#__codelineno-3-429">429</a></span>
<span class="normal"><a href="#__codelineno-3-430">430</a></span>
<span class="normal"><a href="#__codelineno-3-431">431</a></span>
<span class="normal"><a href="#__codelineno-3-432">432</a></span>
<span class="normal"><a href="#__codelineno-3-433">433</a></span>
<span class="normal"><a href="#__codelineno-3-434">434</a></span>
<span class="normal"><a href="#__codelineno-3-435">435</a></span>
<span class="normal"><a href="#__codelineno-3-436">436</a></span>
<span class="normal"><a href="#__codelineno-3-437">437</a></span>
<span class="normal"><a href="#__codelineno-3-438">438</a></span>
<span class="normal"><a href="#__codelineno-3-439">439</a></span>
<span class="normal"><a href="#__codelineno-3-440">440</a></span>
<span class="normal"><a href="#__codelineno-3-441">441</a></span>
<span class="normal"><a href="#__codelineno-3-442">442</a></span>
<span class="normal"><a href="#__codelineno-3-443">443</a></span>
<span class="normal"><a href="#__codelineno-3-444">444</a></span>
<span class="normal"><a href="#__codelineno-3-445">445</a></span>
<span class="normal"><a href="#__codelineno-3-446">446</a></span>
<span class="normal"><a href="#__codelineno-3-447">447</a></span>
<span class="normal"><a href="#__codelineno-3-448">448</a></span>
<span class="normal"><a href="#__codelineno-3-449">449</a></span>
<span class="normal"><a href="#__codelineno-3-450">450</a></span>
<span class="normal"><a href="#__codelineno-3-451">451</a></span>
<span class="normal"><a href="#__codelineno-3-452">452</a></span>
<span class="normal"><a href="#__codelineno-3-453">453</a></span>
<span class="normal"><a href="#__codelineno-3-454">454</a></span>
<span class="normal"><a href="#__codelineno-3-455">455</a></span>
<span class="normal"><a href="#__codelineno-3-456">456</a></span>
<span class="normal"><a href="#__codelineno-3-457">457</a></span>
<span class="normal"><a href="#__codelineno-3-458">458</a></span>
<span class="normal"><a href="#__codelineno-3-459">459</a></span>
<span class="normal"><a href="#__codelineno-3-460">460</a></span>
<span class="normal"><a href="#__codelineno-3-461">461</a></span>
<span class="normal"><a href="#__codelineno-3-462">462</a></span>
<span class="normal"><a href="#__codelineno-3-463">463</a></span>
<span class="normal"><a href="#__codelineno-3-464">464</a></span>
<span class="normal"><a href="#__codelineno-3-465">465</a></span>
<span class="normal"><a href="#__codelineno-3-466">466</a></span>
<span class="normal"><a href="#__codelineno-3-467">467</a></span>
<span class="normal"><a href="#__codelineno-3-468">468</a></span>
<span class="normal"><a href="#__codelineno-3-469">469</a></span>
<span class="normal"><a href="#__codelineno-3-470">470</a></span>
<span class="normal"><a href="#__codelineno-3-471">471</a></span>
<span class="normal"><a href="#__codelineno-3-472">472</a></span>
<span class="normal"><a href="#__codelineno-3-473">473</a></span>
<span class="normal"><a href="#__codelineno-3-474">474</a></span>
<span class="normal"><a href="#__codelineno-3-475">475</a></span>
<span class="normal"><a href="#__codelineno-3-476">476</a></span>
<span class="normal"><a href="#__codelineno-3-477">477</a></span>
<span class="normal"><a href="#__codelineno-3-478">478</a></span>
<span class="normal"><a href="#__codelineno-3-479">479</a></span>
<span class="normal"><a href="#__codelineno-3-480">480</a></span>
<span class="normal"><a href="#__codelineno-3-481">481</a></span>
<span class="normal"><a href="#__codelineno-3-482">482</a></span>
<span class="normal"><a href="#__codelineno-3-483">483</a></span>
<span class="normal"><a href="#__codelineno-3-484">484</a></span>
<span class="normal"><a href="#__codelineno-3-485">485</a></span>
<span class="normal"><a href="#__codelineno-3-486">486</a></span>
<span class="normal"><a href="#__codelineno-3-487">487</a></span>
<span class="normal"><a href="#__codelineno-3-488">488</a></span>
<span class="normal"><a href="#__codelineno-3-489">489</a></span>
<span class="normal"><a href="#__codelineno-3-490">490</a></span>
<span class="normal"><a href="#__codelineno-3-491">491</a></span>
<span class="normal"><a href="#__codelineno-3-492">492</a></span>
<span class="normal"><a href="#__codelineno-3-493">493</a></span>
<span class="normal"><a href="#__codelineno-3-494">494</a></span>
<span class="normal"><a href="#__codelineno-3-495">495</a></span>
<span class="normal"><a href="#__codelineno-3-496">496</a></span>
<span class="normal"><a href="#__codelineno-3-497">497</a></span>
<span class="normal"><a href="#__codelineno-3-498">498</a></span>
<span class="normal"><a href="#__codelineno-3-499">499</a></span>
<span class="normal"><a href="#__codelineno-3-500">500</a></span>
<span class="normal"><a href="#__codelineno-3-501">501</a></span>
<span class="normal"><a href="#__codelineno-3-502">502</a></span>
<span class="normal"><a href="#__codelineno-3-503">503</a></span>
<span class="normal"><a href="#__codelineno-3-504">504</a></span>
<span class="normal"><a href="#__codelineno-3-505">505</a></span>
<span class="normal"><a href="#__codelineno-3-506">506</a></span>
<span class="normal"><a href="#__codelineno-3-507">507</a></span>
<span class="normal"><a href="#__codelineno-3-508">508</a></span>
<span class="normal"><a href="#__codelineno-3-509">509</a></span>
<span class="normal"><a href="#__codelineno-3-510">510</a></span>
<span class="normal"><a href="#__codelineno-3-511">511</a></span>
<span class="normal"><a href="#__codelineno-3-512">512</a></span>
<span class="normal"><a href="#__codelineno-3-513">513</a></span>
<span class="normal"><a href="#__codelineno-3-514">514</a></span>
<span class="normal"><a href="#__codelineno-3-515">515</a></span>
<span class="normal"><a href="#__codelineno-3-516">516</a></span>
<span class="normal"><a href="#__codelineno-3-517">517</a></span>
<span class="normal"><a href="#__codelineno-3-518">518</a></span>
<span class="normal"><a href="#__codelineno-3-519">519</a></span>
<span class="normal"><a href="#__codelineno-3-520">520</a></span>
<span class="normal"><a href="#__codelineno-3-521">521</a></span>
<span class="normal"><a href="#__codelineno-3-522">522</a></span>
<span class="normal"><a href="#__codelineno-3-523">523</a></span>
<span class="normal"><a href="#__codelineno-3-524">524</a></span>
<span class="normal"><a href="#__codelineno-3-525">525</a></span>
<span class="normal"><a href="#__codelineno-3-526">526</a></span>
<span class="normal"><a href="#__codelineno-3-527">527</a></span>
<span class="normal"><a href="#__codelineno-3-528">528</a></span>
<span class="normal"><a href="#__codelineno-3-529">529</a></span>
<span class="normal"><a href="#__codelineno-3-530">530</a></span>
<span class="normal"><a href="#__codelineno-3-531">531</a></span>
<span class="normal"><a href="#__codelineno-3-532">532</a></span>
<span class="normal"><a href="#__codelineno-3-533">533</a></span>
<span class="normal"><a href="#__codelineno-3-534">534</a></span>
<span class="normal"><a href="#__codelineno-3-535">535</a></span>
<span class="normal"><a href="#__codelineno-3-536">536</a></span>
<span class="normal"><a href="#__codelineno-3-537">537</a></span>
<span class="normal"><a href="#__codelineno-3-538">538</a></span>
<span class="normal"><a href="#__codelineno-3-539">539</a></span>
<span class="normal"><a href="#__codelineno-3-540">540</a></span>
<span class="normal"><a href="#__codelineno-3-541">541</a></span>
<span class="normal"><a href="#__codelineno-3-542">542</a></span>
<span class="normal"><a href="#__codelineno-3-543">543</a></span>
<span class="normal"><a href="#__codelineno-3-544">544</a></span>
<span class="normal"><a href="#__codelineno-3-545">545</a></span>
<span class="normal"><a href="#__codelineno-3-546">546</a></span>
<span class="normal"><a href="#__codelineno-3-547">547</a></span>
<span class="normal"><a href="#__codelineno-3-548">548</a></span>
<span class="normal"><a href="#__codelineno-3-549">549</a></span>
<span class="normal"><a href="#__codelineno-3-550">550</a></span>
<span class="normal"><a href="#__codelineno-3-551">551</a></span>
<span class="normal"><a href="#__codelineno-3-552">552</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="s2">"(Possibly )?corrupt EXIF data"</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">ConcatDataset</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">T</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">vgg16</span><span class="p">,</span> <span class="n">VGG16_Weights</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">it</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="c1"># -------------------- é…ç½® --------------------</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="n">USE_AMP</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># å›ºå®šç”¨ CUDA AMP</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="c1"># Kaggle è·¯å¾„</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="n">VOC2007_ROOT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2007/VOCtrainval_06-Nov-2007/VOCdevkit/VOC2007"</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="n">VOC2007_ROOT_ALT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2007/VOCdevkit/VOC2007"</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT_ALT</span><span class="p">):</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>    <span class="n">VOC2007_ROOT</span> <span class="o">=</span> <span class="n">VOC2007_ROOT_ALT</span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a>
<a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="n">VOC2012_ROOT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2012/VOC2012"</span>
<a id="__codelineno-3-31" name="__codelineno-3-31"></a>
<a id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="mi">21</span>
<a id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>
<a id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="n">VAL_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">6</span>
<a id="__codelineno-3-36" name="__codelineno-3-36"></a>
<a id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">7.5e-5</span>
<a id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="n">WEIGHT_DECAY</span> <span class="o">=</span> <span class="mf">1e-4</span>
<a id="__codelineno-3-39" name="__codelineno-3-39"></a><span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">50</span>
<a id="__codelineno-3-40" name="__codelineno-3-40"></a>
<a id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="c1"># è¯„ä¼°åŠ é€Ÿå¼€å…³</span>
<a id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="n">EVAL_COMPUTE_LOSS</span> <span class="o">=</span> <span class="kc">False</span>     <span class="c1"># True ä¼šè®¡ç®— val lossï¼Œç¨æ…¢</span>
<a id="__codelineno-3-43" name="__codelineno-3-43"></a><span class="n">EVAL_MAX_BATCHES</span> <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># é™åˆ¶è¯„ä¼°æ‰¹æ¬¡æ•°ï¼›None è¡¨ç¤ºå…¨é‡</span>
<a id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="n">EVAL_MAX_IMAGES</span> <span class="o">=</span> <span class="kc">None</span>        <span class="c1"># é™åˆ¶è¯„ä¼°å›¾ç‰‡æ•°ï¼›None è¡¨ç¤ºå…¨é‡</span>
<a id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="n">EVAL_PROGRESS</span> <span class="o">=</span> <span class="kc">True</span>          <span class="c1"># ä¿ç•™ tqdm è¿›åº¦æ¡</span>
<a id="__codelineno-3-46" name="__codelineno-3-46"></a>
<a id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="n">SAVE_DIR</span> <span class="o">=</span> <span class="s2">"/kaggle/working"</span>
<a id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="n">BEST_PATH_VOC</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"fcn8s_best_voc2012val.pth"</span><span class="p">)</span>
<a id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="n">LATEST_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"fcn8s_latest.pth"</span><span class="p">)</span>
<a id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="n">VIS_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"vis_voc_val"</span><span class="p">)</span>
<a id="__codelineno-3-51" name="__codelineno-3-51"></a>
<a id="__codelineno-3-52" name="__codelineno-3-52"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using device: </span><span class="si">{</span><span class="n">DEVICE</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s2">"cuda"</span><span class="p">:</span>
<a id="__codelineno-3-54" name="__codelineno-3-54"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-3-55" name="__codelineno-3-55"></a>
<a id="__codelineno-3-56" name="__codelineno-3-56"></a><span class="c1"># PASCAL VOC é¢œè‰²æ˜ å°„ (RGB) ç”¨äºå¯è§†åŒ–</span>
<a id="__codelineno-3-57" name="__codelineno-3-57"></a><span class="n">VOC_COLORMAP</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-3-58" name="__codelineno-3-58"></a>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
<a id="__codelineno-3-59" name="__codelineno-3-59"></a>    <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-3-60" name="__codelineno-3-60"></a>    <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
<a id="__codelineno-3-61" name="__codelineno-3-61"></a>    <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-3-62" name="__codelineno-3-62"></a>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
<a id="__codelineno-3-63" name="__codelineno-3-63"></a><span class="p">]</span>
<a id="__codelineno-3-64" name="__codelineno-3-64"></a>
<a id="__codelineno-3-65" name="__codelineno-3-65"></a><span class="c1"># -------------------- æ•°æ®é›†ï¼ˆVOCï¼‰ --------------------</span>
<a id="__codelineno-3-66" name="__codelineno-3-66"></a><span class="k">class</span><span class="w"> </span><span class="nc">VOCSegmentationDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-3-67" name="__codelineno-3-67"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-3-68" name="__codelineno-3-68"></a><span class="sd">    ç”¨äº VOC2007/VOC2012 çš„è¯­ä¹‰åˆ†å‰²æ•°æ®ã€‚</span>
<a id="__codelineno-3-69" name="__codelineno-3-69"></a><span class="sd">    è‹¥ç¼ºå°‘ ImageSets/Segmentation/{split}.txtï¼Œå°†å›é€€åˆ°æ‰«æ SegmentationClass ç›®å½•ã€‚</span>
<a id="__codelineno-3-70" name="__codelineno-3-70"></a><span class="sd">    """</span>
<a id="__codelineno-3-71" name="__codelineno-3-71"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s2">"train"</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-3-72" name="__codelineno-3-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
<a id="__codelineno-3-73" name="__codelineno-3-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>
<a id="__codelineno-3-74" name="__codelineno-3-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_set</span> <span class="o">=</span> <span class="n">image_set</span>
<a id="__codelineno-3-75" name="__codelineno-3-75"></a>
<a id="__codelineno-3-76" name="__codelineno-3-76"></a>        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"JPEGImages"</span><span class="p">)</span>
<a id="__codelineno-3-77" name="__codelineno-3-77"></a>        <span class="n">mask_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"SegmentationClass"</span><span class="p">)</span>
<a id="__codelineno-3-78" name="__codelineno-3-78"></a>        <span class="n">split_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"ImageSets"</span><span class="p">,</span> <span class="s2">"Segmentation"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">image_set</span><span class="si">}</span><span class="s2">.txt"</span><span class="p">)</span>
<a id="__codelineno-3-79" name="__codelineno-3-79"></a>
<a id="__codelineno-3-80" name="__codelineno-3-80"></a>        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">image_dir</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Image dir not found: </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-3-81" name="__codelineno-3-81"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">):</span>
<a id="__codelineno-3-82" name="__codelineno-3-82"></a>            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
<a id="__codelineno-3-83" name="__codelineno-3-83"></a>                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"SegmentationClass not found: </span><span class="si">{</span><span class="n">mask_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-84" name="__codelineno-3-84"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-85" name="__codelineno-3-85"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[Warning] SegmentationClass not found in </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">, dataset will be empty."</span><span class="p">)</span>
<a id="__codelineno-3-86" name="__codelineno-3-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span> <span class="o">=</span> <span class="n">image_dir</span>
<a id="__codelineno-3-87" name="__codelineno-3-87"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask_dir</span> <span class="o">=</span> <span class="n">mask_dir</span>
<a id="__codelineno-3-88" name="__codelineno-3-88"></a>
<a id="__codelineno-3-89" name="__codelineno-3-89"></a>        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-90" name="__codelineno-3-90"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">split_file</span><span class="p">):</span>
<a id="__codelineno-3-91" name="__codelineno-3-91"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">split_file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-3-92" name="__codelineno-3-92"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
<a id="__codelineno-3-93" name="__codelineno-3-93"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-94" name="__codelineno-3-94"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">):</span>
<a id="__codelineno-3-95" name="__codelineno-3-95"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".png"</span><span class="p">)]</span>
<a id="__codelineno-3-96" name="__codelineno-3-96"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-97" name="__codelineno-3-97"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-98" name="__codelineno-3-98"></a>
<a id="__codelineno-3-99" name="__codelineno-3-99"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-3-100" name="__codelineno-3-100"></a>        <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
<a id="__codelineno-3-101" name="__codelineno-3-101"></a>            <span class="n">ip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.jpg"</span><span class="p">)</span>
<a id="__codelineno-3-102" name="__codelineno-3-102"></a>            <span class="n">mp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
<a id="__codelineno-3-103" name="__codelineno-3-103"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">mp</span><span class="p">):</span>
<a id="__codelineno-3-104" name="__codelineno-3-104"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
<a id="__codelineno-3-105" name="__codelineno-3-105"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<a id="__codelineno-3-106" name="__codelineno-3-106"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-107" name="__codelineno-3-107"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[Warning] Empty dataset for root=</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">, split=</span><span class="si">{</span><span class="n">image_set</span><span class="si">}</span><span class="s2">. Check masks/splits."</span><span class="p">)</span>
<a id="__codelineno-3-108" name="__codelineno-3-108"></a>
<a id="__codelineno-3-109" name="__codelineno-3-109"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-110" name="__codelineno-3-110"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">)</span>
<a id="__codelineno-3-111" name="__codelineno-3-111"></a>
<a id="__codelineno-3-112" name="__codelineno-3-112"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-3-113" name="__codelineno-3-113"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">"RGB"</span><span class="p">)</span>
<a id="__codelineno-3-114" name="__codelineno-3-114"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>  <span class="c1"># palette ç´¢å¼•</span>
<a id="__codelineno-3-115" name="__codelineno-3-115"></a>
<a id="__codelineno-3-116" name="__codelineno-3-116"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-117" name="__codelineno-3-117"></a>            <span class="n">image</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-3-118" name="__codelineno-3-118"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-119" name="__codelineno-3-119"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-3-120" name="__codelineno-3-120"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">))</span>
<a id="__codelineno-3-121" name="__codelineno-3-121"></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-3-122" name="__codelineno-3-122"></a>            <span class="n">image</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-3-123" name="__codelineno-3-123"></a>        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-3-124" name="__codelineno-3-124"></a>
<a id="__codelineno-3-125" name="__codelineno-3-125"></a><span class="c1"># -------------------- æ•°æ®å¢å¼ºä¸é¢„å¤„ç† --------------------</span>
<a id="__codelineno-3-126" name="__codelineno-3-126"></a><span class="k">class</span><span class="w"> </span><span class="nc">SegmentationTransforms</span><span class="p">:</span>
<a id="__codelineno-3-127" name="__codelineno-3-127"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">,</span>
<a id="__codelineno-3-128" name="__codelineno-3-128"></a>                 <span class="n">color_jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_noise_prob</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>
<a id="__codelineno-3-129" name="__codelineno-3-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="n">is_train</span>
<a id="__codelineno-3-130" name="__codelineno-3-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_size</span> <span class="o">=</span> <span class="n">base_size</span>
<a id="__codelineno-3-131" name="__codelineno-3-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">=</span> <span class="n">crop_size</span>
<a id="__codelineno-3-132" name="__codelineno-3-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">)</span>
<a id="__codelineno-3-133" name="__codelineno-3-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)</span>
<a id="__codelineno-3-134" name="__codelineno-3-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ColorJitter</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_jitter</span> <span class="ow">and</span> <span class="n">is_train</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-3-135" name="__codelineno-3-135"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_noise_prob</span> <span class="o">=</span> <span class="n">add_noise_prob</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-3-136" name="__codelineno-3-136"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">noise_std</span> <span class="o">=</span> <span class="n">noise_std</span>
<a id="__codelineno-3-137" name="__codelineno-3-137"></a>
<a id="__codelineno-3-138" name="__codelineno-3-138"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<a id="__codelineno-3-139" name="__codelineno-3-139"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">:</span>
<a id="__codelineno-3-140" name="__codelineno-3-140"></a>            <span class="c1"># 1) éšæœºç¼©æ”¾çŸ­è¾¹åˆ° [0.5, 2.0] * base_size</span>
<a id="__codelineno-3-141" name="__codelineno-3-141"></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-3-142" name="__codelineno-3-142"></a>            <span class="n">short</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
<a id="__codelineno-3-143" name="__codelineno-3-143"></a>            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-3-144" name="__codelineno-3-144"></a>            <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">:</span>
<a id="__codelineno-3-145" name="__codelineno-3-145"></a>                <span class="n">ow</span><span class="p">,</span> <span class="n">oh</span> <span class="o">=</span> <span class="n">short</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">short</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-3-146" name="__codelineno-3-146"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-147" name="__codelineno-3-147"></a>                <span class="n">oh</span><span class="p">,</span> <span class="n">ow</span> <span class="o">=</span> <span class="n">short</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">short</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-3-148" name="__codelineno-3-148"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">ow</span><span class="p">,</span> <span class="n">oh</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">)</span>
<a id="__codelineno-3-149" name="__codelineno-3-149"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">ow</span><span class="p">,</span> <span class="n">oh</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">NEAREST</span><span class="p">)</span>
<a id="__codelineno-3-150" name="__codelineno-3-150"></a>
<a id="__codelineno-3-151" name="__codelineno-3-151"></a>            <span class="c1"># 2) è‹¥å°äº crop_sizeï¼Œå³ä¸‹è§’ paddingï¼ˆmask ç”¨ 255ï¼‰</span>
<a id="__codelineno-3-152" name="__codelineno-3-152"></a>            <span class="n">pad_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-3-153" name="__codelineno-3-153"></a>            <span class="n">pad_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-3-154" name="__codelineno-3-154"></a>            <span class="k">if</span> <span class="n">pad_w</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pad_h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-155" name="__codelineno-3-155"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">,</span> <span class="n">pad_h</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-156" name="__codelineno-3-156"></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">,</span> <span class="n">pad_h</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-3-157" name="__codelineno-3-157"></a>
<a id="__codelineno-3-158" name="__codelineno-3-158"></a>            <span class="c1"># 3) éšæœºè£å‰ª</span>
<a id="__codelineno-3-159" name="__codelineno-3-159"></a>            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-3-160" name="__codelineno-3-160"></a>            <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-161" name="__codelineno-3-161"></a>            <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-162" name="__codelineno-3-162"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">))</span>
<a id="__codelineno-3-163" name="__codelineno-3-163"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">))</span>
<a id="__codelineno-3-164" name="__codelineno-3-164"></a>
<a id="__codelineno-3-165" name="__codelineno-3-165"></a>            <span class="c1"># 4) éšæœºæ°´å¹³ç¿»è½¬</span>
<a id="__codelineno-3-166" name="__codelineno-3-166"></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
<a id="__codelineno-3-167" name="__codelineno-3-167"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">hflip</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-3-168" name="__codelineno-3-168"></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">hflip</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-3-169" name="__codelineno-3-169"></a>
<a id="__codelineno-3-170" name="__codelineno-3-170"></a>            <span class="c1"># 5) é¢œè‰²æŠ–åŠ¨</span>
<a id="__codelineno-3-171" name="__codelineno-3-171"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-172" name="__codelineno-3-172"></a>                <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-3-173" name="__codelineno-3-173"></a>
<a id="__codelineno-3-174" name="__codelineno-3-174"></a>        <span class="c1"># è½¬ Tensor</span>
<a id="__codelineno-3-175" name="__codelineno-3-175"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-3-176" name="__codelineno-3-176"></a>
<a id="__codelineno-3-177" name="__codelineno-3-177"></a>        <span class="c1"># å¯é€‰å™ªå£°ï¼ˆå½’ä¸€åŒ–å‰ï¼‰</span>
<a id="__codelineno-3-178" name="__codelineno-3-178"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_noise_prob</span><span class="p">:</span>
<a id="__codelineno-3-179" name="__codelineno-3-179"></a>            <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_std</span>
<a id="__codelineno-3-180" name="__codelineno-3-180"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">img</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-3-181" name="__codelineno-3-181"></a>
<a id="__codelineno-3-182" name="__codelineno-3-182"></a>        <span class="c1"># æ ‡å‡†åŒ–</span>
<a id="__codelineno-3-183" name="__codelineno-3-183"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)</span>
<a id="__codelineno-3-184" name="__codelineno-3-184"></a>
<a id="__codelineno-3-185" name="__codelineno-3-185"></a>        <span class="c1"># ç›´æ¥æŠŠ palette/L ç´¢å¼•å›¾è½¬æˆç±»åˆ« idï¼ˆ0..20ï¼Œ255 å¿½ç•¥ï¼‰</span>
<a id="__codelineno-3-186" name="__codelineno-3-186"></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-3-187" name="__codelineno-3-187"></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-3-188" name="__codelineno-3-188"></a>
<a id="__codelineno-3-189" name="__codelineno-3-189"></a><span class="c1"># -------------------- æ¨¡å‹ï¼ˆFCN-8sï¼‰ --------------------</span>
<a id="__codelineno-3-190" name="__codelineno-3-190"></a><span class="k">def</span><span class="w"> </span><span class="nf">bilinear_kernel</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">):</span>
<a id="__codelineno-3-191" name="__codelineno-3-191"></a>    <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-3-192" name="__codelineno-3-192"></a>    <span class="n">center</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">kernel_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">factor</span> <span class="o">-</span> <span class="mf">0.5</span>
<a id="__codelineno-3-193" name="__codelineno-3-193"></a>    <span class="n">og</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">kernel_size</span><span class="p">,</span> <span class="p">:</span><span class="n">kernel_size</span><span class="p">]</span>
<a id="__codelineno-3-194" name="__codelineno-3-194"></a>    <span class="n">filt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span>
<a id="__codelineno-3-195" name="__codelineno-3-195"></a>    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-3-196" name="__codelineno-3-196"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)):</span>
<a id="__codelineno-3-197" name="__codelineno-3-197"></a>        <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">filt</span>
<a id="__codelineno-3-198" name="__codelineno-3-198"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-3-199" name="__codelineno-3-199"></a>
<a id="__codelineno-3-200" name="__codelineno-3-200"></a><span class="k">class</span><span class="w"> </span><span class="nc">FCN8s</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-3-201" name="__codelineno-3-201"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-3-202" name="__codelineno-3-202"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">FCN8s</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-3-203" name="__codelineno-3-203"></a>        <span class="n">vgg</span> <span class="o">=</span> <span class="n">vgg16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">VGG16_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span><span class="p">)</span>
<a id="__codelineno-3-204" name="__codelineno-3-204"></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">features</span>
<a id="__codelineno-3-205" name="__codelineno-3-205"></a>
<a id="__codelineno-3-206" name="__codelineno-3-206"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool3_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span>
<a id="__codelineno-3-207" name="__codelineno-3-207"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool4_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span>
<a id="__codelineno-3-208" name="__codelineno-3-208"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool5_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">24</span><span class="p">:]</span>
<a id="__codelineno-3-209" name="__codelineno-3-209"></a>
<a id="__codelineno-3-210" name="__codelineno-3-210"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-3-211" name="__codelineno-3-211"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-212" name="__codelineno-3-212"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drop6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">()</span>
<a id="__codelineno-3-213" name="__codelineno-3-213"></a>
<a id="__codelineno-3-214" name="__codelineno-3-214"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-215" name="__codelineno-3-215"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-216" name="__codelineno-3-216"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drop7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">()</span>
<a id="__codelineno-3-217" name="__codelineno-3-217"></a>
<a id="__codelineno-3-218" name="__codelineno-3-218"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_fr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-219" name="__codelineno-3-219"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_pool3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-220" name="__codelineno-3-220"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_pool4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-221" name="__codelineno-3-221"></a>
<a id="__codelineno-3-222" name="__codelineno-3-222"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-223" name="__codelineno-3-223"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-224" name="__codelineno-3-224"></a>
<a id="__codelineno-3-225" name="__codelineno-3-225"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-3-226" name="__codelineno-3-226"></a>            <span class="n">fc6_w</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a id="__codelineno-3-227" name="__codelineno-3-227"></a>            <span class="n">fc6_b</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span>
<a id="__codelineno-3-228" name="__codelineno-3-228"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc6_w</span><span class="p">)</span>
<a id="__codelineno-3-229" name="__codelineno-3-229"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc6_b</span><span class="p">)</span>
<a id="__codelineno-3-230" name="__codelineno-3-230"></a>
<a id="__codelineno-3-231" name="__codelineno-3-231"></a>            <span class="n">fc7_w</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-232" name="__codelineno-3-232"></a>            <span class="n">fc7_b</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span>
<a id="__codelineno-3-233" name="__codelineno-3-233"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc7_w</span><span class="p">)</span>
<a id="__codelineno-3-234" name="__codelineno-3-234"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc7_b</span><span class="p">)</span>
<a id="__codelineno-3-235" name="__codelineno-3-235"></a>
<a id="__codelineno-3-236" name="__codelineno-3-236"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">bilinear_kernel</span><span class="p">(</span><span class="n">NUM_CLASSES</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-3-237" name="__codelineno-3-237"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">bilinear_kernel</span><span class="p">(</span><span class="n">NUM_CLASSES</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-3-238" name="__codelineno-3-238"></a>
<a id="__codelineno-3-239" name="__codelineno-3-239"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-3-240" name="__codelineno-3-240"></a>        <span class="n">input_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<a id="__codelineno-3-241" name="__codelineno-3-241"></a>        <span class="n">pool3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool3_features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-3-242" name="__codelineno-3-242"></a>        <span class="n">pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool4_features</span><span class="p">(</span><span class="n">pool3</span><span class="p">)</span>
<a id="__codelineno-3-243" name="__codelineno-3-243"></a>        <span class="n">pool5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool5_features</span><span class="p">(</span><span class="n">pool4</span><span class="p">)</span>
<a id="__codelineno-3-244" name="__codelineno-3-244"></a>
<a id="__codelineno-3-245" name="__codelineno-3-245"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu6</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="p">(</span><span class="n">pool5</span><span class="p">))</span>
<a id="__codelineno-3-246" name="__codelineno-3-246"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop6</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-3-247" name="__codelineno-3-247"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu7</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
<a id="__codelineno-3-248" name="__codelineno-3-248"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop7</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-3-249" name="__codelineno-3-249"></a>
<a id="__codelineno-3-250" name="__codelineno-3-250"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_fr</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-3-251" name="__codelineno-3-251"></a>        <span class="n">upscore2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-3-252" name="__codelineno-3-252"></a>
<a id="__codelineno-3-253" name="__codelineno-3-253"></a>        <span class="n">score_pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_pool4</span><span class="p">(</span><span class="n">pool4</span><span class="p">)</span>
<a id="__codelineno-3-254" name="__codelineno-3-254"></a>        <span class="n">upscore2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">upscore2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">score_pool4</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-255" name="__codelineno-3-255"></a>        <span class="n">fuse_pool4</span> <span class="o">=</span> <span class="n">upscore2</span> <span class="o">+</span> <span class="n">score_pool4</span>
<a id="__codelineno-3-256" name="__codelineno-3-256"></a>
<a id="__codelineno-3-257" name="__codelineno-3-257"></a>        <span class="n">upscore_pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span><span class="p">(</span><span class="n">fuse_pool4</span><span class="p">)</span>
<a id="__codelineno-3-258" name="__codelineno-3-258"></a>
<a id="__codelineno-3-259" name="__codelineno-3-259"></a>        <span class="n">score_pool3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_pool3</span><span class="p">(</span><span class="n">pool3</span><span class="p">)</span>
<a id="__codelineno-3-260" name="__codelineno-3-260"></a>        <span class="n">upscore_pool4</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">upscore_pool4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">score_pool3</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-261" name="__codelineno-3-261"></a>        <span class="n">fuse_pool3</span> <span class="o">=</span> <span class="n">upscore_pool4</span> <span class="o">+</span> <span class="n">score_pool3</span>
<a id="__codelineno-3-262" name="__codelineno-3-262"></a>
<a id="__codelineno-3-263" name="__codelineno-3-263"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">fuse_pool3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-264" name="__codelineno-3-264"></a>        <span class="k">return</span> <span class="n">out</span>
<a id="__codelineno-3-265" name="__codelineno-3-265"></a>
<a id="__codelineno-3-266" name="__codelineno-3-266"></a><span class="c1"># -------------------- è¯„ä¼°æŒ‡æ ‡ --------------------</span>
<a id="__codelineno-3-267" name="__codelineno-3-267"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
<a id="__codelineno-3-268" name="__codelineno-3-268"></a>    <span class="n">pixel_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-3-269" name="__codelineno-3-269"></a>    <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
<a id="__codelineno-3-270" name="__codelineno-3-270"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">),</span> <span class="n">denom</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">denom</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-271" name="__codelineno-3-271"></a>    <span class="n">miou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span>
<a id="__codelineno-3-272" name="__codelineno-3-272"></a>    <span class="k">return</span> <span class="n">pixel_accuracy</span><span class="p">,</span> <span class="n">miou</span>
<a id="__codelineno-3-273" name="__codelineno-3-273"></a>
<a id="__codelineno-3-274" name="__codelineno-3-274"></a><span class="c1"># -------------------- è®­ç»ƒ / éªŒè¯ --------------------</span>
<a id="__codelineno-3-275" name="__codelineno-3-275"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_one_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">,</span> <span class="n">grad_clip</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<a id="__codelineno-3-276" name="__codelineno-3-276"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-3-277" name="__codelineno-3-277"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-278" name="__codelineno-3-278"></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Training"</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-279" name="__codelineno-3-279"></a>    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">progress_bar</span><span class="p">:</span>
<a id="__codelineno-3-280" name="__codelineno-3-280"></a>        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-281" name="__codelineno-3-281"></a>        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-282" name="__codelineno-3-282"></a>
<a id="__codelineno-3-283" name="__codelineno-3-283"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-3-284" name="__codelineno-3-284"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-3-285" name="__codelineno-3-285"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-3-286" name="__codelineno-3-286"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-3-287" name="__codelineno-3-287"></a>
<a id="__codelineno-3-288" name="__codelineno-3-288"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-3-289" name="__codelineno-3-289"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">unscale_</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
<a id="__codelineno-3-290" name="__codelineno-3-290"></a>        <span class="k">if</span> <span class="n">grad_clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grad_clip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-291" name="__codelineno-3-291"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">grad_clip</span><span class="p">)</span>
<a id="__codelineno-3-292" name="__codelineno-3-292"></a>
<a id="__codelineno-3-293" name="__codelineno-3-293"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
<a id="__codelineno-3-294" name="__codelineno-3-294"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<a id="__codelineno-3-295" name="__codelineno-3-295"></a>
<a id="__codelineno-3-296" name="__codelineno-3-296"></a>        <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-3-297" name="__codelineno-3-297"></a>
<a id="__codelineno-3-298" name="__codelineno-3-298"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-299" name="__codelineno-3-299"></a>        <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span>
<a id="__codelineno-3-300" name="__codelineno-3-300"></a>            <span class="n">loss</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
<a id="__codelineno-3-301" name="__codelineno-3-301"></a>            <span class="n">lr</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"lr"</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">"lr"</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">'</span>
<a id="__codelineno-3-302" name="__codelineno-3-302"></a>        <span class="p">)</span>
<a id="__codelineno-3-303" name="__codelineno-3-303"></a>    <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
<a id="__codelineno-3-304" name="__codelineno-3-304"></a>
<a id="__codelineno-3-305" name="__codelineno-3-305"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-3-306" name="__codelineno-3-306"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_fast</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
<a id="__codelineno-3-307" name="__codelineno-3-307"></a>                  <span class="n">compute_loss</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_batches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-3-308" name="__codelineno-3-308"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-3-309" name="__codelineno-3-309"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-3-310" name="__codelineno-3-310"></a>    <span class="n">seen_images</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-311" name="__codelineno-3-311"></a>    <span class="n">batches</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-312" name="__codelineno-3-312"></a>
<a id="__codelineno-3-313" name="__codelineno-3-313"></a>    <span class="n">conf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-314" name="__codelineno-3-314"></a>    <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Evaluating"</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="k">else</span> <span class="n">data_loader</span>
<a id="__codelineno-3-315" name="__codelineno-3-315"></a>
<a id="__codelineno-3-316" name="__codelineno-3-316"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
<a id="__codelineno-3-317" name="__codelineno-3-317"></a>        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
<a id="__codelineno-3-318" name="__codelineno-3-318"></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-319" name="__codelineno-3-319"></a>            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-320" name="__codelineno-3-320"></a>
<a id="__codelineno-3-321" name="__codelineno-3-321"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-3-322" name="__codelineno-3-322"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-3-323" name="__codelineno-3-323"></a>                <span class="k">if</span> <span class="n">compute_loss</span><span class="p">:</span>
<a id="__codelineno-3-324" name="__codelineno-3-324"></a>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-3-325" name="__codelineno-3-325"></a>                    <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-326" name="__codelineno-3-326"></a>
<a id="__codelineno-3-327" name="__codelineno-3-327"></a>            <span class="n">preds</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-328" name="__codelineno-3-328"></a>            <span class="n">valid</span> <span class="o">=</span> <span class="n">targets</span> <span class="o">!=</span> <span class="mi">255</span>
<a id="__codelineno-3-329" name="__codelineno-3-329"></a>            <span class="k">if</span> <span class="n">valid</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-3-330" name="__codelineno-3-330"></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">num_classes</span>
<a id="__codelineno-3-331" name="__codelineno-3-331"></a>                <span class="n">t</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-3-332" name="__codelineno-3-332"></a>                <span class="n">p</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-3-333" name="__codelineno-3-333"></a>                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-334" name="__codelineno-3-334"></a>                <span class="n">conf</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a id="__codelineno-3-335" name="__codelineno-3-335"></a>
<a id="__codelineno-3-336" name="__codelineno-3-336"></a>            <span class="n">batches</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-3-337" name="__codelineno-3-337"></a>            <span class="n">seen_images</span> <span class="o">+=</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-338" name="__codelineno-3-338"></a>
<a id="__codelineno-3-339" name="__codelineno-3-339"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">max_batches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">batches</span> <span class="o">&gt;=</span> <span class="n">max_batches</span><span class="p">)</span> <span class="ow">or</span> \
<a id="__codelineno-3-340" name="__codelineno-3-340"></a>               <span class="p">(</span><span class="n">max_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seen_images</span> <span class="o">&gt;=</span> <span class="n">max_images</span><span class="p">):</span>
<a id="__codelineno-3-341" name="__codelineno-3-341"></a>                <span class="k">break</span>
<a id="__codelineno-3-342" name="__codelineno-3-342"></a>
<a id="__codelineno-3-343" name="__codelineno-3-343"></a>    <span class="n">conf_f</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-3-344" name="__codelineno-3-344"></a>    <span class="n">total</span> <span class="o">=</span> <span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-3-345" name="__codelineno-3-345"></a>    <span class="n">pixel_acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-3-346" name="__codelineno-3-346"></a>    <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">))</span>
<a id="__codelineno-3-347" name="__codelineno-3-347"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">denom</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)))</span>
<a id="__codelineno-3-348" name="__codelineno-3-348"></a>    <span class="n">miou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-349" name="__codelineno-3-349"></a>
<a id="__codelineno-3-350" name="__codelineno-3-350"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_loss</span> <span class="o">/</span> <span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">compute_loss</span> <span class="ow">and</span> <span class="n">batches</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
<a id="__codelineno-3-351" name="__codelineno-3-351"></a>    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">pixel_acc</span><span class="p">,</span> <span class="n">miou</span>
<a id="__codelineno-3-352" name="__codelineno-3-352"></a>
<a id="__codelineno-3-353" name="__codelineno-3-353"></a><span class="c1"># -------------------- å¯è§†åŒ– --------------------</span>
<a id="__codelineno-3-354" name="__codelineno-3-354"></a><span class="k">def</span><span class="w"> </span><span class="nf">decode_segmap</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">void_value</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">void_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
<a id="__codelineno-3-355" name="__codelineno-3-355"></a>    <span class="n">lut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-3-356" name="__codelineno-3-356"></a>    <span class="n">lut</span><span class="p">[:</span><span class="n">nc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">VOC_COLORMAP</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-3-357" name="__codelineno-3-357"></a>    <span class="n">lut</span><span class="p">[</span><span class="n">void_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">void_color</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-3-358" name="__codelineno-3-358"></a>    <span class="k">return</span> <span class="n">lut</span><span class="p">[</span><span class="n">image</span><span class="p">]</span>
<a id="__codelineno-3-359" name="__codelineno-3-359"></a>
<a id="__codelineno-3-360" name="__codelineno-3-360"></a><span class="k">def</span><span class="w"> </span><span class="nf">denormalize</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
<a id="__codelineno-3-361" name="__codelineno-3-361"></a>    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">])</span>
<a id="__codelineno-3-362" name="__codelineno-3-362"></a>    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
<a id="__codelineno-3-363" name="__codelineno-3-363"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-364" name="__codelineno-3-364"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">mean</span>
<a id="__codelineno-3-365" name="__codelineno-3-365"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-366" name="__codelineno-3-366"></a>
<a id="__codelineno-3-367" name="__codelineno-3-367"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-3-368" name="__codelineno-3-368"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_predictions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">VIS_DIR</span><span class="p">,</span> <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
<a id="__codelineno-3-369" name="__codelineno-3-369"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-370" name="__codelineno-3-370"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-3-371" name="__codelineno-3-371"></a>    <span class="n">shown</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-372" name="__codelineno-3-372"></a>
<a id="__codelineno-3-373" name="__codelineno-3-373"></a>    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
<a id="__codelineno-3-374" name="__codelineno-3-374"></a>        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-375" name="__codelineno-3-375"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-3-376" name="__codelineno-3-376"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-3-377" name="__codelineno-3-377"></a>
<a id="__codelineno-3-378" name="__codelineno-3-378"></a>        <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-3-379" name="__codelineno-3-379"></a>        <span class="n">images_cpu</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-3-380" name="__codelineno-3-380"></a>        <span class="n">targets_np</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-3-381" name="__codelineno-3-381"></a>
<a id="__codelineno-3-382" name="__codelineno-3-382"></a>        <span class="n">bsz</span> <span class="o">=</span> <span class="n">images_cpu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-3-383" name="__codelineno-3-383"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bsz</span><span class="p">):</span>
<a id="__codelineno-3-384" name="__codelineno-3-384"></a>            <span class="k">if</span> <span class="n">shown</span> <span class="o">&gt;=</span> <span class="n">num_images</span><span class="p">:</span> <span class="k">break</span>
<a id="__codelineno-3-385" name="__codelineno-3-385"></a>
<a id="__codelineno-3-386" name="__codelineno-3-386"></a>            <span class="n">original_img</span> <span class="o">=</span> <span class="n">denormalize</span><span class="p">(</span><span class="n">images_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-3-387" name="__codelineno-3-387"></a>            <span class="n">gt_mask_rgb</span> <span class="o">=</span> <span class="n">decode_segmap</span><span class="p">(</span><span class="n">targets_np</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-3-388" name="__codelineno-3-388"></a>            <span class="n">pred_mask_rgb</span> <span class="o">=</span> <span class="n">decode_segmap</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-3-389" name="__codelineno-3-389"></a>
<a id="__codelineno-3-390" name="__codelineno-3-390"></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-3-391" name="__codelineno-3-391"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original_img</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Original"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-3-392" name="__codelineno-3-392"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gt_mask_rgb</span><span class="p">);</span>  <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Ground Truth"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-3-393" name="__codelineno-3-393"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred_mask_rgb</span><span class="p">);</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Prediction"</span><span class="p">);</span>   <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-3-394" name="__codelineno-3-394"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original_img</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred_mask_rgb</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">overlay_alpha</span><span class="p">)</span>
<a id="__codelineno-3-395" name="__codelineno-3-395"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Overlay"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-3-396" name="__codelineno-3-396"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-3-397" name="__codelineno-3-397"></a>
<a id="__codelineno-3-398" name="__codelineno-3-398"></a>            <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'result_</span><span class="si">{</span><span class="n">shown</span><span class="si">:</span><span class="s1">03d</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
<a id="__codelineno-3-399" name="__codelineno-3-399"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
<a id="__codelineno-3-400" name="__codelineno-3-400"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<a id="__codelineno-3-401" name="__codelineno-3-401"></a>            <span class="n">shown</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-3-402" name="__codelineno-3-402"></a>        <span class="k">if</span> <span class="n">shown</span> <span class="o">&gt;=</span> <span class="n">num_images</span><span class="p">:</span> <span class="k">break</span>
<a id="__codelineno-3-403" name="__codelineno-3-403"></a>
<a id="__codelineno-3-404" name="__codelineno-3-404"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"å¯è§†åŒ–ç»“æœä¿å­˜åœ¨: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">ï¼ˆå…± </span><span class="si">{</span><span class="n">shown</span><span class="si">}</span><span class="s2"> å¼ ï¼‰"</span><span class="p">)</span>
<a id="__codelineno-3-405" name="__codelineno-3-405"></a>
<a id="__codelineno-3-406" name="__codelineno-3-406"></a><span class="c1"># -------------------- å‡†å¤‡æ•°æ®ä¸æ¨¡å‹ --------------------</span>
<a id="__codelineno-3-407" name="__codelineno-3-407"></a><span class="c1"># è®­ç»ƒé›†ï¼šVOC2007 trainval + VOC2012 trainï¼ˆè‹¥ 2007 ä¸å¯ç”¨ï¼Œåˆ™ä»… 2012ï¼‰</span>
<a id="__codelineno-3-408" name="__codelineno-3-408"></a><span class="n">train_sets</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-409" name="__codelineno-3-409"></a>
<a id="__codelineno-3-410" name="__codelineno-3-410"></a><span class="c1"># VOC2007 trainvalï¼ˆè‹¥å­˜åœ¨åˆ†å‰²æ ‡æ³¨ï¼‰</span>
<a id="__codelineno-3-411" name="__codelineno-3-411"></a><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT</span><span class="p">):</span>
<a id="__codelineno-3-412" name="__codelineno-3-412"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-3-413" name="__codelineno-3-413"></a>        <span class="n">train_07</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-3-414" name="__codelineno-3-414"></a>            <span class="n">VOC2007_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'trainval'</span><span class="p">,</span>
<a id="__codelineno-3-415" name="__codelineno-3-415"></a>            <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>
<a id="__codelineno-3-416" name="__codelineno-3-416"></a>            <span class="n">strict</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-3-417" name="__codelineno-3-417"></a>        <span class="p">)</span>
<a id="__codelineno-3-418" name="__codelineno-3-418"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-419" name="__codelineno-3-419"></a>            <span class="n">train_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span>
<a id="__codelineno-3-420" name="__codelineno-3-420"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"VOC2007 trainval å¯ç”¨: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span><span class="si">}</span><span class="s2"> æ ·æœ¬"</span><span class="p">)</span>
<a id="__codelineno-3-421" name="__codelineno-3-421"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-422" name="__codelineno-3-422"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">"VOC2007 trainval æ— å¯ç”¨åˆ†å‰²æ ·æœ¬ï¼Œè·³è¿‡ 2007ã€‚"</span><span class="p">)</span>
<a id="__codelineno-3-423" name="__codelineno-3-423"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-3-424" name="__codelineno-3-424"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"åŠ è½½ VOC2007 å¤±è´¥ï¼Œè·³è¿‡ï¼š</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-425" name="__codelineno-3-425"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-426" name="__codelineno-3-426"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"æœªæ‰¾åˆ° VOC2007 è·¯å¾„ï¼š</span><span class="si">{</span><span class="n">VOC2007_ROOT</span><span class="si">}</span><span class="s2">ï¼ˆå°†ä»…ä½¿ç”¨ VOC2012 è®­ç»ƒï¼‰"</span><span class="p">)</span>
<a id="__codelineno-3-427" name="__codelineno-3-427"></a>
<a id="__codelineno-3-428" name="__codelineno-3-428"></a><span class="c1"># VOC2012 train</span>
<a id="__codelineno-3-429" name="__codelineno-3-429"></a><span class="n">train_12</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-3-430" name="__codelineno-3-430"></a>    <span class="n">VOC2012_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'train'</span><span class="p">,</span>
<a id="__codelineno-3-431" name="__codelineno-3-431"></a>    <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>
<a id="__codelineno-3-432" name="__codelineno-3-432"></a>    <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-3-433" name="__codelineno-3-433"></a><span class="p">)</span>
<a id="__codelineno-3-434" name="__codelineno-3-434"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"VOC2012 train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_12</span><span class="p">)</span><span class="si">}</span><span class="s2"> æ ·æœ¬"</span><span class="p">)</span>
<a id="__codelineno-3-435" name="__codelineno-3-435"></a><span class="n">train_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_12</span><span class="p">)</span>
<a id="__codelineno-3-436" name="__codelineno-3-436"></a>
<a id="__codelineno-3-437" name="__codelineno-3-437"></a><span class="c1"># åˆå¹¶è®­ç»ƒé›†</span>
<a id="__codelineno-3-438" name="__codelineno-3-438"></a><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_sets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-3-439" name="__codelineno-3-439"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-3-440" name="__codelineno-3-440"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-441" name="__codelineno-3-441"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">ConcatDataset</span><span class="p">(</span><span class="n">train_sets</span><span class="p">)</span>
<a id="__codelineno-3-442" name="__codelineno-3-442"></a>
<a id="__codelineno-3-443" name="__codelineno-3-443"></a><span class="c1"># éªŒè¯ï¼šVOC2012 val</span>
<a id="__codelineno-3-444" name="__codelineno-3-444"></a><span class="n">val_dataset_voc</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-3-445" name="__codelineno-3-445"></a>    <span class="n">VOC2012_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'val'</span><span class="p">,</span>
<a id="__codelineno-3-446" name="__codelineno-3-446"></a>    <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>
<a id="__codelineno-3-447" name="__codelineno-3-447"></a>    <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-3-448" name="__codelineno-3-448"></a><span class="p">)</span>
<a id="__codelineno-3-449" name="__codelineno-3-449"></a>
<a id="__codelineno-3-450" name="__codelineno-3-450"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<a id="__codelineno-3-451" name="__codelineno-3-451"></a>    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-3-452" name="__codelineno-3-452"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-3-453" name="__codelineno-3-453"></a><span class="p">)</span>
<a id="__codelineno-3-454" name="__codelineno-3-454"></a><span class="n">val_loader_voc</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<a id="__codelineno-3-455" name="__codelineno-3-455"></a>    <span class="n">val_dataset_voc</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">VAL_BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-3-456" name="__codelineno-3-456"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-3-457" name="__codelineno-3-457"></a><span class="p">)</span>
<a id="__codelineno-3-458" name="__codelineno-3-458"></a>
<a id="__codelineno-3-459" name="__codelineno-3-459"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"è®­ç»ƒé›†æ€»æ ·æœ¬æ•°: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-460" name="__codelineno-3-460"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"éªŒè¯é›†æ ·æœ¬æ•° (VOC2012 val): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset_voc</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-461" name="__codelineno-3-461"></a>
<a id="__codelineno-3-462" name="__codelineno-3-462"></a><span class="n">model</span> <span class="o">=</span> <span class="n">FCN8s</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">NUM_CLASSES</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-3-463" name="__codelineno-3-463"></a><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">ignore_index</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-3-464" name="__codelineno-3-464"></a>
<a id="__codelineno-3-465" name="__codelineno-3-465"></a><span class="c1"># å‚æ•°åˆ†ç»„ + poly å­¦ä¹ ç‡</span>
<a id="__codelineno-3-466" name="__codelineno-3-466"></a><span class="n">base_lr</span> <span class="o">=</span> <span class="n">LEARNING_RATE</span>
<a id="__codelineno-3-467" name="__codelineno-3-467"></a><span class="n">new_lr</span> <span class="o">=</span> <span class="n">LEARNING_RATE</span> <span class="o">*</span> <span class="mi">10</span>
<a id="__codelineno-3-468" name="__codelineno-3-468"></a><span class="n">new_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">score_fr</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">score_pool3</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">score_pool4</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">upscore2</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">upscore_pool4</span><span class="p">]</span>
<a id="__codelineno-3-469" name="__codelineno-3-469"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">([</span>
<a id="__codelineno-3-470" name="__codelineno-3-470"></a>    <span class="p">{</span><span class="s1">'params'</span><span class="p">:</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pool3_features</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<a id="__codelineno-3-471" name="__codelineno-3-471"></a>                        <span class="n">model</span><span class="o">.</span><span class="n">pool4_features</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<a id="__codelineno-3-472" name="__codelineno-3-472"></a>                        <span class="n">model</span><span class="o">.</span><span class="n">pool5_features</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<a id="__codelineno-3-473" name="__codelineno-3-473"></a>                        <span class="n">model</span><span class="o">.</span><span class="n">fc6</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<a id="__codelineno-3-474" name="__codelineno-3-474"></a>                        <span class="n">model</span><span class="o">.</span><span class="n">fc7</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span> <span class="s1">'lr'</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">},</span>
<a id="__codelineno-3-475" name="__codelineno-3-475"></a>    <span class="p">{</span><span class="s1">'params'</span><span class="p">:</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">new_modules</span><span class="p">)),</span> <span class="s1">'lr'</span><span class="p">:</span> <span class="n">new_lr</span><span class="p">},</span>
<a id="__codelineno-3-476" name="__codelineno-3-476"></a><span class="p">],</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">WEIGHT_DECAY</span><span class="p">)</span>
<a id="__codelineno-3-477" name="__codelineno-3-477"></a>
<a id="__codelineno-3-478" name="__codelineno-3-478"></a><span class="n">max_iter</span> <span class="o">=</span> <span class="n">EPOCHS</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<a id="__codelineno-3-479" name="__codelineno-3-479"></a><span class="k">def</span><span class="w"> </span><span class="nf">poly_lr_lambda</span><span class="p">(</span><span class="n">it_idx</span><span class="p">):</span>
<a id="__codelineno-3-480" name="__codelineno-3-480"></a>    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">it_idx</span> <span class="o">/</span> <span class="n">max_iter</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.9</span>
<a id="__codelineno-3-481" name="__codelineno-3-481"></a><span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">LambdaLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_lambda</span><span class="o">=</span><span class="n">poly_lr_lambda</span><span class="p">)</span>
<a id="__codelineno-3-482" name="__codelineno-3-482"></a>
<a id="__codelineno-3-483" name="__codelineno-3-483"></a><span class="c1"># AMP Scalerï¼ˆå›ºå®š cudaï¼‰</span>
<a id="__codelineno-3-484" name="__codelineno-3-484"></a><span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="s1">'cuda'</span><span class="p">)</span>
<a id="__codelineno-3-485" name="__codelineno-3-485"></a>
<a id="__codelineno-3-486" name="__codelineno-3-486"></a><span class="c1"># è®°å½•ä¸ä¿å­˜</span>
<a id="__codelineno-3-487" name="__codelineno-3-487"></a><span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'train_loss'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_loss'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_pa'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_miou'</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-3-488" name="__codelineno-3-488"></a><span class="n">best_miou_voc</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<a id="__codelineno-3-489" name="__codelineno-3-489"></a><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-490" name="__codelineno-3-490"></a>
<a id="__codelineno-3-491" name="__codelineno-3-491"></a><span class="c1"># -------------------- è®­ç»ƒå¾ªç¯ --------------------</span>
<a id="__codelineno-3-492" name="__codelineno-3-492"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"å¼€å§‹è®­ç»ƒ..."</span><span class="p">)</span>
<a id="__codelineno-3-493" name="__codelineno-3-493"></a><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-3-494" name="__codelineno-3-494"></a>
<a id="__codelineno-3-495" name="__codelineno-3-495"></a><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
<a id="__codelineno-3-496" name="__codelineno-3-496"></a>    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_one_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">)</span>
<a id="__codelineno-3-497" name="__codelineno-3-497"></a>
<a id="__codelineno-3-498" name="__codelineno-3-498"></a>    <span class="n">val_loss_voc</span><span class="p">,</span> <span class="n">val_pa_voc</span><span class="p">,</span> <span class="n">val_miou_voc</span> <span class="o">=</span> <span class="n">evaluate_fast</span><span class="p">(</span>
<a id="__codelineno-3-499" name="__codelineno-3-499"></a>        <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">val_loader_voc</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">,</span>
<a id="__codelineno-3-500" name="__codelineno-3-500"></a>        <span class="n">compute_loss</span><span class="o">=</span><span class="n">EVAL_COMPUTE_LOSS</span><span class="p">,</span>
<a id="__codelineno-3-501" name="__codelineno-3-501"></a>        <span class="n">max_batches</span><span class="o">=</span><span class="n">EVAL_MAX_BATCHES</span><span class="p">,</span>
<a id="__codelineno-3-502" name="__codelineno-3-502"></a>        <span class="n">max_images</span><span class="o">=</span><span class="n">EVAL_MAX_IMAGES</span><span class="p">,</span>
<a id="__codelineno-3-503" name="__codelineno-3-503"></a>        <span class="n">progress</span><span class="o">=</span><span class="n">EVAL_PROGRESS</span>
<a id="__codelineno-3-504" name="__codelineno-3-504"></a>    <span class="p">)</span>
<a id="__codelineno-3-505" name="__codelineno-3-505"></a>
<a id="__codelineno-3-506" name="__codelineno-3-506"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'train_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
<a id="__codelineno-3-507" name="__codelineno-3-507"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss_voc</span><span class="p">)</span>
<a id="__codelineno-3-508" name="__codelineno-3-508"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_pa'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_pa_voc</span><span class="p">)</span>
<a id="__codelineno-3-509" name="__codelineno-3-509"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_miou'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_miou_voc</span><span class="p">)</span>
<a id="__codelineno-3-510" name="__codelineno-3-510"></a>
<a id="__codelineno-3-511" name="__codelineno-3-511"></a>    <span class="k">if</span> <span class="n">val_miou_voc</span> <span class="o">&gt;</span> <span class="n">best_miou_voc</span><span class="p">:</span>
<a id="__codelineno-3-512" name="__codelineno-3-512"></a>        <span class="n">best_miou_voc</span> <span class="o">=</span> <span class="n">val_miou_voc</span>
<a id="__codelineno-3-513" name="__codelineno-3-513"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
<a id="__codelineno-3-514" name="__codelineno-3-514"></a>            <span class="s1">'epoch'</span><span class="p">:</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-3-515" name="__codelineno-3-515"></a>            <span class="s1">'model_state'</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<a id="__codelineno-3-516" name="__codelineno-3-516"></a>            <span class="s1">'optimizer_state'</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<a id="__codelineno-3-517" name="__codelineno-3-517"></a>            <span class="s1">'miou_voc'</span><span class="p">:</span> <span class="n">best_miou_voc</span><span class="p">,</span>
<a id="__codelineno-3-518" name="__codelineno-3-518"></a>            <span class="s1">'config'</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-3-519" name="__codelineno-3-519"></a>                <span class="s1">'base_lr'</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">,</span> <span class="s1">'new_lr'</span><span class="p">:</span> <span class="n">new_lr</span><span class="p">,</span> <span class="s1">'weight_decay'</span><span class="p">:</span> <span class="n">WEIGHT_DECAY</span><span class="p">,</span>
<a id="__codelineno-3-520" name="__codelineno-3-520"></a>                <span class="s1">'epochs'</span><span class="p">:</span> <span class="n">EPOCHS</span><span class="p">,</span> <span class="s1">'batch_size'</span><span class="p">:</span> <span class="n">BATCH_SIZE</span>
<a id="__codelineno-3-521" name="__codelineno-3-521"></a>            <span class="p">}</span>
<a id="__codelineno-3-522" name="__codelineno-3-522"></a>        <span class="p">},</span> <span class="n">BEST_PATH_VOC</span><span class="p">)</span>
<a id="__codelineno-3-523" name="__codelineno-3-523"></a>
<a id="__codelineno-3-524" name="__codelineno-3-524"></a>    <span class="n">val_loss_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val_loss_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">EVAL_COMPUTE_LOSS</span> <span class="k">else</span> <span class="s2">"n/a"</span>
<a id="__codelineno-3-525" name="__codelineno-3-525"></a>    <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-3-526" name="__codelineno-3-526"></a>        <span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">EPOCHS</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-3-527" name="__codelineno-3-527"></a>        <span class="sa">f</span><span class="s2">"Train Loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-3-528" name="__codelineno-3-528"></a>        <span class="sa">f</span><span class="s2">"VOC Val: Loss </span><span class="si">{</span><span class="n">val_loss_str</span><span class="si">}</span><span class="s2">, PA </span><span class="si">{</span><span class="n">val_pa_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, mIoU </span><span class="si">{</span><span class="n">val_miou_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-3-529" name="__codelineno-3-529"></a>        <span class="sa">f</span><span class="s2">"Best VOC mIoU: </span><span class="si">{</span><span class="n">best_miou_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-3-530" name="__codelineno-3-530"></a>    <span class="p">)</span>
<a id="__codelineno-3-531" name="__codelineno-3-531"></a>
<a id="__codelineno-3-532" name="__codelineno-3-532"></a><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-3-533" name="__codelineno-3-533"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">è®­ç»ƒå®Œæˆï¼æ€»è€—æ—¶: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> åˆ†é’Ÿ"</span><span class="p">)</span>
<a id="__codelineno-3-534" name="__codelineno-3-534"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- æœ€ç»ˆè¯„ä¼°æŒ‡æ ‡ (VOC2012 val) ---"</span><span class="p">)</span>
<a id="__codelineno-3-535" name="__codelineno-3-535"></a><span class="n">final_loss_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">EVAL_COMPUTE_LOSS</span> <span class="k">else</span> <span class="s2">"n/a"</span>
<a id="__codelineno-3-536" name="__codelineno-3-536"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Val Loss: </span><span class="si">{</span><span class="n">final_loss_str</span><span class="si">}</span><span class="s2"> | PA: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_pa'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | mIoU: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_miou'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-537" name="__codelineno-3-537"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"æœ€ä¼˜æƒé‡å·²ä¿å­˜è‡³: </span><span class="si">{</span><span class="n">BEST_PATH_VOC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-538" name="__codelineno-3-538"></a>
<a id="__codelineno-3-539" name="__codelineno-3-539"></a><span class="c1"># ä¿å­˜å½“å‰ï¼ˆlatestï¼‰</span>
<a id="__codelineno-3-540" name="__codelineno-3-540"></a><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">LATEST_PATH</span><span class="p">)</span>
<a id="__codelineno-3-541" name="__codelineno-3-541"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"å·²ä¿å­˜å½“å‰æ¨¡å‹æƒé‡åˆ°: </span><span class="si">{</span><span class="n">LATEST_PATH</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-542" name="__codelineno-3-542"></a>
<a id="__codelineno-3-543" name="__codelineno-3-543"></a><span class="c1"># åŠ è½½æœ€ä¼˜æƒé‡ç”¨äºå¯è§†åŒ–</span>
<a id="__codelineno-3-544" name="__codelineno-3-544"></a><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">BEST_PATH_VOC</span><span class="p">):</span>
<a id="__codelineno-3-545" name="__codelineno-3-545"></a>    <span class="n">ckpt_voc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">BEST_PATH_VOC</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">))</span>
<a id="__codelineno-3-546" name="__codelineno-3-546"></a>    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">ckpt_voc</span><span class="p">[</span><span class="s1">'model_state'</span><span class="p">])</span>
<a id="__codelineno-3-547" name="__codelineno-3-547"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">å·²åŠ è½½ VOC æœ€ä¼˜æƒé‡è¿›è¡Œå¯è§†åŒ–: </span><span class="si">{</span><span class="n">BEST_PATH_VOC</span><span class="si">}</span><span class="s2"> (epoch=</span><span class="si">{</span><span class="n">ckpt_voc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'epoch'</span><span class="p">,</span><span class="s1">'?'</span><span class="p">)</span><span class="si">}</span><span class="s2">, mIoU_VOC=</span><span class="si">{</span><span class="n">ckpt_voc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'miou_voc'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
<a id="__codelineno-3-548" name="__codelineno-3-548"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-549" name="__codelineno-3-549"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">æœªæ‰¾åˆ° VOC æœ€ä¼˜æƒé‡ï¼Œä½¿ç”¨å½“å‰æ¨¡å‹è¿›è¡Œå¯è§†åŒ–ã€‚"</span><span class="p">)</span>
<a id="__codelineno-3-550" name="__codelineno-3-550"></a>
<a id="__codelineno-3-551" name="__codelineno-3-551"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- å¯è§†åŒ–é¢„æµ‹ç»“æœ (VOC2012 val) ---"</span><span class="p">)</span>
<a id="__codelineno-3-552" name="__codelineno-3-552"></a><span class="n">visualize_predictions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader_voc</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">VIS_DIR</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h4 id="_6">è®­ç»ƒç»“æœ<a class="headerlink" href="#_6" title="Permanent link">Â¶</a></h4>
<p><img alt="alt text" src="../curves.png"/></p>
<p>åœ¨ Pascal VOC 07+12 ä¸Šè®­ç»ƒ 50 ä¸ª Epochï¼Œæ€»ç”¨æ—¶ 7796.3sï¼ŒmIoU è¾¾åˆ° 0.6277ï¼Œåƒç´ å‡†ç¡®ç‡è¾¾åˆ° 0.9065ï¼Œå·²ç»è¶…è¿‡äº†åŸè®ºæ–‡çš„æŒ‡æ ‡ã€‚</p>
<p><img alt="res00" src="../result_000.png"/></p>
<p><img alt="res01" src="../result_001.png"/></p>
<p><img alt="res01" src="../result_004.png"/></p>
<h3 id="u-net">U-Net<a class="headerlink" href="#u-net" title="Permanent link">Â¶</a></h3>
<h4 id="_7">åŸç†<a class="headerlink" href="#_7" title="Permanent link">Â¶</a></h4>
<p>æˆ‘ä»¬å®è·µåˆšåˆšåœ¨ FCN-8s é‡Œé¢æåˆ°çš„æ›´æ”¹ï¼Œä¹Ÿå°±æ˜¯æŠŠç½‘ç»œç»“æ„æ”¹å¯¹ç§°ï¼Œå¹¶ä¸”è·³è·ƒè¿æ¥ç”±ç›¸åŠ å†åœ¨é€šé“ç»´æ‹¼æ¥ï¼Œæœ€ååŠ æ•°æ®å¢å¼ºå³å¯ã€‚</p>
<p>å…¶å®ä» FCN åˆ° U-Netï¼Œæœ‰ç‚¹ç±»ä¼¼äºä» ResNet åˆ° DenseNetã€‚</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">  1</a></span>
<span class="normal"><a href="#__codelineno-4-2">  2</a></span>
<span class="normal"><a href="#__codelineno-4-3">  3</a></span>
<span class="normal"><a href="#__codelineno-4-4">  4</a></span>
<span class="normal"><a href="#__codelineno-4-5">  5</a></span>
<span class="normal"><a href="#__codelineno-4-6">  6</a></span>
<span class="normal"><a href="#__codelineno-4-7">  7</a></span>
<span class="normal"><a href="#__codelineno-4-8">  8</a></span>
<span class="normal"><a href="#__codelineno-4-9">  9</a></span>
<span class="normal"><a href="#__codelineno-4-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-4-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-4-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-4-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-4-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-4-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-4-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-4-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-4-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-4-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-4-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-4-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-4-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-4-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-4-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-4-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-4-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-4-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-4-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-4-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-4-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-4-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-4-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-4-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-4-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-4-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-4-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-4-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-4-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-4-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-4-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-4-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-4-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-4-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-4-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-4-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-4-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-4-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-4-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-4-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-4-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-4-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-4-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-4-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-4-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-4-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-4-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-4-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-4-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-4-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-4-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-4-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-4-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-4-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-4-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-4-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-4-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-4-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-4-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-4-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-4-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-4-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-4-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-4-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-4-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-4-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-4-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-4-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-4-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-4-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-4-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-4-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-4-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-4-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-4-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-4-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-4-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-4-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-4-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-4-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-4-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-4-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-4-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-4-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-4-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-4-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-4-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-4-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-4-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-4-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-4-100">100</a></span>
<span class="normal"><a href="#__codelineno-4-101">101</a></span>
<span class="normal"><a href="#__codelineno-4-102">102</a></span>
<span class="normal"><a href="#__codelineno-4-103">103</a></span>
<span class="normal"><a href="#__codelineno-4-104">104</a></span>
<span class="normal"><a href="#__codelineno-4-105">105</a></span>
<span class="normal"><a href="#__codelineno-4-106">106</a></span>
<span class="normal"><a href="#__codelineno-4-107">107</a></span>
<span class="normal"><a href="#__codelineno-4-108">108</a></span>
<span class="normal"><a href="#__codelineno-4-109">109</a></span>
<span class="normal"><a href="#__codelineno-4-110">110</a></span>
<span class="normal"><a href="#__codelineno-4-111">111</a></span>
<span class="normal"><a href="#__codelineno-4-112">112</a></span>
<span class="normal"><a href="#__codelineno-4-113">113</a></span>
<span class="normal"><a href="#__codelineno-4-114">114</a></span>
<span class="normal"><a href="#__codelineno-4-115">115</a></span>
<span class="normal"><a href="#__codelineno-4-116">116</a></span>
<span class="normal"><a href="#__codelineno-4-117">117</a></span>
<span class="normal"><a href="#__codelineno-4-118">118</a></span>
<span class="normal"><a href="#__codelineno-4-119">119</a></span>
<span class="normal"><a href="#__codelineno-4-120">120</a></span>
<span class="normal"><a href="#__codelineno-4-121">121</a></span>
<span class="normal"><a href="#__codelineno-4-122">122</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1"># åŸºæœ¬çš„åŒå·ç§¯å—ï¼Œè´Ÿè´£æ•´åˆæ‹¼æ¥ä¹‹åçš„é€šé“ç»´ã€‚</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DoubleConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">),</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">),</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>        <span class="p">)</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">UNetVGG16</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>        <span class="c1"># é¢„è®­ç»ƒ VGG16 ç¼–ç å™¨</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a>        <span class="n">vgg</span> <span class="o">=</span> <span class="n">vgg16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">VGG16_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span><span class="p">)</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">features</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a>        <span class="c1"># è¿™é‡Œä¿æŒ 4 æ¬¡ä¸‹é‡‡æ ·ï¼Œæ–¹å¼åœ¨ FCN-8s é‡Œé¢å·²ç»æœ‰ä»‹ç»è¿‡ã€‚</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool1</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool2</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool3</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">23</span><span class="p">]</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool4</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a>        <span class="c1"># è¿™é‡Œä¸å« pool5ï¼Œæˆ‘ä»¬ä¸æƒ³è®©ç½‘ç»œçš„å‚æ•°è¿‡å¤§ï¼Œå› æ­¤åªåˆ° conv5 çš„ç‰¹å¾å›¾å°±å¤Ÿäº†ã€‚</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a>        <span class="c1"># åŒæ—¶ä¸€ä¸ªå…¸å‹çš„ U-Net æœ‰ 4 ä¸ªè·³è·ƒè¿æ¥å°±è¶³çŸ£ã€‚</span>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a>        <span class="c1"># ä½†æ˜¯ç›¸æ¯”äºä¹‹å‰çš„ FCN-8sï¼Œå®é™…ä¸Šå‚æ•°é‡å°äº†å¾ˆå¤šã€‚</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a>        <span class="c1"># å› ä¸º FCN-8s åŸºæœ¬ä¸Šç”¨åˆ°äº† VGG çš„æ‰€æœ‰é¢„è®­ç»ƒæƒé‡ã€‚</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a>        <span class="c1"># æ‰€ä»¥æœ€åæ•ˆæœæ˜¯ä»¥æ¯” FCN-8s å°‘äº†äº”åˆ†ä¹‹å››çš„å‚æ•°ï¼Œæ¢å–äº† 9% çš„ mIoU é™å¹…ã€‚</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a>        <span class="c1"># ä¸Šé‡‡æ ·ï¼šåœ¨ U-Net é‡Œé¢åŸºæœ¬ä¸Šå·²ç»èˆå¼ƒäº†è½¬ç½®å·ç§¯ï¼Œè€Œæ˜¯ç›´æ¥ä¸Šé‡‡æ ·å†åšå·ç§¯ã€‚</span>
<a id="__codelineno-4-43" name="__codelineno-4-43"></a>        <span class="c1"># å…¶å®æ•ˆæœå’Œè½¬ç½®å·ç§¯è¿˜å·®ä¸å¤šï¼Œä½†çœå‚æ•°å’Œè®¡ç®—é‡ã€‚</span>
<a id="__codelineno-4-44" name="__codelineno-4-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-45" name="__codelineno-4-45"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-46" name="__codelineno-4-46"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-47" name="__codelineno-4-47"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<a id="__codelineno-4-48" name="__codelineno-4-48"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-49" name="__codelineno-4-49"></a>        <span class="p">)</span>
<a id="__codelineno-4-50" name="__codelineno-4-50"></a>        <span class="c1"># è§£ç å™¨å°±æ˜¯è·³è·ƒè¿æ¥ä¹‹ååšåŒå·ç§¯ã€‚</span>
<a id="__codelineno-4-51" name="__codelineno-4-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec4</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">512</span> <span class="o">+</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<a id="__codelineno-4-52" name="__codelineno-4-52"></a>
<a id="__codelineno-4-53" name="__codelineno-4-53"></a>        <span class="c1"># åé¢è¿™äº›ä¸Šé‡‡æ ·+è§£ç å°±ä¾è‘«èŠ¦ç”»ç“¢äº†ï¼Œåªéœ€è¦æ›´æ”¹é€šé“æ•°è€Œå·²ã€‚</span>
<a id="__codelineno-4-54" name="__codelineno-4-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-55" name="__codelineno-4-55"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-56" name="__codelineno-4-56"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-57" name="__codelineno-4-57"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<a id="__codelineno-4-58" name="__codelineno-4-58"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-59" name="__codelineno-4-59"></a>        <span class="p">)</span>
<a id="__codelineno-4-60" name="__codelineno-4-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec3</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">256</span> <span class="o">+</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<a id="__codelineno-4-61" name="__codelineno-4-61"></a>
<a id="__codelineno-4-62" name="__codelineno-4-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-63" name="__codelineno-4-63"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-64" name="__codelineno-4-64"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-65" name="__codelineno-4-65"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<a id="__codelineno-4-66" name="__codelineno-4-66"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-67" name="__codelineno-4-67"></a>        <span class="p">)</span>
<a id="__codelineno-4-68" name="__codelineno-4-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">128</span> <span class="o">+</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<a id="__codelineno-4-69" name="__codelineno-4-69"></a>
<a id="__codelineno-4-70" name="__codelineno-4-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-71" name="__codelineno-4-71"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-72" name="__codelineno-4-72"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-73" name="__codelineno-4-73"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
<a id="__codelineno-4-74" name="__codelineno-4-74"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-75" name="__codelineno-4-75"></a>        <span class="p">)</span>
<a id="__codelineno-4-76" name="__codelineno-4-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">64</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<a id="__codelineno-4-77" name="__codelineno-4-77"></a>
<a id="__codelineno-4-78" name="__codelineno-4-78"></a>        <span class="c1"># è¾“å‡ºå±‚</span>
<a id="__codelineno-4-79" name="__codelineno-4-79"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-4-80" name="__codelineno-4-80"></a>
<a id="__codelineno-4-81" name="__codelineno-4-81"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-4-82" name="__codelineno-4-82"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_align</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
<a id="__codelineno-4-83" name="__codelineno-4-83"></a>        <span class="c1"># å¯¹é½å°ºå¯¸ï¼Œé¿å…å¥‡å¶æ•°å¯¼è‡´çš„ 1px è¯¯å·®</span>
<a id="__codelineno-4-84" name="__codelineno-4-84"></a>        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
<a id="__codelineno-4-85" name="__codelineno-4-85"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-4-86" name="__codelineno-4-86"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-4-87" name="__codelineno-4-87"></a>
<a id="__codelineno-4-88" name="__codelineno-4-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-4-89" name="__codelineno-4-89"></a>        <span class="c1"># ç¼–ç å™¨ï¼ŒC è¡¨ç¤ºé€šé“æ•°ï¼Œåé¢çš„åˆ†æ•°ä»£è¡¨ç‰¹å¾å›¾ç›¸å¯¹åŸå›¾çš„å°ºå¯¸ä¹‹æ¯”ã€‚</span>
<a id="__codelineno-4-90" name="__codelineno-4-90"></a>        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>           <span class="c1"># C=64,   1/1</span>
<a id="__codelineno-4-91" name="__codelineno-4-91"></a>        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool1</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>          <span class="c1">#         1/2</span>
<a id="__codelineno-4-92" name="__codelineno-4-92"></a>
<a id="__codelineno-4-93" name="__codelineno-4-93"></a>        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>          <span class="c1"># C=128,  1/2</span>
<a id="__codelineno-4-94" name="__codelineno-4-94"></a>        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool2</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>          <span class="c1">#         1/4</span>
<a id="__codelineno-4-95" name="__codelineno-4-95"></a>
<a id="__codelineno-4-96" name="__codelineno-4-96"></a>        <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>          <span class="c1"># C=256,  1/4</span>
<a id="__codelineno-4-97" name="__codelineno-4-97"></a>        <span class="n">p3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool3</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>          <span class="c1">#         1/8</span>
<a id="__codelineno-4-98" name="__codelineno-4-98"></a>
<a id="__codelineno-4-99" name="__codelineno-4-99"></a>        <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span>          <span class="c1"># C=512,  1/8</span>
<a id="__codelineno-4-100" name="__codelineno-4-100"></a>        <span class="n">p4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool4</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span>          <span class="c1">#        1/16</span>
<a id="__codelineno-4-101" name="__codelineno-4-101"></a>
<a id="__codelineno-4-102" name="__codelineno-4-102"></a>        <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span><span class="p">(</span><span class="n">p4</span><span class="p">)</span>          <span class="c1"># C=512, 1/16 (bottleneck)</span>
<a id="__codelineno-4-103" name="__codelineno-4-103"></a>
<a id="__codelineno-4-104" name="__codelineno-4-104"></a>        <span class="c1"># è§£ç å™¨</span>
<a id="__codelineno-4-105" name="__codelineno-4-105"></a>        <span class="n">u4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up4</span><span class="p">(</span><span class="n">x5</span><span class="p">)</span>            <span class="c1"># -&gt; 1/8</span>
<a id="__codelineno-4-106" name="__codelineno-4-106"></a>        <span class="n">u4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u4</span><span class="p">,</span> <span class="n">x4</span><span class="p">)</span>
<a id="__codelineno-4-107" name="__codelineno-4-107"></a>        <span class="n">d4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec4</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u4</span><span class="p">,</span> <span class="n">x4</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=512</span>
<a id="__codelineno-4-108" name="__codelineno-4-108"></a>
<a id="__codelineno-4-109" name="__codelineno-4-109"></a>        <span class="n">u3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up3</span><span class="p">(</span><span class="n">d4</span><span class="p">)</span>            <span class="c1"># -&gt; 1/4</span>
<a id="__codelineno-4-110" name="__codelineno-4-110"></a>        <span class="n">u3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u3</span><span class="p">,</span> <span class="n">x3</span><span class="p">)</span>
<a id="__codelineno-4-111" name="__codelineno-4-111"></a>        <span class="n">d3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec3</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u3</span><span class="p">,</span> <span class="n">x3</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=256</span>
<a id="__codelineno-4-112" name="__codelineno-4-112"></a>
<a id="__codelineno-4-113" name="__codelineno-4-113"></a>        <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up2</span><span class="p">(</span><span class="n">d3</span><span class="p">)</span>            <span class="c1"># -&gt; 1/2</span>
<a id="__codelineno-4-114" name="__codelineno-4-114"></a>        <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<a id="__codelineno-4-115" name="__codelineno-4-115"></a>        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u2</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=128</span>
<a id="__codelineno-4-116" name="__codelineno-4-116"></a>
<a id="__codelineno-4-117" name="__codelineno-4-117"></a>        <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up1</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>            <span class="c1"># -&gt; 1/1</span>
<a id="__codelineno-4-118" name="__codelineno-4-118"></a>        <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
<a id="__codelineno-4-119" name="__codelineno-4-119"></a>        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">x1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=64</span>
<a id="__codelineno-4-120" name="__codelineno-4-120"></a>
<a id="__codelineno-4-121" name="__codelineno-4-121"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_conv</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>      <span class="c1"># -&gt; num_classes@HxW</span>
<a id="__codelineno-4-122" name="__codelineno-4-122"></a>        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
<h4 id="_8">è®­ç»ƒä»£ç <a class="headerlink" href="#_8" title="Permanent link">Â¶</a></h4>
<details>
<summary> U-Net çš„è®­ç»ƒä»£ç  </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">  1</a></span>
<span class="normal"><a href="#__codelineno-5-2">  2</a></span>
<span class="normal"><a href="#__codelineno-5-3">  3</a></span>
<span class="normal"><a href="#__codelineno-5-4">  4</a></span>
<span class="normal"><a href="#__codelineno-5-5">  5</a></span>
<span class="normal"><a href="#__codelineno-5-6">  6</a></span>
<span class="normal"><a href="#__codelineno-5-7">  7</a></span>
<span class="normal"><a href="#__codelineno-5-8">  8</a></span>
<span class="normal"><a href="#__codelineno-5-9">  9</a></span>
<span class="normal"><a href="#__codelineno-5-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-5-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-5-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-5-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-5-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-5-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-5-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-5-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-5-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-5-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-5-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-5-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-5-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-5-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-5-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-5-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-5-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-5-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-5-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-5-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-5-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-5-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-5-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-5-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-5-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-5-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-5-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-5-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-5-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-5-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-5-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-5-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-5-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-5-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-5-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-5-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-5-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-5-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-5-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-5-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-5-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-5-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-5-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-5-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-5-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-5-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-5-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-5-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-5-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-5-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-5-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-5-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-5-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-5-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-5-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-5-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-5-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-5-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-5-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-5-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-5-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-5-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-5-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-5-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-5-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-5-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-5-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-5-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-5-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-5-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-5-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-5-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-5-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-5-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-5-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-5-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-5-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-5-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-5-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-5-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-5-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-5-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-5-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-5-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-5-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-5-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-5-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-5-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-5-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-5-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-5-100">100</a></span>
<span class="normal"><a href="#__codelineno-5-101">101</a></span>
<span class="normal"><a href="#__codelineno-5-102">102</a></span>
<span class="normal"><a href="#__codelineno-5-103">103</a></span>
<span class="normal"><a href="#__codelineno-5-104">104</a></span>
<span class="normal"><a href="#__codelineno-5-105">105</a></span>
<span class="normal"><a href="#__codelineno-5-106">106</a></span>
<span class="normal"><a href="#__codelineno-5-107">107</a></span>
<span class="normal"><a href="#__codelineno-5-108">108</a></span>
<span class="normal"><a href="#__codelineno-5-109">109</a></span>
<span class="normal"><a href="#__codelineno-5-110">110</a></span>
<span class="normal"><a href="#__codelineno-5-111">111</a></span>
<span class="normal"><a href="#__codelineno-5-112">112</a></span>
<span class="normal"><a href="#__codelineno-5-113">113</a></span>
<span class="normal"><a href="#__codelineno-5-114">114</a></span>
<span class="normal"><a href="#__codelineno-5-115">115</a></span>
<span class="normal"><a href="#__codelineno-5-116">116</a></span>
<span class="normal"><a href="#__codelineno-5-117">117</a></span>
<span class="normal"><a href="#__codelineno-5-118">118</a></span>
<span class="normal"><a href="#__codelineno-5-119">119</a></span>
<span class="normal"><a href="#__codelineno-5-120">120</a></span>
<span class="normal"><a href="#__codelineno-5-121">121</a></span>
<span class="normal"><a href="#__codelineno-5-122">122</a></span>
<span class="normal"><a href="#__codelineno-5-123">123</a></span>
<span class="normal"><a href="#__codelineno-5-124">124</a></span>
<span class="normal"><a href="#__codelineno-5-125">125</a></span>
<span class="normal"><a href="#__codelineno-5-126">126</a></span>
<span class="normal"><a href="#__codelineno-5-127">127</a></span>
<span class="normal"><a href="#__codelineno-5-128">128</a></span>
<span class="normal"><a href="#__codelineno-5-129">129</a></span>
<span class="normal"><a href="#__codelineno-5-130">130</a></span>
<span class="normal"><a href="#__codelineno-5-131">131</a></span>
<span class="normal"><a href="#__codelineno-5-132">132</a></span>
<span class="normal"><a href="#__codelineno-5-133">133</a></span>
<span class="normal"><a href="#__codelineno-5-134">134</a></span>
<span class="normal"><a href="#__codelineno-5-135">135</a></span>
<span class="normal"><a href="#__codelineno-5-136">136</a></span>
<span class="normal"><a href="#__codelineno-5-137">137</a></span>
<span class="normal"><a href="#__codelineno-5-138">138</a></span>
<span class="normal"><a href="#__codelineno-5-139">139</a></span>
<span class="normal"><a href="#__codelineno-5-140">140</a></span>
<span class="normal"><a href="#__codelineno-5-141">141</a></span>
<span class="normal"><a href="#__codelineno-5-142">142</a></span>
<span class="normal"><a href="#__codelineno-5-143">143</a></span>
<span class="normal"><a href="#__codelineno-5-144">144</a></span>
<span class="normal"><a href="#__codelineno-5-145">145</a></span>
<span class="normal"><a href="#__codelineno-5-146">146</a></span>
<span class="normal"><a href="#__codelineno-5-147">147</a></span>
<span class="normal"><a href="#__codelineno-5-148">148</a></span>
<span class="normal"><a href="#__codelineno-5-149">149</a></span>
<span class="normal"><a href="#__codelineno-5-150">150</a></span>
<span class="normal"><a href="#__codelineno-5-151">151</a></span>
<span class="normal"><a href="#__codelineno-5-152">152</a></span>
<span class="normal"><a href="#__codelineno-5-153">153</a></span>
<span class="normal"><a href="#__codelineno-5-154">154</a></span>
<span class="normal"><a href="#__codelineno-5-155">155</a></span>
<span class="normal"><a href="#__codelineno-5-156">156</a></span>
<span class="normal"><a href="#__codelineno-5-157">157</a></span>
<span class="normal"><a href="#__codelineno-5-158">158</a></span>
<span class="normal"><a href="#__codelineno-5-159">159</a></span>
<span class="normal"><a href="#__codelineno-5-160">160</a></span>
<span class="normal"><a href="#__codelineno-5-161">161</a></span>
<span class="normal"><a href="#__codelineno-5-162">162</a></span>
<span class="normal"><a href="#__codelineno-5-163">163</a></span>
<span class="normal"><a href="#__codelineno-5-164">164</a></span>
<span class="normal"><a href="#__codelineno-5-165">165</a></span>
<span class="normal"><a href="#__codelineno-5-166">166</a></span>
<span class="normal"><a href="#__codelineno-5-167">167</a></span>
<span class="normal"><a href="#__codelineno-5-168">168</a></span>
<span class="normal"><a href="#__codelineno-5-169">169</a></span>
<span class="normal"><a href="#__codelineno-5-170">170</a></span>
<span class="normal"><a href="#__codelineno-5-171">171</a></span>
<span class="normal"><a href="#__codelineno-5-172">172</a></span>
<span class="normal"><a href="#__codelineno-5-173">173</a></span>
<span class="normal"><a href="#__codelineno-5-174">174</a></span>
<span class="normal"><a href="#__codelineno-5-175">175</a></span>
<span class="normal"><a href="#__codelineno-5-176">176</a></span>
<span class="normal"><a href="#__codelineno-5-177">177</a></span>
<span class="normal"><a href="#__codelineno-5-178">178</a></span>
<span class="normal"><a href="#__codelineno-5-179">179</a></span>
<span class="normal"><a href="#__codelineno-5-180">180</a></span>
<span class="normal"><a href="#__codelineno-5-181">181</a></span>
<span class="normal"><a href="#__codelineno-5-182">182</a></span>
<span class="normal"><a href="#__codelineno-5-183">183</a></span>
<span class="normal"><a href="#__codelineno-5-184">184</a></span>
<span class="normal"><a href="#__codelineno-5-185">185</a></span>
<span class="normal"><a href="#__codelineno-5-186">186</a></span>
<span class="normal"><a href="#__codelineno-5-187">187</a></span>
<span class="normal"><a href="#__codelineno-5-188">188</a></span>
<span class="normal"><a href="#__codelineno-5-189">189</a></span>
<span class="normal"><a href="#__codelineno-5-190">190</a></span>
<span class="normal"><a href="#__codelineno-5-191">191</a></span>
<span class="normal"><a href="#__codelineno-5-192">192</a></span>
<span class="normal"><a href="#__codelineno-5-193">193</a></span>
<span class="normal"><a href="#__codelineno-5-194">194</a></span>
<span class="normal"><a href="#__codelineno-5-195">195</a></span>
<span class="normal"><a href="#__codelineno-5-196">196</a></span>
<span class="normal"><a href="#__codelineno-5-197">197</a></span>
<span class="normal"><a href="#__codelineno-5-198">198</a></span>
<span class="normal"><a href="#__codelineno-5-199">199</a></span>
<span class="normal"><a href="#__codelineno-5-200">200</a></span>
<span class="normal"><a href="#__codelineno-5-201">201</a></span>
<span class="normal"><a href="#__codelineno-5-202">202</a></span>
<span class="normal"><a href="#__codelineno-5-203">203</a></span>
<span class="normal"><a href="#__codelineno-5-204">204</a></span>
<span class="normal"><a href="#__codelineno-5-205">205</a></span>
<span class="normal"><a href="#__codelineno-5-206">206</a></span>
<span class="normal"><a href="#__codelineno-5-207">207</a></span>
<span class="normal"><a href="#__codelineno-5-208">208</a></span>
<span class="normal"><a href="#__codelineno-5-209">209</a></span>
<span class="normal"><a href="#__codelineno-5-210">210</a></span>
<span class="normal"><a href="#__codelineno-5-211">211</a></span>
<span class="normal"><a href="#__codelineno-5-212">212</a></span>
<span class="normal"><a href="#__codelineno-5-213">213</a></span>
<span class="normal"><a href="#__codelineno-5-214">214</a></span>
<span class="normal"><a href="#__codelineno-5-215">215</a></span>
<span class="normal"><a href="#__codelineno-5-216">216</a></span>
<span class="normal"><a href="#__codelineno-5-217">217</a></span>
<span class="normal"><a href="#__codelineno-5-218">218</a></span>
<span class="normal"><a href="#__codelineno-5-219">219</a></span>
<span class="normal"><a href="#__codelineno-5-220">220</a></span>
<span class="normal"><a href="#__codelineno-5-221">221</a></span>
<span class="normal"><a href="#__codelineno-5-222">222</a></span>
<span class="normal"><a href="#__codelineno-5-223">223</a></span>
<span class="normal"><a href="#__codelineno-5-224">224</a></span>
<span class="normal"><a href="#__codelineno-5-225">225</a></span>
<span class="normal"><a href="#__codelineno-5-226">226</a></span>
<span class="normal"><a href="#__codelineno-5-227">227</a></span>
<span class="normal"><a href="#__codelineno-5-228">228</a></span>
<span class="normal"><a href="#__codelineno-5-229">229</a></span>
<span class="normal"><a href="#__codelineno-5-230">230</a></span>
<span class="normal"><a href="#__codelineno-5-231">231</a></span>
<span class="normal"><a href="#__codelineno-5-232">232</a></span>
<span class="normal"><a href="#__codelineno-5-233">233</a></span>
<span class="normal"><a href="#__codelineno-5-234">234</a></span>
<span class="normal"><a href="#__codelineno-5-235">235</a></span>
<span class="normal"><a href="#__codelineno-5-236">236</a></span>
<span class="normal"><a href="#__codelineno-5-237">237</a></span>
<span class="normal"><a href="#__codelineno-5-238">238</a></span>
<span class="normal"><a href="#__codelineno-5-239">239</a></span>
<span class="normal"><a href="#__codelineno-5-240">240</a></span>
<span class="normal"><a href="#__codelineno-5-241">241</a></span>
<span class="normal"><a href="#__codelineno-5-242">242</a></span>
<span class="normal"><a href="#__codelineno-5-243">243</a></span>
<span class="normal"><a href="#__codelineno-5-244">244</a></span>
<span class="normal"><a href="#__codelineno-5-245">245</a></span>
<span class="normal"><a href="#__codelineno-5-246">246</a></span>
<span class="normal"><a href="#__codelineno-5-247">247</a></span>
<span class="normal"><a href="#__codelineno-5-248">248</a></span>
<span class="normal"><a href="#__codelineno-5-249">249</a></span>
<span class="normal"><a href="#__codelineno-5-250">250</a></span>
<span class="normal"><a href="#__codelineno-5-251">251</a></span>
<span class="normal"><a href="#__codelineno-5-252">252</a></span>
<span class="normal"><a href="#__codelineno-5-253">253</a></span>
<span class="normal"><a href="#__codelineno-5-254">254</a></span>
<span class="normal"><a href="#__codelineno-5-255">255</a></span>
<span class="normal"><a href="#__codelineno-5-256">256</a></span>
<span class="normal"><a href="#__codelineno-5-257">257</a></span>
<span class="normal"><a href="#__codelineno-5-258">258</a></span>
<span class="normal"><a href="#__codelineno-5-259">259</a></span>
<span class="normal"><a href="#__codelineno-5-260">260</a></span>
<span class="normal"><a href="#__codelineno-5-261">261</a></span>
<span class="normal"><a href="#__codelineno-5-262">262</a></span>
<span class="normal"><a href="#__codelineno-5-263">263</a></span>
<span class="normal"><a href="#__codelineno-5-264">264</a></span>
<span class="normal"><a href="#__codelineno-5-265">265</a></span>
<span class="normal"><a href="#__codelineno-5-266">266</a></span>
<span class="normal"><a href="#__codelineno-5-267">267</a></span>
<span class="normal"><a href="#__codelineno-5-268">268</a></span>
<span class="normal"><a href="#__codelineno-5-269">269</a></span>
<span class="normal"><a href="#__codelineno-5-270">270</a></span>
<span class="normal"><a href="#__codelineno-5-271">271</a></span>
<span class="normal"><a href="#__codelineno-5-272">272</a></span>
<span class="normal"><a href="#__codelineno-5-273">273</a></span>
<span class="normal"><a href="#__codelineno-5-274">274</a></span>
<span class="normal"><a href="#__codelineno-5-275">275</a></span>
<span class="normal"><a href="#__codelineno-5-276">276</a></span>
<span class="normal"><a href="#__codelineno-5-277">277</a></span>
<span class="normal"><a href="#__codelineno-5-278">278</a></span>
<span class="normal"><a href="#__codelineno-5-279">279</a></span>
<span class="normal"><a href="#__codelineno-5-280">280</a></span>
<span class="normal"><a href="#__codelineno-5-281">281</a></span>
<span class="normal"><a href="#__codelineno-5-282">282</a></span>
<span class="normal"><a href="#__codelineno-5-283">283</a></span>
<span class="normal"><a href="#__codelineno-5-284">284</a></span>
<span class="normal"><a href="#__codelineno-5-285">285</a></span>
<span class="normal"><a href="#__codelineno-5-286">286</a></span>
<span class="normal"><a href="#__codelineno-5-287">287</a></span>
<span class="normal"><a href="#__codelineno-5-288">288</a></span>
<span class="normal"><a href="#__codelineno-5-289">289</a></span>
<span class="normal"><a href="#__codelineno-5-290">290</a></span>
<span class="normal"><a href="#__codelineno-5-291">291</a></span>
<span class="normal"><a href="#__codelineno-5-292">292</a></span>
<span class="normal"><a href="#__codelineno-5-293">293</a></span>
<span class="normal"><a href="#__codelineno-5-294">294</a></span>
<span class="normal"><a href="#__codelineno-5-295">295</a></span>
<span class="normal"><a href="#__codelineno-5-296">296</a></span>
<span class="normal"><a href="#__codelineno-5-297">297</a></span>
<span class="normal"><a href="#__codelineno-5-298">298</a></span>
<span class="normal"><a href="#__codelineno-5-299">299</a></span>
<span class="normal"><a href="#__codelineno-5-300">300</a></span>
<span class="normal"><a href="#__codelineno-5-301">301</a></span>
<span class="normal"><a href="#__codelineno-5-302">302</a></span>
<span class="normal"><a href="#__codelineno-5-303">303</a></span>
<span class="normal"><a href="#__codelineno-5-304">304</a></span>
<span class="normal"><a href="#__codelineno-5-305">305</a></span>
<span class="normal"><a href="#__codelineno-5-306">306</a></span>
<span class="normal"><a href="#__codelineno-5-307">307</a></span>
<span class="normal"><a href="#__codelineno-5-308">308</a></span>
<span class="normal"><a href="#__codelineno-5-309">309</a></span>
<span class="normal"><a href="#__codelineno-5-310">310</a></span>
<span class="normal"><a href="#__codelineno-5-311">311</a></span>
<span class="normal"><a href="#__codelineno-5-312">312</a></span>
<span class="normal"><a href="#__codelineno-5-313">313</a></span>
<span class="normal"><a href="#__codelineno-5-314">314</a></span>
<span class="normal"><a href="#__codelineno-5-315">315</a></span>
<span class="normal"><a href="#__codelineno-5-316">316</a></span>
<span class="normal"><a href="#__codelineno-5-317">317</a></span>
<span class="normal"><a href="#__codelineno-5-318">318</a></span>
<span class="normal"><a href="#__codelineno-5-319">319</a></span>
<span class="normal"><a href="#__codelineno-5-320">320</a></span>
<span class="normal"><a href="#__codelineno-5-321">321</a></span>
<span class="normal"><a href="#__codelineno-5-322">322</a></span>
<span class="normal"><a href="#__codelineno-5-323">323</a></span>
<span class="normal"><a href="#__codelineno-5-324">324</a></span>
<span class="normal"><a href="#__codelineno-5-325">325</a></span>
<span class="normal"><a href="#__codelineno-5-326">326</a></span>
<span class="normal"><a href="#__codelineno-5-327">327</a></span>
<span class="normal"><a href="#__codelineno-5-328">328</a></span>
<span class="normal"><a href="#__codelineno-5-329">329</a></span>
<span class="normal"><a href="#__codelineno-5-330">330</a></span>
<span class="normal"><a href="#__codelineno-5-331">331</a></span>
<span class="normal"><a href="#__codelineno-5-332">332</a></span>
<span class="normal"><a href="#__codelineno-5-333">333</a></span>
<span class="normal"><a href="#__codelineno-5-334">334</a></span>
<span class="normal"><a href="#__codelineno-5-335">335</a></span>
<span class="normal"><a href="#__codelineno-5-336">336</a></span>
<span class="normal"><a href="#__codelineno-5-337">337</a></span>
<span class="normal"><a href="#__codelineno-5-338">338</a></span>
<span class="normal"><a href="#__codelineno-5-339">339</a></span>
<span class="normal"><a href="#__codelineno-5-340">340</a></span>
<span class="normal"><a href="#__codelineno-5-341">341</a></span>
<span class="normal"><a href="#__codelineno-5-342">342</a></span>
<span class="normal"><a href="#__codelineno-5-343">343</a></span>
<span class="normal"><a href="#__codelineno-5-344">344</a></span>
<span class="normal"><a href="#__codelineno-5-345">345</a></span>
<span class="normal"><a href="#__codelineno-5-346">346</a></span>
<span class="normal"><a href="#__codelineno-5-347">347</a></span>
<span class="normal"><a href="#__codelineno-5-348">348</a></span>
<span class="normal"><a href="#__codelineno-5-349">349</a></span>
<span class="normal"><a href="#__codelineno-5-350">350</a></span>
<span class="normal"><a href="#__codelineno-5-351">351</a></span>
<span class="normal"><a href="#__codelineno-5-352">352</a></span>
<span class="normal"><a href="#__codelineno-5-353">353</a></span>
<span class="normal"><a href="#__codelineno-5-354">354</a></span>
<span class="normal"><a href="#__codelineno-5-355">355</a></span>
<span class="normal"><a href="#__codelineno-5-356">356</a></span>
<span class="normal"><a href="#__codelineno-5-357">357</a></span>
<span class="normal"><a href="#__codelineno-5-358">358</a></span>
<span class="normal"><a href="#__codelineno-5-359">359</a></span>
<span class="normal"><a href="#__codelineno-5-360">360</a></span>
<span class="normal"><a href="#__codelineno-5-361">361</a></span>
<span class="normal"><a href="#__codelineno-5-362">362</a></span>
<span class="normal"><a href="#__codelineno-5-363">363</a></span>
<span class="normal"><a href="#__codelineno-5-364">364</a></span>
<span class="normal"><a href="#__codelineno-5-365">365</a></span>
<span class="normal"><a href="#__codelineno-5-366">366</a></span>
<span class="normal"><a href="#__codelineno-5-367">367</a></span>
<span class="normal"><a href="#__codelineno-5-368">368</a></span>
<span class="normal"><a href="#__codelineno-5-369">369</a></span>
<span class="normal"><a href="#__codelineno-5-370">370</a></span>
<span class="normal"><a href="#__codelineno-5-371">371</a></span>
<span class="normal"><a href="#__codelineno-5-372">372</a></span>
<span class="normal"><a href="#__codelineno-5-373">373</a></span>
<span class="normal"><a href="#__codelineno-5-374">374</a></span>
<span class="normal"><a href="#__codelineno-5-375">375</a></span>
<span class="normal"><a href="#__codelineno-5-376">376</a></span>
<span class="normal"><a href="#__codelineno-5-377">377</a></span>
<span class="normal"><a href="#__codelineno-5-378">378</a></span>
<span class="normal"><a href="#__codelineno-5-379">379</a></span>
<span class="normal"><a href="#__codelineno-5-380">380</a></span>
<span class="normal"><a href="#__codelineno-5-381">381</a></span>
<span class="normal"><a href="#__codelineno-5-382">382</a></span>
<span class="normal"><a href="#__codelineno-5-383">383</a></span>
<span class="normal"><a href="#__codelineno-5-384">384</a></span>
<span class="normal"><a href="#__codelineno-5-385">385</a></span>
<span class="normal"><a href="#__codelineno-5-386">386</a></span>
<span class="normal"><a href="#__codelineno-5-387">387</a></span>
<span class="normal"><a href="#__codelineno-5-388">388</a></span>
<span class="normal"><a href="#__codelineno-5-389">389</a></span>
<span class="normal"><a href="#__codelineno-5-390">390</a></span>
<span class="normal"><a href="#__codelineno-5-391">391</a></span>
<span class="normal"><a href="#__codelineno-5-392">392</a></span>
<span class="normal"><a href="#__codelineno-5-393">393</a></span>
<span class="normal"><a href="#__codelineno-5-394">394</a></span>
<span class="normal"><a href="#__codelineno-5-395">395</a></span>
<span class="normal"><a href="#__codelineno-5-396">396</a></span>
<span class="normal"><a href="#__codelineno-5-397">397</a></span>
<span class="normal"><a href="#__codelineno-5-398">398</a></span>
<span class="normal"><a href="#__codelineno-5-399">399</a></span>
<span class="normal"><a href="#__codelineno-5-400">400</a></span>
<span class="normal"><a href="#__codelineno-5-401">401</a></span>
<span class="normal"><a href="#__codelineno-5-402">402</a></span>
<span class="normal"><a href="#__codelineno-5-403">403</a></span>
<span class="normal"><a href="#__codelineno-5-404">404</a></span>
<span class="normal"><a href="#__codelineno-5-405">405</a></span>
<span class="normal"><a href="#__codelineno-5-406">406</a></span>
<span class="normal"><a href="#__codelineno-5-407">407</a></span>
<span class="normal"><a href="#__codelineno-5-408">408</a></span>
<span class="normal"><a href="#__codelineno-5-409">409</a></span>
<span class="normal"><a href="#__codelineno-5-410">410</a></span>
<span class="normal"><a href="#__codelineno-5-411">411</a></span>
<span class="normal"><a href="#__codelineno-5-412">412</a></span>
<span class="normal"><a href="#__codelineno-5-413">413</a></span>
<span class="normal"><a href="#__codelineno-5-414">414</a></span>
<span class="normal"><a href="#__codelineno-5-415">415</a></span>
<span class="normal"><a href="#__codelineno-5-416">416</a></span>
<span class="normal"><a href="#__codelineno-5-417">417</a></span>
<span class="normal"><a href="#__codelineno-5-418">418</a></span>
<span class="normal"><a href="#__codelineno-5-419">419</a></span>
<span class="normal"><a href="#__codelineno-5-420">420</a></span>
<span class="normal"><a href="#__codelineno-5-421">421</a></span>
<span class="normal"><a href="#__codelineno-5-422">422</a></span>
<span class="normal"><a href="#__codelineno-5-423">423</a></span>
<span class="normal"><a href="#__codelineno-5-424">424</a></span>
<span class="normal"><a href="#__codelineno-5-425">425</a></span>
<span class="normal"><a href="#__codelineno-5-426">426</a></span>
<span class="normal"><a href="#__codelineno-5-427">427</a></span>
<span class="normal"><a href="#__codelineno-5-428">428</a></span>
<span class="normal"><a href="#__codelineno-5-429">429</a></span>
<span class="normal"><a href="#__codelineno-5-430">430</a></span>
<span class="normal"><a href="#__codelineno-5-431">431</a></span>
<span class="normal"><a href="#__codelineno-5-432">432</a></span>
<span class="normal"><a href="#__codelineno-5-433">433</a></span>
<span class="normal"><a href="#__codelineno-5-434">434</a></span>
<span class="normal"><a href="#__codelineno-5-435">435</a></span>
<span class="normal"><a href="#__codelineno-5-436">436</a></span>
<span class="normal"><a href="#__codelineno-5-437">437</a></span>
<span class="normal"><a href="#__codelineno-5-438">438</a></span>
<span class="normal"><a href="#__codelineno-5-439">439</a></span>
<span class="normal"><a href="#__codelineno-5-440">440</a></span>
<span class="normal"><a href="#__codelineno-5-441">441</a></span>
<span class="normal"><a href="#__codelineno-5-442">442</a></span>
<span class="normal"><a href="#__codelineno-5-443">443</a></span>
<span class="normal"><a href="#__codelineno-5-444">444</a></span>
<span class="normal"><a href="#__codelineno-5-445">445</a></span>
<span class="normal"><a href="#__codelineno-5-446">446</a></span>
<span class="normal"><a href="#__codelineno-5-447">447</a></span>
<span class="normal"><a href="#__codelineno-5-448">448</a></span>
<span class="normal"><a href="#__codelineno-5-449">449</a></span>
<span class="normal"><a href="#__codelineno-5-450">450</a></span>
<span class="normal"><a href="#__codelineno-5-451">451</a></span>
<span class="normal"><a href="#__codelineno-5-452">452</a></span>
<span class="normal"><a href="#__codelineno-5-453">453</a></span>
<span class="normal"><a href="#__codelineno-5-454">454</a></span>
<span class="normal"><a href="#__codelineno-5-455">455</a></span>
<span class="normal"><a href="#__codelineno-5-456">456</a></span>
<span class="normal"><a href="#__codelineno-5-457">457</a></span>
<span class="normal"><a href="#__codelineno-5-458">458</a></span>
<span class="normal"><a href="#__codelineno-5-459">459</a></span>
<span class="normal"><a href="#__codelineno-5-460">460</a></span>
<span class="normal"><a href="#__codelineno-5-461">461</a></span>
<span class="normal"><a href="#__codelineno-5-462">462</a></span>
<span class="normal"><a href="#__codelineno-5-463">463</a></span>
<span class="normal"><a href="#__codelineno-5-464">464</a></span>
<span class="normal"><a href="#__codelineno-5-465">465</a></span>
<span class="normal"><a href="#__codelineno-5-466">466</a></span>
<span class="normal"><a href="#__codelineno-5-467">467</a></span>
<span class="normal"><a href="#__codelineno-5-468">468</a></span>
<span class="normal"><a href="#__codelineno-5-469">469</a></span>
<span class="normal"><a href="#__codelineno-5-470">470</a></span>
<span class="normal"><a href="#__codelineno-5-471">471</a></span>
<span class="normal"><a href="#__codelineno-5-472">472</a></span>
<span class="normal"><a href="#__codelineno-5-473">473</a></span>
<span class="normal"><a href="#__codelineno-5-474">474</a></span>
<span class="normal"><a href="#__codelineno-5-475">475</a></span>
<span class="normal"><a href="#__codelineno-5-476">476</a></span>
<span class="normal"><a href="#__codelineno-5-477">477</a></span>
<span class="normal"><a href="#__codelineno-5-478">478</a></span>
<span class="normal"><a href="#__codelineno-5-479">479</a></span>
<span class="normal"><a href="#__codelineno-5-480">480</a></span>
<span class="normal"><a href="#__codelineno-5-481">481</a></span>
<span class="normal"><a href="#__codelineno-5-482">482</a></span>
<span class="normal"><a href="#__codelineno-5-483">483</a></span>
<span class="normal"><a href="#__codelineno-5-484">484</a></span>
<span class="normal"><a href="#__codelineno-5-485">485</a></span>
<span class="normal"><a href="#__codelineno-5-486">486</a></span>
<span class="normal"><a href="#__codelineno-5-487">487</a></span>
<span class="normal"><a href="#__codelineno-5-488">488</a></span>
<span class="normal"><a href="#__codelineno-5-489">489</a></span>
<span class="normal"><a href="#__codelineno-5-490">490</a></span>
<span class="normal"><a href="#__codelineno-5-491">491</a></span>
<span class="normal"><a href="#__codelineno-5-492">492</a></span>
<span class="normal"><a href="#__codelineno-5-493">493</a></span>
<span class="normal"><a href="#__codelineno-5-494">494</a></span>
<span class="normal"><a href="#__codelineno-5-495">495</a></span>
<span class="normal"><a href="#__codelineno-5-496">496</a></span>
<span class="normal"><a href="#__codelineno-5-497">497</a></span>
<span class="normal"><a href="#__codelineno-5-498">498</a></span>
<span class="normal"><a href="#__codelineno-5-499">499</a></span>
<span class="normal"><a href="#__codelineno-5-500">500</a></span>
<span class="normal"><a href="#__codelineno-5-501">501</a></span>
<span class="normal"><a href="#__codelineno-5-502">502</a></span>
<span class="normal"><a href="#__codelineno-5-503">503</a></span>
<span class="normal"><a href="#__codelineno-5-504">504</a></span>
<span class="normal"><a href="#__codelineno-5-505">505</a></span>
<span class="normal"><a href="#__codelineno-5-506">506</a></span>
<span class="normal"><a href="#__codelineno-5-507">507</a></span>
<span class="normal"><a href="#__codelineno-5-508">508</a></span>
<span class="normal"><a href="#__codelineno-5-509">509</a></span>
<span class="normal"><a href="#__codelineno-5-510">510</a></span>
<span class="normal"><a href="#__codelineno-5-511">511</a></span>
<span class="normal"><a href="#__codelineno-5-512">512</a></span>
<span class="normal"><a href="#__codelineno-5-513">513</a></span>
<span class="normal"><a href="#__codelineno-5-514">514</a></span>
<span class="normal"><a href="#__codelineno-5-515">515</a></span>
<span class="normal"><a href="#__codelineno-5-516">516</a></span>
<span class="normal"><a href="#__codelineno-5-517">517</a></span>
<span class="normal"><a href="#__codelineno-5-518">518</a></span>
<span class="normal"><a href="#__codelineno-5-519">519</a></span>
<span class="normal"><a href="#__codelineno-5-520">520</a></span>
<span class="normal"><a href="#__codelineno-5-521">521</a></span>
<span class="normal"><a href="#__codelineno-5-522">522</a></span>
<span class="normal"><a href="#__codelineno-5-523">523</a></span>
<span class="normal"><a href="#__codelineno-5-524">524</a></span>
<span class="normal"><a href="#__codelineno-5-525">525</a></span>
<span class="normal"><a href="#__codelineno-5-526">526</a></span>
<span class="normal"><a href="#__codelineno-5-527">527</a></span>
<span class="normal"><a href="#__codelineno-5-528">528</a></span>
<span class="normal"><a href="#__codelineno-5-529">529</a></span>
<span class="normal"><a href="#__codelineno-5-530">530</a></span>
<span class="normal"><a href="#__codelineno-5-531">531</a></span>
<span class="normal"><a href="#__codelineno-5-532">532</a></span>
<span class="normal"><a href="#__codelineno-5-533">533</a></span>
<span class="normal"><a href="#__codelineno-5-534">534</a></span>
<span class="normal"><a href="#__codelineno-5-535">535</a></span>
<span class="normal"><a href="#__codelineno-5-536">536</a></span>
<span class="normal"><a href="#__codelineno-5-537">537</a></span>
<span class="normal"><a href="#__codelineno-5-538">538</a></span>
<span class="normal"><a href="#__codelineno-5-539">539</a></span>
<span class="normal"><a href="#__codelineno-5-540">540</a></span>
<span class="normal"><a href="#__codelineno-5-541">541</a></span>
<span class="normal"><a href="#__codelineno-5-542">542</a></span>
<span class="normal"><a href="#__codelineno-5-543">543</a></span>
<span class="normal"><a href="#__codelineno-5-544">544</a></span>
<span class="normal"><a href="#__codelineno-5-545">545</a></span>
<span class="normal"><a href="#__codelineno-5-546">546</a></span>
<span class="normal"><a href="#__codelineno-5-547">547</a></span>
<span class="normal"><a href="#__codelineno-5-548">548</a></span>
<span class="normal"><a href="#__codelineno-5-549">549</a></span>
<span class="normal"><a href="#__codelineno-5-550">550</a></span>
<span class="normal"><a href="#__codelineno-5-551">551</a></span>
<span class="normal"><a href="#__codelineno-5-552">552</a></span>
<span class="normal"><a href="#__codelineno-5-553">553</a></span>
<span class="normal"><a href="#__codelineno-5-554">554</a></span>
<span class="normal"><a href="#__codelineno-5-555">555</a></span>
<span class="normal"><a href="#__codelineno-5-556">556</a></span>
<span class="normal"><a href="#__codelineno-5-557">557</a></span>
<span class="normal"><a href="#__codelineno-5-558">558</a></span>
<span class="normal"><a href="#__codelineno-5-559">559</a></span>
<span class="normal"><a href="#__codelineno-5-560">560</a></span>
<span class="normal"><a href="#__codelineno-5-561">561</a></span>
<span class="normal"><a href="#__codelineno-5-562">562</a></span>
<span class="normal"><a href="#__codelineno-5-563">563</a></span>
<span class="normal"><a href="#__codelineno-5-564">564</a></span>
<span class="normal"><a href="#__codelineno-5-565">565</a></span>
<span class="normal"><a href="#__codelineno-5-566">566</a></span>
<span class="normal"><a href="#__codelineno-5-567">567</a></span>
<span class="normal"><a href="#__codelineno-5-568">568</a></span>
<span class="normal"><a href="#__codelineno-5-569">569</a></span>
<span class="normal"><a href="#__codelineno-5-570">570</a></span>
<span class="normal"><a href="#__codelineno-5-571">571</a></span>
<span class="normal"><a href="#__codelineno-5-572">572</a></span>
<span class="normal"><a href="#__codelineno-5-573">573</a></span>
<span class="normal"><a href="#__codelineno-5-574">574</a></span>
<span class="normal"><a href="#__codelineno-5-575">575</a></span>
<span class="normal"><a href="#__codelineno-5-576">576</a></span>
<span class="normal"><a href="#__codelineno-5-577">577</a></span>
<span class="normal"><a href="#__codelineno-5-578">578</a></span>
<span class="normal"><a href="#__codelineno-5-579">579</a></span>
<span class="normal"><a href="#__codelineno-5-580">580</a></span>
<span class="normal"><a href="#__codelineno-5-581">581</a></span>
<span class="normal"><a href="#__codelineno-5-582">582</a></span>
<span class="normal"><a href="#__codelineno-5-583">583</a></span>
<span class="normal"><a href="#__codelineno-5-584">584</a></span>
<span class="normal"><a href="#__codelineno-5-585">585</a></span>
<span class="normal"><a href="#__codelineno-5-586">586</a></span>
<span class="normal"><a href="#__codelineno-5-587">587</a></span>
<span class="normal"><a href="#__codelineno-5-588">588</a></span>
<span class="normal"><a href="#__codelineno-5-589">589</a></span>
<span class="normal"><a href="#__codelineno-5-590">590</a></span>
<span class="normal"><a href="#__codelineno-5-591">591</a></span>
<span class="normal"><a href="#__codelineno-5-592">592</a></span>
<span class="normal"><a href="#__codelineno-5-593">593</a></span>
<span class="normal"><a href="#__codelineno-5-594">594</a></span>
<span class="normal"><a href="#__codelineno-5-595">595</a></span>
<span class="normal"><a href="#__codelineno-5-596">596</a></span>
<span class="normal"><a href="#__codelineno-5-597">597</a></span>
<span class="normal"><a href="#__codelineno-5-598">598</a></span>
<span class="normal"><a href="#__codelineno-5-599">599</a></span>
<span class="normal"><a href="#__codelineno-5-600">600</a></span>
<span class="normal"><a href="#__codelineno-5-601">601</a></span>
<span class="normal"><a href="#__codelineno-5-602">602</a></span>
<span class="normal"><a href="#__codelineno-5-603">603</a></span>
<span class="normal"><a href="#__codelineno-5-604">604</a></span>
<span class="normal"><a href="#__codelineno-5-605">605</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">ConcatDataset</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">T</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">vgg16</span><span class="p">,</span> <span class="n">VGG16_Weights</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">it</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="c1"># -------------------- é…ç½® --------------------</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="n">USE_AMP</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># å›ºå®šç”¨ CUDA AMP</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="c1"># Kaggle å¸¸è§è·¯å¾„ï¼ˆå¯æŒ‰éœ€ä¿®æ”¹ï¼‰</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="n">VOC2007_ROOT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2007/VOCtrainval_06-Nov-2007/VOCdevkit/VOC2007"</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="n">VOC2007_ROOT_ALT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2007/VOCdevkit/VOC2007"</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT_ALT</span><span class="p">):</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a>    <span class="n">VOC2007_ROOT</span> <span class="o">=</span> <span class="n">VOC2007_ROOT_ALT</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="n">VOC2012_ROOT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2012/VOC2012"</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="mi">21</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="n">VAL_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># ä½ è¦æ‰‹è°ƒå°±æ”¹è¿™é‡Œï¼ˆ&gt;1 æ—¶éœ€è‡ªå·±åŠ  padding collateï¼‰</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">6</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">7.5e-5</span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="n">WEIGHT_DECAY</span> <span class="o">=</span> <span class="mf">1e-4</span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a><span class="c1"># è¯„ä¼°åŠ é€Ÿå¼€å…³</span>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a><span class="n">EVAL_COMPUTE_LOSS</span> <span class="o">=</span> <span class="kc">False</span>     <span class="c1"># True ä¼šè®¡ç®— val lossï¼Œç¨æ…¢</span>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="n">EVAL_MAX_BATCHES</span> <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># é™åˆ¶è¯„ä¼°æ‰¹æ¬¡æ•°ï¼›None è¡¨ç¤ºå…¨é‡</span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="n">EVAL_MAX_IMAGES</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># é™åˆ¶è¯„ä¼°å›¾ç‰‡æ•°ï¼›None è¡¨ç¤ºå…¨é‡</span>
<a id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="n">EVAL_PROGRESS</span> <span class="o">=</span> <span class="kc">True</span>          <span class="c1"># ä¿ç•™ tqdm è¿›åº¦æ¡</span>
<a id="__codelineno-5-41" name="__codelineno-5-41"></a>
<a id="__codelineno-5-42" name="__codelineno-5-42"></a><span class="n">SAVE_DIR</span> <span class="o">=</span> <span class="s2">"/kaggle/working"</span>
<a id="__codelineno-5-43" name="__codelineno-5-43"></a><span class="n">BEST_PATH_VOC</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"fcn8s_best_voc2012val.pth"</span><span class="p">)</span>
<a id="__codelineno-5-44" name="__codelineno-5-44"></a><span class="n">LATEST_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"fcn8s_latest.pth"</span><span class="p">)</span>
<a id="__codelineno-5-45" name="__codelineno-5-45"></a><span class="n">VIS_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"vis_voc_val"</span><span class="p">)</span>
<a id="__codelineno-5-46" name="__codelineno-5-46"></a>
<a id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using device: </span><span class="si">{</span><span class="n">DEVICE</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-48" name="__codelineno-5-48"></a><span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s2">"cuda"</span><span class="p">:</span>
<a id="__codelineno-5-49" name="__codelineno-5-49"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-5-50" name="__codelineno-5-50"></a>
<a id="__codelineno-5-51" name="__codelineno-5-51"></a><span class="c1"># PASCAL VOC é¢œè‰²æ˜ å°„ (RGB) ç”¨äºå¯è§†åŒ–</span>
<a id="__codelineno-5-52" name="__codelineno-5-52"></a><span class="n">VOC_COLORMAP</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-5-53" name="__codelineno-5-53"></a>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
<a id="__codelineno-5-54" name="__codelineno-5-54"></a>    <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-5-55" name="__codelineno-5-55"></a>    <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
<a id="__codelineno-5-56" name="__codelineno-5-56"></a>    <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-5-57" name="__codelineno-5-57"></a>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
<a id="__codelineno-5-58" name="__codelineno-5-58"></a><span class="p">]</span>
<a id="__codelineno-5-59" name="__codelineno-5-59"></a>
<a id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="c1"># -------------------- æ•°æ®é›†ï¼ˆVOCï¼‰ --------------------</span>
<a id="__codelineno-5-61" name="__codelineno-5-61"></a><span class="k">class</span><span class="w"> </span><span class="nc">VOCSegmentationDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-5-62" name="__codelineno-5-62"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-5-63" name="__codelineno-5-63"></a><span class="sd">    ç”¨äº VOC2007/VOC2012 çš„è¯­ä¹‰åˆ†å‰²æ•°æ®ã€‚</span>
<a id="__codelineno-5-64" name="__codelineno-5-64"></a><span class="sd">    è‹¥ç¼ºå°‘ ImageSets/Segmentation/{split}.txtï¼Œå°†å›é€€åˆ°æ‰«æ SegmentationClass ç›®å½•ã€‚</span>
<a id="__codelineno-5-65" name="__codelineno-5-65"></a><span class="sd">    """</span>
<a id="__codelineno-5-66" name="__codelineno-5-66"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s2">"train"</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-5-67" name="__codelineno-5-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
<a id="__codelineno-5-68" name="__codelineno-5-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>
<a id="__codelineno-5-69" name="__codelineno-5-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_set</span> <span class="o">=</span> <span class="n">image_set</span>
<a id="__codelineno-5-70" name="__codelineno-5-70"></a>
<a id="__codelineno-5-71" name="__codelineno-5-71"></a>        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"JPEGImages"</span><span class="p">)</span>
<a id="__codelineno-5-72" name="__codelineno-5-72"></a>        <span class="n">mask_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"SegmentationClass"</span><span class="p">)</span>
<a id="__codelineno-5-73" name="__codelineno-5-73"></a>        <span class="n">split_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"ImageSets"</span><span class="p">,</span> <span class="s2">"Segmentation"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">image_set</span><span class="si">}</span><span class="s2">.txt"</span><span class="p">)</span>
<a id="__codelineno-5-74" name="__codelineno-5-74"></a>
<a id="__codelineno-5-75" name="__codelineno-5-75"></a>        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">image_dir</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Image dir not found: </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-5-76" name="__codelineno-5-76"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">):</span>
<a id="__codelineno-5-77" name="__codelineno-5-77"></a>            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
<a id="__codelineno-5-78" name="__codelineno-5-78"></a>                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"SegmentationClass not found: </span><span class="si">{</span><span class="n">mask_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-79" name="__codelineno-5-79"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-80" name="__codelineno-5-80"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[Warning] SegmentationClass not found in </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">, dataset will be empty."</span><span class="p">)</span>
<a id="__codelineno-5-81" name="__codelineno-5-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span> <span class="o">=</span> <span class="n">image_dir</span>
<a id="__codelineno-5-82" name="__codelineno-5-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask_dir</span> <span class="o">=</span> <span class="n">mask_dir</span>
<a id="__codelineno-5-83" name="__codelineno-5-83"></a>
<a id="__codelineno-5-84" name="__codelineno-5-84"></a>        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-85" name="__codelineno-5-85"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">split_file</span><span class="p">):</span>
<a id="__codelineno-5-86" name="__codelineno-5-86"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">split_file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-5-87" name="__codelineno-5-87"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
<a id="__codelineno-5-88" name="__codelineno-5-88"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-89" name="__codelineno-5-89"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">):</span>
<a id="__codelineno-5-90" name="__codelineno-5-90"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".png"</span><span class="p">)]</span>
<a id="__codelineno-5-91" name="__codelineno-5-91"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-92" name="__codelineno-5-92"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-93" name="__codelineno-5-93"></a>
<a id="__codelineno-5-94" name="__codelineno-5-94"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-5-95" name="__codelineno-5-95"></a>        <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
<a id="__codelineno-5-96" name="__codelineno-5-96"></a>            <span class="n">ip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.jpg"</span><span class="p">)</span>
<a id="__codelineno-5-97" name="__codelineno-5-97"></a>            <span class="n">mp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
<a id="__codelineno-5-98" name="__codelineno-5-98"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">mp</span><span class="p">):</span>
<a id="__codelineno-5-99" name="__codelineno-5-99"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
<a id="__codelineno-5-100" name="__codelineno-5-100"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<a id="__codelineno-5-101" name="__codelineno-5-101"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-102" name="__codelineno-5-102"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[Warning] Empty dataset for root=</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">, split=</span><span class="si">{</span><span class="n">image_set</span><span class="si">}</span><span class="s2">. Check masks/splits."</span><span class="p">)</span>
<a id="__codelineno-5-103" name="__codelineno-5-103"></a>
<a id="__codelineno-5-104" name="__codelineno-5-104"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-5-105" name="__codelineno-5-105"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">)</span>
<a id="__codelineno-5-106" name="__codelineno-5-106"></a>
<a id="__codelineno-5-107" name="__codelineno-5-107"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-5-108" name="__codelineno-5-108"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">"RGB"</span><span class="p">)</span>
<a id="__codelineno-5-109" name="__codelineno-5-109"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>  <span class="c1"># palette ç´¢å¼•</span>
<a id="__codelineno-5-110" name="__codelineno-5-110"></a>
<a id="__codelineno-5-111" name="__codelineno-5-111"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-112" name="__codelineno-5-112"></a>            <span class="n">image</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-5-113" name="__codelineno-5-113"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-114" name="__codelineno-5-114"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-5-115" name="__codelineno-5-115"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">))</span>
<a id="__codelineno-5-116" name="__codelineno-5-116"></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-5-117" name="__codelineno-5-117"></a>            <span class="n">image</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-5-118" name="__codelineno-5-118"></a>        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-5-119" name="__codelineno-5-119"></a>
<a id="__codelineno-5-120" name="__codelineno-5-120"></a><span class="c1"># -------------------- æ•°æ®å¢å¼ºä¸é¢„å¤„ç† --------------------</span>
<a id="__codelineno-5-121" name="__codelineno-5-121"></a><span class="k">class</span><span class="w"> </span><span class="nc">SegmentationTransforms</span><span class="p">:</span>
<a id="__codelineno-5-122" name="__codelineno-5-122"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">,</span>
<a id="__codelineno-5-123" name="__codelineno-5-123"></a>                 <span class="n">color_jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_noise_prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>  <span class="c1"># å…³é—­å™ªå£°ï¼šé»˜è®¤ 0.0</span>
<a id="__codelineno-5-124" name="__codelineno-5-124"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="n">is_train</span>
<a id="__codelineno-5-125" name="__codelineno-5-125"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_size</span> <span class="o">=</span> <span class="n">base_size</span>
<a id="__codelineno-5-126" name="__codelineno-5-126"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">=</span> <span class="n">crop_size</span>
<a id="__codelineno-5-127" name="__codelineno-5-127"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">)</span>
<a id="__codelineno-5-128" name="__codelineno-5-128"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)</span>
<a id="__codelineno-5-129" name="__codelineno-5-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ColorJitter</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_jitter</span> <span class="ow">and</span> <span class="n">is_train</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-5-130" name="__codelineno-5-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_noise_prob</span> <span class="o">=</span> <span class="n">add_noise_prob</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-5-131" name="__codelineno-5-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">noise_std</span> <span class="o">=</span> <span class="n">noise_std</span>
<a id="__codelineno-5-132" name="__codelineno-5-132"></a>
<a id="__codelineno-5-133" name="__codelineno-5-133"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<a id="__codelineno-5-134" name="__codelineno-5-134"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">:</span>
<a id="__codelineno-5-135" name="__codelineno-5-135"></a>            <span class="c1"># 1) éšæœºç¼©æ”¾çŸ­è¾¹åˆ° [0.5, 2.0] * base_size</span>
<a id="__codelineno-5-136" name="__codelineno-5-136"></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-5-137" name="__codelineno-5-137"></a>            <span class="n">short</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
<a id="__codelineno-5-138" name="__codelineno-5-138"></a>            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-5-139" name="__codelineno-5-139"></a>            <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">:</span>
<a id="__codelineno-5-140" name="__codelineno-5-140"></a>                <span class="n">ow</span><span class="p">,</span> <span class="n">oh</span> <span class="o">=</span> <span class="n">short</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">short</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-5-141" name="__codelineno-5-141"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-142" name="__codelineno-5-142"></a>                <span class="n">oh</span><span class="p">,</span> <span class="n">ow</span> <span class="o">=</span> <span class="n">short</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">short</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-5-143" name="__codelineno-5-143"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">ow</span><span class="p">,</span> <span class="n">oh</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">)</span>
<a id="__codelineno-5-144" name="__codelineno-5-144"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">ow</span><span class="p">,</span> <span class="n">oh</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">NEAREST</span><span class="p">)</span>
<a id="__codelineno-5-145" name="__codelineno-5-145"></a>
<a id="__codelineno-5-146" name="__codelineno-5-146"></a>            <span class="c1"># 2) è‹¥å°äº crop_sizeï¼Œå³ä¸‹è§’ paddingï¼ˆmask ç”¨ 255ï¼‰</span>
<a id="__codelineno-5-147" name="__codelineno-5-147"></a>            <span class="n">pad_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-5-148" name="__codelineno-5-148"></a>            <span class="n">pad_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-5-149" name="__codelineno-5-149"></a>            <span class="k">if</span> <span class="n">pad_w</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pad_h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-150" name="__codelineno-5-150"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">,</span> <span class="n">pad_h</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-151" name="__codelineno-5-151"></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">,</span> <span class="n">pad_h</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-5-152" name="__codelineno-5-152"></a>
<a id="__codelineno-5-153" name="__codelineno-5-153"></a>            <span class="c1"># 3) éšæœºè£å‰ª</span>
<a id="__codelineno-5-154" name="__codelineno-5-154"></a>            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-5-155" name="__codelineno-5-155"></a>            <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-156" name="__codelineno-5-156"></a>            <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-157" name="__codelineno-5-157"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">))</span>
<a id="__codelineno-5-158" name="__codelineno-5-158"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">))</span>
<a id="__codelineno-5-159" name="__codelineno-5-159"></a>
<a id="__codelineno-5-160" name="__codelineno-5-160"></a>            <span class="c1"># 4) éšæœºæ°´å¹³ç¿»è½¬</span>
<a id="__codelineno-5-161" name="__codelineno-5-161"></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
<a id="__codelineno-5-162" name="__codelineno-5-162"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">hflip</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-5-163" name="__codelineno-5-163"></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">hflip</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-5-164" name="__codelineno-5-164"></a>
<a id="__codelineno-5-165" name="__codelineno-5-165"></a>            <span class="c1"># 5) é¢œè‰²æŠ–åŠ¨</span>
<a id="__codelineno-5-166" name="__codelineno-5-166"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-167" name="__codelineno-5-167"></a>                <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-5-168" name="__codelineno-5-168"></a>
<a id="__codelineno-5-169" name="__codelineno-5-169"></a>        <span class="c1"># è½¬ Tensor</span>
<a id="__codelineno-5-170" name="__codelineno-5-170"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-5-171" name="__codelineno-5-171"></a>
<a id="__codelineno-5-172" name="__codelineno-5-172"></a>        <span class="c1"># å¯é€‰å™ªå£°ï¼ˆç°å·²å…³é—­ï¼Œé»˜è®¤ add_noise_prob=0.0ï¼‰</span>
<a id="__codelineno-5-173" name="__codelineno-5-173"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_noise_prob</span><span class="p">:</span>
<a id="__codelineno-5-174" name="__codelineno-5-174"></a>            <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_std</span>
<a id="__codelineno-5-175" name="__codelineno-5-175"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">img</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-5-176" name="__codelineno-5-176"></a>
<a id="__codelineno-5-177" name="__codelineno-5-177"></a>        <span class="c1"># æ ‡å‡†åŒ–</span>
<a id="__codelineno-5-178" name="__codelineno-5-178"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)</span>
<a id="__codelineno-5-179" name="__codelineno-5-179"></a>
<a id="__codelineno-5-180" name="__codelineno-5-180"></a>        <span class="c1"># ç›´æ¥æŠŠ palette/L ç´¢å¼•å›¾è½¬æˆç±»åˆ« idï¼ˆ0..20ï¼Œ255 å¿½ç•¥ï¼‰</span>
<a id="__codelineno-5-181" name="__codelineno-5-181"></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-5-182" name="__codelineno-5-182"></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-5-183" name="__codelineno-5-183"></a>
<a id="__codelineno-5-184" name="__codelineno-5-184"></a><span class="c1"># -------------------- æ¨¡å‹ï¼ˆU-Netï¼‰ --------------------</span>
<a id="__codelineno-5-185" name="__codelineno-5-185"></a><span class="k">def</span><span class="w"> </span><span class="nf">bilinear_kernel</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">):</span>
<a id="__codelineno-5-186" name="__codelineno-5-186"></a>    <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-5-187" name="__codelineno-5-187"></a>    <span class="n">center</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">kernel_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">factor</span> <span class="o">-</span> <span class="mf">0.5</span>
<a id="__codelineno-5-188" name="__codelineno-5-188"></a>    <span class="n">og</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">kernel_size</span><span class="p">,</span> <span class="p">:</span><span class="n">kernel_size</span><span class="p">]</span>
<a id="__codelineno-5-189" name="__codelineno-5-189"></a>    <span class="n">filt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span>
<a id="__codelineno-5-190" name="__codelineno-5-190"></a>    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-5-191" name="__codelineno-5-191"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)):</span>
<a id="__codelineno-5-192" name="__codelineno-5-192"></a>        <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">filt</span>
<a id="__codelineno-5-193" name="__codelineno-5-193"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-5-194" name="__codelineno-5-194"></a>
<a id="__codelineno-5-195" name="__codelineno-5-195"></a><span class="c1"># è§£ç å™¨ DoubleConvï¼šåŠ  BN + Dropout2d</span>
<a id="__codelineno-5-196" name="__codelineno-5-196"></a><span class="k">class</span><span class="w"> </span><span class="nc">DoubleConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-5-197" name="__codelineno-5-197"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<a id="__codelineno-5-198" name="__codelineno-5-198"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-5-199" name="__codelineno-5-199"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-5-200" name="__codelineno-5-200"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-201" name="__codelineno-5-201"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">),</span>
<a id="__codelineno-5-202" name="__codelineno-5-202"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-203" name="__codelineno-5-203"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-204" name="__codelineno-5-204"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">),</span>
<a id="__codelineno-5-205" name="__codelineno-5-205"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-206" name="__codelineno-5-206"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
<a id="__codelineno-5-207" name="__codelineno-5-207"></a>        <span class="p">)</span>
<a id="__codelineno-5-208" name="__codelineno-5-208"></a>
<a id="__codelineno-5-209" name="__codelineno-5-209"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-5-210" name="__codelineno-5-210"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-5-211" name="__codelineno-5-211"></a>
<a id="__codelineno-5-212" name="__codelineno-5-212"></a>
<a id="__codelineno-5-213" name="__codelineno-5-213"></a><span class="k">class</span><span class="w"> </span><span class="nc">UNetVGG16</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-5-214" name="__codelineno-5-214"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-5-215" name="__codelineno-5-215"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-5-216" name="__codelineno-5-216"></a>        <span class="c1"># é¢„è®­ç»ƒ VGG16 ç¼–ç å™¨</span>
<a id="__codelineno-5-217" name="__codelineno-5-217"></a>        <span class="n">vgg</span> <span class="o">=</span> <span class="n">vgg16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">VGG16_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span><span class="p">)</span>
<a id="__codelineno-5-218" name="__codelineno-5-218"></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">features</span>
<a id="__codelineno-5-219" name="__codelineno-5-219"></a>
<a id="__codelineno-5-220" name="__codelineno-5-220"></a>        <span class="c1"># æ‹†åˆ†ä¸ºâ€œå·ç§¯å— + æ± åŒ–â€ï¼Œå¹¶ç§»é™¤ pool5ï¼ˆä¿æŒ 4 æ¬¡ä¸‹é‡‡æ ·ï¼‰</span>
<a id="__codelineno-5-221" name="__codelineno-5-221"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-5-222" name="__codelineno-5-222"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool1</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-5-223" name="__codelineno-5-223"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
<a id="__codelineno-5-224" name="__codelineno-5-224"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool2</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<a id="__codelineno-5-225" name="__codelineno-5-225"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-5-226" name="__codelineno-5-226"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool3</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-5-227" name="__codelineno-5-227"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">23</span><span class="p">]</span>
<a id="__codelineno-5-228" name="__codelineno-5-228"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool4</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span>
<a id="__codelineno-5-229" name="__codelineno-5-229"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span>  <span class="c1"># ä¸å« pool5</span>
<a id="__codelineno-5-230" name="__codelineno-5-230"></a>
<a id="__codelineno-5-231" name="__codelineno-5-231"></a>        <span class="c1"># è§£ç å™¨ï¼šä¸Šé‡‡æ ·æ”¹ä¸ºâ€œæ’å€¼ + å·ç§¯(BN+ReLU)â€ + æ‹¼æ¥ + åŒå·ç§¯(DoubleConv: BN+Dropout)</span>
<a id="__codelineno-5-232" name="__codelineno-5-232"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-5-233" name="__codelineno-5-233"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-234" name="__codelineno-5-234"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-235" name="__codelineno-5-235"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<a id="__codelineno-5-236" name="__codelineno-5-236"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-237" name="__codelineno-5-237"></a>        <span class="p">)</span>
<a id="__codelineno-5-238" name="__codelineno-5-238"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec4</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">512</span> <span class="o">+</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<a id="__codelineno-5-239" name="__codelineno-5-239"></a>
<a id="__codelineno-5-240" name="__codelineno-5-240"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-5-241" name="__codelineno-5-241"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-242" name="__codelineno-5-242"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-243" name="__codelineno-5-243"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<a id="__codelineno-5-244" name="__codelineno-5-244"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-245" name="__codelineno-5-245"></a>        <span class="p">)</span>
<a id="__codelineno-5-246" name="__codelineno-5-246"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec3</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">256</span> <span class="o">+</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<a id="__codelineno-5-247" name="__codelineno-5-247"></a>
<a id="__codelineno-5-248" name="__codelineno-5-248"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-5-249" name="__codelineno-5-249"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-250" name="__codelineno-5-250"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-251" name="__codelineno-5-251"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<a id="__codelineno-5-252" name="__codelineno-5-252"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-253" name="__codelineno-5-253"></a>        <span class="p">)</span>
<a id="__codelineno-5-254" name="__codelineno-5-254"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">128</span> <span class="o">+</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<a id="__codelineno-5-255" name="__codelineno-5-255"></a>
<a id="__codelineno-5-256" name="__codelineno-5-256"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-5-257" name="__codelineno-5-257"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-258" name="__codelineno-5-258"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-259" name="__codelineno-5-259"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
<a id="__codelineno-5-260" name="__codelineno-5-260"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-261" name="__codelineno-5-261"></a>        <span class="p">)</span>
<a id="__codelineno-5-262" name="__codelineno-5-262"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">64</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<a id="__codelineno-5-263" name="__codelineno-5-263"></a>
<a id="__codelineno-5-264" name="__codelineno-5-264"></a>        <span class="c1"># è¾“å‡ºå±‚</span>
<a id="__codelineno-5-265" name="__codelineno-5-265"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-266" name="__codelineno-5-266"></a>
<a id="__codelineno-5-267" name="__codelineno-5-267"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-5-268" name="__codelineno-5-268"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_align</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
<a id="__codelineno-5-269" name="__codelineno-5-269"></a>        <span class="c1"># å¯¹é½å°ºå¯¸ï¼Œé¿å…å¥‡å¶æ•°å¯¼è‡´çš„ 1px è¯¯å·®</span>
<a id="__codelineno-5-270" name="__codelineno-5-270"></a>        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
<a id="__codelineno-5-271" name="__codelineno-5-271"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-5-272" name="__codelineno-5-272"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-5-273" name="__codelineno-5-273"></a>
<a id="__codelineno-5-274" name="__codelineno-5-274"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-5-275" name="__codelineno-5-275"></a>        <span class="c1"># ç¼–ç å™¨</span>
<a id="__codelineno-5-276" name="__codelineno-5-276"></a>        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>           <span class="c1"># C=64,   1/1</span>
<a id="__codelineno-5-277" name="__codelineno-5-277"></a>        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool1</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>          <span class="c1">#        1/2</span>
<a id="__codelineno-5-278" name="__codelineno-5-278"></a>
<a id="__codelineno-5-279" name="__codelineno-5-279"></a>        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>          <span class="c1"># C=128,  1/2</span>
<a id="__codelineno-5-280" name="__codelineno-5-280"></a>        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool2</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>          <span class="c1">#        1/4</span>
<a id="__codelineno-5-281" name="__codelineno-5-281"></a>
<a id="__codelineno-5-282" name="__codelineno-5-282"></a>        <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>          <span class="c1"># C=256,  1/4</span>
<a id="__codelineno-5-283" name="__codelineno-5-283"></a>        <span class="n">p3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool3</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>          <span class="c1">#        1/8</span>
<a id="__codelineno-5-284" name="__codelineno-5-284"></a>
<a id="__codelineno-5-285" name="__codelineno-5-285"></a>        <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span>          <span class="c1"># C=512,  1/8</span>
<a id="__codelineno-5-286" name="__codelineno-5-286"></a>        <span class="n">p4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool4</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span>          <span class="c1">#        1/16</span>
<a id="__codelineno-5-287" name="__codelineno-5-287"></a>
<a id="__codelineno-5-288" name="__codelineno-5-288"></a>        <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span><span class="p">(</span><span class="n">p4</span><span class="p">)</span>          <span class="c1"># C=512,  1/16 (bottleneck)</span>
<a id="__codelineno-5-289" name="__codelineno-5-289"></a>
<a id="__codelineno-5-290" name="__codelineno-5-290"></a>        <span class="c1"># è§£ç å™¨ï¼ˆU-Netï¼‰</span>
<a id="__codelineno-5-291" name="__codelineno-5-291"></a>        <span class="n">u4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up4</span><span class="p">(</span><span class="n">x5</span><span class="p">)</span>            <span class="c1"># -&gt; 1/8</span>
<a id="__codelineno-5-292" name="__codelineno-5-292"></a>        <span class="n">u4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u4</span><span class="p">,</span> <span class="n">x4</span><span class="p">)</span>
<a id="__codelineno-5-293" name="__codelineno-5-293"></a>        <span class="n">d4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec4</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u4</span><span class="p">,</span> <span class="n">x4</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=512</span>
<a id="__codelineno-5-294" name="__codelineno-5-294"></a>
<a id="__codelineno-5-295" name="__codelineno-5-295"></a>        <span class="n">u3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up3</span><span class="p">(</span><span class="n">d4</span><span class="p">)</span>            <span class="c1"># -&gt; 1/4</span>
<a id="__codelineno-5-296" name="__codelineno-5-296"></a>        <span class="n">u3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u3</span><span class="p">,</span> <span class="n">x3</span><span class="p">)</span>
<a id="__codelineno-5-297" name="__codelineno-5-297"></a>        <span class="n">d3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec3</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u3</span><span class="p">,</span> <span class="n">x3</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=256</span>
<a id="__codelineno-5-298" name="__codelineno-5-298"></a>
<a id="__codelineno-5-299" name="__codelineno-5-299"></a>        <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up2</span><span class="p">(</span><span class="n">d3</span><span class="p">)</span>            <span class="c1"># -&gt; 1/2</span>
<a id="__codelineno-5-300" name="__codelineno-5-300"></a>        <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<a id="__codelineno-5-301" name="__codelineno-5-301"></a>        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u2</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=128</span>
<a id="__codelineno-5-302" name="__codelineno-5-302"></a>
<a id="__codelineno-5-303" name="__codelineno-5-303"></a>        <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up1</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>            <span class="c1"># -&gt; 1/1</span>
<a id="__codelineno-5-304" name="__codelineno-5-304"></a>        <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
<a id="__codelineno-5-305" name="__codelineno-5-305"></a>        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">x1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=64</span>
<a id="__codelineno-5-306" name="__codelineno-5-306"></a>
<a id="__codelineno-5-307" name="__codelineno-5-307"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_conv</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>      <span class="c1"># -&gt; num_classes@HxW</span>
<a id="__codelineno-5-308" name="__codelineno-5-308"></a>        <span class="k">return</span> <span class="n">out</span>
<a id="__codelineno-5-309" name="__codelineno-5-309"></a>
<a id="__codelineno-5-310" name="__codelineno-5-310"></a><span class="c1"># -------------------- è¯„ä¼°æŒ‡æ ‡ --------------------</span>
<a id="__codelineno-5-311" name="__codelineno-5-311"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
<a id="__codelineno-5-312" name="__codelineno-5-312"></a>    <span class="n">pixel_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-5-313" name="__codelineno-5-313"></a>    <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
<a id="__codelineno-5-314" name="__codelineno-5-314"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">),</span> <span class="n">denom</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">denom</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-315" name="__codelineno-5-315"></a>    <span class="n">miou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span>
<a id="__codelineno-5-316" name="__codelineno-5-316"></a>    <span class="k">return</span> <span class="n">pixel_accuracy</span><span class="p">,</span> <span class="n">miou</span>
<a id="__codelineno-5-317" name="__codelineno-5-317"></a>
<a id="__codelineno-5-318" name="__codelineno-5-318"></a><span class="c1"># -------------------- è®­ç»ƒ / éªŒè¯ --------------------</span>
<a id="__codelineno-5-319" name="__codelineno-5-319"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_one_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">,</span> <span class="n">grad_clip</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<a id="__codelineno-5-320" name="__codelineno-5-320"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-5-321" name="__codelineno-5-321"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-322" name="__codelineno-5-322"></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Training"</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-5-323" name="__codelineno-5-323"></a>    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">progress_bar</span><span class="p">:</span>
<a id="__codelineno-5-324" name="__codelineno-5-324"></a>        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-5-325" name="__codelineno-5-325"></a>        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-5-326" name="__codelineno-5-326"></a>
<a id="__codelineno-5-327" name="__codelineno-5-327"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-5-328" name="__codelineno-5-328"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-5-329" name="__codelineno-5-329"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-5-330" name="__codelineno-5-330"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-5-331" name="__codelineno-5-331"></a>
<a id="__codelineno-5-332" name="__codelineno-5-332"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-5-333" name="__codelineno-5-333"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">unscale_</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
<a id="__codelineno-5-334" name="__codelineno-5-334"></a>        <span class="k">if</span> <span class="n">grad_clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grad_clip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-335" name="__codelineno-5-335"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">grad_clip</span><span class="p">)</span>
<a id="__codelineno-5-336" name="__codelineno-5-336"></a>
<a id="__codelineno-5-337" name="__codelineno-5-337"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
<a id="__codelineno-5-338" name="__codelineno-5-338"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<a id="__codelineno-5-339" name="__codelineno-5-339"></a>
<a id="__codelineno-5-340" name="__codelineno-5-340"></a>        <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-5-341" name="__codelineno-5-341"></a>
<a id="__codelineno-5-342" name="__codelineno-5-342"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-5-343" name="__codelineno-5-343"></a>        <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span>
<a id="__codelineno-5-344" name="__codelineno-5-344"></a>            <span class="n">loss</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
<a id="__codelineno-5-345" name="__codelineno-5-345"></a>            <span class="n">lr</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"lr"</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">"lr"</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">'</span>
<a id="__codelineno-5-346" name="__codelineno-5-346"></a>        <span class="p">)</span>
<a id="__codelineno-5-347" name="__codelineno-5-347"></a>    <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
<a id="__codelineno-5-348" name="__codelineno-5-348"></a>
<a id="__codelineno-5-349" name="__codelineno-5-349"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-5-350" name="__codelineno-5-350"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_fast</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
<a id="__codelineno-5-351" name="__codelineno-5-351"></a>                  <span class="n">compute_loss</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_batches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-5-352" name="__codelineno-5-352"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-5-353" name="__codelineno-5-353"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-5-354" name="__codelineno-5-354"></a>    <span class="n">seen_images</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-355" name="__codelineno-5-355"></a>    <span class="n">batches</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-356" name="__codelineno-5-356"></a>
<a id="__codelineno-5-357" name="__codelineno-5-357"></a>    <span class="n">conf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-5-358" name="__codelineno-5-358"></a>    <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Evaluating"</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="k">else</span> <span class="n">data_loader</span>
<a id="__codelineno-5-359" name="__codelineno-5-359"></a>
<a id="__codelineno-5-360" name="__codelineno-5-360"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
<a id="__codelineno-5-361" name="__codelineno-5-361"></a>        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
<a id="__codelineno-5-362" name="__codelineno-5-362"></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-363" name="__codelineno-5-363"></a>            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-364" name="__codelineno-5-364"></a>
<a id="__codelineno-5-365" name="__codelineno-5-365"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-5-366" name="__codelineno-5-366"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-5-367" name="__codelineno-5-367"></a>                <span class="k">if</span> <span class="n">compute_loss</span><span class="p">:</span>
<a id="__codelineno-5-368" name="__codelineno-5-368"></a>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-5-369" name="__codelineno-5-369"></a>                    <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-5-370" name="__codelineno-5-370"></a>
<a id="__codelineno-5-371" name="__codelineno-5-371"></a>            <span class="n">preds</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-372" name="__codelineno-5-372"></a>            <span class="n">valid</span> <span class="o">=</span> <span class="n">targets</span> <span class="o">!=</span> <span class="mi">255</span>
<a id="__codelineno-5-373" name="__codelineno-5-373"></a>            <span class="k">if</span> <span class="n">valid</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-5-374" name="__codelineno-5-374"></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">num_classes</span>
<a id="__codelineno-5-375" name="__codelineno-5-375"></a>                <span class="n">t</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-5-376" name="__codelineno-5-376"></a>                <span class="n">p</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-5-377" name="__codelineno-5-377"></a>                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-378" name="__codelineno-5-378"></a>                <span class="n">conf</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a id="__codelineno-5-379" name="__codelineno-5-379"></a>
<a id="__codelineno-5-380" name="__codelineno-5-380"></a>            <span class="n">batches</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-381" name="__codelineno-5-381"></a>            <span class="n">seen_images</span> <span class="o">+=</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-382" name="__codelineno-5-382"></a>
<a id="__codelineno-5-383" name="__codelineno-5-383"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">max_batches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">batches</span> <span class="o">&gt;=</span> <span class="n">max_batches</span><span class="p">)</span> <span class="ow">or</span> \
<a id="__codelineno-5-384" name="__codelineno-5-384"></a>               <span class="p">(</span><span class="n">max_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seen_images</span> <span class="o">&gt;=</span> <span class="n">max_images</span><span class="p">):</span>
<a id="__codelineno-5-385" name="__codelineno-5-385"></a>                <span class="k">break</span>
<a id="__codelineno-5-386" name="__codelineno-5-386"></a>
<a id="__codelineno-5-387" name="__codelineno-5-387"></a>    <span class="n">conf_f</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-5-388" name="__codelineno-5-388"></a>    <span class="n">total</span> <span class="o">=</span> <span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-5-389" name="__codelineno-5-389"></a>    <span class="n">pixel_acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-5-390" name="__codelineno-5-390"></a>    <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">))</span>
<a id="__codelineno-5-391" name="__codelineno-5-391"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">denom</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)))</span>
<a id="__codelineno-5-392" name="__codelineno-5-392"></a>    <span class="n">miou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-5-393" name="__codelineno-5-393"></a>
<a id="__codelineno-5-394" name="__codelineno-5-394"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_loss</span> <span class="o">/</span> <span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">compute_loss</span> <span class="ow">and</span> <span class="n">batches</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
<a id="__codelineno-5-395" name="__codelineno-5-395"></a>    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">pixel_acc</span><span class="p">,</span> <span class="n">miou</span>
<a id="__codelineno-5-396" name="__codelineno-5-396"></a>
<a id="__codelineno-5-397" name="__codelineno-5-397"></a><span class="c1"># -------------------- å¯è§†åŒ– --------------------</span>
<a id="__codelineno-5-398" name="__codelineno-5-398"></a><span class="k">def</span><span class="w"> </span><span class="nf">decode_segmap</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">void_value</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">void_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
<a id="__codelineno-5-399" name="__codelineno-5-399"></a>    <span class="n">lut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-5-400" name="__codelineno-5-400"></a>    <span class="n">lut</span><span class="p">[:</span><span class="n">nc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">VOC_COLORMAP</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-5-401" name="__codelineno-5-401"></a>    <span class="n">lut</span><span class="p">[</span><span class="n">void_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">void_color</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-5-402" name="__codelineno-5-402"></a>    <span class="k">return</span> <span class="n">lut</span><span class="p">[</span><span class="n">image</span><span class="p">]</span>
<a id="__codelineno-5-403" name="__codelineno-5-403"></a>
<a id="__codelineno-5-404" name="__codelineno-5-404"></a><span class="k">def</span><span class="w"> </span><span class="nf">denormalize</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
<a id="__codelineno-5-405" name="__codelineno-5-405"></a>    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">])</span>
<a id="__codelineno-5-406" name="__codelineno-5-406"></a>    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
<a id="__codelineno-5-407" name="__codelineno-5-407"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-408" name="__codelineno-5-408"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">mean</span>
<a id="__codelineno-5-409" name="__codelineno-5-409"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-410" name="__codelineno-5-410"></a>
<a id="__codelineno-5-411" name="__codelineno-5-411"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-5-412" name="__codelineno-5-412"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_predictions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">VIS_DIR</span><span class="p">,</span> <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
<a id="__codelineno-5-413" name="__codelineno-5-413"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-414" name="__codelineno-5-414"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-5-415" name="__codelineno-5-415"></a>    <span class="n">shown</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-416" name="__codelineno-5-416"></a>
<a id="__codelineno-5-417" name="__codelineno-5-417"></a>    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
<a id="__codelineno-5-418" name="__codelineno-5-418"></a>        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-5-419" name="__codelineno-5-419"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-5-420" name="__codelineno-5-420"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-5-421" name="__codelineno-5-421"></a>
<a id="__codelineno-5-422" name="__codelineno-5-422"></a>        <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-5-423" name="__codelineno-5-423"></a>        <span class="n">images_cpu</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-5-424" name="__codelineno-5-424"></a>        <span class="n">targets_np</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-5-425" name="__codelineno-5-425"></a>
<a id="__codelineno-5-426" name="__codelineno-5-426"></a>        <span class="n">bsz</span> <span class="o">=</span> <span class="n">images_cpu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-427" name="__codelineno-5-427"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bsz</span><span class="p">):</span>
<a id="__codelineno-5-428" name="__codelineno-5-428"></a>            <span class="k">if</span> <span class="n">shown</span> <span class="o">&gt;=</span> <span class="n">num_images</span><span class="p">:</span> <span class="k">break</span>
<a id="__codelineno-5-429" name="__codelineno-5-429"></a>
<a id="__codelineno-5-430" name="__codelineno-5-430"></a>            <span class="n">original_img</span> <span class="o">=</span> <span class="n">denormalize</span><span class="p">(</span><span class="n">images_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-5-431" name="__codelineno-5-431"></a>            <span class="n">gt_mask_rgb</span> <span class="o">=</span> <span class="n">decode_segmap</span><span class="p">(</span><span class="n">targets_np</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-5-432" name="__codelineno-5-432"></a>            <span class="n">pred_mask_rgb</span> <span class="o">=</span> <span class="n">decode_segmap</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-5-433" name="__codelineno-5-433"></a>
<a id="__codelineno-5-434" name="__codelineno-5-434"></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-5-435" name="__codelineno-5-435"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original_img</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Original"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-5-436" name="__codelineno-5-436"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gt_mask_rgb</span><span class="p">);</span>  <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Ground Truth"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-5-437" name="__codelineno-5-437"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred_mask_rgb</span><span class="p">);</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Prediction"</span><span class="p">);</span>   <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-5-438" name="__codelineno-5-438"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original_img</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred_mask_rgb</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">overlay_alpha</span><span class="p">)</span>
<a id="__codelineno-5-439" name="__codelineno-5-439"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Overlay"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-5-440" name="__codelineno-5-440"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-5-441" name="__codelineno-5-441"></a>
<a id="__codelineno-5-442" name="__codelineno-5-442"></a>            <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'result_</span><span class="si">{</span><span class="n">shown</span><span class="si">:</span><span class="s1">03d</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
<a id="__codelineno-5-443" name="__codelineno-5-443"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
<a id="__codelineno-5-444" name="__codelineno-5-444"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<a id="__codelineno-5-445" name="__codelineno-5-445"></a>            <span class="n">shown</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-446" name="__codelineno-5-446"></a>        <span class="k">if</span> <span class="n">shown</span> <span class="o">&gt;=</span> <span class="n">num_images</span><span class="p">:</span> <span class="k">break</span>
<a id="__codelineno-5-447" name="__codelineno-5-447"></a>
<a id="__codelineno-5-448" name="__codelineno-5-448"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"å¯è§†åŒ–ç»“æœä¿å­˜åœ¨: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">ï¼ˆå…± </span><span class="si">{</span><span class="n">shown</span><span class="si">}</span><span class="s2"> å¼ ï¼‰"</span><span class="p">)</span>
<a id="__codelineno-5-449" name="__codelineno-5-449"></a>
<a id="__codelineno-5-450" name="__codelineno-5-450"></a><span class="c1"># -------------------- å‡†å¤‡æ•°æ®ä¸æ¨¡å‹ --------------------</span>
<a id="__codelineno-5-451" name="__codelineno-5-451"></a><span class="c1"># è®­ç»ƒé›†ï¼šVOC2007 trainval + VOC2012 trainï¼ˆè‹¥ 2007 ä¸å¯ç”¨ï¼Œåˆ™ä»… 2012ï¼‰</span>
<a id="__codelineno-5-452" name="__codelineno-5-452"></a><span class="n">train_sets</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-453" name="__codelineno-5-453"></a>
<a id="__codelineno-5-454" name="__codelineno-5-454"></a><span class="c1"># VOC2007 trainvalï¼ˆè‹¥å­˜åœ¨åˆ†å‰²æ ‡æ³¨ï¼‰</span>
<a id="__codelineno-5-455" name="__codelineno-5-455"></a><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT</span><span class="p">):</span>
<a id="__codelineno-5-456" name="__codelineno-5-456"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-457" name="__codelineno-5-457"></a>        <span class="n">train_07</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-5-458" name="__codelineno-5-458"></a>            <span class="n">VOC2007_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'trainval'</span><span class="p">,</span>
<a id="__codelineno-5-459" name="__codelineno-5-459"></a>            <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>  <span class="c1"># å·²é»˜è®¤å…³é—­å™ªå£°</span>
<a id="__codelineno-5-460" name="__codelineno-5-460"></a>            <span class="n">strict</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-5-461" name="__codelineno-5-461"></a>        <span class="p">)</span>
<a id="__codelineno-5-462" name="__codelineno-5-462"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-463" name="__codelineno-5-463"></a>            <span class="n">train_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span>
<a id="__codelineno-5-464" name="__codelineno-5-464"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"VOC2007 trainval å¯ç”¨: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span><span class="si">}</span><span class="s2"> æ ·æœ¬"</span><span class="p">)</span>
<a id="__codelineno-5-465" name="__codelineno-5-465"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-466" name="__codelineno-5-466"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">"VOC2007 trainval æ— å¯ç”¨åˆ†å‰²æ ·æœ¬ï¼Œè·³è¿‡ 2007ã€‚"</span><span class="p">)</span>
<a id="__codelineno-5-467" name="__codelineno-5-467"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-5-468" name="__codelineno-5-468"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"åŠ è½½ VOC2007 å¤±è´¥ï¼Œè·³è¿‡ï¼š</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-469" name="__codelineno-5-469"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-470" name="__codelineno-5-470"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"æœªæ‰¾åˆ° VOC2007 è·¯å¾„ï¼š</span><span class="si">{</span><span class="n">VOC2007_ROOT</span><span class="si">}</span><span class="s2">ï¼ˆå°†ä»…ä½¿ç”¨ VOC2012 è®­ç»ƒï¼‰"</span><span class="p">)</span>
<a id="__codelineno-5-471" name="__codelineno-5-471"></a>
<a id="__codelineno-5-472" name="__codelineno-5-472"></a><span class="c1"># VOC2012 train</span>
<a id="__codelineno-5-473" name="__codelineno-5-473"></a><span class="n">train_12</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-5-474" name="__codelineno-5-474"></a>    <span class="n">VOC2012_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'train'</span><span class="p">,</span>
<a id="__codelineno-5-475" name="__codelineno-5-475"></a>    <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>  <span class="c1"># å·²é»˜è®¤å…³é—­å™ªå£°</span>
<a id="__codelineno-5-476" name="__codelineno-5-476"></a>    <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-5-477" name="__codelineno-5-477"></a><span class="p">)</span>
<a id="__codelineno-5-478" name="__codelineno-5-478"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"VOC2012 train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_12</span><span class="p">)</span><span class="si">}</span><span class="s2"> æ ·æœ¬"</span><span class="p">)</span>
<a id="__codelineno-5-479" name="__codelineno-5-479"></a><span class="n">train_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_12</span><span class="p">)</span>
<a id="__codelineno-5-480" name="__codelineno-5-480"></a>
<a id="__codelineno-5-481" name="__codelineno-5-481"></a><span class="c1"># åˆå¹¶è®­ç»ƒé›†</span>
<a id="__codelineno-5-482" name="__codelineno-5-482"></a><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_sets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-5-483" name="__codelineno-5-483"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-484" name="__codelineno-5-484"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-485" name="__codelineno-5-485"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">ConcatDataset</span><span class="p">(</span><span class="n">train_sets</span><span class="p">)</span>
<a id="__codelineno-5-486" name="__codelineno-5-486"></a>
<a id="__codelineno-5-487" name="__codelineno-5-487"></a><span class="c1"># éªŒè¯ï¼šVOC2012 val</span>
<a id="__codelineno-5-488" name="__codelineno-5-488"></a><span class="n">val_dataset_voc</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-5-489" name="__codelineno-5-489"></a>    <span class="n">VOC2012_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'val'</span><span class="p">,</span>
<a id="__codelineno-5-490" name="__codelineno-5-490"></a>    <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>
<a id="__codelineno-5-491" name="__codelineno-5-491"></a>    <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-5-492" name="__codelineno-5-492"></a><span class="p">)</span>
<a id="__codelineno-5-493" name="__codelineno-5-493"></a>
<a id="__codelineno-5-494" name="__codelineno-5-494"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<a id="__codelineno-5-495" name="__codelineno-5-495"></a>    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-5-496" name="__codelineno-5-496"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-5-497" name="__codelineno-5-497"></a><span class="p">)</span>
<a id="__codelineno-5-498" name="__codelineno-5-498"></a><span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<a id="__codelineno-5-499" name="__codelineno-5-499"></a>    <span class="n">val_dataset_voc</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">VAL_BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-5-500" name="__codelineno-5-500"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-5-501" name="__codelineno-5-501"></a><span class="p">)</span>
<a id="__codelineno-5-502" name="__codelineno-5-502"></a>
<a id="__codelineno-5-503" name="__codelineno-5-503"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"è®­ç»ƒé›†æ€»æ ·æœ¬æ•°: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-504" name="__codelineno-5-504"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"éªŒè¯é›†æ ·æœ¬æ•° (VOC2012 val): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset_voc</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-505" name="__codelineno-5-505"></a>
<a id="__codelineno-5-506" name="__codelineno-5-506"></a><span class="n">model</span> <span class="o">=</span> <span class="n">UNetVGG16</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">NUM_CLASSES</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-5-507" name="__codelineno-5-507"></a><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">ignore_index</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-5-508" name="__codelineno-5-508"></a>
<a id="__codelineno-5-509" name="__codelineno-5-509"></a><span class="c1"># å‚æ•°åˆ†ç»„ + poly å­¦ä¹ ç‡</span>
<a id="__codelineno-5-510" name="__codelineno-5-510"></a><span class="n">base_lr</span> <span class="o">=</span> <span class="n">LEARNING_RATE</span>
<a id="__codelineno-5-511" name="__codelineno-5-511"></a><span class="n">new_lr</span>  <span class="o">=</span> <span class="n">LEARNING_RATE</span> <span class="o">*</span> <span class="mi">10</span>
<a id="__codelineno-5-512" name="__codelineno-5-512"></a>
<a id="__codelineno-5-513" name="__codelineno-5-513"></a><span class="c1"># é¢„è®­ç»ƒçš„ç¼–ç å™¨ï¼ˆVGG16 featuresï¼‰</span>
<a id="__codelineno-5-514" name="__codelineno-5-514"></a><span class="n">encoder_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conv1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">conv2</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">conv3</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">conv4</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">conv5</span><span class="p">]</span>
<a id="__codelineno-5-515" name="__codelineno-5-515"></a>
<a id="__codelineno-5-516" name="__codelineno-5-516"></a><span class="c1"># æ–°åˆå§‹åŒ–çš„è§£ç å™¨ä¸è¾“å‡ºå±‚</span>
<a id="__codelineno-5-517" name="__codelineno-5-517"></a><span class="n">new_modules</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-5-518" name="__codelineno-5-518"></a>    <span class="n">model</span><span class="o">.</span><span class="n">up4</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dec4</span><span class="p">,</span>
<a id="__codelineno-5-519" name="__codelineno-5-519"></a>    <span class="n">model</span><span class="o">.</span><span class="n">up3</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dec3</span><span class="p">,</span>
<a id="__codelineno-5-520" name="__codelineno-5-520"></a>    <span class="n">model</span><span class="o">.</span><span class="n">up2</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dec2</span><span class="p">,</span>
<a id="__codelineno-5-521" name="__codelineno-5-521"></a>    <span class="n">model</span><span class="o">.</span><span class="n">up1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dec1</span><span class="p">,</span>
<a id="__codelineno-5-522" name="__codelineno-5-522"></a>    <span class="n">model</span><span class="o">.</span><span class="n">out_conv</span>
<a id="__codelineno-5-523" name="__codelineno-5-523"></a><span class="p">]</span>
<a id="__codelineno-5-524" name="__codelineno-5-524"></a>
<a id="__codelineno-5-525" name="__codelineno-5-525"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">([</span>
<a id="__codelineno-5-526" name="__codelineno-5-526"></a>    <span class="p">{</span><span class="s1">'params'</span><span class="p">:</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">encoder_modules</span><span class="p">)),</span> <span class="s1">'lr'</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">},</span>
<a id="__codelineno-5-527" name="__codelineno-5-527"></a>    <span class="p">{</span><span class="s1">'params'</span><span class="p">:</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">new_modules</span><span class="p">)),</span> <span class="s1">'lr'</span><span class="p">:</span> <span class="n">new_lr</span><span class="p">},</span>
<a id="__codelineno-5-528" name="__codelineno-5-528"></a><span class="p">],</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">WEIGHT_DECAY</span><span class="p">)</span>
<a id="__codelineno-5-529" name="__codelineno-5-529"></a>
<a id="__codelineno-5-530" name="__codelineno-5-530"></a><span class="n">max_iter</span> <span class="o">=</span> <span class="n">EPOCHS</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<a id="__codelineno-5-531" name="__codelineno-5-531"></a><span class="k">def</span><span class="w"> </span><span class="nf">poly_lr_lambda</span><span class="p">(</span><span class="n">it_idx</span><span class="p">):</span>
<a id="__codelineno-5-532" name="__codelineno-5-532"></a>    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">it_idx</span> <span class="o">/</span> <span class="n">max_iter</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.9</span>
<a id="__codelineno-5-533" name="__codelineno-5-533"></a>
<a id="__codelineno-5-534" name="__codelineno-5-534"></a><span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">LambdaLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_lambda</span><span class="o">=</span><span class="n">poly_lr_lambda</span><span class="p">)</span>
<a id="__codelineno-5-535" name="__codelineno-5-535"></a>
<a id="__codelineno-5-536" name="__codelineno-5-536"></a><span class="c1"># AMP Scalerï¼ˆå›ºå®š cudaï¼‰</span>
<a id="__codelineno-5-537" name="__codelineno-5-537"></a><span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="s1">'cuda'</span><span class="p">)</span>
<a id="__codelineno-5-538" name="__codelineno-5-538"></a>
<a id="__codelineno-5-539" name="__codelineno-5-539"></a><span class="c1"># è®°å½•ä¸ä¿å­˜</span>
<a id="__codelineno-5-540" name="__codelineno-5-540"></a><span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'train_loss'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_loss'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_pa'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_miou'</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-5-541" name="__codelineno-5-541"></a><span class="n">best_miou_voc</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<a id="__codelineno-5-542" name="__codelineno-5-542"></a><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-543" name="__codelineno-5-543"></a>
<a id="__codelineno-5-544" name="__codelineno-5-544"></a><span class="c1"># -------------------- è®­ç»ƒå¾ªç¯ --------------------</span>
<a id="__codelineno-5-545" name="__codelineno-5-545"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"å¼€å§‹è®­ç»ƒ..."</span><span class="p">)</span>
<a id="__codelineno-5-546" name="__codelineno-5-546"></a><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-5-547" name="__codelineno-5-547"></a>
<a id="__codelineno-5-548" name="__codelineno-5-548"></a><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
<a id="__codelineno-5-549" name="__codelineno-5-549"></a>    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_one_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">)</span>
<a id="__codelineno-5-550" name="__codelineno-5-550"></a>
<a id="__codelineno-5-551" name="__codelineno-5-551"></a>    <span class="n">val_loss_voc</span><span class="p">,</span> <span class="n">val_pa_voc</span><span class="p">,</span> <span class="n">val_miou_voc</span> <span class="o">=</span> <span class="n">evaluate_fast</span><span class="p">(</span>
<a id="__codelineno-5-552" name="__codelineno-5-552"></a>        <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">,</span>
<a id="__codelineno-5-553" name="__codelineno-5-553"></a>        <span class="n">compute_loss</span><span class="o">=</span><span class="n">EVAL_COMPUTE_LOSS</span><span class="p">,</span>
<a id="__codelineno-5-554" name="__codelineno-5-554"></a>        <span class="n">max_batches</span><span class="o">=</span><span class="n">EVAL_MAX_BATCHES</span><span class="p">,</span>
<a id="__codelineno-5-555" name="__codelineno-5-555"></a>        <span class="n">max_images</span><span class="o">=</span><span class="n">EVAL_MAX_IMAGES</span><span class="p">,</span>
<a id="__codelineno-5-556" name="__codelineno-5-556"></a>        <span class="n">progress</span><span class="o">=</span><span class="n">EVAL_PROGRESS</span>
<a id="__codelineno-5-557" name="__codelineno-5-557"></a>    <span class="p">)</span>
<a id="__codelineno-5-558" name="__codelineno-5-558"></a>
<a id="__codelineno-5-559" name="__codelineno-5-559"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'train_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
<a id="__codelineno-5-560" name="__codelineno-5-560"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss_voc</span><span class="p">)</span>
<a id="__codelineno-5-561" name="__codelineno-5-561"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_pa'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_pa_voc</span><span class="p">)</span>
<a id="__codelineno-5-562" name="__codelineno-5-562"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_miou'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_miou_voc</span><span class="p">)</span>
<a id="__codelineno-5-563" name="__codelineno-5-563"></a>
<a id="__codelineno-5-564" name="__codelineno-5-564"></a>    <span class="k">if</span> <span class="n">val_miou_voc</span> <span class="o">&gt;</span> <span class="n">best_miou_voc</span><span class="p">:</span>
<a id="__codelineno-5-565" name="__codelineno-5-565"></a>        <span class="n">best_miou_voc</span> <span class="o">=</span> <span class="n">val_miou_voc</span>
<a id="__codelineno-5-566" name="__codelineno-5-566"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
<a id="__codelineno-5-567" name="__codelineno-5-567"></a>            <span class="s1">'epoch'</span><span class="p">:</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-5-568" name="__codelineno-5-568"></a>            <span class="s1">'model_state'</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<a id="__codelineno-5-569" name="__codelineno-5-569"></a>            <span class="s1">'optimizer_state'</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<a id="__codelineno-5-570" name="__codelineno-5-570"></a>            <span class="s1">'miou_voc'</span><span class="p">:</span> <span class="n">best_miou_voc</span><span class="p">,</span>
<a id="__codelineno-5-571" name="__codelineno-5-571"></a>            <span class="s1">'config'</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-5-572" name="__codelineno-5-572"></a>                <span class="s1">'base_lr'</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">,</span> <span class="s1">'new_lr'</span><span class="p">:</span> <span class="n">new_lr</span><span class="p">,</span> <span class="s1">'weight_decay'</span><span class="p">:</span> <span class="n">WEIGHT_DECAY</span><span class="p">,</span>
<a id="__codelineno-5-573" name="__codelineno-5-573"></a>                <span class="s1">'epochs'</span><span class="p">:</span> <span class="n">EPOCHS</span><span class="p">,</span> <span class="s1">'batch_size'</span><span class="p">:</span> <span class="n">BATCH_SIZE</span>
<a id="__codelineno-5-574" name="__codelineno-5-574"></a>            <span class="p">}</span>
<a id="__codelineno-5-575" name="__codelineno-5-575"></a>        <span class="p">},</span> <span class="n">BEST_PATH_VOC</span><span class="p">)</span>
<a id="__codelineno-5-576" name="__codelineno-5-576"></a>
<a id="__codelineno-5-577" name="__codelineno-5-577"></a>    <span class="n">val_loss_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val_loss_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">EVAL_COMPUTE_LOSS</span> <span class="k">else</span> <span class="s2">"n/a"</span>
<a id="__codelineno-5-578" name="__codelineno-5-578"></a>    <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-5-579" name="__codelineno-5-579"></a>        <span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">EPOCHS</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-5-580" name="__codelineno-5-580"></a>        <span class="sa">f</span><span class="s2">"Train Loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-5-581" name="__codelineno-5-581"></a>        <span class="sa">f</span><span class="s2">"VOC Val: Loss </span><span class="si">{</span><span class="n">val_loss_str</span><span class="si">}</span><span class="s2">, PA </span><span class="si">{</span><span class="n">val_pa_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, mIoU </span><span class="si">{</span><span class="n">val_miou_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-5-582" name="__codelineno-5-582"></a>        <span class="sa">f</span><span class="s2">"Best VOC mIoU: </span><span class="si">{</span><span class="n">best_miou_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-5-583" name="__codelineno-5-583"></a>    <span class="p">)</span>
<a id="__codelineno-5-584" name="__codelineno-5-584"></a>
<a id="__codelineno-5-585" name="__codelineno-5-585"></a><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-5-586" name="__codelineno-5-586"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">è®­ç»ƒå®Œæˆï¼æ€»è€—æ—¶: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> åˆ†é’Ÿ"</span><span class="p">)</span>
<a id="__codelineno-5-587" name="__codelineno-5-587"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- æœ€ç»ˆè¯„ä¼°æŒ‡æ ‡ (VOC2012 val) ---"</span><span class="p">)</span>
<a id="__codelineno-5-588" name="__codelineno-5-588"></a><span class="n">final_loss_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">EVAL_COMPUTE_LOSS</span> <span class="k">else</span> <span class="s2">"n/a"</span>
<a id="__codelineno-5-589" name="__codelineno-5-589"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Val Loss: </span><span class="si">{</span><span class="n">final_loss_str</span><span class="si">}</span><span class="s2"> | PA: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_pa'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | mIoU: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_miou'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-590" name="__codelineno-5-590"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"æœ€ä¼˜æƒé‡å·²ä¿å­˜è‡³: </span><span class="si">{</span><span class="n">BEST_PATH_VOC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-591" name="__codelineno-5-591"></a>
<a id="__codelineno-5-592" name="__codelineno-5-592"></a><span class="c1"># ä¿å­˜å½“å‰ï¼ˆlatestï¼‰</span>
<a id="__codelineno-5-593" name="__codelineno-5-593"></a><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">LATEST_PATH</span><span class="p">)</span>
<a id="__codelineno-5-594" name="__codelineno-5-594"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"å·²ä¿å­˜å½“å‰æ¨¡å‹æƒé‡åˆ°: </span><span class="si">{</span><span class="n">LATEST_PATH</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-595" name="__codelineno-5-595"></a>
<a id="__codelineno-5-596" name="__codelineno-5-596"></a><span class="c1"># åŠ è½½æœ€ä¼˜æƒé‡ç”¨äºå¯è§†åŒ–</span>
<a id="__codelineno-5-597" name="__codelineno-5-597"></a><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">BEST_PATH_VOC</span><span class="p">):</span>
<a id="__codelineno-5-598" name="__codelineno-5-598"></a>    <span class="n">ckpt_voc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">BEST_PATH_VOC</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">))</span>
<a id="__codelineno-5-599" name="__codelineno-5-599"></a>    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">ckpt_voc</span><span class="p">[</span><span class="s1">'model_state'</span><span class="p">])</span>
<a id="__codelineno-5-600" name="__codelineno-5-600"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">å·²åŠ è½½ VOC æœ€ä¼˜æƒé‡è¿›è¡Œå¯è§†åŒ–: </span><span class="si">{</span><span class="n">BEST_PATH_VOC</span><span class="si">}</span><span class="s2"> (epoch=</span><span class="si">{</span><span class="n">ckpt_voc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'epoch'</span><span class="p">,</span><span class="s1">'?'</span><span class="p">)</span><span class="si">}</span><span class="s2">, mIoU_VOC=</span><span class="si">{</span><span class="n">ckpt_voc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'miou_voc'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
<a id="__codelineno-5-601" name="__codelineno-5-601"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-602" name="__codelineno-5-602"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">æœªæ‰¾åˆ° VOC æœ€ä¼˜æƒé‡ï¼Œä½¿ç”¨å½“å‰æ¨¡å‹è¿›è¡Œå¯è§†åŒ–ã€‚"</span><span class="p">)</span>
<a id="__codelineno-5-603" name="__codelineno-5-603"></a>
<a id="__codelineno-5-604" name="__codelineno-5-604"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- å¯è§†åŒ–é¢„æµ‹ç»“æœ (VOC2012 val) ---"</span><span class="p">)</span>
<a id="__codelineno-5-605" name="__codelineno-5-605"></a><span class="n">visualize_predictions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">VIS_DIR</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h4 id="_9">ç»“æœ<a class="headerlink" href="#_9" title="Permanent link">Â¶</a></h4>
<p>åœ¨ Pascal VOC 07+12 ä¸Šè®­ç»ƒ 80 ä¸ª Epochï¼Œè€—æ—¶ 19332sï¼Œæœ€åçš„ mIoU ä¸º 0.5342ã€‚è¯¶ï¼Œæ‚¨åˆ«ç§è¿™ mIoU è¿˜æ‰“ä¸è¿‡ FCN-8sï¼Œé‚£è¾¹å¯æ˜¯ç”¨ä¸Šäº† VGG é¢„è®­ç»ƒå‚æ•°çš„å¤§å¤´â€”â€”ä¹Ÿå°±æ˜¯ pool5 ä¹‹åçš„ä¸¤ä¸ªçº¿æ€§å±‚å•Šï¼</p>
<p><img alt="alt text" src="../image-28.png"/></p>
<p>ä¸‹é¢æ˜¯å‡ ä¸ªæ ·ä¾‹å›¾åƒï¼š</p>
<p><img alt="alt text" src="../image-29.png"/></p>
<p><img alt="alt text" src="../image-30.png"/></p>
<p><img alt="alt text" src="../image-31.png"/></p>
<h3 id="_10">ç¢ç¢å¿µ<a class="headerlink" href="#_10" title="Permanent link">Â¶</a></h3>
<p>è®°å¾—å½“æ—¶å­¦æ•°å­—é€»è¾‘çš„æ—¶å€™ï¼Œè€æ˜¯æœ‰é¢˜ç›®æ¥è€ƒå¯Ÿå¤šè·¯é€‰æ‹©å™¨ MUXï¼Œä¹Ÿå°±æ˜¯æ ¹æ® n ä¸ªè¾“å…¥ç«¯é«˜ä½ç”µå¹³ï¼ŒæŠŠå®ƒçœ‹ä½œä¸€ä¸ªäºŒè¿›åˆ¶æ•° xï¼Œä»è€Œæ¿€æ´»ç¬¬ x ä¸ªè¾“å‡ºç«¯ã€‚è¿™ç§é¢˜ç›®ä¸€èˆ¬ä¸ä¼šè®©å¤šè·¯é€‰æ‹©å™¨åšè‡ªå·±çš„æœ¬èŒå·¥ä½œï¼Œè€Œæ˜¯åˆ©ç”¨è‡ªå·±å¯ä»¥è¿›è¡Œä»äºŒè¿›åˆ¶ç¼–ç åˆ°é€»è¾‘æœ€å°é¡¹çš„â€œè¯‘ç â€æ¥å¹²èŠ±æ´»â€”â€”æ¯”å¦‚æ“ä¸€ä¸ªå…¨åŠ å™¨ã€‚</p>
<p>å…¶å®å…¨å·ç§¯æ¶æ„ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å•çº¯åšè¯­ä¹‰åˆ†å‰²ï¼Œè¿˜æ˜¯å¤ªé™åˆ¶å®ƒçš„å‘æŒ¥äº†ã€‚äº‹å®ä¸Šå®ƒå±•ç¤ºäº†ä¸€ç§<strong>åƒç´ çº§çš„ç¼–ç å™¨â€”â€”è§£ç å™¨</strong>çš„é€šç”¨æ¶æ„ï¼Œä»è€Œå¯ä»¥ç”¨åœ¨å„ç§<strong>ç”Ÿæˆå¼ä»»åŠ¡</strong>ä¸Šé¢ã€‚æ— è®ºæ˜¯ VAE è¿˜æ˜¯ DC-GANï¼Œæˆ‘ä»¬éƒ½åœ¨å…¶ä¸­çœ‹åˆ°äº†åå·ç§¯çš„åº”ç”¨ï¼›è€Œå¤§åé¼é¼çš„ DDPMï¼Œå…¶ç”Ÿæˆæ­£æ˜¯ä½¿ç”¨äº† U-Net æ¶æ„ã€‚</p>
<h2 id="_11">ç›®æ ‡æ£€æµ‹<a class="headerlink" href="#_11" title="Permanent link">Â¶</a></h2>
<p>ç›®æ ‡æ£€æµ‹çš„çš„ç›®çš„åœ¨äº<strong>æ‰“ç›®æ ‡æ¡†</strong>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img alt="SCP-CN-2999" src="../image-27.png"/></p>
<p>å¦‚ä½•ç”Ÿæˆè¿™ä¸€ç›®æ ‡æ¡†å‘¢ï¼Ÿå¤æ—©çš„ç†è®º R-CNN è®¤ä¸ºï¼šæˆ‘ä»¬å·²ç»æœ‰äº†å¼ºå¤§çš„å›¾åƒ<strong>åˆ†ç±»ç½‘ç»œ</strong>äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ¯æ¬¡é€‰å–å›¾åƒçš„ä¸€éƒ¨åˆ†ä¸¢ç»™åˆ†ç±»ç½‘ç»œï¼Œå†å–é¢„æµ‹æ¦‚ç‡æœ€é«˜çš„é‚£ä¸ªæ¡†å³å¯ã€‚è¿™æ ·åšç¡®å®å¾ˆæœ‰é“ç†ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªå¾ˆå¤§çš„å›¾åƒï¼Œæ¯”å¦‚æˆ‘çš„ç›¸æœºæ‹æ‘„çš„ 5424x3612 çš„ä¸‹é¢è¿™å¼ å›¾åƒï¼š</p>
<p><img alt="alt text" src="../IMG_20250503_234053.jpg"/></p>
<p>å¦‚æœè¿˜æ˜¯ç”¨ R-CNN çš„æ–¹æ³•åšï¼Œéš¾ç‚¹åœ¨äºï¼šå·²çŸ¥ R-CNN åœ¨ ImageNet çš„ 224x224 ä¸Šé¢éƒ½è¦ç”Ÿæˆæ¥è¿‘ 2000 ä¸ªæ¡†ï¼Œé‚£ä¹ˆè€ƒè™‘è¿™ä¸ªå›¾åˆ‡å¼€æˆ 224x224 çš„å—ï¼Œä¸€å…±å°±è¦ç”Ÿæˆ 780910 ä¸ªæ¡†ï¼å‡è®¾æ¯ä¸ªæ¡†æ¨ç†æ—¶é—´ 1msï¼Œä¸”å…¨éƒ¨éƒ½èƒ½ä»¥æ‰¹é‡ 128 æ•°æ®å¹¶è¡Œï¼Œä»ç„¶éœ€è¦ 6s æ‰èƒ½å®ŒæˆåŸºç¡€çš„æ¨ç†ï¼Œè€Œä¸”è¿™è¿˜ä¸åŒ…å«åç»­çš„ NMS ç­‰æ“ä½œã€‚åœ¨åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼ŒYOLO v1 æŠŠæ¡†çš„æ•°é‡å‹ç¼©åˆ°äº† 38265 ä¸ªï¼ˆæŒ‰æ¯ä¸ª cell 32px ç®—ï¼‰ï¼Œä¹Ÿå°±æ˜¯ R-CNN çš„äºŒååˆ†ä¹‹ä¸€ã€‚ä¹Ÿå°±æ˜¯è¯´ 0.3s å°±å¯ä»¥å‡ºå›¾ï¼Œè¿™å°±ä½¿å¾—<strong>å®æ—¶</strong>ç›®æ ‡æ£€æµ‹æˆä¸ºå¯èƒ½ã€‚</p>
<p><img alt="alt text" src="../image-33.png"/></p>
<p>ï¼ˆç•ªå¤–ï¼šSCP-CN-2999 æ˜¯æˆ‘å¿ƒç›®ä¸­çš„ä¸­åˆ†åä½³æ–‡æ¡£ä¹‹ä¸€ã€‚å¦‚æœä½ åŒçƒ¦äº†å¯¹äººå·¥æ™ºèƒ½çš„å¼—æ´›è‚¯æ–¯å¦å™äº‹ï¼Œå¹¶è®¤ä¸ºé‚£äº›äººä¸äººå·¥æ™ºèƒ½åˆä½œå…±ç”Ÿçš„ç‚¹å­æ˜¯é˜¿è¥¿è«å¤«æ—¶ä»£å°±ç©çƒ‚äº†çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆæ¬¢è¿é˜…è¯»<a href="https://scp-wiki-cn.wikidot.com/scp-cn-2999">è¿™ç¯‡æ–‡æ¡£</a>ã€‚ï¼‰</p>
<p>æœ¬æ–‡å¯¹ç›®æ ‡æ£€æµ‹æ¨¡å‹åªä»‹ç» YOLO æ¨¡å‹ã€‚</p>
<h3 id="yolo-v1">YOLO v1<a class="headerlink" href="#yolo-v1" title="Permanent link">Â¶</a></h3>
<h4 id="_12">æ¨¡å‹æ¶æ„<a class="headerlink" href="#_12" title="Permanent link">Â¶</a></h4>
<p>é‚£ä¹ˆï¼ŒYOLO é‡‡ç”¨äº†ä»€ä¹ˆæ–¹æ³•æ¥ç¼©å‡ç›®æ ‡æ¡†å‘¢ï¼Ÿä¸åƒ R-CNN ä¸€æ ·é€‰æ‹©å…ˆå­¦ä¹ ç›®æ ‡æ¡†çš„ä½ç½®åˆ†å¸ƒå†å¯å‘å¼åœ°æœå¯»ï¼ŒYOLO é€‰æ‹©<strong>ç«¯åˆ°ç«¯</strong>çš„æ–¹å¼è·å¾—ç›®æ ‡æ¡†ã€‚æ¯”å¦‚æœ‰ä¸€å¼  224x224 çš„ ImageNet å›¾åƒï¼Œæˆ‘ä»¬é¦–å…ˆå¯ä»¥åˆ’åˆ†ä¸€ä¸ª 7x7 çš„ç½‘æ ¼ï¼Œæ¯ä¸ªå°æ ¼å­çš„è¾¹é•¿æ˜¯ 32pxã€‚å¯¹äºè¿™ä¸ª 32x32 çš„å°å›¾åƒå¹²ä»€ä¹ˆå‘¢ï¼Ÿéš¾é“æ˜¯åƒ R-CNN ä¸€æ ·ç›´æ¥åˆ†ç±»å—ï¼Ÿä¸ç„¶ã€‚</p>
<p>ä¿—è¯­æœ‰è¨€ï¼Œâ€œç®¡ä¸­çª¥è±¹ï¼Œå¯è§ä¸€æ–‘â€ã€‚æˆ‘ä»¬è€ƒè™‘æŸä¸€ä¸ªç‰©ä½“çš„<strong>ä¸­å¿ƒ</strong>è½å…¥äº†è¿™ä¸ªæ ¼å­é‡Œé¢ï¼Œé‚£ä¹ˆè¿™ä¸ªæ ¼å­å°±å¾ˆå¯èƒ½æœ‰ä¸€éƒ¨åˆ†ä¿¡æ¯çŸ¥é“è¿™ä¸ªç‰©ä½“æ˜¯ä»€ä¹ˆã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºè¿™ä¸ƒä¸ƒå››åä¹ä¸ªæ ¼å­ï¼Œæˆ‘ä»¬è®©æ¯ä¸€ä¸ªæ ¼å­éƒ½æ¥çœ‹çœ‹è½åœ¨æ ¼å­é‡Œçš„æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œä¹Ÿå°±æ˜¯ç»™å‡ºç±»åˆ«çš„é¢„æµ‹æ¦‚ç‡ã€‚å¦ä¸€æ–¹é¢ï¼Œä¸€ä¸ªæ ¼å­çš„ä¿¡æ¯åŸºæœ¬ä¸Šä¹Ÿå·®ä¸å¤šèƒ½è®©æˆ‘ä»¬çŸ¥é“è¿™ä¸ªç‰©ä½“å¤§æ¦‚çš„å°ºå¯¸å¦‚ä½•ï¼Œæ¯”å¦‚è¯´æ ¼å­é‡Œé¢æœ‰ä¸ªäººè„¸ï¼Œé‚£ä¹ˆå¾€ä¸‹ç”»ä¸€ä¸ª6~8å¤´èº«çš„æ¡†åŸºæœ¬ä¸Šå°±æ²¡é”™äº†ã€‚å…·ä½“åˆ°åº•æ˜¯å‡ å¤´èº«ï¼Œæ¨¡å‹ä¸ç¡®å®šï¼Œé‚£å°±å…­å¤´èº«ä¸ƒå¤´èº«å…«å¤´èº«éƒ½è¯•ä¸€ä¸‹ï¼Œå¤šæ‰“å‡ ä¸ªæ¡†ï¼Œæ€»æœ‰ä¸€ä¸ªèƒ½è’™å¯¹ã€‚</p>
<p>è¿™é‡Œå¯èƒ½æœ‰ä¸€ä¸ªè¯¯è§£ï¼ˆæ¯•ç«Ÿè¿™ç§è¯´æ˜å¼çš„è¯­è¨€ä¸ç”šç²¾ç¡®ï¼‰ï¼Œå°±æ˜¯ä¼šä»¥ä¸ºæˆ‘ä»¬<strong>åª</strong>æ ¹æ®æ ¼å­é‡Œé¢çš„ä¸œè¥¿æ¥æ‰“æ¡†ã€‚ä½†å…¶å®ä¸æ˜¯çš„ï¼Œæˆ‘ä»¬ä¸æ˜¯å…ˆç»™å›¾åƒåˆ†å—ç„¶åé™åˆ¶æ¯ä¸€ä¸ªæ ¼å­çš„<strong>æ„Ÿå—é‡</strong>åªåœ¨è¿™ä¸ªæ ¼å­é‡Œé¢ã€‚äº‹å®ä¸Šæˆ‘ä»¬æ˜¯åŸºäºå›¾åƒæ•´ä½“çš„ä¿¡æ¯ï¼Œæœ€åç”Ÿæˆ S x S ä¸ªæ ¼å­å’Œæ¯ä¸ªæ ¼å­çš„ B ä¸ªæ¡†ã€‚ä¹Ÿå°±æ˜¯è¯´æ¨ç®—æ¡†çš„å¤§å°ä»¥åŠè¯¥æ”¾è¿›å“ªä¸ªæ ¼å­éƒ½æ˜¯<strong>éª¨å¹²ç½‘</strong>åº”è¯¥å¹²çš„æ´»ï¼Œå®ƒçš„æ„Ÿå—é‡æ˜¯<strong>æ•´å¼ å›¾åƒ</strong>ã€‚å¦‚æœè¿˜æ˜¯è§‰å¾—å«ç³Šï¼Œè¯·æ¥ç€è¯»ã€‚</p>
<p>ç”¨å½¢å¼åŒ–çš„è¯­è¨€æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæ ¼å­è´Ÿè´£é¢„æµ‹ <span class="arithmatex">\(B\)</span> ä¸ªæ¡†ï¼Œæ¯ä¸ªæ¡†æœ‰ <span class="arithmatex">\(x,y,w,h\)</span> å››ä¸ªå‚æ•°ï¼Œå¯¹åº”æ¡†çš„ä¸­å¿ƒç‚¹ç›¸å¯¹å›¾åƒå·¦ä¸Šè§’çš„åæ ‡ <span class="arithmatex">\(x,y\)</span> ä¸æ¡†çš„å°ºå¯¸ <span class="arithmatex">\(w,h\)</span>ï¼Œè¿™å››ä¸ªå‚æ•°å…¨éƒ¨æ ¹æ®å›¾åƒå°ºå¯¸å½’ä¸€åŒ–åˆ° <span class="arithmatex">\([0,1]\)</span> ä¹‹é—´æ–¹ä¾¿åå‘ä¼ æ’­ã€‚åŒæ—¶ï¼Œæ¡†æ‰“çš„å‡†ä¸å‡†ï¼Œè¿˜éœ€è¦ä¸€ä¸ªç½®ä¿¡åº¦ <span class="arithmatex">\(c\)</span> æ¥è¡¡é‡ã€‚å…·ä½“è§£é‡Šåœ¨ä¸‹ä¸€æ®µã€‚åŒæ—¶ YOLO v1 å‡å®šä¸€ä¸ªæ ¼å­é‡Œé¢åªæœ‰ä¸€ä¸ªç‰©ä½“ï¼Œæ‰€ä»¥è¿˜è¦ç»™å‡ºç‰©ä½“æ‰€å±çš„å„ç±»åˆ«çš„æ¦‚ç‡ï¼ˆä¸‹ä¸€æ®µå†è§£é‡Šï¼‰ã€‚ä»¥åœ¨ Pascal VOC ä¸Šè®­ç»ƒçš„ YOLO v1 æ¥è¯´ï¼Œä¸€å¼ å›¾ç‰‡ç”»æˆ <span class="arithmatex">\(S\times S\)</span> ä¹Ÿå°±æ˜¯ 7x7 çš„ç½‘æ ¼ï¼Œæ¯ä¸ªç½‘æ ¼è´Ÿè´£å¯¹æ ¼å­é‡Œé¢çš„å†…å®¹æ‰“æ¡†ã€‚ä¸€ä¸ªæ ¼å­æ‰“ä¸¤ä¸ªæ¡†ï¼Œè¿˜è´Ÿè´£è¾“å‡º 20 ä¸ªç±»åˆ«ï¼Œé‚£ä¹ˆä¸€ä¸ªæ ¼å­çš„è¾“å‡ºå°±æ˜¯ <span class="arithmatex">\(2\times 5+20=30\)</span> ç»´çš„å‘é‡ï¼Œè€Œæ•´ä¸ªç½‘ç»œçš„è¾“å‡ºå°±æ˜¯ä¸€ä¸ª <code>(7,7,30)</code> çš„å¼ é‡ã€‚</p>
<p>åˆšåˆšæåˆ°æ‰“æ¡†ä½¿ç”¨çš„æ˜¯<strong>ç½®ä¿¡åº¦</strong>ã€‚æˆ‘ä»¬çŸ¥é“æ‰“æ¡†æ— éå°±æ˜¯è¦<strong>æ‰“çš„å‡†</strong>ï¼Œä¸ä»…ä½ç½®è¦å‡†ï¼Œè¯†åˆ«ä¹Ÿè¦å‡†ã€‚ä½ç½®å‡†ä¸å‡†å¾ˆç®€å•ï¼Œåªéœ€è¦ç”¨çœŸå®æ¡†å’Œé¢„æµ‹æ¡†çš„ IoU å°±å¯ä»¥äº†ã€‚è€Œç”±äºä¸€èˆ¬çš„ç½‘ç»œåªèƒ½è¯†åˆ«<strong>ç±»åˆ«æ˜¯ä»€ä¹ˆ</strong>è€Œä¸èƒ½è¯†åˆ«<strong>ç±»åˆ«æ˜¯å¦å­˜åœ¨</strong>ï¼ˆä¹‹å‰çœ‹åˆ°æŸåŒå­¦ç»™ä¸€ä¸ª MNIST åˆ†ç±»å™¨å–‚äº†ä¸€ä¸ªäº”è§’æ˜Ÿï¼Œç„¶åæ¨¡å‹ç…æœ‰ä»‹äº‹åœ°ç»™å‡ºäº†ç±»åˆ« 8 çš„é«˜è¾¾ 99% çš„åˆ†ç±»æ¦‚ç‡ï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬è¿˜éœ€è¦å¼•å…¥ä¸€ä¸ªåˆ¤æ–­æ˜¯å¦å­˜åœ¨å¾…åˆ†ç±»å¯¹è±¡çš„æ¦‚ç‡ <span class="arithmatex">\(P(\mathrm{Obj})\)</span>ï¼Œä¹˜èµ·æ¥å°±å¾—åˆ°<strong>ç½®ä¿¡åº¦</strong>äº†ï¼š<span class="arithmatex">\(c=P(\mathrm{Obj})\times \mathrm{IoU}\)</span>ã€‚è¿™ä»£è¡¨<strong>æ¨¡å‹å¯¹å¾—åˆ°çš„è¿™ä¸ªæ¡†çš„ä¿¡å¿ƒ</strong>ã€‚ä¹Ÿå°±æ˜¯æ¡†é‡Œé¢æœ‰ç‰©ä½“å¹¶ä¸”é¢„æµ‹å’ŒçœŸå®è¶Šæ¥è¿‘ï¼Œè¿™ä¸ªæ¡†å°±è¶Šå¯ä¿¡ã€‚å½“ç„¶è¿™åªæ˜¯æˆ‘ä»¬çš„ä¸€å¢æƒ…æ„¿ï¼Œå…·ä½“çš„ç½®ä¿¡åº¦è¿˜éœ€è¦åå‘ä¼ æ’­æ¥ç®—å‡ºæ¥ã€‚</p>
<p>è€Œç±»åˆ«æ¦‚ç‡å…¶å®æ˜¯ä¸€ä¸ª<strong>æ¡ä»¶æ¦‚ç‡</strong>ï¼Œæ˜¯åœ¨è¿™ä¸ªæ ¼å­é‡Œé¢æœ‰å¯¹è±¡çš„æ¡ä»¶ä¸‹ï¼Œå¯¹å¯¹è±¡ <span class="arithmatex">\(i\)</span> çš„åˆ†ç±»æ¦‚ç‡ <span class="arithmatex">\(P(\mathrm{Class}_i|\mathrm{Obj})\)</span>ã€‚å¯¹äºæ¯ä¸€ä¸ªæ¡†ï¼Œæˆ‘ä»¬æŠŠå®ƒçš„ç½®ä¿¡åº¦ä¹˜ä¸Šåˆ†ç±»æ¦‚ç‡çš„å‘é‡ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªå¾—åˆ†ï¼š<span class="arithmatex">\(s=P(\mathrm{Class}_i|\mathrm{Obj})\times P(\mathrm{Obj})\times \mathrm{IoU}=P(\mathrm{Class}_i\mathrm{\ with\ Obj\ exists})\times \mathrm{IoU}\)</span>ã€‚è¿™ä¸ªå¾—åˆ†ä»£è¡¨äº†å¯¹äºæ¯ä¸€ä¸ªç±»åˆ«ï¼Œæ¨¡å‹å¾—åˆ°çš„æ¡†çš„<strong>è´¨é‡</strong>ã€‚ç†æƒ³æƒ…å†µä¸‹å¯¹äºèƒŒæ™¯æ ¼å­è€Œè¨€ï¼Œ<span class="arithmatex">\(s\)</span> åº”è¯¥æ˜¯å…¨é›¶å‘é‡ï¼›è€Œå¯¹äºä¸­å¿ƒè½åœ¨è¿™ä¸ªæ ¼å­é‡Œé¢çš„çœŸå®çš„æ¡†è€Œè¨€ï¼Œ<span class="arithmatex">\(s\)</span> åº”è¯¥æ˜¯ä¸€ä¸ª one-hot å‘é‡ï¼Œå…¶ä¸­ 1 å¯¹åº”çš„å°±æ˜¯é‚£ä¸ªçœŸå®æ¡†çš„ç±»åˆ«ã€‚è¿™æ ·åœ¨æ¨ç†æ—¶ï¼Œå¯¹äºæ¨¡å‹å¾—åˆ°çš„è¯¸å¤šæ¡†è€Œè¨€ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®å¾—åˆ†æ’åºï¼Œå°±å¯ä»¥ç­›é€‰å‡ºæœ€å¥½çš„é‚£äº›æ¡†äº†ã€‚</p>
<p>â€œæ¯ä¸ªæ ¼å­åªé¢„æµ‹ä¸€ä¸ªç±»åˆ«â€å›ºç„¶ç®€åŒ–äº†æ¨¡å‹ï¼Œä½†ä¹Ÿå¾ˆæœ‰å¯èƒ½å¸¦æ¥ä¿¡æ¯çš„æŸå¤±ï¼Œå…·ä½“è¡¨ç°ä¸ºï¼ŒYOLO v1 åœ¨å°ç‰©ä½“çš„é¢„æµ‹ä¸ŠåŠ›ä¸ä»å¿ƒã€‚å‡è®¾ä¸¤ä¸ªå°ç‰©ä½“éƒ½åŒ…åœ¨ä¸€ä¸ªæ ¼å­é‡Œé¢ï¼Œé‚£è¿™ä¸ªæ ¼å­è¯¥é¢„æµ‹ä»€ä¹ˆå‘¢ï¼Ÿè€Œå¦‚æœæˆ‘ä»¬åŠ ç»†æ ¼å­ï¼Œåˆ™ä¼šå¸¦æ¥å¹³æ–¹çº§çš„å¤æ‚åº¦å¢é•¿ã€‚</p>
<h4 id="_13">æŸå¤±å‡½æ•°<a class="headerlink" href="#_13" title="Permanent link">Â¶</a></h4>
<p>ä¸‹é¢æˆ‘ä»¬éœ€è¦æŒ‡æ ‡æ¥è¯„ä¼°è¿™ä¸ªæ¨¡å‹æ‰“æ¡†çš„è´¨é‡å¦‚ä½•ï¼Œè¿™æ ·æ‰èƒ½è®©æ¨¡å‹åå‘ä¼ æ’­å®ç°è¿›åŒ–ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹æŸå¤±å‡½æ•°ã€‚æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹æ‰“æ¡†çš„å‡ ä¸ªè¦ç´ ï¼šé¦–å…ˆå®šä¸­å¿ƒç‚¹åæ ‡ï¼Œç„¶åç®—æ¡†çš„å°ºå¯¸ï¼Œç»™å‡ºç½®ä¿¡åº¦ï¼Œæœ€åä¸€éƒ¨åˆ†æ˜¯æ¦‚ç‡ã€‚å…¶ä¸­æ¯ä¸€ä¸ªè¦ç´ éƒ½è¦å…¼é¡¾ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬è¦ç¡®å®šå¯¹äºæ¯ä¸€ä¸ªæ ¼å­è€Œè¨€ï¼Œå®ƒçš„æ¡†åœ¨é¢„æµ‹ä»€ä¹ˆã€‚YOLO v1 ä¸ºäº†ç®€åŒ–ï¼Œé¦–å…ˆå¯¹äºæ¯ä¸ªæ ¼å­å…ˆç­›ä¸€éï¼Œæ‰¾åˆ°é‚£ä¸ª<strong>ä¸­å¿ƒç‚¹è½åœ¨è¿™ä¸ªæ ¼å­é‡Œé¢çš„çœŸå®æ¡†</strong>(a ground truth)ï¼Œå¦‚æœæœ‰çœŸå®æ¡†ï¼ˆåŸè®ºæ–‡å«è¿™ä¸ªç‰©ä½“å‡ºç°åœ¨æ ¼å­é‡Œé¢ï¼‰ï¼Œæˆ‘ä»¬ç”¨ <span class="arithmatex">\(1_{i}^\mathrm{obj}\)</span> æ¥æŒ‡ç¤ºæ ¼å­ <span class="arithmatex">\(i\)</span> æœ‰ç‰©ä½“å‡ºç°åœ¨è¿™ä¸ªæ ¼å­é‡Œé¢ã€‚</p>
<p>ä¸‹é¢ï¼Œæ—¢ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªçœŸå®æ¡†ï¼Œå°±å¯ä»¥é€‰<strong>æ ¼å­é‡Œé¢å’Œå®ƒ IoU æœ€å¤§çš„é‚£ä¸ªé¢„æµ‹æ¡†</strong>(the predictor responsible for the ground truth)è¿›è¡Œé…å¯¹ï¼Œæˆ‘ä»¬æŠŠé‚£ä¸ªçœŸå®æ¡†å«åšâ€œç›®æ ‡æ¡†â€(the ground truth)ï¼ˆåŸè®ºæ–‡å«åšè¿™ä¸ªé¢„æµ‹æ¡†è´Ÿè´£è¿™ä¸ªçœŸå®æ¡†ï¼Œä¹Ÿå°±æ˜¯è´Ÿè´£å®ƒçš„ç›®æ ‡æ¡†ï¼‰ã€‚</p>
<p>æˆ‘ä»¬ç”¨æŒ‡æ ‡ <span class="arithmatex">\(1_{ij}^\mathrm{obj}\)</span> è¡¨ç¤ºç¬¬ <span class="arithmatex">\(i\)</span> ä¸ªæ ¼å­çš„ç¬¬ <span class="arithmatex">\(j\)</span> ä¸ªæ¡†å­˜åœ¨ä¸€ä¸ªå¯¹åº”çš„ç›®æ ‡æ¡†ï¼Œè¿™å°±è¯´æ˜è¿™ä¸ªæ¡†æ˜¯å’Œå®ƒæ ¼å­çš„çœŸå®æ¡† IoU æœ€å¤§çš„é‚£ä¸ªæ¡†ã€‚å¦‚æœä¸å­˜åœ¨ç›®æ ‡æ¡†ï¼Œå°±ä½¿ç”¨ <span class="arithmatex">\(1_{ij}^\mathrm{noobj}\)</span> æ¥æŒ‡ç¤ºï¼Œè¯´æ˜å®ƒçš„ IoU ä¸æ˜¯æœ€å¤§çš„ï¼Œæˆ–è€…å®ƒå¯¹åº”çš„æ ¼å­æ ¹æœ¬æ²¡æœ‰çœŸå®æ¡†ã€‚ä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥è®¡ç®—<strong>æ¡†çš„æŸå¤±</strong>ï¼š</p>
<p>å¯¹äºç¬¬ <span class="arithmatex">\(i\)</span> ä¸ªæ ¼å­çš„ç¬¬ <span class="arithmatex">\(j\)</span> ä¸ªæ¡†ï¼Œå…¶ä¸­å¿ƒç‚¹çš„è¯¯å·®ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨é¢„æµ‹æ¡†ä¸­å¿ƒç‚¹åˆ°ç›®æ ‡æ¡†ä¸­å¿ƒç‚¹è·ç¦»æ¨¡é•¿çš„å¹³æ–¹è¡¡é‡ï¼š</p>
<div class="arithmatex">\[
\mathcal{L}_\mathrm{center}=\sum_i^{S^2}\sum_j^{B} 1_{ij}^\mathrm{obj}\left[(x_{ij}-x_{ij}^{\mathrm{true}})^2+(y_{ij}-y_{ij}^{\mathrm{true}})^2\right]
\]</div>
<p>è€Œå°ºå¯¸ä¸Šçš„è¯¯å·®å¦‚æœä»ç„¶æ˜¯ç›´æ¥ç›¸å‡å†æ±‚å¹³æ–¹çš„ç®—æ³•ï¼Œä¼šå¯¼è‡´<strong>ç›¸åŒçš„è¯¯å·®å¯¹å¤§æ¡†çš„æƒ©ç½šä¸åˆç†åœ°å¤§äºå°æ¡†</strong>ï¼Œå› ä¸ºä»è§‚æ„Ÿå’Œå°ºåº¦è€Œè¨€ï¼ŒåŒæ ·æ˜¯ 10px çš„å·®å€¼ï¼Œå¯¹äºå¤§æ¡†è€Œè¨€æ— è¶³è½»é‡ï¼Œå¯¹äºå°æ¡†å´æ˜¯å¾ˆå¤§çš„åç§»ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦æŠŠå¯¹å¤§æ¡†çš„è¡¡é‡å°ºåº¦è°ƒå°è€Œå¯¹å°æ¡†çš„è¡¡é‡å°ºåº¦è°ƒå¤§ã€‚å…¶å® <span class="arithmatex">\(x^{1/p}(p&gt;1)\)</span> å°±èƒ½åšåˆ°è¿™ä¸ªæ˜ å°„ï¼Œåœ¨è®ºæ–‡é‡Œé¢ï¼Œå–åˆ°çš„æ˜¯ <span class="arithmatex">\(p=2\)</span>ã€‚ç°åœ¨å°±å¯ä»¥ç±»ä¼¼åœ°å†™å‡ºå°ºå¯¸çš„æŸå¤±äº†ï¼š</p>
<div class="arithmatex">\[
\mathcal{L}_\mathrm{size}=\sum_i^{S^2}\sum_j^{B}1_{ij}^\mathrm{obj}\left[(\sqrt {w_{ij}}-\sqrt{w_{ij}^{\mathrm{true}}})^2+(\sqrt{h_{ij}}-\sqrt{h_{ij}^{\mathrm{true}}})^2\right]
\]</div>
<p>ä¸‹ä¸€éƒ¨åˆ†æ˜¯ç½®ä¿¡åº¦çš„æŸå¤±ã€‚æˆ‘ä»¬çŸ¥é“å¯¹äºæ¯ä¸€ä¸ªæ¡†ï¼Œç†æƒ³çš„ç½®ä¿¡åº¦å¦‚ä¸‹ï¼š</p>
<div class="arithmatex">\[
c_{ij}^\mathrm{ideal}=\left\{
\begin{align*}
    &amp;\mathrm{IoU}^{\mathrm{true}}_{\mathrm{pred}},&amp;1_{ij}^\mathrm{obj}=1\\
    &amp;0,&amp;1_{ij}^\mathrm{noobj}=1
\end{align*}\right.
\]</div>
<p>è¿™é‡Œçš„ç½®ä¿¡åº¦æŸå¤±çš„å…³é”®æ˜¯è¦<strong>åˆ†è¾¨æ­£ç¡®çš„ç›®æ ‡å’ŒèƒŒæ™¯</strong>ï¼Œå¦‚æœå‰é¢ä¸¤é¡¹æŸå¤±éƒ½å¾ˆä½ï¼ŒIoU è‡ªç„¶ç›¸å½“é«˜ï¼Œæ‰€ä»¥è¿™é‡Œçš„å…³é”®å°±æ˜¯ï¼Œå¯¹äºé¢„æµ‹æ¡†è€Œè¨€ï¼Œæˆ‘ä»¬éœ€è¦è®©å®ƒç›¸å¯¹å¯¹åº”çš„ç›®æ ‡æ¡†çš„ç½®ä¿¡åº¦å°½é‡é«˜ï¼ˆå¯¹åº”ç›®æ ‡ï¼Œæ˜¯æ­£æ ·æœ¬ï¼‰ï¼Œè€Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„ç›®æ ‡æ¡†ï¼Œåˆ™ç½®ä¿¡åº¦å°½é‡ä½ï¼ˆå¯¹åº”èƒŒæ™¯æˆ–è€…éæœ€ä¼˜çš„é¢„æµ‹æ¡†ï¼Œæ˜¯è´Ÿæ ·æœ¬ï¼‰ã€‚</p>
<p>æ­£æ ·æœ¬å’Œè´Ÿæ ·æœ¬çš„æŸå¤±è®¡ç®—å°±æ˜¯æŠŠåˆšåˆšçš„å¼å­æ‹†å¼€ï¼Œä»æ—§ä½¿ç”¨ MSEã€‚åˆšåˆšæåˆ°æˆ‘ä»¬éœ€è¦è®©ä¸åŒçš„é¢„æµ‹æ¡†ç½®ä¿¡åº¦æœ‰é«˜ä½çš„åˆ†é…ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è®©éœ€è¦æ‹‰é«˜ç½®ä¿¡åº¦çš„ï¼Œæ‹‰åˆ° <span class="arithmatex">\(1\)</span>ï¼Œéœ€è¦å‹ä½çš„ï¼Œå‹åˆ° <span class="arithmatex">\(0\)</span>ï¼š</p>
<div class="arithmatex">\[
\begin{align*}
    \mathcal{L}_{\mathrm{P}}&amp;=\sum_i^{S^2}\sum_j^{B}1_{ij}^\mathrm{obj}\left(c_{ij}-1\right)^2\\
    \mathcal{L}_{\mathrm{N}}&amp;=\sum_i^{S^2}\sum_j^{B}1_{ij}^\mathrm{noobj}\left(c_{ij}-0\right)^2
\end{align*}
\]</div>
<p>æœ€åå°±æ˜¯åˆ†ç±»è¯¯å·®äº†ã€‚ç”±äºåˆ†ç±»æ˜¯ç”±æ ¼å­è¿›è¡Œçš„ï¼Œå› æ­¤è¿™ä¸€éƒ¨åˆ†æ˜¯<strong>æ ¼å­çš„æŸå¤±</strong>ã€‚å›å¿†ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ <span class="arithmatex">\(1_{i}^\mathrm{obj}\)</span> æ¥æŒ‡ç¤ºæŸä¸ªæ ¼å­æœ‰å¯¹åº”æ¡†çš„ä¸­å¿ƒç‚¹è½åˆ°æ ¼å­é‡Œé¢ã€‚åŸè®ºæ–‡è¿˜æ˜¯ç”¨çš„ MSEï¼Œä¸è¿‡æˆ‘è§‰å¾—åˆ†ç±»ä»»åŠ¡ç”¨äº¤å‰ç†µæ˜¾ç„¶æ›´åˆé€‚ï¼š</p>
<div class="arithmatex">\[
\mathcal{L}_{\mathrm{class}}=\sum_i ^{S^2}1_{i}^\mathrm{obj}CE(p_i||\mathrm{one\_hot}_i^{\mathrm{obj}})
\]</div>
<p>æœ€åæŠŠä»–ä»¬åŠ æƒèµ·æ¥ï¼š</p>
<div class="arithmatex">\[
\mathcal{L}_{\mathrm{YOLO}}=\lambda_{\mathrm{coord}}(\mathcal{L}_\mathrm{center}+\mathcal{L}_\mathrm{size})+\mathcal{L}_{\mathrm{P}}+\lambda_{\mathrm{noobj}}\mathcal{L}_{\mathrm{N}}+\mathcal{L}_{\mathrm{class}}
\]</div>
<p>è¿™ä¸ªåŠ æƒä¹Ÿæ˜¯æœ‰è¯´æ³•çš„ã€‚æˆ‘ä»¬çš„ä¼˜å…ˆçº§æ˜¯æ‰“æ¡†æ‰“åˆ°ä½ï¼Œè¦ä¸ç„¶åé¢çš„ç½®ä¿¡åº¦è¿™äº›éƒ½æ˜¯æ‰¯æ·¡ï¼Œå› æ­¤è¦ç»™ <span class="arithmatex">\(\lambda_{\mathrm{coord}}\)</span> ä¸€ä¸ªå¤§æƒé‡ï¼Œè®ºæ–‡é‡Œé¢ç»™åˆ°äº† <span class="arithmatex">\(5\)</span>ï¼Œè€Œä¸”ç”±äºä¸€ä¸ªå›¾èƒŒæ™¯è‚¯å®šå¤šäºç›®æ ‡ï¼Œå› æ­¤æ€»çš„ <span class="arithmatex">\(\mathcal{L}_{\mathrm{N}}\)</span> è‚¯å®šç›¸å½“é«˜ï¼Œå¯¼è‡´æ¨¡å‹å€¾å‘äºå‹ç½®ä¿¡åˆ†ï¼ŒæŠŠæ‰€æœ‰çš„æ¡†éƒ½é¢„æµ‹æˆèƒŒæ™¯ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ§åˆ¶è¿™éƒ¨åˆ†æŸå¤±ï¼Œç»™ <span class="arithmatex">\(\lambda_{\mathrm{noobj}}\)</span> ä¸€ä¸ªå°æƒé‡ï¼Œè®ºæ–‡é‡Œé¢ç»™åˆ° <span class="arithmatex">\(0.5\)</span>ã€‚</p>
<p>æœ€åæ€»ç»“ä¸€ä¸‹è®¡ç®—æµç¨‹ï¼š</p>
<p>å¯¹äºæ‹¿åˆ°çš„å›¾ç‰‡ï¼Œå…ˆè¿‡ç½‘ç»œæ¨ç†å¾—åˆ° <code>(S, S, B*5+C)</code> çš„é¢„æµ‹å¼ é‡ã€‚ç„¶åæ‰«ä¸€éæ‰€æœ‰æ ¼å­ï¼š</p>
<ul>
<li>å¦‚æœæœ‰ä¸ªçœŸå®æ¡† T çš„ä¸­å¿ƒè½åœ¨æ ¼å­ <span class="arithmatex">\(i\)</span> é‡Œé¢äº†ï¼š<ul>
<li>æ­¤æ—¶ <span class="arithmatex">\(1_i^{\mathrm{obj}}=1\)</span></li>
<li>ä»æ ¼å­ <span class="arithmatex">\(i\)</span> çš„ <span class="arithmatex">\(B\)</span> ä¸ªæ¡†é‡Œé¢æ‰¾åˆ°å’Œ T çš„ IoU æœ€å¤§çš„æ¡† <span class="arithmatex">\(j\)</span>ï¼Œæ­¤æ—¶ <span class="arithmatex">\(1_{ij}^{\mathrm{obj}}=1\)</span></li>
<li>å¯¹äºè¿™ä¸ªæ¡†ï¼Œè®¡ç®— <span class="arithmatex">\(\mathcal{L}_1=\lambda_{\mathrm{coord}}(\mathcal{L}_\mathrm{center}+\mathcal{L}_\mathrm{size})+\mathcal{L}_{\mathrm{P}}\)</span></li>
<li>å¯¹äºå‰©ä¸‹çš„ <span class="arithmatex">\(B-1\)</span> ä¸ªæ¡†ï¼Œè®¡ç®— <span class="arithmatex">\(\mathcal{L}_2=\lambda_{\mathrm{noobj}}\sum^{B-1}\mathcal{L}_{\mathrm{N}}\)</span></li>
<li>å¯¹äºè¿™ä¸ªæ ¼å­çš„ç±»åˆ«æ¦‚ç‡å‘é‡ <span class="arithmatex">\(p_i\)</span>ï¼Œå’Œ T çš„ç±»åˆ«åšäº¤å‰ç†µï¼Œå³è®¡ç®— <span class="arithmatex">\(\mathcal{L}_{\mathrm{class}}=\sum_i ^{S^2}CE(p_i||\mathrm{one\_hot}_i^{\mathrm{T}})\)</span></li>
<li>æ ¼å­çš„æ€»æŸå¤± <span class="arithmatex">\(\mathcal{L}_{\mathrm{objcell}}=\mathcal{L}_1+\mathcal{L}_2+\mathcal{L}_{\mathrm{class}}\)</span></li>
</ul>
</li>
<li>å¦‚æœæ²¡æœ‰ï¼š<ul>
<li>æ­¤æ—¶ <span class="arithmatex">\(1_i^{\mathrm{obj}}=0\)</span></li>
<li>åªéœ€å¯¹æ‰€æœ‰æ¡†æ±‚å’Œï¼š <span class="arithmatex">\(\mathcal{L}_{\mathrm{noobjcell}}=\mathcal{L}_2=\lambda_{\mathrm{noobj}}\sum^{B}\mathcal{L}_{\mathrm{N}}\)</span></li>
</ul>
</li>
</ul>
<p>æœ€åå¯ä»¥å¾—åˆ°æ•´ä¸ªå›¾ç‰‡çš„æŸå¤±ï¼š<span class="arithmatex">\(\mathcal{L}_{\mathrm{YOLO}}=\sum\mathcal{L}_{\mathrm{objcell}}+\sum\mathcal{L}_{\mathrm{noobjcell}}\)</span>ã€‚</p>
<p>å¦‚æœä½ æ˜¯åƒæˆ‘ä¸€æ ·ä»è¿‡ç¨‹å¼çš„ C/C++ å¼€å§‹æ¥è§¦ç¨‹åºè®¾è®¡è¯­è¨€çš„ï¼Œå¤§æ¦‚ä¼šè§‰å¾—è¿™å°±æ˜¯ä¸€ä¸ª for-if å°±èƒ½è§£å†³çš„äº‹ã€‚ä½†æ˜¯å¦‚æœä½ è¯»äº†ä¸‹é¢çš„æŸå¤±å‡½æ•°ä»£ç å°±ä¼šå‘ç°<strong>å®Œå…¨ä¸æ˜¯è¿™æ ·åšçš„</strong>ï¼Œè€Œæ˜¯ä¸€ç§æ¥è¿‘<strong>å‡½æ•°å¼</strong>çš„æ€æƒ³ã€‚</p>
<p>å¦‚æœæƒ³æ„Ÿå—è¿™ç§èŒƒå¼è½¬ç§» (Paradigm Shift) å¸¦æ¥çš„éœ‡æ’¼ï¼Œå¼ºçƒˆæ¨èé˜…è¯»ä¸‹é¢è®¡ç®—æŸå¤±ä½¿ç”¨çš„ä»£ç ã€‚é…åˆè¿™é¦– Paradigm Shift é£Ÿç”¨æ›´ä½³å“¦~</p>
<div style="text-align: center; margin: 20px 0;">
<iframe border="0" frameborder="no" height="86" marginheight="0" marginwidth="0" src="//music.163.com/outchain/player?type=2&amp;id=419116089&amp;auto=0&amp;height=66" style="border: 0px solid #ccc;" width="330"></iframe>
</div>
<p>æœ€åå€¼å¾—ä¸€æçš„æ˜¯ï¼Œâ€œé€‰å–IoUæœ€å¤§çš„æ¡†â€è¿™ä¸ªæ“ä½œä¼¼ä¹å› ä¸ºæ¶‰åŠåˆ° <code>argmax</code> æ“ä½œè€Œ<strong>ä¸å¯å¯¼</strong>ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬å¯¹ä¸åŒçš„æƒ…å†µåˆ†é…äº†ä¸åŒçš„æŸå¤±ï¼Œå› æ­¤æˆ‘ä»¬äº‹å®ä¸Šæ‰§è¡Œçš„æ“ä½œæ˜¯<strong>å¯¹æœ€å¤§æ¡†</strong>åˆ©ç”¨ <span class="arithmatex">\(\mathcal{L}_1\)</span> å›ä¼ æ¢¯åº¦è€Œå¯¹å…¶ä»–æ¡†åˆ©ç”¨ <span class="arithmatex">\(\mathcal{L}_{\mathrm{N}}\)</span> å›ä¼ æ¢¯åº¦ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡æ¡ä»¶åˆ¤æ–­æ¥æ„å»ºä¸åŒçš„æŸå¤±è·¯å¾„ï¼Œè¿™æ ·æ•´ä¸ªç½‘ç»œå°±å®Œå…¨å¯å¯¼äº†ã€‚è¿™ä¸€ç‚¹å†™æˆä»£ç ä¹Ÿæ˜¯æœ‰è¯´æ³•çš„ï¼Œè¯·çœ‹ VCRï¼š</p>
<p><img alt="alt text" src="../image-36.png"/></p>
<h4 id="_14">ç½‘ç»œç»“æ„<a class="headerlink" href="#_14" title="Permanent link">Â¶</a></h4>
<p>YOLO v1 ä½¿ç”¨è‡ªç ”æ¶æ„ Darknet æ¥å®ç°æ‰“æ¡†ã€‚ä»–ä»¬åœ¨ ImageNet ä¸Šé¢é¢„è®­ç»ƒäº†ç‰¹å¾æå–å™¨ï¼Œç„¶åæ›¿æ¢åˆ†ç±»å¤´æ”¹ä¸ºè¾“å‡º <code>(S, S, B*5+C)</code> çš„é¢„æµ‹å¼ é‡ï¼Œå†åœ¨ VOC 07+12 ä¸Šé¢è®­ç»ƒã€‚ç”±äº Darknet çš„é¢„è®­ç»ƒæƒé‡æ²¡æœ‰å…¬å¼€ï¼ˆåªå…¬å¼€äº†åœ¨ç›®æ ‡æ£€æµ‹æ•°æ®ä¸Šé¢å¾®è°ƒå¥½çš„ï¼‰ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨ torchvision å¼€æºçš„ ResNet-18 åœ¨ ImageNet ä¸Šé¢çš„é¢„è®­ç»ƒæƒé‡ä½œä¸ºéª¨å¹²ç½‘ã€‚å½“ç„¶è¿™ä¸ªç½‘ç»œçš„å‚æ•°é‡å®Œå…¨æ¯”ä¸è¿‡ Darknetã€‚</p>
<h4 id="map">mAP<a class="headerlink" href="#map" title="Permanent link">Â¶</a></h4>
<p>æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªæ ¼å­å¯ä»¥æœ‰å¤šä¸ªæ¡†ï¼Œä¸åŒçš„æ¡†æœ‰ä¸åŒçš„ç½®ä¿¡åº¦ã€‚å¯¹äºä¸€ä¸ªç»™å®šçš„ IoU é˜ˆå€¼ï¼Œæ¯”å¦‚è¯´ 0.5ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é€‰æ‹©ç½®ä¿¡åº¦é˜ˆå€¼æ¥ç­›é€‰æ¡†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥æŠŠåŒæ—¶ç¬¦åˆä¸‹é¢ä¸‰ä¸ªæ¡ä»¶çš„æ¡†è§†ä½œ<strong>TP</strong>è€Œè¿™ä¸ªæ ¼å­æ‰“çš„å…¶ä»–æ¡†è§†ä½œ<strong>FP</strong>ï¼šé¢„æµ‹ç±»åˆ«å’ŒçœŸå®ç±»åˆ«ä¸€è‡´ã€ç›¸å¯¹çœŸå®æ¡†çš„ IoU æ»¡è¶³ IoU é˜ˆå€¼ä»¥åŠæ»¡è¶³ç½®ä¿¡åº¦é˜ˆå€¼ã€‚ç„¶åæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æ··æ·†çŸ©é˜µï¼Œä»è€Œå¾—åˆ° P-R æ›²çº¿ä¹Ÿå°±æ˜¯<strong>ç²¾å‡†ç‡-å¬å›ç‡æ›²çº¿</strong>ã€‚</p>
<p>æˆ‘ä»¬æŒ‰ç­‰é—´éš”é‡‡æ · 11 ä¸ªå¬å›ç‡ï¼ˆäº‹å®ä¸ŠçœŸå® P-R åˆ†å¸ƒä¸å¯èƒ½ç­‰é—´éš”ï¼Œä½†æ˜¯æˆ‘ä»¬æ’å€¼å³å¯ï¼‰ï¼Œè®¡ç®—å¯¹åº”ç²¾ç¡®ç‡çš„å¹³å‡ï¼Œå°±å¾—åˆ°äº†<strong>å¹³å‡ç²¾ç¡®ç‡</strong>ä¹Ÿå°±æ˜¯ APï¼Œç”±äºæˆ‘ä»¬è®¾ç½®çš„ IoU é˜ˆå€¼æ˜¯ 0.5ï¼Œæ‰€ä»¥å†™ä½œ AP@0.5ï¼ŒåŒæ ·çš„å¯¹ç±»åˆ«åšå¹³å‡å°±å¾—åˆ°äº†æˆ‘ä»¬ä¸»è¦çš„è¯„ä»·æŒ‡æ ‡ mAP@0.5ã€‚ä»å‡ ä½•æ„ä¹‰ä¸Šè®²ï¼Œæ˜¯åœ¨è¿‘ä¼¼è®¡ç®— P-R æ›²çº¿ä¸‹çš„é¢ç§¯ï¼ˆä¹Ÿå°±æ˜¯ AUCï¼‰ã€‚</p>
<p>å› ä¸ºä¸€èˆ¬ç²¾ç¡®ç‡å’Œå¬å›ç‡æ˜¯åå‘å˜åŒ–çš„ï¼Œæ‰€ä»¥è¿™ä¸ªåˆ†æ•°è¶Šé«˜ï¼Œä¸€æ–¹é¢æ„å‘³ç€å®ƒæ‰“æ¡†æœ‰åŸºæœ¬çš„å‡†ç¡®åº¦ï¼Œä½†æ˜¯æ›´æ„å‘³ç€æ¨¡å‹<strong>åœ¨ç±»åˆ«é¢„æµ‹ä¸Š</strong>è¶Šå¥½ã€‚</p>
<p>å…·ä½“è®¡ç®—è§ä»£ç ã€‚</p>
<h4 id="_15">è®­ç»ƒ<a class="headerlink" href="#_15" title="Permanent link">Â¶</a></h4>
<p>ä¸‹é¢çš„ä»£ç ï¼Œä¸»è¦æ˜¯åœ¨ VOC 07+12 ä¸Šè®­ç»ƒ YOLO v1 (ResNet-18 backbone) å¹¶è¿›è¡ŒéªŒè¯å’Œè¯„ä¼°ã€‚ç”±äº ResNet-18 çš„å‚æ•°é‡å°ä¸”ä¸æ˜¯ä¸ºäº†ç›®æ ‡æ£€æµ‹è€Œä¼˜åŒ–çš„ï¼ˆå› ä¸º Darknet ç”¨ä¸Šäº†å¤šå°ºåº¦å·ç§¯æ ¸ï¼Œé€šé“æ•°ä¹Ÿæ›´å®½ä»è€Œæ›´é€‚åˆåƒ FCN ä¸€æ ·è¾“å‡º <code>(S, S, 5*B+C)</code> çš„â€œç‰¹å¾å›¾â€ï¼Œå…¶å®æŸç§æ„ä¹‰ä¸Šç”¨ VGG æˆ–è€… GoogLeNet éƒ½æ›´é€‚åˆï¼Œä½†æ˜¯å‚æ•°é‡æ›´å¤§ï¼‰ï¼Œæ‰€ä»¥åªèƒ½è·å¾— mAP@0.5 = 0.4723ï¼Œå…·ä½“çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img alt="alt text" src="../image-34.png"/></p>
<p><img alt="alt text" src="../image-35.png"/></p>
<p>ä¸‹é¢ç»™å‡ºæ¨¡å‹ç±»çš„å®šä¹‰ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">YOLOv1ResNet18</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>        <span class="n">backbone</span> <span class="o">=</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">ResNet18_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span> <span class="k">if</span> <span class="n">pretrained</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>        <span class="c1"># ä¸‹é¢å°±æ˜¯é¢„è®­ç»ƒçš„æƒé‡</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stem</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>            <span class="n">backbone</span><span class="o">.</span><span class="n">conv1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">bn1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">maxpool</span><span class="p">,</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>            <span class="n">backbone</span><span class="o">.</span><span class="n">layer1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer2</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer3</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer4</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>        <span class="p">)</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>        <span class="c1"># æ‰©å±•åˆ° 1024 é€šé“ï¼Œä¸ºè¾“å‡º (7,7,30) çš„å¼ é‡åšå‡†å¤‡ã€‚ </span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>        <span class="c1"># ç”±äºè¾“å‡ºå·²ç»æ˜¯ 512@7x7 çš„äº†ï¼Œå…¶å®ç›¸å½“äºæˆ‘ä»¬å‡†å¤‡æ•´åˆåˆ° 30@7x7</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>        <span class="p">)</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>        <span class="n">out_ch</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span> <span class="n">c</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>        <span class="c1"># åŒå·ç§¯åˆ°è¾“å‡ºé€šé“ï¼Œè¿™ä¸¤éƒ¨åˆ†éƒ½æ²¡æœ‰ç”¨ä¸Šé¢„è®­ç»ƒæƒé‡ï¼Œä¹Ÿå¯¼è‡´ mAP æ¯”è¾ƒä½</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>        <span class="c1"># Leakly ReLU å’Œè®ºæ–‡ä¸€è‡´</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>        <span class="p">)</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># [N,512,14,14]</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   <span class="c1"># [N,1024,7,7]</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># [N,(B*5+C),7,7]</span>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> <span class="c1"># [N,7,7,(B*5+C)]</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a>        <span class="c1"># è¿™é‡Œç”±äºç½®æ¢äº†å¼ é‡ç»´ï¼Œæ‰€ä»¥.contiguous()ä¸€ä¸‹è®©å†…å­˜è¿ç»­ã€‚</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a>        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
<p>ä¸‹é¢æ˜¯é‡å¤´æˆï¼Œæˆ‘ä»¬çš„æŸå¤±å‡½æ•°ã€‚</p>
<p>ä»£ç æ¯”è¾ƒé•¿ï¼Œå› ä¸ºæˆ‘å…·ä½“åˆ†æäº†è›®å¤šç»†èŠ‚ï¼Œå› æ­¤æŠ˜å äº†ä¸€ä¸‹ã€‚</p>
<details>
<summary> YOLO v1 loss è¯¦ç»†çš„å®ç° </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">  1</a></span>
<span class="normal"><a href="#__codelineno-7-2">  2</a></span>
<span class="normal"><a href="#__codelineno-7-3">  3</a></span>
<span class="normal"><a href="#__codelineno-7-4">  4</a></span>
<span class="normal"><a href="#__codelineno-7-5">  5</a></span>
<span class="normal"><a href="#__codelineno-7-6">  6</a></span>
<span class="normal"><a href="#__codelineno-7-7">  7</a></span>
<span class="normal"><a href="#__codelineno-7-8">  8</a></span>
<span class="normal"><a href="#__codelineno-7-9">  9</a></span>
<span class="normal"><a href="#__codelineno-7-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-7-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-7-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-7-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-7-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-7-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-7-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-7-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-7-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-7-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-7-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-7-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-7-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-7-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-7-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-7-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-7-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-7-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-7-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-7-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-7-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-7-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-7-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-7-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-7-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-7-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-7-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-7-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-7-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-7-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-7-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-7-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-7-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-7-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-7-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-7-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-7-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-7-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-7-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-7-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-7-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-7-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-7-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-7-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-7-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-7-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-7-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-7-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-7-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-7-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-7-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-7-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-7-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-7-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-7-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-7-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-7-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-7-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-7-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-7-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-7-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-7-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-7-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-7-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-7-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-7-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-7-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-7-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-7-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-7-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-7-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-7-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-7-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-7-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-7-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-7-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-7-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-7-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-7-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-7-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-7-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-7-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-7-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-7-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-7-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-7-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-7-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-7-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-7-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-7-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-7-100">100</a></span>
<span class="normal"><a href="#__codelineno-7-101">101</a></span>
<span class="normal"><a href="#__codelineno-7-102">102</a></span>
<span class="normal"><a href="#__codelineno-7-103">103</a></span>
<span class="normal"><a href="#__codelineno-7-104">104</a></span>
<span class="normal"><a href="#__codelineno-7-105">105</a></span>
<span class="normal"><a href="#__codelineno-7-106">106</a></span>
<span class="normal"><a href="#__codelineno-7-107">107</a></span>
<span class="normal"><a href="#__codelineno-7-108">108</a></span>
<span class="normal"><a href="#__codelineno-7-109">109</a></span>
<span class="normal"><a href="#__codelineno-7-110">110</a></span>
<span class="normal"><a href="#__codelineno-7-111">111</a></span>
<span class="normal"><a href="#__codelineno-7-112">112</a></span>
<span class="normal"><a href="#__codelineno-7-113">113</a></span>
<span class="normal"><a href="#__codelineno-7-114">114</a></span>
<span class="normal"><a href="#__codelineno-7-115">115</a></span>
<span class="normal"><a href="#__codelineno-7-116">116</a></span>
<span class="normal"><a href="#__codelineno-7-117">117</a></span>
<span class="normal"><a href="#__codelineno-7-118">118</a></span>
<span class="normal"><a href="#__codelineno-7-119">119</a></span>
<span class="normal"><a href="#__codelineno-7-120">120</a></span>
<span class="normal"><a href="#__codelineno-7-121">121</a></span>
<span class="normal"><a href="#__codelineno-7-122">122</a></span>
<span class="normal"><a href="#__codelineno-7-123">123</a></span>
<span class="normal"><a href="#__codelineno-7-124">124</a></span>
<span class="normal"><a href="#__codelineno-7-125">125</a></span>
<span class="normal"><a href="#__codelineno-7-126">126</a></span>
<span class="normal"><a href="#__codelineno-7-127">127</a></span>
<span class="normal"><a href="#__codelineno-7-128">128</a></span>
<span class="normal"><a href="#__codelineno-7-129">129</a></span>
<span class="normal"><a href="#__codelineno-7-130">130</a></span>
<span class="normal"><a href="#__codelineno-7-131">131</a></span>
<span class="normal"><a href="#__codelineno-7-132">132</a></span>
<span class="normal"><a href="#__codelineno-7-133">133</a></span>
<span class="normal"><a href="#__codelineno-7-134">134</a></span>
<span class="normal"><a href="#__codelineno-7-135">135</a></span>
<span class="normal"><a href="#__codelineno-7-136">136</a></span>
<span class="normal"><a href="#__codelineno-7-137">137</a></span>
<span class="normal"><a href="#__codelineno-7-138">138</a></span>
<span class="normal"><a href="#__codelineno-7-139">139</a></span>
<span class="normal"><a href="#__codelineno-7-140">140</a></span>
<span class="normal"><a href="#__codelineno-7-141">141</a></span>
<span class="normal"><a href="#__codelineno-7-142">142</a></span>
<span class="normal"><a href="#__codelineno-7-143">143</a></span>
<span class="normal"><a href="#__codelineno-7-144">144</a></span>
<span class="normal"><a href="#__codelineno-7-145">145</a></span>
<span class="normal"><a href="#__codelineno-7-146">146</a></span>
<span class="normal"><a href="#__codelineno-7-147">147</a></span>
<span class="normal"><a href="#__codelineno-7-148">148</a></span>
<span class="normal"><a href="#__codelineno-7-149">149</a></span>
<span class="normal"><a href="#__codelineno-7-150">150</a></span>
<span class="normal"><a href="#__codelineno-7-151">151</a></span>
<span class="normal"><a href="#__codelineno-7-152">152</a></span>
<span class="normal"><a href="#__codelineno-7-153">153</a></span>
<span class="normal"><a href="#__codelineno-7-154">154</a></span>
<span class="normal"><a href="#__codelineno-7-155">155</a></span>
<span class="normal"><a href="#__codelineno-7-156">156</a></span>
<span class="normal"><a href="#__codelineno-7-157">157</a></span>
<span class="normal"><a href="#__codelineno-7-158">158</a></span>
<span class="normal"><a href="#__codelineno-7-159">159</a></span>
<span class="normal"><a href="#__codelineno-7-160">160</a></span>
<span class="normal"><a href="#__codelineno-7-161">161</a></span>
<span class="normal"><a href="#__codelineno-7-162">162</a></span>
<span class="normal"><a href="#__codelineno-7-163">163</a></span>
<span class="normal"><a href="#__codelineno-7-164">164</a></span>
<span class="normal"><a href="#__codelineno-7-165">165</a></span>
<span class="normal"><a href="#__codelineno-7-166">166</a></span>
<span class="normal"><a href="#__codelineno-7-167">167</a></span>
<span class="normal"><a href="#__codelineno-7-168">168</a></span>
<span class="normal"><a href="#__codelineno-7-169">169</a></span>
<span class="normal"><a href="#__codelineno-7-170">170</a></span>
<span class="normal"><a href="#__codelineno-7-171">171</a></span>
<span class="normal"><a href="#__codelineno-7-172">172</a></span>
<span class="normal"><a href="#__codelineno-7-173">173</a></span>
<span class="normal"><a href="#__codelineno-7-174">174</a></span>
<span class="normal"><a href="#__codelineno-7-175">175</a></span>
<span class="normal"><a href="#__codelineno-7-176">176</a></span>
<span class="normal"><a href="#__codelineno-7-177">177</a></span>
<span class="normal"><a href="#__codelineno-7-178">178</a></span>
<span class="normal"><a href="#__codelineno-7-179">179</a></span>
<span class="normal"><a href="#__codelineno-7-180">180</a></span>
<span class="normal"><a href="#__codelineno-7-181">181</a></span>
<span class="normal"><a href="#__codelineno-7-182">182</a></span>
<span class="normal"><a href="#__codelineno-7-183">183</a></span>
<span class="normal"><a href="#__codelineno-7-184">184</a></span>
<span class="normal"><a href="#__codelineno-7-185">185</a></span>
<span class="normal"><a href="#__codelineno-7-186">186</a></span>
<span class="normal"><a href="#__codelineno-7-187">187</a></span>
<span class="normal"><a href="#__codelineno-7-188">188</a></span>
<span class="normal"><a href="#__codelineno-7-189">189</a></span>
<span class="normal"><a href="#__codelineno-7-190">190</a></span>
<span class="normal"><a href="#__codelineno-7-191">191</a></span>
<span class="normal"><a href="#__codelineno-7-192">192</a></span>
<span class="normal"><a href="#__codelineno-7-193">193</a></span>
<span class="normal"><a href="#__codelineno-7-194">194</a></span>
<span class="normal"><a href="#__codelineno-7-195">195</a></span>
<span class="normal"><a href="#__codelineno-7-196">196</a></span>
<span class="normal"><a href="#__codelineno-7-197">197</a></span>
<span class="normal"><a href="#__codelineno-7-198">198</a></span>
<span class="normal"><a href="#__codelineno-7-199">199</a></span>
<span class="normal"><a href="#__codelineno-7-200">200</a></span>
<span class="normal"><a href="#__codelineno-7-201">201</a></span>
<span class="normal"><a href="#__codelineno-7-202">202</a></span>
<span class="normal"><a href="#__codelineno-7-203">203</a></span>
<span class="normal"><a href="#__codelineno-7-204">204</a></span>
<span class="normal"><a href="#__codelineno-7-205">205</a></span>
<span class="normal"><a href="#__codelineno-7-206">206</a></span>
<span class="normal"><a href="#__codelineno-7-207">207</a></span>
<span class="normal"><a href="#__codelineno-7-208">208</a></span>
<span class="normal"><a href="#__codelineno-7-209">209</a></span>
<span class="normal"><a href="#__codelineno-7-210">210</a></span>
<span class="normal"><a href="#__codelineno-7-211">211</a></span>
<span class="normal"><a href="#__codelineno-7-212">212</a></span>
<span class="normal"><a href="#__codelineno-7-213">213</a></span>
<span class="normal"><a href="#__codelineno-7-214">214</a></span>
<span class="normal"><a href="#__codelineno-7-215">215</a></span>
<span class="normal"><a href="#__codelineno-7-216">216</a></span>
<span class="normal"><a href="#__codelineno-7-217">217</a></span>
<span class="normal"><a href="#__codelineno-7-218">218</a></span>
<span class="normal"><a href="#__codelineno-7-219">219</a></span>
<span class="normal"><a href="#__codelineno-7-220">220</a></span>
<span class="normal"><a href="#__codelineno-7-221">221</a></span>
<span class="normal"><a href="#__codelineno-7-222">222</a></span>
<span class="normal"><a href="#__codelineno-7-223">223</a></span>
<span class="normal"><a href="#__codelineno-7-224">224</a></span>
<span class="normal"><a href="#__codelineno-7-225">225</a></span>
<span class="normal"><a href="#__codelineno-7-226">226</a></span>
<span class="normal"><a href="#__codelineno-7-227">227</a></span>
<span class="normal"><a href="#__codelineno-7-228">228</a></span>
<span class="normal"><a href="#__codelineno-7-229">229</a></span>
<span class="normal"><a href="#__codelineno-7-230">230</a></span>
<span class="normal"><a href="#__codelineno-7-231">231</a></span>
<span class="normal"><a href="#__codelineno-7-232">232</a></span>
<span class="normal"><a href="#__codelineno-7-233">233</a></span>
<span class="normal"><a href="#__codelineno-7-234">234</a></span>
<span class="normal"><a href="#__codelineno-7-235">235</a></span>
<span class="normal"><a href="#__codelineno-7-236">236</a></span>
<span class="normal"><a href="#__codelineno-7-237">237</a></span>
<span class="normal"><a href="#__codelineno-7-238">238</a></span>
<span class="normal"><a href="#__codelineno-7-239">239</a></span>
<span class="normal"><a href="#__codelineno-7-240">240</a></span>
<span class="normal"><a href="#__codelineno-7-241">241</a></span>
<span class="normal"><a href="#__codelineno-7-242">242</a></span>
<span class="normal"><a href="#__codelineno-7-243">243</a></span>
<span class="normal"><a href="#__codelineno-7-244">244</a></span>
<span class="normal"><a href="#__codelineno-7-245">245</a></span>
<span class="normal"><a href="#__codelineno-7-246">246</a></span>
<span class="normal"><a href="#__codelineno-7-247">247</a></span>
<span class="normal"><a href="#__codelineno-7-248">248</a></span>
<span class="normal"><a href="#__codelineno-7-249">249</a></span>
<span class="normal"><a href="#__codelineno-7-250">250</a></span>
<span class="normal"><a href="#__codelineno-7-251">251</a></span>
<span class="normal"><a href="#__codelineno-7-252">252</a></span>
<span class="normal"><a href="#__codelineno-7-253">253</a></span>
<span class="normal"><a href="#__codelineno-7-254">254</a></span>
<span class="normal"><a href="#__codelineno-7-255">255</a></span>
<span class="normal"><a href="#__codelineno-7-256">256</a></span>
<span class="normal"><a href="#__codelineno-7-257">257</a></span>
<span class="normal"><a href="#__codelineno-7-258">258</a></span>
<span class="normal"><a href="#__codelineno-7-259">259</a></span>
<span class="normal"><a href="#__codelineno-7-260">260</a></span>
<span class="normal"><a href="#__codelineno-7-261">261</a></span>
<span class="normal"><a href="#__codelineno-7-262">262</a></span>
<span class="normal"><a href="#__codelineno-7-263">263</a></span>
<span class="normal"><a href="#__codelineno-7-264">264</a></span>
<span class="normal"><a href="#__codelineno-7-265">265</a></span>
<span class="normal"><a href="#__codelineno-7-266">266</a></span>
<span class="normal"><a href="#__codelineno-7-267">267</a></span>
<span class="normal"><a href="#__codelineno-7-268">268</a></span>
<span class="normal"><a href="#__codelineno-7-269">269</a></span>
<span class="normal"><a href="#__codelineno-7-270">270</a></span>
<span class="normal"><a href="#__codelineno-7-271">271</a></span>
<span class="normal"><a href="#__codelineno-7-272">272</a></span>
<span class="normal"><a href="#__codelineno-7-273">273</a></span>
<span class="normal"><a href="#__codelineno-7-274">274</a></span>
<span class="normal"><a href="#__codelineno-7-275">275</a></span>
<span class="normal"><a href="#__codelineno-7-276">276</a></span>
<span class="normal"><a href="#__codelineno-7-277">277</a></span>
<span class="normal"><a href="#__codelineno-7-278">278</a></span>
<span class="normal"><a href="#__codelineno-7-279">279</a></span>
<span class="normal"><a href="#__codelineno-7-280">280</a></span>
<span class="normal"><a href="#__codelineno-7-281">281</a></span>
<span class="normal"><a href="#__codelineno-7-282">282</a></span>
<span class="normal"><a href="#__codelineno-7-283">283</a></span>
<span class="normal"><a href="#__codelineno-7-284">284</a></span>
<span class="normal"><a href="#__codelineno-7-285">285</a></span>
<span class="normal"><a href="#__codelineno-7-286">286</a></span>
<span class="normal"><a href="#__codelineno-7-287">287</a></span>
<span class="normal"><a href="#__codelineno-7-288">288</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">YoloV1Loss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">lambda_coord</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">lambda_noobj</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>                 <span class="n">ignore_iou_thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cls_label_smooth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>        <span class="c1"># å®šä¹‰ YOLO v1 æŸå¤±å‡½æ•°çš„è¶…å‚æ•°</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>        <span class="c1"># S è¡¨ç¤ºç½‘æ ¼çš„å°ºå¯¸ï¼Œå³å°†å›¾åƒåˆ’åˆ†ä¸º SÃ—S ä¸ªæ ¼å­</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>        <span class="c1"># åæ ‡æŸå¤±çš„æƒé‡ç³»æ•°ï¼Œç”¨äºå¢å¼ºåæ ‡é¢„æµ‹çš„é‡è¦æ€§</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_coord</span> <span class="o">=</span> <span class="n">lambda_coord</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>        <span class="c1"># æ— ç›®æ ‡ç½®ä¿¡åº¦æŸå¤±çš„æƒé‡ç³»æ•°ï¼Œç”¨äºé™ä½èƒŒæ™¯é¢„æµ‹çš„æƒé‡</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_noobj</span> <span class="o">=</span> <span class="n">lambda_noobj</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>        <span class="c1"># IoU å¿½ç•¥é˜ˆå€¼ï¼Œè™½ç„¶åŸå§‹çš„ YOLO æŸå¤±æ²¡æœ‰ï¼Œä½†æ˜¯ä¸‹é¢ä¼šç”¨åˆ°çš„ç¥å¥‡å¦™å¦™å‚æ•°</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_iou_thresh</span> <span class="o">=</span> <span class="n">ignore_iou_thresh</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>        <span class="c1"># åˆ†ç±»æ ‡ç­¾å¹³æ»‘ç³»æ•°ï¼Œç”¨äºé˜²æ­¢è¿‡æ‹Ÿåˆ</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cls_label_smooth</span> <span class="o">=</span> <span class="n">cls_label_smooth</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="sd">        å‰å‘ä¼ æ’­å‡½æ•°ï¼Œè®¡ç®— YOLO v1 çš„æ€»æŸå¤±åŠå„ä¸ªç»„æˆéƒ¨åˆ†çš„æŸå¤±å€¼ã€‚</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="sd">        pred: ç½‘ç»œè¾“å‡ºçš„é¢„æµ‹å¼ é‡ï¼Œå½¢çŠ¶ä¸º [N, S, S, B*5+C]</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="sd">        target: çœŸå®æ ‡ç­¾å¼ é‡ï¼Œå½¢çŠ¶ä¸º [N, S, S, 5+C]ï¼ŒåŒ…å«å½’ä¸€åŒ–çš„ä¸­å¿ƒåæ ‡ã€å®½é«˜ã€ç½®ä¿¡åº¦å’Œç±»åˆ« one-hot ç¼–ç </span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="sd">        """</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>        <span class="c1"># è·å–æ‰¹é‡å¤§å° (N)ã€ç½‘æ ¼å°ºå¯¸ (S)ã€æ¯ä¸ªæ ¼å­çš„é¢„æµ‹æ¡†æ•°é‡ (B) å’Œç±»åˆ«æ•°é‡ (C)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>        <span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a>        <span class="c1"># å°†é¢„æµ‹å¼ é‡é‡å¡‘ä¸º [N, S, S, B*5 + C] çš„å½¢çŠ¶</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>        <span class="c1"># æå–é¢„æµ‹æ¡†éƒ¨åˆ†å¹¶é‡å¡‘ä¸º [N, S, S, B, 5]ï¼ŒåŒ…å«æ¯ä¸ªé¢„æµ‹æ¡†çš„ (x, y, w, h, conf) åŸå§‹å€¼</span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a>        <span class="n">pred_boxes</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="n">B</span><span class="o">*</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a>        <span class="c1"># æå–ç±»åˆ«é¢„æµ‹éƒ¨åˆ†ï¼Œå½¢çŠ¶ä¸º [N, S, S, C]</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a>        <span class="n">pred_cls_logits</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">B</span><span class="o">*</span><span class="mi">5</span><span class="p">:]</span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a>        <span class="c1"># ä»ç›®æ ‡å¼ é‡ä¸­æå–çœŸå®è¾¹ç•Œæ¡†çš„åæ ‡ã€ç½®ä¿¡åº¦å’Œç±»åˆ«ä¿¡æ¯</span>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a>        <span class="c1"># t_xywh åŒ…å«å½’ä¸€åŒ–çš„ä¸­å¿ƒåæ ‡å’Œå®½é«˜ï¼Œå½¢çŠ¶ä¸º [N, S, S, 4]</span>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a>        <span class="n">t_xywh</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a>        <span class="c1"># t_obj è¡¨ç¤ºæ¯ä¸ªæ ¼å­æ˜¯å¦å­˜åœ¨ç›®æ ‡ï¼Œå½¢çŠ¶ä¸º [N, S, S]</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a>        <span class="c1"># è¿™ä¸ªå°±å¯¹åº”åŸè®ºæ–‡çš„ 1^obj_i</span>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a>        <span class="n">t_obj</span>  <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-7-41" name="__codelineno-7-41"></a>        <span class="c1"># t_cls è¡¨ç¤ºæ¯ä¸ªæ ¼å­çš„ç±»åˆ« one-hot ç¼–ç ï¼Œå½¢çŠ¶ä¸º [N, S, S, C]</span>
<a id="__codelineno-7-42" name="__codelineno-7-42"></a>        <span class="n">t_cls</span>  <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">5</span><span class="p">:]</span>
<a id="__codelineno-7-43" name="__codelineno-7-43"></a>
<a id="__codelineno-7-44" name="__codelineno-7-44"></a>        <span class="c1"># ç”Ÿæˆç½‘æ ¼åæ ‡ï¼Œç”¨äºå°†é¢„æµ‹çš„ç›¸å¯¹åæ ‡è½¬æ¢ä¸ºç»å¯¹åæ ‡</span>
<a id="__codelineno-7-45" name="__codelineno-7-45"></a>        <span class="c1"># åˆ›å»º [0, 1, ..., S-1] çš„åºåˆ—ï¼Œè¡¨ç¤ºç½‘æ ¼çš„ç´¢å¼•</span>
<a id="__codelineno-7-46" name="__codelineno-7-46"></a>        <span class="n">gxv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-7-47" name="__codelineno-7-47"></a>        <span class="n">gyv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-7-48" name="__codelineno-7-48"></a>        <span class="c1"># ç”Ÿæˆç½‘æ ¼çš„ x å’Œ y åæ ‡çŸ©é˜µï¼Œå½¢çŠ¶å‡ä¸º [S, S]</span>
<a id="__codelineno-7-49" name="__codelineno-7-49"></a>        <span class="n">gy</span><span class="p">,</span> <span class="n">gx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">gyv</span><span class="p">,</span> <span class="n">gxv</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">'ij'</span><span class="p">)</span>
<a id="__codelineno-7-50" name="__codelineno-7-50"></a>        <span class="c1"># æ‰©å±•ç»´åº¦ä»¥ä¾¿åç»­å¹¿æ’­æ“ä½œï¼Œå½¢çŠ¶å˜ä¸º [1, S, S, 1]</span>
<a id="__codelineno-7-51" name="__codelineno-7-51"></a>        <span class="n">gx</span> <span class="o">=</span> <span class="n">gx</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-7-52" name="__codelineno-7-52"></a>        <span class="n">gy</span> <span class="o">=</span> <span class="n">gy</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-7-53" name="__codelineno-7-53"></a>
<a id="__codelineno-7-54" name="__codelineno-7-54"></a>        <span class="c1"># å¯¹é¢„æµ‹çš„è¾¹ç•Œæ¡†å‚æ•°è¿›è¡Œè§£ç å’Œæ¿€æ´»</span>
<a id="__codelineno-7-55" name="__codelineno-7-55"></a>        <span class="c1"># ä½¿ç”¨ sigmoid å‡½æ•°å°† x å’Œ y çš„é¢„æµ‹å€¼çº¦æŸåˆ° [0,1] èŒƒå›´å†…ï¼Œè¡¨ç¤ºç›¸å¯¹äºæ ¼å­å·¦ä¸Šè§’çš„åç§»</span>
<a id="__codelineno-7-56" name="__codelineno-7-56"></a>        <span class="n">px</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-7-57" name="__codelineno-7-57"></a>        <span class="n">py</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-7-58" name="__codelineno-7-58"></a>        <span class="c1"># ä½¿ç”¨ softplus æ¿€æ´»å‡½æ•°å¤„ç†å®½é«˜é¢„æµ‹å€¼ï¼Œç„¶åå¹³æ–¹å¹¶è£å‰ªåˆ° [1e-6, 1.0] èŒƒå›´å†…ï¼Œç¡®ä¿æ•°å€¼ç¨³å®šæ€§</span>
<a id="__codelineno-7-59" name="__codelineno-7-59"></a>        <span class="c1"># è¿™é‡Œä½¿ç”¨ softplus åŠ ä¸Šå¹³æ–¹æ˜¯ä¸ºäº†ç¡®ä¿å®½é«˜ä¸ºæ­£å€¼ï¼Œå¹¶ä¸”æŠ‘åˆ¶ç‰¹åˆ«å¤§çš„æ¡†</span>
<a id="__codelineno-7-60" name="__codelineno-7-60"></a>        <span class="c1"># å…·ä½“æ¥è¯´ï¼Œsoftplus å‡½æ•°å¯ä»¥å¹³æ»‘åœ°å°†è´Ÿå€¼æ˜ å°„åˆ°æ­£å€¼ï¼ˆsoftplus(x)=log(1+exp(x))ï¼‰ï¼Œè€Œå¹³æ–¹æ“ä½œåˆ™è¿›ä¸€æ­¥æ”¾å¤§äº†å°å€¼çš„å½±å“</span>
<a id="__codelineno-7-61" name="__codelineno-7-61"></a>        <span class="c1"># å®è·µä¸‹æ¥ï¼Œè¿™æ ·å¤„ç†çš„æ•ˆæœä¼šæ›´å¥½ä¸€äº›</span>
<a id="__codelineno-7-62" name="__codelineno-7-62"></a>        <span class="n">pw</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-63" name="__codelineno-7-63"></a>        <span class="n">ph</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-64" name="__codelineno-7-64"></a>        <span class="c1"># ä½¿ç”¨ sigmoid å‡½æ•°å°†ç½®ä¿¡åº¦é¢„æµ‹å€¼çº¦æŸåˆ° [0,1] èŒƒå›´å†…</span>
<a id="__codelineno-7-65" name="__codelineno-7-65"></a>        <span class="n">pconf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<a id="__codelineno-7-66" name="__codelineno-7-66"></a>        <span class="c1"># ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†æ¯ä¸€ä¸ªé¢„æµ‹æ¡†çš„ä¸­å¿ƒåæ ‡ (px, py), å®½é«˜ (pw, ph) å’Œç½®ä¿¡åº¦ pconf</span>
<a id="__codelineno-7-67" name="__codelineno-7-67"></a>        <span class="c1"># è¿™é‡Œé¢„æµ‹çš„ (px, py) æ˜¯ç›¸å¯¹äºæ ¼å­å·¦ä¸Šè§’çš„åç§»ï¼Œ(pw, ph) æ˜¯ç»è¿‡ç‰¹æ®Šå¤„ç†çš„å®½é«˜</span>
<a id="__codelineno-7-68" name="__codelineno-7-68"></a>        <span class="c1"># å®ƒä»¬éƒ½æ˜¯ç›¸å¯¹äºè¾“å…¥å›¾åƒå°ºå¯¸å½’ä¸€åŒ–çš„å€¼</span>
<a id="__codelineno-7-69" name="__codelineno-7-69"></a>
<a id="__codelineno-7-70" name="__codelineno-7-70"></a>        <span class="c1"># å°†é¢„æµ‹çš„ç›¸å¯¹åæ ‡è½¬æ¢ä¸ºç»å¯¹åæ ‡</span>
<a id="__codelineno-7-71" name="__codelineno-7-71"></a>        <span class="c1"># ç›¸å¯¹åæ ‡å°±æ˜¯ç›¸å¯¹äºã€æ ¼å­ã€‘å·¦ä¸Šè§’çš„åç§»</span>
<a id="__codelineno-7-72" name="__codelineno-7-72"></a>        <span class="c1"># ç»å¯¹åæ ‡æ˜¯ç›¸å¯¹äºã€æ•´ä¸ªå›¾åƒã€‘çš„å·¦ä¸Šè§’çš„åç§»ï¼Œè¿˜è¦é™¤ä»¥ S è¿›è¡Œå½’ä¸€åŒ–</span>
<a id="__codelineno-7-73" name="__codelineno-7-73"></a>        <span class="c1">#</span>
<a id="__codelineno-7-74" name="__codelineno-7-74"></a>        <span class="c1"># -----------------------------------------------</span>
<a id="__codelineno-7-75" name="__codelineno-7-75"></a>        <span class="c1"># </span>
<a id="__codelineno-7-76" name="__codelineno-7-76"></a>        <span class="c1"># è¿™é‡Œçš„åæ ‡è½¬æ¢è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œå€¼å¾—è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š</span>
<a id="__codelineno-7-77" name="__codelineno-7-77"></a>        <span class="c1"># è®¡ç®—é¢„æµ‹æ¡†çš„ä¸­å¿ƒç‚¹ç»å¯¹åæ ‡ï¼Œé€šè¿‡å°†æ ¼å­ç´¢å¼•åŠ ä¸Šåç§»é‡å¹¶é™¤ä»¥ç½‘æ ¼å°ºå¯¸è¿›è¡Œå½’ä¸€åŒ–</span>
<a id="__codelineno-7-78" name="__codelineno-7-78"></a>        <span class="c1"># px çš„å½¢çŠ¶ä¸º [N, S, S, B]ï¼Œgx çš„å½¢çŠ¶ä¸º [1, S, S, 1]ï¼Œé€šè¿‡å¹¿æ’­æœºåˆ¶è¿›è¡ŒåŠ æ³•</span>
<a id="__codelineno-7-79" name="__codelineno-7-79"></a>        <span class="c1"># è¿™ä¸ªæœºåˆ¶çš„æ“ä½œè¿‡ç¨‹å…·ä½“æ˜¯ï¼šgx åœ¨ç¬¬ä¸€ä¸ªç»´åº¦ä¸Šé¢å¤åˆ¶ N ä»½ï¼Œåœ¨æœ€åä¸€ä¸ªç»´åº¦ä¸Šå¤åˆ¶ B ä»½</span>
<a id="__codelineno-7-80" name="__codelineno-7-80"></a>        <span class="c1"># è¿™æ · gx çš„å½¢çŠ¶å°±å˜æˆäº† [N, S, S, B]ï¼Œç„¶åå°±å¯ä»¥å’Œ px æ¯ä¸ªä½ç½®å¯¹é½ç›¸åŠ äº†</span>
<a id="__codelineno-7-81" name="__codelineno-7-81"></a>        <span class="c1"># è¿™ä¸€å¥—æ“ä½œä¸‹æ¥ï¼Œå…¶å®å°±æ˜¯ä»ä¸€å¼€å§‹çš„ä¸€ç»´ [S] çš„å‘é‡ gxvï¼Œé€šè¿‡ meshgrid åœ¨ç¬¬äºŒä¸ªç»´åº¦ä¸Šå¤åˆ¶ S ä»½</span>
<a id="__codelineno-7-82" name="__codelineno-7-82"></a>        <span class="c1"># å˜æˆäº†äºŒç»´çš„ [S, S] çŸ©é˜µ gxï¼Œå†åˆ†åˆ«æ·»åŠ ä¸¤ä¸ªç»´åº¦å¹¶å¤åˆ¶ N å’Œ B ä»½ï¼Œå˜æˆäº† [N, S, S, B] çš„å¹¿æ’­åå¼ é‡</span>
<a id="__codelineno-7-83" name="__codelineno-7-83"></a>        <span class="c1"># æœ€åå’Œ px ç›¸åŠ ï¼Œå¾—åˆ°æ¯ä¸ªé¢„æµ‹æ¡†çš„ç»å¯¹ä¸­å¿ƒåæ ‡</span>
<a id="__codelineno-7-84" name="__codelineno-7-84"></a>        <span class="n">pcx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gx</span> <span class="o">+</span> <span class="n">px</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-7-85" name="__codelineno-7-85"></a>        <span class="c1"># å¯¹ y åæ ‡åŒç†ï¼Œæœ€åé™¤ä»¥ S è¿›è¡Œå½’ä¸€åŒ–</span>
<a id="__codelineno-7-86" name="__codelineno-7-86"></a>        <span class="n">pcy</span> <span class="o">=</span> <span class="p">(</span><span class="n">gy</span> <span class="o">+</span> <span class="n">py</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-7-87" name="__codelineno-7-87"></a>        <span class="c1"># ç»„åˆé¢„æµ‹æ¡†çš„ä¸­å¿ƒåæ ‡å’Œå®½é«˜ï¼Œå½¢çŠ¶ä¸º [N, S, S, B, 4]</span>
<a id="__codelineno-7-88" name="__codelineno-7-88"></a>        <span class="c1"># dim =-1 è¡¨ç¤ºåœ¨æœ€åä¸€ä¸ªç»´åº¦ä¸Šè¿›è¡Œå †å </span>
<a id="__codelineno-7-89" name="__codelineno-7-89"></a>        <span class="n">p_cxcywh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">pcx</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">pcy</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">pw</span><span class="p">,</span> <span class="n">ph</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-90" name="__codelineno-7-90"></a>        <span class="c1"># å°† (cx, cy, w, h) æ ¼å¼çš„è¾¹ç•Œæ¡†è½¬æ¢ä¸º (x1, y1, x2, y2) æ ¼å¼ï¼Œå¹¶è£å‰ªåˆ° [0,1] èŒƒå›´å†…</span>
<a id="__codelineno-7-91" name="__codelineno-7-91"></a>        <span class="n">p_xyxy</span> <span class="o">=</span> <span class="n">cxcywh_to_xyxy</span><span class="p">(</span><span class="n">p_cxcywh</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-92" name="__codelineno-7-92"></a>        <span class="c1"># ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†æ¯ä¸€ä¸ªé¢„æµ‹æ¡†çš„ç»å¯¹åæ ‡ p_xyxyï¼Œå½¢çŠ¶ä¸º [N, S, S, B, 4]</span>
<a id="__codelineno-7-93" name="__codelineno-7-93"></a>
<a id="__codelineno-7-94" name="__codelineno-7-94"></a>        <span class="c1"># å¯¹çœŸå®è¾¹ç•Œæ¡†åæ ‡è¿›è¡Œè§£ç å’Œå½’ä¸€åŒ–å¤„ç†</span>
<a id="__codelineno-7-95" name="__codelineno-7-95"></a>        <span class="c1"># ä»ç›®æ ‡å¼ é‡ä¸­æå–çœŸå®è¾¹ç•Œæ¡†çš„ (x, y, w, h) åæ ‡</span>
<a id="__codelineno-7-96" name="__codelineno-7-96"></a>        <span class="c1"># è¿™é‡Œ tw, th ä½¿ç”¨ clamp é™åˆ¶åœ¨ [1e-6, 1.0] èŒƒå›´å†…ï¼Œé˜²æ­¢æ•°å€¼ä¸ç¨³å®š</span>
<a id="__codelineno-7-97" name="__codelineno-7-97"></a>        <span class="c1"># tx çš„å½¢çŠ¶ä¸º [N, S, S, 1]ï¼Œä¸ gx å½¢çŠ¶å…¼å®¹ï¼Œå…¶ä»–ç±»ä¼¼</span>
<a id="__codelineno-7-98" name="__codelineno-7-98"></a>        <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tw</span><span class="p">,</span> <span class="n">th</span> <span class="o">=</span> <span class="n">t_xywh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_xywh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">t_xywh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">t_xywh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-99" name="__codelineno-7-99"></a>        <span class="c1"># è®¡ç®—çœŸå®è¾¹ç•Œæ¡†çš„ä¸­å¿ƒåæ ‡ (tcx, tcy)ï¼Œé€šè¿‡å°†æ ¼å­ç´¢å¼•åŠ ä¸Šåç§»é‡å¹¶é™¤ä»¥ç½‘æ ¼å°ºå¯¸è¿›è¡Œå½’ä¸€åŒ–</span>
<a id="__codelineno-7-100" name="__codelineno-7-100"></a>        <span class="c1"># è¿™é‡Œ gx.squeeze(-1) æ˜¯æŠŠæœ€åä¸€ä¸ªç»´åº¦æŒ¤æ‰ï¼Œå˜æˆ [1, S, S] çš„å½¢çŠ¶</span>
<a id="__codelineno-7-101" name="__codelineno-7-101"></a>        <span class="c1"># è¿™ä¸ªæ—¶å€™ä½ å°±è¦é—®äº†ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ gx å’Œ gy å‘¢ï¼Ÿå½“ç„¶å¯ä»¥ï¼å¹¿æ’­æœºåˆ¶å’Œä¹‹å‰å®Œå…¨ä¸€æ ·ã€‚</span>
<a id="__codelineno-7-102" name="__codelineno-7-102"></a>        <span class="c1"># è¿™é‡Œä¿ç•™æ˜¯å› ä¸ºè¿™ä¸ªä»£ç ä¸æ˜¯æˆ‘å†™çš„ï¼Œæˆ‘çŒœæµ‹gptæ˜¯ä¸ºäº†è®©å½¢çŠ¶æ›´æ¸…æ™°ä¸€äº›</span>
<a id="__codelineno-7-103" name="__codelineno-7-103"></a>        <span class="c1"># ç„¶åé€šè¿‡å¹¿æ’­æœºåˆ¶å’Œ tx çš„å½¢çŠ¶ [N, S, S, 1] è¿›è¡Œç›¸åŠ åå†è¿›è¡Œå½’ä¸€åŒ–ï¼Œå…·ä½“æœºåˆ¶åŒä¸Š</span>
<a id="__codelineno-7-104" name="__codelineno-7-104"></a>        <span class="n">tcx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gx</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">tx</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-7-105" name="__codelineno-7-105"></a>        <span class="n">tcy</span> <span class="o">=</span> <span class="p">(</span><span class="n">gy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ty</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-7-106" name="__codelineno-7-106"></a>        <span class="c1"># å°†ä¸­å¿ƒåæ ‡å’Œå®½é«˜ç»„åˆæˆ (tcx, tcy, tw, th) æ ¼å¼ï¼Œå½¢çŠ¶ä¸º [N, S, S, 4]</span>
<a id="__codelineno-7-107" name="__codelineno-7-107"></a>        <span class="n">t_cxcywh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">tcx</span><span class="p">,</span><span class="n">tcy</span><span class="p">,</span><span class="n">tw</span><span class="p">,</span><span class="n">th</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-108" name="__codelineno-7-108"></a>        <span class="c1"># å°† (tcx, tcy, tw, th) è½¬æ¢ä¸º (x1, y1, x2, y2) æ ¼å¼ï¼Œå¹¶è£å‰ªåˆ° [0, 1] èŒƒå›´å†…</span>
<a id="__codelineno-7-109" name="__codelineno-7-109"></a>        <span class="n">t_xyxy</span> <span class="o">=</span> <span class="n">cxcywh_to_xyxy</span><span class="p">(</span><span class="n">t_cxcywh</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-110" name="__codelineno-7-110"></a>        <span class="c1"># ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†æ¯ä¸€ä¸ªçœŸå®æ¡†çš„ç»å¯¹åæ ‡ t_xyxyï¼Œå½¢çŠ¶ä¸º [N, S, S, 4]</span>
<a id="__codelineno-7-111" name="__codelineno-7-111"></a>
<a id="__codelineno-7-112" name="__codelineno-7-112"></a>        <span class="c1"># ä¸‹é¢ï¼Œå°±å¯ä»¥è®¡ç®—æ¡†çš„æŸå¤±äº†ã€‚</span>
<a id="__codelineno-7-113" name="__codelineno-7-113"></a>
<a id="__codelineno-7-114" name="__codelineno-7-114"></a>        <span class="c1"># è®¡ç®—æ¯ä¸ªé¢„æµ‹æ¡†ä¸å¯¹åº”æ ¼å­ä¸­çœŸå®æ¡†çš„ IoU</span>
<a id="__codelineno-7-115" name="__codelineno-7-115"></a>        <span class="c1"># æ‰©å±•çœŸå®æ¡†å¼ é‡ä»¥ä¾¿ä¸æ¯ä¸ªé¢„æµ‹æ¡†è®¡ç®— IoUï¼Œå½¢çŠ¶å˜ä¸º [N, S, S, B, 4]</span>
<a id="__codelineno-7-116" name="__codelineno-7-116"></a>        <span class="c1"># è¿™ä¸€è¡Œä»£ç çš„æ“ä½œæ˜¯æŠŠ t_xyxy åœ¨æœ€åä¸€ä¸ªç»´åº¦ä¸Šé¢æ·»åŠ ä¸€ä¸ªç»´åº¦ï¼Œç„¶ååœ¨è¿™ä¸ªç»´åº¦ä¸Šå¤åˆ¶ B ä»½</span>
<a id="__codelineno-7-117" name="__codelineno-7-117"></a>        <span class="c1"># è¿™æ · t_xyxy_exp çš„å½¢çŠ¶å°±å˜æˆäº† [N, S, S, B, 4]ï¼Œç„¶åå°±å¯ä»¥å’Œ p_xyxy æ¯ä¸ªä½ç½®å¯¹é½è®¡ç®— IoU äº†</span>
<a id="__codelineno-7-118" name="__codelineno-7-118"></a>        <span class="n">t_xyxy_exp</span> <span class="o">=</span> <span class="n">t_xyxy</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-119" name="__codelineno-7-119"></a>        <span class="c1"># è®¡ç®—æ‰€æœ‰é¢„æµ‹æ¡†ä¸å¯¹åº”çœŸå®æ¡†çš„ IoUï¼Œå½¢çŠ¶ä¸º [N, S, S, B]</span>
<a id="__codelineno-7-120" name="__codelineno-7-120"></a>        <span class="n">iou_all</span> <span class="o">=</span> <span class="n">iou_xyxy_aligned</span><span class="p">(</span><span class="n">p_xyxy</span><span class="p">,</span> <span class="n">t_xyxy_exp</span><span class="p">)</span>
<a id="__codelineno-7-121" name="__codelineno-7-121"></a>
<a id="__codelineno-7-122" name="__codelineno-7-122"></a>        <span class="c1"># ä¸‹é¢æˆ‘ä»¬è¦æ ¹æ® iou_all æ¥å†³å®šå“ªäº›æ¡†è´Ÿè´£é¢„æµ‹ï¼Œå“ªäº›æ¡†ä¸è´Ÿè´£é¢„æµ‹</span>
<a id="__codelineno-7-123" name="__codelineno-7-123"></a>
<a id="__codelineno-7-124" name="__codelineno-7-124"></a>        <span class="c1"># æ„å»ºè´Ÿè´£é¢„æµ‹çš„æ©ç ï¼Œç”¨äºæ ‡è¯†æ¯ä¸ªæ ¼å­ä¸­ä¸çœŸå®æ¡† IoU æœ€å¤§çš„é¢„æµ‹æ¡†</span>
<a id="__codelineno-7-125" name="__codelineno-7-125"></a>        <span class="c1"># obj_cells è¡¨ç¤ºå­˜åœ¨ç›®æ ‡çš„æ ¼å­ï¼Œå½¢çŠ¶ä¸º [N, S, S]</span>
<a id="__codelineno-7-126" name="__codelineno-7-126"></a>        <span class="c1"># è¿™ä¸ªå°±æ˜¯è®ºæ–‡ä¸­çš„ 1^obj_i</span>
<a id="__codelineno-7-127" name="__codelineno-7-127"></a>        <span class="n">obj_cells</span> <span class="o">=</span> <span class="n">t_obj</span>
<a id="__codelineno-7-128" name="__codelineno-7-128"></a>        <span class="c1"># å°†æ— ç›®æ ‡æ ¼å­çš„ IoU è®¾ç½®ä¸º -1ï¼Œä»¥ä¾¿åç»­å¤„ç†ï¼Œå½¢çŠ¶æ˜¯ [N, S, S, B]</span>
<a id="__codelineno-7-129" name="__codelineno-7-129"></a>        <span class="n">iou_all_masked</span> <span class="o">=</span> <span class="n">iou_all</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">obj_cells</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-130" name="__codelineno-7-130"></a>        <span class="c1"># è·å–æ¯ä¸ªæ ¼å­ä¸­ IoU æœ€å¤§çš„é¢„æµ‹æ¡†ç´¢å¼•ï¼Œå½¢çŠ¶ä¸º [N, S, S]</span>
<a id="__codelineno-7-131" name="__codelineno-7-131"></a>        <span class="n">best_box_idx</span> <span class="o">=</span> <span class="n">iou_all_masked</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-132" name="__codelineno-7-132"></a>        <span class="c1"># æ„å»ºè´Ÿè´£é¢„æµ‹çš„æ©ç ï¼Œå½¢çŠ¶ä¸º [N, S, S, B]ï¼Œå…¶ä¸­è´Ÿè´£é¢„æµ‹çš„æ¡†ä½ç½®ä¸º 1ï¼Œå…¶ä½™ä¸º 0</span>
<a id="__codelineno-7-133" name="__codelineno-7-133"></a>        <span class="c1"># è¿™ä¸ªå°±æ˜¯è®ºæ–‡ä¸­çš„ 1^obj_ij</span>
<a id="__codelineno-7-134" name="__codelineno-7-134"></a>        <span class="n">resp_mask</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">best_box_idx</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="n">obj_cells</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-135" name="__codelineno-7-135"></a>
<a id="__codelineno-7-136" name="__codelineno-7-136"></a>        <span class="c1"># è®¡ç®—åæ ‡æŸå¤±ï¼ŒåŒ…æ‹¬ä¸­å¿ƒç‚¹åæ ‡å’Œå®½é«˜çš„æŸå¤±</span>
<a id="__codelineno-7-137" name="__codelineno-7-137"></a>        <span class="c1"># å¯¹å®½é«˜å–å¹³æ–¹æ ¹ä»¥å¹³è¡¡å¤§å°æ¡†çš„æŸå¤±è´¡çŒ®</span>
<a id="__codelineno-7-138" name="__codelineno-7-138"></a>        <span class="c1"># è¿™ä¸€éƒ¨åˆ†å¯¹åº”çš„ L_coord å’Œ L_size</span>
<a id="__codelineno-7-139" name="__codelineno-7-139"></a>        <span class="c1"># w,h çš„å½¢çŠ¶å‡ä¸º [N, S, S, B]ï¼Œä½†å…¶å®æœ‰æ„ä¹‰çš„åªæœ‰è´Ÿè´£é¢„æµ‹çš„æ¡†ï¼Œä¹Ÿå°±æ˜¯ IoU æœ€å¤§çš„é‚£ä¸ªæ¡†</span>
<a id="__codelineno-7-140" name="__codelineno-7-140"></a>        <span class="c1"># ç›¸å½“äºè¿™éƒ¨åˆ†è®¡ç®—é‡Œé¢ (B-1)/B çš„éƒ¨åˆ†æ˜¯æ²¡æœ‰æ„ä¹‰çš„</span>
<a id="__codelineno-7-141" name="__codelineno-7-141"></a>        <span class="c1"># ä½†æ˜¯ç”±äºåé¢ä¹˜ä¸Šäº† resp_maskï¼Œæ‰€ä»¥è¿™äº›æ— æ„ä¹‰çš„éƒ¨åˆ†æŸå¤±ç›´æ¥ç½®é›¶äº†ï¼Œæ¢¯åº¦ä¸ä¼šå›ä¼ </span>
<a id="__codelineno-7-142" name="__codelineno-7-142"></a>        <span class="c1"># è¿™ä¸ªæ—¶å€™ä½ å°±è¦é—®äº†ï¼Œä¸ºä»€ä¹ˆä¸æ¥ä¸ª for-if æ¥é¿å…è®¡ç®—è¿™äº›æ— æ„ä¹‰çš„éƒ¨åˆ†å‘¢ï¼Ÿ</span>
<a id="__codelineno-7-143" name="__codelineno-7-143"></a>        <span class="c1"># è¿™æ ·åšçš„åŸå› æ˜¯ï¼Œfor-if ä¼šå¯¼è‡´è®¡ç®—å›¾æ–­è£‚ï¼Œæ²¡æ³•å­æ±‚å¯¼äº†ï¼Œè€Œä¸”é€å…ƒç´ åˆ†æ”¯é¢„æµ‹æ…¢æ­»â€¦â€¦</span>
<a id="__codelineno-7-144" name="__codelineno-7-144"></a>        <span class="c1"># åè§‚è®¡ç®—è¿™äº›æ— æ„ä¹‰çš„éƒ¨åˆ†ä¹Ÿä¸ä¼šç‰¹åˆ«å½±å“æ•ˆç‡ï¼Œæ¯•ç«Ÿ B ä¸€èˆ¬éƒ½æ¯”è¾ƒå°ï¼Œè€Œä¸”å¯ä»¥æ•°æ®å¹¶è¡Œè®¡ç®—</span>
<a id="__codelineno-7-145" name="__codelineno-7-145"></a>        <span class="c1"># è¿™é‡ŒåŠ ä¸Šä¸€ä¸ªå¾ˆå°çš„æ•°å€¼ 1e-6 è¿˜æ˜¯ä¸ºäº†é˜²æ­¢æ•°å€¼ä¸ç¨³å®š</span>
<a id="__codelineno-7-146" name="__codelineno-7-146"></a>        <span class="n">sqrt_pw</span><span class="p">,</span> <span class="n">sqrt_ph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pw</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ph</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
<a id="__codelineno-7-147" name="__codelineno-7-147"></a>        <span class="n">sqrt_tw</span><span class="p">,</span> <span class="n">sqrt_th</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tw</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
<a id="__codelineno-7-148" name="__codelineno-7-148"></a>        <span class="c1"># è®¡ç®—ä¸­å¿ƒç‚¹ x åæ ‡çš„æŸå¤±ï¼Œä»…å¯¹è´Ÿè´£é¢„æµ‹çš„æ¡†è®¡ç®—</span>
<a id="__codelineno-7-149" name="__codelineno-7-149"></a>        <span class="n">coord_x_loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">px</span> <span class="o">-</span> <span class="n">tx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resp_mask</span>
<a id="__codelineno-7-150" name="__codelineno-7-150"></a>        <span class="c1"># è®¡ç®—ä¸­å¿ƒç‚¹ y åæ ‡çš„æŸå¤±ï¼Œä»…å¯¹è´Ÿè´£é¢„æµ‹çš„æ¡†è®¡ç®—</span>
<a id="__codelineno-7-151" name="__codelineno-7-151"></a>        <span class="n">coord_y_loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">py</span> <span class="o">-</span> <span class="n">ty</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resp_mask</span>
<a id="__codelineno-7-152" name="__codelineno-7-152"></a>        <span class="c1"># è®¡ç®—å®½åº¦çš„æŸå¤±ï¼Œä½¿ç”¨å¹³æ–¹æ ¹å¤„ç†åçš„å€¼</span>
<a id="__codelineno-7-153" name="__codelineno-7-153"></a>        <span class="n">coord_w_loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">sqrt_pw</span> <span class="o">-</span> <span class="n">sqrt_tw</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resp_mask</span>
<a id="__codelineno-7-154" name="__codelineno-7-154"></a>        <span class="c1"># è®¡ç®—é«˜åº¦çš„æŸå¤±ï¼Œä½¿ç”¨å¹³æ–¹æ ¹å¤„ç†åçš„å€¼</span>
<a id="__codelineno-7-155" name="__codelineno-7-155"></a>        <span class="n">coord_h_loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">sqrt_ph</span> <span class="o">-</span> <span class="n">sqrt_th</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resp_mask</span>
<a id="__codelineno-7-156" name="__codelineno-7-156"></a>
<a id="__codelineno-7-157" name="__codelineno-7-157"></a>        <span class="c1"># è®¡ç®—æœ‰ç›®æ ‡ç½®ä¿¡åº¦æŸå¤±ï¼Œç›®æ ‡å€¼ä¸ºé¢„æµ‹æ¡†ä¸çœŸå®æ¡†çš„ IoUï¼Œå¯¹åº” L_P</span>
<a id="__codelineno-7-158" name="__codelineno-7-158"></a>        <span class="c1"># é‚£ä½ å°±è¦é—®äº†ï¼Œè¿™ IoU åˆä¸å¯å¯¼äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ</span>
<a id="__codelineno-7-159" name="__codelineno-7-159"></a>        <span class="c1"># å…¶å®ä¹Ÿæ²¡äº‹ï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯ç”¨å®ƒæ¥ä½œä¸ºä¸€ä¸ªå¸¸æ•°ç›®æ ‡å€¼ï¼Œåˆä¸æ˜¯çœŸçš„è¦ä¼˜åŒ–å®ƒ</span>
<a id="__codelineno-7-160" name="__codelineno-7-160"></a>        <span class="c1"># åè€Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨ detach æ¥é˜²æ­¢æ¢¯åº¦å›ä¼ </span>
<a id="__codelineno-7-161" name="__codelineno-7-161"></a>        <span class="n">iou_target</span> <span class="o">=</span> <span class="n">iou_all</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-7-162" name="__codelineno-7-162"></a>        <span class="c1"># è®¡ç®—æœ‰ç›®æ ‡ç½®ä¿¡åº¦æŸå¤±ï¼Œä»…å¯¹è´Ÿè´£é¢„æµ‹çš„æ¡†è®¡ç®—</span>
<a id="__codelineno-7-163" name="__codelineno-7-163"></a>        <span class="n">conf_obj_terms</span> <span class="o">=</span> <span class="p">((</span><span class="n">pconf</span> <span class="o">-</span> <span class="n">iou_target</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resp_mask</span>
<a id="__codelineno-7-164" name="__codelineno-7-164"></a>
<a id="__codelineno-7-165" name="__codelineno-7-165"></a>        <span class="c1"># æ„å»ºæ— ç›®æ ‡æ©ç ï¼ŒåŒ…æ‹¬éè´Ÿè´£é¢„æµ‹æ¡†å’Œçº¯ç²¹æ— ç›®æ ‡çš„æ ¼å­ï¼Œå¯¹åº” L_N</span>
<a id="__codelineno-7-166" name="__codelineno-7-166"></a>        <span class="c1"># éè´Ÿè´£é¢„æµ‹æ¡†æ©ç ï¼šå­˜åœ¨ç›®æ ‡çš„æ ¼å­ä¸­ä¸è´Ÿè´£é¢„æµ‹çš„æ¡†</span>
<a id="__codelineno-7-167" name="__codelineno-7-167"></a>        <span class="c1"># è¿™ä¸ªå°±æ˜¯è®ºæ–‡ä¸­çš„ 1^noobj_ij</span>
<a id="__codelineno-7-168" name="__codelineno-7-168"></a>        <span class="n">not_resp_mask</span> <span class="o">=</span> <span class="n">obj_cells</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">resp_mask</span><span class="p">)</span>
<a id="__codelineno-7-169" name="__codelineno-7-169"></a>        <span class="c1"># çº¯ç²¹æ— ç›®æ ‡æ ¼å­æ©ç ï¼šä¸å­˜åœ¨ç›®æ ‡çš„æ ¼å­ä¸­çš„æ‰€æœ‰é¢„æµ‹æ¡†</span>
<a id="__codelineno-7-170" name="__codelineno-7-170"></a>        <span class="c1"># ç±»æ¯”ä¸€ä¸‹å¯ä»¥å«åš 1^noobj_i</span>
<a id="__codelineno-7-171" name="__codelineno-7-171"></a>        <span class="n">noobj_cells_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">obj_cells</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">pconf</span><span class="p">)</span>
<a id="__codelineno-7-172" name="__codelineno-7-172"></a>
<a id="__codelineno-7-173" name="__codelineno-7-173"></a>        <span class="c1"># æ„å»ºå¿½ç•¥æ©ç ï¼Œç”¨äºå¤„ç†ä¸çœŸå®æ¡† IoU è¾ƒé«˜çš„æ— ç›®æ ‡é¢„æµ‹æ¡†</span>
<a id="__codelineno-7-174" name="__codelineno-7-174"></a>        <span class="c1"># åœ¨ YOLO è®­ç»ƒä¸­ï¼Œæœ‰äº›é¢„æµ‹æ¡†ä¸çœŸå®æ¡†çš„ IoU è¾ƒé«˜ä½†å¹¶ä¸æ˜¯è´Ÿè´£é¢„æµ‹çš„æ¡†</span>
<a id="__codelineno-7-175" name="__codelineno-7-175"></a>        <span class="c1"># è¿™äº›æ¡†ä¸åº”è¯¥è¢«æƒ©ç½šä¸ºæ— ç›®æ ‡ï¼Œå› ä¸ºå®ƒä»¬çš„é¢„æµ‹å®é™…ä¸Š"æ¥è¿‘"æŸä¸ªçœŸå®ç›®æ ‡</span>
<a id="__codelineno-7-176" name="__codelineno-7-176"></a>        <span class="c1"># æˆ‘ä»¬ä¸èƒ½å¦å®šå®ƒä»¬çš„åŠªåŠ›ï¼Œå› æ­¤ä½¿ç”¨ ignore_iou_thresh ä½œä¸ºé˜ˆå€¼æ¥è¯†åˆ«è¿™äº›æ¡†</span>
<a id="__codelineno-7-177" name="__codelineno-7-177"></a>        <span class="n">ignore_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pconf</span><span class="p">)</span>
<a id="__codelineno-7-178" name="__codelineno-7-178"></a>        <span class="c1"># ä½¿ç”¨ torch.no_grad() ç¡®ä¿åœ¨è¿™ä¸ªè®¡ç®—è¿‡ç¨‹ä¸­ä¸ç”Ÿæˆæ¢¯åº¦</span>
<a id="__codelineno-7-179" name="__codelineno-7-179"></a>        <span class="c1"># å› ä¸ºæˆ‘ä»¬åªæ˜¯ç”¨å®ƒæ¥æ„å»ºä¸€ä¸ªæ©ç ï¼Œæ¥è¿›è¡Œé€‰æ‹©æ€§çš„æŸå¤±è®¡ç®—å’Œæ¢¯åº¦å›ä¼ </span>
<a id="__codelineno-7-180" name="__codelineno-7-180"></a>        <span class="c1"># æ©ç æœ¬èº«ä¸éœ€è¦æ¢¯åº¦ï¼Œè€Œä¸”é‡Œé¢æ¶‰åŠåˆ°çš„ argmax ä¹Ÿæ˜¯ä¸å¯å¯¼çš„</span>
<a id="__codelineno-7-181" name="__codelineno-7-181"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-7-182" name="__codelineno-7-182"></a>            <span class="c1"># éå†æ‰¹æ¬¡ä¸­çš„æ¯ä¸ªæ ·æœ¬</span>
<a id="__codelineno-7-183" name="__codelineno-7-183"></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<a id="__codelineno-7-184" name="__codelineno-7-184"></a>                <span class="c1"># è·å–å½“å‰æ ·æœ¬ä¸­å­˜åœ¨ç›®æ ‡çš„ç½‘æ ¼ä½ç½®çš„æ©ç ï¼Œå½¢çŠ¶ä¸º [S, S]</span>
<a id="__codelineno-7-185" name="__codelineno-7-185"></a>                <span class="c1"># è¿™é‡Œçš„æœºåˆ¶æ˜¯ obj_cells[n] æ˜¯ [S, S] çš„å¼ é‡</span>
<a id="__codelineno-7-186" name="__codelineno-7-186"></a>                <span class="c1"># obj_cells[n] &gt; 0 ä¼šå¾—åˆ°ä¸€ä¸ªå¸ƒå°”å¼ é‡ï¼Œå½¢çŠ¶ä¹Ÿæ˜¯ [S, S]</span>
<a id="__codelineno-7-187" name="__codelineno-7-187"></a>                <span class="c1"># è¿™ä¸ªå¸ƒå°”å¼ é‡è¡¨ç¤ºå“ªäº›æ ¼å­æ˜¯æœ‰ç›®æ ‡çš„</span>
<a id="__codelineno-7-188" name="__codelineno-7-188"></a>                <span class="n">obj_mask_n</span> <span class="o">=</span> <span class="n">obj_cells</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-7-189" name="__codelineno-7-189"></a>                <span class="c1"># æå–å½“å‰æ ·æœ¬ä¸­æ‰€æœ‰çœŸå®æ¡†çš„åæ ‡</span>
<a id="__codelineno-7-190" name="__codelineno-7-190"></a>                <span class="c1"># ç”±äº t_xyxy[n] æ˜¯ [S, S, 4] çš„å¼ é‡ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç´¢å¼•</span>
<a id="__codelineno-7-191" name="__codelineno-7-191"></a>                <span class="c1"># é‚£ä½ å°±è¦é—®äº†ï¼Œgt_n çš„å½¢çŠ¶æ˜¯ [S, S, 4] å—ï¼Ÿ</span>
<a id="__codelineno-7-192" name="__codelineno-7-192"></a>                <span class="c1"># ä¸æ˜¯çš„ï¼Œå› ä¸º obj_mask_n æ˜¯å¸ƒå°”ç´¢å¼•ï¼Œæ‰€ä»¥ä¼šæŠŠæ‰€æœ‰ä¸º True çš„ä½ç½®éƒ½æå–å‡ºæ¥</span>
<a id="__codelineno-7-193" name="__codelineno-7-193"></a>                <span class="c1"># å•ç‹¬æ”¾è¿›ç¬¬ä¸€ä¸ªç»´åº¦ï¼Œæ‰€ä»¥æœ€ç»ˆ gt_n çš„å½¢çŠ¶æ˜¯ [num_gt, 4]ï¼Œå…¶ä¸­ num_gt æ˜¯å½“å‰æ ·æœ¬ä¸­çœŸå®æ¡†çš„æ•°é‡</span>
<a id="__codelineno-7-194" name="__codelineno-7-194"></a>                <span class="n">gt_n</span> <span class="o">=</span> <span class="n">t_xyxy</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">obj_mask_n</span><span class="p">]</span>
<a id="__codelineno-7-195" name="__codelineno-7-195"></a>                <span class="c1"># å°†å½“å‰æ ·æœ¬çš„æ‰€æœ‰é¢„æµ‹æ¡†é‡å¡‘ä¸º [S*S*B, 4] çš„å½¢çŠ¶</span>
<a id="__codelineno-7-196" name="__codelineno-7-196"></a>                <span class="c1"># .reshape(-1, 4) ä¼šå°† [S, S, B, 4] å˜æˆ [S*S*B, 4]</span>
<a id="__codelineno-7-197" name="__codelineno-7-197"></a>                <span class="c1"># -1 å°±æ˜¯è®©å‰é¢çš„ç»´åº¦éƒ½å †åœ¨ä¸€èµ·</span>
<a id="__codelineno-7-198" name="__codelineno-7-198"></a>                <span class="n">pred_n</span> <span class="o">=</span> <span class="n">p_xyxy</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-7-199" name="__codelineno-7-199"></a>                <span class="c1"># æ£€æŸ¥å½“å‰æ ·æœ¬ä¸­æ˜¯å¦å­˜åœ¨çœŸå®æ¡†</span>
<a id="__codelineno-7-200" name="__codelineno-7-200"></a>                <span class="c1"># .numel() ä¼šè¿”å›å¼ é‡ä¸­å…ƒç´ çš„æ€»æ•°é‡</span>
<a id="__codelineno-7-201" name="__codelineno-7-201"></a>                <span class="k">if</span> <span class="n">gt_n</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-7-202" name="__codelineno-7-202"></a>                    <span class="c1"># å¦‚æœæ²¡æœ‰çœŸå®æ¡†ï¼Œæ‰€æœ‰é¢„æµ‹æ¡†çš„æœ€å¤§ IoU è®¾ä¸º 0</span>
<a id="__codelineno-7-203" name="__codelineno-7-203"></a>                    <span class="n">max_iou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred_n</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-204" name="__codelineno-7-204"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-205" name="__codelineno-7-205"></a>                    <span class="c1"># è®¡ç®—æ‰€æœ‰é¢„æµ‹æ¡†ä¸æ‰€æœ‰çœŸå®æ¡†çš„ IoUï¼Œå¾—åˆ° [num_pred, num_gt] çš„ IoU çŸ©é˜µ</span>
<a id="__codelineno-7-206" name="__codelineno-7-206"></a>                    <span class="n">ious</span> <span class="o">=</span> <span class="n">box_iou_xyxy</span><span class="p">(</span><span class="n">pred_n</span><span class="p">,</span> <span class="n">gt_n</span><span class="p">)</span>
<a id="__codelineno-7-207" name="__codelineno-7-207"></a>                    <span class="c1"># è·å–æ¯ä¸ªé¢„æµ‹æ¡†ä¸æ‰€æœ‰çœŸå®æ¡†çš„æœ€å¤§ IoU [num_pred]</span>
<a id="__codelineno-7-208" name="__codelineno-7-208"></a>                    <span class="n">max_iou</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-7-209" name="__codelineno-7-209"></a>                <span class="c1"># å°†æœ€å¤§ IoU è¶…è¿‡é˜ˆå€¼çš„é¢„æµ‹æ¡†æ ‡è®°ä¸ºå¿½ç•¥ (1.0)ï¼Œå¦åˆ™ä¸º 0</span>
<a id="__codelineno-7-210" name="__codelineno-7-210"></a>                <span class="c1"># ä¹Ÿå°±æ˜¯æˆ‘ä»¬åªéœ€è¦å¯¹é‚£äº› IoU è¾ƒä½çš„é¢„æµ‹æ¡†è®¡ç®—æ— ç›®æ ‡æŸå¤± L_N</span>
<a id="__codelineno-7-211" name="__codelineno-7-211"></a>                <span class="c1"># å…¶ä»–æ¡†æˆ‘ä»¬å°±å¿½ç•¥æ‰ï¼Œä¸è®¡ç®—æŸå¤±ï¼Œè‚¯å®šå®ƒä»¬çš„åŠ³åŠ¨æˆæœ</span>
<a id="__codelineno-7-212" name="__codelineno-7-212"></a>                <span class="c1"># ç„¶åå°†æ ‡è®°é‡å¡‘ä¸º [S, S, B] çš„å½¢çŠ¶ï¼Œä¸ ignore_mask çš„å½“å‰æ ·æœ¬å½¢çŠ¶åŒ¹é…</span>
<a id="__codelineno-7-213" name="__codelineno-7-213"></a>                <span class="n">ign</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_iou</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_iou_thresh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
<a id="__codelineno-7-214" name="__codelineno-7-214"></a>                <span class="c1"># å°†å½“å‰æ ·æœ¬çš„å¿½ç•¥æ©ç èµ‹å€¼ç»™ ignore_mask</span>
<a id="__codelineno-7-215" name="__codelineno-7-215"></a>                <span class="n">ignore_mask</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ign</span>
<a id="__codelineno-7-216" name="__codelineno-7-216"></a>            <span class="c1"># è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡ï¼šä¸ºä»€ä¹ˆåœ¨è¿™é‡Œè¿˜åœ¨ç”¨ for-if è¿™ä¹ˆä½æ•ˆçš„æ–¹æ¡ˆå‘¢ï¼Ÿ</span>
<a id="__codelineno-7-217" name="__codelineno-7-217"></a>            <span class="c1"># å› ä¸ºæ¯ä¸ªå›¾åƒçš„ num_gt ä¹Ÿå°±æ˜¯ç‰©å“ä¸ªæ•°ä¸ä¸€æ ·ï¼Œæ²¡æ³•åœ¨ç»´åº¦ä¸Šå¯¹é½</span>
<a id="__codelineno-7-218" name="__codelineno-7-218"></a>            <span class="c1"># å¼ºè¡Œå¯¹é½ä¹Ÿä¸æ˜¯ä¸å¯ä»¥ï¼Œä½†æ˜¯ä½ è¿˜æ˜¯è¦éå†ä¸€éï¼Œæ•ˆç‡å·®ä¸äº†å¤šå°‘</span>
<a id="__codelineno-7-219" name="__codelineno-7-219"></a>            <span class="c1"># å¹¶ä¸”è¿™æ—¶å€™ä½ å°±ç­‰ç€ CUDA out of memory å§</span>
<a id="__codelineno-7-220" name="__codelineno-7-220"></a>
<a id="__codelineno-7-221" name="__codelineno-7-221"></a>        <span class="c1"># è®¡ç®—æ— ç›®æ ‡ç½®ä¿¡åº¦æŸå¤±ï¼Œä¸åŒ…æ‹¬è¢«å¿½ç•¥çš„é¢„æµ‹æ¡†ï¼Œä¹Ÿå°±æ˜¯ L_N</span>
<a id="__codelineno-7-222" name="__codelineno-7-222"></a>        <span class="c1"># æ— ç›®æ ‡æŸå¤±åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šéè´Ÿè´£é¢„æµ‹æ¡† (not_resp_mask) å’Œæ— ç›®æ ‡æ ¼å­ä¸­çš„æ‰€æœ‰é¢„æµ‹æ¡† (noobj_cells_mask)</span>
<a id="__codelineno-7-223" name="__codelineno-7-223"></a>        <span class="c1"># ä½†éœ€è¦æ’é™¤é‚£äº›ä¸çœŸå®æ¡† IoU è¾ƒé«˜è€Œè¢«å¿½ç•¥çš„é¢„æµ‹æ¡† (ä¹˜ä»¥ (1.0 - ignore_mask))</span>
<a id="__codelineno-7-224" name="__codelineno-7-224"></a>        <span class="n">conf_noobj_terms</span> <span class="o">=</span> <span class="p">((</span><span class="n">pconf</span> <span class="o">-</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">not_resp_mask</span> <span class="o">+</span> <span class="n">noobj_cells_mask</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ignore_mask</span><span class="p">)</span>
<a id="__codelineno-7-225" name="__codelineno-7-225"></a>
<a id="__codelineno-7-226" name="__codelineno-7-226"></a>        <span class="c1"># å¯¹æ¡†çš„æŸå¤±è®¡ç®—å®Œæ¯•ï¼Œä¸‹é¢æ˜¯å¯¹æ ¼å­çš„æŸå¤±ã€‚</span>
<a id="__codelineno-7-227" name="__codelineno-7-227"></a>
<a id="__codelineno-7-228" name="__codelineno-7-228"></a>        <span class="c1"># è®¡ç®—åˆ†ç±»æŸå¤±ï¼Œä»…å¯¹å­˜åœ¨ç›®æ ‡çš„æ ¼å­è®¡ç®—äº¤å‰ç†µæŸå¤±</span>
<a id="__codelineno-7-229" name="__codelineno-7-229"></a>        <span class="c1"># é¦–å…ˆè®¡ç®—å­˜åœ¨ç›®æ ‡çš„æ ¼å­æ•°é‡ï¼Œç”¨äºåç»­å½’ä¸€åŒ–ï¼Œä½¿ç”¨ clamp(min=1.0) é˜²æ­¢é™¤é›¶</span>
<a id="__codelineno-7-230" name="__codelineno-7-230"></a>        <span class="n">num_objcells</span> <span class="o">=</span> <span class="n">obj_cells</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-231" name="__codelineno-7-231"></a>        <span class="c1"># ä» one-hot ç¼–ç çš„çœŸå®æ ‡ç­¾ä¸­è·å–ç±»åˆ«ç´¢å¼•ï¼Œå½¢çŠ¶ä¸º [N, S, S]</span>
<a id="__codelineno-7-232" name="__codelineno-7-232"></a>        <span class="n">t_cls_idx</span> <span class="o">=</span> <span class="n">t_cls</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-233" name="__codelineno-7-233"></a>        <span class="c1"># æ„å»ºå­˜åœ¨ç›®æ ‡çš„å¸ƒå°”æ©ç ï¼Œå½¢çŠ¶ä¸º [N, S, S]ï¼Œç”¨äºç´¢å¼•å­˜åœ¨ç›®æ ‡çš„æ ¼å­</span>
<a id="__codelineno-7-234" name="__codelineno-7-234"></a>        <span class="n">obj_mask_bool</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj_cells</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-7-235" name="__codelineno-7-235"></a>
<a id="__codelineno-7-236" name="__codelineno-7-236"></a>        <span class="c1"># æ£€æŸ¥æ˜¯å¦å­˜åœ¨è‡³å°‘ä¸€ä¸ªåŒ…å«ç›®æ ‡çš„æ ¼å­</span>
<a id="__codelineno-7-237" name="__codelineno-7-237"></a>        <span class="k">if</span> <span class="n">obj_mask_bool</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-7-238" name="__codelineno-7-238"></a>            <span class="c1"># è®¡ç®—äº¤å‰ç†µæŸå¤±ï¼Œä½¿ç”¨æ ‡ç­¾å¹³æ»‘</span>
<a id="__codelineno-7-239" name="__codelineno-7-239"></a>            <span class="c1"># é¦–å…ˆä»é¢„æµ‹çš„åˆ†ç±»logitsä¸­æå–å­˜åœ¨ç›®æ ‡çš„æ ¼å­éƒ¨åˆ†ï¼Œå¹¶é‡å¡‘ä¸º [N*S*S, C] å½¢çŠ¶</span>
<a id="__codelineno-7-240" name="__codelineno-7-240"></a>            <span class="c1"># åŒæ—¶ä»çœŸå®æ ‡ç­¾ä¸­æå–å¯¹åº”çš„ç±»åˆ«ç´¢å¼•ï¼Œå¹¶é‡å¡‘ä¸º [N*S*S] å½¢çŠ¶</span>
<a id="__codelineno-7-241" name="__codelineno-7-241"></a>            <span class="n">ce</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
<a id="__codelineno-7-242" name="__codelineno-7-242"></a>                <span class="n">pred_cls_logits</span><span class="p">[</span><span class="n">obj_mask_bool</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span>
<a id="__codelineno-7-243" name="__codelineno-7-243"></a>                <span class="n">t_cls_idx</span><span class="p">[</span><span class="n">obj_mask_bool</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-7-244" name="__codelineno-7-244"></a>                <span class="n">reduction</span><span class="o">=</span><span class="s1">'sum'</span><span class="p">,</span>  <span class="c1"># ä½¿ç”¨æ±‚å’Œè€Œä¸æ˜¯å‡å€¼ï¼Œå› ä¸ºåé¢ä¼šé™¤ä»¥ num_objcells</span>
<a id="__codelineno-7-245" name="__codelineno-7-245"></a>                <span class="n">label_smoothing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_label_smooth</span>  <span class="c1"># åº”ç”¨æ ‡ç­¾å¹³æ»‘</span>
<a id="__codelineno-7-246" name="__codelineno-7-246"></a>            <span class="p">)</span>
<a id="__codelineno-7-247" name="__codelineno-7-247"></a>            <span class="c1"># å°†äº¤å‰ç†µæŸå¤±é™¤ä»¥å­˜åœ¨ç›®æ ‡çš„æ ¼å­æ•°é‡ï¼Œå¾—åˆ°å¹³å‡åˆ†ç±»æŸå¤±</span>
<a id="__codelineno-7-248" name="__codelineno-7-248"></a>            <span class="n">class_loss</span> <span class="o">=</span> <span class="n">ce</span> <span class="o">/</span> <span class="n">num_objcells</span>
<a id="__codelineno-7-249" name="__codelineno-7-249"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-250" name="__codelineno-7-250"></a>            <span class="c1"># å¦‚æœæ²¡æœ‰å­˜åœ¨ç›®æ ‡çš„æ ¼å­ï¼Œå°†åˆ†ç±»æŸå¤±è®¾ä¸º 0</span>
<a id="__codelineno-7-251" name="__codelineno-7-251"></a>            <span class="n">class_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-252" name="__codelineno-7-252"></a>
<a id="__codelineno-7-253" name="__codelineno-7-253"></a>        <span class="c1"># å¯¹å„ä¸ªæŸå¤±ç»„ä»¶è¿›è¡Œå½’ä¸€åŒ–å¤„ç†</span>
<a id="__codelineno-7-254" name="__codelineno-7-254"></a>        <span class="c1"># è®¡ç®—è´Ÿè´£é¢„æµ‹çš„æ¡†æ•°é‡ï¼Œç”¨äºåæ ‡æŸå¤±å’Œæœ‰ç›®æ ‡ç½®ä¿¡åº¦æŸå¤±çš„å½’ä¸€åŒ–</span>
<a id="__codelineno-7-255" name="__codelineno-7-255"></a>        <span class="n">num_resp</span> <span class="o">=</span> <span class="n">resp_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-256" name="__codelineno-7-256"></a>        <span class="c1"># è®¡ç®—éœ€è¦è®¡ç®—æ— ç›®æ ‡æŸå¤±çš„æ¡†æ•°é‡ï¼ŒåŒ…æ‹¬éè´Ÿè´£é¢„æµ‹æ¡†å’Œæ— ç›®æ ‡æ ¼å­ä¸­çš„é¢„æµ‹æ¡†</span>
<a id="__codelineno-7-257" name="__codelineno-7-257"></a>        <span class="c1"># ä½†è¦æ’é™¤è¢«å¿½ç•¥çš„é¢„æµ‹æ¡† (ä¹˜ä»¥ (1.0 - ignore_mask))</span>
<a id="__codelineno-7-258" name="__codelineno-7-258"></a>        <span class="n">num_noobj</span> <span class="o">=</span> <span class="p">(</span> <span class="p">((</span><span class="n">not_resp_mask</span> <span class="o">+</span> <span class="n">noobj_cells_mask</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ignore_mask</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-259" name="__codelineno-7-259"></a>
<a id="__codelineno-7-260" name="__codelineno-7-260"></a>        <span class="c1"># è®¡ç®—åŠ æƒåçš„åæ ‡æŸå¤±ï¼ŒåŒ…æ‹¬ä¸­å¿ƒç‚¹åæ ‡å’Œå®½é«˜æŸå¤±</span>
<a id="__codelineno-7-261" name="__codelineno-7-261"></a>        <span class="c1"># ä½¿ç”¨ lambda_coord å¢å¼ºåæ ‡é¢„æµ‹çš„é‡è¦æ€§</span>
<a id="__codelineno-7-262" name="__codelineno-7-262"></a>        <span class="n">coord_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_coord</span> <span class="o">*</span> <span class="p">(</span>
<a id="__codelineno-7-263" name="__codelineno-7-263"></a>            <span class="n">coord_x_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">coord_y_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> 
<a id="__codelineno-7-264" name="__codelineno-7-264"></a>            <span class="n">coord_w_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">coord_h_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-7-265" name="__codelineno-7-265"></a>        <span class="p">)</span> <span class="o">/</span> <span class="n">num_resp</span>
<a id="__codelineno-7-266" name="__codelineno-7-266"></a>
<a id="__codelineno-7-267" name="__codelineno-7-267"></a>        <span class="c1"># è®¡ç®—æœ‰ç›®æ ‡ç½®ä¿¡åº¦æŸå¤±ï¼Œä½¿ç”¨è´Ÿè´£é¢„æµ‹çš„æ¡†æ•°é‡è¿›è¡Œå½’ä¸€åŒ–</span>
<a id="__codelineno-7-268" name="__codelineno-7-268"></a>        <span class="n">conf_obj_loss</span> <span class="o">=</span> <span class="n">conf_obj_terms</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">num_resp</span>
<a id="__codelineno-7-269" name="__codelineno-7-269"></a>
<a id="__codelineno-7-270" name="__codelineno-7-270"></a>        <span class="c1"># è®¡ç®—åŠ æƒåçš„æ— ç›®æ ‡ç½®ä¿¡åº¦æŸå¤±</span>
<a id="__codelineno-7-271" name="__codelineno-7-271"></a>        <span class="c1"># ä½¿ç”¨ lambda_noobj é™ä½èƒŒæ™¯é¢„æµ‹çš„æƒé‡ï¼Œé¿å…èƒŒæ™¯ä¸»å¯¼è®­ç»ƒè¿‡ç¨‹</span>
<a id="__codelineno-7-272" name="__codelineno-7-272"></a>        <span class="n">conf_noobj_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_noobj</span> <span class="o">*</span> <span class="n">conf_noobj_terms</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">num_noobj</span>
<a id="__codelineno-7-273" name="__codelineno-7-273"></a>
<a id="__codelineno-7-274" name="__codelineno-7-274"></a>        <span class="c1"># è®¡ç®—æ€»æŸå¤±ï¼Œå°†æ‰€æœ‰æŸå¤±ç»„ä»¶ç›¸åŠ </span>
<a id="__codelineno-7-275" name="__codelineno-7-275"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">coord_loss</span> <span class="o">+</span> <span class="n">conf_obj_loss</span> <span class="o">+</span> <span class="n">conf_noobj_loss</span> <span class="o">+</span> <span class="n">class_loss</span>
<a id="__codelineno-7-276" name="__codelineno-7-276"></a>
<a id="__codelineno-7-277" name="__codelineno-7-277"></a>        <span class="c1"># æ„å»ºæŸå¤±å­—å…¸ï¼Œç”¨äºè®°å½•å„ä¸ªæŸå¤±ç»„ä»¶çš„å€¼</span>
<a id="__codelineno-7-278" name="__codelineno-7-278"></a>        <span class="c1"># ä½¿ç”¨ detach().item() å°†å¼ é‡è½¬æ¢ä¸º Python æ•°å€¼ï¼Œé¿å…åœ¨æ—¥å¿—è®°å½•ä¸­ä¿ç•™è®¡ç®—å›¾</span>
<a id="__codelineno-7-279" name="__codelineno-7-279"></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-280" name="__codelineno-7-280"></a>            <span class="s1">'loss_total'</span><span class="p">:</span> <span class="n">total_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>          <span class="c1"># æ€»æŸå¤±</span>
<a id="__codelineno-7-281" name="__codelineno-7-281"></a>            <span class="s1">'loss_coord'</span><span class="p">:</span> <span class="n">coord_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>          <span class="c1"># åæ ‡æŸå¤±</span>
<a id="__codelineno-7-282" name="__codelineno-7-282"></a>            <span class="s1">'loss_conf_obj'</span><span class="p">:</span> <span class="n">conf_obj_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>    <span class="c1"># æœ‰ç›®æ ‡ç½®ä¿¡åº¦æŸå¤±</span>
<a id="__codelineno-7-283" name="__codelineno-7-283"></a>            <span class="s1">'loss_conf_noobj'</span><span class="p">:</span> <span class="n">conf_noobj_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span><span class="c1"># æ— ç›®æ ‡ç½®ä¿¡åº¦æŸå¤±</span>
<a id="__codelineno-7-284" name="__codelineno-7-284"></a>            <span class="s1">'loss_class'</span><span class="p">:</span> <span class="n">class_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>          <span class="c1"># åˆ†ç±»æŸå¤±</span>
<a id="__codelineno-7-285" name="__codelineno-7-285"></a>        <span class="p">}</span>
<a id="__codelineno-7-286" name="__codelineno-7-286"></a>
<a id="__codelineno-7-287" name="__codelineno-7-287"></a>        <span class="c1"># è¿”å›æ€»æŸå¤±å’ŒæŸå¤±å­—å…¸</span>
<a id="__codelineno-7-288" name="__codelineno-7-288"></a>        <span class="k">return</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">loss_dict</span>
</code></pre></div></td></tr></table></div>
</details>
<h4 id="_16">æ¨ç†ä¸è¯„ä¼°<a class="headerlink" href="#_16" title="Permanent link">Â¶</a></h4>
<p>å”¯ä¸€å€¼å¾—ä¸€æçš„å°±æ˜¯æ¨ç†æ—¶ä½¿ç”¨çš„ NMS æ‰‹æ®µã€‚ç”±äºæ‰“æ¡†çš„æ—¶å€™æ¨¡å‹æƒ³æé«˜å¬å›ï¼ˆå°¤å…¶åœ¨æˆ‘ä»¬ä¹‹å‰é­”æ”¹è¿‡çš„ YOLO Loss é‡Œé¢ï¼‰ï¼Œå°±ä¼šç»™åŒä¸€ä¸ªç›®æ ‡æ‰“å¾ˆå¤šç›¸äº’é‡å çš„æ¡†ï¼Œäºæ˜¯æˆ‘ä»¬å°±éœ€è¦å¯¹è¿™äº›æ¡†è¿›è¡Œç­›é€‰ã€‚</p>
<p>é¦–å…ˆè¯„åˆ¤ä¸€ä¸ªæ¡†å¥½ä¸å¥½æœ€ä½³æ ‡å‡†æ˜¯<strong>ç½®ä¿¡åº¦</strong> <span class="arithmatex">\(c\)</span>ï¼Œå› æ­¤æˆ‘ä»¬æŒ‰ç½®ä¿¡åº¦æ’åºï¼Œæœ€é«˜çš„æ¡†å°±æ˜¯è´¨é‡æœ€å¥½çš„æ¡†ã€‚æˆ‘ä»¬è®°å½•ä¸‹æ¥ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¸èƒ½ä¿ç•™å¤ªå¤šé‡å çš„æ¡†ï¼Œå°±ä¸¢å¼ƒå’Œè¿™ä¸ªæœ€ä½³æ¡† IoU å¤§äºæŸä¸ªé˜ˆå€¼ <code>NMS_IoU</code> çš„æ‰€æœ‰æ¡†ã€‚ç„¶åå¯¹å‰©ä¸‹çš„æ¡†ï¼ˆä¸å«é‚£ä¸ªæœ€ä½³æ¡†ï¼‰é‡å¤æ‰§è¡Œåˆšåˆšçš„æ’åºâ€”â€”ä¸¢å¼ƒæ“ä½œã€‚æœ€åè®°å½•ä¸‹æ¥çš„æ‰€æœ‰æ¡†å°±æ˜¯ç­›é€‰å¥½çš„æ¡†äº†ã€‚</p>
<p>è¿™å«åš Non-Max Suppression(NMS)ï¼Œéæå¤§å€¼æŠ‘åˆ¶ã€‚</p>
<p>å…¶ä»–çš„å†…å®¹ï¼Œè¯·å…·ä½“çœ‹ä»£ç å§ã€‚è¿™é‡Œæ²¡æœ‰ç»™ <code>yolo_decode</code> å‡½æ•°ï¼Œå› ä¸ºè§£ç çš„éƒ¨åˆ†åœ¨ <code>YOLOV1Loss</code> ç±»é‡Œé¢å·²ç»æœ‰å‘ˆç°äº†ã€‚</p>
<details>
<summary> åˆ©ç”¨ NMS è¯„ä¼° mAP, P-R ç­‰æŒ‡æ ‡ </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">  1</a></span>
<span class="normal"><a href="#__codelineno-8-2">  2</a></span>
<span class="normal"><a href="#__codelineno-8-3">  3</a></span>
<span class="normal"><a href="#__codelineno-8-4">  4</a></span>
<span class="normal"><a href="#__codelineno-8-5">  5</a></span>
<span class="normal"><a href="#__codelineno-8-6">  6</a></span>
<span class="normal"><a href="#__codelineno-8-7">  7</a></span>
<span class="normal"><a href="#__codelineno-8-8">  8</a></span>
<span class="normal"><a href="#__codelineno-8-9">  9</a></span>
<span class="normal"><a href="#__codelineno-8-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-8-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-8-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-8-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-8-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-8-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-8-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-8-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-8-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-8-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-8-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-8-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-8-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-8-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-8-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-8-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-8-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-8-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-8-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-8-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-8-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-8-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-8-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-8-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-8-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-8-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-8-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-8-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-8-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-8-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-8-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-8-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-8-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-8-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-8-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-8-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-8-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-8-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-8-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-8-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-8-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-8-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-8-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-8-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-8-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-8-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-8-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-8-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-8-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-8-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-8-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-8-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-8-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-8-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-8-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-8-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-8-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-8-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-8-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-8-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-8-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-8-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-8-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-8-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-8-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-8-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-8-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-8-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-8-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-8-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-8-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-8-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-8-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-8-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-8-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-8-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-8-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-8-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-8-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-8-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-8-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-8-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-8-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-8-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-8-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-8-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-8-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-8-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-8-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-8-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-8-100">100</a></span>
<span class="normal"><a href="#__codelineno-8-101">101</a></span>
<span class="normal"><a href="#__codelineno-8-102">102</a></span>
<span class="normal"><a href="#__codelineno-8-103">103</a></span>
<span class="normal"><a href="#__codelineno-8-104">104</a></span>
<span class="normal"><a href="#__codelineno-8-105">105</a></span>
<span class="normal"><a href="#__codelineno-8-106">106</a></span>
<span class="normal"><a href="#__codelineno-8-107">107</a></span>
<span class="normal"><a href="#__codelineno-8-108">108</a></span>
<span class="normal"><a href="#__codelineno-8-109">109</a></span>
<span class="normal"><a href="#__codelineno-8-110">110</a></span>
<span class="normal"><a href="#__codelineno-8-111">111</a></span>
<span class="normal"><a href="#__codelineno-8-112">112</a></span>
<span class="normal"><a href="#__codelineno-8-113">113</a></span>
<span class="normal"><a href="#__codelineno-8-114">114</a></span>
<span class="normal"><a href="#__codelineno-8-115">115</a></span>
<span class="normal"><a href="#__codelineno-8-116">116</a></span>
<span class="normal"><a href="#__codelineno-8-117">117</a></span>
<span class="normal"><a href="#__codelineno-8-118">118</a></span>
<span class="normal"><a href="#__codelineno-8-119">119</a></span>
<span class="normal"><a href="#__codelineno-8-120">120</a></span>
<span class="normal"><a href="#__codelineno-8-121">121</a></span>
<span class="normal"><a href="#__codelineno-8-122">122</a></span>
<span class="normal"><a href="#__codelineno-8-123">123</a></span>
<span class="normal"><a href="#__codelineno-8-124">124</a></span>
<span class="normal"><a href="#__codelineno-8-125">125</a></span>
<span class="normal"><a href="#__codelineno-8-126">126</a></span>
<span class="normal"><a href="#__codelineno-8-127">127</a></span>
<span class="normal"><a href="#__codelineno-8-128">128</a></span>
<span class="normal"><a href="#__codelineno-8-129">129</a></span>
<span class="normal"><a href="#__codelineno-8-130">130</a></span>
<span class="normal"><a href="#__codelineno-8-131">131</a></span>
<span class="normal"><a href="#__codelineno-8-132">132</a></span>
<span class="normal"><a href="#__codelineno-8-133">133</a></span>
<span class="normal"><a href="#__codelineno-8-134">134</a></span>
<span class="normal"><a href="#__codelineno-8-135">135</a></span>
<span class="normal"><a href="#__codelineno-8-136">136</a></span>
<span class="normal"><a href="#__codelineno-8-137">137</a></span>
<span class="normal"><a href="#__codelineno-8-138">138</a></span>
<span class="normal"><a href="#__codelineno-8-139">139</a></span>
<span class="normal"><a href="#__codelineno-8-140">140</a></span>
<span class="normal"><a href="#__codelineno-8-141">141</a></span>
<span class="normal"><a href="#__codelineno-8-142">142</a></span>
<span class="normal"><a href="#__codelineno-8-143">143</a></span>
<span class="normal"><a href="#__codelineno-8-144">144</a></span>
<span class="normal"><a href="#__codelineno-8-145">145</a></span>
<span class="normal"><a href="#__codelineno-8-146">146</a></span>
<span class="normal"><a href="#__codelineno-8-147">147</a></span>
<span class="normal"><a href="#__codelineno-8-148">148</a></span>
<span class="normal"><a href="#__codelineno-8-149">149</a></span>
<span class="normal"><a href="#__codelineno-8-150">150</a></span>
<span class="normal"><a href="#__codelineno-8-151">151</a></span>
<span class="normal"><a href="#__codelineno-8-152">152</a></span>
<span class="normal"><a href="#__codelineno-8-153">153</a></span>
<span class="normal"><a href="#__codelineno-8-154">154</a></span>
<span class="normal"><a href="#__codelineno-8-155">155</a></span>
<span class="normal"><a href="#__codelineno-8-156">156</a></span>
<span class="normal"><a href="#__codelineno-8-157">157</a></span>
<span class="normal"><a href="#__codelineno-8-158">158</a></span>
<span class="normal"><a href="#__codelineno-8-159">159</a></span>
<span class="normal"><a href="#__codelineno-8-160">160</a></span>
<span class="normal"><a href="#__codelineno-8-161">161</a></span>
<span class="normal"><a href="#__codelineno-8-162">162</a></span>
<span class="normal"><a href="#__codelineno-8-163">163</a></span>
<span class="normal"><a href="#__codelineno-8-164">164</a></span>
<span class="normal"><a href="#__codelineno-8-165">165</a></span>
<span class="normal"><a href="#__codelineno-8-166">166</a></span>
<span class="normal"><a href="#__codelineno-8-167">167</a></span>
<span class="normal"><a href="#__codelineno-8-168">168</a></span>
<span class="normal"><a href="#__codelineno-8-169">169</a></span>
<span class="normal"><a href="#__codelineno-8-170">170</a></span>
<span class="normal"><a href="#__codelineno-8-171">171</a></span>
<span class="normal"><a href="#__codelineno-8-172">172</a></span>
<span class="normal"><a href="#__codelineno-8-173">173</a></span>
<span class="normal"><a href="#__codelineno-8-174">174</a></span>
<span class="normal"><a href="#__codelineno-8-175">175</a></span>
<span class="normal"><a href="#__codelineno-8-176">176</a></span>
<span class="normal"><a href="#__codelineno-8-177">177</a></span>
<span class="normal"><a href="#__codelineno-8-178">178</a></span>
<span class="normal"><a href="#__codelineno-8-179">179</a></span>
<span class="normal"><a href="#__codelineno-8-180">180</a></span>
<span class="normal"><a href="#__codelineno-8-181">181</a></span>
<span class="normal"><a href="#__codelineno-8-182">182</a></span>
<span class="normal"><a href="#__codelineno-8-183">183</a></span>
<span class="normal"><a href="#__codelineno-8-184">184</a></span>
<span class="normal"><a href="#__codelineno-8-185">185</a></span>
<span class="normal"><a href="#__codelineno-8-186">186</a></span>
<span class="normal"><a href="#__codelineno-8-187">187</a></span>
<span class="normal"><a href="#__codelineno-8-188">188</a></span>
<span class="normal"><a href="#__codelineno-8-189">189</a></span>
<span class="normal"><a href="#__codelineno-8-190">190</a></span>
<span class="normal"><a href="#__codelineno-8-191">191</a></span>
<span class="normal"><a href="#__codelineno-8-192">192</a></span>
<span class="normal"><a href="#__codelineno-8-193">193</a></span>
<span class="normal"><a href="#__codelineno-8-194">194</a></span>
<span class="normal"><a href="#__codelineno-8-195">195</a></span>
<span class="normal"><a href="#__codelineno-8-196">196</a></span>
<span class="normal"><a href="#__codelineno-8-197">197</a></span>
<span class="normal"><a href="#__codelineno-8-198">198</a></span>
<span class="normal"><a href="#__codelineno-8-199">199</a></span>
<span class="normal"><a href="#__codelineno-8-200">200</a></span>
<span class="normal"><a href="#__codelineno-8-201">201</a></span>
<span class="normal"><a href="#__codelineno-8-202">202</a></span>
<span class="normal"><a href="#__codelineno-8-203">203</a></span>
<span class="normal"><a href="#__codelineno-8-204">204</a></span>
<span class="normal"><a href="#__codelineno-8-205">205</a></span>
<span class="normal"><a href="#__codelineno-8-206">206</a></span>
<span class="normal"><a href="#__codelineno-8-207">207</a></span>
<span class="normal"><a href="#__codelineno-8-208">208</a></span>
<span class="normal"><a href="#__codelineno-8-209">209</a></span>
<span class="normal"><a href="#__codelineno-8-210">210</a></span>
<span class="normal"><a href="#__codelineno-8-211">211</a></span>
<span class="normal"><a href="#__codelineno-8-212">212</a></span>
<span class="normal"><a href="#__codelineno-8-213">213</a></span>
<span class="normal"><a href="#__codelineno-8-214">214</a></span>
<span class="normal"><a href="#__codelineno-8-215">215</a></span>
<span class="normal"><a href="#__codelineno-8-216">216</a></span>
<span class="normal"><a href="#__codelineno-8-217">217</a></span>
<span class="normal"><a href="#__codelineno-8-218">218</a></span>
<span class="normal"><a href="#__codelineno-8-219">219</a></span>
<span class="normal"><a href="#__codelineno-8-220">220</a></span>
<span class="normal"><a href="#__codelineno-8-221">221</a></span>
<span class="normal"><a href="#__codelineno-8-222">222</a></span>
<span class="normal"><a href="#__codelineno-8-223">223</a></span>
<span class="normal"><a href="#__codelineno-8-224">224</a></span>
<span class="normal"><a href="#__codelineno-8-225">225</a></span>
<span class="normal"><a href="#__codelineno-8-226">226</a></span>
<span class="normal"><a href="#__codelineno-8-227">227</a></span>
<span class="normal"><a href="#__codelineno-8-228">228</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">nms_classwise</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">iou_thr</span><span class="o">=</span><span class="mf">0.45</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="sd">    æŒ‰ç±»åˆ«è¿›è¡Œéæå¤§å€¼æŠ‘åˆ¶ (NMS)ï¼Œå»é™¤é‡å åº¦é«˜çš„æ£€æµ‹æ¡†</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="sd">        dets: æ£€æµ‹ç»“æœå¼ é‡ï¼Œå½¢çŠ¶ä¸º [num_detections, 6]ï¼Œæ¯è¡ŒåŒ…å« [x1, y1, x2, y2, score, class]</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="sd">        iou_thr: IoU é˜ˆå€¼ï¼Œç”¨äºåˆ¤æ–­ä¸¤ä¸ªæ¡†æ˜¯å¦é‡å è¿‡é«˜ï¼Œé»˜è®¤ä¸º 0.45</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="sd">        ç»è¿‡ NMS å¤„ç†åçš„æ£€æµ‹ç»“æœå¼ é‡</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="sd">    """</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>    <span class="c1"># æ£€æŸ¥æ˜¯å¦æœ‰æ£€æµ‹ç»“æœ</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="k">if</span> <span class="n">dets</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>        <span class="k">return</span> <span class="n">dets</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>    <span class="c1"># å¯¹æ¯ä¸ªç±»åˆ«å•ç‹¬å¤„ç†</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a>        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>        <span class="c1"># åˆ›å»ºå½“å‰ç±»åˆ«çš„æ©ç </span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a>        <span class="c1"># æå–å½“å‰ç±»åˆ«çš„æ£€æµ‹ç»“æœ</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a>        <span class="c1"># ä½¿ç”¨ TorchVision çš„ NMS å‡½æ•°è¿›è¡Œéæå¤§å€¼æŠ‘åˆ¶</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a>        <span class="c1"># æ³¨æ„ï¼šè¿™é‡Œåº”ç”¨äº† NMSï¼Œè¿™æ˜¯å»é™¤é‡å æ¡†çš„å…³é”®æ­¥éª¤</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a>        <span class="c1"># NMS ä¼šä¿ç•™å¾—åˆ†æœ€é«˜çš„æ¡†ï¼Œå¹¶ç§»é™¤ä¸å…¶ IoU è¶…è¿‡é˜ˆå€¼çš„å…¶ä»–æ¡†</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a>        <span class="n">keep_idx</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">nms</span><span class="p">(</span><span class="n">d</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">iou_thr</span><span class="p">)</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a>        <span class="c1"># å°†ä¿ç•™çš„æ£€æµ‹ç»“æœæ·»åŠ åˆ°è¾“å‡ºåˆ—è¡¨</span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a>        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">keep_idx</span><span class="p">])</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a>    <span class="c1"># åˆå¹¶æ‰€æœ‰ç±»åˆ«çš„æ£€æµ‹ç»“æœ</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">out</span> <span class="k">else</span> <span class="n">dets</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_map_pr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">nms_iou</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span> <span class="n">iou_match</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">subsample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="sd">    å…¨é¢è¯„ä¼° YOLO æ¨¡å‹çš„æ€§èƒ½ï¼Œè®¡ç®— mAP (mean Average Precision) å’Œç²¾ç¡®ç‡-å¬å›ç‡æŒ‡æ ‡</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a><span class="sd">    Args:</span>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a><span class="sd">        dataset: è¯„ä¼°æ•°æ®é›†ï¼Œåº”æä¾›å›¾åƒå’Œæ ‡æ³¨</span>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="sd">        model: è®­ç»ƒå¥½çš„ YOLO æ¨¡å‹</span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a><span class="sd">        device: è®¡ç®—è®¾å¤‡ ('cpu' æˆ– 'cuda')</span>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="sd">        conf_thresh: ç½®ä¿¡åº¦é˜ˆå€¼ï¼Œè¿‡æ»¤ä½ç½®ä¿¡åº¦é¢„æµ‹æ¡†ï¼Œé»˜è®¤ 1e-4</span>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="sd">        nms_iou: NMS æ“ä½œçš„ IoU é˜ˆå€¼ï¼Œç”¨äºå»é™¤é‡å æ¡†ï¼Œé»˜è®¤ 0.45</span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="sd">        iou_match: åˆ¤æ–­é¢„æµ‹æ¡†ä¸çœŸå®æ¡†åŒ¹é…çš„ IoU é˜ˆå€¼ï¼Œé»˜è®¤ 0.5 (PASCAL VOC æ ‡å‡†)</span>
<a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="sd">        subsample: è¯„ä¼°å­é›†å¤§å°ï¼Œç”¨äºå¿«é€ŸéªŒè¯ï¼Œé»˜è®¤è¯„ä¼°å…¨éƒ¨æ•°æ®</span>
<a id="__codelineno-8-46" name="__codelineno-8-46"></a>
<a id="__codelineno-8-47" name="__codelineno-8-47"></a><span class="sd">    Returns:</span>
<a id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="sd">        dict: åŒ…å«å¤šç§è¯„ä¼°æŒ‡æ ‡çš„å­—å…¸</span>
<a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="sd">    """</span>
<a id="__codelineno-8-50" name="__codelineno-8-50"></a>    <span class="c1"># è®¾ç½®æ¨¡å‹ä¸ºè¯„ä¼°æ¨¡å¼ï¼Œå…³é—­ dropout å’Œ batch normalization çš„éšæœºæ€§</span>
<a id="__codelineno-8-51" name="__codelineno-8-51"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-8-52" name="__codelineno-8-52"></a>
<a id="__codelineno-8-53" name="__codelineno-8-53"></a>    <span class="c1"># åˆ›å»ºæ•°æ®åŠ è½½å™¨ï¼Œè®¾ç½®åˆé€‚çš„æ‰¹é‡å¤§å°å’Œå·¥ä½œçº¿ç¨‹æ•°</span>
<a id="__codelineno-8-54" name="__codelineno-8-54"></a>    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span>
<a id="__codelineno-8-55" name="__codelineno-8-55"></a>                        <span class="n">pin_memory</span><span class="o">=</span><span class="n">PIN_MEMORY</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">)</span>
<a id="__codelineno-8-56" name="__codelineno-8-56"></a>
<a id="__codelineno-8-57" name="__codelineno-8-57"></a>    <span class="c1"># åˆå§‹åŒ–æ•°æ®ç»“æ„å­˜å‚¨æ‰€æœ‰çœŸå®æ¡†å’Œé¢„æµ‹æ¡†</span>
<a id="__codelineno-8-58" name="__codelineno-8-58"></a>    <span class="c1"># all_gts: æŒ‰ç±»åˆ«ç»„ç»‡çš„çœŸå®æ¡†ï¼Œç»“æ„ä¸º {class_id: {image_id: [bboxes]}}</span>
<a id="__codelineno-8-59" name="__codelineno-8-59"></a>    <span class="c1"># all_preds: æŒ‰ç±»åˆ«ç»„ç»‡çš„é¢„æµ‹æ¡†ï¼Œç»“æ„ä¸º {class_id: [(image_id, confidence, bbox)]}</span>
<a id="__codelineno-8-60" name="__codelineno-8-60"></a>    <span class="n">all_gts</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">C_global</span><span class="p">)}</span>
<a id="__codelineno-8-61" name="__codelineno-8-61"></a>    <span class="n">all_preds</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">C_global</span><span class="p">)}</span>
<a id="__codelineno-8-62" name="__codelineno-8-62"></a>
<a id="__codelineno-8-63" name="__codelineno-8-63"></a>    <span class="c1"># ä½¿ç”¨æ— æ¢¯åº¦è®¡ç®—å’Œè‡ªåŠ¨æ··åˆç²¾åº¦ï¼ˆå¦‚æœå¯ç”¨ï¼‰ä»¥æé«˜æ•ˆç‡</span>
<a id="__codelineno-8-64" name="__codelineno-8-64"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">AUTOCAST_ENABLED</span><span class="p">):</span>
<a id="__codelineno-8-65" name="__codelineno-8-65"></a>        <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># å·²å¤„ç†å›¾åƒè®¡æ•°å™¨</span>
<a id="__codelineno-8-66" name="__codelineno-8-66"></a>
<a id="__codelineno-8-67" name="__codelineno-8-67"></a>        <span class="c1"># ä½¿ç”¨è¿›åº¦æ¡éå†æ•°æ®åŠ è½½å™¨</span>
<a id="__codelineno-8-68" name="__codelineno-8-68"></a>        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">gts</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">'Eval'</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-8-69" name="__codelineno-8-69"></a>            <span class="c1"># å°†å›¾åƒæ•°æ®è½¬ç§»åˆ°æŒ‡å®šè®¾å¤‡ï¼ˆCPU/GPUï¼‰</span>
<a id="__codelineno-8-70" name="__codelineno-8-70"></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-8-71" name="__codelineno-8-71"></a>
<a id="__codelineno-8-72" name="__codelineno-8-72"></a>            <span class="c1"># å‰å‘ä¼ æ’­è·å–æ¨¡å‹é¢„æµ‹</span>
<a id="__codelineno-8-73" name="__codelineno-8-73"></a>            <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-8-74" name="__codelineno-8-74"></a>
<a id="__codelineno-8-75" name="__codelineno-8-75"></a>            <span class="c1"># è§£ç åŸå§‹é¢„æµ‹è¾“å‡ºï¼Œè½¬æ¢ä¸ºè¾¹ç•Œæ¡†æ ¼å¼</span>
<a id="__codelineno-8-76" name="__codelineno-8-76"></a>            <span class="n">dets_batch</span> <span class="o">=</span> <span class="n">yolo_decode</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="n">conf_thresh</span><span class="p">)</span>
<a id="__codelineno-8-77" name="__codelineno-8-77"></a>
<a id="__codelineno-8-78" name="__codelineno-8-78"></a>            <span class="c1"># å¤„ç†æ‰¹æ¬¡ä¸­çš„æ¯ä¸ªå›¾åƒ</span>
<a id="__codelineno-8-79" name="__codelineno-8-79"></a>            <span class="k">for</span> <span class="n">bi</span><span class="p">,</span> <span class="n">dets</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dets_batch</span><span class="p">):</span>
<a id="__codelineno-8-80" name="__codelineno-8-80"></a>                <span class="c1"># å¯¹æ£€æµ‹ç»“æœåº”ç”¨éæå¤§å€¼æŠ‘åˆ¶ (NMS)ï¼Œå»é™¤é‡å æ¡†</span>
<a id="__codelineno-8-81" name="__codelineno-8-81"></a>                <span class="c1"># è¿™æ˜¯è¯„ä¼°æµç¨‹ä¸­çš„å…³é”®æ­¥éª¤ï¼Œç¡®ä¿æ¯ä¸ªç›®æ ‡åªæœ‰ä¸€ä¸ªæœ€ä½³é¢„æµ‹æ¡†</span>
<a id="__codelineno-8-82" name="__codelineno-8-82"></a>                <span class="n">dets</span> <span class="o">=</span> <span class="n">nms_classwise</span><span class="p">(</span><span class="n">dets</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">iou_thr</span><span class="o">=</span><span class="n">nms_iou</span><span class="p">)</span>
<a id="__codelineno-8-83" name="__codelineno-8-83"></a>
<a id="__codelineno-8-84" name="__codelineno-8-84"></a>                <span class="c1"># è·å–å½“å‰å›¾åƒçš„IDå’ŒçœŸå®æ ‡æ³¨</span>
<a id="__codelineno-8-85" name="__codelineno-8-85"></a>                <span class="n">img_id</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span>
<a id="__codelineno-8-86" name="__codelineno-8-86"></a>                <span class="n">gt</span> <span class="o">=</span> <span class="n">gts</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>  <span class="c1"># çœŸå®æ ‡æ³¨ï¼Œæ ¼å¼ä¸º [x1, y1, x2, y2, class]</span>
<a id="__codelineno-8-87" name="__codelineno-8-87"></a>
<a id="__codelineno-8-88" name="__codelineno-8-88"></a>                <span class="c1"># å­˜å‚¨çœŸå®æ¡†ä¿¡æ¯åˆ°å…¨å±€æ•°æ®ç»“æ„</span>
<a id="__codelineno-8-89" name="__codelineno-8-89"></a>                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gt</span><span class="p">:</span>
<a id="__codelineno-8-90" name="__codelineno-8-90"></a>                    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="bp">cls</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-8-91" name="__codelineno-8-91"></a>                    <span class="c1"># åˆå§‹åŒ–è¯¥ç±»åˆ«çš„å›¾åƒå­—å…¸ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</span>
<a id="__codelineno-8-92" name="__codelineno-8-92"></a>                    <span class="k">if</span> <span class="n">img_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_gts</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">)]:</span>
<a id="__codelineno-8-93" name="__codelineno-8-93"></a>                        <span class="n">all_gts</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">)][</span><span class="n">img_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-8-94" name="__codelineno-8-94"></a>                    <span class="c1"># æ·»åŠ çœŸå®æ¡†åæ ‡</span>
<a id="__codelineno-8-95" name="__codelineno-8-95"></a>                    <span class="n">all_gts</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">)][</span><span class="n">img_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
<a id="__codelineno-8-96" name="__codelineno-8-96"></a>
<a id="__codelineno-8-97" name="__codelineno-8-97"></a>                <span class="c1"># å­˜å‚¨é¢„æµ‹æ¡†ä¿¡æ¯åˆ°å…¨å±€æ•°æ®ç»“æ„</span>
<a id="__codelineno-8-98" name="__codelineno-8-98"></a>                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">:</span>
<a id="__codelineno-8-99" name="__codelineno-8-99"></a>                    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="bp">cls</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-8-100" name="__codelineno-8-100"></a>                    <span class="n">all_preds</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_id</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]))</span>
<a id="__codelineno-8-101" name="__codelineno-8-101"></a>
<a id="__codelineno-8-102" name="__codelineno-8-102"></a>            <span class="c1"># æ›´æ–°å·²å¤„ç†å›¾åƒè®¡æ•°</span>
<a id="__codelineno-8-103" name="__codelineno-8-103"></a>            <span class="n">processed</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<a id="__codelineno-8-104" name="__codelineno-8-104"></a>
<a id="__codelineno-8-105" name="__codelineno-8-105"></a>            <span class="c1"># å¦‚æœè®¾ç½®äº†å­é‡‡æ ·ä¸”å·²è¾¾åˆ°é‡‡æ ·æ•°é‡ï¼Œæå‰ç»ˆæ­¢è¯„ä¼°</span>
<a id="__codelineno-8-106" name="__codelineno-8-106"></a>            <span class="k">if</span> <span class="n">subsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">processed</span> <span class="o">&gt;=</span> <span class="n">subsample</span><span class="p">:</span>
<a id="__codelineno-8-107" name="__codelineno-8-107"></a>                <span class="k">break</span>
<a id="__codelineno-8-108" name="__codelineno-8-108"></a>
<a id="__codelineno-8-109" name="__codelineno-8-109"></a>    <span class="c1"># åˆå§‹åŒ–è¯„ä¼°æŒ‡æ ‡</span>
<a id="__codelineno-8-110" name="__codelineno-8-110"></a>    <span class="n">aps</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># å­˜å‚¨æ¯ä¸ªç±»åˆ«çš„ AP (Average Precision)</span>
<a id="__codelineno-8-111" name="__codelineno-8-111"></a>    <span class="n">iou_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># å­˜å‚¨æ‰€æœ‰åŒ¹é…æ¡†çš„ IoU å€¼ï¼Œç”¨äºè®¡ç®—å¹³å‡ IoU</span>
<a id="__codelineno-8-112" name="__codelineno-8-112"></a>    <span class="n">tp_total</span> <span class="o">=</span> <span class="n">fp_total</span> <span class="o">=</span> <span class="n">fn_total</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># å…¨å±€çš„çœŸæ­£ä¾‹ã€å‡æ­£ä¾‹ã€å‡åä¾‹è®¡æ•°</span>
<a id="__codelineno-8-113" name="__codelineno-8-113"></a>
<a id="__codelineno-8-114" name="__codelineno-8-114"></a>    <span class="c1"># å¯¹æ¯ä¸ªç±»åˆ«å•ç‹¬è®¡ç®—è¯„ä¼°æŒ‡æ ‡</span>
<a id="__codelineno-8-115" name="__codelineno-8-115"></a>    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">C_global</span><span class="p">):</span>
<a id="__codelineno-8-116" name="__codelineno-8-116"></a>        <span class="c1"># æŒ‰ç½®ä¿¡åº¦é™åºæ’åºå½“å‰ç±»åˆ«çš„æ‰€æœ‰é¢„æµ‹æ¡†</span>
<a id="__codelineno-8-117" name="__codelineno-8-117"></a>        <span class="c1"># è¿™æ˜¯è®¡ç®— PR æ›²çº¿çš„å…³é”®æ­¥éª¤ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æŒ‰ç½®ä¿¡åº¦ä»é«˜åˆ°ä½å¤„ç†é¢„æµ‹</span>
<a id="__codelineno-8-118" name="__codelineno-8-118"></a>        <span class="n">preds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_preds</span><span class="p">[</span><span class="bp">cls</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-8-119" name="__codelineno-8-119"></a>
<a id="__codelineno-8-120" name="__codelineno-8-120"></a>        <span class="c1"># è·å–å½“å‰ç±»åˆ«çš„æ‰€æœ‰çœŸå®æ¡†ï¼ŒæŒ‰å›¾åƒåˆ†ç»„</span>
<a id="__codelineno-8-121" name="__codelineno-8-121"></a>        <span class="n">gt_per_image</span> <span class="o">=</span> <span class="n">all_gts</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
<a id="__codelineno-8-122" name="__codelineno-8-122"></a>
<a id="__codelineno-8-123" name="__codelineno-8-123"></a>        <span class="c1"># åˆ›å»ºåŒ¹é…æ ‡è®°å­—å…¸ï¼Œè®°å½•æ¯ä¸ªçœŸå®æ¡†æ˜¯å¦å·²è¢«é¢„æµ‹æ¡†åŒ¹é…</span>
<a id="__codelineno-8-124" name="__codelineno-8-124"></a>        <span class="c1"># ç»“æ„: {image_id: numpy_array_of_booleans}</span>
<a id="__codelineno-8-125" name="__codelineno-8-125"></a>        <span class="n">gt_matched</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-8-126" name="__codelineno-8-126"></a>        <span class="k">for</span> <span class="n">img_id</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="n">gt_per_image</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-8-127" name="__codelineno-8-127"></a>            <span class="n">gt_matched</span><span class="p">[</span><span class="n">img_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<a id="__codelineno-8-128" name="__codelineno-8-128"></a>
<a id="__codelineno-8-129" name="__codelineno-8-129"></a>        <span class="c1"># åˆå§‹åŒ–çœŸæ­£ä¾‹(TP)ã€å‡æ­£ä¾‹(FP)å’Œå¾—åˆ†åˆ—è¡¨</span>
<a id="__codelineno-8-130" name="__codelineno-8-130"></a>        <span class="n">TPs</span><span class="p">,</span> <span class="n">FPs</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-8-131" name="__codelineno-8-131"></a>
<a id="__codelineno-8-132" name="__codelineno-8-132"></a>        <span class="c1"># æŒ‰ç½®ä¿¡åº¦ä»é«˜åˆ°ä½éå†æ‰€æœ‰é¢„æµ‹æ¡†</span>
<a id="__codelineno-8-133" name="__codelineno-8-133"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">img_id</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">:</span>
<a id="__codelineno-8-134" name="__codelineno-8-134"></a>            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>  <span class="c1"># è®°å½•å½“å‰é¢„æµ‹æ¡†çš„å¾—åˆ†</span>
<a id="__codelineno-8-135" name="__codelineno-8-135"></a>
<a id="__codelineno-8-136" name="__codelineno-8-136"></a>            <span class="c1"># è·å–å½“å‰å›¾åƒä¸­è¯¥ç±»åˆ«çš„æ‰€æœ‰çœŸå®æ¡†</span>
<a id="__codelineno-8-137" name="__codelineno-8-137"></a>            <span class="n">gt_boxes</span> <span class="o">=</span> <span class="n">gt_per_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">img_id</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-8-138" name="__codelineno-8-138"></a>
<a id="__codelineno-8-139" name="__codelineno-8-139"></a>            <span class="c1"># å¦‚æœå½“å‰å›¾åƒæ²¡æœ‰è¯¥ç±»åˆ«çš„çœŸå®æ¡†ï¼Œæ‰€æœ‰é¢„æµ‹éƒ½æ˜¯å‡æ­£ä¾‹(FP)</span>
<a id="__codelineno-8-140" name="__codelineno-8-140"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_boxes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-141" name="__codelineno-8-141"></a>                <span class="n">TPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-8-142" name="__codelineno-8-142"></a>                <span class="n">FPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-143" name="__codelineno-8-143"></a>                <span class="k">continue</span>
<a id="__codelineno-8-144" name="__codelineno-8-144"></a>
<a id="__codelineno-8-145" name="__codelineno-8-145"></a>            <span class="c1"># è®¡ç®—å½“å‰é¢„æµ‹æ¡†ä¸æ‰€æœ‰çœŸå®æ¡†çš„ IoU</span>
<a id="__codelineno-8-146" name="__codelineno-8-146"></a>            <span class="n">box_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">box</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># å½“å‰é¢„æµ‹æ¡†</span>
<a id="__codelineno-8-147" name="__codelineno-8-147"></a>            <span class="n">gt_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">gt_boxes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># æ‰€æœ‰çœŸå®æ¡†</span>
<a id="__codelineno-8-148" name="__codelineno-8-148"></a>
<a id="__codelineno-8-149" name="__codelineno-8-149"></a>            <span class="c1"># è®¡ç®— IoU çŸ©é˜µå¹¶è·å–æœ€å¤§å€¼å’Œç´¢å¼•</span>
<a id="__codelineno-8-150" name="__codelineno-8-150"></a>            <span class="n">ious</span> <span class="o">=</span> <span class="n">box_iou_xyxy</span><span class="p">(</span><span class="n">box_t</span><span class="p">,</span> <span class="n">gt_t</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-8-151" name="__codelineno-8-151"></a>            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>  <span class="c1"># æœ€é«˜ IoU çš„ç´¢å¼•</span>
<a id="__codelineno-8-152" name="__codelineno-8-152"></a>            <span class="n">best_iou</span> <span class="o">=</span> <span class="n">ious</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>  <span class="c1"># æœ€é«˜ IoU å€¼</span>
<a id="__codelineno-8-153" name="__codelineno-8-153"></a>
<a id="__codelineno-8-154" name="__codelineno-8-154"></a>            <span class="c1"># åˆ¤æ–­æ˜¯å¦ä¸ºçœŸæ­£ä¾‹(TP)çš„æ¡ä»¶ï¼š</span>
<a id="__codelineno-8-155" name="__codelineno-8-155"></a>            <span class="c1"># 1. IoU è¶…è¿‡åŒ¹é…é˜ˆå€¼ (é€šå¸¸ä¸º 0.5)</span>
<a id="__codelineno-8-156" name="__codelineno-8-156"></a>            <span class="c1"># 2. å¯¹åº”çš„çœŸå®æ¡†å°šæœªè¢«åŒ¹é…</span>
<a id="__codelineno-8-157" name="__codelineno-8-157"></a>            <span class="k">if</span> <span class="n">best_iou</span> <span class="o">&gt;=</span> <span class="n">iou_match</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">gt_matched</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="n">best_idx</span><span class="p">]:</span>
<a id="__codelineno-8-158" name="__codelineno-8-158"></a>                <span class="n">TPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># çœŸæ­£ä¾‹</span>
<a id="__codelineno-8-159" name="__codelineno-8-159"></a>                <span class="n">FPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># ä¸æ˜¯å‡æ­£ä¾‹</span>
<a id="__codelineno-8-160" name="__codelineno-8-160"></a>                <span class="n">gt_matched</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="n">best_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># æ ‡è®°è¯¥çœŸå®æ¡†å·²è¢«åŒ¹é…</span>
<a id="__codelineno-8-161" name="__codelineno-8-161"></a>                <span class="n">iou_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_iou</span><span class="p">)</span>  <span class="c1"># è®°å½•åŒ¹é…æ¡†çš„ IoU</span>
<a id="__codelineno-8-162" name="__codelineno-8-162"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-163" name="__codelineno-8-163"></a>                <span class="n">TPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># ä¸æ˜¯çœŸæ­£ä¾‹</span>
<a id="__codelineno-8-164" name="__codelineno-8-164"></a>                <span class="n">FPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># å‡æ­£ä¾‹</span>
<a id="__codelineno-8-165" name="__codelineno-8-165"></a>
<a id="__codelineno-8-166" name="__codelineno-8-166"></a>        <span class="c1"># è½¬æ¢ä¸º numpy æ•°ç»„ä»¥ä¾¿å‘é‡åŒ–è®¡ç®—</span>
<a id="__codelineno-8-167" name="__codelineno-8-167"></a>        <span class="n">TPs</span><span class="p">,</span> <span class="n">FPs</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TPs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">FPs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
<a id="__codelineno-8-168" name="__codelineno-8-168"></a>
<a id="__codelineno-8-169" name="__codelineno-8-169"></a>        <span class="c1"># è®¡ç®—ç´¯ç§¯çœŸæ­£ä¾‹å’Œå‡æ­£ä¾‹æ•°é‡</span>
<a id="__codelineno-8-170" name="__codelineno-8-170"></a>        <span class="n">cum_TP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">TPs</span><span class="p">)</span>
<a id="__codelineno-8-171" name="__codelineno-8-171"></a>        <span class="n">cum_FP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">FPs</span><span class="p">)</span>
<a id="__codelineno-8-172" name="__codelineno-8-172"></a>
<a id="__codelineno-8-173" name="__codelineno-8-173"></a>        <span class="c1"># è®¡ç®—å½“å‰ç±»åˆ«çš„çœŸå®æ¡†æ€»æ•°</span>
<a id="__codelineno-8-174" name="__codelineno-8-174"></a>        <span class="n">total_gts</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gt_per_image</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-8-175" name="__codelineno-8-175"></a>
<a id="__codelineno-8-176" name="__codelineno-8-176"></a>        <span class="c1"># å¦‚æœæ²¡æœ‰çœŸå®æ¡†ï¼ŒAP è®¾ä¸º 0</span>
<a id="__codelineno-8-177" name="__codelineno-8-177"></a>        <span class="k">if</span> <span class="n">total_gts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-178" name="__codelineno-8-178"></a>            <span class="n">aps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-8-179" name="__codelineno-8-179"></a>            <span class="k">continue</span>
<a id="__codelineno-8-180" name="__codelineno-8-180"></a>
<a id="__codelineno-8-181" name="__codelineno-8-181"></a>        <span class="c1"># è®¡ç®—å¬å›ç‡å’Œç²¾ç¡®ç‡æ›²çº¿</span>
<a id="__codelineno-8-182" name="__codelineno-8-182"></a>        <span class="c1"># å¬å›ç‡ = çœŸæ­£ä¾‹æ•° / æ€»çœŸå®æ¡†æ•°</span>
<a id="__codelineno-8-183" name="__codelineno-8-183"></a>        <span class="n">recalls</span> <span class="o">=</span> <span class="n">cum_TP</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_gts</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-8-184" name="__codelineno-8-184"></a>
<a id="__codelineno-8-185" name="__codelineno-8-185"></a>        <span class="c1"># ç²¾ç¡®ç‡ = çœŸæ­£ä¾‹æ•° / (çœŸæ­£ä¾‹æ•° + å‡æ­£ä¾‹æ•°)</span>
<a id="__codelineno-8-186" name="__codelineno-8-186"></a>        <span class="n">precisions</span> <span class="o">=</span> <span class="n">cum_TP</span> <span class="o">/</span> <span class="p">(</span><span class="n">cum_TP</span> <span class="o">+</span> <span class="n">cum_FP</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-8-187" name="__codelineno-8-187"></a>
<a id="__codelineno-8-188" name="__codelineno-8-188"></a>        <span class="c1"># ä½¿ç”¨ 11ç‚¹æ’å€¼æ³•è®¡ç®— AP (Average Precision)</span>
<a id="__codelineno-8-189" name="__codelineno-8-189"></a>        <span class="c1"># è¿™æ˜¯ PASCAL VOC æŒ‘æˆ˜èµ›çš„æ ‡å‡†è¯„ä¼°æ–¹æ³•</span>
<a id="__codelineno-8-190" name="__codelineno-8-190"></a>        <span class="n">ap</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-8-191" name="__codelineno-8-191"></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>  <span class="c1"># åœ¨ [0, 1] åŒºé—´å‡åŒ€å–11ä¸ªç‚¹</span>
<a id="__codelineno-8-192" name="__codelineno-8-192"></a>            <span class="c1"># å¯¹äºæ¯ä¸ªå¬å›ç‡é˜ˆå€¼ tï¼Œæ‰¾åˆ°æ‰€æœ‰å¬å›ç‡ â‰¥ t çš„ç²¾ç¡®ç‡æœ€å¤§å€¼</span>
<a id="__codelineno-8-193" name="__codelineno-8-193"></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">precisions</span><span class="p">[</span><span class="n">recalls</span> <span class="o">&gt;=</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">recalls</span> <span class="o">&gt;=</span> <span class="n">t</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-8-194" name="__codelineno-8-194"></a>            <span class="n">ap</span> <span class="o">+=</span> <span class="n">p</span> <span class="o">/</span> <span class="mf">11.0</span>  <span class="c1"># å¹³å‡è¿™äº›ç²¾ç¡®ç‡å€¼</span>
<a id="__codelineno-8-195" name="__codelineno-8-195"></a>
<a id="__codelineno-8-196" name="__codelineno-8-196"></a>        <span class="n">aps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span>  <span class="c1"># è®°å½•å½“å‰ç±»åˆ«çš„ AP</span>
<a id="__codelineno-8-197" name="__codelineno-8-197"></a>
<a id="__codelineno-8-198" name="__codelineno-8-198"></a>        <span class="c1"># è®¡ç®—ç½®ä¿¡åº¦é˜ˆå€¼ 0.5 ä¸‹çš„ TP, FP, FN</span>
<a id="__codelineno-8-199" name="__codelineno-8-199"></a>        <span class="c1"># è¿™åœ¨å®è·µä¸­å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå®ƒåæ˜ äº†æ¨¡å‹åœ¨å®é™…åº”ç”¨ä¸­çš„æ€§èƒ½</span>
<a id="__codelineno-8-200" name="__codelineno-8-200"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&gt;=</span> <span class="mf">0.5</span>  <span class="c1"># é€‰æ‹©ç½®ä¿¡åº¦ â‰¥ 0.5 çš„é¢„æµ‹</span>
<a id="__codelineno-8-201" name="__codelineno-8-201"></a>        <span class="n">tp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TPs</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>  <span class="c1"># çœŸæ­£ä¾‹æ•°</span>
<a id="__codelineno-8-202" name="__codelineno-8-202"></a>        <span class="n">fp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">FPs</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>  <span class="c1"># å‡æ­£ä¾‹æ•°</span>
<a id="__codelineno-8-203" name="__codelineno-8-203"></a>        <span class="n">fn</span> <span class="o">=</span> <span class="n">total_gts</span> <span class="o">-</span> <span class="n">tp</span>  <span class="c1"># å‡åä¾‹æ•° = æ€»çœŸå®æ¡†æ•° - çœŸæ­£ä¾‹æ•°</span>
<a id="__codelineno-8-204" name="__codelineno-8-204"></a>
<a id="__codelineno-8-205" name="__codelineno-8-205"></a>        <span class="c1"># ç´¯åŠ åˆ°å…¨å±€è®¡æ•°</span>
<a id="__codelineno-8-206" name="__codelineno-8-206"></a>        <span class="n">tp_total</span> <span class="o">+=</span> <span class="n">tp</span>
<a id="__codelineno-8-207" name="__codelineno-8-207"></a>        <span class="n">fp_total</span> <span class="o">+=</span> <span class="n">fp</span>
<a id="__codelineno-8-208" name="__codelineno-8-208"></a>        <span class="n">fn_total</span> <span class="o">+=</span> <span class="n">fn</span>
<a id="__codelineno-8-209" name="__codelineno-8-209"></a>
<a id="__codelineno-8-210" name="__codelineno-8-210"></a>    <span class="c1"># è®¡ç®—æœ€ç»ˆè¯„ä¼°æŒ‡æ ‡</span>
<a id="__codelineno-8-211" name="__codelineno-8-211"></a>    <span class="c1"># mAP: æ‰€æœ‰ç±»åˆ« AP çš„å¹³å‡å€¼ï¼Œæ˜¯ç›®æ ‡æ£€æµ‹çš„ä¸»è¦è¯„ä¼°æŒ‡æ ‡</span>
<a id="__codelineno-8-212" name="__codelineno-8-212"></a>    <span class="n">mAP</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aps</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aps</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-8-213" name="__codelineno-8-213"></a>
<a id="__codelineno-8-214" name="__codelineno-8-214"></a>    <span class="c1"># å¹³å‡ IoU: æ‰€æœ‰åŒ¹é…æ¡†çš„ IoU å¹³å‡å€¼ï¼Œåæ˜ å®šä½ç²¾åº¦</span>
<a id="__codelineno-8-215" name="__codelineno-8-215"></a>    <span class="n">mean_iou_matched</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">iou_list</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iou_list</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-8-216" name="__codelineno-8-216"></a>
<a id="__codelineno-8-217" name="__codelineno-8-217"></a>    <span class="c1"># ç½®ä¿¡åº¦é˜ˆå€¼ 0.5 ä¸‹çš„ç²¾ç¡®ç‡å’Œå¬å›ç‡</span>
<a id="__codelineno-8-218" name="__codelineno-8-218"></a>    <span class="n">precision_05</span> <span class="o">=</span> <span class="n">tp_total</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp_total</span> <span class="o">+</span> <span class="n">fp_total</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-8-219" name="__codelineno-8-219"></a>    <span class="n">recall_05</span> <span class="o">=</span> <span class="n">tp_total</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp_total</span> <span class="o">+</span> <span class="n">fn_total</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-8-220" name="__codelineno-8-220"></a>
<a id="__codelineno-8-221" name="__codelineno-8-221"></a>    <span class="c1"># è¿”å›åŒ…å«æ‰€æœ‰è¯„ä¼°æŒ‡æ ‡çš„å­—å…¸</span>
<a id="__codelineno-8-222" name="__codelineno-8-222"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-8-223" name="__codelineno-8-223"></a>        <span class="s1">'mAP_50'</span><span class="p">:</span> <span class="n">mAP</span><span class="p">,</span>  <span class="c1"># ä½¿ç”¨ IoU é˜ˆå€¼ 0.5 çš„ mAP</span>
<a id="__codelineno-8-224" name="__codelineno-8-224"></a>        <span class="s1">'mean_iou_matched'</span><span class="p">:</span> <span class="n">mean_iou_matched</span><span class="p">,</span>  <span class="c1"># åŒ¹é…æ¡†çš„å¹³å‡ IoU</span>
<a id="__codelineno-8-225" name="__codelineno-8-225"></a>        <span class="s1">'precision@0.5'</span><span class="p">:</span> <span class="n">precision_05</span><span class="p">,</span>  <span class="c1"># ç½®ä¿¡åº¦é˜ˆå€¼ 0.5 ä¸‹çš„ç²¾ç¡®ç‡</span>
<a id="__codelineno-8-226" name="__codelineno-8-226"></a>        <span class="s1">'recall@0.5'</span><span class="p">:</span> <span class="n">recall_05</span><span class="p">,</span>  <span class="c1"># ç½®ä¿¡åº¦é˜ˆå€¼ 0.5 ä¸‹çš„å¬å›ç‡</span>
<a id="__codelineno-8-227" name="__codelineno-8-227"></a>        <span class="s1">'AP_per_class'</span><span class="p">:</span> <span class="n">aps</span>  <span class="c1"># æ¯ä¸ªç±»åˆ«çš„ AP å€¼ï¼Œç”¨äºåˆ†æç±»åˆ«ç‰¹å¼‚æ€§æ€§èƒ½</span>
<a id="__codelineno-8-228" name="__codelineno-8-228"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
<h4 id="_17">å¯è§†åŒ–<a class="headerlink" href="#_17" title="Permanent link">Â¶</a></h4>
<p>è¿™é‡Œå®ç°äº†é€šè¿‡æ‘„åƒå¤´è§†é¢‘æµè¿›è¡Œ<strong>å®æ—¶ç›®æ ‡æ£€æµ‹</strong>ã€‚</p>
<details>
<summary> å®æ—¶ç›®æ ‡æ£€æµ‹ä½¿ç”¨çš„ä»£ç  </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">  1</a></span>
<span class="normal"><a href="#__codelineno-9-2">  2</a></span>
<span class="normal"><a href="#__codelineno-9-3">  3</a></span>
<span class="normal"><a href="#__codelineno-9-4">  4</a></span>
<span class="normal"><a href="#__codelineno-9-5">  5</a></span>
<span class="normal"><a href="#__codelineno-9-6">  6</a></span>
<span class="normal"><a href="#__codelineno-9-7">  7</a></span>
<span class="normal"><a href="#__codelineno-9-8">  8</a></span>
<span class="normal"><a href="#__codelineno-9-9">  9</a></span>
<span class="normal"><a href="#__codelineno-9-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-9-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-9-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-9-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-9-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-9-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-9-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-9-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-9-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-9-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-9-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-9-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-9-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-9-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-9-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-9-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-9-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-9-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-9-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-9-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-9-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-9-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-9-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-9-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-9-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-9-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-9-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-9-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-9-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-9-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-9-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-9-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-9-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-9-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-9-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-9-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-9-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-9-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-9-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-9-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-9-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-9-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-9-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-9-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-9-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-9-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-9-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-9-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-9-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-9-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-9-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-9-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-9-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-9-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-9-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-9-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-9-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-9-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-9-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-9-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-9-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-9-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-9-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-9-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-9-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-9-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-9-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-9-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-9-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-9-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-9-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-9-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-9-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-9-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-9-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-9-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-9-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-9-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-9-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-9-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-9-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-9-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-9-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-9-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-9-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-9-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-9-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-9-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-9-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-9-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-9-100">100</a></span>
<span class="normal"><a href="#__codelineno-9-101">101</a></span>
<span class="normal"><a href="#__codelineno-9-102">102</a></span>
<span class="normal"><a href="#__codelineno-9-103">103</a></span>
<span class="normal"><a href="#__codelineno-9-104">104</a></span>
<span class="normal"><a href="#__codelineno-9-105">105</a></span>
<span class="normal"><a href="#__codelineno-9-106">106</a></span>
<span class="normal"><a href="#__codelineno-9-107">107</a></span>
<span class="normal"><a href="#__codelineno-9-108">108</a></span>
<span class="normal"><a href="#__codelineno-9-109">109</a></span>
<span class="normal"><a href="#__codelineno-9-110">110</a></span>
<span class="normal"><a href="#__codelineno-9-111">111</a></span>
<span class="normal"><a href="#__codelineno-9-112">112</a></span>
<span class="normal"><a href="#__codelineno-9-113">113</a></span>
<span class="normal"><a href="#__codelineno-9-114">114</a></span>
<span class="normal"><a href="#__codelineno-9-115">115</a></span>
<span class="normal"><a href="#__codelineno-9-116">116</a></span>
<span class="normal"><a href="#__codelineno-9-117">117</a></span>
<span class="normal"><a href="#__codelineno-9-118">118</a></span>
<span class="normal"><a href="#__codelineno-9-119">119</a></span>
<span class="normal"><a href="#__codelineno-9-120">120</a></span>
<span class="normal"><a href="#__codelineno-9-121">121</a></span>
<span class="normal"><a href="#__codelineno-9-122">122</a></span>
<span class="normal"><a href="#__codelineno-9-123">123</a></span>
<span class="normal"><a href="#__codelineno-9-124">124</a></span>
<span class="normal"><a href="#__codelineno-9-125">125</a></span>
<span class="normal"><a href="#__codelineno-9-126">126</a></span>
<span class="normal"><a href="#__codelineno-9-127">127</a></span>
<span class="normal"><a href="#__codelineno-9-128">128</a></span>
<span class="normal"><a href="#__codelineno-9-129">129</a></span>
<span class="normal"><a href="#__codelineno-9-130">130</a></span>
<span class="normal"><a href="#__codelineno-9-131">131</a></span>
<span class="normal"><a href="#__codelineno-9-132">132</a></span>
<span class="normal"><a href="#__codelineno-9-133">133</a></span>
<span class="normal"><a href="#__codelineno-9-134">134</a></span>
<span class="normal"><a href="#__codelineno-9-135">135</a></span>
<span class="normal"><a href="#__codelineno-9-136">136</a></span>
<span class="normal"><a href="#__codelineno-9-137">137</a></span>
<span class="normal"><a href="#__codelineno-9-138">138</a></span>
<span class="normal"><a href="#__codelineno-9-139">139</a></span>
<span class="normal"><a href="#__codelineno-9-140">140</a></span>
<span class="normal"><a href="#__codelineno-9-141">141</a></span>
<span class="normal"><a href="#__codelineno-9-142">142</a></span>
<span class="normal"><a href="#__codelineno-9-143">143</a></span>
<span class="normal"><a href="#__codelineno-9-144">144</a></span>
<span class="normal"><a href="#__codelineno-9-145">145</a></span>
<span class="normal"><a href="#__codelineno-9-146">146</a></span>
<span class="normal"><a href="#__codelineno-9-147">147</a></span>
<span class="normal"><a href="#__codelineno-9-148">148</a></span>
<span class="normal"><a href="#__codelineno-9-149">149</a></span>
<span class="normal"><a href="#__codelineno-9-150">150</a></span>
<span class="normal"><a href="#__codelineno-9-151">151</a></span>
<span class="normal"><a href="#__codelineno-9-152">152</a></span>
<span class="normal"><a href="#__codelineno-9-153">153</a></span>
<span class="normal"><a href="#__codelineno-9-154">154</a></span>
<span class="normal"><a href="#__codelineno-9-155">155</a></span>
<span class="normal"><a href="#__codelineno-9-156">156</a></span>
<span class="normal"><a href="#__codelineno-9-157">157</a></span>
<span class="normal"><a href="#__codelineno-9-158">158</a></span>
<span class="normal"><a href="#__codelineno-9-159">159</a></span>
<span class="normal"><a href="#__codelineno-9-160">160</a></span>
<span class="normal"><a href="#__codelineno-9-161">161</a></span>
<span class="normal"><a href="#__codelineno-9-162">162</a></span>
<span class="normal"><a href="#__codelineno-9-163">163</a></span>
<span class="normal"><a href="#__codelineno-9-164">164</a></span>
<span class="normal"><a href="#__codelineno-9-165">165</a></span>
<span class="normal"><a href="#__codelineno-9-166">166</a></span>
<span class="normal"><a href="#__codelineno-9-167">167</a></span>
<span class="normal"><a href="#__codelineno-9-168">168</a></span>
<span class="normal"><a href="#__codelineno-9-169">169</a></span>
<span class="normal"><a href="#__codelineno-9-170">170</a></span>
<span class="normal"><a href="#__codelineno-9-171">171</a></span>
<span class="normal"><a href="#__codelineno-9-172">172</a></span>
<span class="normal"><a href="#__codelineno-9-173">173</a></span>
<span class="normal"><a href="#__codelineno-9-174">174</a></span>
<span class="normal"><a href="#__codelineno-9-175">175</a></span>
<span class="normal"><a href="#__codelineno-9-176">176</a></span>
<span class="normal"><a href="#__codelineno-9-177">177</a></span>
<span class="normal"><a href="#__codelineno-9-178">178</a></span>
<span class="normal"><a href="#__codelineno-9-179">179</a></span>
<span class="normal"><a href="#__codelineno-9-180">180</a></span>
<span class="normal"><a href="#__codelineno-9-181">181</a></span>
<span class="normal"><a href="#__codelineno-9-182">182</a></span>
<span class="normal"><a href="#__codelineno-9-183">183</a></span>
<span class="normal"><a href="#__codelineno-9-184">184</a></span>
<span class="normal"><a href="#__codelineno-9-185">185</a></span>
<span class="normal"><a href="#__codelineno-9-186">186</a></span>
<span class="normal"><a href="#__codelineno-9-187">187</a></span>
<span class="normal"><a href="#__codelineno-9-188">188</a></span>
<span class="normal"><a href="#__codelineno-9-189">189</a></span>
<span class="normal"><a href="#__codelineno-9-190">190</a></span>
<span class="normal"><a href="#__codelineno-9-191">191</a></span>
<span class="normal"><a href="#__codelineno-9-192">192</a></span>
<span class="normal"><a href="#__codelineno-9-193">193</a></span>
<span class="normal"><a href="#__codelineno-9-194">194</a></span>
<span class="normal"><a href="#__codelineno-9-195">195</a></span>
<span class="normal"><a href="#__codelineno-9-196">196</a></span>
<span class="normal"><a href="#__codelineno-9-197">197</a></span>
<span class="normal"><a href="#__codelineno-9-198">198</a></span>
<span class="normal"><a href="#__codelineno-9-199">199</a></span>
<span class="normal"><a href="#__codelineno-9-200">200</a></span>
<span class="normal"><a href="#__codelineno-9-201">201</a></span>
<span class="normal"><a href="#__codelineno-9-202">202</a></span>
<span class="normal"><a href="#__codelineno-9-203">203</a></span>
<span class="normal"><a href="#__codelineno-9-204">204</a></span>
<span class="normal"><a href="#__codelineno-9-205">205</a></span>
<span class="normal"><a href="#__codelineno-9-206">206</a></span>
<span class="normal"><a href="#__codelineno-9-207">207</a></span>
<span class="normal"><a href="#__codelineno-9-208">208</a></span>
<span class="normal"><a href="#__codelineno-9-209">209</a></span>
<span class="normal"><a href="#__codelineno-9-210">210</a></span>
<span class="normal"><a href="#__codelineno-9-211">211</a></span>
<span class="normal"><a href="#__codelineno-9-212">212</a></span>
<span class="normal"><a href="#__codelineno-9-213">213</a></span>
<span class="normal"><a href="#__codelineno-9-214">214</a></span>
<span class="normal"><a href="#__codelineno-9-215">215</a></span>
<span class="normal"><a href="#__codelineno-9-216">216</a></span>
<span class="normal"><a href="#__codelineno-9-217">217</a></span>
<span class="normal"><a href="#__codelineno-9-218">218</a></span>
<span class="normal"><a href="#__codelineno-9-219">219</a></span>
<span class="normal"><a href="#__codelineno-9-220">220</a></span>
<span class="normal"><a href="#__codelineno-9-221">221</a></span>
<span class="normal"><a href="#__codelineno-9-222">222</a></span>
<span class="normal"><a href="#__codelineno-9-223">223</a></span>
<span class="normal"><a href="#__codelineno-9-224">224</a></span>
<span class="normal"><a href="#__codelineno-9-225">225</a></span>
<span class="normal"><a href="#__codelineno-9-226">226</a></span>
<span class="normal"><a href="#__codelineno-9-227">227</a></span>
<span class="normal"><a href="#__codelineno-9-228">228</a></span>
<span class="normal"><a href="#__codelineno-9-229">229</a></span>
<span class="normal"><a href="#__codelineno-9-230">230</a></span>
<span class="normal"><a href="#__codelineno-9-231">231</a></span>
<span class="normal"><a href="#__codelineno-9-232">232</a></span>
<span class="normal"><a href="#__codelineno-9-233">233</a></span>
<span class="normal"><a href="#__codelineno-9-234">234</a></span>
<span class="normal"><a href="#__codelineno-9-235">235</a></span>
<span class="normal"><a href="#__codelineno-9-236">236</a></span>
<span class="normal"><a href="#__codelineno-9-237">237</a></span>
<span class="normal"><a href="#__codelineno-9-238">238</a></span>
<span class="normal"><a href="#__codelineno-9-239">239</a></span>
<span class="normal"><a href="#__codelineno-9-240">240</a></span>
<span class="normal"><a href="#__codelineno-9-241">241</a></span>
<span class="normal"><a href="#__codelineno-9-242">242</a></span>
<span class="normal"><a href="#__codelineno-9-243">243</a></span>
<span class="normal"><a href="#__codelineno-9-244">244</a></span>
<span class="normal"><a href="#__codelineno-9-245">245</a></span>
<span class="normal"><a href="#__codelineno-9-246">246</a></span>
<span class="normal"><a href="#__codelineno-9-247">247</a></span>
<span class="normal"><a href="#__codelineno-9-248">248</a></span>
<span class="normal"><a href="#__codelineno-9-249">249</a></span>
<span class="normal"><a href="#__codelineno-9-250">250</a></span>
<span class="normal"><a href="#__codelineno-9-251">251</a></span>
<span class="normal"><a href="#__codelineno-9-252">252</a></span>
<span class="normal"><a href="#__codelineno-9-253">253</a></span>
<span class="normal"><a href="#__codelineno-9-254">254</a></span>
<span class="normal"><a href="#__codelineno-9-255">255</a></span>
<span class="normal"><a href="#__codelineno-9-256">256</a></span>
<span class="normal"><a href="#__codelineno-9-257">257</a></span>
<span class="normal"><a href="#__codelineno-9-258">258</a></span>
<span class="normal"><a href="#__codelineno-9-259">259</a></span>
<span class="normal"><a href="#__codelineno-9-260">260</a></span>
<span class="normal"><a href="#__codelineno-9-261">261</a></span>
<span class="normal"><a href="#__codelineno-9-262">262</a></span>
<span class="normal"><a href="#__codelineno-9-263">263</a></span>
<span class="normal"><a href="#__codelineno-9-264">264</a></span>
<span class="normal"><a href="#__codelineno-9-265">265</a></span>
<span class="normal"><a href="#__codelineno-9-266">266</a></span>
<span class="normal"><a href="#__codelineno-9-267">267</a></span>
<span class="normal"><a href="#__codelineno-9-268">268</a></span>
<span class="normal"><a href="#__codelineno-9-269">269</a></span>
<span class="normal"><a href="#__codelineno-9-270">270</a></span>
<span class="normal"><a href="#__codelineno-9-271">271</a></span>
<span class="normal"><a href="#__codelineno-9-272">272</a></span>
<span class="normal"><a href="#__codelineno-9-273">273</a></span>
<span class="normal"><a href="#__codelineno-9-274">274</a></span>
<span class="normal"><a href="#__codelineno-9-275">275</a></span>
<span class="normal"><a href="#__codelineno-9-276">276</a></span>
<span class="normal"><a href="#__codelineno-9-277">277</a></span>
<span class="normal"><a href="#__codelineno-9-278">278</a></span>
<span class="normal"><a href="#__codelineno-9-279">279</a></span>
<span class="normal"><a href="#__codelineno-9-280">280</a></span>
<span class="normal"><a href="#__codelineno-9-281">281</a></span>
<span class="normal"><a href="#__codelineno-9-282">282</a></span>
<span class="normal"><a href="#__codelineno-9-283">283</a></span>
<span class="normal"><a href="#__codelineno-9-284">284</a></span>
<span class="normal"><a href="#__codelineno-9-285">285</a></span>
<span class="normal"><a href="#__codelineno-9-286">286</a></span>
<span class="normal"><a href="#__codelineno-9-287">287</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">ResNet18_Weights</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">regnet_y_1_6gf</span><span class="p">,</span> <span class="n">RegNet_Y_1_6GF_Weights</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="c1"># å…¨å±€é…ç½® (ä»…ä¿ç•™æ¨ç†å¿…è¦å‚æ•°)</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="n">S</span> <span class="o">=</span> <span class="mi">7</span>   <span class="c1"># ç½‘æ ¼å¤§å°</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="n">B</span> <span class="o">=</span> <span class="mi">2</span>   <span class="c1"># æ¯ä¸ªç½‘æ ¼çš„è¾¹ç•Œæ¡†æ•°é‡</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="n">C</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># VOCç±»åˆ«æ•°é‡</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="mi">448</span>  <span class="c1"># è¾“å…¥å›¾åƒå°ºå¯¸</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="n">DEVICE</span> <span class="o">=</span> <span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'xpu'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">xpu</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="n">AUTOCAST_ENABLED</span> <span class="o">=</span> <span class="p">(</span><span class="n">DEVICE</span> <span class="o">==</span> <span class="s1">'cuda'</span> <span class="ow">or</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s1">'xpu'</span><span class="p">)</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="c1"># VOCç±»åˆ«æ˜ å°„</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="n">VOC_CLASSES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a>    <span class="s1">'aeroplane'</span><span class="p">,</span><span class="s1">'bicycle'</span><span class="p">,</span><span class="s1">'bird'</span><span class="p">,</span><span class="s1">'boat'</span><span class="p">,</span><span class="s1">'bottle'</span><span class="p">,</span><span class="s1">'bus'</span><span class="p">,</span><span class="s1">'car'</span><span class="p">,</span><span class="s1">'cat'</span><span class="p">,</span><span class="s1">'chair'</span><span class="p">,</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a>    <span class="s1">'cow'</span><span class="p">,</span><span class="s1">'diningtable'</span><span class="p">,</span><span class="s1">'dog'</span><span class="p">,</span><span class="s1">'horse'</span><span class="p">,</span><span class="s1">'motorbike'</span><span class="p">,</span><span class="s1">'person'</span><span class="p">,</span><span class="s1">'pottedplant'</span><span class="p">,</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a>    <span class="s1">'sheep'</span><span class="p">,</span><span class="s1">'sofa'</span><span class="p">,</span><span class="s1">'train'</span><span class="p">,</span><span class="s1">'tvmonitor'</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="p">]</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="n">CLASS_TO_IDX</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">VOC_CLASSES</span><span class="p">)}</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="n">IDX_TO_CLASS</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="n">CLASS_TO_IDX</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="c1"># è¾¹ç•Œæ¡†å·¥å…·å‡½æ•°</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="k">def</span><span class="w"> </span><span class="nf">box_iou_xyxy</span><span class="p">(</span><span class="n">boxes1</span><span class="p">,</span> <span class="n">boxes2</span><span class="p">):</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a>    <span class="c1"># boxes1: [N, 4], boxes2: [M, 4]</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a>    <span class="n">N</span> <span class="o">=</span> <span class="n">boxes1</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a>    <span class="n">M</span> <span class="o">=</span> <span class="n">boxes2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a>    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">M</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-42" name="__codelineno-9-42"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">boxes1</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-9-43" name="__codelineno-9-43"></a>    <span class="n">lt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">boxes1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">boxes2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>   <span class="c1"># [N,M,2]</span>
<a id="__codelineno-9-44" name="__codelineno-9-44"></a>    <span class="n">rb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">boxes1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">:],</span> <span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>   <span class="c1"># [N,M,2]</span>
<a id="__codelineno-9-45" name="__codelineno-9-45"></a>    <span class="n">wh</span> <span class="o">=</span> <span class="p">(</span><span class="n">rb</span> <span class="o">-</span> <span class="n">lt</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-46" name="__codelineno-9-46"></a>    <span class="n">inter</span> <span class="o">=</span> <span class="n">wh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">wh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-9-47" name="__codelineno-9-47"></a>    <span class="n">area1</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">boxes1</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-48" name="__codelineno-9-48"></a>    <span class="n">area2</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-49" name="__codelineno-9-49"></a>    <span class="n">union</span> <span class="o">=</span> <span class="n">area1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">area2</span> <span class="o">-</span> <span class="n">inter</span>
<a id="__codelineno-9-50" name="__codelineno-9-50"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">/</span> <span class="p">(</span><span class="n">union</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-9-51" name="__codelineno-9-51"></a>    <span class="k">return</span> <span class="n">iou</span>
<a id="__codelineno-9-52" name="__codelineno-9-52"></a>
<a id="__codelineno-9-53" name="__codelineno-9-53"></a><span class="k">def</span><span class="w"> </span><span class="nf">cxcywh_to_xyxy</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
<a id="__codelineno-9-54" name="__codelineno-9-54"></a>    <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-9-55" name="__codelineno-9-55"></a>    <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx</span> <span class="o">-</span> <span class="n">w</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-9-56" name="__codelineno-9-56"></a>    <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cy</span> <span class="o">-</span> <span class="n">h</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-9-57" name="__codelineno-9-57"></a>    <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-9-58" name="__codelineno-9-58"></a>    <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">cy</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-9-59" name="__codelineno-9-59"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-60" name="__codelineno-9-60"></a>
<a id="__codelineno-9-61" name="__codelineno-9-61"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-62" name="__codelineno-9-62"></a><span class="c1"># YOLOv1æ¨¡å‹å®šä¹‰</span>
<a id="__codelineno-9-63" name="__codelineno-9-63"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-64" name="__codelineno-9-64"></a><span class="k">class</span><span class="w"> </span><span class="nc">YOLOv1ResNet18</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-9-65" name="__codelineno-9-65"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-9-66" name="__codelineno-9-66"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-9-67" name="__codelineno-9-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
<a id="__codelineno-9-68" name="__codelineno-9-68"></a>        <span class="n">backbone</span> <span class="o">=</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">ResNet18_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span> <span class="k">if</span> <span class="n">pretrained</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-9-69" name="__codelineno-9-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stem</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-9-70" name="__codelineno-9-70"></a>            <span class="n">backbone</span><span class="o">.</span><span class="n">conv1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">bn1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">maxpool</span><span class="p">,</span>
<a id="__codelineno-9-71" name="__codelineno-9-71"></a>            <span class="n">backbone</span><span class="o">.</span><span class="n">layer1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer2</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer3</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer4</span>
<a id="__codelineno-9-72" name="__codelineno-9-72"></a>        <span class="p">)</span>
<a id="__codelineno-9-73" name="__codelineno-9-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-9-74" name="__codelineno-9-74"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-9-75" name="__codelineno-9-75"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<a id="__codelineno-9-76" name="__codelineno-9-76"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-77" name="__codelineno-9-77"></a>        <span class="p">)</span>
<a id="__codelineno-9-78" name="__codelineno-9-78"></a>        <span class="n">out_ch</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span> <span class="n">c</span>
<a id="__codelineno-9-79" name="__codelineno-9-79"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-9-80" name="__codelineno-9-80"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-9-81" name="__codelineno-9-81"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<a id="__codelineno-9-82" name="__codelineno-9-82"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-9-83" name="__codelineno-9-83"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-84" name="__codelineno-9-84"></a>        <span class="p">)</span>
<a id="__codelineno-9-85" name="__codelineno-9-85"></a>
<a id="__codelineno-9-86" name="__codelineno-9-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-9-87" name="__codelineno-9-87"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># [N,512,14,14] è¾“å…¥ä¸º448x448æ—¶</span>
<a id="__codelineno-9-88" name="__codelineno-9-88"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   <span class="c1"># [N,1024,7,7]</span>
<a id="__codelineno-9-89" name="__codelineno-9-89"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># [N,(B*5+C),7,7]</span>
<a id="__codelineno-9-90" name="__codelineno-9-90"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
<a id="__codelineno-9-91" name="__codelineno-9-91"></a>        <span class="k">return</span> <span class="n">x</span>  <span class="c1"># [N,S,S,B*5+C]</span>
<a id="__codelineno-9-92" name="__codelineno-9-92"></a>
<a id="__codelineno-9-93" name="__codelineno-9-93"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-94" name="__codelineno-9-94"></a><span class="c1"># é¢„æµ‹è§£ç ä¸åå¤„ç†</span>
<a id="__codelineno-9-95" name="__codelineno-9-95"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-96" name="__codelineno-9-96"></a><span class="k">def</span><span class="w"> </span><span class="nf">yolo_decode</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<a id="__codelineno-9-97" name="__codelineno-9-97"></a><span class="w">    </span><span class="sd">"""å°†æ¨¡å‹è¾“å‡ºè§£ç ä¸ºè¾¹ç•Œæ¡† [x1,y1,x2,y2,score,cls] (å½’ä¸€åŒ–åæ ‡)"""</span>
<a id="__codelineno-9-98" name="__codelineno-9-98"></a>    <span class="n">N</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-99" name="__codelineno-9-99"></a>    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="o">*</span><span class="mi">5</span><span class="o">+</span><span class="n">C</span><span class="p">)</span>
<a id="__codelineno-9-100" name="__codelineno-9-100"></a>    <span class="n">boxes</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="n">B</span><span class="o">*</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-9-101" name="__codelineno-9-101"></a>    <span class="n">cls_logits</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">B</span><span class="o">*</span><span class="mi">5</span><span class="p">:]</span>  <span class="c1"># [N,S,S,C]</span>
<a id="__codelineno-9-102" name="__codelineno-9-102"></a>    <span class="n">cls_prob</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">cls_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-103" name="__codelineno-9-103"></a>
<a id="__codelineno-9-104" name="__codelineno-9-104"></a>    <span class="c1"># ç”Ÿæˆç½‘æ ¼åæ ‡</span>
<a id="__codelineno-9-105" name="__codelineno-9-105"></a>    <span class="n">grid_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-9-106" name="__codelineno-9-106"></a>    <span class="n">grid_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-9-107" name="__codelineno-9-107"></a>    <span class="n">gy</span><span class="p">,</span> <span class="n">gx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">grid_y</span><span class="p">,</span> <span class="n">grid_x</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">'ij'</span><span class="p">)</span>
<a id="__codelineno-9-108" name="__codelineno-9-108"></a>    <span class="n">gx</span> <span class="o">=</span> <span class="n">gx</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-9-109" name="__codelineno-9-109"></a>    <span class="n">gy</span> <span class="o">=</span> <span class="n">gy</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-9-110" name="__codelineno-9-110"></a>
<a id="__codelineno-9-111" name="__codelineno-9-111"></a>    <span class="c1"># è§£ç è¾¹ç•Œæ¡†</span>
<a id="__codelineno-9-112" name="__codelineno-9-112"></a>    <span class="n">px</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
<a id="__codelineno-9-113" name="__codelineno-9-113"></a>    <span class="n">py</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
<a id="__codelineno-9-114" name="__codelineno-9-114"></a>    <span class="n">pw</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-9-115" name="__codelineno-9-115"></a>    <span class="n">ph</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-9-116" name="__codelineno-9-116"></a>    <span class="n">pconf</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
<a id="__codelineno-9-117" name="__codelineno-9-117"></a>
<a id="__codelineno-9-118" name="__codelineno-9-118"></a>    <span class="c1"># è½¬æ¢ä¸ºå½’ä¸€åŒ–åæ ‡</span>
<a id="__codelineno-9-119" name="__codelineno-9-119"></a>    <span class="n">pcx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gx</span> <span class="o">+</span> <span class="n">px</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-9-120" name="__codelineno-9-120"></a>    <span class="n">pcy</span> <span class="o">=</span> <span class="p">(</span><span class="n">gy</span> <span class="o">+</span> <span class="n">py</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-9-121" name="__codelineno-9-121"></a>    <span class="n">p_cxcywh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">pcx</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">pcy</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">pw</span><span class="p">,</span> <span class="n">ph</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-122" name="__codelineno-9-122"></a>    <span class="n">p_xyxy</span> <span class="o">=</span> <span class="n">cxcywh_to_xyxy</span><span class="p">(</span><span class="n">p_cxcywh</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-123" name="__codelineno-9-123"></a>
<a id="__codelineno-9-124" name="__codelineno-9-124"></a>    <span class="n">dets_per_image</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-125" name="__codelineno-9-125"></a>    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<a id="__codelineno-9-126" name="__codelineno-9-126"></a>        <span class="n">boxes_n</span> <span class="o">=</span> <span class="n">p_xyxy</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>      <span class="c1"># [S*S*B,4]</span>
<a id="__codelineno-9-127" name="__codelineno-9-127"></a>        <span class="n">conf_n</span> <span class="o">=</span> <span class="n">pconf</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c1"># [S*S*B,1]</span>
<a id="__codelineno-9-128" name="__codelineno-9-128"></a>        <span class="n">cls_prob_n</span> <span class="o">=</span> <span class="n">cls_prob</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">S</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
<a id="__codelineno-9-129" name="__codelineno-9-129"></a>        <span class="n">cls_prob_expand</span> <span class="o">=</span> <span class="n">cls_prob_n</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [S*S*B,C]</span>
<a id="__codelineno-9-130" name="__codelineno-9-130"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">conf_n</span> <span class="o">*</span> <span class="n">cls_prob_expand</span>                          <span class="c1"># [S*S*B,C]</span>
<a id="__codelineno-9-131" name="__codelineno-9-131"></a>        <span class="n">max_scores</span><span class="p">,</span> <span class="n">max_cls</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-132" name="__codelineno-9-132"></a>        <span class="n">keep</span> <span class="o">=</span> <span class="n">max_scores</span> <span class="o">&gt;</span> <span class="n">conf_thresh</span>
<a id="__codelineno-9-133" name="__codelineno-9-133"></a>
<a id="__codelineno-9-134" name="__codelineno-9-134"></a>        <span class="k">if</span> <span class="n">keep</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-135" name="__codelineno-9-135"></a>            <span class="n">dets_per_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-9-136" name="__codelineno-9-136"></a>            <span class="k">continue</span>
<a id="__codelineno-9-137" name="__codelineno-9-137"></a>
<a id="__codelineno-9-138" name="__codelineno-9-138"></a>        <span class="n">boxes_keep</span> <span class="o">=</span> <span class="n">boxes_n</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
<a id="__codelineno-9-139" name="__codelineno-9-139"></a>        <span class="n">scores_keep</span> <span class="o">=</span> <span class="n">max_scores</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
<a id="__codelineno-9-140" name="__codelineno-9-140"></a>        <span class="n">cls_keep</span> <span class="o">=</span> <span class="n">max_cls</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-9-141" name="__codelineno-9-141"></a>        <span class="n">dets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">boxes_keep</span><span class="p">,</span> <span class="n">scores_keep</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cls_keep</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-142" name="__codelineno-9-142"></a>        <span class="n">dets_per_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>
<a id="__codelineno-9-143" name="__codelineno-9-143"></a>
<a id="__codelineno-9-144" name="__codelineno-9-144"></a>    <span class="k">return</span> <span class="n">dets_per_image</span>
<a id="__codelineno-9-145" name="__codelineno-9-145"></a>
<a id="__codelineno-9-146" name="__codelineno-9-146"></a><span class="k">def</span><span class="w"> </span><span class="nf">nms_classwise</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">iou_thr</span><span class="o">=</span><span class="mf">0.45</span><span class="p">):</span>
<a id="__codelineno-9-147" name="__codelineno-9-147"></a><span class="w">    </span><span class="sd">"""æŒ‰ç±»åˆ«è¿›è¡Œéæå¤§å€¼æŠ‘åˆ¶"""</span>
<a id="__codelineno-9-148" name="__codelineno-9-148"></a>    <span class="k">if</span> <span class="n">dets</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-149" name="__codelineno-9-149"></a>        <span class="k">return</span> <span class="n">dets</span>
<a id="__codelineno-9-150" name="__codelineno-9-150"></a>    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-151" name="__codelineno-9-151"></a>    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
<a id="__codelineno-9-152" name="__codelineno-9-152"></a>        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-9-153" name="__codelineno-9-153"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span>
<a id="__codelineno-9-154" name="__codelineno-9-154"></a>        <span class="n">class_dets</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<a id="__codelineno-9-155" name="__codelineno-9-155"></a>        <span class="n">keep_idx</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">nms</span><span class="p">(</span><span class="n">class_dets</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">class_dets</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">iou_thr</span><span class="p">)</span>
<a id="__codelineno-9-156" name="__codelineno-9-156"></a>        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_dets</span><span class="p">[</span><span class="n">keep_idx</span><span class="p">])</span>
<a id="__codelineno-9-157" name="__codelineno-9-157"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">else</span> <span class="n">dets</span>
<a id="__codelineno-9-158" name="__codelineno-9-158"></a>
<a id="__codelineno-9-159" name="__codelineno-9-159"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-160" name="__codelineno-9-160"></a><span class="c1"># æ‘„åƒå¤´å®æ—¶æ£€æµ‹åŠŸèƒ½</span>
<a id="__codelineno-9-161" name="__codelineno-9-161"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-162" name="__codelineno-9-162"></a><span class="k">def</span><span class="w"> </span><span class="nf">preprocess_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">448</span><span class="p">):</span>
<a id="__codelineno-9-163" name="__codelineno-9-163"></a><span class="w">    </span><span class="sd">"""é¢„å¤„ç†æ‘„åƒå¤´å¸§ç”¨äºæ¨¡å‹è¾“å…¥"""</span>
<a id="__codelineno-9-164" name="__codelineno-9-164"></a>    <span class="c1"># è°ƒæ•´å¤§å°</span>
<a id="__codelineno-9-165" name="__codelineno-9-165"></a>    <span class="n">frame_resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">))</span>
<a id="__codelineno-9-166" name="__codelineno-9-166"></a>    <span class="c1"># BGRè½¬RGB</span>
<a id="__codelineno-9-167" name="__codelineno-9-167"></a>    <span class="n">frame_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame_resized</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
<a id="__codelineno-9-168" name="__codelineno-9-168"></a>    <span class="c1"># è½¬æ¢ä¸ºå¼ é‡å¹¶å½’ä¸€åŒ–</span>
<a id="__codelineno-9-169" name="__codelineno-9-169"></a>    <span class="n">frame_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">frame_rgb</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="mf">255.0</span>
<a id="__codelineno-9-170" name="__codelineno-9-170"></a>    <span class="c1"># åº”ç”¨ImageNetæ ‡å‡†åŒ–</span>
<a id="__codelineno-9-171" name="__codelineno-9-171"></a>    <span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
<a id="__codelineno-9-172" name="__codelineno-9-172"></a>        <span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span>
<a id="__codelineno-9-173" name="__codelineno-9-173"></a>        <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]</span>
<a id="__codelineno-9-174" name="__codelineno-9-174"></a>    <span class="p">)</span>
<a id="__codelineno-9-175" name="__codelineno-9-175"></a>    <span class="n">frame_tensor</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">frame_tensor</span><span class="p">)</span>
<a id="__codelineno-9-176" name="__codelineno-9-176"></a>    <span class="c1"># æ·»åŠ æ‰¹æ¬¡ç»´åº¦</span>
<a id="__codelineno-9-177" name="__codelineno-9-177"></a>    <span class="k">return</span> <span class="n">frame_tensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-178" name="__codelineno-9-178"></a>
<a id="__codelineno-9-179" name="__codelineno-9-179"></a><span class="k">def</span><span class="w"> </span><span class="nf">draw_detections</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">img_size</span><span class="p">):</span>
<a id="__codelineno-9-180" name="__codelineno-9-180"></a><span class="w">    </span><span class="sd">"""åœ¨åŸå§‹å¸§ä¸Šç»˜åˆ¶æ£€æµ‹ç»“æœ"""</span>
<a id="__codelineno-9-181" name="__codelineno-9-181"></a>    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-9-182" name="__codelineno-9-182"></a>    <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
<a id="__codelineno-9-183" name="__codelineno-9-183"></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">cls_idx</span> <span class="o">=</span> <span class="n">det</span>
<a id="__codelineno-9-184" name="__codelineno-9-184"></a>        <span class="c1"># å°†å½’ä¸€åŒ–åæ ‡è½¬æ¢ä¸ºåŸå§‹å›¾åƒå°ºå¯¸</span>
<a id="__codelineno-9-185" name="__codelineno-9-185"></a>        <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-9-186" name="__codelineno-9-186"></a>        <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y1</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-9-187" name="__codelineno-9-187"></a>        <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x2</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-9-188" name="__codelineno-9-188"></a>        <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y2</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-9-189" name="__codelineno-9-189"></a>
<a id="__codelineno-9-190" name="__codelineno-9-190"></a>        <span class="c1"># ç»˜åˆ¶è¾¹ç•Œæ¡†</span>
<a id="__codelineno-9-191" name="__codelineno-9-191"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-192" name="__codelineno-9-192"></a>        <span class="c1"># ç»˜åˆ¶ç±»åˆ«å’Œç½®ä¿¡åº¦</span>
<a id="__codelineno-9-193" name="__codelineno-9-193"></a>        <span class="n">cls_name</span> <span class="o">=</span> <span class="n">IDX_TO_CLASS</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">cls_idx</span><span class="p">)]</span>
<a id="__codelineno-9-194" name="__codelineno-9-194"></a>        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">cls_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-9-195" name="__codelineno-9-195"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="o">-</span><span class="mi">10</span><span class="p">)),</span> 
<a id="__codelineno-9-196" name="__codelineno-9-196"></a>                   <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-197" name="__codelineno-9-197"></a>    <span class="k">return</span> <span class="n">frame</span>
<a id="__codelineno-9-198" name="__codelineno-9-198"></a>
<a id="__codelineno-9-199" name="__codelineno-9-199"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_camera_detection</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">nms_iou</span><span class="o">=</span><span class="mf">0.45</span><span class="p">):</span>
<a id="__codelineno-9-200" name="__codelineno-9-200"></a><span class="w">    </span><span class="sd">"""è¿è¡Œæ‘„åƒå¤´å®æ—¶æ£€æµ‹"""</span>
<a id="__codelineno-9-201" name="__codelineno-9-201"></a>    <span class="c1"># æ‰“å¼€æ‘„åƒå¤´</span>
<a id="__codelineno-9-202" name="__codelineno-9-202"></a>    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-203" name="__codelineno-9-203"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
<a id="__codelineno-9-204" name="__codelineno-9-204"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"æ— æ³•æ‰“å¼€æ‘„åƒå¤´"</span><span class="p">)</span>
<a id="__codelineno-9-205" name="__codelineno-9-205"></a>        <span class="k">return</span>
<a id="__codelineno-9-206" name="__codelineno-9-206"></a>
<a id="__codelineno-9-207" name="__codelineno-9-207"></a>    <span class="c1"># è®¾ç½®æ‘„åƒå¤´å‚æ•°</span>
<a id="__codelineno-9-208" name="__codelineno-9-208"></a>    <span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="mi">1280</span><span class="p">)</span>
<a id="__codelineno-9-209" name="__codelineno-9-209"></a>    <span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="mi">720</span><span class="p">)</span>
<a id="__codelineno-9-210" name="__codelineno-9-210"></a>    <span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span> <span class="n">fps</span><span class="p">)</span>
<a id="__codelineno-9-211" name="__codelineno-9-211"></a>
<a id="__codelineno-9-212" name="__codelineno-9-212"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-9-213" name="__codelineno-9-213"></a>    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-9-214" name="__codelineno-9-214"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"å¼€å§‹å®æ—¶æ£€æµ‹ (æŒ‰ 'q' é€€å‡º)"</span><span class="p">)</span>
<a id="__codelineno-9-215" name="__codelineno-9-215"></a>
<a id="__codelineno-9-216" name="__codelineno-9-216"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-9-217" name="__codelineno-9-217"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-9-218" name="__codelineno-9-218"></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-9-219" name="__codelineno-9-219"></a>
<a id="__codelineno-9-220" name="__codelineno-9-220"></a>            <span class="c1"># è¯»å–ä¸€å¸§</span>
<a id="__codelineno-9-221" name="__codelineno-9-221"></a>            <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-9-222" name="__codelineno-9-222"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
<a id="__codelineno-9-223" name="__codelineno-9-223"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">"æ— æ³•è·å–è§†é¢‘å¸§"</span><span class="p">)</span>
<a id="__codelineno-9-224" name="__codelineno-9-224"></a>                <span class="k">break</span>
<a id="__codelineno-9-225" name="__codelineno-9-225"></a>
<a id="__codelineno-9-226" name="__codelineno-9-226"></a>            <span class="c1"># é¢„å¤„ç†</span>
<a id="__codelineno-9-227" name="__codelineno-9-227"></a>            <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">preprocess_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-9-228" name="__codelineno-9-228"></a>
<a id="__codelineno-9-229" name="__codelineno-9-229"></a>            <span class="c1"># æ¨¡å‹æ¨ç†</span>
<a id="__codelineno-9-230" name="__codelineno-9-230"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s1">'cuda'</span> <span class="k">else</span> <span class="s1">'cpu'</span><span class="p">,</span> 
<a id="__codelineno-9-231" name="__codelineno-9-231"></a>                                                  <span class="n">enabled</span><span class="o">=</span><span class="n">AUTOCAST_ENABLED</span><span class="p">):</span>
<a id="__codelineno-9-232" name="__codelineno-9-232"></a>                <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">)</span>
<a id="__codelineno-9-233" name="__codelineno-9-233"></a>
<a id="__codelineno-9-234" name="__codelineno-9-234"></a>            <span class="c1"># è§£ç å’Œåå¤„ç†</span>
<a id="__codelineno-9-235" name="__codelineno-9-235"></a>            <span class="n">dets</span> <span class="o">=</span> <span class="n">yolo_decode</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="n">conf_thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-9-236" name="__codelineno-9-236"></a>            <span class="n">dets</span> <span class="o">=</span> <span class="n">nms_classwise</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">iou_thr</span><span class="o">=</span><span class="n">nms_iou</span><span class="p">)</span>
<a id="__codelineno-9-237" name="__codelineno-9-237"></a>
<a id="__codelineno-9-238" name="__codelineno-9-238"></a>            <span class="c1"># ç»˜åˆ¶æ£€æµ‹ç»“æœ</span>
<a id="__codelineno-9-239" name="__codelineno-9-239"></a>            <span class="n">frame_with_dets</span> <span class="o">=</span> <span class="n">draw_detections</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">)</span>
<a id="__codelineno-9-240" name="__codelineno-9-240"></a>
<a id="__codelineno-9-241" name="__codelineno-9-241"></a>            <span class="c1"># è®¡ç®—å¹¶æ˜¾ç¤ºFPS</span>
<a id="__codelineno-9-242" name="__codelineno-9-242"></a>            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-9-243" name="__codelineno-9-243"></a>            <span class="n">current_fps</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">elapsed</span> <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-9-244" name="__codelineno-9-244"></a>            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame_with_dets</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"FPS: </span><span class="si">{</span><span class="n">current_fps</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
<a id="__codelineno-9-245" name="__codelineno-9-245"></a>                       <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-246" name="__codelineno-9-246"></a>
<a id="__codelineno-9-247" name="__codelineno-9-247"></a>            <span class="c1"># æ˜¾ç¤ºç»“æœ</span>
<a id="__codelineno-9-248" name="__codelineno-9-248"></a>            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">"YOLOv1 Real-time Detection"</span><span class="p">,</span> <span class="n">frame_with_dets</span><span class="p">)</span>
<a id="__codelineno-9-249" name="__codelineno-9-249"></a>
<a id="__codelineno-9-250" name="__codelineno-9-250"></a>            <span class="c1"># æŒ‰'q'é€€å‡º</span>
<a id="__codelineno-9-251" name="__codelineno-9-251"></a>            <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">'q'</span><span class="p">):</span>
<a id="__codelineno-9-252" name="__codelineno-9-252"></a>                <span class="k">break</span>
<a id="__codelineno-9-253" name="__codelineno-9-253"></a>
<a id="__codelineno-9-254" name="__codelineno-9-254"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-9-255" name="__codelineno-9-255"></a>        <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<a id="__codelineno-9-256" name="__codelineno-9-256"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
<a id="__codelineno-9-257" name="__codelineno-9-257"></a>
<a id="__codelineno-9-258" name="__codelineno-9-258"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-259" name="__codelineno-9-259"></a><span class="c1"># ä¸»å‡½æ•° - åŠ è½½æ¨¡å‹å¹¶å¯åŠ¨æ£€æµ‹</span>
<a id="__codelineno-9-260" name="__codelineno-9-260"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-261" name="__codelineno-9-261"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-9-262" name="__codelineno-9-262"></a>    <span class="c1"># åˆ›å»ºæ¨¡å‹</span>
<a id="__codelineno-9-263" name="__codelineno-9-263"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">YOLOv1ResNet18</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">S</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-264" name="__codelineno-9-264"></a>
<a id="__codelineno-9-265" name="__codelineno-9-265"></a>    <span class="c1"># åŠ è½½æƒé‡</span>
<a id="__codelineno-9-266" name="__codelineno-9-266"></a>    <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="s1">'./yolov1_resnet18_voc0712.pth'</span>
<a id="__codelineno-9-267" name="__codelineno-9-267"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">):</span>
<a id="__codelineno-9-268" name="__codelineno-9-268"></a>        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">))</span>
<a id="__codelineno-9-269" name="__codelineno-9-269"></a>        <span class="c1"># åŠ è½½æ¨¡å‹æƒé‡</span>
<a id="__codelineno-9-270" name="__codelineno-9-270"></a>        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">'model_state_dict'</span><span class="p">])</span>
<a id="__codelineno-9-271" name="__codelineno-9-271"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"æˆåŠŸåŠ è½½æ¨¡å‹æƒé‡: </span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-9-272" name="__codelineno-9-272"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-273" name="__codelineno-9-273"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"è­¦å‘Š: æœªæ‰¾åˆ°æ¨¡å‹æƒé‡æ–‡ä»¶ </span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2">ï¼Œä½¿ç”¨éšæœºæƒé‡"</span><span class="p">)</span>
<a id="__codelineno-9-274" name="__codelineno-9-274"></a>
<a id="__codelineno-9-275" name="__codelineno-9-275"></a>    <span class="c1"># å¯åŠ¨æ‘„åƒå¤´æ£€æµ‹</span>
<a id="__codelineno-9-276" name="__codelineno-9-276"></a>    <span class="n">run_camera_detection</span><span class="p">(</span>
<a id="__codelineno-9-277" name="__codelineno-9-277"></a>        <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-9-278" name="__codelineno-9-278"></a>        <span class="n">fps</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>           <span class="c1"># ç›®æ ‡å¸§ç‡</span>
<a id="__codelineno-9-279" name="__codelineno-9-279"></a>        <span class="n">conf_thresh</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span> <span class="c1"># ç½®ä¿¡åº¦é˜ˆå€¼</span>
<a id="__codelineno-9-280" name="__codelineno-9-280"></a>        <span class="n">nms_iou</span><span class="o">=</span><span class="mf">0.45</span>      <span class="c1"># NMSçš„IOUé˜ˆå€¼</span>
<a id="__codelineno-9-281" name="__codelineno-9-281"></a>    <span class="p">)</span>
<a id="__codelineno-9-282" name="__codelineno-9-282"></a>
<a id="__codelineno-9-283" name="__codelineno-9-283"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-9-284" name="__codelineno-9-284"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"using device: </span><span class="si">{</span><span class="n">DEVICE</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-9-285" name="__codelineno-9-285"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>  <span class="c1"># å»¶è¿Ÿå¯¼å…¥ï¼Œä»…åœ¨ä¸»ç¨‹åºè¿è¡Œæ—¶éœ€è¦</span>
<a id="__codelineno-9-286" name="__codelineno-9-286"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"åˆå§‹åŒ–å®Œæ¯•ï¼Œå¼€å§‹åŠ è½½æƒé‡..."</span><span class="p">)</span>
<a id="__codelineno-9-287" name="__codelineno-9-287"></a>    <span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<p>æœ€ååœ¨çœŸå®ä¸–ç•Œæ ·æœ¬çš„æ£€æµ‹æ•ˆæœå¦‚ä¸‹ï¼šï¼ˆå¸§ç‡å¾ˆä½æ˜¯ç”±äºç¬”è®°æœ¬æ²¡æœ‰ç‹¬æ˜¾å¯¼è‡´åªèƒ½åœ¨ CPU ä¸Šé¢æ¨ç†ï¼‰</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20005625.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20005447.png"/></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20005400.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20005133.png"/></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20003519.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20010942.png"/></td>
</tr>
</tbody>
</table>
<div class="admonition info">
<p class="admonition-title">ğŸ“ å¦‚æœæ‚¨éœ€è¦å¼•ç”¨æœ¬æ–‡</p>
<p>Yan Li. (Sep. 13, 2025). å›¾åƒè¯­ä¹‰åˆ†å‰²å’Œç›®æ ‡æ£€æµ‹ç›¸å…³æ¨¡å‹å¤ç°æ‰‹è®° [Blog post]. Retrieved from <a href="https://dicaeopolis.github.io/DNN/model-expr/S-and-D-models-replication">https://dicaeopolis.github.io/DNN/model-expr/S-and-D-models-replication</a></p>
<p>åœ¨ BibTeX æ ¼å¼ä¸­ï¼š
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span>
<span class="normal"><a href="#__codelineno-10-6">6</a></span>
<span class="normal"><a href="#__codelineno-10-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>@online{S-and-D-models-replication,
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    title={å›¾åƒè¯­ä¹‰åˆ†å‰²å’Œç›®æ ‡æ£€æµ‹ç›¸å…³æ¨¡å‹å¤ç°æ‰‹è®°},
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>    author={Yan Li},
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>    year={2025},
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>    month={Sep},
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>    url={\url{https://dicaeopolis.github.io/DNN/model-expr/S-and-D-models-replication}},
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>}
</code></pre></div></td></tr></table></div></p>
</div>
<form class="md-feedback" hidden="" name="feedback">
<fieldset>
<legend class="md-feedback__title">
        Was this page helpful?
      </legend>
<div class="md-feedback__inner">
<div class="md-feedback__list">
<button class="md-feedback__icon md-icon" data-md-value="1" title="This page was helpful" type="submit">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"></path></svg>
</button>
<button class="md-feedback__icon md-icon" data-md-value="0" title="This page could be improved" type="submit">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"></path></svg>
</button>
</div>
<div class="md-feedback__note">
<div data-md-value="1" hidden="">
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
<div data-md-value="0" hidden="">
              
              
                
              
              
              
                
                
              
              Thanks for your feedback! Help us improve this page by using our <a href="..." rel="noopener" target="_blank">feedback form</a>.
            </div>
</div>
</div>
</fieldset>
</form>
<h2 id="__comments">è¯„è®º</h2>
<!-- Giscus è„šæœ¬ç²˜è´´åœ¨è¿™é‡Œ -->
<script async="" crossorigin="anonymous" data-category="Comments" data-category-id="DIC_kwDOOfbpCM4CtuiH" data-emit-metadata="0" data-input-position="bottom" data-lang="zh-CN" data-mapping="pathname" data-reactions-enabled="1" data-repo="dicaeopolis/dicaeopolis.github.io" data-repo-id="R_kgDOOfbpCA" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js">
</script>
<!-- è¿™æ®µè„šæœ¬ç”¨äºåŒæ­¥ Giscus å’Œ mkdocs-material çš„ä¸»é¢˜ -->
<script>
    var giscus = document.querySelector("script[src*=giscus]");
    document.addEventListener("DOMContentLoaded", function () {
      var palette = __md_get("__palette");
      if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "transparent_dark" : "light";
        giscus.setAttribute("data-theme", theme);
      }
      var ref = document.querySelector("[data-md-component=palette]");
      ref.addEventListener("change", function () {
        var palette = __md_get("__palette");
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "transparent_dark" : "light";
          var message = { setConfig: { theme: theme } };
          var frame = document.querySelector(".giscus-frame");
          frame.contentWindow.postMessage({ giscus: message }, "https://giscus.app");
        }
      });
    });
  </script>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["content.code.copy", "content.code.select", "navigation.titles", "navigation.tabs", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script src="../../../assets/js/custom.js"></script>
<script src="../../../themes/js/custom.js"></script>
<script src="../../../themes/js/simpleLightbox.min.js"></script>
<script src="../../../themes/js/optionalConfig.js"></script>
<script src="../../../themes/js/mermaidloader.js"></script>
<script src="../../../themes/js/umlconvert.js"></script>
<script src="../../../themes/js/mathjax.js"></script>
<script src="../../../themes/js/katex.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.17.1/flowchart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mermaid-js/mermaid-mindmap@9.3.0/dist/diagram-definition.0faef4c2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-plantuml@1.4.1/index.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml-full.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-svg-full.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
</body>
</html>