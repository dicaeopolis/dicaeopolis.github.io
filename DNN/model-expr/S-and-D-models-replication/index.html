
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../DDPM/" rel="prev"/>
<link href="../Image-models-replication/" rel="next"/>
<link href="../../../favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.22" name="generator"/>
<title>图像语义分割和目标检测相关模型复现手记 - Dicaeopolis' Wiki</title>
<link href="../../../assets/stylesheets/main.84d31ad4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../themes/css/custom.css" rel="stylesheet"/>
<link href="../../../themes/css/simpleLightbox.min.css" rel="stylesheet"/>
<link href="../../../themes/css/pied_piper.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" rel="stylesheet"/>
<link href="../../../stylesheets/customize.css" rel="stylesheet"/>
<link href="../../../assets/css/custom.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="Dicaeopolis' Wiki" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="Dicaeopolis' Wiki">
<img alt="logo" src="../../../favicon.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Dicaeopolis' Wiki
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              图像语义分割和目标检测相关模型复现手记
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg>
</label>
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
    
  
  深度神经网络

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../campus-sources/">
          
  
  
    
  
  校内课程知识

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../misc/">
          
  
  
    
  
  配置和杂谈笔记

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../algorithm/">
          
  
  
    
  
  传统算法与性能

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Dicaeopolis' Wiki" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="Dicaeopolis' Wiki">
<img alt="logo" src="../../../favicon.png"/>
</a>
    Dicaeopolis' Wiki
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_1" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    深度神经网络
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_1_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_1">
<span class="md-nav__icon md-icon"></span>
            深度神经网络
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../RL/">
<span class="md-ellipsis">
    RL学习笔记 - 上篇
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../SVM_SMO/">
<span class="md-ellipsis">
    SMO 算法的推导
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="0">
<span class="md-ellipsis">
    Wp
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_4">
<span class="md-nav__icon md-icon"></span>
            Wp
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../WP/aiwp/">
<span class="md-ellipsis">
    MISC-AI 方向 WriteUp
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../model-attack/">
<span class="md-ellipsis">
    深度学习模型攻击理论与复现归档
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_5" id="__nav_1_5_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_5">
<span class="md-nav__icon md-icon"></span>
            深度学习模型攻击理论与复现归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/hsja/">
<span class="md-ellipsis">
    HSJA 攻击
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/BadNets/">
<span class="md-ellipsis">
    BadNets
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/CandW/">
<span class="md-ellipsis">
    C&amp;W 攻击
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/pgd/">
<span class="md-ellipsis">
    PGD 攻击
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model-attack/fgsm/">
<span class="md-ellipsis">
    FGSM 攻击
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_1_6" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    深度学习相关模型理论与复现归档
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_6" id="__nav_1_6_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_1_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_6">
<span class="md-nav__icon md-icon"></span>
            深度学习相关模型理论与复现归档
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../DDPM/">
<span class="md-ellipsis">
    扩散模型理论篇: 从多阶段变分自编码器到概率流常微分方程采样器系列
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    图像语义分割和目标检测相关模型复现手记
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    图像语义分割和目标检测相关模型复现手记
    
  </span>
</a>
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      语义分割
    </span>
</a>
<nav aria-label="语义分割" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fcn">
<span class="md-ellipsis">
      FCN
    </span>
</a>
<nav aria-label="FCN" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      架构
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      指标
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_5">
<span class="md-ellipsis">
      实现细节
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_6">
<span class="md-ellipsis">
      训练结果
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#u-net">
<span class="md-ellipsis">
      U-Net
    </span>
</a>
<nav aria-label="U-Net" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_7">
<span class="md-ellipsis">
      原理
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_8">
<span class="md-ellipsis">
      训练代码
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_9">
<span class="md-ellipsis">
      结果
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_10">
<span class="md-ellipsis">
      碎碎念
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_11">
<span class="md-ellipsis">
      目标检测
    </span>
</a>
<nav aria-label="目标检测" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#yolo-v1">
<span class="md-ellipsis">
      YOLO v1
    </span>
</a>
<nav aria-label="YOLO v1" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_12">
<span class="md-ellipsis">
      模型架构
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_13">
<span class="md-ellipsis">
      损失函数
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_14">
<span class="md-ellipsis">
      网络结构
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#map">
<span class="md-ellipsis">
      mAP
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_15">
<span class="md-ellipsis">
      训练
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_16">
<span class="md-ellipsis">
      推理与评估
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_17">
<span class="md-ellipsis">
      可视化
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Image-models-replication/">
<span class="md-ellipsis">
    图像分类相关模型复现手记
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../DC-GAN-%E8%80%81%E5%A9%86%E7%94%9F%E6%88%90%E5%99%A8/">
<span class="md-ellipsis">
    DC-GAN 老婆生成器
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1_7" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../optimizer/">
<span class="md-ellipsis">
    优化器
    
  </span>
</a>
<label class="md-nav__link" for="__nav_1_7" id="__nav_1_7_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_1_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_7">
<span class="md-nav__icon md-icon"></span>
            优化器
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/misc/">
<span class="md-ellipsis">
    后续的写作计划
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/SignGD/">
<span class="md-ellipsis">
    符号梯度下降
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/Adaptive/">
<span class="md-ellipsis">
    自适应学习率改进策略
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../optimizer/SGD/">
<span class="md-ellipsis">
    SGD 系列算法
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../campus-sources/">
<span class="md-ellipsis">
    校内课程知识
    
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            校内课程知识
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/SDC_assignments/">
<span class="md-ellipsis">
    《计算机组成原理》理论课程作业与笔记归档
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/Descrete_assignments/">
<span class="md-ellipsis">
    《离散数学》课程作业与笔记归档
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/PU_Bii_assignments/">
<span class="md-ellipsis">
    《大学物理B下》课程作业与笔记归档
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/Prob_Stats_assignments/">
<span class="md-ellipsis">
    《概率论与数理统计》课程作业与笔记归档
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/binmul/">
<span class="md-ellipsis">
<i class="fas fa-calculator"></i> 二进制乘法可视化工具
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/textbook/">
<span class="md-ellipsis">
    本科教科书电子资源
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/ds-keynote/">
<span class="md-ellipsis">
    《数据结构》划重点笔记
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/ds-write-up/">
<span class="md-ellipsis">
    《数据结构》期末复习题题解
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../campus-sources/autosignin/">
<span class="md-ellipsis">
    自动签到脚本
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../misc/">
<span class="md-ellipsis">
    配置和杂谈笔记
    
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            配置和杂谈笔记
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../misc/test/">
<span class="md-ellipsis">
    功能测试页面
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../algorithm/">
<span class="md-ellipsis">
    传统算法与性能
    
  </span>
</a>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            传统算法与性能
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../algorithm/benchmark-on-stl/">
<span class="md-ellipsis">
    STL的一些性能测试
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../algorithm/stl-wheels/">
<span class="md-ellipsis">
    嗯造轮子
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../algorithm/template-on-numeric-ring/">
<span class="md-ellipsis">
    整数环取模模板
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      语义分割
    </span>
</a>
<nav aria-label="语义分割" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fcn">
<span class="md-ellipsis">
      FCN
    </span>
</a>
<nav aria-label="FCN" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      架构
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      指标
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_5">
<span class="md-ellipsis">
      实现细节
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_6">
<span class="md-ellipsis">
      训练结果
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#u-net">
<span class="md-ellipsis">
      U-Net
    </span>
</a>
<nav aria-label="U-Net" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_7">
<span class="md-ellipsis">
      原理
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_8">
<span class="md-ellipsis">
      训练代码
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_9">
<span class="md-ellipsis">
      结果
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_10">
<span class="md-ellipsis">
      碎碎念
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_11">
<span class="md-ellipsis">
      目标检测
    </span>
</a>
<nav aria-label="目标检测" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#yolo-v1">
<span class="md-ellipsis">
      YOLO v1
    </span>
</a>
<nav aria-label="YOLO v1" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_12">
<span class="md-ellipsis">
      模型架构
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_13">
<span class="md-ellipsis">
      损失函数
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_14">
<span class="md-ellipsis">
      网络结构
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#map">
<span class="md-ellipsis">
      mAP
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_15">
<span class="md-ellipsis">
      训练
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_16">
<span class="md-ellipsis">
      推理与评估
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_17">
<span class="md-ellipsis">
      可视化
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="_1">图像语义分割和目标检测相关模型复现手记<a class="headerlink" href="#_1" title="Permanent link">¶</a></h1>
<div class="admonition info">
<p class="admonition-title">📖 阅读信息</p>
<p>阅读时间约 <strong>57</strong> 分钟　|　约 <strong>6436</strong> 字　|　约 <strong>59</strong> 个公式　|　约 <strong>2069</strong> 行代码</p>
</div>
<h2 id="_2">语义分割<a class="headerlink" href="#_2" title="Permanent link">¶</a></h2>
<p>语义分割的难点在于输出到和原图<strong>分辨率一致</strong>的特征图。因此不管是 FCN, U-Net 还是 Deeplab 等网络，关键点主要在于<strong>下采样和上采样的信息流动</strong>。一方面，我们需要利用下采样来获取特征图进行分割分类，这要求下采样过程能够高效提取信息；另一方面，我们还需要对下采样之后的结果进行解码，这又要求下采样不能丢弃太多信息，同时还需要引入编码器的中间结果来提供额外的信息。为此便有了跳跃连接、空洞卷积等核心操作。</p>
<p>虽然都是某种意义上的“生成模型”，这一部分的模型就没有 VAE 等模型那样强的数学，而是偏重于工程实现。</p>
<p>本文对语义分割主要介绍 FCN、U-Net 等。</p>
<h3 id="fcn">FCN<a class="headerlink" href="#fcn" title="Permanent link">¶</a></h3>
<h4 id="_3">架构<a class="headerlink" href="#_3" title="Permanent link">¶</a></h4>
<p>（其实我本来想直接上 U-Net 的，因为我一开始读 FCN 文章的时候就对这个架构有两个疑点，结果发现 U-Net 都能解决……）</p>
<p>本文主要复现的是 FCN-8s。它的前半截编码器部分是 VGG-16，于是我们又可以快乐地使用 ImageNet 预训练权重了。先回顾一下 VGG-16 的结构：</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef result fill:#45475a,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4;
    classDef conv fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;

    %% Input Layer
    subgraph Input["Input"]
        A[("3 @ 224×224")]
    end
    class Input input;

    %% Initial Convolution
    subgraph InitConv["Convolution Block 1"]
        B["Conv2d &lt;br&gt; 3x64 x 3×3"] 
        C["Conv2d &lt;br&gt; 64x64 x 3×3"] 
        D["Maxpool 1&lt;br&gt;stride = 2"]
    end
    A --&gt; B
    B --&gt; C --&gt; D
    class InitConv conv;

    %% Layer 1 (2× BasicBlock without downsample)
    subgraph Layer1["Convolution Block 2"]
        F["Conv2d &lt;br&gt; 64x128 x 3×3"] 
        GG["Conv2d &lt;br&gt; 128x128 x 3×3"] 
        G["Maxpool 2&lt;br&gt;stride = 2"]
    end
    D --&gt; |64 @ 112×112| F
    F --&gt; GG --&gt; G
    class Layer1 conv;

    %% Layer 2 (2× BasicBlock with downsample in first block)
    subgraph Layer2["Convolution Block 3"]
        H["Conv2d &lt;br&gt; 128x256 x 3×3"]
        I["Conv2d &lt;br&gt; 256x256 x 3×3"]
        J["Maxpool 3&lt;br&gt;stride = 2"]
    end
    G --&gt; |128 @ 56×56| H
    H --&gt; I --&gt; J
    class Layer2 conv;

    %% Layer 3 (2× BasicBlock with downsample in first block)
    subgraph Layer3["Convolution Block 4"]
        K["Conv2d &lt;br&gt; 256x512 x 3×3"]
        L["Conv2d &lt;br&gt; 512x512 x 3×3"]
        M["Maxpool 4&lt;br&gt;stride = 2"]
    end
    J --&gt; |256 @ 28×28| K
    K --&gt; L --&gt; M
    class Layer3 conv;

    %% Layer 4 (2× BasicBlock with downsample in first block)
    subgraph Layer4["Convolution Block 5"]
        N["Conv2d &lt;br&gt; 512x512 x 3×3"]
        O["Conv2d &lt;br&gt; 512x512 x 3×3"]
        P["Maxpool 5&lt;br&gt;stride = 2"]
    end
    M --&gt; |512 @ 14×14| N
    N --&gt; O --&gt; P
    class Layer4 conv;

    %% Global Pooling and FC
    subgraph PoolFC["GAP &amp; Classfiaction"]
        Q["Flatten &lt;br&gt; or GAP"]
        S["Linear Layers"]
    end
    P --&gt; |512 @ 7x7| Q --&gt; S
    class PoolFC box;

    %% Output Layer
    subgraph Output["output"]
        T[("1000")]
    end
    S --&gt; T
    class Output output;

    %% Styling
    style A stroke-dasharray: 5 5
    style T stroke:#a6e3a1,stroke-width:3px</code></pre>
<p>这里我们取到 <code>Maxpool 5</code> 之前的地方就够了，这样 VGG-16 的输出就是一张 <code>512@7x7</code> 的低分辨率特征图。然后 FCN 在这里就出现了几个变体（或者说一个演进的过程）：</p>
<p>首先考虑把这个特征图直接上采样到 224x224，我们肯定不能直接用什么线性插值、立方插值、Lanczos 插值等算法，因为它只是插值而不引入新信息。这就要祭出我们在 DC-GAN 以及 SRCNN 等生成式模型里面见到的 <code>ConvTranspose2d</code> 了。之前在分类模型下面没有细讲，这里简要介绍一下：<code>ConvTranspose2d</code> 的原理是在原有像素的四周均匀插 0 得到和目标大小一致的大图，然后再在这个大图上面做正常卷积。</p>
<p>于是我们通过步长为 32 的转置卷积一次性将 <code>512@7x7</code> 的特征图上采样到 <code>n@224x224</code>，得到我们的目标图像。这便是 FCN-32s。这里的 32 就是转置卷积的步长，s 就是 stride 的意思。</p>
<p>很显然，这个 <code>512@7x7</code> 的特征图剩下的信息相比于原图已经很少了，而我们的目标是要实现<strong>像素级</strong>的分割，为此，FCN 提出了跳跃连接的概念：既然编码器像一个“漏斗”一样去压榨特征，那么我取压榨之前具有更丰富信息的特征图，和我后面转置卷积上采样得到的特征图一融合，不就行了嘛。这便是 FCN 提出的跳跃连接思想。（其实和 ResNet 的残差连接有点像）</p>
<p>这样，我们就不一次性暴力恢复，而是先利用步长为 2 的转置卷积将 <code>512@7x7</code> 的特征图上采样到 <code>n@14x14</code>，其中 n 是类别数，也就是和 <code>Maxpool 4</code> 的输出尺寸一致。这样，前一个阶段的信息经过一个 1x1 卷积合并通道之后，就可以直接融合了。而这引发了我对于 FCN 架构的第一个疑点——FCN 的论文说是将两个特征图<strong>相加</strong>。但是我认为在通道维直接<strong>拼接</strong>，可能效果更好，因为对于特征图相加之后进行的卷积操作 C1 而言，我们总能设计一个卷积核使得拼接特征图再进行卷积操作 C2 的输出和相加后进行 C1 的输出完全一样，这意味着拼接再卷积作为一个张量到张量的映射集合，其“维度”是大于相加再卷积的，因而有能力承载更多的特征。不过，我们先按照原论文来，进行相加操作，得到 <code>n@14x14</code> 的特征图。最后，我们实施一次步长为 16 的转置卷积，上采样到 <code>n@224x224</code>，由于这一步步长为 16，所以叫 FCN-16s。</p>
<p>这样，FCN-8s 的意思就很简单了。我们对 <code>n@14x14</code> 的特征图进行一次步长为 2 的转置卷积，再同 <code>Maxpool 3</code> 的输出特征图相加得到 <code>n@28x28</code> 的特征图，再实施一次步长为 8 的转置卷积，上采样到 <code>n@224x224</code> 即可。</p>
<p>FCN 的论文只做到 8s，为什么不接着往后面做呢？这就是我的第二个疑点。如果逐层应用跳跃连接，也就是 <code>n@28x28</code> 到 <code>n@56x56</code> 到 <code>n@112x112</code> 再到 <code>n@224x224</code>，每一步都以<strong>拼接</strong>的方式实现跳跃连接，那么我们几乎就发明了 U-Net。</p>
<p>下面是 FCN-8s 的架构：</p>
<pre class="mermaid"><code>%%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'primaryColor': '#1e1e2e', 'edgeLabelBackground':'#313244', 'tertiaryColor': '#181825'}}}%%
graph LR
    %% Styling definitions
    classDef box fill:#313244,stroke:#cdd6f4,stroke-width:2px,color:#cdd6f4,radius:8px;
    classDef input fill:#585b70,stroke:#89b4fa,stroke-width:2px,color:#cdd6f4;
    classDef output fill:#313244,stroke:#f38ba8,stroke-width:2px,color:#cdd6f4;
    classDef result fill:#45475a,stroke:#a6e3a1,stroke-width:2px,color:#cdd6f4;
    classDef conv fill:#313244,stroke:#74c7ec,stroke-width:2px,color:#cdd6f4;
    classDef skip fill:#313244,stroke:#cba6f7,stroke-width:2px,color:#cdd6f4;
    classDef upsample fill:#313244,stroke:#f5c2e7,stroke-width:2px,color:#cdd6f4;

    %% Input Layer
    subgraph Input["Input"]
        A[("3 @ 224×224")]
    end
    class Input input;

    %% VGG-16 Backbone (until pool5)
    subgraph Backbone["VGG-16 Backbone"]
        %% Block 1
        subgraph Block1["Block 1"]
            B["Conv 3x64&lt;br&gt;3×3"]
            C["Conv 64x64&lt;br&gt;3×3"]
            D["MaxPool&lt;br&gt;2×2 stride=2"]
        end

        %% Block 2
        subgraph Block2["Block 2"]
            E["Conv 64x128&lt;br&gt;3×3"]
            F["Conv 128x128&lt;br&gt;3×3"]
            G["MaxPool&lt;br&gt;2×2 stride=2"]
        end

        %% Block 3
        subgraph Block3["Block 3"]
            H["Conv 128x256&lt;br&gt;3×3"]
            I["Conv 256x256&lt;br&gt;3×3"]
            J["Conv 256x256&lt;br&gt;3×3"]
            K["MaxPool&lt;br&gt;2×2 stride=2&lt;br&gt;(pool3)"]
        end

        %% Block 4
        subgraph Block4["Block 4"]
            L["Conv 256x512&lt;br&gt;3×3"]
            M["Conv 512x512&lt;br&gt;3×3"]
            N["Conv 512x512&lt;br&gt;3×3"]
            O["MaxPool&lt;br&gt;2×2 stride=2&lt;br&gt;(pool4)"]
        end

        %% Block 5
        subgraph Block5["Block 5"]
            P["Conv 512x512&lt;br&gt;3×3"]
            Q["Conv 512x512&lt;br&gt;3×3"]
            R["Conv 512x512&lt;br&gt;3×3"]
            S["MaxPool&lt;br&gt;2×2 stride=2&lt;br&gt;(pool5)"]
        end
    end

    A --&gt; B
    B --&gt; C --&gt; D
    D --&gt; E
    E --&gt; F --&gt; G
    G --&gt; H
    H --&gt; I --&gt; J --&gt; K
    K --&gt; L
    L --&gt; M --&gt; N --&gt; O
    O --&gt; P
    P --&gt; Q --&gt; R --&gt; S

    class Backbone conv;
    class Block1,Block2,Block3,Block4,Block5 box;

    %% FCN-8s Specific Layers
    subgraph FCN["FCN-8s Head"]
        %% 1x1 Convs to reduce channels to num_classes
        T["1×1 Conv&lt;br&gt;512→n"]
        U["1×1 Conv&lt;br&gt;512→n"]
        V["1×1 Conv&lt;br&gt;256→n"]

        %% 2x Upsampling
        W["2x Upsample&lt;br&gt;transposed conv"]
        X["2x Upsample&lt;br&gt;transposed conv"]

        %% Skip connections and addition
        Y["Add&lt;br&gt;pool4 + 2x(pool5)"]
        Z["Add&lt;br&gt;pool3 + 2x(combined)"]

        %% Final 8x Upsampling
        AA["8x Upsample&lt;br&gt;transposed conv"]
    end

    S --&gt; T
    O --&gt; U
    K --&gt; V
    T --&gt; W
    W --&gt; Y
    U --&gt; Y
    Y --&gt; X
    X --&gt; Z
    V --&gt; Z
    Z --&gt; AA

    class FCN skip;
    class T,U,V conv;
    class W,X,AA upsample;
    class Y,Z result;

    %% Output Layer
    subgraph Output["Output"]
        AB[("n @ 224×224&lt;br&gt;(Segmentation Mask)")]
    end
    AA --&gt; AB
    class Output output;

    %% Styling
    style A stroke-dasharray: 5 5
    style AB stroke:#a6e3a1,stroke-width:3px

    %% Skip connection annotations
    linkStyle 15 stroke:#cba6f7,stroke-width:2px,stroke-dasharray: 5 5;
    linkStyle 16 stroke:#cba6f7,stroke-width:2px,stroke-dasharray: 5 5;</code></pre>
<h4 id="_4">指标<a class="headerlink" href="#_4" title="Permanent link">¶</a></h4>
<p>先前的图像分类任务里面，我们基本上没有去衡量除了准确率和损失之外的其他指标，但是语义分割和目标检测这一块，我们就不仅要关注类别对不对，更要关注分割/检测是否到位。</p>
<p>让我们来回顾一下概率论课程中的参数推断，里面提到两种错误：<strong>拒真</strong>和<strong>取伪</strong>（或者叫假阳假阴或者第一类错误第二类错误什么的），如果我们把这两种错误的频数和两种正确的频数放到一起，就得到了<strong>混淆矩阵</strong>：</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;">预测为真</th>
<th style="text-align: center;">预测为假</th>
<th style="text-align: center;">总和</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">实际为真</td>
<td style="text-align: center;">真阳性 TP</td>
<td style="text-align: center;">假阴性 FN</td>
<td style="text-align: center;">真样本数 T</td>
</tr>
<tr>
<td style="text-align: center;">实际为假</td>
<td style="text-align: center;">假阳性 FP</td>
<td style="text-align: center;">真阴性 TN</td>
<td style="text-align: center;">假样本数 F</td>
</tr>
<tr>
<td style="text-align: center;">总和</td>
<td style="text-align: center;">阳性数 P</td>
<td style="text-align: center;">阴性数 N</td>
<td style="text-align: center;">总数 S</td>
</tr>
</tbody>
</table>
<p>那么我们就可以以此来评估模型性能了：</p>
<div class="arithmatex">\[
\begin{align*}
    \mathrm{Acc.}&amp;=\frac{\mathrm{TP}+\mathrm{TN}}{\mathrm{S}}\\
    \mathrm{Prec.}&amp;=\frac{\mathrm{TP}}{\mathrm{P}}=1-\frac{\mathrm{FP}}{\mathrm{P}}\\
    \mathrm{Recall}&amp;=\frac{\mathrm{TP}}{\mathrm{TP}+\mathrm{FN}}
\end{align*}
\]</div>
<p>第一个是<strong>准确率</strong>即预测正确占总数的比例。第二个是<strong>精准率</strong>，越高说明假阴性/假阳性的占比越低。最后一个是<strong>召回率</strong>，可以理解成在预测正确的情况下，模型有多大意愿给出阴性/阳性结果。在语义分割的语境下，我们在单张图片的像素意义上计算这些指标，也就是说我们可以得到像素准确率 PA。</p>
<p><img alt="alt text" src="../image-26.png"/></p>
<p>如图，假设黑圈是 ground truth 而白圈是 prediction，那么以上三个率就能可视化了。</p>
<p>如果做的是像 Pascal VOC 这样的多类别语义分割，我们给每个类别都计算 PA，然后求平均，就得到一个总的计算准确率的指标：平均类别像素准确率 mPA。</p>
<p>另一方面，我们其实希望白圈和黑圈尽可能重合，其实就是<strong>相交得更多，不属于相交的部分更少</strong>。为此，我们可以引入一个指标来衡量：交并比 IoU，也就是 II 区域的面积除以 I、II 和 III 区域的面积之和。</p>
<div class="arithmatex">\[
\mathrm{IoU}=\dfrac{\mathrm{TP}}{\mathrm{T}+\mathrm{P}-\mathrm{TP}}
\]</div>
<p>同样的，我们可以计算类别平均交并比 mIoU。</p>
<p>下面的代码就实现了基于混淆矩阵计算 PA 和 mIoU。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="n">pixel_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 对角线元素都是预测正确的</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="c1"># 忽略NaN值（例如某个类别在验证集中从未出现过）</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="n">miou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="k">return</span> <span class="n">pixel_accuracy</span><span class="p">,</span> <span class="n">miou</span>
</code></pre></div></td></tr></table></div>
<p>FCN 的损失函数当简单：其实我们等于是<strong>对一个和原图尺寸一致的像素阵列做独立的分类</strong>，那么和分类任务一样，<strong>直接沿用交叉熵损失即可</strong>！</p>
<h4 id="_5">实现细节<a class="headerlink" href="#_5" title="Permanent link">¶</a></h4>
<p>这里的细节主要是来讲 FCN-8s 这个类的具体实现。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span>
<span class="normal"><a href="#__codelineno-1-32">32</a></span>
<span class="normal"><a href="#__codelineno-1-33">33</a></span>
<span class="normal"><a href="#__codelineno-1-34">34</a></span>
<span class="normal"><a href="#__codelineno-1-35">35</a></span>
<span class="normal"><a href="#__codelineno-1-36">36</a></span>
<span class="normal"><a href="#__codelineno-1-37">37</a></span>
<span class="normal"><a href="#__codelineno-1-38">38</a></span>
<span class="normal"><a href="#__codelineno-1-39">39</a></span>
<span class="normal"><a href="#__codelineno-1-40">40</a></span>
<span class="normal"><a href="#__codelineno-1-41">41</a></span>
<span class="normal"><a href="#__codelineno-1-42">42</a></span>
<span class="normal"><a href="#__codelineno-1-43">43</a></span>
<span class="normal"><a href="#__codelineno-1-44">44</a></span>
<span class="normal"><a href="#__codelineno-1-45">45</a></span>
<span class="normal"><a href="#__codelineno-1-46">46</a></span>
<span class="normal"><a href="#__codelineno-1-47">47</a></span>
<span class="normal"><a href="#__codelineno-1-48">48</a></span>
<span class="normal"><a href="#__codelineno-1-49">49</a></span>
<span class="normal"><a href="#__codelineno-1-50">50</a></span>
<span class="normal"><a href="#__codelineno-1-51">51</a></span>
<span class="normal"><a href="#__codelineno-1-52">52</a></span>
<span class="normal"><a href="#__codelineno-1-53">53</a></span>
<span class="normal"><a href="#__codelineno-1-54">54</a></span>
<span class="normal"><a href="#__codelineno-1-55">55</a></span>
<span class="normal"><a href="#__codelineno-1-56">56</a></span>
<span class="normal"><a href="#__codelineno-1-57">57</a></span>
<span class="normal"><a href="#__codelineno-1-58">58</a></span>
<span class="normal"><a href="#__codelineno-1-59">59</a></span>
<span class="normal"><a href="#__codelineno-1-60">60</a></span>
<span class="normal"><a href="#__codelineno-1-61">61</a></span>
<span class="normal"><a href="#__codelineno-1-62">62</a></span>
<span class="normal"><a href="#__codelineno-1-63">63</a></span>
<span class="normal"><a href="#__codelineno-1-64">64</a></span>
<span class="normal"><a href="#__codelineno-1-65">65</a></span>
<span class="normal"><a href="#__codelineno-1-66">66</a></span>
<span class="normal"><a href="#__codelineno-1-67">67</a></span>
<span class="normal"><a href="#__codelineno-1-68">68</a></span>
<span class="normal"><a href="#__codelineno-1-69">69</a></span>
<span class="normal"><a href="#__codelineno-1-70">70</a></span>
<span class="normal"><a href="#__codelineno-1-71">71</a></span>
<span class="normal"><a href="#__codelineno-1-72">72</a></span>
<span class="normal"><a href="#__codelineno-1-73">73</a></span>
<span class="normal"><a href="#__codelineno-1-74">74</a></span>
<span class="normal"><a href="#__codelineno-1-75">75</a></span>
<span class="normal"><a href="#__codelineno-1-76">76</a></span>
<span class="normal"><a href="#__codelineno-1-77">77</a></span>
<span class="normal"><a href="#__codelineno-1-78">78</a></span>
<span class="normal"><a href="#__codelineno-1-79">79</a></span>
<span class="normal"><a href="#__codelineno-1-80">80</a></span>
<span class="normal"><a href="#__codelineno-1-81">81</a></span>
<span class="normal"><a href="#__codelineno-1-82">82</a></span>
<span class="normal"><a href="#__codelineno-1-83">83</a></span>
<span class="normal"><a href="#__codelineno-1-84">84</a></span>
<span class="normal"><a href="#__codelineno-1-85">85</a></span>
<span class="normal"><a href="#__codelineno-1-86">86</a></span>
<span class="normal"><a href="#__codelineno-1-87">87</a></span>
<span class="normal"><a href="#__codelineno-1-88">88</a></span>
<span class="normal"><a href="#__codelineno-1-89">89</a></span>
<span class="normal"><a href="#__codelineno-1-90">90</a></span>
<span class="normal"><a href="#__codelineno-1-91">91</a></span>
<span class="normal"><a href="#__codelineno-1-92">92</a></span>
<span class="normal"><a href="#__codelineno-1-93">93</a></span>
<span class="normal"><a href="#__codelineno-1-94">94</a></span>
<span class="normal"><a href="#__codelineno-1-95">95</a></span>
<span class="normal"><a href="#__codelineno-1-96">96</a></span>
<span class="normal"><a href="#__codelineno-1-97">97</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">FCN8s</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">FCN8s</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>        <span class="c1"># 预训练 VGG16</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>        <span class="n">vgg</span> <span class="o">=</span> <span class="n">vgg16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">VGG16_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">features</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>        <span class="c1"># 提取不同阶段的特征图</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="c1"># 在 PyTorch 的实现中，VGG 的连续卷积-池化操作是保存在 vgg.features 这个 list 里面</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>        <span class="c1"># [64, 64, 'M', 128, 128, 'M', 256, 256, 256, 'M', 512, 512, 512, 'M', 512, 512, 512, 'M'] 其中 M 就是 Maxpool</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="c1"># 由于这个 list 被封印进 nn.Sequnential 里面，所以可以直接调用，输出就是特征图</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool3_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span>   <span class="c1"># 到 pool3</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool4_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span> <span class="c1"># 到 pool4</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool5_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">24</span><span class="p">:]</span>   <span class="c1"># 到 pool5</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>        <span class="c1"># 全连接层改为卷积层（FCN）</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>        <span class="c1"># VGG 的第一个 Linear: 512@7x7 -&gt; 4096@7x7</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>        <span class="c1"># 当然这里为了适应任意宽度的输出，可以使用 GAP</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a>        <span class="c1"># 不过我们可以利用上 VGG 的预训练权重，比起重新训效果肯定更好</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drop6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">()</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>        <span class="c1"># VGG 的第二个 Linear: 4096@7x7 -&gt; 4096@7x7</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a>        <span class="c1"># 仍然是拷贝权重然后 reshape 到卷积核</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drop7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">()</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a>        <span class="c1"># 仍然是靠 1x1 卷积负责得到一个 num_classes@7x7 的分类得分</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_fr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a>        <span class="c1"># 通过 1x1 卷积得到 num_classes@HxW 的特征图用于跳跃连接</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_pool3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_pool4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a>        <span class="c1"># 上采样层</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a>        <span class="c1"># 将 VGG classifier 的 fc6/fc7 预训练权重拷贝到卷积层</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a>            <span class="c1"># vgg.classifier: [Linear(25088,4096), ReLU, Dropout, Linear(4096,4096), ReLU, Dropout, Linear(4096,1000)]</span>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a>            <span class="c1"># view(4096, 512, 7, 7) 操作就是把 25088x4096 的线性层 reshape 到这个形状的张量</span>
<a id="__codelineno-1-45" name="__codelineno-1-45"></a>            <span class="n">fc6_w</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a id="__codelineno-1-46" name="__codelineno-1-46"></a>            <span class="n">fc6_b</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span>
<a id="__codelineno-1-47" name="__codelineno-1-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc6_w</span><span class="p">)</span>
<a id="__codelineno-1-48" name="__codelineno-1-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc6_b</span><span class="p">)</span>
<a id="__codelineno-1-49" name="__codelineno-1-49"></a>
<a id="__codelineno-1-50" name="__codelineno-1-50"></a>            <span class="c1"># 这里也是同样的操作转换成张量</span>
<a id="__codelineno-1-51" name="__codelineno-1-51"></a>            <span class="n">fc7_w</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-52" name="__codelineno-1-52"></a>            <span class="n">fc7_b</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span>
<a id="__codelineno-1-53" name="__codelineno-1-53"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc7_w</span><span class="p">)</span>
<a id="__codelineno-1-54" name="__codelineno-1-54"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc7_b</span><span class="p">)</span>
<a id="__codelineno-1-55" name="__codelineno-1-55"></a>
<a id="__codelineno-1-56" name="__codelineno-1-56"></a>        <span class="c1"># 反卷积层用双线性插值进行初始化</span>
<a id="__codelineno-1-57" name="__codelineno-1-57"></a>        <span class="c1"># 反卷积的初始化的细节在后面说明</span>
<a id="__codelineno-1-58" name="__codelineno-1-58"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-1-59" name="__codelineno-1-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">bilinear_kernel</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-1-60" name="__codelineno-1-60"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">bilinear_kernel</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-1-61" name="__codelineno-1-61"></a>
<a id="__codelineno-1-62" name="__codelineno-1-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-1-63" name="__codelineno-1-63"></a>        <span class="n">input_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="c1"># (B, C, H, W) -&gt; (H, W)</span>
<a id="__codelineno-1-64" name="__codelineno-1-64"></a>
<a id="__codelineno-1-65" name="__codelineno-1-65"></a>        <span class="c1"># 直接得到 pool3, pool4, pool5 后的特征图</span>
<a id="__codelineno-1-66" name="__codelineno-1-66"></a>        <span class="n">pool3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool3_features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-1-67" name="__codelineno-1-67"></a>        <span class="n">pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool4_features</span><span class="p">(</span><span class="n">pool3</span><span class="p">)</span>
<a id="__codelineno-1-68" name="__codelineno-1-68"></a>        <span class="n">pool5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool5_features</span><span class="p">(</span><span class="n">pool4</span><span class="p">)</span>
<a id="__codelineno-1-69" name="__codelineno-1-69"></a>
<a id="__codelineno-1-70" name="__codelineno-1-70"></a>        <span class="c1"># 1x1 卷积得到我们需要的 num_classes@7x7 的特征图</span>
<a id="__codelineno-1-71" name="__codelineno-1-71"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu6</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="p">(</span><span class="n">pool5</span><span class="p">))</span>
<a id="__codelineno-1-72" name="__codelineno-1-72"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop6</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-73" name="__codelineno-1-73"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu7</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
<a id="__codelineno-1-74" name="__codelineno-1-74"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop7</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-75" name="__codelineno-1-75"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_fr</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-76" name="__codelineno-1-76"></a>
<a id="__codelineno-1-77" name="__codelineno-1-77"></a>        <span class="c1"># 第一次上采样通过转置卷积输出宽高扩张一倍的特征图</span>
<a id="__codelineno-1-78" name="__codelineno-1-78"></a>        <span class="n">upscore2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-79" name="__codelineno-1-79"></a>
<a id="__codelineno-1-80" name="__codelineno-1-80"></a>        <span class="c1"># 跳连 pool4</span>
<a id="__codelineno-1-81" name="__codelineno-1-81"></a>        <span class="n">score_pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_pool4</span><span class="p">(</span><span class="n">pool4</span><span class="p">)</span>
<a id="__codelineno-1-82" name="__codelineno-1-82"></a>        <span class="c1"># 这里用双线性插值适应特征图大小</span>
<a id="__codelineno-1-83" name="__codelineno-1-83"></a>        <span class="n">upscore2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">upscore2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">score_pool4</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-84" name="__codelineno-1-84"></a>        <span class="n">fuse_pool4</span> <span class="o">=</span> <span class="n">upscore2</span> <span class="o">+</span> <span class="n">score_pool4</span>
<a id="__codelineno-1-85" name="__codelineno-1-85"></a>
<a id="__codelineno-1-86" name="__codelineno-1-86"></a>        <span class="c1"># 第二次上采样通过转置卷积输出宽高扩张一倍的特征图</span>
<a id="__codelineno-1-87" name="__codelineno-1-87"></a>        <span class="n">upscore_pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span><span class="p">(</span><span class="n">fuse_pool4</span><span class="p">)</span>
<a id="__codelineno-1-88" name="__codelineno-1-88"></a>
<a id="__codelineno-1-89" name="__codelineno-1-89"></a>        <span class="c1"># 跳连 pool3</span>
<a id="__codelineno-1-90" name="__codelineno-1-90"></a>        <span class="n">score_pool3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_pool3</span><span class="p">(</span><span class="n">pool3</span><span class="p">)</span>
<a id="__codelineno-1-91" name="__codelineno-1-91"></a>        <span class="c1"># 同样使用双线性插值适应大小</span>
<a id="__codelineno-1-92" name="__codelineno-1-92"></a>        <span class="n">upscore_pool4</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">upscore_pool4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">score_pool3</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-93" name="__codelineno-1-93"></a>        <span class="n">fuse_pool3</span> <span class="o">=</span> <span class="n">upscore_pool4</span> <span class="o">+</span> <span class="n">score_pool3</span>
<a id="__codelineno-1-94" name="__codelineno-1-94"></a>
<a id="__codelineno-1-95" name="__codelineno-1-95"></a>        <span class="c1"># 最终上采样到输入尺寸，直接插值，省时高效</span>
<a id="__codelineno-1-96" name="__codelineno-1-96"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">fuse_pool3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-97" name="__codelineno-1-97"></a>        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
<p>可以看到除开之前提到的整体架构以外，代码还有一些小细节。</p>
<p>首先是<strong>反卷积的双线性插值初始化</strong>。这一部分代码如下：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">bilinear_kernel</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="sd">"""生成双线性插值的反卷积初始化权重"""</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>    <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="k">if</span> <span class="n">kernel_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">-</span> <span class="mf">0.5</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>    <span class="n">og</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">kernel_size</span><span class="p">,</span> <span class="p">:</span><span class="n">kernel_size</span><span class="p">]</span> <span class="c1"># 生成两个二维数组，分别表示行和列的索引网格。</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>    <span class="n">filt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)):</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>        <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">filt</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>这里关键是 <code>filt</code> 的计算，本质上就是卷积核内部计算对应的行到边界的归一化曼哈顿距离乘以对应的列到边界的归一化曼哈顿距离。对于从小图到大图的转置卷积而言，大图里面两个源于小图的像素之间的像素，就可以根据到这两个像素的曼哈顿距离作为比例来混合得到。也就是说即使我们还没有从网络里面学到任何知识，这个卷积核至少还可以不破坏原有信息而直接插值放大。同时本来 FCN 的卷积核就需要对特征图进行放大，这无疑是相比随机初始化更高效的初始化方法。</p>
<p>下面是完整的训练代码，关于数据加载和增强的大量工程性代码就不细讲了。不过，代码里的数据增强还是比较有效。</p>
<details>
<summary> FCN-8s 完整训练代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">  1</a></span>
<span class="normal"><a href="#__codelineno-3-2">  2</a></span>
<span class="normal"><a href="#__codelineno-3-3">  3</a></span>
<span class="normal"><a href="#__codelineno-3-4">  4</a></span>
<span class="normal"><a href="#__codelineno-3-5">  5</a></span>
<span class="normal"><a href="#__codelineno-3-6">  6</a></span>
<span class="normal"><a href="#__codelineno-3-7">  7</a></span>
<span class="normal"><a href="#__codelineno-3-8">  8</a></span>
<span class="normal"><a href="#__codelineno-3-9">  9</a></span>
<span class="normal"><a href="#__codelineno-3-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-3-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-3-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-3-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-3-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-3-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-3-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-3-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-3-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-3-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-3-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-3-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-3-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-3-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-3-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-3-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-3-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-3-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-3-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-3-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-3-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-3-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-3-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-3-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-3-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-3-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-3-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-3-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-3-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-3-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-3-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-3-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-3-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-3-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-3-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-3-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-3-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-3-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-3-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-3-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-3-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-3-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-3-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-3-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-3-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-3-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-3-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-3-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-3-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-3-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-3-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-3-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-3-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-3-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-3-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-3-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-3-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-3-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-3-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-3-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-3-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-3-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-3-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-3-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-3-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-3-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-3-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-3-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-3-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-3-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-3-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-3-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-3-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-3-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-3-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-3-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-3-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-3-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-3-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-3-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-3-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-3-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-3-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-3-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-3-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-3-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-3-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-3-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-3-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-3-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-3-100">100</a></span>
<span class="normal"><a href="#__codelineno-3-101">101</a></span>
<span class="normal"><a href="#__codelineno-3-102">102</a></span>
<span class="normal"><a href="#__codelineno-3-103">103</a></span>
<span class="normal"><a href="#__codelineno-3-104">104</a></span>
<span class="normal"><a href="#__codelineno-3-105">105</a></span>
<span class="normal"><a href="#__codelineno-3-106">106</a></span>
<span class="normal"><a href="#__codelineno-3-107">107</a></span>
<span class="normal"><a href="#__codelineno-3-108">108</a></span>
<span class="normal"><a href="#__codelineno-3-109">109</a></span>
<span class="normal"><a href="#__codelineno-3-110">110</a></span>
<span class="normal"><a href="#__codelineno-3-111">111</a></span>
<span class="normal"><a href="#__codelineno-3-112">112</a></span>
<span class="normal"><a href="#__codelineno-3-113">113</a></span>
<span class="normal"><a href="#__codelineno-3-114">114</a></span>
<span class="normal"><a href="#__codelineno-3-115">115</a></span>
<span class="normal"><a href="#__codelineno-3-116">116</a></span>
<span class="normal"><a href="#__codelineno-3-117">117</a></span>
<span class="normal"><a href="#__codelineno-3-118">118</a></span>
<span class="normal"><a href="#__codelineno-3-119">119</a></span>
<span class="normal"><a href="#__codelineno-3-120">120</a></span>
<span class="normal"><a href="#__codelineno-3-121">121</a></span>
<span class="normal"><a href="#__codelineno-3-122">122</a></span>
<span class="normal"><a href="#__codelineno-3-123">123</a></span>
<span class="normal"><a href="#__codelineno-3-124">124</a></span>
<span class="normal"><a href="#__codelineno-3-125">125</a></span>
<span class="normal"><a href="#__codelineno-3-126">126</a></span>
<span class="normal"><a href="#__codelineno-3-127">127</a></span>
<span class="normal"><a href="#__codelineno-3-128">128</a></span>
<span class="normal"><a href="#__codelineno-3-129">129</a></span>
<span class="normal"><a href="#__codelineno-3-130">130</a></span>
<span class="normal"><a href="#__codelineno-3-131">131</a></span>
<span class="normal"><a href="#__codelineno-3-132">132</a></span>
<span class="normal"><a href="#__codelineno-3-133">133</a></span>
<span class="normal"><a href="#__codelineno-3-134">134</a></span>
<span class="normal"><a href="#__codelineno-3-135">135</a></span>
<span class="normal"><a href="#__codelineno-3-136">136</a></span>
<span class="normal"><a href="#__codelineno-3-137">137</a></span>
<span class="normal"><a href="#__codelineno-3-138">138</a></span>
<span class="normal"><a href="#__codelineno-3-139">139</a></span>
<span class="normal"><a href="#__codelineno-3-140">140</a></span>
<span class="normal"><a href="#__codelineno-3-141">141</a></span>
<span class="normal"><a href="#__codelineno-3-142">142</a></span>
<span class="normal"><a href="#__codelineno-3-143">143</a></span>
<span class="normal"><a href="#__codelineno-3-144">144</a></span>
<span class="normal"><a href="#__codelineno-3-145">145</a></span>
<span class="normal"><a href="#__codelineno-3-146">146</a></span>
<span class="normal"><a href="#__codelineno-3-147">147</a></span>
<span class="normal"><a href="#__codelineno-3-148">148</a></span>
<span class="normal"><a href="#__codelineno-3-149">149</a></span>
<span class="normal"><a href="#__codelineno-3-150">150</a></span>
<span class="normal"><a href="#__codelineno-3-151">151</a></span>
<span class="normal"><a href="#__codelineno-3-152">152</a></span>
<span class="normal"><a href="#__codelineno-3-153">153</a></span>
<span class="normal"><a href="#__codelineno-3-154">154</a></span>
<span class="normal"><a href="#__codelineno-3-155">155</a></span>
<span class="normal"><a href="#__codelineno-3-156">156</a></span>
<span class="normal"><a href="#__codelineno-3-157">157</a></span>
<span class="normal"><a href="#__codelineno-3-158">158</a></span>
<span class="normal"><a href="#__codelineno-3-159">159</a></span>
<span class="normal"><a href="#__codelineno-3-160">160</a></span>
<span class="normal"><a href="#__codelineno-3-161">161</a></span>
<span class="normal"><a href="#__codelineno-3-162">162</a></span>
<span class="normal"><a href="#__codelineno-3-163">163</a></span>
<span class="normal"><a href="#__codelineno-3-164">164</a></span>
<span class="normal"><a href="#__codelineno-3-165">165</a></span>
<span class="normal"><a href="#__codelineno-3-166">166</a></span>
<span class="normal"><a href="#__codelineno-3-167">167</a></span>
<span class="normal"><a href="#__codelineno-3-168">168</a></span>
<span class="normal"><a href="#__codelineno-3-169">169</a></span>
<span class="normal"><a href="#__codelineno-3-170">170</a></span>
<span class="normal"><a href="#__codelineno-3-171">171</a></span>
<span class="normal"><a href="#__codelineno-3-172">172</a></span>
<span class="normal"><a href="#__codelineno-3-173">173</a></span>
<span class="normal"><a href="#__codelineno-3-174">174</a></span>
<span class="normal"><a href="#__codelineno-3-175">175</a></span>
<span class="normal"><a href="#__codelineno-3-176">176</a></span>
<span class="normal"><a href="#__codelineno-3-177">177</a></span>
<span class="normal"><a href="#__codelineno-3-178">178</a></span>
<span class="normal"><a href="#__codelineno-3-179">179</a></span>
<span class="normal"><a href="#__codelineno-3-180">180</a></span>
<span class="normal"><a href="#__codelineno-3-181">181</a></span>
<span class="normal"><a href="#__codelineno-3-182">182</a></span>
<span class="normal"><a href="#__codelineno-3-183">183</a></span>
<span class="normal"><a href="#__codelineno-3-184">184</a></span>
<span class="normal"><a href="#__codelineno-3-185">185</a></span>
<span class="normal"><a href="#__codelineno-3-186">186</a></span>
<span class="normal"><a href="#__codelineno-3-187">187</a></span>
<span class="normal"><a href="#__codelineno-3-188">188</a></span>
<span class="normal"><a href="#__codelineno-3-189">189</a></span>
<span class="normal"><a href="#__codelineno-3-190">190</a></span>
<span class="normal"><a href="#__codelineno-3-191">191</a></span>
<span class="normal"><a href="#__codelineno-3-192">192</a></span>
<span class="normal"><a href="#__codelineno-3-193">193</a></span>
<span class="normal"><a href="#__codelineno-3-194">194</a></span>
<span class="normal"><a href="#__codelineno-3-195">195</a></span>
<span class="normal"><a href="#__codelineno-3-196">196</a></span>
<span class="normal"><a href="#__codelineno-3-197">197</a></span>
<span class="normal"><a href="#__codelineno-3-198">198</a></span>
<span class="normal"><a href="#__codelineno-3-199">199</a></span>
<span class="normal"><a href="#__codelineno-3-200">200</a></span>
<span class="normal"><a href="#__codelineno-3-201">201</a></span>
<span class="normal"><a href="#__codelineno-3-202">202</a></span>
<span class="normal"><a href="#__codelineno-3-203">203</a></span>
<span class="normal"><a href="#__codelineno-3-204">204</a></span>
<span class="normal"><a href="#__codelineno-3-205">205</a></span>
<span class="normal"><a href="#__codelineno-3-206">206</a></span>
<span class="normal"><a href="#__codelineno-3-207">207</a></span>
<span class="normal"><a href="#__codelineno-3-208">208</a></span>
<span class="normal"><a href="#__codelineno-3-209">209</a></span>
<span class="normal"><a href="#__codelineno-3-210">210</a></span>
<span class="normal"><a href="#__codelineno-3-211">211</a></span>
<span class="normal"><a href="#__codelineno-3-212">212</a></span>
<span class="normal"><a href="#__codelineno-3-213">213</a></span>
<span class="normal"><a href="#__codelineno-3-214">214</a></span>
<span class="normal"><a href="#__codelineno-3-215">215</a></span>
<span class="normal"><a href="#__codelineno-3-216">216</a></span>
<span class="normal"><a href="#__codelineno-3-217">217</a></span>
<span class="normal"><a href="#__codelineno-3-218">218</a></span>
<span class="normal"><a href="#__codelineno-3-219">219</a></span>
<span class="normal"><a href="#__codelineno-3-220">220</a></span>
<span class="normal"><a href="#__codelineno-3-221">221</a></span>
<span class="normal"><a href="#__codelineno-3-222">222</a></span>
<span class="normal"><a href="#__codelineno-3-223">223</a></span>
<span class="normal"><a href="#__codelineno-3-224">224</a></span>
<span class="normal"><a href="#__codelineno-3-225">225</a></span>
<span class="normal"><a href="#__codelineno-3-226">226</a></span>
<span class="normal"><a href="#__codelineno-3-227">227</a></span>
<span class="normal"><a href="#__codelineno-3-228">228</a></span>
<span class="normal"><a href="#__codelineno-3-229">229</a></span>
<span class="normal"><a href="#__codelineno-3-230">230</a></span>
<span class="normal"><a href="#__codelineno-3-231">231</a></span>
<span class="normal"><a href="#__codelineno-3-232">232</a></span>
<span class="normal"><a href="#__codelineno-3-233">233</a></span>
<span class="normal"><a href="#__codelineno-3-234">234</a></span>
<span class="normal"><a href="#__codelineno-3-235">235</a></span>
<span class="normal"><a href="#__codelineno-3-236">236</a></span>
<span class="normal"><a href="#__codelineno-3-237">237</a></span>
<span class="normal"><a href="#__codelineno-3-238">238</a></span>
<span class="normal"><a href="#__codelineno-3-239">239</a></span>
<span class="normal"><a href="#__codelineno-3-240">240</a></span>
<span class="normal"><a href="#__codelineno-3-241">241</a></span>
<span class="normal"><a href="#__codelineno-3-242">242</a></span>
<span class="normal"><a href="#__codelineno-3-243">243</a></span>
<span class="normal"><a href="#__codelineno-3-244">244</a></span>
<span class="normal"><a href="#__codelineno-3-245">245</a></span>
<span class="normal"><a href="#__codelineno-3-246">246</a></span>
<span class="normal"><a href="#__codelineno-3-247">247</a></span>
<span class="normal"><a href="#__codelineno-3-248">248</a></span>
<span class="normal"><a href="#__codelineno-3-249">249</a></span>
<span class="normal"><a href="#__codelineno-3-250">250</a></span>
<span class="normal"><a href="#__codelineno-3-251">251</a></span>
<span class="normal"><a href="#__codelineno-3-252">252</a></span>
<span class="normal"><a href="#__codelineno-3-253">253</a></span>
<span class="normal"><a href="#__codelineno-3-254">254</a></span>
<span class="normal"><a href="#__codelineno-3-255">255</a></span>
<span class="normal"><a href="#__codelineno-3-256">256</a></span>
<span class="normal"><a href="#__codelineno-3-257">257</a></span>
<span class="normal"><a href="#__codelineno-3-258">258</a></span>
<span class="normal"><a href="#__codelineno-3-259">259</a></span>
<span class="normal"><a href="#__codelineno-3-260">260</a></span>
<span class="normal"><a href="#__codelineno-3-261">261</a></span>
<span class="normal"><a href="#__codelineno-3-262">262</a></span>
<span class="normal"><a href="#__codelineno-3-263">263</a></span>
<span class="normal"><a href="#__codelineno-3-264">264</a></span>
<span class="normal"><a href="#__codelineno-3-265">265</a></span>
<span class="normal"><a href="#__codelineno-3-266">266</a></span>
<span class="normal"><a href="#__codelineno-3-267">267</a></span>
<span class="normal"><a href="#__codelineno-3-268">268</a></span>
<span class="normal"><a href="#__codelineno-3-269">269</a></span>
<span class="normal"><a href="#__codelineno-3-270">270</a></span>
<span class="normal"><a href="#__codelineno-3-271">271</a></span>
<span class="normal"><a href="#__codelineno-3-272">272</a></span>
<span class="normal"><a href="#__codelineno-3-273">273</a></span>
<span class="normal"><a href="#__codelineno-3-274">274</a></span>
<span class="normal"><a href="#__codelineno-3-275">275</a></span>
<span class="normal"><a href="#__codelineno-3-276">276</a></span>
<span class="normal"><a href="#__codelineno-3-277">277</a></span>
<span class="normal"><a href="#__codelineno-3-278">278</a></span>
<span class="normal"><a href="#__codelineno-3-279">279</a></span>
<span class="normal"><a href="#__codelineno-3-280">280</a></span>
<span class="normal"><a href="#__codelineno-3-281">281</a></span>
<span class="normal"><a href="#__codelineno-3-282">282</a></span>
<span class="normal"><a href="#__codelineno-3-283">283</a></span>
<span class="normal"><a href="#__codelineno-3-284">284</a></span>
<span class="normal"><a href="#__codelineno-3-285">285</a></span>
<span class="normal"><a href="#__codelineno-3-286">286</a></span>
<span class="normal"><a href="#__codelineno-3-287">287</a></span>
<span class="normal"><a href="#__codelineno-3-288">288</a></span>
<span class="normal"><a href="#__codelineno-3-289">289</a></span>
<span class="normal"><a href="#__codelineno-3-290">290</a></span>
<span class="normal"><a href="#__codelineno-3-291">291</a></span>
<span class="normal"><a href="#__codelineno-3-292">292</a></span>
<span class="normal"><a href="#__codelineno-3-293">293</a></span>
<span class="normal"><a href="#__codelineno-3-294">294</a></span>
<span class="normal"><a href="#__codelineno-3-295">295</a></span>
<span class="normal"><a href="#__codelineno-3-296">296</a></span>
<span class="normal"><a href="#__codelineno-3-297">297</a></span>
<span class="normal"><a href="#__codelineno-3-298">298</a></span>
<span class="normal"><a href="#__codelineno-3-299">299</a></span>
<span class="normal"><a href="#__codelineno-3-300">300</a></span>
<span class="normal"><a href="#__codelineno-3-301">301</a></span>
<span class="normal"><a href="#__codelineno-3-302">302</a></span>
<span class="normal"><a href="#__codelineno-3-303">303</a></span>
<span class="normal"><a href="#__codelineno-3-304">304</a></span>
<span class="normal"><a href="#__codelineno-3-305">305</a></span>
<span class="normal"><a href="#__codelineno-3-306">306</a></span>
<span class="normal"><a href="#__codelineno-3-307">307</a></span>
<span class="normal"><a href="#__codelineno-3-308">308</a></span>
<span class="normal"><a href="#__codelineno-3-309">309</a></span>
<span class="normal"><a href="#__codelineno-3-310">310</a></span>
<span class="normal"><a href="#__codelineno-3-311">311</a></span>
<span class="normal"><a href="#__codelineno-3-312">312</a></span>
<span class="normal"><a href="#__codelineno-3-313">313</a></span>
<span class="normal"><a href="#__codelineno-3-314">314</a></span>
<span class="normal"><a href="#__codelineno-3-315">315</a></span>
<span class="normal"><a href="#__codelineno-3-316">316</a></span>
<span class="normal"><a href="#__codelineno-3-317">317</a></span>
<span class="normal"><a href="#__codelineno-3-318">318</a></span>
<span class="normal"><a href="#__codelineno-3-319">319</a></span>
<span class="normal"><a href="#__codelineno-3-320">320</a></span>
<span class="normal"><a href="#__codelineno-3-321">321</a></span>
<span class="normal"><a href="#__codelineno-3-322">322</a></span>
<span class="normal"><a href="#__codelineno-3-323">323</a></span>
<span class="normal"><a href="#__codelineno-3-324">324</a></span>
<span class="normal"><a href="#__codelineno-3-325">325</a></span>
<span class="normal"><a href="#__codelineno-3-326">326</a></span>
<span class="normal"><a href="#__codelineno-3-327">327</a></span>
<span class="normal"><a href="#__codelineno-3-328">328</a></span>
<span class="normal"><a href="#__codelineno-3-329">329</a></span>
<span class="normal"><a href="#__codelineno-3-330">330</a></span>
<span class="normal"><a href="#__codelineno-3-331">331</a></span>
<span class="normal"><a href="#__codelineno-3-332">332</a></span>
<span class="normal"><a href="#__codelineno-3-333">333</a></span>
<span class="normal"><a href="#__codelineno-3-334">334</a></span>
<span class="normal"><a href="#__codelineno-3-335">335</a></span>
<span class="normal"><a href="#__codelineno-3-336">336</a></span>
<span class="normal"><a href="#__codelineno-3-337">337</a></span>
<span class="normal"><a href="#__codelineno-3-338">338</a></span>
<span class="normal"><a href="#__codelineno-3-339">339</a></span>
<span class="normal"><a href="#__codelineno-3-340">340</a></span>
<span class="normal"><a href="#__codelineno-3-341">341</a></span>
<span class="normal"><a href="#__codelineno-3-342">342</a></span>
<span class="normal"><a href="#__codelineno-3-343">343</a></span>
<span class="normal"><a href="#__codelineno-3-344">344</a></span>
<span class="normal"><a href="#__codelineno-3-345">345</a></span>
<span class="normal"><a href="#__codelineno-3-346">346</a></span>
<span class="normal"><a href="#__codelineno-3-347">347</a></span>
<span class="normal"><a href="#__codelineno-3-348">348</a></span>
<span class="normal"><a href="#__codelineno-3-349">349</a></span>
<span class="normal"><a href="#__codelineno-3-350">350</a></span>
<span class="normal"><a href="#__codelineno-3-351">351</a></span>
<span class="normal"><a href="#__codelineno-3-352">352</a></span>
<span class="normal"><a href="#__codelineno-3-353">353</a></span>
<span class="normal"><a href="#__codelineno-3-354">354</a></span>
<span class="normal"><a href="#__codelineno-3-355">355</a></span>
<span class="normal"><a href="#__codelineno-3-356">356</a></span>
<span class="normal"><a href="#__codelineno-3-357">357</a></span>
<span class="normal"><a href="#__codelineno-3-358">358</a></span>
<span class="normal"><a href="#__codelineno-3-359">359</a></span>
<span class="normal"><a href="#__codelineno-3-360">360</a></span>
<span class="normal"><a href="#__codelineno-3-361">361</a></span>
<span class="normal"><a href="#__codelineno-3-362">362</a></span>
<span class="normal"><a href="#__codelineno-3-363">363</a></span>
<span class="normal"><a href="#__codelineno-3-364">364</a></span>
<span class="normal"><a href="#__codelineno-3-365">365</a></span>
<span class="normal"><a href="#__codelineno-3-366">366</a></span>
<span class="normal"><a href="#__codelineno-3-367">367</a></span>
<span class="normal"><a href="#__codelineno-3-368">368</a></span>
<span class="normal"><a href="#__codelineno-3-369">369</a></span>
<span class="normal"><a href="#__codelineno-3-370">370</a></span>
<span class="normal"><a href="#__codelineno-3-371">371</a></span>
<span class="normal"><a href="#__codelineno-3-372">372</a></span>
<span class="normal"><a href="#__codelineno-3-373">373</a></span>
<span class="normal"><a href="#__codelineno-3-374">374</a></span>
<span class="normal"><a href="#__codelineno-3-375">375</a></span>
<span class="normal"><a href="#__codelineno-3-376">376</a></span>
<span class="normal"><a href="#__codelineno-3-377">377</a></span>
<span class="normal"><a href="#__codelineno-3-378">378</a></span>
<span class="normal"><a href="#__codelineno-3-379">379</a></span>
<span class="normal"><a href="#__codelineno-3-380">380</a></span>
<span class="normal"><a href="#__codelineno-3-381">381</a></span>
<span class="normal"><a href="#__codelineno-3-382">382</a></span>
<span class="normal"><a href="#__codelineno-3-383">383</a></span>
<span class="normal"><a href="#__codelineno-3-384">384</a></span>
<span class="normal"><a href="#__codelineno-3-385">385</a></span>
<span class="normal"><a href="#__codelineno-3-386">386</a></span>
<span class="normal"><a href="#__codelineno-3-387">387</a></span>
<span class="normal"><a href="#__codelineno-3-388">388</a></span>
<span class="normal"><a href="#__codelineno-3-389">389</a></span>
<span class="normal"><a href="#__codelineno-3-390">390</a></span>
<span class="normal"><a href="#__codelineno-3-391">391</a></span>
<span class="normal"><a href="#__codelineno-3-392">392</a></span>
<span class="normal"><a href="#__codelineno-3-393">393</a></span>
<span class="normal"><a href="#__codelineno-3-394">394</a></span>
<span class="normal"><a href="#__codelineno-3-395">395</a></span>
<span class="normal"><a href="#__codelineno-3-396">396</a></span>
<span class="normal"><a href="#__codelineno-3-397">397</a></span>
<span class="normal"><a href="#__codelineno-3-398">398</a></span>
<span class="normal"><a href="#__codelineno-3-399">399</a></span>
<span class="normal"><a href="#__codelineno-3-400">400</a></span>
<span class="normal"><a href="#__codelineno-3-401">401</a></span>
<span class="normal"><a href="#__codelineno-3-402">402</a></span>
<span class="normal"><a href="#__codelineno-3-403">403</a></span>
<span class="normal"><a href="#__codelineno-3-404">404</a></span>
<span class="normal"><a href="#__codelineno-3-405">405</a></span>
<span class="normal"><a href="#__codelineno-3-406">406</a></span>
<span class="normal"><a href="#__codelineno-3-407">407</a></span>
<span class="normal"><a href="#__codelineno-3-408">408</a></span>
<span class="normal"><a href="#__codelineno-3-409">409</a></span>
<span class="normal"><a href="#__codelineno-3-410">410</a></span>
<span class="normal"><a href="#__codelineno-3-411">411</a></span>
<span class="normal"><a href="#__codelineno-3-412">412</a></span>
<span class="normal"><a href="#__codelineno-3-413">413</a></span>
<span class="normal"><a href="#__codelineno-3-414">414</a></span>
<span class="normal"><a href="#__codelineno-3-415">415</a></span>
<span class="normal"><a href="#__codelineno-3-416">416</a></span>
<span class="normal"><a href="#__codelineno-3-417">417</a></span>
<span class="normal"><a href="#__codelineno-3-418">418</a></span>
<span class="normal"><a href="#__codelineno-3-419">419</a></span>
<span class="normal"><a href="#__codelineno-3-420">420</a></span>
<span class="normal"><a href="#__codelineno-3-421">421</a></span>
<span class="normal"><a href="#__codelineno-3-422">422</a></span>
<span class="normal"><a href="#__codelineno-3-423">423</a></span>
<span class="normal"><a href="#__codelineno-3-424">424</a></span>
<span class="normal"><a href="#__codelineno-3-425">425</a></span>
<span class="normal"><a href="#__codelineno-3-426">426</a></span>
<span class="normal"><a href="#__codelineno-3-427">427</a></span>
<span class="normal"><a href="#__codelineno-3-428">428</a></span>
<span class="normal"><a href="#__codelineno-3-429">429</a></span>
<span class="normal"><a href="#__codelineno-3-430">430</a></span>
<span class="normal"><a href="#__codelineno-3-431">431</a></span>
<span class="normal"><a href="#__codelineno-3-432">432</a></span>
<span class="normal"><a href="#__codelineno-3-433">433</a></span>
<span class="normal"><a href="#__codelineno-3-434">434</a></span>
<span class="normal"><a href="#__codelineno-3-435">435</a></span>
<span class="normal"><a href="#__codelineno-3-436">436</a></span>
<span class="normal"><a href="#__codelineno-3-437">437</a></span>
<span class="normal"><a href="#__codelineno-3-438">438</a></span>
<span class="normal"><a href="#__codelineno-3-439">439</a></span>
<span class="normal"><a href="#__codelineno-3-440">440</a></span>
<span class="normal"><a href="#__codelineno-3-441">441</a></span>
<span class="normal"><a href="#__codelineno-3-442">442</a></span>
<span class="normal"><a href="#__codelineno-3-443">443</a></span>
<span class="normal"><a href="#__codelineno-3-444">444</a></span>
<span class="normal"><a href="#__codelineno-3-445">445</a></span>
<span class="normal"><a href="#__codelineno-3-446">446</a></span>
<span class="normal"><a href="#__codelineno-3-447">447</a></span>
<span class="normal"><a href="#__codelineno-3-448">448</a></span>
<span class="normal"><a href="#__codelineno-3-449">449</a></span>
<span class="normal"><a href="#__codelineno-3-450">450</a></span>
<span class="normal"><a href="#__codelineno-3-451">451</a></span>
<span class="normal"><a href="#__codelineno-3-452">452</a></span>
<span class="normal"><a href="#__codelineno-3-453">453</a></span>
<span class="normal"><a href="#__codelineno-3-454">454</a></span>
<span class="normal"><a href="#__codelineno-3-455">455</a></span>
<span class="normal"><a href="#__codelineno-3-456">456</a></span>
<span class="normal"><a href="#__codelineno-3-457">457</a></span>
<span class="normal"><a href="#__codelineno-3-458">458</a></span>
<span class="normal"><a href="#__codelineno-3-459">459</a></span>
<span class="normal"><a href="#__codelineno-3-460">460</a></span>
<span class="normal"><a href="#__codelineno-3-461">461</a></span>
<span class="normal"><a href="#__codelineno-3-462">462</a></span>
<span class="normal"><a href="#__codelineno-3-463">463</a></span>
<span class="normal"><a href="#__codelineno-3-464">464</a></span>
<span class="normal"><a href="#__codelineno-3-465">465</a></span>
<span class="normal"><a href="#__codelineno-3-466">466</a></span>
<span class="normal"><a href="#__codelineno-3-467">467</a></span>
<span class="normal"><a href="#__codelineno-3-468">468</a></span>
<span class="normal"><a href="#__codelineno-3-469">469</a></span>
<span class="normal"><a href="#__codelineno-3-470">470</a></span>
<span class="normal"><a href="#__codelineno-3-471">471</a></span>
<span class="normal"><a href="#__codelineno-3-472">472</a></span>
<span class="normal"><a href="#__codelineno-3-473">473</a></span>
<span class="normal"><a href="#__codelineno-3-474">474</a></span>
<span class="normal"><a href="#__codelineno-3-475">475</a></span>
<span class="normal"><a href="#__codelineno-3-476">476</a></span>
<span class="normal"><a href="#__codelineno-3-477">477</a></span>
<span class="normal"><a href="#__codelineno-3-478">478</a></span>
<span class="normal"><a href="#__codelineno-3-479">479</a></span>
<span class="normal"><a href="#__codelineno-3-480">480</a></span>
<span class="normal"><a href="#__codelineno-3-481">481</a></span>
<span class="normal"><a href="#__codelineno-3-482">482</a></span>
<span class="normal"><a href="#__codelineno-3-483">483</a></span>
<span class="normal"><a href="#__codelineno-3-484">484</a></span>
<span class="normal"><a href="#__codelineno-3-485">485</a></span>
<span class="normal"><a href="#__codelineno-3-486">486</a></span>
<span class="normal"><a href="#__codelineno-3-487">487</a></span>
<span class="normal"><a href="#__codelineno-3-488">488</a></span>
<span class="normal"><a href="#__codelineno-3-489">489</a></span>
<span class="normal"><a href="#__codelineno-3-490">490</a></span>
<span class="normal"><a href="#__codelineno-3-491">491</a></span>
<span class="normal"><a href="#__codelineno-3-492">492</a></span>
<span class="normal"><a href="#__codelineno-3-493">493</a></span>
<span class="normal"><a href="#__codelineno-3-494">494</a></span>
<span class="normal"><a href="#__codelineno-3-495">495</a></span>
<span class="normal"><a href="#__codelineno-3-496">496</a></span>
<span class="normal"><a href="#__codelineno-3-497">497</a></span>
<span class="normal"><a href="#__codelineno-3-498">498</a></span>
<span class="normal"><a href="#__codelineno-3-499">499</a></span>
<span class="normal"><a href="#__codelineno-3-500">500</a></span>
<span class="normal"><a href="#__codelineno-3-501">501</a></span>
<span class="normal"><a href="#__codelineno-3-502">502</a></span>
<span class="normal"><a href="#__codelineno-3-503">503</a></span>
<span class="normal"><a href="#__codelineno-3-504">504</a></span>
<span class="normal"><a href="#__codelineno-3-505">505</a></span>
<span class="normal"><a href="#__codelineno-3-506">506</a></span>
<span class="normal"><a href="#__codelineno-3-507">507</a></span>
<span class="normal"><a href="#__codelineno-3-508">508</a></span>
<span class="normal"><a href="#__codelineno-3-509">509</a></span>
<span class="normal"><a href="#__codelineno-3-510">510</a></span>
<span class="normal"><a href="#__codelineno-3-511">511</a></span>
<span class="normal"><a href="#__codelineno-3-512">512</a></span>
<span class="normal"><a href="#__codelineno-3-513">513</a></span>
<span class="normal"><a href="#__codelineno-3-514">514</a></span>
<span class="normal"><a href="#__codelineno-3-515">515</a></span>
<span class="normal"><a href="#__codelineno-3-516">516</a></span>
<span class="normal"><a href="#__codelineno-3-517">517</a></span>
<span class="normal"><a href="#__codelineno-3-518">518</a></span>
<span class="normal"><a href="#__codelineno-3-519">519</a></span>
<span class="normal"><a href="#__codelineno-3-520">520</a></span>
<span class="normal"><a href="#__codelineno-3-521">521</a></span>
<span class="normal"><a href="#__codelineno-3-522">522</a></span>
<span class="normal"><a href="#__codelineno-3-523">523</a></span>
<span class="normal"><a href="#__codelineno-3-524">524</a></span>
<span class="normal"><a href="#__codelineno-3-525">525</a></span>
<span class="normal"><a href="#__codelineno-3-526">526</a></span>
<span class="normal"><a href="#__codelineno-3-527">527</a></span>
<span class="normal"><a href="#__codelineno-3-528">528</a></span>
<span class="normal"><a href="#__codelineno-3-529">529</a></span>
<span class="normal"><a href="#__codelineno-3-530">530</a></span>
<span class="normal"><a href="#__codelineno-3-531">531</a></span>
<span class="normal"><a href="#__codelineno-3-532">532</a></span>
<span class="normal"><a href="#__codelineno-3-533">533</a></span>
<span class="normal"><a href="#__codelineno-3-534">534</a></span>
<span class="normal"><a href="#__codelineno-3-535">535</a></span>
<span class="normal"><a href="#__codelineno-3-536">536</a></span>
<span class="normal"><a href="#__codelineno-3-537">537</a></span>
<span class="normal"><a href="#__codelineno-3-538">538</a></span>
<span class="normal"><a href="#__codelineno-3-539">539</a></span>
<span class="normal"><a href="#__codelineno-3-540">540</a></span>
<span class="normal"><a href="#__codelineno-3-541">541</a></span>
<span class="normal"><a href="#__codelineno-3-542">542</a></span>
<span class="normal"><a href="#__codelineno-3-543">543</a></span>
<span class="normal"><a href="#__codelineno-3-544">544</a></span>
<span class="normal"><a href="#__codelineno-3-545">545</a></span>
<span class="normal"><a href="#__codelineno-3-546">546</a></span>
<span class="normal"><a href="#__codelineno-3-547">547</a></span>
<span class="normal"><a href="#__codelineno-3-548">548</a></span>
<span class="normal"><a href="#__codelineno-3-549">549</a></span>
<span class="normal"><a href="#__codelineno-3-550">550</a></span>
<span class="normal"><a href="#__codelineno-3-551">551</a></span>
<span class="normal"><a href="#__codelineno-3-552">552</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="s2">"(Possibly )?corrupt EXIF data"</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">ConcatDataset</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">T</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">vgg16</span><span class="p">,</span> <span class="n">VGG16_Weights</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">it</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="c1"># -------------------- 配置 --------------------</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="n">USE_AMP</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 固定用 CUDA AMP</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="c1"># Kaggle 路径</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="n">VOC2007_ROOT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2007/VOCtrainval_06-Nov-2007/VOCdevkit/VOC2007"</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="n">VOC2007_ROOT_ALT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2007/VOCdevkit/VOC2007"</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT_ALT</span><span class="p">):</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>    <span class="n">VOC2007_ROOT</span> <span class="o">=</span> <span class="n">VOC2007_ROOT_ALT</span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a>
<a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="n">VOC2012_ROOT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2012/VOC2012"</span>
<a id="__codelineno-3-31" name="__codelineno-3-31"></a>
<a id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="mi">21</span>
<a id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>
<a id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="n">VAL_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">6</span>
<a id="__codelineno-3-36" name="__codelineno-3-36"></a>
<a id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">7.5e-5</span>
<a id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="n">WEIGHT_DECAY</span> <span class="o">=</span> <span class="mf">1e-4</span>
<a id="__codelineno-3-39" name="__codelineno-3-39"></a><span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">50</span>
<a id="__codelineno-3-40" name="__codelineno-3-40"></a>
<a id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="c1"># 评估加速开关</span>
<a id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="n">EVAL_COMPUTE_LOSS</span> <span class="o">=</span> <span class="kc">False</span>     <span class="c1"># True 会计算 val loss，稍慢</span>
<a id="__codelineno-3-43" name="__codelineno-3-43"></a><span class="n">EVAL_MAX_BATCHES</span> <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># 限制评估批次数；None 表示全量</span>
<a id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="n">EVAL_MAX_IMAGES</span> <span class="o">=</span> <span class="kc">None</span>        <span class="c1"># 限制评估图片数；None 表示全量</span>
<a id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="n">EVAL_PROGRESS</span> <span class="o">=</span> <span class="kc">True</span>          <span class="c1"># 保留 tqdm 进度条</span>
<a id="__codelineno-3-46" name="__codelineno-3-46"></a>
<a id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="n">SAVE_DIR</span> <span class="o">=</span> <span class="s2">"/kaggle/working"</span>
<a id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="n">BEST_PATH_VOC</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"fcn8s_best_voc2012val.pth"</span><span class="p">)</span>
<a id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="n">LATEST_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"fcn8s_latest.pth"</span><span class="p">)</span>
<a id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="n">VIS_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"vis_voc_val"</span><span class="p">)</span>
<a id="__codelineno-3-51" name="__codelineno-3-51"></a>
<a id="__codelineno-3-52" name="__codelineno-3-52"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using device: </span><span class="si">{</span><span class="n">DEVICE</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s2">"cuda"</span><span class="p">:</span>
<a id="__codelineno-3-54" name="__codelineno-3-54"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-3-55" name="__codelineno-3-55"></a>
<a id="__codelineno-3-56" name="__codelineno-3-56"></a><span class="c1"># PASCAL VOC 颜色映射 (RGB) 用于可视化</span>
<a id="__codelineno-3-57" name="__codelineno-3-57"></a><span class="n">VOC_COLORMAP</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-3-58" name="__codelineno-3-58"></a>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
<a id="__codelineno-3-59" name="__codelineno-3-59"></a>    <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-3-60" name="__codelineno-3-60"></a>    <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
<a id="__codelineno-3-61" name="__codelineno-3-61"></a>    <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-3-62" name="__codelineno-3-62"></a>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
<a id="__codelineno-3-63" name="__codelineno-3-63"></a><span class="p">]</span>
<a id="__codelineno-3-64" name="__codelineno-3-64"></a>
<a id="__codelineno-3-65" name="__codelineno-3-65"></a><span class="c1"># -------------------- 数据集（VOC） --------------------</span>
<a id="__codelineno-3-66" name="__codelineno-3-66"></a><span class="k">class</span><span class="w"> </span><span class="nc">VOCSegmentationDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-3-67" name="__codelineno-3-67"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-3-68" name="__codelineno-3-68"></a><span class="sd">    用于 VOC2007/VOC2012 的语义分割数据。</span>
<a id="__codelineno-3-69" name="__codelineno-3-69"></a><span class="sd">    若缺少 ImageSets/Segmentation/{split}.txt，将回退到扫描 SegmentationClass 目录。</span>
<a id="__codelineno-3-70" name="__codelineno-3-70"></a><span class="sd">    """</span>
<a id="__codelineno-3-71" name="__codelineno-3-71"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s2">"train"</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-3-72" name="__codelineno-3-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
<a id="__codelineno-3-73" name="__codelineno-3-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>
<a id="__codelineno-3-74" name="__codelineno-3-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_set</span> <span class="o">=</span> <span class="n">image_set</span>
<a id="__codelineno-3-75" name="__codelineno-3-75"></a>
<a id="__codelineno-3-76" name="__codelineno-3-76"></a>        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"JPEGImages"</span><span class="p">)</span>
<a id="__codelineno-3-77" name="__codelineno-3-77"></a>        <span class="n">mask_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"SegmentationClass"</span><span class="p">)</span>
<a id="__codelineno-3-78" name="__codelineno-3-78"></a>        <span class="n">split_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"ImageSets"</span><span class="p">,</span> <span class="s2">"Segmentation"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">image_set</span><span class="si">}</span><span class="s2">.txt"</span><span class="p">)</span>
<a id="__codelineno-3-79" name="__codelineno-3-79"></a>
<a id="__codelineno-3-80" name="__codelineno-3-80"></a>        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">image_dir</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Image dir not found: </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-3-81" name="__codelineno-3-81"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">):</span>
<a id="__codelineno-3-82" name="__codelineno-3-82"></a>            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
<a id="__codelineno-3-83" name="__codelineno-3-83"></a>                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"SegmentationClass not found: </span><span class="si">{</span><span class="n">mask_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-84" name="__codelineno-3-84"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-85" name="__codelineno-3-85"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[Warning] SegmentationClass not found in </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">, dataset will be empty."</span><span class="p">)</span>
<a id="__codelineno-3-86" name="__codelineno-3-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span> <span class="o">=</span> <span class="n">image_dir</span>
<a id="__codelineno-3-87" name="__codelineno-3-87"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask_dir</span> <span class="o">=</span> <span class="n">mask_dir</span>
<a id="__codelineno-3-88" name="__codelineno-3-88"></a>
<a id="__codelineno-3-89" name="__codelineno-3-89"></a>        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-90" name="__codelineno-3-90"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">split_file</span><span class="p">):</span>
<a id="__codelineno-3-91" name="__codelineno-3-91"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">split_file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-3-92" name="__codelineno-3-92"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
<a id="__codelineno-3-93" name="__codelineno-3-93"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-94" name="__codelineno-3-94"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">):</span>
<a id="__codelineno-3-95" name="__codelineno-3-95"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".png"</span><span class="p">)]</span>
<a id="__codelineno-3-96" name="__codelineno-3-96"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-97" name="__codelineno-3-97"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-98" name="__codelineno-3-98"></a>
<a id="__codelineno-3-99" name="__codelineno-3-99"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-3-100" name="__codelineno-3-100"></a>        <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
<a id="__codelineno-3-101" name="__codelineno-3-101"></a>            <span class="n">ip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.jpg"</span><span class="p">)</span>
<a id="__codelineno-3-102" name="__codelineno-3-102"></a>            <span class="n">mp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
<a id="__codelineno-3-103" name="__codelineno-3-103"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">mp</span><span class="p">):</span>
<a id="__codelineno-3-104" name="__codelineno-3-104"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
<a id="__codelineno-3-105" name="__codelineno-3-105"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<a id="__codelineno-3-106" name="__codelineno-3-106"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-107" name="__codelineno-3-107"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[Warning] Empty dataset for root=</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">, split=</span><span class="si">{</span><span class="n">image_set</span><span class="si">}</span><span class="s2">. Check masks/splits."</span><span class="p">)</span>
<a id="__codelineno-3-108" name="__codelineno-3-108"></a>
<a id="__codelineno-3-109" name="__codelineno-3-109"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-110" name="__codelineno-3-110"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">)</span>
<a id="__codelineno-3-111" name="__codelineno-3-111"></a>
<a id="__codelineno-3-112" name="__codelineno-3-112"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-3-113" name="__codelineno-3-113"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">"RGB"</span><span class="p">)</span>
<a id="__codelineno-3-114" name="__codelineno-3-114"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>  <span class="c1"># palette 索引</span>
<a id="__codelineno-3-115" name="__codelineno-3-115"></a>
<a id="__codelineno-3-116" name="__codelineno-3-116"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-117" name="__codelineno-3-117"></a>            <span class="n">image</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-3-118" name="__codelineno-3-118"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-119" name="__codelineno-3-119"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-3-120" name="__codelineno-3-120"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">))</span>
<a id="__codelineno-3-121" name="__codelineno-3-121"></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-3-122" name="__codelineno-3-122"></a>            <span class="n">image</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-3-123" name="__codelineno-3-123"></a>        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-3-124" name="__codelineno-3-124"></a>
<a id="__codelineno-3-125" name="__codelineno-3-125"></a><span class="c1"># -------------------- 数据增强与预处理 --------------------</span>
<a id="__codelineno-3-126" name="__codelineno-3-126"></a><span class="k">class</span><span class="w"> </span><span class="nc">SegmentationTransforms</span><span class="p">:</span>
<a id="__codelineno-3-127" name="__codelineno-3-127"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">,</span>
<a id="__codelineno-3-128" name="__codelineno-3-128"></a>                 <span class="n">color_jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_noise_prob</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>
<a id="__codelineno-3-129" name="__codelineno-3-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="n">is_train</span>
<a id="__codelineno-3-130" name="__codelineno-3-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_size</span> <span class="o">=</span> <span class="n">base_size</span>
<a id="__codelineno-3-131" name="__codelineno-3-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">=</span> <span class="n">crop_size</span>
<a id="__codelineno-3-132" name="__codelineno-3-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">)</span>
<a id="__codelineno-3-133" name="__codelineno-3-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)</span>
<a id="__codelineno-3-134" name="__codelineno-3-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ColorJitter</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_jitter</span> <span class="ow">and</span> <span class="n">is_train</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-3-135" name="__codelineno-3-135"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_noise_prob</span> <span class="o">=</span> <span class="n">add_noise_prob</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-3-136" name="__codelineno-3-136"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">noise_std</span> <span class="o">=</span> <span class="n">noise_std</span>
<a id="__codelineno-3-137" name="__codelineno-3-137"></a>
<a id="__codelineno-3-138" name="__codelineno-3-138"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<a id="__codelineno-3-139" name="__codelineno-3-139"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">:</span>
<a id="__codelineno-3-140" name="__codelineno-3-140"></a>            <span class="c1"># 1) 随机缩放短边到 [0.5, 2.0] * base_size</span>
<a id="__codelineno-3-141" name="__codelineno-3-141"></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-3-142" name="__codelineno-3-142"></a>            <span class="n">short</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
<a id="__codelineno-3-143" name="__codelineno-3-143"></a>            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-3-144" name="__codelineno-3-144"></a>            <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">:</span>
<a id="__codelineno-3-145" name="__codelineno-3-145"></a>                <span class="n">ow</span><span class="p">,</span> <span class="n">oh</span> <span class="o">=</span> <span class="n">short</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">short</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-3-146" name="__codelineno-3-146"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-147" name="__codelineno-3-147"></a>                <span class="n">oh</span><span class="p">,</span> <span class="n">ow</span> <span class="o">=</span> <span class="n">short</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">short</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-3-148" name="__codelineno-3-148"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">ow</span><span class="p">,</span> <span class="n">oh</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">)</span>
<a id="__codelineno-3-149" name="__codelineno-3-149"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">ow</span><span class="p">,</span> <span class="n">oh</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">NEAREST</span><span class="p">)</span>
<a id="__codelineno-3-150" name="__codelineno-3-150"></a>
<a id="__codelineno-3-151" name="__codelineno-3-151"></a>            <span class="c1"># 2) 若小于 crop_size，右下角 padding（mask 用 255）</span>
<a id="__codelineno-3-152" name="__codelineno-3-152"></a>            <span class="n">pad_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-3-153" name="__codelineno-3-153"></a>            <span class="n">pad_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-3-154" name="__codelineno-3-154"></a>            <span class="k">if</span> <span class="n">pad_w</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pad_h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-155" name="__codelineno-3-155"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">,</span> <span class="n">pad_h</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-156" name="__codelineno-3-156"></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">,</span> <span class="n">pad_h</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-3-157" name="__codelineno-3-157"></a>
<a id="__codelineno-3-158" name="__codelineno-3-158"></a>            <span class="c1"># 3) 随机裁剪</span>
<a id="__codelineno-3-159" name="__codelineno-3-159"></a>            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-3-160" name="__codelineno-3-160"></a>            <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-161" name="__codelineno-3-161"></a>            <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-162" name="__codelineno-3-162"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">))</span>
<a id="__codelineno-3-163" name="__codelineno-3-163"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">))</span>
<a id="__codelineno-3-164" name="__codelineno-3-164"></a>
<a id="__codelineno-3-165" name="__codelineno-3-165"></a>            <span class="c1"># 4) 随机水平翻转</span>
<a id="__codelineno-3-166" name="__codelineno-3-166"></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
<a id="__codelineno-3-167" name="__codelineno-3-167"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">hflip</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-3-168" name="__codelineno-3-168"></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">hflip</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-3-169" name="__codelineno-3-169"></a>
<a id="__codelineno-3-170" name="__codelineno-3-170"></a>            <span class="c1"># 5) 颜色抖动</span>
<a id="__codelineno-3-171" name="__codelineno-3-171"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-172" name="__codelineno-3-172"></a>                <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-3-173" name="__codelineno-3-173"></a>
<a id="__codelineno-3-174" name="__codelineno-3-174"></a>        <span class="c1"># 转 Tensor</span>
<a id="__codelineno-3-175" name="__codelineno-3-175"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-3-176" name="__codelineno-3-176"></a>
<a id="__codelineno-3-177" name="__codelineno-3-177"></a>        <span class="c1"># 可选噪声（归一化前）</span>
<a id="__codelineno-3-178" name="__codelineno-3-178"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_noise_prob</span><span class="p">:</span>
<a id="__codelineno-3-179" name="__codelineno-3-179"></a>            <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_std</span>
<a id="__codelineno-3-180" name="__codelineno-3-180"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">img</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-3-181" name="__codelineno-3-181"></a>
<a id="__codelineno-3-182" name="__codelineno-3-182"></a>        <span class="c1"># 标准化</span>
<a id="__codelineno-3-183" name="__codelineno-3-183"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)</span>
<a id="__codelineno-3-184" name="__codelineno-3-184"></a>
<a id="__codelineno-3-185" name="__codelineno-3-185"></a>        <span class="c1"># 直接把 palette/L 索引图转成类别 id（0..20，255 忽略）</span>
<a id="__codelineno-3-186" name="__codelineno-3-186"></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-3-187" name="__codelineno-3-187"></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-3-188" name="__codelineno-3-188"></a>
<a id="__codelineno-3-189" name="__codelineno-3-189"></a><span class="c1"># -------------------- 模型（FCN-8s） --------------------</span>
<a id="__codelineno-3-190" name="__codelineno-3-190"></a><span class="k">def</span><span class="w"> </span><span class="nf">bilinear_kernel</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">):</span>
<a id="__codelineno-3-191" name="__codelineno-3-191"></a>    <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-3-192" name="__codelineno-3-192"></a>    <span class="n">center</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">kernel_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">factor</span> <span class="o">-</span> <span class="mf">0.5</span>
<a id="__codelineno-3-193" name="__codelineno-3-193"></a>    <span class="n">og</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">kernel_size</span><span class="p">,</span> <span class="p">:</span><span class="n">kernel_size</span><span class="p">]</span>
<a id="__codelineno-3-194" name="__codelineno-3-194"></a>    <span class="n">filt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span>
<a id="__codelineno-3-195" name="__codelineno-3-195"></a>    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-3-196" name="__codelineno-3-196"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)):</span>
<a id="__codelineno-3-197" name="__codelineno-3-197"></a>        <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">filt</span>
<a id="__codelineno-3-198" name="__codelineno-3-198"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-3-199" name="__codelineno-3-199"></a>
<a id="__codelineno-3-200" name="__codelineno-3-200"></a><span class="k">class</span><span class="w"> </span><span class="nc">FCN8s</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-3-201" name="__codelineno-3-201"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-3-202" name="__codelineno-3-202"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">FCN8s</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-3-203" name="__codelineno-3-203"></a>        <span class="n">vgg</span> <span class="o">=</span> <span class="n">vgg16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">VGG16_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span><span class="p">)</span>
<a id="__codelineno-3-204" name="__codelineno-3-204"></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">features</span>
<a id="__codelineno-3-205" name="__codelineno-3-205"></a>
<a id="__codelineno-3-206" name="__codelineno-3-206"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool3_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span>
<a id="__codelineno-3-207" name="__codelineno-3-207"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool4_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span>
<a id="__codelineno-3-208" name="__codelineno-3-208"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool5_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">24</span><span class="p">:]</span>
<a id="__codelineno-3-209" name="__codelineno-3-209"></a>
<a id="__codelineno-3-210" name="__codelineno-3-210"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-3-211" name="__codelineno-3-211"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-212" name="__codelineno-3-212"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drop6</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">()</span>
<a id="__codelineno-3-213" name="__codelineno-3-213"></a>
<a id="__codelineno-3-214" name="__codelineno-3-214"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-215" name="__codelineno-3-215"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relu7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-216" name="__codelineno-3-216"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drop7</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">()</span>
<a id="__codelineno-3-217" name="__codelineno-3-217"></a>
<a id="__codelineno-3-218" name="__codelineno-3-218"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_fr</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-219" name="__codelineno-3-219"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_pool3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-220" name="__codelineno-3-220"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">score_pool4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-221" name="__codelineno-3-221"></a>
<a id="__codelineno-3-222" name="__codelineno-3-222"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-223" name="__codelineno-3-223"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-224" name="__codelineno-3-224"></a>
<a id="__codelineno-3-225" name="__codelineno-3-225"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-3-226" name="__codelineno-3-226"></a>            <span class="n">fc6_w</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a id="__codelineno-3-227" name="__codelineno-3-227"></a>            <span class="n">fc6_b</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span>
<a id="__codelineno-3-228" name="__codelineno-3-228"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc6_w</span><span class="p">)</span>
<a id="__codelineno-3-229" name="__codelineno-3-229"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc6_b</span><span class="p">)</span>
<a id="__codelineno-3-230" name="__codelineno-3-230"></a>
<a id="__codelineno-3-231" name="__codelineno-3-231"></a>            <span class="n">fc7_w</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-232" name="__codelineno-3-232"></a>            <span class="n">fc7_b</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">classifier</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span>
<a id="__codelineno-3-233" name="__codelineno-3-233"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc7_w</span><span class="p">)</span>
<a id="__codelineno-3-234" name="__codelineno-3-234"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">fc7_b</span><span class="p">)</span>
<a id="__codelineno-3-235" name="__codelineno-3-235"></a>
<a id="__codelineno-3-236" name="__codelineno-3-236"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">bilinear_kernel</span><span class="p">(</span><span class="n">NUM_CLASSES</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-3-237" name="__codelineno-3-237"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">bilinear_kernel</span><span class="p">(</span><span class="n">NUM_CLASSES</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-3-238" name="__codelineno-3-238"></a>
<a id="__codelineno-3-239" name="__codelineno-3-239"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-3-240" name="__codelineno-3-240"></a>        <span class="n">input_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<a id="__codelineno-3-241" name="__codelineno-3-241"></a>        <span class="n">pool3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool3_features</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-3-242" name="__codelineno-3-242"></a>        <span class="n">pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool4_features</span><span class="p">(</span><span class="n">pool3</span><span class="p">)</span>
<a id="__codelineno-3-243" name="__codelineno-3-243"></a>        <span class="n">pool5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool5_features</span><span class="p">(</span><span class="n">pool4</span><span class="p">)</span>
<a id="__codelineno-3-244" name="__codelineno-3-244"></a>
<a id="__codelineno-3-245" name="__codelineno-3-245"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu6</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc6</span><span class="p">(</span><span class="n">pool5</span><span class="p">))</span>
<a id="__codelineno-3-246" name="__codelineno-3-246"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop6</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-3-247" name="__codelineno-3-247"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu7</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc7</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
<a id="__codelineno-3-248" name="__codelineno-3-248"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop7</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-3-249" name="__codelineno-3-249"></a>
<a id="__codelineno-3-250" name="__codelineno-3-250"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_fr</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-3-251" name="__codelineno-3-251"></a>        <span class="n">upscore2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upscore2</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-3-252" name="__codelineno-3-252"></a>
<a id="__codelineno-3-253" name="__codelineno-3-253"></a>        <span class="n">score_pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_pool4</span><span class="p">(</span><span class="n">pool4</span><span class="p">)</span>
<a id="__codelineno-3-254" name="__codelineno-3-254"></a>        <span class="n">upscore2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">upscore2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">score_pool4</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-255" name="__codelineno-3-255"></a>        <span class="n">fuse_pool4</span> <span class="o">=</span> <span class="n">upscore2</span> <span class="o">+</span> <span class="n">score_pool4</span>
<a id="__codelineno-3-256" name="__codelineno-3-256"></a>
<a id="__codelineno-3-257" name="__codelineno-3-257"></a>        <span class="n">upscore_pool4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upscore_pool4</span><span class="p">(</span><span class="n">fuse_pool4</span><span class="p">)</span>
<a id="__codelineno-3-258" name="__codelineno-3-258"></a>
<a id="__codelineno-3-259" name="__codelineno-3-259"></a>        <span class="n">score_pool3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_pool3</span><span class="p">(</span><span class="n">pool3</span><span class="p">)</span>
<a id="__codelineno-3-260" name="__codelineno-3-260"></a>        <span class="n">upscore_pool4</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">upscore_pool4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">score_pool3</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-261" name="__codelineno-3-261"></a>        <span class="n">fuse_pool3</span> <span class="o">=</span> <span class="n">upscore_pool4</span> <span class="o">+</span> <span class="n">score_pool3</span>
<a id="__codelineno-3-262" name="__codelineno-3-262"></a>
<a id="__codelineno-3-263" name="__codelineno-3-263"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">fuse_pool3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-264" name="__codelineno-3-264"></a>        <span class="k">return</span> <span class="n">out</span>
<a id="__codelineno-3-265" name="__codelineno-3-265"></a>
<a id="__codelineno-3-266" name="__codelineno-3-266"></a><span class="c1"># -------------------- 评估指标 --------------------</span>
<a id="__codelineno-3-267" name="__codelineno-3-267"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
<a id="__codelineno-3-268" name="__codelineno-3-268"></a>    <span class="n">pixel_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-3-269" name="__codelineno-3-269"></a>    <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
<a id="__codelineno-3-270" name="__codelineno-3-270"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">),</span> <span class="n">denom</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">denom</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-271" name="__codelineno-3-271"></a>    <span class="n">miou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span>
<a id="__codelineno-3-272" name="__codelineno-3-272"></a>    <span class="k">return</span> <span class="n">pixel_accuracy</span><span class="p">,</span> <span class="n">miou</span>
<a id="__codelineno-3-273" name="__codelineno-3-273"></a>
<a id="__codelineno-3-274" name="__codelineno-3-274"></a><span class="c1"># -------------------- 训练 / 验证 --------------------</span>
<a id="__codelineno-3-275" name="__codelineno-3-275"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_one_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">,</span> <span class="n">grad_clip</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<a id="__codelineno-3-276" name="__codelineno-3-276"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-3-277" name="__codelineno-3-277"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-278" name="__codelineno-3-278"></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Training"</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-279" name="__codelineno-3-279"></a>    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">progress_bar</span><span class="p">:</span>
<a id="__codelineno-3-280" name="__codelineno-3-280"></a>        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-281" name="__codelineno-3-281"></a>        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-282" name="__codelineno-3-282"></a>
<a id="__codelineno-3-283" name="__codelineno-3-283"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-3-284" name="__codelineno-3-284"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-3-285" name="__codelineno-3-285"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-3-286" name="__codelineno-3-286"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-3-287" name="__codelineno-3-287"></a>
<a id="__codelineno-3-288" name="__codelineno-3-288"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-3-289" name="__codelineno-3-289"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">unscale_</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
<a id="__codelineno-3-290" name="__codelineno-3-290"></a>        <span class="k">if</span> <span class="n">grad_clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grad_clip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-291" name="__codelineno-3-291"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">grad_clip</span><span class="p">)</span>
<a id="__codelineno-3-292" name="__codelineno-3-292"></a>
<a id="__codelineno-3-293" name="__codelineno-3-293"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
<a id="__codelineno-3-294" name="__codelineno-3-294"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<a id="__codelineno-3-295" name="__codelineno-3-295"></a>
<a id="__codelineno-3-296" name="__codelineno-3-296"></a>        <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-3-297" name="__codelineno-3-297"></a>
<a id="__codelineno-3-298" name="__codelineno-3-298"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-299" name="__codelineno-3-299"></a>        <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span>
<a id="__codelineno-3-300" name="__codelineno-3-300"></a>            <span class="n">loss</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
<a id="__codelineno-3-301" name="__codelineno-3-301"></a>            <span class="n">lr</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"lr"</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">"lr"</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">'</span>
<a id="__codelineno-3-302" name="__codelineno-3-302"></a>        <span class="p">)</span>
<a id="__codelineno-3-303" name="__codelineno-3-303"></a>    <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
<a id="__codelineno-3-304" name="__codelineno-3-304"></a>
<a id="__codelineno-3-305" name="__codelineno-3-305"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-3-306" name="__codelineno-3-306"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_fast</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
<a id="__codelineno-3-307" name="__codelineno-3-307"></a>                  <span class="n">compute_loss</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_batches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-3-308" name="__codelineno-3-308"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-3-309" name="__codelineno-3-309"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-3-310" name="__codelineno-3-310"></a>    <span class="n">seen_images</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-311" name="__codelineno-3-311"></a>    <span class="n">batches</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-312" name="__codelineno-3-312"></a>
<a id="__codelineno-3-313" name="__codelineno-3-313"></a>    <span class="n">conf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-314" name="__codelineno-3-314"></a>    <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Evaluating"</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="k">else</span> <span class="n">data_loader</span>
<a id="__codelineno-3-315" name="__codelineno-3-315"></a>
<a id="__codelineno-3-316" name="__codelineno-3-316"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
<a id="__codelineno-3-317" name="__codelineno-3-317"></a>        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
<a id="__codelineno-3-318" name="__codelineno-3-318"></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-319" name="__codelineno-3-319"></a>            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-320" name="__codelineno-3-320"></a>
<a id="__codelineno-3-321" name="__codelineno-3-321"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-3-322" name="__codelineno-3-322"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-3-323" name="__codelineno-3-323"></a>                <span class="k">if</span> <span class="n">compute_loss</span><span class="p">:</span>
<a id="__codelineno-3-324" name="__codelineno-3-324"></a>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-3-325" name="__codelineno-3-325"></a>                    <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-326" name="__codelineno-3-326"></a>
<a id="__codelineno-3-327" name="__codelineno-3-327"></a>            <span class="n">preds</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-328" name="__codelineno-3-328"></a>            <span class="n">valid</span> <span class="o">=</span> <span class="n">targets</span> <span class="o">!=</span> <span class="mi">255</span>
<a id="__codelineno-3-329" name="__codelineno-3-329"></a>            <span class="k">if</span> <span class="n">valid</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-3-330" name="__codelineno-3-330"></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">num_classes</span>
<a id="__codelineno-3-331" name="__codelineno-3-331"></a>                <span class="n">t</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-3-332" name="__codelineno-3-332"></a>                <span class="n">p</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-3-333" name="__codelineno-3-333"></a>                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-334" name="__codelineno-3-334"></a>                <span class="n">conf</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a id="__codelineno-3-335" name="__codelineno-3-335"></a>
<a id="__codelineno-3-336" name="__codelineno-3-336"></a>            <span class="n">batches</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-3-337" name="__codelineno-3-337"></a>            <span class="n">seen_images</span> <span class="o">+=</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-338" name="__codelineno-3-338"></a>
<a id="__codelineno-3-339" name="__codelineno-3-339"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">max_batches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">batches</span> <span class="o">&gt;=</span> <span class="n">max_batches</span><span class="p">)</span> <span class="ow">or</span> \
<a id="__codelineno-3-340" name="__codelineno-3-340"></a>               <span class="p">(</span><span class="n">max_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seen_images</span> <span class="o">&gt;=</span> <span class="n">max_images</span><span class="p">):</span>
<a id="__codelineno-3-341" name="__codelineno-3-341"></a>                <span class="k">break</span>
<a id="__codelineno-3-342" name="__codelineno-3-342"></a>
<a id="__codelineno-3-343" name="__codelineno-3-343"></a>    <span class="n">conf_f</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-3-344" name="__codelineno-3-344"></a>    <span class="n">total</span> <span class="o">=</span> <span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-3-345" name="__codelineno-3-345"></a>    <span class="n">pixel_acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-3-346" name="__codelineno-3-346"></a>    <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">))</span>
<a id="__codelineno-3-347" name="__codelineno-3-347"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">denom</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)))</span>
<a id="__codelineno-3-348" name="__codelineno-3-348"></a>    <span class="n">miou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-349" name="__codelineno-3-349"></a>
<a id="__codelineno-3-350" name="__codelineno-3-350"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_loss</span> <span class="o">/</span> <span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">compute_loss</span> <span class="ow">and</span> <span class="n">batches</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
<a id="__codelineno-3-351" name="__codelineno-3-351"></a>    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">pixel_acc</span><span class="p">,</span> <span class="n">miou</span>
<a id="__codelineno-3-352" name="__codelineno-3-352"></a>
<a id="__codelineno-3-353" name="__codelineno-3-353"></a><span class="c1"># -------------------- 可视化 --------------------</span>
<a id="__codelineno-3-354" name="__codelineno-3-354"></a><span class="k">def</span><span class="w"> </span><span class="nf">decode_segmap</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">void_value</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">void_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
<a id="__codelineno-3-355" name="__codelineno-3-355"></a>    <span class="n">lut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-3-356" name="__codelineno-3-356"></a>    <span class="n">lut</span><span class="p">[:</span><span class="n">nc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">VOC_COLORMAP</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-3-357" name="__codelineno-3-357"></a>    <span class="n">lut</span><span class="p">[</span><span class="n">void_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">void_color</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-3-358" name="__codelineno-3-358"></a>    <span class="k">return</span> <span class="n">lut</span><span class="p">[</span><span class="n">image</span><span class="p">]</span>
<a id="__codelineno-3-359" name="__codelineno-3-359"></a>
<a id="__codelineno-3-360" name="__codelineno-3-360"></a><span class="k">def</span><span class="w"> </span><span class="nf">denormalize</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
<a id="__codelineno-3-361" name="__codelineno-3-361"></a>    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">])</span>
<a id="__codelineno-3-362" name="__codelineno-3-362"></a>    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
<a id="__codelineno-3-363" name="__codelineno-3-363"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-364" name="__codelineno-3-364"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">mean</span>
<a id="__codelineno-3-365" name="__codelineno-3-365"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-366" name="__codelineno-3-366"></a>
<a id="__codelineno-3-367" name="__codelineno-3-367"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-3-368" name="__codelineno-3-368"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_predictions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">VIS_DIR</span><span class="p">,</span> <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
<a id="__codelineno-3-369" name="__codelineno-3-369"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-370" name="__codelineno-3-370"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-3-371" name="__codelineno-3-371"></a>    <span class="n">shown</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-372" name="__codelineno-3-372"></a>
<a id="__codelineno-3-373" name="__codelineno-3-373"></a>    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
<a id="__codelineno-3-374" name="__codelineno-3-374"></a>        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-375" name="__codelineno-3-375"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-3-376" name="__codelineno-3-376"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-3-377" name="__codelineno-3-377"></a>
<a id="__codelineno-3-378" name="__codelineno-3-378"></a>        <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-3-379" name="__codelineno-3-379"></a>        <span class="n">images_cpu</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-3-380" name="__codelineno-3-380"></a>        <span class="n">targets_np</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-3-381" name="__codelineno-3-381"></a>
<a id="__codelineno-3-382" name="__codelineno-3-382"></a>        <span class="n">bsz</span> <span class="o">=</span> <span class="n">images_cpu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-3-383" name="__codelineno-3-383"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bsz</span><span class="p">):</span>
<a id="__codelineno-3-384" name="__codelineno-3-384"></a>            <span class="k">if</span> <span class="n">shown</span> <span class="o">&gt;=</span> <span class="n">num_images</span><span class="p">:</span> <span class="k">break</span>
<a id="__codelineno-3-385" name="__codelineno-3-385"></a>
<a id="__codelineno-3-386" name="__codelineno-3-386"></a>            <span class="n">original_img</span> <span class="o">=</span> <span class="n">denormalize</span><span class="p">(</span><span class="n">images_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-3-387" name="__codelineno-3-387"></a>            <span class="n">gt_mask_rgb</span> <span class="o">=</span> <span class="n">decode_segmap</span><span class="p">(</span><span class="n">targets_np</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-3-388" name="__codelineno-3-388"></a>            <span class="n">pred_mask_rgb</span> <span class="o">=</span> <span class="n">decode_segmap</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-3-389" name="__codelineno-3-389"></a>
<a id="__codelineno-3-390" name="__codelineno-3-390"></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-3-391" name="__codelineno-3-391"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original_img</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Original"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-3-392" name="__codelineno-3-392"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gt_mask_rgb</span><span class="p">);</span>  <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Ground Truth"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-3-393" name="__codelineno-3-393"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred_mask_rgb</span><span class="p">);</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Prediction"</span><span class="p">);</span>   <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-3-394" name="__codelineno-3-394"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original_img</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred_mask_rgb</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">overlay_alpha</span><span class="p">)</span>
<a id="__codelineno-3-395" name="__codelineno-3-395"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Overlay"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-3-396" name="__codelineno-3-396"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-3-397" name="__codelineno-3-397"></a>
<a id="__codelineno-3-398" name="__codelineno-3-398"></a>            <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'result_</span><span class="si">{</span><span class="n">shown</span><span class="si">:</span><span class="s1">03d</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
<a id="__codelineno-3-399" name="__codelineno-3-399"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
<a id="__codelineno-3-400" name="__codelineno-3-400"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<a id="__codelineno-3-401" name="__codelineno-3-401"></a>            <span class="n">shown</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-3-402" name="__codelineno-3-402"></a>        <span class="k">if</span> <span class="n">shown</span> <span class="o">&gt;=</span> <span class="n">num_images</span><span class="p">:</span> <span class="k">break</span>
<a id="__codelineno-3-403" name="__codelineno-3-403"></a>
<a id="__codelineno-3-404" name="__codelineno-3-404"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"可视化结果保存在: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">（共 </span><span class="si">{</span><span class="n">shown</span><span class="si">}</span><span class="s2"> 张）"</span><span class="p">)</span>
<a id="__codelineno-3-405" name="__codelineno-3-405"></a>
<a id="__codelineno-3-406" name="__codelineno-3-406"></a><span class="c1"># -------------------- 准备数据与模型 --------------------</span>
<a id="__codelineno-3-407" name="__codelineno-3-407"></a><span class="c1"># 训练集：VOC2007 trainval + VOC2012 train（若 2007 不可用，则仅 2012）</span>
<a id="__codelineno-3-408" name="__codelineno-3-408"></a><span class="n">train_sets</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-409" name="__codelineno-3-409"></a>
<a id="__codelineno-3-410" name="__codelineno-3-410"></a><span class="c1"># VOC2007 trainval（若存在分割标注）</span>
<a id="__codelineno-3-411" name="__codelineno-3-411"></a><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT</span><span class="p">):</span>
<a id="__codelineno-3-412" name="__codelineno-3-412"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-3-413" name="__codelineno-3-413"></a>        <span class="n">train_07</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-3-414" name="__codelineno-3-414"></a>            <span class="n">VOC2007_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'trainval'</span><span class="p">,</span>
<a id="__codelineno-3-415" name="__codelineno-3-415"></a>            <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>
<a id="__codelineno-3-416" name="__codelineno-3-416"></a>            <span class="n">strict</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-3-417" name="__codelineno-3-417"></a>        <span class="p">)</span>
<a id="__codelineno-3-418" name="__codelineno-3-418"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-419" name="__codelineno-3-419"></a>            <span class="n">train_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span>
<a id="__codelineno-3-420" name="__codelineno-3-420"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"VOC2007 trainval 可用: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span><span class="si">}</span><span class="s2"> 样本"</span><span class="p">)</span>
<a id="__codelineno-3-421" name="__codelineno-3-421"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-422" name="__codelineno-3-422"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">"VOC2007 trainval 无可用分割样本，跳过 2007。"</span><span class="p">)</span>
<a id="__codelineno-3-423" name="__codelineno-3-423"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-3-424" name="__codelineno-3-424"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"加载 VOC2007 失败，跳过：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-425" name="__codelineno-3-425"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-426" name="__codelineno-3-426"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"未找到 VOC2007 路径：</span><span class="si">{</span><span class="n">VOC2007_ROOT</span><span class="si">}</span><span class="s2">（将仅使用 VOC2012 训练）"</span><span class="p">)</span>
<a id="__codelineno-3-427" name="__codelineno-3-427"></a>
<a id="__codelineno-3-428" name="__codelineno-3-428"></a><span class="c1"># VOC2012 train</span>
<a id="__codelineno-3-429" name="__codelineno-3-429"></a><span class="n">train_12</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-3-430" name="__codelineno-3-430"></a>    <span class="n">VOC2012_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'train'</span><span class="p">,</span>
<a id="__codelineno-3-431" name="__codelineno-3-431"></a>    <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>
<a id="__codelineno-3-432" name="__codelineno-3-432"></a>    <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-3-433" name="__codelineno-3-433"></a><span class="p">)</span>
<a id="__codelineno-3-434" name="__codelineno-3-434"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"VOC2012 train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_12</span><span class="p">)</span><span class="si">}</span><span class="s2"> 样本"</span><span class="p">)</span>
<a id="__codelineno-3-435" name="__codelineno-3-435"></a><span class="n">train_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_12</span><span class="p">)</span>
<a id="__codelineno-3-436" name="__codelineno-3-436"></a>
<a id="__codelineno-3-437" name="__codelineno-3-437"></a><span class="c1"># 合并训练集</span>
<a id="__codelineno-3-438" name="__codelineno-3-438"></a><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_sets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-3-439" name="__codelineno-3-439"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-3-440" name="__codelineno-3-440"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-441" name="__codelineno-3-441"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">ConcatDataset</span><span class="p">(</span><span class="n">train_sets</span><span class="p">)</span>
<a id="__codelineno-3-442" name="__codelineno-3-442"></a>
<a id="__codelineno-3-443" name="__codelineno-3-443"></a><span class="c1"># 验证：VOC2012 val</span>
<a id="__codelineno-3-444" name="__codelineno-3-444"></a><span class="n">val_dataset_voc</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-3-445" name="__codelineno-3-445"></a>    <span class="n">VOC2012_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'val'</span><span class="p">,</span>
<a id="__codelineno-3-446" name="__codelineno-3-446"></a>    <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>
<a id="__codelineno-3-447" name="__codelineno-3-447"></a>    <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-3-448" name="__codelineno-3-448"></a><span class="p">)</span>
<a id="__codelineno-3-449" name="__codelineno-3-449"></a>
<a id="__codelineno-3-450" name="__codelineno-3-450"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<a id="__codelineno-3-451" name="__codelineno-3-451"></a>    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-3-452" name="__codelineno-3-452"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-3-453" name="__codelineno-3-453"></a><span class="p">)</span>
<a id="__codelineno-3-454" name="__codelineno-3-454"></a><span class="n">val_loader_voc</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<a id="__codelineno-3-455" name="__codelineno-3-455"></a>    <span class="n">val_dataset_voc</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">VAL_BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-3-456" name="__codelineno-3-456"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-3-457" name="__codelineno-3-457"></a><span class="p">)</span>
<a id="__codelineno-3-458" name="__codelineno-3-458"></a>
<a id="__codelineno-3-459" name="__codelineno-3-459"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"训练集总样本数: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-460" name="__codelineno-3-460"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"验证集样本数 (VOC2012 val): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset_voc</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-461" name="__codelineno-3-461"></a>
<a id="__codelineno-3-462" name="__codelineno-3-462"></a><span class="n">model</span> <span class="o">=</span> <span class="n">FCN8s</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">NUM_CLASSES</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-3-463" name="__codelineno-3-463"></a><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">ignore_index</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-3-464" name="__codelineno-3-464"></a>
<a id="__codelineno-3-465" name="__codelineno-3-465"></a><span class="c1"># 参数分组 + poly 学习率</span>
<a id="__codelineno-3-466" name="__codelineno-3-466"></a><span class="n">base_lr</span> <span class="o">=</span> <span class="n">LEARNING_RATE</span>
<a id="__codelineno-3-467" name="__codelineno-3-467"></a><span class="n">new_lr</span> <span class="o">=</span> <span class="n">LEARNING_RATE</span> <span class="o">*</span> <span class="mi">10</span>
<a id="__codelineno-3-468" name="__codelineno-3-468"></a><span class="n">new_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">score_fr</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">score_pool3</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">score_pool4</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">upscore2</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">upscore_pool4</span><span class="p">]</span>
<a id="__codelineno-3-469" name="__codelineno-3-469"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">([</span>
<a id="__codelineno-3-470" name="__codelineno-3-470"></a>    <span class="p">{</span><span class="s1">'params'</span><span class="p">:</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pool3_features</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<a id="__codelineno-3-471" name="__codelineno-3-471"></a>                        <span class="n">model</span><span class="o">.</span><span class="n">pool4_features</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<a id="__codelineno-3-472" name="__codelineno-3-472"></a>                        <span class="n">model</span><span class="o">.</span><span class="n">pool5_features</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<a id="__codelineno-3-473" name="__codelineno-3-473"></a>                        <span class="n">model</span><span class="o">.</span><span class="n">fc6</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<a id="__codelineno-3-474" name="__codelineno-3-474"></a>                        <span class="n">model</span><span class="o">.</span><span class="n">fc7</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span> <span class="s1">'lr'</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">},</span>
<a id="__codelineno-3-475" name="__codelineno-3-475"></a>    <span class="p">{</span><span class="s1">'params'</span><span class="p">:</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">new_modules</span><span class="p">)),</span> <span class="s1">'lr'</span><span class="p">:</span> <span class="n">new_lr</span><span class="p">},</span>
<a id="__codelineno-3-476" name="__codelineno-3-476"></a><span class="p">],</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">WEIGHT_DECAY</span><span class="p">)</span>
<a id="__codelineno-3-477" name="__codelineno-3-477"></a>
<a id="__codelineno-3-478" name="__codelineno-3-478"></a><span class="n">max_iter</span> <span class="o">=</span> <span class="n">EPOCHS</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<a id="__codelineno-3-479" name="__codelineno-3-479"></a><span class="k">def</span><span class="w"> </span><span class="nf">poly_lr_lambda</span><span class="p">(</span><span class="n">it_idx</span><span class="p">):</span>
<a id="__codelineno-3-480" name="__codelineno-3-480"></a>    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">it_idx</span> <span class="o">/</span> <span class="n">max_iter</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.9</span>
<a id="__codelineno-3-481" name="__codelineno-3-481"></a><span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">LambdaLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_lambda</span><span class="o">=</span><span class="n">poly_lr_lambda</span><span class="p">)</span>
<a id="__codelineno-3-482" name="__codelineno-3-482"></a>
<a id="__codelineno-3-483" name="__codelineno-3-483"></a><span class="c1"># AMP Scaler（固定 cuda）</span>
<a id="__codelineno-3-484" name="__codelineno-3-484"></a><span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="s1">'cuda'</span><span class="p">)</span>
<a id="__codelineno-3-485" name="__codelineno-3-485"></a>
<a id="__codelineno-3-486" name="__codelineno-3-486"></a><span class="c1"># 记录与保存</span>
<a id="__codelineno-3-487" name="__codelineno-3-487"></a><span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'train_loss'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_loss'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_pa'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_miou'</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-3-488" name="__codelineno-3-488"></a><span class="n">best_miou_voc</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<a id="__codelineno-3-489" name="__codelineno-3-489"></a><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-490" name="__codelineno-3-490"></a>
<a id="__codelineno-3-491" name="__codelineno-3-491"></a><span class="c1"># -------------------- 训练循环 --------------------</span>
<a id="__codelineno-3-492" name="__codelineno-3-492"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"开始训练..."</span><span class="p">)</span>
<a id="__codelineno-3-493" name="__codelineno-3-493"></a><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-3-494" name="__codelineno-3-494"></a>
<a id="__codelineno-3-495" name="__codelineno-3-495"></a><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
<a id="__codelineno-3-496" name="__codelineno-3-496"></a>    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_one_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">)</span>
<a id="__codelineno-3-497" name="__codelineno-3-497"></a>
<a id="__codelineno-3-498" name="__codelineno-3-498"></a>    <span class="n">val_loss_voc</span><span class="p">,</span> <span class="n">val_pa_voc</span><span class="p">,</span> <span class="n">val_miou_voc</span> <span class="o">=</span> <span class="n">evaluate_fast</span><span class="p">(</span>
<a id="__codelineno-3-499" name="__codelineno-3-499"></a>        <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">val_loader_voc</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">,</span>
<a id="__codelineno-3-500" name="__codelineno-3-500"></a>        <span class="n">compute_loss</span><span class="o">=</span><span class="n">EVAL_COMPUTE_LOSS</span><span class="p">,</span>
<a id="__codelineno-3-501" name="__codelineno-3-501"></a>        <span class="n">max_batches</span><span class="o">=</span><span class="n">EVAL_MAX_BATCHES</span><span class="p">,</span>
<a id="__codelineno-3-502" name="__codelineno-3-502"></a>        <span class="n">max_images</span><span class="o">=</span><span class="n">EVAL_MAX_IMAGES</span><span class="p">,</span>
<a id="__codelineno-3-503" name="__codelineno-3-503"></a>        <span class="n">progress</span><span class="o">=</span><span class="n">EVAL_PROGRESS</span>
<a id="__codelineno-3-504" name="__codelineno-3-504"></a>    <span class="p">)</span>
<a id="__codelineno-3-505" name="__codelineno-3-505"></a>
<a id="__codelineno-3-506" name="__codelineno-3-506"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'train_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
<a id="__codelineno-3-507" name="__codelineno-3-507"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss_voc</span><span class="p">)</span>
<a id="__codelineno-3-508" name="__codelineno-3-508"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_pa'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_pa_voc</span><span class="p">)</span>
<a id="__codelineno-3-509" name="__codelineno-3-509"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_miou'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_miou_voc</span><span class="p">)</span>
<a id="__codelineno-3-510" name="__codelineno-3-510"></a>
<a id="__codelineno-3-511" name="__codelineno-3-511"></a>    <span class="k">if</span> <span class="n">val_miou_voc</span> <span class="o">&gt;</span> <span class="n">best_miou_voc</span><span class="p">:</span>
<a id="__codelineno-3-512" name="__codelineno-3-512"></a>        <span class="n">best_miou_voc</span> <span class="o">=</span> <span class="n">val_miou_voc</span>
<a id="__codelineno-3-513" name="__codelineno-3-513"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
<a id="__codelineno-3-514" name="__codelineno-3-514"></a>            <span class="s1">'epoch'</span><span class="p">:</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-3-515" name="__codelineno-3-515"></a>            <span class="s1">'model_state'</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<a id="__codelineno-3-516" name="__codelineno-3-516"></a>            <span class="s1">'optimizer_state'</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<a id="__codelineno-3-517" name="__codelineno-3-517"></a>            <span class="s1">'miou_voc'</span><span class="p">:</span> <span class="n">best_miou_voc</span><span class="p">,</span>
<a id="__codelineno-3-518" name="__codelineno-3-518"></a>            <span class="s1">'config'</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-3-519" name="__codelineno-3-519"></a>                <span class="s1">'base_lr'</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">,</span> <span class="s1">'new_lr'</span><span class="p">:</span> <span class="n">new_lr</span><span class="p">,</span> <span class="s1">'weight_decay'</span><span class="p">:</span> <span class="n">WEIGHT_DECAY</span><span class="p">,</span>
<a id="__codelineno-3-520" name="__codelineno-3-520"></a>                <span class="s1">'epochs'</span><span class="p">:</span> <span class="n">EPOCHS</span><span class="p">,</span> <span class="s1">'batch_size'</span><span class="p">:</span> <span class="n">BATCH_SIZE</span>
<a id="__codelineno-3-521" name="__codelineno-3-521"></a>            <span class="p">}</span>
<a id="__codelineno-3-522" name="__codelineno-3-522"></a>        <span class="p">},</span> <span class="n">BEST_PATH_VOC</span><span class="p">)</span>
<a id="__codelineno-3-523" name="__codelineno-3-523"></a>
<a id="__codelineno-3-524" name="__codelineno-3-524"></a>    <span class="n">val_loss_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val_loss_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">EVAL_COMPUTE_LOSS</span> <span class="k">else</span> <span class="s2">"n/a"</span>
<a id="__codelineno-3-525" name="__codelineno-3-525"></a>    <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-3-526" name="__codelineno-3-526"></a>        <span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">EPOCHS</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-3-527" name="__codelineno-3-527"></a>        <span class="sa">f</span><span class="s2">"Train Loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-3-528" name="__codelineno-3-528"></a>        <span class="sa">f</span><span class="s2">"VOC Val: Loss </span><span class="si">{</span><span class="n">val_loss_str</span><span class="si">}</span><span class="s2">, PA </span><span class="si">{</span><span class="n">val_pa_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, mIoU </span><span class="si">{</span><span class="n">val_miou_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-3-529" name="__codelineno-3-529"></a>        <span class="sa">f</span><span class="s2">"Best VOC mIoU: </span><span class="si">{</span><span class="n">best_miou_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-3-530" name="__codelineno-3-530"></a>    <span class="p">)</span>
<a id="__codelineno-3-531" name="__codelineno-3-531"></a>
<a id="__codelineno-3-532" name="__codelineno-3-532"></a><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-3-533" name="__codelineno-3-533"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">训练完成！总耗时: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> 分钟"</span><span class="p">)</span>
<a id="__codelineno-3-534" name="__codelineno-3-534"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- 最终评估指标 (VOC2012 val) ---"</span><span class="p">)</span>
<a id="__codelineno-3-535" name="__codelineno-3-535"></a><span class="n">final_loss_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">EVAL_COMPUTE_LOSS</span> <span class="k">else</span> <span class="s2">"n/a"</span>
<a id="__codelineno-3-536" name="__codelineno-3-536"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Val Loss: </span><span class="si">{</span><span class="n">final_loss_str</span><span class="si">}</span><span class="s2"> | PA: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_pa'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | mIoU: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_miou'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-537" name="__codelineno-3-537"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"最优权重已保存至: </span><span class="si">{</span><span class="n">BEST_PATH_VOC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-538" name="__codelineno-3-538"></a>
<a id="__codelineno-3-539" name="__codelineno-3-539"></a><span class="c1"># 保存当前（latest）</span>
<a id="__codelineno-3-540" name="__codelineno-3-540"></a><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">LATEST_PATH</span><span class="p">)</span>
<a id="__codelineno-3-541" name="__codelineno-3-541"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"已保存当前模型权重到: </span><span class="si">{</span><span class="n">LATEST_PATH</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-3-542" name="__codelineno-3-542"></a>
<a id="__codelineno-3-543" name="__codelineno-3-543"></a><span class="c1"># 加载最优权重用于可视化</span>
<a id="__codelineno-3-544" name="__codelineno-3-544"></a><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">BEST_PATH_VOC</span><span class="p">):</span>
<a id="__codelineno-3-545" name="__codelineno-3-545"></a>    <span class="n">ckpt_voc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">BEST_PATH_VOC</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">))</span>
<a id="__codelineno-3-546" name="__codelineno-3-546"></a>    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">ckpt_voc</span><span class="p">[</span><span class="s1">'model_state'</span><span class="p">])</span>
<a id="__codelineno-3-547" name="__codelineno-3-547"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">已加载 VOC 最优权重进行可视化: </span><span class="si">{</span><span class="n">BEST_PATH_VOC</span><span class="si">}</span><span class="s2"> (epoch=</span><span class="si">{</span><span class="n">ckpt_voc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'epoch'</span><span class="p">,</span><span class="s1">'?'</span><span class="p">)</span><span class="si">}</span><span class="s2">, mIoU_VOC=</span><span class="si">{</span><span class="n">ckpt_voc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'miou_voc'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
<a id="__codelineno-3-548" name="__codelineno-3-548"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-549" name="__codelineno-3-549"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">未找到 VOC 最优权重，使用当前模型进行可视化。"</span><span class="p">)</span>
<a id="__codelineno-3-550" name="__codelineno-3-550"></a>
<a id="__codelineno-3-551" name="__codelineno-3-551"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- 可视化预测结果 (VOC2012 val) ---"</span><span class="p">)</span>
<a id="__codelineno-3-552" name="__codelineno-3-552"></a><span class="n">visualize_predictions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader_voc</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">VIS_DIR</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h4 id="_6">训练结果<a class="headerlink" href="#_6" title="Permanent link">¶</a></h4>
<p><img alt="alt text" src="../curves.png"/></p>
<p>在 Pascal VOC 07+12 上训练 50 个 Epoch，总用时 7796.3s，mIoU 达到 0.6277，像素准确率达到 0.9065，已经超过了原论文的指标。</p>
<p><img alt="res00" src="../result_000.png"/></p>
<p><img alt="res01" src="../result_001.png"/></p>
<p><img alt="res01" src="../result_004.png"/></p>
<h3 id="u-net">U-Net<a class="headerlink" href="#u-net" title="Permanent link">¶</a></h3>
<h4 id="_7">原理<a class="headerlink" href="#_7" title="Permanent link">¶</a></h4>
<p>我们实践刚刚在 FCN-8s 里面提到的更改，也就是把网络结构改对称，并且跳跃连接由相加再在通道维拼接，最后加数据增强即可。</p>
<p>其实从 FCN 到 U-Net，有点类似于从 ResNet 到 DenseNet。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">  1</a></span>
<span class="normal"><a href="#__codelineno-4-2">  2</a></span>
<span class="normal"><a href="#__codelineno-4-3">  3</a></span>
<span class="normal"><a href="#__codelineno-4-4">  4</a></span>
<span class="normal"><a href="#__codelineno-4-5">  5</a></span>
<span class="normal"><a href="#__codelineno-4-6">  6</a></span>
<span class="normal"><a href="#__codelineno-4-7">  7</a></span>
<span class="normal"><a href="#__codelineno-4-8">  8</a></span>
<span class="normal"><a href="#__codelineno-4-9">  9</a></span>
<span class="normal"><a href="#__codelineno-4-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-4-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-4-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-4-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-4-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-4-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-4-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-4-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-4-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-4-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-4-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-4-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-4-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-4-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-4-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-4-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-4-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-4-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-4-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-4-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-4-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-4-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-4-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-4-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-4-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-4-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-4-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-4-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-4-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-4-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-4-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-4-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-4-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-4-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-4-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-4-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-4-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-4-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-4-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-4-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-4-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-4-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-4-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-4-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-4-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-4-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-4-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-4-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-4-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-4-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-4-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-4-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-4-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-4-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-4-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-4-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-4-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-4-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-4-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-4-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-4-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-4-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-4-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-4-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-4-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-4-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-4-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-4-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-4-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-4-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-4-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-4-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-4-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-4-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-4-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-4-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-4-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-4-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-4-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-4-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-4-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-4-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-4-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-4-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-4-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-4-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-4-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-4-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-4-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-4-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-4-100">100</a></span>
<span class="normal"><a href="#__codelineno-4-101">101</a></span>
<span class="normal"><a href="#__codelineno-4-102">102</a></span>
<span class="normal"><a href="#__codelineno-4-103">103</a></span>
<span class="normal"><a href="#__codelineno-4-104">104</a></span>
<span class="normal"><a href="#__codelineno-4-105">105</a></span>
<span class="normal"><a href="#__codelineno-4-106">106</a></span>
<span class="normal"><a href="#__codelineno-4-107">107</a></span>
<span class="normal"><a href="#__codelineno-4-108">108</a></span>
<span class="normal"><a href="#__codelineno-4-109">109</a></span>
<span class="normal"><a href="#__codelineno-4-110">110</a></span>
<span class="normal"><a href="#__codelineno-4-111">111</a></span>
<span class="normal"><a href="#__codelineno-4-112">112</a></span>
<span class="normal"><a href="#__codelineno-4-113">113</a></span>
<span class="normal"><a href="#__codelineno-4-114">114</a></span>
<span class="normal"><a href="#__codelineno-4-115">115</a></span>
<span class="normal"><a href="#__codelineno-4-116">116</a></span>
<span class="normal"><a href="#__codelineno-4-117">117</a></span>
<span class="normal"><a href="#__codelineno-4-118">118</a></span>
<span class="normal"><a href="#__codelineno-4-119">119</a></span>
<span class="normal"><a href="#__codelineno-4-120">120</a></span>
<span class="normal"><a href="#__codelineno-4-121">121</a></span>
<span class="normal"><a href="#__codelineno-4-122">122</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1"># 基本的双卷积块，负责整合拼接之后的通道维。</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DoubleConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">),</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">),</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>        <span class="p">)</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">UNetVGG16</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>        <span class="c1"># 预训练 VGG16 编码器</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a>        <span class="n">vgg</span> <span class="o">=</span> <span class="n">vgg16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">VGG16_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span><span class="p">)</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">features</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a>        <span class="c1"># 这里保持 4 次下采样，方式在 FCN-8s 里面已经有介绍过。</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool1</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool2</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool3</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">23</span><span class="p">]</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool4</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a>        <span class="c1"># 这里不含 pool5，我们不想让网络的参数过大，因此只到 conv5 的特征图就够了。</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a>        <span class="c1"># 同时一个典型的 U-Net 有 4 个跳跃连接就足矣。</span>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a>        <span class="c1"># 但是相比于之前的 FCN-8s，实际上参数量小了很多。</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a>        <span class="c1"># 因为 FCN-8s 基本上用到了 VGG 的所有预训练权重。</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a>        <span class="c1"># 所以最后效果是以比 FCN-8s 少了五分之四的参数，换取了 9% 的 mIoU 降幅。</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a>        <span class="c1"># 上采样：在 U-Net 里面基本上已经舍弃了转置卷积，而是直接上采样再做卷积。</span>
<a id="__codelineno-4-43" name="__codelineno-4-43"></a>        <span class="c1"># 其实效果和转置卷积还差不多，但省参数和计算量。</span>
<a id="__codelineno-4-44" name="__codelineno-4-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-45" name="__codelineno-4-45"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-46" name="__codelineno-4-46"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-47" name="__codelineno-4-47"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<a id="__codelineno-4-48" name="__codelineno-4-48"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-49" name="__codelineno-4-49"></a>        <span class="p">)</span>
<a id="__codelineno-4-50" name="__codelineno-4-50"></a>        <span class="c1"># 解码器就是跳跃连接之后做双卷积。</span>
<a id="__codelineno-4-51" name="__codelineno-4-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec4</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">512</span> <span class="o">+</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<a id="__codelineno-4-52" name="__codelineno-4-52"></a>
<a id="__codelineno-4-53" name="__codelineno-4-53"></a>        <span class="c1"># 后面这些上采样+解码就依葫芦画瓢了，只需要更改通道数而已。</span>
<a id="__codelineno-4-54" name="__codelineno-4-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-55" name="__codelineno-4-55"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-56" name="__codelineno-4-56"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-57" name="__codelineno-4-57"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<a id="__codelineno-4-58" name="__codelineno-4-58"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-59" name="__codelineno-4-59"></a>        <span class="p">)</span>
<a id="__codelineno-4-60" name="__codelineno-4-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec3</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">256</span> <span class="o">+</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<a id="__codelineno-4-61" name="__codelineno-4-61"></a>
<a id="__codelineno-4-62" name="__codelineno-4-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-63" name="__codelineno-4-63"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-64" name="__codelineno-4-64"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-65" name="__codelineno-4-65"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<a id="__codelineno-4-66" name="__codelineno-4-66"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-67" name="__codelineno-4-67"></a>        <span class="p">)</span>
<a id="__codelineno-4-68" name="__codelineno-4-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">128</span> <span class="o">+</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<a id="__codelineno-4-69" name="__codelineno-4-69"></a>
<a id="__codelineno-4-70" name="__codelineno-4-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-4-71" name="__codelineno-4-71"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-72" name="__codelineno-4-72"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-4-73" name="__codelineno-4-73"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
<a id="__codelineno-4-74" name="__codelineno-4-74"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-4-75" name="__codelineno-4-75"></a>        <span class="p">)</span>
<a id="__codelineno-4-76" name="__codelineno-4-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">64</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<a id="__codelineno-4-77" name="__codelineno-4-77"></a>
<a id="__codelineno-4-78" name="__codelineno-4-78"></a>        <span class="c1"># 输出层</span>
<a id="__codelineno-4-79" name="__codelineno-4-79"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-4-80" name="__codelineno-4-80"></a>
<a id="__codelineno-4-81" name="__codelineno-4-81"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-4-82" name="__codelineno-4-82"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_align</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
<a id="__codelineno-4-83" name="__codelineno-4-83"></a>        <span class="c1"># 对齐尺寸，避免奇偶数导致的 1px 误差</span>
<a id="__codelineno-4-84" name="__codelineno-4-84"></a>        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
<a id="__codelineno-4-85" name="__codelineno-4-85"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-4-86" name="__codelineno-4-86"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-4-87" name="__codelineno-4-87"></a>
<a id="__codelineno-4-88" name="__codelineno-4-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-4-89" name="__codelineno-4-89"></a>        <span class="c1"># 编码器，C 表示通道数，后面的分数代表特征图相对原图的尺寸之比。</span>
<a id="__codelineno-4-90" name="__codelineno-4-90"></a>        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>           <span class="c1"># C=64,   1/1</span>
<a id="__codelineno-4-91" name="__codelineno-4-91"></a>        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool1</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>          <span class="c1">#         1/2</span>
<a id="__codelineno-4-92" name="__codelineno-4-92"></a>
<a id="__codelineno-4-93" name="__codelineno-4-93"></a>        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>          <span class="c1"># C=128,  1/2</span>
<a id="__codelineno-4-94" name="__codelineno-4-94"></a>        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool2</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>          <span class="c1">#         1/4</span>
<a id="__codelineno-4-95" name="__codelineno-4-95"></a>
<a id="__codelineno-4-96" name="__codelineno-4-96"></a>        <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>          <span class="c1"># C=256,  1/4</span>
<a id="__codelineno-4-97" name="__codelineno-4-97"></a>        <span class="n">p3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool3</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>          <span class="c1">#         1/8</span>
<a id="__codelineno-4-98" name="__codelineno-4-98"></a>
<a id="__codelineno-4-99" name="__codelineno-4-99"></a>        <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span>          <span class="c1"># C=512,  1/8</span>
<a id="__codelineno-4-100" name="__codelineno-4-100"></a>        <span class="n">p4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool4</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span>          <span class="c1">#        1/16</span>
<a id="__codelineno-4-101" name="__codelineno-4-101"></a>
<a id="__codelineno-4-102" name="__codelineno-4-102"></a>        <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span><span class="p">(</span><span class="n">p4</span><span class="p">)</span>          <span class="c1"># C=512, 1/16 (bottleneck)</span>
<a id="__codelineno-4-103" name="__codelineno-4-103"></a>
<a id="__codelineno-4-104" name="__codelineno-4-104"></a>        <span class="c1"># 解码器</span>
<a id="__codelineno-4-105" name="__codelineno-4-105"></a>        <span class="n">u4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up4</span><span class="p">(</span><span class="n">x5</span><span class="p">)</span>            <span class="c1"># -&gt; 1/8</span>
<a id="__codelineno-4-106" name="__codelineno-4-106"></a>        <span class="n">u4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u4</span><span class="p">,</span> <span class="n">x4</span><span class="p">)</span>
<a id="__codelineno-4-107" name="__codelineno-4-107"></a>        <span class="n">d4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec4</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u4</span><span class="p">,</span> <span class="n">x4</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=512</span>
<a id="__codelineno-4-108" name="__codelineno-4-108"></a>
<a id="__codelineno-4-109" name="__codelineno-4-109"></a>        <span class="n">u3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up3</span><span class="p">(</span><span class="n">d4</span><span class="p">)</span>            <span class="c1"># -&gt; 1/4</span>
<a id="__codelineno-4-110" name="__codelineno-4-110"></a>        <span class="n">u3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u3</span><span class="p">,</span> <span class="n">x3</span><span class="p">)</span>
<a id="__codelineno-4-111" name="__codelineno-4-111"></a>        <span class="n">d3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec3</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u3</span><span class="p">,</span> <span class="n">x3</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=256</span>
<a id="__codelineno-4-112" name="__codelineno-4-112"></a>
<a id="__codelineno-4-113" name="__codelineno-4-113"></a>        <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up2</span><span class="p">(</span><span class="n">d3</span><span class="p">)</span>            <span class="c1"># -&gt; 1/2</span>
<a id="__codelineno-4-114" name="__codelineno-4-114"></a>        <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<a id="__codelineno-4-115" name="__codelineno-4-115"></a>        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u2</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=128</span>
<a id="__codelineno-4-116" name="__codelineno-4-116"></a>
<a id="__codelineno-4-117" name="__codelineno-4-117"></a>        <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up1</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>            <span class="c1"># -&gt; 1/1</span>
<a id="__codelineno-4-118" name="__codelineno-4-118"></a>        <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
<a id="__codelineno-4-119" name="__codelineno-4-119"></a>        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">x1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=64</span>
<a id="__codelineno-4-120" name="__codelineno-4-120"></a>
<a id="__codelineno-4-121" name="__codelineno-4-121"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_conv</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>      <span class="c1"># -&gt; num_classes@HxW</span>
<a id="__codelineno-4-122" name="__codelineno-4-122"></a>        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
<h4 id="_8">训练代码<a class="headerlink" href="#_8" title="Permanent link">¶</a></h4>
<details>
<summary> U-Net 的训练代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">  1</a></span>
<span class="normal"><a href="#__codelineno-5-2">  2</a></span>
<span class="normal"><a href="#__codelineno-5-3">  3</a></span>
<span class="normal"><a href="#__codelineno-5-4">  4</a></span>
<span class="normal"><a href="#__codelineno-5-5">  5</a></span>
<span class="normal"><a href="#__codelineno-5-6">  6</a></span>
<span class="normal"><a href="#__codelineno-5-7">  7</a></span>
<span class="normal"><a href="#__codelineno-5-8">  8</a></span>
<span class="normal"><a href="#__codelineno-5-9">  9</a></span>
<span class="normal"><a href="#__codelineno-5-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-5-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-5-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-5-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-5-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-5-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-5-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-5-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-5-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-5-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-5-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-5-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-5-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-5-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-5-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-5-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-5-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-5-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-5-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-5-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-5-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-5-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-5-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-5-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-5-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-5-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-5-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-5-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-5-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-5-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-5-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-5-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-5-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-5-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-5-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-5-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-5-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-5-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-5-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-5-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-5-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-5-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-5-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-5-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-5-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-5-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-5-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-5-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-5-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-5-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-5-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-5-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-5-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-5-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-5-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-5-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-5-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-5-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-5-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-5-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-5-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-5-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-5-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-5-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-5-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-5-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-5-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-5-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-5-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-5-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-5-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-5-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-5-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-5-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-5-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-5-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-5-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-5-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-5-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-5-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-5-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-5-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-5-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-5-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-5-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-5-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-5-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-5-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-5-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-5-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-5-100">100</a></span>
<span class="normal"><a href="#__codelineno-5-101">101</a></span>
<span class="normal"><a href="#__codelineno-5-102">102</a></span>
<span class="normal"><a href="#__codelineno-5-103">103</a></span>
<span class="normal"><a href="#__codelineno-5-104">104</a></span>
<span class="normal"><a href="#__codelineno-5-105">105</a></span>
<span class="normal"><a href="#__codelineno-5-106">106</a></span>
<span class="normal"><a href="#__codelineno-5-107">107</a></span>
<span class="normal"><a href="#__codelineno-5-108">108</a></span>
<span class="normal"><a href="#__codelineno-5-109">109</a></span>
<span class="normal"><a href="#__codelineno-5-110">110</a></span>
<span class="normal"><a href="#__codelineno-5-111">111</a></span>
<span class="normal"><a href="#__codelineno-5-112">112</a></span>
<span class="normal"><a href="#__codelineno-5-113">113</a></span>
<span class="normal"><a href="#__codelineno-5-114">114</a></span>
<span class="normal"><a href="#__codelineno-5-115">115</a></span>
<span class="normal"><a href="#__codelineno-5-116">116</a></span>
<span class="normal"><a href="#__codelineno-5-117">117</a></span>
<span class="normal"><a href="#__codelineno-5-118">118</a></span>
<span class="normal"><a href="#__codelineno-5-119">119</a></span>
<span class="normal"><a href="#__codelineno-5-120">120</a></span>
<span class="normal"><a href="#__codelineno-5-121">121</a></span>
<span class="normal"><a href="#__codelineno-5-122">122</a></span>
<span class="normal"><a href="#__codelineno-5-123">123</a></span>
<span class="normal"><a href="#__codelineno-5-124">124</a></span>
<span class="normal"><a href="#__codelineno-5-125">125</a></span>
<span class="normal"><a href="#__codelineno-5-126">126</a></span>
<span class="normal"><a href="#__codelineno-5-127">127</a></span>
<span class="normal"><a href="#__codelineno-5-128">128</a></span>
<span class="normal"><a href="#__codelineno-5-129">129</a></span>
<span class="normal"><a href="#__codelineno-5-130">130</a></span>
<span class="normal"><a href="#__codelineno-5-131">131</a></span>
<span class="normal"><a href="#__codelineno-5-132">132</a></span>
<span class="normal"><a href="#__codelineno-5-133">133</a></span>
<span class="normal"><a href="#__codelineno-5-134">134</a></span>
<span class="normal"><a href="#__codelineno-5-135">135</a></span>
<span class="normal"><a href="#__codelineno-5-136">136</a></span>
<span class="normal"><a href="#__codelineno-5-137">137</a></span>
<span class="normal"><a href="#__codelineno-5-138">138</a></span>
<span class="normal"><a href="#__codelineno-5-139">139</a></span>
<span class="normal"><a href="#__codelineno-5-140">140</a></span>
<span class="normal"><a href="#__codelineno-5-141">141</a></span>
<span class="normal"><a href="#__codelineno-5-142">142</a></span>
<span class="normal"><a href="#__codelineno-5-143">143</a></span>
<span class="normal"><a href="#__codelineno-5-144">144</a></span>
<span class="normal"><a href="#__codelineno-5-145">145</a></span>
<span class="normal"><a href="#__codelineno-5-146">146</a></span>
<span class="normal"><a href="#__codelineno-5-147">147</a></span>
<span class="normal"><a href="#__codelineno-5-148">148</a></span>
<span class="normal"><a href="#__codelineno-5-149">149</a></span>
<span class="normal"><a href="#__codelineno-5-150">150</a></span>
<span class="normal"><a href="#__codelineno-5-151">151</a></span>
<span class="normal"><a href="#__codelineno-5-152">152</a></span>
<span class="normal"><a href="#__codelineno-5-153">153</a></span>
<span class="normal"><a href="#__codelineno-5-154">154</a></span>
<span class="normal"><a href="#__codelineno-5-155">155</a></span>
<span class="normal"><a href="#__codelineno-5-156">156</a></span>
<span class="normal"><a href="#__codelineno-5-157">157</a></span>
<span class="normal"><a href="#__codelineno-5-158">158</a></span>
<span class="normal"><a href="#__codelineno-5-159">159</a></span>
<span class="normal"><a href="#__codelineno-5-160">160</a></span>
<span class="normal"><a href="#__codelineno-5-161">161</a></span>
<span class="normal"><a href="#__codelineno-5-162">162</a></span>
<span class="normal"><a href="#__codelineno-5-163">163</a></span>
<span class="normal"><a href="#__codelineno-5-164">164</a></span>
<span class="normal"><a href="#__codelineno-5-165">165</a></span>
<span class="normal"><a href="#__codelineno-5-166">166</a></span>
<span class="normal"><a href="#__codelineno-5-167">167</a></span>
<span class="normal"><a href="#__codelineno-5-168">168</a></span>
<span class="normal"><a href="#__codelineno-5-169">169</a></span>
<span class="normal"><a href="#__codelineno-5-170">170</a></span>
<span class="normal"><a href="#__codelineno-5-171">171</a></span>
<span class="normal"><a href="#__codelineno-5-172">172</a></span>
<span class="normal"><a href="#__codelineno-5-173">173</a></span>
<span class="normal"><a href="#__codelineno-5-174">174</a></span>
<span class="normal"><a href="#__codelineno-5-175">175</a></span>
<span class="normal"><a href="#__codelineno-5-176">176</a></span>
<span class="normal"><a href="#__codelineno-5-177">177</a></span>
<span class="normal"><a href="#__codelineno-5-178">178</a></span>
<span class="normal"><a href="#__codelineno-5-179">179</a></span>
<span class="normal"><a href="#__codelineno-5-180">180</a></span>
<span class="normal"><a href="#__codelineno-5-181">181</a></span>
<span class="normal"><a href="#__codelineno-5-182">182</a></span>
<span class="normal"><a href="#__codelineno-5-183">183</a></span>
<span class="normal"><a href="#__codelineno-5-184">184</a></span>
<span class="normal"><a href="#__codelineno-5-185">185</a></span>
<span class="normal"><a href="#__codelineno-5-186">186</a></span>
<span class="normal"><a href="#__codelineno-5-187">187</a></span>
<span class="normal"><a href="#__codelineno-5-188">188</a></span>
<span class="normal"><a href="#__codelineno-5-189">189</a></span>
<span class="normal"><a href="#__codelineno-5-190">190</a></span>
<span class="normal"><a href="#__codelineno-5-191">191</a></span>
<span class="normal"><a href="#__codelineno-5-192">192</a></span>
<span class="normal"><a href="#__codelineno-5-193">193</a></span>
<span class="normal"><a href="#__codelineno-5-194">194</a></span>
<span class="normal"><a href="#__codelineno-5-195">195</a></span>
<span class="normal"><a href="#__codelineno-5-196">196</a></span>
<span class="normal"><a href="#__codelineno-5-197">197</a></span>
<span class="normal"><a href="#__codelineno-5-198">198</a></span>
<span class="normal"><a href="#__codelineno-5-199">199</a></span>
<span class="normal"><a href="#__codelineno-5-200">200</a></span>
<span class="normal"><a href="#__codelineno-5-201">201</a></span>
<span class="normal"><a href="#__codelineno-5-202">202</a></span>
<span class="normal"><a href="#__codelineno-5-203">203</a></span>
<span class="normal"><a href="#__codelineno-5-204">204</a></span>
<span class="normal"><a href="#__codelineno-5-205">205</a></span>
<span class="normal"><a href="#__codelineno-5-206">206</a></span>
<span class="normal"><a href="#__codelineno-5-207">207</a></span>
<span class="normal"><a href="#__codelineno-5-208">208</a></span>
<span class="normal"><a href="#__codelineno-5-209">209</a></span>
<span class="normal"><a href="#__codelineno-5-210">210</a></span>
<span class="normal"><a href="#__codelineno-5-211">211</a></span>
<span class="normal"><a href="#__codelineno-5-212">212</a></span>
<span class="normal"><a href="#__codelineno-5-213">213</a></span>
<span class="normal"><a href="#__codelineno-5-214">214</a></span>
<span class="normal"><a href="#__codelineno-5-215">215</a></span>
<span class="normal"><a href="#__codelineno-5-216">216</a></span>
<span class="normal"><a href="#__codelineno-5-217">217</a></span>
<span class="normal"><a href="#__codelineno-5-218">218</a></span>
<span class="normal"><a href="#__codelineno-5-219">219</a></span>
<span class="normal"><a href="#__codelineno-5-220">220</a></span>
<span class="normal"><a href="#__codelineno-5-221">221</a></span>
<span class="normal"><a href="#__codelineno-5-222">222</a></span>
<span class="normal"><a href="#__codelineno-5-223">223</a></span>
<span class="normal"><a href="#__codelineno-5-224">224</a></span>
<span class="normal"><a href="#__codelineno-5-225">225</a></span>
<span class="normal"><a href="#__codelineno-5-226">226</a></span>
<span class="normal"><a href="#__codelineno-5-227">227</a></span>
<span class="normal"><a href="#__codelineno-5-228">228</a></span>
<span class="normal"><a href="#__codelineno-5-229">229</a></span>
<span class="normal"><a href="#__codelineno-5-230">230</a></span>
<span class="normal"><a href="#__codelineno-5-231">231</a></span>
<span class="normal"><a href="#__codelineno-5-232">232</a></span>
<span class="normal"><a href="#__codelineno-5-233">233</a></span>
<span class="normal"><a href="#__codelineno-5-234">234</a></span>
<span class="normal"><a href="#__codelineno-5-235">235</a></span>
<span class="normal"><a href="#__codelineno-5-236">236</a></span>
<span class="normal"><a href="#__codelineno-5-237">237</a></span>
<span class="normal"><a href="#__codelineno-5-238">238</a></span>
<span class="normal"><a href="#__codelineno-5-239">239</a></span>
<span class="normal"><a href="#__codelineno-5-240">240</a></span>
<span class="normal"><a href="#__codelineno-5-241">241</a></span>
<span class="normal"><a href="#__codelineno-5-242">242</a></span>
<span class="normal"><a href="#__codelineno-5-243">243</a></span>
<span class="normal"><a href="#__codelineno-5-244">244</a></span>
<span class="normal"><a href="#__codelineno-5-245">245</a></span>
<span class="normal"><a href="#__codelineno-5-246">246</a></span>
<span class="normal"><a href="#__codelineno-5-247">247</a></span>
<span class="normal"><a href="#__codelineno-5-248">248</a></span>
<span class="normal"><a href="#__codelineno-5-249">249</a></span>
<span class="normal"><a href="#__codelineno-5-250">250</a></span>
<span class="normal"><a href="#__codelineno-5-251">251</a></span>
<span class="normal"><a href="#__codelineno-5-252">252</a></span>
<span class="normal"><a href="#__codelineno-5-253">253</a></span>
<span class="normal"><a href="#__codelineno-5-254">254</a></span>
<span class="normal"><a href="#__codelineno-5-255">255</a></span>
<span class="normal"><a href="#__codelineno-5-256">256</a></span>
<span class="normal"><a href="#__codelineno-5-257">257</a></span>
<span class="normal"><a href="#__codelineno-5-258">258</a></span>
<span class="normal"><a href="#__codelineno-5-259">259</a></span>
<span class="normal"><a href="#__codelineno-5-260">260</a></span>
<span class="normal"><a href="#__codelineno-5-261">261</a></span>
<span class="normal"><a href="#__codelineno-5-262">262</a></span>
<span class="normal"><a href="#__codelineno-5-263">263</a></span>
<span class="normal"><a href="#__codelineno-5-264">264</a></span>
<span class="normal"><a href="#__codelineno-5-265">265</a></span>
<span class="normal"><a href="#__codelineno-5-266">266</a></span>
<span class="normal"><a href="#__codelineno-5-267">267</a></span>
<span class="normal"><a href="#__codelineno-5-268">268</a></span>
<span class="normal"><a href="#__codelineno-5-269">269</a></span>
<span class="normal"><a href="#__codelineno-5-270">270</a></span>
<span class="normal"><a href="#__codelineno-5-271">271</a></span>
<span class="normal"><a href="#__codelineno-5-272">272</a></span>
<span class="normal"><a href="#__codelineno-5-273">273</a></span>
<span class="normal"><a href="#__codelineno-5-274">274</a></span>
<span class="normal"><a href="#__codelineno-5-275">275</a></span>
<span class="normal"><a href="#__codelineno-5-276">276</a></span>
<span class="normal"><a href="#__codelineno-5-277">277</a></span>
<span class="normal"><a href="#__codelineno-5-278">278</a></span>
<span class="normal"><a href="#__codelineno-5-279">279</a></span>
<span class="normal"><a href="#__codelineno-5-280">280</a></span>
<span class="normal"><a href="#__codelineno-5-281">281</a></span>
<span class="normal"><a href="#__codelineno-5-282">282</a></span>
<span class="normal"><a href="#__codelineno-5-283">283</a></span>
<span class="normal"><a href="#__codelineno-5-284">284</a></span>
<span class="normal"><a href="#__codelineno-5-285">285</a></span>
<span class="normal"><a href="#__codelineno-5-286">286</a></span>
<span class="normal"><a href="#__codelineno-5-287">287</a></span>
<span class="normal"><a href="#__codelineno-5-288">288</a></span>
<span class="normal"><a href="#__codelineno-5-289">289</a></span>
<span class="normal"><a href="#__codelineno-5-290">290</a></span>
<span class="normal"><a href="#__codelineno-5-291">291</a></span>
<span class="normal"><a href="#__codelineno-5-292">292</a></span>
<span class="normal"><a href="#__codelineno-5-293">293</a></span>
<span class="normal"><a href="#__codelineno-5-294">294</a></span>
<span class="normal"><a href="#__codelineno-5-295">295</a></span>
<span class="normal"><a href="#__codelineno-5-296">296</a></span>
<span class="normal"><a href="#__codelineno-5-297">297</a></span>
<span class="normal"><a href="#__codelineno-5-298">298</a></span>
<span class="normal"><a href="#__codelineno-5-299">299</a></span>
<span class="normal"><a href="#__codelineno-5-300">300</a></span>
<span class="normal"><a href="#__codelineno-5-301">301</a></span>
<span class="normal"><a href="#__codelineno-5-302">302</a></span>
<span class="normal"><a href="#__codelineno-5-303">303</a></span>
<span class="normal"><a href="#__codelineno-5-304">304</a></span>
<span class="normal"><a href="#__codelineno-5-305">305</a></span>
<span class="normal"><a href="#__codelineno-5-306">306</a></span>
<span class="normal"><a href="#__codelineno-5-307">307</a></span>
<span class="normal"><a href="#__codelineno-5-308">308</a></span>
<span class="normal"><a href="#__codelineno-5-309">309</a></span>
<span class="normal"><a href="#__codelineno-5-310">310</a></span>
<span class="normal"><a href="#__codelineno-5-311">311</a></span>
<span class="normal"><a href="#__codelineno-5-312">312</a></span>
<span class="normal"><a href="#__codelineno-5-313">313</a></span>
<span class="normal"><a href="#__codelineno-5-314">314</a></span>
<span class="normal"><a href="#__codelineno-5-315">315</a></span>
<span class="normal"><a href="#__codelineno-5-316">316</a></span>
<span class="normal"><a href="#__codelineno-5-317">317</a></span>
<span class="normal"><a href="#__codelineno-5-318">318</a></span>
<span class="normal"><a href="#__codelineno-5-319">319</a></span>
<span class="normal"><a href="#__codelineno-5-320">320</a></span>
<span class="normal"><a href="#__codelineno-5-321">321</a></span>
<span class="normal"><a href="#__codelineno-5-322">322</a></span>
<span class="normal"><a href="#__codelineno-5-323">323</a></span>
<span class="normal"><a href="#__codelineno-5-324">324</a></span>
<span class="normal"><a href="#__codelineno-5-325">325</a></span>
<span class="normal"><a href="#__codelineno-5-326">326</a></span>
<span class="normal"><a href="#__codelineno-5-327">327</a></span>
<span class="normal"><a href="#__codelineno-5-328">328</a></span>
<span class="normal"><a href="#__codelineno-5-329">329</a></span>
<span class="normal"><a href="#__codelineno-5-330">330</a></span>
<span class="normal"><a href="#__codelineno-5-331">331</a></span>
<span class="normal"><a href="#__codelineno-5-332">332</a></span>
<span class="normal"><a href="#__codelineno-5-333">333</a></span>
<span class="normal"><a href="#__codelineno-5-334">334</a></span>
<span class="normal"><a href="#__codelineno-5-335">335</a></span>
<span class="normal"><a href="#__codelineno-5-336">336</a></span>
<span class="normal"><a href="#__codelineno-5-337">337</a></span>
<span class="normal"><a href="#__codelineno-5-338">338</a></span>
<span class="normal"><a href="#__codelineno-5-339">339</a></span>
<span class="normal"><a href="#__codelineno-5-340">340</a></span>
<span class="normal"><a href="#__codelineno-5-341">341</a></span>
<span class="normal"><a href="#__codelineno-5-342">342</a></span>
<span class="normal"><a href="#__codelineno-5-343">343</a></span>
<span class="normal"><a href="#__codelineno-5-344">344</a></span>
<span class="normal"><a href="#__codelineno-5-345">345</a></span>
<span class="normal"><a href="#__codelineno-5-346">346</a></span>
<span class="normal"><a href="#__codelineno-5-347">347</a></span>
<span class="normal"><a href="#__codelineno-5-348">348</a></span>
<span class="normal"><a href="#__codelineno-5-349">349</a></span>
<span class="normal"><a href="#__codelineno-5-350">350</a></span>
<span class="normal"><a href="#__codelineno-5-351">351</a></span>
<span class="normal"><a href="#__codelineno-5-352">352</a></span>
<span class="normal"><a href="#__codelineno-5-353">353</a></span>
<span class="normal"><a href="#__codelineno-5-354">354</a></span>
<span class="normal"><a href="#__codelineno-5-355">355</a></span>
<span class="normal"><a href="#__codelineno-5-356">356</a></span>
<span class="normal"><a href="#__codelineno-5-357">357</a></span>
<span class="normal"><a href="#__codelineno-5-358">358</a></span>
<span class="normal"><a href="#__codelineno-5-359">359</a></span>
<span class="normal"><a href="#__codelineno-5-360">360</a></span>
<span class="normal"><a href="#__codelineno-5-361">361</a></span>
<span class="normal"><a href="#__codelineno-5-362">362</a></span>
<span class="normal"><a href="#__codelineno-5-363">363</a></span>
<span class="normal"><a href="#__codelineno-5-364">364</a></span>
<span class="normal"><a href="#__codelineno-5-365">365</a></span>
<span class="normal"><a href="#__codelineno-5-366">366</a></span>
<span class="normal"><a href="#__codelineno-5-367">367</a></span>
<span class="normal"><a href="#__codelineno-5-368">368</a></span>
<span class="normal"><a href="#__codelineno-5-369">369</a></span>
<span class="normal"><a href="#__codelineno-5-370">370</a></span>
<span class="normal"><a href="#__codelineno-5-371">371</a></span>
<span class="normal"><a href="#__codelineno-5-372">372</a></span>
<span class="normal"><a href="#__codelineno-5-373">373</a></span>
<span class="normal"><a href="#__codelineno-5-374">374</a></span>
<span class="normal"><a href="#__codelineno-5-375">375</a></span>
<span class="normal"><a href="#__codelineno-5-376">376</a></span>
<span class="normal"><a href="#__codelineno-5-377">377</a></span>
<span class="normal"><a href="#__codelineno-5-378">378</a></span>
<span class="normal"><a href="#__codelineno-5-379">379</a></span>
<span class="normal"><a href="#__codelineno-5-380">380</a></span>
<span class="normal"><a href="#__codelineno-5-381">381</a></span>
<span class="normal"><a href="#__codelineno-5-382">382</a></span>
<span class="normal"><a href="#__codelineno-5-383">383</a></span>
<span class="normal"><a href="#__codelineno-5-384">384</a></span>
<span class="normal"><a href="#__codelineno-5-385">385</a></span>
<span class="normal"><a href="#__codelineno-5-386">386</a></span>
<span class="normal"><a href="#__codelineno-5-387">387</a></span>
<span class="normal"><a href="#__codelineno-5-388">388</a></span>
<span class="normal"><a href="#__codelineno-5-389">389</a></span>
<span class="normal"><a href="#__codelineno-5-390">390</a></span>
<span class="normal"><a href="#__codelineno-5-391">391</a></span>
<span class="normal"><a href="#__codelineno-5-392">392</a></span>
<span class="normal"><a href="#__codelineno-5-393">393</a></span>
<span class="normal"><a href="#__codelineno-5-394">394</a></span>
<span class="normal"><a href="#__codelineno-5-395">395</a></span>
<span class="normal"><a href="#__codelineno-5-396">396</a></span>
<span class="normal"><a href="#__codelineno-5-397">397</a></span>
<span class="normal"><a href="#__codelineno-5-398">398</a></span>
<span class="normal"><a href="#__codelineno-5-399">399</a></span>
<span class="normal"><a href="#__codelineno-5-400">400</a></span>
<span class="normal"><a href="#__codelineno-5-401">401</a></span>
<span class="normal"><a href="#__codelineno-5-402">402</a></span>
<span class="normal"><a href="#__codelineno-5-403">403</a></span>
<span class="normal"><a href="#__codelineno-5-404">404</a></span>
<span class="normal"><a href="#__codelineno-5-405">405</a></span>
<span class="normal"><a href="#__codelineno-5-406">406</a></span>
<span class="normal"><a href="#__codelineno-5-407">407</a></span>
<span class="normal"><a href="#__codelineno-5-408">408</a></span>
<span class="normal"><a href="#__codelineno-5-409">409</a></span>
<span class="normal"><a href="#__codelineno-5-410">410</a></span>
<span class="normal"><a href="#__codelineno-5-411">411</a></span>
<span class="normal"><a href="#__codelineno-5-412">412</a></span>
<span class="normal"><a href="#__codelineno-5-413">413</a></span>
<span class="normal"><a href="#__codelineno-5-414">414</a></span>
<span class="normal"><a href="#__codelineno-5-415">415</a></span>
<span class="normal"><a href="#__codelineno-5-416">416</a></span>
<span class="normal"><a href="#__codelineno-5-417">417</a></span>
<span class="normal"><a href="#__codelineno-5-418">418</a></span>
<span class="normal"><a href="#__codelineno-5-419">419</a></span>
<span class="normal"><a href="#__codelineno-5-420">420</a></span>
<span class="normal"><a href="#__codelineno-5-421">421</a></span>
<span class="normal"><a href="#__codelineno-5-422">422</a></span>
<span class="normal"><a href="#__codelineno-5-423">423</a></span>
<span class="normal"><a href="#__codelineno-5-424">424</a></span>
<span class="normal"><a href="#__codelineno-5-425">425</a></span>
<span class="normal"><a href="#__codelineno-5-426">426</a></span>
<span class="normal"><a href="#__codelineno-5-427">427</a></span>
<span class="normal"><a href="#__codelineno-5-428">428</a></span>
<span class="normal"><a href="#__codelineno-5-429">429</a></span>
<span class="normal"><a href="#__codelineno-5-430">430</a></span>
<span class="normal"><a href="#__codelineno-5-431">431</a></span>
<span class="normal"><a href="#__codelineno-5-432">432</a></span>
<span class="normal"><a href="#__codelineno-5-433">433</a></span>
<span class="normal"><a href="#__codelineno-5-434">434</a></span>
<span class="normal"><a href="#__codelineno-5-435">435</a></span>
<span class="normal"><a href="#__codelineno-5-436">436</a></span>
<span class="normal"><a href="#__codelineno-5-437">437</a></span>
<span class="normal"><a href="#__codelineno-5-438">438</a></span>
<span class="normal"><a href="#__codelineno-5-439">439</a></span>
<span class="normal"><a href="#__codelineno-5-440">440</a></span>
<span class="normal"><a href="#__codelineno-5-441">441</a></span>
<span class="normal"><a href="#__codelineno-5-442">442</a></span>
<span class="normal"><a href="#__codelineno-5-443">443</a></span>
<span class="normal"><a href="#__codelineno-5-444">444</a></span>
<span class="normal"><a href="#__codelineno-5-445">445</a></span>
<span class="normal"><a href="#__codelineno-5-446">446</a></span>
<span class="normal"><a href="#__codelineno-5-447">447</a></span>
<span class="normal"><a href="#__codelineno-5-448">448</a></span>
<span class="normal"><a href="#__codelineno-5-449">449</a></span>
<span class="normal"><a href="#__codelineno-5-450">450</a></span>
<span class="normal"><a href="#__codelineno-5-451">451</a></span>
<span class="normal"><a href="#__codelineno-5-452">452</a></span>
<span class="normal"><a href="#__codelineno-5-453">453</a></span>
<span class="normal"><a href="#__codelineno-5-454">454</a></span>
<span class="normal"><a href="#__codelineno-5-455">455</a></span>
<span class="normal"><a href="#__codelineno-5-456">456</a></span>
<span class="normal"><a href="#__codelineno-5-457">457</a></span>
<span class="normal"><a href="#__codelineno-5-458">458</a></span>
<span class="normal"><a href="#__codelineno-5-459">459</a></span>
<span class="normal"><a href="#__codelineno-5-460">460</a></span>
<span class="normal"><a href="#__codelineno-5-461">461</a></span>
<span class="normal"><a href="#__codelineno-5-462">462</a></span>
<span class="normal"><a href="#__codelineno-5-463">463</a></span>
<span class="normal"><a href="#__codelineno-5-464">464</a></span>
<span class="normal"><a href="#__codelineno-5-465">465</a></span>
<span class="normal"><a href="#__codelineno-5-466">466</a></span>
<span class="normal"><a href="#__codelineno-5-467">467</a></span>
<span class="normal"><a href="#__codelineno-5-468">468</a></span>
<span class="normal"><a href="#__codelineno-5-469">469</a></span>
<span class="normal"><a href="#__codelineno-5-470">470</a></span>
<span class="normal"><a href="#__codelineno-5-471">471</a></span>
<span class="normal"><a href="#__codelineno-5-472">472</a></span>
<span class="normal"><a href="#__codelineno-5-473">473</a></span>
<span class="normal"><a href="#__codelineno-5-474">474</a></span>
<span class="normal"><a href="#__codelineno-5-475">475</a></span>
<span class="normal"><a href="#__codelineno-5-476">476</a></span>
<span class="normal"><a href="#__codelineno-5-477">477</a></span>
<span class="normal"><a href="#__codelineno-5-478">478</a></span>
<span class="normal"><a href="#__codelineno-5-479">479</a></span>
<span class="normal"><a href="#__codelineno-5-480">480</a></span>
<span class="normal"><a href="#__codelineno-5-481">481</a></span>
<span class="normal"><a href="#__codelineno-5-482">482</a></span>
<span class="normal"><a href="#__codelineno-5-483">483</a></span>
<span class="normal"><a href="#__codelineno-5-484">484</a></span>
<span class="normal"><a href="#__codelineno-5-485">485</a></span>
<span class="normal"><a href="#__codelineno-5-486">486</a></span>
<span class="normal"><a href="#__codelineno-5-487">487</a></span>
<span class="normal"><a href="#__codelineno-5-488">488</a></span>
<span class="normal"><a href="#__codelineno-5-489">489</a></span>
<span class="normal"><a href="#__codelineno-5-490">490</a></span>
<span class="normal"><a href="#__codelineno-5-491">491</a></span>
<span class="normal"><a href="#__codelineno-5-492">492</a></span>
<span class="normal"><a href="#__codelineno-5-493">493</a></span>
<span class="normal"><a href="#__codelineno-5-494">494</a></span>
<span class="normal"><a href="#__codelineno-5-495">495</a></span>
<span class="normal"><a href="#__codelineno-5-496">496</a></span>
<span class="normal"><a href="#__codelineno-5-497">497</a></span>
<span class="normal"><a href="#__codelineno-5-498">498</a></span>
<span class="normal"><a href="#__codelineno-5-499">499</a></span>
<span class="normal"><a href="#__codelineno-5-500">500</a></span>
<span class="normal"><a href="#__codelineno-5-501">501</a></span>
<span class="normal"><a href="#__codelineno-5-502">502</a></span>
<span class="normal"><a href="#__codelineno-5-503">503</a></span>
<span class="normal"><a href="#__codelineno-5-504">504</a></span>
<span class="normal"><a href="#__codelineno-5-505">505</a></span>
<span class="normal"><a href="#__codelineno-5-506">506</a></span>
<span class="normal"><a href="#__codelineno-5-507">507</a></span>
<span class="normal"><a href="#__codelineno-5-508">508</a></span>
<span class="normal"><a href="#__codelineno-5-509">509</a></span>
<span class="normal"><a href="#__codelineno-5-510">510</a></span>
<span class="normal"><a href="#__codelineno-5-511">511</a></span>
<span class="normal"><a href="#__codelineno-5-512">512</a></span>
<span class="normal"><a href="#__codelineno-5-513">513</a></span>
<span class="normal"><a href="#__codelineno-5-514">514</a></span>
<span class="normal"><a href="#__codelineno-5-515">515</a></span>
<span class="normal"><a href="#__codelineno-5-516">516</a></span>
<span class="normal"><a href="#__codelineno-5-517">517</a></span>
<span class="normal"><a href="#__codelineno-5-518">518</a></span>
<span class="normal"><a href="#__codelineno-5-519">519</a></span>
<span class="normal"><a href="#__codelineno-5-520">520</a></span>
<span class="normal"><a href="#__codelineno-5-521">521</a></span>
<span class="normal"><a href="#__codelineno-5-522">522</a></span>
<span class="normal"><a href="#__codelineno-5-523">523</a></span>
<span class="normal"><a href="#__codelineno-5-524">524</a></span>
<span class="normal"><a href="#__codelineno-5-525">525</a></span>
<span class="normal"><a href="#__codelineno-5-526">526</a></span>
<span class="normal"><a href="#__codelineno-5-527">527</a></span>
<span class="normal"><a href="#__codelineno-5-528">528</a></span>
<span class="normal"><a href="#__codelineno-5-529">529</a></span>
<span class="normal"><a href="#__codelineno-5-530">530</a></span>
<span class="normal"><a href="#__codelineno-5-531">531</a></span>
<span class="normal"><a href="#__codelineno-5-532">532</a></span>
<span class="normal"><a href="#__codelineno-5-533">533</a></span>
<span class="normal"><a href="#__codelineno-5-534">534</a></span>
<span class="normal"><a href="#__codelineno-5-535">535</a></span>
<span class="normal"><a href="#__codelineno-5-536">536</a></span>
<span class="normal"><a href="#__codelineno-5-537">537</a></span>
<span class="normal"><a href="#__codelineno-5-538">538</a></span>
<span class="normal"><a href="#__codelineno-5-539">539</a></span>
<span class="normal"><a href="#__codelineno-5-540">540</a></span>
<span class="normal"><a href="#__codelineno-5-541">541</a></span>
<span class="normal"><a href="#__codelineno-5-542">542</a></span>
<span class="normal"><a href="#__codelineno-5-543">543</a></span>
<span class="normal"><a href="#__codelineno-5-544">544</a></span>
<span class="normal"><a href="#__codelineno-5-545">545</a></span>
<span class="normal"><a href="#__codelineno-5-546">546</a></span>
<span class="normal"><a href="#__codelineno-5-547">547</a></span>
<span class="normal"><a href="#__codelineno-5-548">548</a></span>
<span class="normal"><a href="#__codelineno-5-549">549</a></span>
<span class="normal"><a href="#__codelineno-5-550">550</a></span>
<span class="normal"><a href="#__codelineno-5-551">551</a></span>
<span class="normal"><a href="#__codelineno-5-552">552</a></span>
<span class="normal"><a href="#__codelineno-5-553">553</a></span>
<span class="normal"><a href="#__codelineno-5-554">554</a></span>
<span class="normal"><a href="#__codelineno-5-555">555</a></span>
<span class="normal"><a href="#__codelineno-5-556">556</a></span>
<span class="normal"><a href="#__codelineno-5-557">557</a></span>
<span class="normal"><a href="#__codelineno-5-558">558</a></span>
<span class="normal"><a href="#__codelineno-5-559">559</a></span>
<span class="normal"><a href="#__codelineno-5-560">560</a></span>
<span class="normal"><a href="#__codelineno-5-561">561</a></span>
<span class="normal"><a href="#__codelineno-5-562">562</a></span>
<span class="normal"><a href="#__codelineno-5-563">563</a></span>
<span class="normal"><a href="#__codelineno-5-564">564</a></span>
<span class="normal"><a href="#__codelineno-5-565">565</a></span>
<span class="normal"><a href="#__codelineno-5-566">566</a></span>
<span class="normal"><a href="#__codelineno-5-567">567</a></span>
<span class="normal"><a href="#__codelineno-5-568">568</a></span>
<span class="normal"><a href="#__codelineno-5-569">569</a></span>
<span class="normal"><a href="#__codelineno-5-570">570</a></span>
<span class="normal"><a href="#__codelineno-5-571">571</a></span>
<span class="normal"><a href="#__codelineno-5-572">572</a></span>
<span class="normal"><a href="#__codelineno-5-573">573</a></span>
<span class="normal"><a href="#__codelineno-5-574">574</a></span>
<span class="normal"><a href="#__codelineno-5-575">575</a></span>
<span class="normal"><a href="#__codelineno-5-576">576</a></span>
<span class="normal"><a href="#__codelineno-5-577">577</a></span>
<span class="normal"><a href="#__codelineno-5-578">578</a></span>
<span class="normal"><a href="#__codelineno-5-579">579</a></span>
<span class="normal"><a href="#__codelineno-5-580">580</a></span>
<span class="normal"><a href="#__codelineno-5-581">581</a></span>
<span class="normal"><a href="#__codelineno-5-582">582</a></span>
<span class="normal"><a href="#__codelineno-5-583">583</a></span>
<span class="normal"><a href="#__codelineno-5-584">584</a></span>
<span class="normal"><a href="#__codelineno-5-585">585</a></span>
<span class="normal"><a href="#__codelineno-5-586">586</a></span>
<span class="normal"><a href="#__codelineno-5-587">587</a></span>
<span class="normal"><a href="#__codelineno-5-588">588</a></span>
<span class="normal"><a href="#__codelineno-5-589">589</a></span>
<span class="normal"><a href="#__codelineno-5-590">590</a></span>
<span class="normal"><a href="#__codelineno-5-591">591</a></span>
<span class="normal"><a href="#__codelineno-5-592">592</a></span>
<span class="normal"><a href="#__codelineno-5-593">593</a></span>
<span class="normal"><a href="#__codelineno-5-594">594</a></span>
<span class="normal"><a href="#__codelineno-5-595">595</a></span>
<span class="normal"><a href="#__codelineno-5-596">596</a></span>
<span class="normal"><a href="#__codelineno-5-597">597</a></span>
<span class="normal"><a href="#__codelineno-5-598">598</a></span>
<span class="normal"><a href="#__codelineno-5-599">599</a></span>
<span class="normal"><a href="#__codelineno-5-600">600</a></span>
<span class="normal"><a href="#__codelineno-5-601">601</a></span>
<span class="normal"><a href="#__codelineno-5-602">602</a></span>
<span class="normal"><a href="#__codelineno-5-603">603</a></span>
<span class="normal"><a href="#__codelineno-5-604">604</a></span>
<span class="normal"><a href="#__codelineno-5-605">605</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">ConcatDataset</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">T</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">vgg16</span><span class="p">,</span> <span class="n">VGG16_Weights</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">it</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="c1"># -------------------- 配置 --------------------</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="n">USE_AMP</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 固定用 CUDA AMP</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="c1"># Kaggle 常见路径（可按需修改）</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="n">VOC2007_ROOT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2007/VOCtrainval_06-Nov-2007/VOCdevkit/VOC2007"</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="n">VOC2007_ROOT_ALT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2007/VOCdevkit/VOC2007"</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT_ALT</span><span class="p">):</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a>    <span class="n">VOC2007_ROOT</span> <span class="o">=</span> <span class="n">VOC2007_ROOT_ALT</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="n">VOC2012_ROOT</span> <span class="o">=</span> <span class="s2">"/kaggle/input/pascal-voc-2012/VOC2012"</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="mi">21</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="n">VAL_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 你要手调就改这里（&gt;1 时需自己加 padding collate）</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="n">NUM_WORKERS</span> <span class="o">=</span> <span class="mi">6</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">7.5e-5</span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="n">WEIGHT_DECAY</span> <span class="o">=</span> <span class="mf">1e-4</span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">80</span>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a><span class="c1"># 评估加速开关</span>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a><span class="n">EVAL_COMPUTE_LOSS</span> <span class="o">=</span> <span class="kc">False</span>     <span class="c1"># True 会计算 val loss，稍慢</span>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="n">EVAL_MAX_BATCHES</span> <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># 限制评估批次数；None 表示全量</span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="n">EVAL_MAX_IMAGES</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># 限制评估图片数；None 表示全量</span>
<a id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="n">EVAL_PROGRESS</span> <span class="o">=</span> <span class="kc">True</span>          <span class="c1"># 保留 tqdm 进度条</span>
<a id="__codelineno-5-41" name="__codelineno-5-41"></a>
<a id="__codelineno-5-42" name="__codelineno-5-42"></a><span class="n">SAVE_DIR</span> <span class="o">=</span> <span class="s2">"/kaggle/working"</span>
<a id="__codelineno-5-43" name="__codelineno-5-43"></a><span class="n">BEST_PATH_VOC</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"fcn8s_best_voc2012val.pth"</span><span class="p">)</span>
<a id="__codelineno-5-44" name="__codelineno-5-44"></a><span class="n">LATEST_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"fcn8s_latest.pth"</span><span class="p">)</span>
<a id="__codelineno-5-45" name="__codelineno-5-45"></a><span class="n">VIS_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="s2">"vis_voc_val"</span><span class="p">)</span>
<a id="__codelineno-5-46" name="__codelineno-5-46"></a>
<a id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Using device: </span><span class="si">{</span><span class="n">DEVICE</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-48" name="__codelineno-5-48"></a><span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s2">"cuda"</span><span class="p">:</span>
<a id="__codelineno-5-49" name="__codelineno-5-49"></a>    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-5-50" name="__codelineno-5-50"></a>
<a id="__codelineno-5-51" name="__codelineno-5-51"></a><span class="c1"># PASCAL VOC 颜色映射 (RGB) 用于可视化</span>
<a id="__codelineno-5-52" name="__codelineno-5-52"></a><span class="n">VOC_COLORMAP</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-5-53" name="__codelineno-5-53"></a>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
<a id="__codelineno-5-54" name="__codelineno-5-54"></a>    <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-5-55" name="__codelineno-5-55"></a>    <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
<a id="__codelineno-5-56" name="__codelineno-5-56"></a>    <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-5-57" name="__codelineno-5-57"></a>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
<a id="__codelineno-5-58" name="__codelineno-5-58"></a><span class="p">]</span>
<a id="__codelineno-5-59" name="__codelineno-5-59"></a>
<a id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="c1"># -------------------- 数据集（VOC） --------------------</span>
<a id="__codelineno-5-61" name="__codelineno-5-61"></a><span class="k">class</span><span class="w"> </span><span class="nc">VOCSegmentationDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-5-62" name="__codelineno-5-62"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-5-63" name="__codelineno-5-63"></a><span class="sd">    用于 VOC2007/VOC2012 的语义分割数据。</span>
<a id="__codelineno-5-64" name="__codelineno-5-64"></a><span class="sd">    若缺少 ImageSets/Segmentation/{split}.txt，将回退到扫描 SegmentationClass 目录。</span>
<a id="__codelineno-5-65" name="__codelineno-5-65"></a><span class="sd">    """</span>
<a id="__codelineno-5-66" name="__codelineno-5-66"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s2">"train"</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-5-67" name="__codelineno-5-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
<a id="__codelineno-5-68" name="__codelineno-5-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>
<a id="__codelineno-5-69" name="__codelineno-5-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_set</span> <span class="o">=</span> <span class="n">image_set</span>
<a id="__codelineno-5-70" name="__codelineno-5-70"></a>
<a id="__codelineno-5-71" name="__codelineno-5-71"></a>        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"JPEGImages"</span><span class="p">)</span>
<a id="__codelineno-5-72" name="__codelineno-5-72"></a>        <span class="n">mask_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"SegmentationClass"</span><span class="p">)</span>
<a id="__codelineno-5-73" name="__codelineno-5-73"></a>        <span class="n">split_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"ImageSets"</span><span class="p">,</span> <span class="s2">"Segmentation"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">image_set</span><span class="si">}</span><span class="s2">.txt"</span><span class="p">)</span>
<a id="__codelineno-5-74" name="__codelineno-5-74"></a>
<a id="__codelineno-5-75" name="__codelineno-5-75"></a>        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">image_dir</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"Image dir not found: </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-5-76" name="__codelineno-5-76"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">):</span>
<a id="__codelineno-5-77" name="__codelineno-5-77"></a>            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
<a id="__codelineno-5-78" name="__codelineno-5-78"></a>                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"SegmentationClass not found: </span><span class="si">{</span><span class="n">mask_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-79" name="__codelineno-5-79"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-80" name="__codelineno-5-80"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[Warning] SegmentationClass not found in </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">, dataset will be empty."</span><span class="p">)</span>
<a id="__codelineno-5-81" name="__codelineno-5-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span> <span class="o">=</span> <span class="n">image_dir</span>
<a id="__codelineno-5-82" name="__codelineno-5-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask_dir</span> <span class="o">=</span> <span class="n">mask_dir</span>
<a id="__codelineno-5-83" name="__codelineno-5-83"></a>
<a id="__codelineno-5-84" name="__codelineno-5-84"></a>        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-85" name="__codelineno-5-85"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">split_file</span><span class="p">):</span>
<a id="__codelineno-5-86" name="__codelineno-5-86"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">split_file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-5-87" name="__codelineno-5-87"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
<a id="__codelineno-5-88" name="__codelineno-5-88"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-89" name="__codelineno-5-89"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">):</span>
<a id="__codelineno-5-90" name="__codelineno-5-90"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".png"</span><span class="p">)]</span>
<a id="__codelineno-5-91" name="__codelineno-5-91"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-92" name="__codelineno-5-92"></a>                <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-93" name="__codelineno-5-93"></a>
<a id="__codelineno-5-94" name="__codelineno-5-94"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-5-95" name="__codelineno-5-95"></a>        <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
<a id="__codelineno-5-96" name="__codelineno-5-96"></a>            <span class="n">ip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.jpg"</span><span class="p">)</span>
<a id="__codelineno-5-97" name="__codelineno-5-97"></a>            <span class="n">mp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s2">.png"</span><span class="p">)</span>
<a id="__codelineno-5-98" name="__codelineno-5-98"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">mp</span><span class="p">):</span>
<a id="__codelineno-5-99" name="__codelineno-5-99"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
<a id="__codelineno-5-100" name="__codelineno-5-100"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<a id="__codelineno-5-101" name="__codelineno-5-101"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-102" name="__codelineno-5-102"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[Warning] Empty dataset for root=</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">, split=</span><span class="si">{</span><span class="n">image_set</span><span class="si">}</span><span class="s2">. Check masks/splits."</span><span class="p">)</span>
<a id="__codelineno-5-103" name="__codelineno-5-103"></a>
<a id="__codelineno-5-104" name="__codelineno-5-104"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-5-105" name="__codelineno-5-105"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">)</span>
<a id="__codelineno-5-106" name="__codelineno-5-106"></a>
<a id="__codelineno-5-107" name="__codelineno-5-107"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-5-108" name="__codelineno-5-108"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">"RGB"</span><span class="p">)</span>
<a id="__codelineno-5-109" name="__codelineno-5-109"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>  <span class="c1"># palette 索引</span>
<a id="__codelineno-5-110" name="__codelineno-5-110"></a>
<a id="__codelineno-5-111" name="__codelineno-5-111"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-112" name="__codelineno-5-112"></a>            <span class="n">image</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-5-113" name="__codelineno-5-113"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-114" name="__codelineno-5-114"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-5-115" name="__codelineno-5-115"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">))</span>
<a id="__codelineno-5-116" name="__codelineno-5-116"></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-5-117" name="__codelineno-5-117"></a>            <span class="n">image</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-5-118" name="__codelineno-5-118"></a>        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-5-119" name="__codelineno-5-119"></a>
<a id="__codelineno-5-120" name="__codelineno-5-120"></a><span class="c1"># -------------------- 数据增强与预处理 --------------------</span>
<a id="__codelineno-5-121" name="__codelineno-5-121"></a><span class="k">class</span><span class="w"> </span><span class="nc">SegmentationTransforms</span><span class="p">:</span>
<a id="__codelineno-5-122" name="__codelineno-5-122"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">,</span>
<a id="__codelineno-5-123" name="__codelineno-5-123"></a>                 <span class="n">color_jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_noise_prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>  <span class="c1"># 关闭噪声：默认 0.0</span>
<a id="__codelineno-5-124" name="__codelineno-5-124"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="n">is_train</span>
<a id="__codelineno-5-125" name="__codelineno-5-125"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_size</span> <span class="o">=</span> <span class="n">base_size</span>
<a id="__codelineno-5-126" name="__codelineno-5-126"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">=</span> <span class="n">crop_size</span>
<a id="__codelineno-5-127" name="__codelineno-5-127"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">)</span>
<a id="__codelineno-5-128" name="__codelineno-5-128"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)</span>
<a id="__codelineno-5-129" name="__codelineno-5-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ColorJitter</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_jitter</span> <span class="ow">and</span> <span class="n">is_train</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-5-130" name="__codelineno-5-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_noise_prob</span> <span class="o">=</span> <span class="n">add_noise_prob</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-5-131" name="__codelineno-5-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">noise_std</span> <span class="o">=</span> <span class="n">noise_std</span>
<a id="__codelineno-5-132" name="__codelineno-5-132"></a>
<a id="__codelineno-5-133" name="__codelineno-5-133"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<a id="__codelineno-5-134" name="__codelineno-5-134"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">:</span>
<a id="__codelineno-5-135" name="__codelineno-5-135"></a>            <span class="c1"># 1) 随机缩放短边到 [0.5, 2.0] * base_size</span>
<a id="__codelineno-5-136" name="__codelineno-5-136"></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-5-137" name="__codelineno-5-137"></a>            <span class="n">short</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_size</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
<a id="__codelineno-5-138" name="__codelineno-5-138"></a>            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-5-139" name="__codelineno-5-139"></a>            <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">:</span>
<a id="__codelineno-5-140" name="__codelineno-5-140"></a>                <span class="n">ow</span><span class="p">,</span> <span class="n">oh</span> <span class="o">=</span> <span class="n">short</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">short</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-5-141" name="__codelineno-5-141"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-142" name="__codelineno-5-142"></a>                <span class="n">oh</span><span class="p">,</span> <span class="n">ow</span> <span class="o">=</span> <span class="n">short</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">short</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-5-143" name="__codelineno-5-143"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">ow</span><span class="p">,</span> <span class="n">oh</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">BILINEAR</span><span class="p">)</span>
<a id="__codelineno-5-144" name="__codelineno-5-144"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">ow</span><span class="p">,</span> <span class="n">oh</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">NEAREST</span><span class="p">)</span>
<a id="__codelineno-5-145" name="__codelineno-5-145"></a>
<a id="__codelineno-5-146" name="__codelineno-5-146"></a>            <span class="c1"># 2) 若小于 crop_size，右下角 padding（mask 用 255）</span>
<a id="__codelineno-5-147" name="__codelineno-5-147"></a>            <span class="n">pad_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-5-148" name="__codelineno-5-148"></a>            <span class="n">pad_h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">-</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-5-149" name="__codelineno-5-149"></a>            <span class="k">if</span> <span class="n">pad_w</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pad_h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-150" name="__codelineno-5-150"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">,</span> <span class="n">pad_h</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-151" name="__codelineno-5-151"></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">,</span> <span class="n">pad_h</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-5-152" name="__codelineno-5-152"></a>
<a id="__codelineno-5-153" name="__codelineno-5-153"></a>            <span class="c1"># 3) 随机裁剪</span>
<a id="__codelineno-5-154" name="__codelineno-5-154"></a>            <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-5-155" name="__codelineno-5-155"></a>            <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-156" name="__codelineno-5-156"></a>            <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-157" name="__codelineno-5-157"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">))</span>
<a id="__codelineno-5-158" name="__codelineno-5-158"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_size</span><span class="p">))</span>
<a id="__codelineno-5-159" name="__codelineno-5-159"></a>
<a id="__codelineno-5-160" name="__codelineno-5-160"></a>            <span class="c1"># 4) 随机水平翻转</span>
<a id="__codelineno-5-161" name="__codelineno-5-161"></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
<a id="__codelineno-5-162" name="__codelineno-5-162"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">hflip</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-5-163" name="__codelineno-5-163"></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">hflip</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-5-164" name="__codelineno-5-164"></a>
<a id="__codelineno-5-165" name="__codelineno-5-165"></a>            <span class="c1"># 5) 颜色抖动</span>
<a id="__codelineno-5-166" name="__codelineno-5-166"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-167" name="__codelineno-5-167"></a>                <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_jitter</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-5-168" name="__codelineno-5-168"></a>
<a id="__codelineno-5-169" name="__codelineno-5-169"></a>        <span class="c1"># 转 Tensor</span>
<a id="__codelineno-5-170" name="__codelineno-5-170"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-5-171" name="__codelineno-5-171"></a>
<a id="__codelineno-5-172" name="__codelineno-5-172"></a>        <span class="c1"># 可选噪声（现已关闭，默认 add_noise_prob=0.0）</span>
<a id="__codelineno-5-173" name="__codelineno-5-173"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_noise_prob</span><span class="p">:</span>
<a id="__codelineno-5-174" name="__codelineno-5-174"></a>            <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_std</span>
<a id="__codelineno-5-175" name="__codelineno-5-175"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">img</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-5-176" name="__codelineno-5-176"></a>
<a id="__codelineno-5-177" name="__codelineno-5-177"></a>        <span class="c1"># 标准化</span>
<a id="__codelineno-5-178" name="__codelineno-5-178"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)</span>
<a id="__codelineno-5-179" name="__codelineno-5-179"></a>
<a id="__codelineno-5-180" name="__codelineno-5-180"></a>        <span class="c1"># 直接把 palette/L 索引图转成类别 id（0..20，255 忽略）</span>
<a id="__codelineno-5-181" name="__codelineno-5-181"></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-5-182" name="__codelineno-5-182"></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-5-183" name="__codelineno-5-183"></a>
<a id="__codelineno-5-184" name="__codelineno-5-184"></a><span class="c1"># -------------------- 模型（U-Net） --------------------</span>
<a id="__codelineno-5-185" name="__codelineno-5-185"></a><span class="k">def</span><span class="w"> </span><span class="nf">bilinear_kernel</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">):</span>
<a id="__codelineno-5-186" name="__codelineno-5-186"></a>    <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-5-187" name="__codelineno-5-187"></a>    <span class="n">center</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">kernel_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">factor</span> <span class="o">-</span> <span class="mf">0.5</span>
<a id="__codelineno-5-188" name="__codelineno-5-188"></a>    <span class="n">og</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">kernel_size</span><span class="p">,</span> <span class="p">:</span><span class="n">kernel_size</span><span class="p">]</span>
<a id="__codelineno-5-189" name="__codelineno-5-189"></a>    <span class="n">filt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">og</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span>
<a id="__codelineno-5-190" name="__codelineno-5-190"></a>    <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-5-191" name="__codelineno-5-191"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">)):</span>
<a id="__codelineno-5-192" name="__codelineno-5-192"></a>        <span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">filt</span>
<a id="__codelineno-5-193" name="__codelineno-5-193"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-5-194" name="__codelineno-5-194"></a>
<a id="__codelineno-5-195" name="__codelineno-5-195"></a><span class="c1"># 解码器 DoubleConv：加 BN + Dropout2d</span>
<a id="__codelineno-5-196" name="__codelineno-5-196"></a><span class="k">class</span><span class="w"> </span><span class="nc">DoubleConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-5-197" name="__codelineno-5-197"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<a id="__codelineno-5-198" name="__codelineno-5-198"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-5-199" name="__codelineno-5-199"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-5-200" name="__codelineno-5-200"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-201" name="__codelineno-5-201"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">),</span>
<a id="__codelineno-5-202" name="__codelineno-5-202"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-203" name="__codelineno-5-203"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-204" name="__codelineno-5-204"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_ch</span><span class="p">),</span>
<a id="__codelineno-5-205" name="__codelineno-5-205"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-206" name="__codelineno-5-206"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout2d</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
<a id="__codelineno-5-207" name="__codelineno-5-207"></a>        <span class="p">)</span>
<a id="__codelineno-5-208" name="__codelineno-5-208"></a>
<a id="__codelineno-5-209" name="__codelineno-5-209"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-5-210" name="__codelineno-5-210"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-5-211" name="__codelineno-5-211"></a>
<a id="__codelineno-5-212" name="__codelineno-5-212"></a>
<a id="__codelineno-5-213" name="__codelineno-5-213"></a><span class="k">class</span><span class="w"> </span><span class="nc">UNetVGG16</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-5-214" name="__codelineno-5-214"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-5-215" name="__codelineno-5-215"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-5-216" name="__codelineno-5-216"></a>        <span class="c1"># 预训练 VGG16 编码器</span>
<a id="__codelineno-5-217" name="__codelineno-5-217"></a>        <span class="n">vgg</span> <span class="o">=</span> <span class="n">vgg16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">VGG16_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span><span class="p">)</span>
<a id="__codelineno-5-218" name="__codelineno-5-218"></a>        <span class="n">features</span> <span class="o">=</span> <span class="n">vgg</span><span class="o">.</span><span class="n">features</span>
<a id="__codelineno-5-219" name="__codelineno-5-219"></a>
<a id="__codelineno-5-220" name="__codelineno-5-220"></a>        <span class="c1"># 拆分为“卷积块 + 池化”，并移除 pool5（保持 4 次下采样）</span>
<a id="__codelineno-5-221" name="__codelineno-5-221"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-5-222" name="__codelineno-5-222"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool1</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-5-223" name="__codelineno-5-223"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
<a id="__codelineno-5-224" name="__codelineno-5-224"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool2</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<a id="__codelineno-5-225" name="__codelineno-5-225"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-5-226" name="__codelineno-5-226"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool3</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-5-227" name="__codelineno-5-227"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">23</span><span class="p">]</span>
<a id="__codelineno-5-228" name="__codelineno-5-228"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool4</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span>
<a id="__codelineno-5-229" name="__codelineno-5-229"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span>  <span class="c1"># 不含 pool5</span>
<a id="__codelineno-5-230" name="__codelineno-5-230"></a>
<a id="__codelineno-5-231" name="__codelineno-5-231"></a>        <span class="c1"># 解码器：上采样改为“插值 + 卷积(BN+ReLU)” + 拼接 + 双卷积(DoubleConv: BN+Dropout)</span>
<a id="__codelineno-5-232" name="__codelineno-5-232"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-5-233" name="__codelineno-5-233"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-234" name="__codelineno-5-234"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-235" name="__codelineno-5-235"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<a id="__codelineno-5-236" name="__codelineno-5-236"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-237" name="__codelineno-5-237"></a>        <span class="p">)</span>
<a id="__codelineno-5-238" name="__codelineno-5-238"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec4</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">512</span> <span class="o">+</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<a id="__codelineno-5-239" name="__codelineno-5-239"></a>
<a id="__codelineno-5-240" name="__codelineno-5-240"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-5-241" name="__codelineno-5-241"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-242" name="__codelineno-5-242"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-243" name="__codelineno-5-243"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<a id="__codelineno-5-244" name="__codelineno-5-244"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-245" name="__codelineno-5-245"></a>        <span class="p">)</span>
<a id="__codelineno-5-246" name="__codelineno-5-246"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec3</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">256</span> <span class="o">+</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<a id="__codelineno-5-247" name="__codelineno-5-247"></a>
<a id="__codelineno-5-248" name="__codelineno-5-248"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-5-249" name="__codelineno-5-249"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-250" name="__codelineno-5-250"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-251" name="__codelineno-5-251"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
<a id="__codelineno-5-252" name="__codelineno-5-252"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-253" name="__codelineno-5-253"></a>        <span class="p">)</span>
<a id="__codelineno-5-254" name="__codelineno-5-254"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">128</span> <span class="o">+</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<a id="__codelineno-5-255" name="__codelineno-5-255"></a>
<a id="__codelineno-5-256" name="__codelineno-5-256"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-5-257" name="__codelineno-5-257"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-258" name="__codelineno-5-258"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-259" name="__codelineno-5-259"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
<a id="__codelineno-5-260" name="__codelineno-5-260"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-261" name="__codelineno-5-261"></a>        <span class="p">)</span>
<a id="__codelineno-5-262" name="__codelineno-5-262"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span> <span class="o">=</span> <span class="n">DoubleConv</span><span class="p">(</span><span class="mi">64</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<a id="__codelineno-5-263" name="__codelineno-5-263"></a>
<a id="__codelineno-5-264" name="__codelineno-5-264"></a>        <span class="c1"># 输出层</span>
<a id="__codelineno-5-265" name="__codelineno-5-265"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-266" name="__codelineno-5-266"></a>
<a id="__codelineno-5-267" name="__codelineno-5-267"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-5-268" name="__codelineno-5-268"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_align</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
<a id="__codelineno-5-269" name="__codelineno-5-269"></a>        <span class="c1"># 对齐尺寸，避免奇偶数导致的 1px 误差</span>
<a id="__codelineno-5-270" name="__codelineno-5-270"></a>        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
<a id="__codelineno-5-271" name="__codelineno-5-271"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'bilinear'</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-5-272" name="__codelineno-5-272"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-5-273" name="__codelineno-5-273"></a>
<a id="__codelineno-5-274" name="__codelineno-5-274"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-5-275" name="__codelineno-5-275"></a>        <span class="c1"># 编码器</span>
<a id="__codelineno-5-276" name="__codelineno-5-276"></a>        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>           <span class="c1"># C=64,   1/1</span>
<a id="__codelineno-5-277" name="__codelineno-5-277"></a>        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool1</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>          <span class="c1">#        1/2</span>
<a id="__codelineno-5-278" name="__codelineno-5-278"></a>
<a id="__codelineno-5-279" name="__codelineno-5-279"></a>        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>          <span class="c1"># C=128,  1/2</span>
<a id="__codelineno-5-280" name="__codelineno-5-280"></a>        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool2</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>          <span class="c1">#        1/4</span>
<a id="__codelineno-5-281" name="__codelineno-5-281"></a>
<a id="__codelineno-5-282" name="__codelineno-5-282"></a>        <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>          <span class="c1"># C=256,  1/4</span>
<a id="__codelineno-5-283" name="__codelineno-5-283"></a>        <span class="n">p3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool3</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>          <span class="c1">#        1/8</span>
<a id="__codelineno-5-284" name="__codelineno-5-284"></a>
<a id="__codelineno-5-285" name="__codelineno-5-285"></a>        <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span>          <span class="c1"># C=512,  1/8</span>
<a id="__codelineno-5-286" name="__codelineno-5-286"></a>        <span class="n">p4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool4</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span>          <span class="c1">#        1/16</span>
<a id="__codelineno-5-287" name="__codelineno-5-287"></a>
<a id="__codelineno-5-288" name="__codelineno-5-288"></a>        <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv5</span><span class="p">(</span><span class="n">p4</span><span class="p">)</span>          <span class="c1"># C=512,  1/16 (bottleneck)</span>
<a id="__codelineno-5-289" name="__codelineno-5-289"></a>
<a id="__codelineno-5-290" name="__codelineno-5-290"></a>        <span class="c1"># 解码器（U-Net）</span>
<a id="__codelineno-5-291" name="__codelineno-5-291"></a>        <span class="n">u4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up4</span><span class="p">(</span><span class="n">x5</span><span class="p">)</span>            <span class="c1"># -&gt; 1/8</span>
<a id="__codelineno-5-292" name="__codelineno-5-292"></a>        <span class="n">u4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u4</span><span class="p">,</span> <span class="n">x4</span><span class="p">)</span>
<a id="__codelineno-5-293" name="__codelineno-5-293"></a>        <span class="n">d4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec4</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u4</span><span class="p">,</span> <span class="n">x4</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=512</span>
<a id="__codelineno-5-294" name="__codelineno-5-294"></a>
<a id="__codelineno-5-295" name="__codelineno-5-295"></a>        <span class="n">u3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up3</span><span class="p">(</span><span class="n">d4</span><span class="p">)</span>            <span class="c1"># -&gt; 1/4</span>
<a id="__codelineno-5-296" name="__codelineno-5-296"></a>        <span class="n">u3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u3</span><span class="p">,</span> <span class="n">x3</span><span class="p">)</span>
<a id="__codelineno-5-297" name="__codelineno-5-297"></a>        <span class="n">d3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec3</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u3</span><span class="p">,</span> <span class="n">x3</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=256</span>
<a id="__codelineno-5-298" name="__codelineno-5-298"></a>
<a id="__codelineno-5-299" name="__codelineno-5-299"></a>        <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up2</span><span class="p">(</span><span class="n">d3</span><span class="p">)</span>            <span class="c1"># -&gt; 1/2</span>
<a id="__codelineno-5-300" name="__codelineno-5-300"></a>        <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<a id="__codelineno-5-301" name="__codelineno-5-301"></a>        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u2</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=128</span>
<a id="__codelineno-5-302" name="__codelineno-5-302"></a>
<a id="__codelineno-5-303" name="__codelineno-5-303"></a>        <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up1</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>            <span class="c1"># -&gt; 1/1</span>
<a id="__codelineno-5-304" name="__codelineno-5-304"></a>        <span class="n">u1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
<a id="__codelineno-5-305" name="__codelineno-5-305"></a>        <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">u1</span><span class="p">,</span> <span class="n">x1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># C=64</span>
<a id="__codelineno-5-306" name="__codelineno-5-306"></a>
<a id="__codelineno-5-307" name="__codelineno-5-307"></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_conv</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>      <span class="c1"># -&gt; num_classes@HxW</span>
<a id="__codelineno-5-308" name="__codelineno-5-308"></a>        <span class="k">return</span> <span class="n">out</span>
<a id="__codelineno-5-309" name="__codelineno-5-309"></a>
<a id="__codelineno-5-310" name="__codelineno-5-310"></a><span class="c1"># -------------------- 评估指标 --------------------</span>
<a id="__codelineno-5-311" name="__codelineno-5-311"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
<a id="__codelineno-5-312" name="__codelineno-5-312"></a>    <span class="n">pixel_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-5-313" name="__codelineno-5-313"></a>    <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
<a id="__codelineno-5-314" name="__codelineno-5-314"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">),</span> <span class="n">denom</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">denom</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-315" name="__codelineno-5-315"></a>    <span class="n">miou</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span>
<a id="__codelineno-5-316" name="__codelineno-5-316"></a>    <span class="k">return</span> <span class="n">pixel_accuracy</span><span class="p">,</span> <span class="n">miou</span>
<a id="__codelineno-5-317" name="__codelineno-5-317"></a>
<a id="__codelineno-5-318" name="__codelineno-5-318"></a><span class="c1"># -------------------- 训练 / 验证 --------------------</span>
<a id="__codelineno-5-319" name="__codelineno-5-319"></a><span class="k">def</span><span class="w"> </span><span class="nf">train_one_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">,</span> <span class="n">grad_clip</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<a id="__codelineno-5-320" name="__codelineno-5-320"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-5-321" name="__codelineno-5-321"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-322" name="__codelineno-5-322"></a>    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Training"</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-5-323" name="__codelineno-5-323"></a>    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">progress_bar</span><span class="p">:</span>
<a id="__codelineno-5-324" name="__codelineno-5-324"></a>        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-5-325" name="__codelineno-5-325"></a>        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-5-326" name="__codelineno-5-326"></a>
<a id="__codelineno-5-327" name="__codelineno-5-327"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-5-328" name="__codelineno-5-328"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-5-329" name="__codelineno-5-329"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-5-330" name="__codelineno-5-330"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-5-331" name="__codelineno-5-331"></a>
<a id="__codelineno-5-332" name="__codelineno-5-332"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-5-333" name="__codelineno-5-333"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">unscale_</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
<a id="__codelineno-5-334" name="__codelineno-5-334"></a>        <span class="k">if</span> <span class="n">grad_clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grad_clip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-335" name="__codelineno-5-335"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">grad_clip</span><span class="p">)</span>
<a id="__codelineno-5-336" name="__codelineno-5-336"></a>
<a id="__codelineno-5-337" name="__codelineno-5-337"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
<a id="__codelineno-5-338" name="__codelineno-5-338"></a>        <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<a id="__codelineno-5-339" name="__codelineno-5-339"></a>
<a id="__codelineno-5-340" name="__codelineno-5-340"></a>        <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-5-341" name="__codelineno-5-341"></a>
<a id="__codelineno-5-342" name="__codelineno-5-342"></a>        <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-5-343" name="__codelineno-5-343"></a>        <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span>
<a id="__codelineno-5-344" name="__codelineno-5-344"></a>            <span class="n">loss</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
<a id="__codelineno-5-345" name="__codelineno-5-345"></a>            <span class="n">lr</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"lr"</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">"lr"</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">'</span>
<a id="__codelineno-5-346" name="__codelineno-5-346"></a>        <span class="p">)</span>
<a id="__codelineno-5-347" name="__codelineno-5-347"></a>    <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
<a id="__codelineno-5-348" name="__codelineno-5-348"></a>
<a id="__codelineno-5-349" name="__codelineno-5-349"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-5-350" name="__codelineno-5-350"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_fast</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
<a id="__codelineno-5-351" name="__codelineno-5-351"></a>                  <span class="n">compute_loss</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_batches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-5-352" name="__codelineno-5-352"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-5-353" name="__codelineno-5-353"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-5-354" name="__codelineno-5-354"></a>    <span class="n">seen_images</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-355" name="__codelineno-5-355"></a>    <span class="n">batches</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-356" name="__codelineno-5-356"></a>
<a id="__codelineno-5-357" name="__codelineno-5-357"></a>    <span class="n">conf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-5-358" name="__codelineno-5-358"></a>    <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">"Evaluating"</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="k">else</span> <span class="n">data_loader</span>
<a id="__codelineno-5-359" name="__codelineno-5-359"></a>
<a id="__codelineno-5-360" name="__codelineno-5-360"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
<a id="__codelineno-5-361" name="__codelineno-5-361"></a>        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
<a id="__codelineno-5-362" name="__codelineno-5-362"></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-363" name="__codelineno-5-363"></a>            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-364" name="__codelineno-5-364"></a>
<a id="__codelineno-5-365" name="__codelineno-5-365"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-5-366" name="__codelineno-5-366"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-5-367" name="__codelineno-5-367"></a>                <span class="k">if</span> <span class="n">compute_loss</span><span class="p">:</span>
<a id="__codelineno-5-368" name="__codelineno-5-368"></a>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<a id="__codelineno-5-369" name="__codelineno-5-369"></a>                    <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-5-370" name="__codelineno-5-370"></a>
<a id="__codelineno-5-371" name="__codelineno-5-371"></a>            <span class="n">preds</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-372" name="__codelineno-5-372"></a>            <span class="n">valid</span> <span class="o">=</span> <span class="n">targets</span> <span class="o">!=</span> <span class="mi">255</span>
<a id="__codelineno-5-373" name="__codelineno-5-373"></a>            <span class="k">if</span> <span class="n">valid</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-5-374" name="__codelineno-5-374"></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">num_classes</span>
<a id="__codelineno-5-375" name="__codelineno-5-375"></a>                <span class="n">t</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-5-376" name="__codelineno-5-376"></a>                <span class="n">p</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-5-377" name="__codelineno-5-377"></a>                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-378" name="__codelineno-5-378"></a>                <span class="n">conf</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a id="__codelineno-5-379" name="__codelineno-5-379"></a>
<a id="__codelineno-5-380" name="__codelineno-5-380"></a>            <span class="n">batches</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-381" name="__codelineno-5-381"></a>            <span class="n">seen_images</span> <span class="o">+=</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-382" name="__codelineno-5-382"></a>
<a id="__codelineno-5-383" name="__codelineno-5-383"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">max_batches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">batches</span> <span class="o">&gt;=</span> <span class="n">max_batches</span><span class="p">)</span> <span class="ow">or</span> \
<a id="__codelineno-5-384" name="__codelineno-5-384"></a>               <span class="p">(</span><span class="n">max_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seen_images</span> <span class="o">&gt;=</span> <span class="n">max_images</span><span class="p">):</span>
<a id="__codelineno-5-385" name="__codelineno-5-385"></a>                <span class="k">break</span>
<a id="__codelineno-5-386" name="__codelineno-5-386"></a>
<a id="__codelineno-5-387" name="__codelineno-5-387"></a>    <span class="n">conf_f</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-5-388" name="__codelineno-5-388"></a>    <span class="n">total</span> <span class="o">=</span> <span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-5-389" name="__codelineno-5-389"></a>    <span class="n">pixel_acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-5-390" name="__codelineno-5-390"></a>    <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">conf_f</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">))</span>
<a id="__codelineno-5-391" name="__codelineno-5-391"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">conf_f</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">denom</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)))</span>
<a id="__codelineno-5-392" name="__codelineno-5-392"></a>    <span class="n">miou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">iou</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-5-393" name="__codelineno-5-393"></a>
<a id="__codelineno-5-394" name="__codelineno-5-394"></a>    <span class="n">avg_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_loss</span> <span class="o">/</span> <span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">compute_loss</span> <span class="ow">and</span> <span class="n">batches</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
<a id="__codelineno-5-395" name="__codelineno-5-395"></a>    <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">pixel_acc</span><span class="p">,</span> <span class="n">miou</span>
<a id="__codelineno-5-396" name="__codelineno-5-396"></a>
<a id="__codelineno-5-397" name="__codelineno-5-397"></a><span class="c1"># -------------------- 可视化 --------------------</span>
<a id="__codelineno-5-398" name="__codelineno-5-398"></a><span class="k">def</span><span class="w"> </span><span class="nf">decode_segmap</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">void_value</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">void_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
<a id="__codelineno-5-399" name="__codelineno-5-399"></a>    <span class="n">lut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-5-400" name="__codelineno-5-400"></a>    <span class="n">lut</span><span class="p">[:</span><span class="n">nc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">VOC_COLORMAP</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-5-401" name="__codelineno-5-401"></a>    <span class="n">lut</span><span class="p">[</span><span class="n">void_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">void_color</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<a id="__codelineno-5-402" name="__codelineno-5-402"></a>    <span class="k">return</span> <span class="n">lut</span><span class="p">[</span><span class="n">image</span><span class="p">]</span>
<a id="__codelineno-5-403" name="__codelineno-5-403"></a>
<a id="__codelineno-5-404" name="__codelineno-5-404"></a><span class="k">def</span><span class="w"> </span><span class="nf">denormalize</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
<a id="__codelineno-5-405" name="__codelineno-5-405"></a>    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">])</span>
<a id="__codelineno-5-406" name="__codelineno-5-406"></a>    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
<a id="__codelineno-5-407" name="__codelineno-5-407"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-408" name="__codelineno-5-408"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="n">arr</span> <span class="o">+</span> <span class="n">mean</span>
<a id="__codelineno-5-409" name="__codelineno-5-409"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-410" name="__codelineno-5-410"></a>
<a id="__codelineno-5-411" name="__codelineno-5-411"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-5-412" name="__codelineno-5-412"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize_predictions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">VIS_DIR</span><span class="p">,</span> <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
<a id="__codelineno-5-413" name="__codelineno-5-413"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-414" name="__codelineno-5-414"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-5-415" name="__codelineno-5-415"></a>    <span class="n">shown</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-416" name="__codelineno-5-416"></a>
<a id="__codelineno-5-417" name="__codelineno-5-417"></a>    <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
<a id="__codelineno-5-418" name="__codelineno-5-418"></a>        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-5-419" name="__codelineno-5-419"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">):</span>
<a id="__codelineno-5-420" name="__codelineno-5-420"></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-5-421" name="__codelineno-5-421"></a>
<a id="__codelineno-5-422" name="__codelineno-5-422"></a>        <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-5-423" name="__codelineno-5-423"></a>        <span class="n">images_cpu</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-5-424" name="__codelineno-5-424"></a>        <span class="n">targets_np</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-5-425" name="__codelineno-5-425"></a>
<a id="__codelineno-5-426" name="__codelineno-5-426"></a>        <span class="n">bsz</span> <span class="o">=</span> <span class="n">images_cpu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-427" name="__codelineno-5-427"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bsz</span><span class="p">):</span>
<a id="__codelineno-5-428" name="__codelineno-5-428"></a>            <span class="k">if</span> <span class="n">shown</span> <span class="o">&gt;=</span> <span class="n">num_images</span><span class="p">:</span> <span class="k">break</span>
<a id="__codelineno-5-429" name="__codelineno-5-429"></a>
<a id="__codelineno-5-430" name="__codelineno-5-430"></a>            <span class="n">original_img</span> <span class="o">=</span> <span class="n">denormalize</span><span class="p">(</span><span class="n">images_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-5-431" name="__codelineno-5-431"></a>            <span class="n">gt_mask_rgb</span> <span class="o">=</span> <span class="n">decode_segmap</span><span class="p">(</span><span class="n">targets_np</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-5-432" name="__codelineno-5-432"></a>            <span class="n">pred_mask_rgb</span> <span class="o">=</span> <span class="n">decode_segmap</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-5-433" name="__codelineno-5-433"></a>
<a id="__codelineno-5-434" name="__codelineno-5-434"></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-5-435" name="__codelineno-5-435"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original_img</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Original"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-5-436" name="__codelineno-5-436"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gt_mask_rgb</span><span class="p">);</span>  <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Ground Truth"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-5-437" name="__codelineno-5-437"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred_mask_rgb</span><span class="p">);</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Prediction"</span><span class="p">);</span>   <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-5-438" name="__codelineno-5-438"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">original_img</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred_mask_rgb</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">overlay_alpha</span><span class="p">)</span>
<a id="__codelineno-5-439" name="__codelineno-5-439"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Overlay"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<a id="__codelineno-5-440" name="__codelineno-5-440"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-5-441" name="__codelineno-5-441"></a>
<a id="__codelineno-5-442" name="__codelineno-5-442"></a>            <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'result_</span><span class="si">{</span><span class="n">shown</span><span class="si">:</span><span class="s1">03d</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
<a id="__codelineno-5-443" name="__codelineno-5-443"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
<a id="__codelineno-5-444" name="__codelineno-5-444"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<a id="__codelineno-5-445" name="__codelineno-5-445"></a>            <span class="n">shown</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-446" name="__codelineno-5-446"></a>        <span class="k">if</span> <span class="n">shown</span> <span class="o">&gt;=</span> <span class="n">num_images</span><span class="p">:</span> <span class="k">break</span>
<a id="__codelineno-5-447" name="__codelineno-5-447"></a>
<a id="__codelineno-5-448" name="__codelineno-5-448"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"可视化结果保存在: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span><span class="si">}</span><span class="s2">（共 </span><span class="si">{</span><span class="n">shown</span><span class="si">}</span><span class="s2"> 张）"</span><span class="p">)</span>
<a id="__codelineno-5-449" name="__codelineno-5-449"></a>
<a id="__codelineno-5-450" name="__codelineno-5-450"></a><span class="c1"># -------------------- 准备数据与模型 --------------------</span>
<a id="__codelineno-5-451" name="__codelineno-5-451"></a><span class="c1"># 训练集：VOC2007 trainval + VOC2012 train（若 2007 不可用，则仅 2012）</span>
<a id="__codelineno-5-452" name="__codelineno-5-452"></a><span class="n">train_sets</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-453" name="__codelineno-5-453"></a>
<a id="__codelineno-5-454" name="__codelineno-5-454"></a><span class="c1"># VOC2007 trainval（若存在分割标注）</span>
<a id="__codelineno-5-455" name="__codelineno-5-455"></a><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">VOC2007_ROOT</span><span class="p">):</span>
<a id="__codelineno-5-456" name="__codelineno-5-456"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-457" name="__codelineno-5-457"></a>        <span class="n">train_07</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-5-458" name="__codelineno-5-458"></a>            <span class="n">VOC2007_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'trainval'</span><span class="p">,</span>
<a id="__codelineno-5-459" name="__codelineno-5-459"></a>            <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>  <span class="c1"># 已默认关闭噪声</span>
<a id="__codelineno-5-460" name="__codelineno-5-460"></a>            <span class="n">strict</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-5-461" name="__codelineno-5-461"></a>        <span class="p">)</span>
<a id="__codelineno-5-462" name="__codelineno-5-462"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-463" name="__codelineno-5-463"></a>            <span class="n">train_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span>
<a id="__codelineno-5-464" name="__codelineno-5-464"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"VOC2007 trainval 可用: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_07</span><span class="p">)</span><span class="si">}</span><span class="s2"> 样本"</span><span class="p">)</span>
<a id="__codelineno-5-465" name="__codelineno-5-465"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-466" name="__codelineno-5-466"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">"VOC2007 trainval 无可用分割样本，跳过 2007。"</span><span class="p">)</span>
<a id="__codelineno-5-467" name="__codelineno-5-467"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-5-468" name="__codelineno-5-468"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"加载 VOC2007 失败，跳过：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-469" name="__codelineno-5-469"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-470" name="__codelineno-5-470"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"未找到 VOC2007 路径：</span><span class="si">{</span><span class="n">VOC2007_ROOT</span><span class="si">}</span><span class="s2">（将仅使用 VOC2012 训练）"</span><span class="p">)</span>
<a id="__codelineno-5-471" name="__codelineno-5-471"></a>
<a id="__codelineno-5-472" name="__codelineno-5-472"></a><span class="c1"># VOC2012 train</span>
<a id="__codelineno-5-473" name="__codelineno-5-473"></a><span class="n">train_12</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-5-474" name="__codelineno-5-474"></a>    <span class="n">VOC2012_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'train'</span><span class="p">,</span>
<a id="__codelineno-5-475" name="__codelineno-5-475"></a>    <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>  <span class="c1"># 已默认关闭噪声</span>
<a id="__codelineno-5-476" name="__codelineno-5-476"></a>    <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-5-477" name="__codelineno-5-477"></a><span class="p">)</span>
<a id="__codelineno-5-478" name="__codelineno-5-478"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"VOC2012 train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_12</span><span class="p">)</span><span class="si">}</span><span class="s2"> 样本"</span><span class="p">)</span>
<a id="__codelineno-5-479" name="__codelineno-5-479"></a><span class="n">train_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_12</span><span class="p">)</span>
<a id="__codelineno-5-480" name="__codelineno-5-480"></a>
<a id="__codelineno-5-481" name="__codelineno-5-481"></a><span class="c1"># 合并训练集</span>
<a id="__codelineno-5-482" name="__codelineno-5-482"></a><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_sets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-5-483" name="__codelineno-5-483"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-484" name="__codelineno-5-484"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-485" name="__codelineno-5-485"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">ConcatDataset</span><span class="p">(</span><span class="n">train_sets</span><span class="p">)</span>
<a id="__codelineno-5-486" name="__codelineno-5-486"></a>
<a id="__codelineno-5-487" name="__codelineno-5-487"></a><span class="c1"># 验证：VOC2012 val</span>
<a id="__codelineno-5-488" name="__codelineno-5-488"></a><span class="n">val_dataset_voc</span> <span class="o">=</span> <span class="n">VOCSegmentationDataset</span><span class="p">(</span>
<a id="__codelineno-5-489" name="__codelineno-5-489"></a>    <span class="n">VOC2012_ROOT</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="s1">'val'</span><span class="p">,</span>
<a id="__codelineno-5-490" name="__codelineno-5-490"></a>    <span class="n">transforms</span><span class="o">=</span><span class="n">SegmentationTransforms</span><span class="p">(</span><span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_size</span><span class="o">=</span><span class="mi">520</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="mi">480</span><span class="p">),</span>
<a id="__codelineno-5-491" name="__codelineno-5-491"></a>    <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-5-492" name="__codelineno-5-492"></a><span class="p">)</span>
<a id="__codelineno-5-493" name="__codelineno-5-493"></a>
<a id="__codelineno-5-494" name="__codelineno-5-494"></a><span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<a id="__codelineno-5-495" name="__codelineno-5-495"></a>    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-5-496" name="__codelineno-5-496"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-5-497" name="__codelineno-5-497"></a><span class="p">)</span>
<a id="__codelineno-5-498" name="__codelineno-5-498"></a><span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
<a id="__codelineno-5-499" name="__codelineno-5-499"></a>    <span class="n">val_dataset_voc</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">VAL_BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-5-500" name="__codelineno-5-500"></a>    <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-5-501" name="__codelineno-5-501"></a><span class="p">)</span>
<a id="__codelineno-5-502" name="__codelineno-5-502"></a>
<a id="__codelineno-5-503" name="__codelineno-5-503"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"训练集总样本数: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-504" name="__codelineno-5-504"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"验证集样本数 (VOC2012 val): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset_voc</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-505" name="__codelineno-5-505"></a>
<a id="__codelineno-5-506" name="__codelineno-5-506"></a><span class="n">model</span> <span class="o">=</span> <span class="n">UNetVGG16</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">NUM_CLASSES</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-5-507" name="__codelineno-5-507"></a><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">ignore_index</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-5-508" name="__codelineno-5-508"></a>
<a id="__codelineno-5-509" name="__codelineno-5-509"></a><span class="c1"># 参数分组 + poly 学习率</span>
<a id="__codelineno-5-510" name="__codelineno-5-510"></a><span class="n">base_lr</span> <span class="o">=</span> <span class="n">LEARNING_RATE</span>
<a id="__codelineno-5-511" name="__codelineno-5-511"></a><span class="n">new_lr</span>  <span class="o">=</span> <span class="n">LEARNING_RATE</span> <span class="o">*</span> <span class="mi">10</span>
<a id="__codelineno-5-512" name="__codelineno-5-512"></a>
<a id="__codelineno-5-513" name="__codelineno-5-513"></a><span class="c1"># 预训练的编码器（VGG16 features）</span>
<a id="__codelineno-5-514" name="__codelineno-5-514"></a><span class="n">encoder_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">conv1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">conv2</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">conv3</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">conv4</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">conv5</span><span class="p">]</span>
<a id="__codelineno-5-515" name="__codelineno-5-515"></a>
<a id="__codelineno-5-516" name="__codelineno-5-516"></a><span class="c1"># 新初始化的解码器与输出层</span>
<a id="__codelineno-5-517" name="__codelineno-5-517"></a><span class="n">new_modules</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-5-518" name="__codelineno-5-518"></a>    <span class="n">model</span><span class="o">.</span><span class="n">up4</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dec4</span><span class="p">,</span>
<a id="__codelineno-5-519" name="__codelineno-5-519"></a>    <span class="n">model</span><span class="o">.</span><span class="n">up3</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dec3</span><span class="p">,</span>
<a id="__codelineno-5-520" name="__codelineno-5-520"></a>    <span class="n">model</span><span class="o">.</span><span class="n">up2</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dec2</span><span class="p">,</span>
<a id="__codelineno-5-521" name="__codelineno-5-521"></a>    <span class="n">model</span><span class="o">.</span><span class="n">up1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dec1</span><span class="p">,</span>
<a id="__codelineno-5-522" name="__codelineno-5-522"></a>    <span class="n">model</span><span class="o">.</span><span class="n">out_conv</span>
<a id="__codelineno-5-523" name="__codelineno-5-523"></a><span class="p">]</span>
<a id="__codelineno-5-524" name="__codelineno-5-524"></a>
<a id="__codelineno-5-525" name="__codelineno-5-525"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">([</span>
<a id="__codelineno-5-526" name="__codelineno-5-526"></a>    <span class="p">{</span><span class="s1">'params'</span><span class="p">:</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">encoder_modules</span><span class="p">)),</span> <span class="s1">'lr'</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">},</span>
<a id="__codelineno-5-527" name="__codelineno-5-527"></a>    <span class="p">{</span><span class="s1">'params'</span><span class="p">:</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">new_modules</span><span class="p">)),</span> <span class="s1">'lr'</span><span class="p">:</span> <span class="n">new_lr</span><span class="p">},</span>
<a id="__codelineno-5-528" name="__codelineno-5-528"></a><span class="p">],</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">WEIGHT_DECAY</span><span class="p">)</span>
<a id="__codelineno-5-529" name="__codelineno-5-529"></a>
<a id="__codelineno-5-530" name="__codelineno-5-530"></a><span class="n">max_iter</span> <span class="o">=</span> <span class="n">EPOCHS</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<a id="__codelineno-5-531" name="__codelineno-5-531"></a><span class="k">def</span><span class="w"> </span><span class="nf">poly_lr_lambda</span><span class="p">(</span><span class="n">it_idx</span><span class="p">):</span>
<a id="__codelineno-5-532" name="__codelineno-5-532"></a>    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">it_idx</span> <span class="o">/</span> <span class="n">max_iter</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.9</span>
<a id="__codelineno-5-533" name="__codelineno-5-533"></a>
<a id="__codelineno-5-534" name="__codelineno-5-534"></a><span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">LambdaLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_lambda</span><span class="o">=</span><span class="n">poly_lr_lambda</span><span class="p">)</span>
<a id="__codelineno-5-535" name="__codelineno-5-535"></a>
<a id="__codelineno-5-536" name="__codelineno-5-536"></a><span class="c1"># AMP Scaler（固定 cuda）</span>
<a id="__codelineno-5-537" name="__codelineno-5-537"></a><span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="s1">'cuda'</span><span class="p">)</span>
<a id="__codelineno-5-538" name="__codelineno-5-538"></a>
<a id="__codelineno-5-539" name="__codelineno-5-539"></a><span class="c1"># 记录与保存</span>
<a id="__codelineno-5-540" name="__codelineno-5-540"></a><span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'train_loss'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_loss'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_pa'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'val_miou'</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-5-541" name="__codelineno-5-541"></a><span class="n">best_miou_voc</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<a id="__codelineno-5-542" name="__codelineno-5-542"></a><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">SAVE_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-543" name="__codelineno-5-543"></a>
<a id="__codelineno-5-544" name="__codelineno-5-544"></a><span class="c1"># -------------------- 训练循环 --------------------</span>
<a id="__codelineno-5-545" name="__codelineno-5-545"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"开始训练..."</span><span class="p">)</span>
<a id="__codelineno-5-546" name="__codelineno-5-546"></a><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-5-547" name="__codelineno-5-547"></a>
<a id="__codelineno-5-548" name="__codelineno-5-548"></a><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
<a id="__codelineno-5-549" name="__codelineno-5-549"></a>    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">train_one_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">lr_scheduler</span><span class="p">)</span>
<a id="__codelineno-5-550" name="__codelineno-5-550"></a>
<a id="__codelineno-5-551" name="__codelineno-5-551"></a>    <span class="n">val_loss_voc</span><span class="p">,</span> <span class="n">val_pa_voc</span><span class="p">,</span> <span class="n">val_miou_voc</span> <span class="o">=</span> <span class="n">evaluate_fast</span><span class="p">(</span>
<a id="__codelineno-5-552" name="__codelineno-5-552"></a>        <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">NUM_CLASSES</span><span class="p">,</span>
<a id="__codelineno-5-553" name="__codelineno-5-553"></a>        <span class="n">compute_loss</span><span class="o">=</span><span class="n">EVAL_COMPUTE_LOSS</span><span class="p">,</span>
<a id="__codelineno-5-554" name="__codelineno-5-554"></a>        <span class="n">max_batches</span><span class="o">=</span><span class="n">EVAL_MAX_BATCHES</span><span class="p">,</span>
<a id="__codelineno-5-555" name="__codelineno-5-555"></a>        <span class="n">max_images</span><span class="o">=</span><span class="n">EVAL_MAX_IMAGES</span><span class="p">,</span>
<a id="__codelineno-5-556" name="__codelineno-5-556"></a>        <span class="n">progress</span><span class="o">=</span><span class="n">EVAL_PROGRESS</span>
<a id="__codelineno-5-557" name="__codelineno-5-557"></a>    <span class="p">)</span>
<a id="__codelineno-5-558" name="__codelineno-5-558"></a>
<a id="__codelineno-5-559" name="__codelineno-5-559"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'train_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
<a id="__codelineno-5-560" name="__codelineno-5-560"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss_voc</span><span class="p">)</span>
<a id="__codelineno-5-561" name="__codelineno-5-561"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_pa'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_pa_voc</span><span class="p">)</span>
<a id="__codelineno-5-562" name="__codelineno-5-562"></a>    <span class="n">history</span><span class="p">[</span><span class="s1">'val_miou'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_miou_voc</span><span class="p">)</span>
<a id="__codelineno-5-563" name="__codelineno-5-563"></a>
<a id="__codelineno-5-564" name="__codelineno-5-564"></a>    <span class="k">if</span> <span class="n">val_miou_voc</span> <span class="o">&gt;</span> <span class="n">best_miou_voc</span><span class="p">:</span>
<a id="__codelineno-5-565" name="__codelineno-5-565"></a>        <span class="n">best_miou_voc</span> <span class="o">=</span> <span class="n">val_miou_voc</span>
<a id="__codelineno-5-566" name="__codelineno-5-566"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
<a id="__codelineno-5-567" name="__codelineno-5-567"></a>            <span class="s1">'epoch'</span><span class="p">:</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-5-568" name="__codelineno-5-568"></a>            <span class="s1">'model_state'</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<a id="__codelineno-5-569" name="__codelineno-5-569"></a>            <span class="s1">'optimizer_state'</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<a id="__codelineno-5-570" name="__codelineno-5-570"></a>            <span class="s1">'miou_voc'</span><span class="p">:</span> <span class="n">best_miou_voc</span><span class="p">,</span>
<a id="__codelineno-5-571" name="__codelineno-5-571"></a>            <span class="s1">'config'</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-5-572" name="__codelineno-5-572"></a>                <span class="s1">'base_lr'</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">,</span> <span class="s1">'new_lr'</span><span class="p">:</span> <span class="n">new_lr</span><span class="p">,</span> <span class="s1">'weight_decay'</span><span class="p">:</span> <span class="n">WEIGHT_DECAY</span><span class="p">,</span>
<a id="__codelineno-5-573" name="__codelineno-5-573"></a>                <span class="s1">'epochs'</span><span class="p">:</span> <span class="n">EPOCHS</span><span class="p">,</span> <span class="s1">'batch_size'</span><span class="p">:</span> <span class="n">BATCH_SIZE</span>
<a id="__codelineno-5-574" name="__codelineno-5-574"></a>            <span class="p">}</span>
<a id="__codelineno-5-575" name="__codelineno-5-575"></a>        <span class="p">},</span> <span class="n">BEST_PATH_VOC</span><span class="p">)</span>
<a id="__codelineno-5-576" name="__codelineno-5-576"></a>
<a id="__codelineno-5-577" name="__codelineno-5-577"></a>    <span class="n">val_loss_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">val_loss_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">EVAL_COMPUTE_LOSS</span> <span class="k">else</span> <span class="s2">"n/a"</span>
<a id="__codelineno-5-578" name="__codelineno-5-578"></a>    <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-5-579" name="__codelineno-5-579"></a>        <span class="sa">f</span><span class="s2">"Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">EPOCHS</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-5-580" name="__codelineno-5-580"></a>        <span class="sa">f</span><span class="s2">"Train Loss: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-5-581" name="__codelineno-5-581"></a>        <span class="sa">f</span><span class="s2">"VOC Val: Loss </span><span class="si">{</span><span class="n">val_loss_str</span><span class="si">}</span><span class="s2">, PA </span><span class="si">{</span><span class="n">val_pa_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, mIoU </span><span class="si">{</span><span class="n">val_miou_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | "</span>
<a id="__codelineno-5-582" name="__codelineno-5-582"></a>        <span class="sa">f</span><span class="s2">"Best VOC mIoU: </span><span class="si">{</span><span class="n">best_miou_voc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-5-583" name="__codelineno-5-583"></a>    <span class="p">)</span>
<a id="__codelineno-5-584" name="__codelineno-5-584"></a>
<a id="__codelineno-5-585" name="__codelineno-5-585"></a><span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-5-586" name="__codelineno-5-586"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">训练完成！总耗时: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> 分钟"</span><span class="p">)</span>
<a id="__codelineno-5-587" name="__codelineno-5-587"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- 最终评估指标 (VOC2012 val) ---"</span><span class="p">)</span>
<a id="__codelineno-5-588" name="__codelineno-5-588"></a><span class="n">final_loss_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_loss'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="n">EVAL_COMPUTE_LOSS</span> <span class="k">else</span> <span class="s2">"n/a"</span>
<a id="__codelineno-5-589" name="__codelineno-5-589"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Val Loss: </span><span class="si">{</span><span class="n">final_loss_str</span><span class="si">}</span><span class="s2"> | PA: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_pa'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | mIoU: </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="s1">'val_miou'</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-590" name="__codelineno-5-590"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"最优权重已保存至: </span><span class="si">{</span><span class="n">BEST_PATH_VOC</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-591" name="__codelineno-5-591"></a>
<a id="__codelineno-5-592" name="__codelineno-5-592"></a><span class="c1"># 保存当前（latest）</span>
<a id="__codelineno-5-593" name="__codelineno-5-593"></a><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">LATEST_PATH</span><span class="p">)</span>
<a id="__codelineno-5-594" name="__codelineno-5-594"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"已保存当前模型权重到: </span><span class="si">{</span><span class="n">LATEST_PATH</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-5-595" name="__codelineno-5-595"></a>
<a id="__codelineno-5-596" name="__codelineno-5-596"></a><span class="c1"># 加载最优权重用于可视化</span>
<a id="__codelineno-5-597" name="__codelineno-5-597"></a><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">BEST_PATH_VOC</span><span class="p">):</span>
<a id="__codelineno-5-598" name="__codelineno-5-598"></a>    <span class="n">ckpt_voc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">BEST_PATH_VOC</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">))</span>
<a id="__codelineno-5-599" name="__codelineno-5-599"></a>    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">ckpt_voc</span><span class="p">[</span><span class="s1">'model_state'</span><span class="p">])</span>
<a id="__codelineno-5-600" name="__codelineno-5-600"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">已加载 VOC 最优权重进行可视化: </span><span class="si">{</span><span class="n">BEST_PATH_VOC</span><span class="si">}</span><span class="s2"> (epoch=</span><span class="si">{</span><span class="n">ckpt_voc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'epoch'</span><span class="p">,</span><span class="s1">'?'</span><span class="p">)</span><span class="si">}</span><span class="s2">, mIoU_VOC=</span><span class="si">{</span><span class="n">ckpt_voc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'miou_voc'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
<a id="__codelineno-5-601" name="__codelineno-5-601"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-602" name="__codelineno-5-602"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">未找到 VOC 最优权重，使用当前模型进行可视化。"</span><span class="p">)</span>
<a id="__codelineno-5-603" name="__codelineno-5-603"></a>
<a id="__codelineno-5-604" name="__codelineno-5-604"></a><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">--- 可视化预测结果 (VOC2012 val) ---"</span><span class="p">)</span>
<a id="__codelineno-5-605" name="__codelineno-5-605"></a><span class="n">visualize_predictions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">VIS_DIR</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h4 id="_9">结果<a class="headerlink" href="#_9" title="Permanent link">¶</a></h4>
<p>在 Pascal VOC 07+12 上训练 80 个 Epoch，耗时 19332s，最后的 mIoU 为 0.5342。诶，您别瞧这 mIoU 还打不过 FCN-8s，那边可是用上了 VGG 预训练参数的大头——也就是 pool5 之后的两个线性层啊！</p>
<p><img alt="alt text" src="../image-28.png"/></p>
<p>下面是几个样例图像：</p>
<p><img alt="alt text" src="../image-29.png"/></p>
<p><img alt="alt text" src="../image-30.png"/></p>
<p><img alt="alt text" src="../image-31.png"/></p>
<h3 id="_10">碎碎念<a class="headerlink" href="#_10" title="Permanent link">¶</a></h3>
<p>记得当时学数字逻辑的时候，老是有题目来考察多路选择器 MUX，也就是根据 n 个输入端高低电平，把它看作一个二进制数 x，从而激活第 x 个输出端。这种题目一般不会让多路选择器做自己的本职工作，而是利用自己可以进行从二进制编码到逻辑最小项的“译码”来干花活——比如搓一个全加器。</p>
<p>其实全卷积架构也是如此。单纯做语义分割，还是太限制它的发挥了。事实上它展示了一种<strong>像素级的编码器——解码器</strong>的通用架构，从而可以用在各种<strong>生成式任务</strong>上面。无论是 VAE 还是 DC-GAN，我们都在其中看到了反卷积的应用；而大名鼎鼎的 DDPM，其生成正是使用了 U-Net 架构。</p>
<h2 id="_11">目标检测<a class="headerlink" href="#_11" title="Permanent link">¶</a></h2>
<p>目标检测的的目的在于<strong>打目标框</strong>。如下图所示：</p>
<p><img alt="SCP-CN-2999" src="../image-27.png"/></p>
<p>如何生成这一目标框呢？古早的理论 R-CNN 认为：我们已经有了强大的图像<strong>分类网络</strong>了，那么我们只需要每次选取图像的一部分丢给分类网络，再取预测概率最高的那个框即可。这样做确实很有道理，但是对于一个很大的图像，比如我的相机拍摄的 5424x3612 的下面这张图像：</p>
<p><img alt="alt text" src="../IMG_20250503_234053.jpg"/></p>
<p>如果还是用 R-CNN 的方法做，难点在于：已知 R-CNN 在 ImageNet 的 224x224 上面都要生成接近 2000 个框，那么考虑这个图切开成 224x224 的块，一共就要生成 780910 个框！假设每个框推理时间 1ms，且全部都能以批量 128 数据并行，仍然需要 6s 才能完成基础的推理，而且这还不包含后续的 NMS 等操作。在后面我们会看到，YOLO v1 把框的数量压缩到了 38265 个（按每个 cell 32px 算），也就是 R-CNN 的二十分之一。也就是说 0.3s 就可以出图，这就使得<strong>实时</strong>目标检测成为可能。</p>
<p><img alt="alt text" src="../image-33.png"/></p>
<p>（番外：SCP-CN-2999 是我心目中的中分十佳文档之一。如果你厌烦了对人工智能的弗洛肯斯坦叙事，并认为那些人与人工智能合作共生的点子是阿西莫夫时代就玩烂了的东西，那么欢迎阅读<a href="https://scp-wiki-cn.wikidot.com/scp-cn-2999">这篇文档</a>。）</p>
<p>本文对目标检测模型只介绍 YOLO 模型。</p>
<h3 id="yolo-v1">YOLO v1<a class="headerlink" href="#yolo-v1" title="Permanent link">¶</a></h3>
<h4 id="_12">模型架构<a class="headerlink" href="#_12" title="Permanent link">¶</a></h4>
<p>那么，YOLO 采用了什么方法来缩减目标框呢？不像 R-CNN 一样选择先学习目标框的位置分布再启发式地搜寻，YOLO 选择<strong>端到端</strong>的方式获得目标框。比如有一张 224x224 的 ImageNet 图像，我们首先可以划分一个 7x7 的网格，每个小格子的边长是 32px。对于这个 32x32 的小图像干什么呢？难道是像 R-CNN 一样直接分类吗？不然。</p>
<p>俗语有言，“管中窥豹，可见一斑”。我们考虑某一个物体的<strong>中心</strong>落入了这个格子里面，那么这个格子就很可能有一部分信息知道这个物体是什么。换句话说，对于这七七四十九个格子，我们让每一个格子都来看看落在格子里的是什么东西，也就是给出类别的预测概率。另一方面，一个格子的信息基本上也差不多能让我们知道这个物体大概的尺寸如何，比如说格子里面有个人脸，那么往下画一个6~8头身的框基本上就没错了。具体到底是几头身，模型不确定，那就六头身七头身八头身都试一下，多打几个框，总有一个能蒙对。</p>
<p>这里可能有一个误解（毕竟这种说明式的语言不甚精确），就是会以为我们<strong>只</strong>根据格子里面的东西来打框。但其实不是的，我们不是先给图像分块然后限制每一个格子的<strong>感受野</strong>只在这个格子里面。事实上我们是基于图像整体的信息，最后生成 S x S 个格子和每个格子的 B 个框。也就是说推算框的大小以及该放进哪个格子都是<strong>骨干网</strong>应该干的活，它的感受野是<strong>整张图像</strong>。如果还是觉得含糊，请接着读。</p>
<p>用形式化的语言来说，也就是每个格子负责预测 <span class="arithmatex">\(B\)</span> 个框，每个框有 <span class="arithmatex">\(x,y,w,h\)</span> 四个参数，对应框的中心点相对图像左上角的坐标 <span class="arithmatex">\(x,y\)</span> 与框的尺寸 <span class="arithmatex">\(w,h\)</span>，这四个参数全部根据图像尺寸归一化到 <span class="arithmatex">\([0,1]\)</span> 之间方便反向传播。同时，框打的准不准，还需要一个置信度 <span class="arithmatex">\(c\)</span> 来衡量。具体解释在下一段。同时 YOLO v1 假定一个格子里面只有一个物体，所以还要给出物体所属的各类别的概率（下一段再解释）。以在 Pascal VOC 上训练的 YOLO v1 来说，一张图片画成 <span class="arithmatex">\(S\times S\)</span> 也就是 7x7 的网格，每个网格负责对格子里面的内容打框。一个格子打两个框，还负责输出 20 个类别，那么一个格子的输出就是 <span class="arithmatex">\(2\times 5+20=30\)</span> 维的向量，而整个网络的输出就是一个 <code>(7,7,30)</code> 的张量。</p>
<p>刚刚提到打框使用的是<strong>置信度</strong>。我们知道打框无非就是要<strong>打的准</strong>，不仅位置要准，识别也要准。位置准不准很简单，只需要用真实框和预测框的 IoU 就可以了。而由于一般的网络只能识别<strong>类别是什么</strong>而不能识别<strong>类别是否存在</strong>（之前看到某同学给一个 MNIST 分类器喂了一个五角星，然后模型煞有介事地给出了类别 8 的高达 99% 的分类概率），于是我们还需要引入一个判断是否存在待分类对象的概率 <span class="arithmatex">\(P(\mathrm{Obj})\)</span>，乘起来就得到<strong>置信度</strong>了：<span class="arithmatex">\(c=P(\mathrm{Obj})\times \mathrm{IoU}\)</span>。这代表<strong>模型对得到的这个框的信心</strong>。也就是框里面有物体并且预测和真实越接近，这个框就越可信。当然这只是我们的一厢情愿，具体的置信度还需要反向传播来算出来。</p>
<p>而类别概率其实是一个<strong>条件概率</strong>，是在这个格子里面有对象的条件下，对对象 <span class="arithmatex">\(i\)</span> 的分类概率 <span class="arithmatex">\(P(\mathrm{Class}_i|\mathrm{Obj})\)</span>。对于每一个框，我们把它的置信度乘上分类概率的向量，可以得到一个得分：<span class="arithmatex">\(s=P(\mathrm{Class}_i|\mathrm{Obj})\times P(\mathrm{Obj})\times \mathrm{IoU}=P(\mathrm{Class}_i\mathrm{\ with\ Obj\ exists})\times \mathrm{IoU}\)</span>。这个得分代表了对于每一个类别，模型得到的框的<strong>质量</strong>。理想情况下对于背景格子而言，<span class="arithmatex">\(s\)</span> 应该是全零向量；而对于中心落在这个格子里面的真实的框而言，<span class="arithmatex">\(s\)</span> 应该是一个 one-hot 向量，其中 1 对应的就是那个真实框的类别。这样在推理时，对于模型得到的诸多框而言，我们只需要根据得分排序，就可以筛选出最好的那些框了。</p>
<p>“每个格子只预测一个类别”固然简化了模型，但也很有可能带来信息的损失，具体表现为，YOLO v1 在小物体的预测上力不从心。假设两个小物体都包在一个格子里面，那这个格子该预测什么呢？而如果我们加细格子，则会带来平方级的复杂度增长。</p>
<h4 id="_13">损失函数<a class="headerlink" href="#_13" title="Permanent link">¶</a></h4>
<p>下面我们需要指标来评估这个模型打框的质量如何，这样才能让模型反向传播实现进化。</p>
<p>首先我们来看损失函数。我们来回顾一下打框的几个要素：首先定中心点坐标，然后算框的尺寸，给出置信度，最后一部分是概率。其中每一个要素都要兼顾。</p>
<p>首先我们要确定对于每一个格子而言，它的框在预测什么。YOLO v1 为了简化，首先对于每个格子先筛一遍，找到那个<strong>中心点落在这个格子里面的真实框</strong>(a ground truth)，如果有真实框（原论文叫这个物体出现在格子里面），我们用 <span class="arithmatex">\(1_{i}^\mathrm{obj}\)</span> 来指示格子 <span class="arithmatex">\(i\)</span> 有物体出现在这个格子里面。</p>
<p>下面，既然我们已经有了一个真实框，就可以选<strong>格子里面和它 IoU 最大的那个预测框</strong>(the predictor responsible for the ground truth)进行配对，我们把那个真实框叫做“目标框”(the ground truth)（原论文叫做这个预测框负责这个真实框，也就是负责它的目标框）。</p>
<p>我们用指标 <span class="arithmatex">\(1_{ij}^\mathrm{obj}\)</span> 表示第 <span class="arithmatex">\(i\)</span> 个格子的第 <span class="arithmatex">\(j\)</span> 个框存在一个对应的目标框，这就说明这个框是和它格子的真实框 IoU 最大的那个框。如果不存在目标框，就使用 <span class="arithmatex">\(1_{ij}^\mathrm{noobj}\)</span> 来指示，说明它的 IoU 不是最大的，或者它对应的格子根本没有真实框。下面我们就可以计算<strong>框的损失</strong>：</p>
<p>对于第 <span class="arithmatex">\(i\)</span> 个格子的第 <span class="arithmatex">\(j\)</span> 个框，其中心点的误差，我们可以直接用预测框中心点到目标框中心点距离模长的平方衡量：</p>
<div class="arithmatex">\[
\mathcal{L}_\mathrm{center}=\sum_i^{S^2}\sum_j^{B} 1_{ij}^\mathrm{obj}\left[(x_{ij}-x_{ij}^{\mathrm{true}})^2+(y_{ij}-y_{ij}^{\mathrm{true}})^2\right]
\]</div>
<p>而尺寸上的误差如果仍然是直接相减再求平方的算法，会导致<strong>相同的误差对大框的惩罚不合理地大于小框</strong>，因为从观感和尺度而言，同样是 10px 的差值，对于大框而言无足轻重，对于小框却是很大的偏移。也就是说我们需要把对大框的衡量尺度调小而对小框的衡量尺度调大。其实 <span class="arithmatex">\(x^{1/p}(p&gt;1)\)</span> 就能做到这个映射，在论文里面，取到的是 <span class="arithmatex">\(p=2\)</span>。现在就可以类似地写出尺寸的损失了：</p>
<div class="arithmatex">\[
\mathcal{L}_\mathrm{size}=\sum_i^{S^2}\sum_j^{B}1_{ij}^\mathrm{obj}\left[(\sqrt {w_{ij}}-\sqrt{w_{ij}^{\mathrm{true}}})^2+(\sqrt{h_{ij}}-\sqrt{h_{ij}^{\mathrm{true}}})^2\right]
\]</div>
<p>下一部分是置信度的损失。我们知道对于每一个框，理想的置信度如下：</p>
<div class="arithmatex">\[
c_{ij}^\mathrm{ideal}=\left\{
\begin{align*}
    &amp;\mathrm{IoU}^{\mathrm{true}}_{\mathrm{pred}},&amp;1_{ij}^\mathrm{obj}=1\\
    &amp;0,&amp;1_{ij}^\mathrm{noobj}=1
\end{align*}\right.
\]</div>
<p>这里的置信度损失的关键是要<strong>分辨正确的目标和背景</strong>，如果前面两项损失都很低，IoU 自然相当高，所以这里的关键就是，对于预测框而言，我们需要让它相对对应的目标框的置信度尽量高（对应目标，是正样本），而如果没有对应的目标框，则置信度尽量低（对应背景或者非最优的预测框，是负样本）。</p>
<p>正样本和负样本的损失计算就是把刚刚的式子拆开，仍旧使用 MSE。刚刚提到我们需要让不同的预测框置信度有高低的分配，我们可以直接让需要拉高置信度的，拉到 <span class="arithmatex">\(1\)</span>，需要压低的，压到 <span class="arithmatex">\(0\)</span>：</p>
<div class="arithmatex">\[
\begin{align*}
    \mathcal{L}_{\mathrm{P}}&amp;=\sum_i^{S^2}\sum_j^{B}1_{ij}^\mathrm{obj}\left(c_{ij}-1\right)^2\\
    \mathcal{L}_{\mathrm{N}}&amp;=\sum_i^{S^2}\sum_j^{B}1_{ij}^\mathrm{noobj}\left(c_{ij}-0\right)^2
\end{align*}
\]</div>
<p>最后就是分类误差了。由于分类是由格子进行的，因此这一部分是<strong>格子的损失</strong>。回忆一下，我们之前使用 <span class="arithmatex">\(1_{i}^\mathrm{obj}\)</span> 来指示某个格子有对应框的中心点落到格子里面。原论文还是用的 MSE，不过我觉得分类任务用交叉熵显然更合适：</p>
<div class="arithmatex">\[
\mathcal{L}_{\mathrm{class}}=\sum_i ^{S^2}1_{i}^\mathrm{obj}CE(p_i||\mathrm{one\_hot}_i^{\mathrm{obj}})
\]</div>
<p>最后把他们加权起来：</p>
<div class="arithmatex">\[
\mathcal{L}_{\mathrm{YOLO}}=\lambda_{\mathrm{coord}}(\mathcal{L}_\mathrm{center}+\mathcal{L}_\mathrm{size})+\mathcal{L}_{\mathrm{P}}+\lambda_{\mathrm{noobj}}\mathcal{L}_{\mathrm{N}}+\mathcal{L}_{\mathrm{class}}
\]</div>
<p>这个加权也是有说法的。我们的优先级是打框打到位，要不然后面的置信度这些都是扯淡，因此要给 <span class="arithmatex">\(\lambda_{\mathrm{coord}}\)</span> 一个大权重，论文里面给到了 <span class="arithmatex">\(5\)</span>，而且由于一个图背景肯定多于目标，因此总的 <span class="arithmatex">\(\mathcal{L}_{\mathrm{N}}\)</span> 肯定相当高，导致模型倾向于压置信分，把所有的框都预测成背景，因此我们需要控制这部分损失，给 <span class="arithmatex">\(\lambda_{\mathrm{noobj}}\)</span> 一个小权重，论文里面给到 <span class="arithmatex">\(0.5\)</span>。</p>
<p>最后总结一下计算流程：</p>
<p>对于拿到的图片，先过网络推理得到 <code>(S, S, B*5+C)</code> 的预测张量。然后扫一遍所有格子：</p>
<ul>
<li>如果有个真实框 T 的中心落在格子 <span class="arithmatex">\(i\)</span> 里面了：<ul>
<li>此时 <span class="arithmatex">\(1_i^{\mathrm{obj}}=1\)</span></li>
<li>从格子 <span class="arithmatex">\(i\)</span> 的 <span class="arithmatex">\(B\)</span> 个框里面找到和 T 的 IoU 最大的框 <span class="arithmatex">\(j\)</span>，此时 <span class="arithmatex">\(1_{ij}^{\mathrm{obj}}=1\)</span></li>
<li>对于这个框，计算 <span class="arithmatex">\(\mathcal{L}_1=\lambda_{\mathrm{coord}}(\mathcal{L}_\mathrm{center}+\mathcal{L}_\mathrm{size})+\mathcal{L}_{\mathrm{P}}\)</span></li>
<li>对于剩下的 <span class="arithmatex">\(B-1\)</span> 个框，计算 <span class="arithmatex">\(\mathcal{L}_2=\lambda_{\mathrm{noobj}}\sum^{B-1}\mathcal{L}_{\mathrm{N}}\)</span></li>
<li>对于这个格子的类别概率向量 <span class="arithmatex">\(p_i\)</span>，和 T 的类别做交叉熵，即计算 <span class="arithmatex">\(\mathcal{L}_{\mathrm{class}}=\sum_i ^{S^2}CE(p_i||\mathrm{one\_hot}_i^{\mathrm{T}})\)</span></li>
<li>格子的总损失 <span class="arithmatex">\(\mathcal{L}_{\mathrm{objcell}}=\mathcal{L}_1+\mathcal{L}_2+\mathcal{L}_{\mathrm{class}}\)</span></li>
</ul>
</li>
<li>如果没有：<ul>
<li>此时 <span class="arithmatex">\(1_i^{\mathrm{obj}}=0\)</span></li>
<li>只需对所有框求和： <span class="arithmatex">\(\mathcal{L}_{\mathrm{noobjcell}}=\mathcal{L}_2=\lambda_{\mathrm{noobj}}\sum^{B}\mathcal{L}_{\mathrm{N}}\)</span></li>
</ul>
</li>
</ul>
<p>最后可以得到整个图片的损失：<span class="arithmatex">\(\mathcal{L}_{\mathrm{YOLO}}=\sum\mathcal{L}_{\mathrm{objcell}}+\sum\mathcal{L}_{\mathrm{noobjcell}}\)</span>。</p>
<p>如果你是像我一样从过程式的 C/C++ 开始接触程序设计语言的，大概会觉得这就是一个 for-if 就能解决的事。但是如果你读了下面的损失函数代码就会发现<strong>完全不是这样做的</strong>，而是一种接近<strong>函数式</strong>的思想。</p>
<p>如果想感受这种范式转移 (Paradigm Shift) 带来的震撼，强烈推荐阅读下面计算损失使用的代码。配合这首 Paradigm Shift 食用更佳哦~</p>
<div style="text-align: center; margin: 20px 0;">
<iframe border="0" frameborder="no" height="86" marginheight="0" marginwidth="0" src="//music.163.com/outchain/player?type=2&amp;id=419116089&amp;auto=0&amp;height=66" style="border: 0px solid #ccc;" width="330"></iframe>
</div>
<p>最后值得一提的是，“选取IoU最大的框”这个操作似乎因为涉及到 <code>argmax</code> 操作而<strong>不可导</strong>，但是由于我们对不同的情况分配了不同的损失，因此我们事实上执行的操作是<strong>对最大框</strong>利用 <span class="arithmatex">\(\mathcal{L}_1\)</span> 回传梯度而对其他框利用 <span class="arithmatex">\(\mathcal{L}_{\mathrm{N}}\)</span> 回传梯度，也就是通过条件判断来构建不同的损失路径，这样整个网络就完全可导了。这一点写成代码也是有说法的，请看 VCR：</p>
<p><img alt="alt text" src="../image-36.png"/></p>
<h4 id="_14">网络结构<a class="headerlink" href="#_14" title="Permanent link">¶</a></h4>
<p>YOLO v1 使用自研架构 Darknet 来实现打框。他们在 ImageNet 上面预训练了特征提取器，然后替换分类头改为输出 <code>(S, S, B*5+C)</code> 的预测张量，再在 VOC 07+12 上面训练。由于 Darknet 的预训练权重没有公开（只公开了在目标检测数据上面微调好的），我们在这里使用 torchvision 开源的 ResNet-18 在 ImageNet 上面的预训练权重作为骨干网。当然这个网络的参数量完全比不过 Darknet。</p>
<h4 id="map">mAP<a class="headerlink" href="#map" title="Permanent link">¶</a></h4>
<p>我们知道一个格子可以有多个框，不同的框有不同的置信度。对于一个给定的 IoU 阈值，比如说 0.5，我们可以通过选择置信度阈值来筛选框，也就是说我们可以把同时符合下面三个条件的框视作<strong>TP</strong>而这个格子打的其他框视作<strong>FP</strong>：预测类别和真实类别一致、相对真实框的 IoU 满足 IoU 阈值以及满足置信度阈值。然后我们就可以得到混淆矩阵，从而得到 P-R 曲线也就是<strong>精准率-召回率曲线</strong>。</p>
<p>我们按等间隔采样 11 个召回率（事实上真实 P-R 分布不可能等间隔，但是我们插值即可），计算对应精确率的平均，就得到了<strong>平均精确率</strong>也就是 AP，由于我们设置的 IoU 阈值是 0.5，所以写作 AP@0.5，同样的对类别做平均就得到了我们主要的评价指标 mAP@0.5。从几何意义上讲，是在近似计算 P-R 曲线下的面积（也就是 AUC）。</p>
<p>因为一般精确率和召回率是反向变化的，所以这个分数越高，一方面意味着它打框有基本的准确度，但是更意味着模型<strong>在类别预测上</strong>越好。</p>
<p>具体计算见代码。</p>
<h4 id="_15">训练<a class="headerlink" href="#_15" title="Permanent link">¶</a></h4>
<p>下面的代码，主要是在 VOC 07+12 上训练 YOLO v1 (ResNet-18 backbone) 并进行验证和评估。由于 ResNet-18 的参数量小且不是为了目标检测而优化的（因为 Darknet 用上了多尺度卷积核，通道数也更宽从而更适合像 FCN 一样输出 <code>(S, S, 5*B+C)</code> 的“特征图”，其实某种意义上用 VGG 或者 GoogLeNet 都更适合，但是参数量更大），所以只能获得 mAP@0.5 = 0.4723，具体的结果如下：</p>
<p><img alt="alt text" src="../image-34.png"/></p>
<p><img alt="alt text" src="../image-35.png"/></p>
<p>下面给出模型类的定义：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">YOLOv1ResNet18</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>        <span class="n">backbone</span> <span class="o">=</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">ResNet18_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span> <span class="k">if</span> <span class="n">pretrained</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>        <span class="c1"># 下面就是预训练的权重</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stem</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>            <span class="n">backbone</span><span class="o">.</span><span class="n">conv1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">bn1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">maxpool</span><span class="p">,</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>            <span class="n">backbone</span><span class="o">.</span><span class="n">layer1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer2</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer3</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer4</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>        <span class="p">)</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>        <span class="c1"># 扩展到 1024 通道，为输出 (7,7,30) 的张量做准备。 </span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>        <span class="c1"># 由于输出已经是 512@7x7 的了，其实相当于我们准备整合到 30@7x7</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>        <span class="p">)</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>        <span class="n">out_ch</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span> <span class="n">c</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>        <span class="c1"># 双卷积到输出通道，这两部分都没有用上预训练权重，也导致 mAP 比较低</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>        <span class="c1"># Leakly ReLU 和论文一致</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>        <span class="p">)</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># [N,512,14,14]</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   <span class="c1"># [N,1024,7,7]</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># [N,(B*5+C),7,7]</span>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> <span class="c1"># [N,7,7,(B*5+C)]</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a>        <span class="c1"># 这里由于置换了张量维，所以.contiguous()一下让内存连续。</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a>        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
<p>下面是重头戏，我们的损失函数。</p>
<p>代码比较长，因为我具体分析了蛮多细节，因此折叠了一下。</p>
<details>
<summary> YOLO v1 loss 详细的实现 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">  1</a></span>
<span class="normal"><a href="#__codelineno-7-2">  2</a></span>
<span class="normal"><a href="#__codelineno-7-3">  3</a></span>
<span class="normal"><a href="#__codelineno-7-4">  4</a></span>
<span class="normal"><a href="#__codelineno-7-5">  5</a></span>
<span class="normal"><a href="#__codelineno-7-6">  6</a></span>
<span class="normal"><a href="#__codelineno-7-7">  7</a></span>
<span class="normal"><a href="#__codelineno-7-8">  8</a></span>
<span class="normal"><a href="#__codelineno-7-9">  9</a></span>
<span class="normal"><a href="#__codelineno-7-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-7-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-7-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-7-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-7-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-7-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-7-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-7-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-7-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-7-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-7-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-7-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-7-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-7-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-7-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-7-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-7-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-7-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-7-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-7-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-7-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-7-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-7-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-7-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-7-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-7-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-7-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-7-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-7-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-7-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-7-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-7-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-7-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-7-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-7-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-7-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-7-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-7-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-7-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-7-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-7-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-7-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-7-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-7-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-7-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-7-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-7-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-7-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-7-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-7-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-7-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-7-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-7-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-7-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-7-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-7-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-7-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-7-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-7-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-7-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-7-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-7-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-7-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-7-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-7-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-7-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-7-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-7-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-7-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-7-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-7-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-7-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-7-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-7-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-7-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-7-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-7-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-7-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-7-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-7-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-7-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-7-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-7-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-7-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-7-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-7-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-7-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-7-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-7-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-7-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-7-100">100</a></span>
<span class="normal"><a href="#__codelineno-7-101">101</a></span>
<span class="normal"><a href="#__codelineno-7-102">102</a></span>
<span class="normal"><a href="#__codelineno-7-103">103</a></span>
<span class="normal"><a href="#__codelineno-7-104">104</a></span>
<span class="normal"><a href="#__codelineno-7-105">105</a></span>
<span class="normal"><a href="#__codelineno-7-106">106</a></span>
<span class="normal"><a href="#__codelineno-7-107">107</a></span>
<span class="normal"><a href="#__codelineno-7-108">108</a></span>
<span class="normal"><a href="#__codelineno-7-109">109</a></span>
<span class="normal"><a href="#__codelineno-7-110">110</a></span>
<span class="normal"><a href="#__codelineno-7-111">111</a></span>
<span class="normal"><a href="#__codelineno-7-112">112</a></span>
<span class="normal"><a href="#__codelineno-7-113">113</a></span>
<span class="normal"><a href="#__codelineno-7-114">114</a></span>
<span class="normal"><a href="#__codelineno-7-115">115</a></span>
<span class="normal"><a href="#__codelineno-7-116">116</a></span>
<span class="normal"><a href="#__codelineno-7-117">117</a></span>
<span class="normal"><a href="#__codelineno-7-118">118</a></span>
<span class="normal"><a href="#__codelineno-7-119">119</a></span>
<span class="normal"><a href="#__codelineno-7-120">120</a></span>
<span class="normal"><a href="#__codelineno-7-121">121</a></span>
<span class="normal"><a href="#__codelineno-7-122">122</a></span>
<span class="normal"><a href="#__codelineno-7-123">123</a></span>
<span class="normal"><a href="#__codelineno-7-124">124</a></span>
<span class="normal"><a href="#__codelineno-7-125">125</a></span>
<span class="normal"><a href="#__codelineno-7-126">126</a></span>
<span class="normal"><a href="#__codelineno-7-127">127</a></span>
<span class="normal"><a href="#__codelineno-7-128">128</a></span>
<span class="normal"><a href="#__codelineno-7-129">129</a></span>
<span class="normal"><a href="#__codelineno-7-130">130</a></span>
<span class="normal"><a href="#__codelineno-7-131">131</a></span>
<span class="normal"><a href="#__codelineno-7-132">132</a></span>
<span class="normal"><a href="#__codelineno-7-133">133</a></span>
<span class="normal"><a href="#__codelineno-7-134">134</a></span>
<span class="normal"><a href="#__codelineno-7-135">135</a></span>
<span class="normal"><a href="#__codelineno-7-136">136</a></span>
<span class="normal"><a href="#__codelineno-7-137">137</a></span>
<span class="normal"><a href="#__codelineno-7-138">138</a></span>
<span class="normal"><a href="#__codelineno-7-139">139</a></span>
<span class="normal"><a href="#__codelineno-7-140">140</a></span>
<span class="normal"><a href="#__codelineno-7-141">141</a></span>
<span class="normal"><a href="#__codelineno-7-142">142</a></span>
<span class="normal"><a href="#__codelineno-7-143">143</a></span>
<span class="normal"><a href="#__codelineno-7-144">144</a></span>
<span class="normal"><a href="#__codelineno-7-145">145</a></span>
<span class="normal"><a href="#__codelineno-7-146">146</a></span>
<span class="normal"><a href="#__codelineno-7-147">147</a></span>
<span class="normal"><a href="#__codelineno-7-148">148</a></span>
<span class="normal"><a href="#__codelineno-7-149">149</a></span>
<span class="normal"><a href="#__codelineno-7-150">150</a></span>
<span class="normal"><a href="#__codelineno-7-151">151</a></span>
<span class="normal"><a href="#__codelineno-7-152">152</a></span>
<span class="normal"><a href="#__codelineno-7-153">153</a></span>
<span class="normal"><a href="#__codelineno-7-154">154</a></span>
<span class="normal"><a href="#__codelineno-7-155">155</a></span>
<span class="normal"><a href="#__codelineno-7-156">156</a></span>
<span class="normal"><a href="#__codelineno-7-157">157</a></span>
<span class="normal"><a href="#__codelineno-7-158">158</a></span>
<span class="normal"><a href="#__codelineno-7-159">159</a></span>
<span class="normal"><a href="#__codelineno-7-160">160</a></span>
<span class="normal"><a href="#__codelineno-7-161">161</a></span>
<span class="normal"><a href="#__codelineno-7-162">162</a></span>
<span class="normal"><a href="#__codelineno-7-163">163</a></span>
<span class="normal"><a href="#__codelineno-7-164">164</a></span>
<span class="normal"><a href="#__codelineno-7-165">165</a></span>
<span class="normal"><a href="#__codelineno-7-166">166</a></span>
<span class="normal"><a href="#__codelineno-7-167">167</a></span>
<span class="normal"><a href="#__codelineno-7-168">168</a></span>
<span class="normal"><a href="#__codelineno-7-169">169</a></span>
<span class="normal"><a href="#__codelineno-7-170">170</a></span>
<span class="normal"><a href="#__codelineno-7-171">171</a></span>
<span class="normal"><a href="#__codelineno-7-172">172</a></span>
<span class="normal"><a href="#__codelineno-7-173">173</a></span>
<span class="normal"><a href="#__codelineno-7-174">174</a></span>
<span class="normal"><a href="#__codelineno-7-175">175</a></span>
<span class="normal"><a href="#__codelineno-7-176">176</a></span>
<span class="normal"><a href="#__codelineno-7-177">177</a></span>
<span class="normal"><a href="#__codelineno-7-178">178</a></span>
<span class="normal"><a href="#__codelineno-7-179">179</a></span>
<span class="normal"><a href="#__codelineno-7-180">180</a></span>
<span class="normal"><a href="#__codelineno-7-181">181</a></span>
<span class="normal"><a href="#__codelineno-7-182">182</a></span>
<span class="normal"><a href="#__codelineno-7-183">183</a></span>
<span class="normal"><a href="#__codelineno-7-184">184</a></span>
<span class="normal"><a href="#__codelineno-7-185">185</a></span>
<span class="normal"><a href="#__codelineno-7-186">186</a></span>
<span class="normal"><a href="#__codelineno-7-187">187</a></span>
<span class="normal"><a href="#__codelineno-7-188">188</a></span>
<span class="normal"><a href="#__codelineno-7-189">189</a></span>
<span class="normal"><a href="#__codelineno-7-190">190</a></span>
<span class="normal"><a href="#__codelineno-7-191">191</a></span>
<span class="normal"><a href="#__codelineno-7-192">192</a></span>
<span class="normal"><a href="#__codelineno-7-193">193</a></span>
<span class="normal"><a href="#__codelineno-7-194">194</a></span>
<span class="normal"><a href="#__codelineno-7-195">195</a></span>
<span class="normal"><a href="#__codelineno-7-196">196</a></span>
<span class="normal"><a href="#__codelineno-7-197">197</a></span>
<span class="normal"><a href="#__codelineno-7-198">198</a></span>
<span class="normal"><a href="#__codelineno-7-199">199</a></span>
<span class="normal"><a href="#__codelineno-7-200">200</a></span>
<span class="normal"><a href="#__codelineno-7-201">201</a></span>
<span class="normal"><a href="#__codelineno-7-202">202</a></span>
<span class="normal"><a href="#__codelineno-7-203">203</a></span>
<span class="normal"><a href="#__codelineno-7-204">204</a></span>
<span class="normal"><a href="#__codelineno-7-205">205</a></span>
<span class="normal"><a href="#__codelineno-7-206">206</a></span>
<span class="normal"><a href="#__codelineno-7-207">207</a></span>
<span class="normal"><a href="#__codelineno-7-208">208</a></span>
<span class="normal"><a href="#__codelineno-7-209">209</a></span>
<span class="normal"><a href="#__codelineno-7-210">210</a></span>
<span class="normal"><a href="#__codelineno-7-211">211</a></span>
<span class="normal"><a href="#__codelineno-7-212">212</a></span>
<span class="normal"><a href="#__codelineno-7-213">213</a></span>
<span class="normal"><a href="#__codelineno-7-214">214</a></span>
<span class="normal"><a href="#__codelineno-7-215">215</a></span>
<span class="normal"><a href="#__codelineno-7-216">216</a></span>
<span class="normal"><a href="#__codelineno-7-217">217</a></span>
<span class="normal"><a href="#__codelineno-7-218">218</a></span>
<span class="normal"><a href="#__codelineno-7-219">219</a></span>
<span class="normal"><a href="#__codelineno-7-220">220</a></span>
<span class="normal"><a href="#__codelineno-7-221">221</a></span>
<span class="normal"><a href="#__codelineno-7-222">222</a></span>
<span class="normal"><a href="#__codelineno-7-223">223</a></span>
<span class="normal"><a href="#__codelineno-7-224">224</a></span>
<span class="normal"><a href="#__codelineno-7-225">225</a></span>
<span class="normal"><a href="#__codelineno-7-226">226</a></span>
<span class="normal"><a href="#__codelineno-7-227">227</a></span>
<span class="normal"><a href="#__codelineno-7-228">228</a></span>
<span class="normal"><a href="#__codelineno-7-229">229</a></span>
<span class="normal"><a href="#__codelineno-7-230">230</a></span>
<span class="normal"><a href="#__codelineno-7-231">231</a></span>
<span class="normal"><a href="#__codelineno-7-232">232</a></span>
<span class="normal"><a href="#__codelineno-7-233">233</a></span>
<span class="normal"><a href="#__codelineno-7-234">234</a></span>
<span class="normal"><a href="#__codelineno-7-235">235</a></span>
<span class="normal"><a href="#__codelineno-7-236">236</a></span>
<span class="normal"><a href="#__codelineno-7-237">237</a></span>
<span class="normal"><a href="#__codelineno-7-238">238</a></span>
<span class="normal"><a href="#__codelineno-7-239">239</a></span>
<span class="normal"><a href="#__codelineno-7-240">240</a></span>
<span class="normal"><a href="#__codelineno-7-241">241</a></span>
<span class="normal"><a href="#__codelineno-7-242">242</a></span>
<span class="normal"><a href="#__codelineno-7-243">243</a></span>
<span class="normal"><a href="#__codelineno-7-244">244</a></span>
<span class="normal"><a href="#__codelineno-7-245">245</a></span>
<span class="normal"><a href="#__codelineno-7-246">246</a></span>
<span class="normal"><a href="#__codelineno-7-247">247</a></span>
<span class="normal"><a href="#__codelineno-7-248">248</a></span>
<span class="normal"><a href="#__codelineno-7-249">249</a></span>
<span class="normal"><a href="#__codelineno-7-250">250</a></span>
<span class="normal"><a href="#__codelineno-7-251">251</a></span>
<span class="normal"><a href="#__codelineno-7-252">252</a></span>
<span class="normal"><a href="#__codelineno-7-253">253</a></span>
<span class="normal"><a href="#__codelineno-7-254">254</a></span>
<span class="normal"><a href="#__codelineno-7-255">255</a></span>
<span class="normal"><a href="#__codelineno-7-256">256</a></span>
<span class="normal"><a href="#__codelineno-7-257">257</a></span>
<span class="normal"><a href="#__codelineno-7-258">258</a></span>
<span class="normal"><a href="#__codelineno-7-259">259</a></span>
<span class="normal"><a href="#__codelineno-7-260">260</a></span>
<span class="normal"><a href="#__codelineno-7-261">261</a></span>
<span class="normal"><a href="#__codelineno-7-262">262</a></span>
<span class="normal"><a href="#__codelineno-7-263">263</a></span>
<span class="normal"><a href="#__codelineno-7-264">264</a></span>
<span class="normal"><a href="#__codelineno-7-265">265</a></span>
<span class="normal"><a href="#__codelineno-7-266">266</a></span>
<span class="normal"><a href="#__codelineno-7-267">267</a></span>
<span class="normal"><a href="#__codelineno-7-268">268</a></span>
<span class="normal"><a href="#__codelineno-7-269">269</a></span>
<span class="normal"><a href="#__codelineno-7-270">270</a></span>
<span class="normal"><a href="#__codelineno-7-271">271</a></span>
<span class="normal"><a href="#__codelineno-7-272">272</a></span>
<span class="normal"><a href="#__codelineno-7-273">273</a></span>
<span class="normal"><a href="#__codelineno-7-274">274</a></span>
<span class="normal"><a href="#__codelineno-7-275">275</a></span>
<span class="normal"><a href="#__codelineno-7-276">276</a></span>
<span class="normal"><a href="#__codelineno-7-277">277</a></span>
<span class="normal"><a href="#__codelineno-7-278">278</a></span>
<span class="normal"><a href="#__codelineno-7-279">279</a></span>
<span class="normal"><a href="#__codelineno-7-280">280</a></span>
<span class="normal"><a href="#__codelineno-7-281">281</a></span>
<span class="normal"><a href="#__codelineno-7-282">282</a></span>
<span class="normal"><a href="#__codelineno-7-283">283</a></span>
<span class="normal"><a href="#__codelineno-7-284">284</a></span>
<span class="normal"><a href="#__codelineno-7-285">285</a></span>
<span class="normal"><a href="#__codelineno-7-286">286</a></span>
<span class="normal"><a href="#__codelineno-7-287">287</a></span>
<span class="normal"><a href="#__codelineno-7-288">288</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">YoloV1Loss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">lambda_coord</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">lambda_noobj</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>                 <span class="n">ignore_iou_thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cls_label_smooth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>        <span class="c1"># 定义 YOLO v1 损失函数的超参数</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>        <span class="c1"># S 表示网格的尺寸，即将图像划分为 S×S 个格子</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>        <span class="c1"># 坐标损失的权重系数，用于增强坐标预测的重要性</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_coord</span> <span class="o">=</span> <span class="n">lambda_coord</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>        <span class="c1"># 无目标置信度损失的权重系数，用于降低背景预测的权重</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_noobj</span> <span class="o">=</span> <span class="n">lambda_noobj</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>        <span class="c1"># IoU 忽略阈值，虽然原始的 YOLO 损失没有，但是下面会用到的神奇妙妙参数</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_iou_thresh</span> <span class="o">=</span> <span class="n">ignore_iou_thresh</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>        <span class="c1"># 分类标签平滑系数，用于防止过拟合</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cls_label_smooth</span> <span class="o">=</span> <span class="n">cls_label_smooth</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="sd">        前向传播函数，计算 YOLO v1 的总损失及各个组成部分的损失值。</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="sd">        pred: 网络输出的预测张量，形状为 [N, S, S, B*5+C]</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="sd">        target: 真实标签张量，形状为 [N, S, S, 5+C]，包含归一化的中心坐标、宽高、置信度和类别 one-hot 编码</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="sd">        """</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>        <span class="c1"># 获取批量大小 (N)、网格尺寸 (S)、每个格子的预测框数量 (B) 和类别数量 (C)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>        <span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a>        <span class="c1"># 将预测张量重塑为 [N, S, S, B*5 + C] 的形状</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a>        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>        <span class="c1"># 提取预测框部分并重塑为 [N, S, S, B, 5]，包含每个预测框的 (x, y, w, h, conf) 原始值</span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a>        <span class="n">pred_boxes</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="n">B</span><span class="o">*</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a>        <span class="c1"># 提取类别预测部分，形状为 [N, S, S, C]</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a>        <span class="n">pred_cls_logits</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">B</span><span class="o">*</span><span class="mi">5</span><span class="p">:]</span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a>        <span class="c1"># 从目标张量中提取真实边界框的坐标、置信度和类别信息</span>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a>        <span class="c1"># t_xywh 包含归一化的中心坐标和宽高，形状为 [N, S, S, 4]</span>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a>        <span class="n">t_xywh</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a>        <span class="c1"># t_obj 表示每个格子是否存在目标，形状为 [N, S, S]</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a>        <span class="c1"># 这个就对应原论文的 1^obj_i</span>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a>        <span class="n">t_obj</span>  <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-7-41" name="__codelineno-7-41"></a>        <span class="c1"># t_cls 表示每个格子的类别 one-hot 编码，形状为 [N, S, S, C]</span>
<a id="__codelineno-7-42" name="__codelineno-7-42"></a>        <span class="n">t_cls</span>  <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">5</span><span class="p">:]</span>
<a id="__codelineno-7-43" name="__codelineno-7-43"></a>
<a id="__codelineno-7-44" name="__codelineno-7-44"></a>        <span class="c1"># 生成网格坐标，用于将预测的相对坐标转换为绝对坐标</span>
<a id="__codelineno-7-45" name="__codelineno-7-45"></a>        <span class="c1"># 创建 [0, 1, ..., S-1] 的序列，表示网格的索引</span>
<a id="__codelineno-7-46" name="__codelineno-7-46"></a>        <span class="n">gxv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-7-47" name="__codelineno-7-47"></a>        <span class="n">gyv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-7-48" name="__codelineno-7-48"></a>        <span class="c1"># 生成网格的 x 和 y 坐标矩阵，形状均为 [S, S]</span>
<a id="__codelineno-7-49" name="__codelineno-7-49"></a>        <span class="n">gy</span><span class="p">,</span> <span class="n">gx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">gyv</span><span class="p">,</span> <span class="n">gxv</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">'ij'</span><span class="p">)</span>
<a id="__codelineno-7-50" name="__codelineno-7-50"></a>        <span class="c1"># 扩展维度以便后续广播操作，形状变为 [1, S, S, 1]</span>
<a id="__codelineno-7-51" name="__codelineno-7-51"></a>        <span class="n">gx</span> <span class="o">=</span> <span class="n">gx</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-7-52" name="__codelineno-7-52"></a>        <span class="n">gy</span> <span class="o">=</span> <span class="n">gy</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-7-53" name="__codelineno-7-53"></a>
<a id="__codelineno-7-54" name="__codelineno-7-54"></a>        <span class="c1"># 对预测的边界框参数进行解码和激活</span>
<a id="__codelineno-7-55" name="__codelineno-7-55"></a>        <span class="c1"># 使用 sigmoid 函数将 x 和 y 的预测值约束到 [0,1] 范围内，表示相对于格子左上角的偏移</span>
<a id="__codelineno-7-56" name="__codelineno-7-56"></a>        <span class="n">px</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-7-57" name="__codelineno-7-57"></a>        <span class="n">py</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-7-58" name="__codelineno-7-58"></a>        <span class="c1"># 使用 softplus 激活函数处理宽高预测值，然后平方并裁剪到 [1e-6, 1.0] 范围内，确保数值稳定性</span>
<a id="__codelineno-7-59" name="__codelineno-7-59"></a>        <span class="c1"># 这里使用 softplus 加上平方是为了确保宽高为正值，并且抑制特别大的框</span>
<a id="__codelineno-7-60" name="__codelineno-7-60"></a>        <span class="c1"># 具体来说，softplus 函数可以平滑地将负值映射到正值（softplus(x)=log(1+exp(x))），而平方操作则进一步放大了小值的影响</span>
<a id="__codelineno-7-61" name="__codelineno-7-61"></a>        <span class="c1"># 实践下来，这样处理的效果会更好一些</span>
<a id="__codelineno-7-62" name="__codelineno-7-62"></a>        <span class="n">pw</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-63" name="__codelineno-7-63"></a>        <span class="n">ph</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-64" name="__codelineno-7-64"></a>        <span class="c1"># 使用 sigmoid 函数将置信度预测值约束到 [0,1] 范围内</span>
<a id="__codelineno-7-65" name="__codelineno-7-65"></a>        <span class="n">pconf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<a id="__codelineno-7-66" name="__codelineno-7-66"></a>        <span class="c1"># 现在，我们就得到了每一个预测框的中心坐标 (px, py), 宽高 (pw, ph) 和置信度 pconf</span>
<a id="__codelineno-7-67" name="__codelineno-7-67"></a>        <span class="c1"># 这里预测的 (px, py) 是相对于格子左上角的偏移，(pw, ph) 是经过特殊处理的宽高</span>
<a id="__codelineno-7-68" name="__codelineno-7-68"></a>        <span class="c1"># 它们都是相对于输入图像尺寸归一化的值</span>
<a id="__codelineno-7-69" name="__codelineno-7-69"></a>
<a id="__codelineno-7-70" name="__codelineno-7-70"></a>        <span class="c1"># 将预测的相对坐标转换为绝对坐标</span>
<a id="__codelineno-7-71" name="__codelineno-7-71"></a>        <span class="c1"># 相对坐标就是相对于【格子】左上角的偏移</span>
<a id="__codelineno-7-72" name="__codelineno-7-72"></a>        <span class="c1"># 绝对坐标是相对于【整个图像】的左上角的偏移，还要除以 S 进行归一化</span>
<a id="__codelineno-7-73" name="__codelineno-7-73"></a>        <span class="c1">#</span>
<a id="__codelineno-7-74" name="__codelineno-7-74"></a>        <span class="c1"># -----------------------------------------------</span>
<a id="__codelineno-7-75" name="__codelineno-7-75"></a>        <span class="c1"># </span>
<a id="__codelineno-7-76" name="__codelineno-7-76"></a>        <span class="c1"># 这里的坐标转换过程比较复杂，值得详细解释一下：</span>
<a id="__codelineno-7-77" name="__codelineno-7-77"></a>        <span class="c1"># 计算预测框的中心点绝对坐标，通过将格子索引加上偏移量并除以网格尺寸进行归一化</span>
<a id="__codelineno-7-78" name="__codelineno-7-78"></a>        <span class="c1"># px 的形状为 [N, S, S, B]，gx 的形状为 [1, S, S, 1]，通过广播机制进行加法</span>
<a id="__codelineno-7-79" name="__codelineno-7-79"></a>        <span class="c1"># 这个机制的操作过程具体是：gx 在第一个维度上面复制 N 份，在最后一个维度上复制 B 份</span>
<a id="__codelineno-7-80" name="__codelineno-7-80"></a>        <span class="c1"># 这样 gx 的形状就变成了 [N, S, S, B]，然后就可以和 px 每个位置对齐相加了</span>
<a id="__codelineno-7-81" name="__codelineno-7-81"></a>        <span class="c1"># 这一套操作下来，其实就是从一开始的一维 [S] 的向量 gxv，通过 meshgrid 在第二个维度上复制 S 份</span>
<a id="__codelineno-7-82" name="__codelineno-7-82"></a>        <span class="c1"># 变成了二维的 [S, S] 矩阵 gx，再分别添加两个维度并复制 N 和 B 份，变成了 [N, S, S, B] 的广播后张量</span>
<a id="__codelineno-7-83" name="__codelineno-7-83"></a>        <span class="c1"># 最后和 px 相加，得到每个预测框的绝对中心坐标</span>
<a id="__codelineno-7-84" name="__codelineno-7-84"></a>        <span class="n">pcx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gx</span> <span class="o">+</span> <span class="n">px</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-7-85" name="__codelineno-7-85"></a>        <span class="c1"># 对 y 坐标同理，最后除以 S 进行归一化</span>
<a id="__codelineno-7-86" name="__codelineno-7-86"></a>        <span class="n">pcy</span> <span class="o">=</span> <span class="p">(</span><span class="n">gy</span> <span class="o">+</span> <span class="n">py</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-7-87" name="__codelineno-7-87"></a>        <span class="c1"># 组合预测框的中心坐标和宽高，形状为 [N, S, S, B, 4]</span>
<a id="__codelineno-7-88" name="__codelineno-7-88"></a>        <span class="c1"># dim =-1 表示在最后一个维度上进行堆叠</span>
<a id="__codelineno-7-89" name="__codelineno-7-89"></a>        <span class="n">p_cxcywh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">pcx</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">pcy</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">pw</span><span class="p">,</span> <span class="n">ph</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-90" name="__codelineno-7-90"></a>        <span class="c1"># 将 (cx, cy, w, h) 格式的边界框转换为 (x1, y1, x2, y2) 格式，并裁剪到 [0,1] 范围内</span>
<a id="__codelineno-7-91" name="__codelineno-7-91"></a>        <span class="n">p_xyxy</span> <span class="o">=</span> <span class="n">cxcywh_to_xyxy</span><span class="p">(</span><span class="n">p_cxcywh</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-92" name="__codelineno-7-92"></a>        <span class="c1"># 现在，我们就得到了每一个预测框的绝对坐标 p_xyxy，形状为 [N, S, S, B, 4]</span>
<a id="__codelineno-7-93" name="__codelineno-7-93"></a>
<a id="__codelineno-7-94" name="__codelineno-7-94"></a>        <span class="c1"># 对真实边界框坐标进行解码和归一化处理</span>
<a id="__codelineno-7-95" name="__codelineno-7-95"></a>        <span class="c1"># 从目标张量中提取真实边界框的 (x, y, w, h) 坐标</span>
<a id="__codelineno-7-96" name="__codelineno-7-96"></a>        <span class="c1"># 这里 tw, th 使用 clamp 限制在 [1e-6, 1.0] 范围内，防止数值不稳定</span>
<a id="__codelineno-7-97" name="__codelineno-7-97"></a>        <span class="c1"># tx 的形状为 [N, S, S, 1]，与 gx 形状兼容，其他类似</span>
<a id="__codelineno-7-98" name="__codelineno-7-98"></a>        <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tw</span><span class="p">,</span> <span class="n">th</span> <span class="o">=</span> <span class="n">t_xywh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_xywh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">t_xywh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">t_xywh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-99" name="__codelineno-7-99"></a>        <span class="c1"># 计算真实边界框的中心坐标 (tcx, tcy)，通过将格子索引加上偏移量并除以网格尺寸进行归一化</span>
<a id="__codelineno-7-100" name="__codelineno-7-100"></a>        <span class="c1"># 这里 gx.squeeze(-1) 是把最后一个维度挤掉，变成 [1, S, S] 的形状</span>
<a id="__codelineno-7-101" name="__codelineno-7-101"></a>        <span class="c1"># 这个时候你就要问了，为什么不直接用 gx 和 gy 呢？当然可以！广播机制和之前完全一样。</span>
<a id="__codelineno-7-102" name="__codelineno-7-102"></a>        <span class="c1"># 这里保留是因为这个代码不是我写的，我猜测gpt是为了让形状更清晰一些</span>
<a id="__codelineno-7-103" name="__codelineno-7-103"></a>        <span class="c1"># 然后通过广播机制和 tx 的形状 [N, S, S, 1] 进行相加后再进行归一化，具体机制同上</span>
<a id="__codelineno-7-104" name="__codelineno-7-104"></a>        <span class="n">tcx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gx</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">tx</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-7-105" name="__codelineno-7-105"></a>        <span class="n">tcy</span> <span class="o">=</span> <span class="p">(</span><span class="n">gy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ty</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-7-106" name="__codelineno-7-106"></a>        <span class="c1"># 将中心坐标和宽高组合成 (tcx, tcy, tw, th) 格式，形状为 [N, S, S, 4]</span>
<a id="__codelineno-7-107" name="__codelineno-7-107"></a>        <span class="n">t_cxcywh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">tcx</span><span class="p">,</span><span class="n">tcy</span><span class="p">,</span><span class="n">tw</span><span class="p">,</span><span class="n">th</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-108" name="__codelineno-7-108"></a>        <span class="c1"># 将 (tcx, tcy, tw, th) 转换为 (x1, y1, x2, y2) 格式，并裁剪到 [0, 1] 范围内</span>
<a id="__codelineno-7-109" name="__codelineno-7-109"></a>        <span class="n">t_xyxy</span> <span class="o">=</span> <span class="n">cxcywh_to_xyxy</span><span class="p">(</span><span class="n">t_cxcywh</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-110" name="__codelineno-7-110"></a>        <span class="c1"># 现在，我们就得到了每一个真实框的绝对坐标 t_xyxy，形状为 [N, S, S, 4]</span>
<a id="__codelineno-7-111" name="__codelineno-7-111"></a>
<a id="__codelineno-7-112" name="__codelineno-7-112"></a>        <span class="c1"># 下面，就可以计算框的损失了。</span>
<a id="__codelineno-7-113" name="__codelineno-7-113"></a>
<a id="__codelineno-7-114" name="__codelineno-7-114"></a>        <span class="c1"># 计算每个预测框与对应格子中真实框的 IoU</span>
<a id="__codelineno-7-115" name="__codelineno-7-115"></a>        <span class="c1"># 扩展真实框张量以便与每个预测框计算 IoU，形状变为 [N, S, S, B, 4]</span>
<a id="__codelineno-7-116" name="__codelineno-7-116"></a>        <span class="c1"># 这一行代码的操作是把 t_xyxy 在最后一个维度上面添加一个维度，然后在这个维度上复制 B 份</span>
<a id="__codelineno-7-117" name="__codelineno-7-117"></a>        <span class="c1"># 这样 t_xyxy_exp 的形状就变成了 [N, S, S, B, 4]，然后就可以和 p_xyxy 每个位置对齐计算 IoU 了</span>
<a id="__codelineno-7-118" name="__codelineno-7-118"></a>        <span class="n">t_xyxy_exp</span> <span class="o">=</span> <span class="n">t_xyxy</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-119" name="__codelineno-7-119"></a>        <span class="c1"># 计算所有预测框与对应真实框的 IoU，形状为 [N, S, S, B]</span>
<a id="__codelineno-7-120" name="__codelineno-7-120"></a>        <span class="n">iou_all</span> <span class="o">=</span> <span class="n">iou_xyxy_aligned</span><span class="p">(</span><span class="n">p_xyxy</span><span class="p">,</span> <span class="n">t_xyxy_exp</span><span class="p">)</span>
<a id="__codelineno-7-121" name="__codelineno-7-121"></a>
<a id="__codelineno-7-122" name="__codelineno-7-122"></a>        <span class="c1"># 下面我们要根据 iou_all 来决定哪些框负责预测，哪些框不负责预测</span>
<a id="__codelineno-7-123" name="__codelineno-7-123"></a>
<a id="__codelineno-7-124" name="__codelineno-7-124"></a>        <span class="c1"># 构建负责预测的掩码，用于标识每个格子中与真实框 IoU 最大的预测框</span>
<a id="__codelineno-7-125" name="__codelineno-7-125"></a>        <span class="c1"># obj_cells 表示存在目标的格子，形状为 [N, S, S]</span>
<a id="__codelineno-7-126" name="__codelineno-7-126"></a>        <span class="c1"># 这个就是论文中的 1^obj_i</span>
<a id="__codelineno-7-127" name="__codelineno-7-127"></a>        <span class="n">obj_cells</span> <span class="o">=</span> <span class="n">t_obj</span>
<a id="__codelineno-7-128" name="__codelineno-7-128"></a>        <span class="c1"># 将无目标格子的 IoU 设置为 -1，以便后续处理，形状是 [N, S, S, B]</span>
<a id="__codelineno-7-129" name="__codelineno-7-129"></a>        <span class="n">iou_all_masked</span> <span class="o">=</span> <span class="n">iou_all</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">obj_cells</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-130" name="__codelineno-7-130"></a>        <span class="c1"># 获取每个格子中 IoU 最大的预测框索引，形状为 [N, S, S]</span>
<a id="__codelineno-7-131" name="__codelineno-7-131"></a>        <span class="n">best_box_idx</span> <span class="o">=</span> <span class="n">iou_all_masked</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-132" name="__codelineno-7-132"></a>        <span class="c1"># 构建负责预测的掩码，形状为 [N, S, S, B]，其中负责预测的框位置为 1，其余为 0</span>
<a id="__codelineno-7-133" name="__codelineno-7-133"></a>        <span class="c1"># 这个就是论文中的 1^obj_ij</span>
<a id="__codelineno-7-134" name="__codelineno-7-134"></a>        <span class="n">resp_mask</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">best_box_idx</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="n">obj_cells</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-135" name="__codelineno-7-135"></a>
<a id="__codelineno-7-136" name="__codelineno-7-136"></a>        <span class="c1"># 计算坐标损失，包括中心点坐标和宽高的损失</span>
<a id="__codelineno-7-137" name="__codelineno-7-137"></a>        <span class="c1"># 对宽高取平方根以平衡大小框的损失贡献</span>
<a id="__codelineno-7-138" name="__codelineno-7-138"></a>        <span class="c1"># 这一部分对应的 L_coord 和 L_size</span>
<a id="__codelineno-7-139" name="__codelineno-7-139"></a>        <span class="c1"># w,h 的形状均为 [N, S, S, B]，但其实有意义的只有负责预测的框，也就是 IoU 最大的那个框</span>
<a id="__codelineno-7-140" name="__codelineno-7-140"></a>        <span class="c1"># 相当于这部分计算里面 (B-1)/B 的部分是没有意义的</span>
<a id="__codelineno-7-141" name="__codelineno-7-141"></a>        <span class="c1"># 但是由于后面乘上了 resp_mask，所以这些无意义的部分损失直接置零了，梯度不会回传</span>
<a id="__codelineno-7-142" name="__codelineno-7-142"></a>        <span class="c1"># 这个时候你就要问了，为什么不来个 for-if 来避免计算这些无意义的部分呢？</span>
<a id="__codelineno-7-143" name="__codelineno-7-143"></a>        <span class="c1"># 这样做的原因是，for-if 会导致计算图断裂，没法子求导了，而且逐元素分支预测慢死……</span>
<a id="__codelineno-7-144" name="__codelineno-7-144"></a>        <span class="c1"># 反观计算这些无意义的部分也不会特别影响效率，毕竟 B 一般都比较小，而且可以数据并行计算</span>
<a id="__codelineno-7-145" name="__codelineno-7-145"></a>        <span class="c1"># 这里加上一个很小的数值 1e-6 还是为了防止数值不稳定</span>
<a id="__codelineno-7-146" name="__codelineno-7-146"></a>        <span class="n">sqrt_pw</span><span class="p">,</span> <span class="n">sqrt_ph</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pw</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ph</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
<a id="__codelineno-7-147" name="__codelineno-7-147"></a>        <span class="n">sqrt_tw</span><span class="p">,</span> <span class="n">sqrt_th</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tw</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">th</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
<a id="__codelineno-7-148" name="__codelineno-7-148"></a>        <span class="c1"># 计算中心点 x 坐标的损失，仅对负责预测的框计算</span>
<a id="__codelineno-7-149" name="__codelineno-7-149"></a>        <span class="n">coord_x_loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">px</span> <span class="o">-</span> <span class="n">tx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resp_mask</span>
<a id="__codelineno-7-150" name="__codelineno-7-150"></a>        <span class="c1"># 计算中心点 y 坐标的损失，仅对负责预测的框计算</span>
<a id="__codelineno-7-151" name="__codelineno-7-151"></a>        <span class="n">coord_y_loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">py</span> <span class="o">-</span> <span class="n">ty</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resp_mask</span>
<a id="__codelineno-7-152" name="__codelineno-7-152"></a>        <span class="c1"># 计算宽度的损失，使用平方根处理后的值</span>
<a id="__codelineno-7-153" name="__codelineno-7-153"></a>        <span class="n">coord_w_loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">sqrt_pw</span> <span class="o">-</span> <span class="n">sqrt_tw</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resp_mask</span>
<a id="__codelineno-7-154" name="__codelineno-7-154"></a>        <span class="c1"># 计算高度的损失，使用平方根处理后的值</span>
<a id="__codelineno-7-155" name="__codelineno-7-155"></a>        <span class="n">coord_h_loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">sqrt_ph</span> <span class="o">-</span> <span class="n">sqrt_th</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resp_mask</span>
<a id="__codelineno-7-156" name="__codelineno-7-156"></a>
<a id="__codelineno-7-157" name="__codelineno-7-157"></a>        <span class="c1"># 计算有目标置信度损失，目标值为预测框与真实框的 IoU，对应 L_P</span>
<a id="__codelineno-7-158" name="__codelineno-7-158"></a>        <span class="c1"># 那你就要问了，这 IoU 又不可导了，怎么办？</span>
<a id="__codelineno-7-159" name="__codelineno-7-159"></a>        <span class="c1"># 其实也没事，因为我们只是用它来作为一个常数目标值，又不是真的要优化它</span>
<a id="__codelineno-7-160" name="__codelineno-7-160"></a>        <span class="c1"># 反而，我们还需要使用 detach 来防止梯度回传</span>
<a id="__codelineno-7-161" name="__codelineno-7-161"></a>        <span class="n">iou_target</span> <span class="o">=</span> <span class="n">iou_all</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-7-162" name="__codelineno-7-162"></a>        <span class="c1"># 计算有目标置信度损失，仅对负责预测的框计算</span>
<a id="__codelineno-7-163" name="__codelineno-7-163"></a>        <span class="n">conf_obj_terms</span> <span class="o">=</span> <span class="p">((</span><span class="n">pconf</span> <span class="o">-</span> <span class="n">iou_target</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">resp_mask</span>
<a id="__codelineno-7-164" name="__codelineno-7-164"></a>
<a id="__codelineno-7-165" name="__codelineno-7-165"></a>        <span class="c1"># 构建无目标掩码，包括非负责预测框和纯粹无目标的格子，对应 L_N</span>
<a id="__codelineno-7-166" name="__codelineno-7-166"></a>        <span class="c1"># 非负责预测框掩码：存在目标的格子中不负责预测的框</span>
<a id="__codelineno-7-167" name="__codelineno-7-167"></a>        <span class="c1"># 这个就是论文中的 1^noobj_ij</span>
<a id="__codelineno-7-168" name="__codelineno-7-168"></a>        <span class="n">not_resp_mask</span> <span class="o">=</span> <span class="n">obj_cells</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">resp_mask</span><span class="p">)</span>
<a id="__codelineno-7-169" name="__codelineno-7-169"></a>        <span class="c1"># 纯粹无目标格子掩码：不存在目标的格子中的所有预测框</span>
<a id="__codelineno-7-170" name="__codelineno-7-170"></a>        <span class="c1"># 类比一下可以叫做 1^noobj_i</span>
<a id="__codelineno-7-171" name="__codelineno-7-171"></a>        <span class="n">noobj_cells_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">obj_cells</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">pconf</span><span class="p">)</span>
<a id="__codelineno-7-172" name="__codelineno-7-172"></a>
<a id="__codelineno-7-173" name="__codelineno-7-173"></a>        <span class="c1"># 构建忽略掩码，用于处理与真实框 IoU 较高的无目标预测框</span>
<a id="__codelineno-7-174" name="__codelineno-7-174"></a>        <span class="c1"># 在 YOLO 训练中，有些预测框与真实框的 IoU 较高但并不是负责预测的框</span>
<a id="__codelineno-7-175" name="__codelineno-7-175"></a>        <span class="c1"># 这些框不应该被惩罚为无目标，因为它们的预测实际上"接近"某个真实目标</span>
<a id="__codelineno-7-176" name="__codelineno-7-176"></a>        <span class="c1"># 我们不能否定它们的努力，因此使用 ignore_iou_thresh 作为阈值来识别这些框</span>
<a id="__codelineno-7-177" name="__codelineno-7-177"></a>        <span class="n">ignore_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pconf</span><span class="p">)</span>
<a id="__codelineno-7-178" name="__codelineno-7-178"></a>        <span class="c1"># 使用 torch.no_grad() 确保在这个计算过程中不生成梯度</span>
<a id="__codelineno-7-179" name="__codelineno-7-179"></a>        <span class="c1"># 因为我们只是用它来构建一个掩码，来进行选择性的损失计算和梯度回传</span>
<a id="__codelineno-7-180" name="__codelineno-7-180"></a>        <span class="c1"># 掩码本身不需要梯度，而且里面涉及到的 argmax 也是不可导的</span>
<a id="__codelineno-7-181" name="__codelineno-7-181"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-7-182" name="__codelineno-7-182"></a>            <span class="c1"># 遍历批次中的每个样本</span>
<a id="__codelineno-7-183" name="__codelineno-7-183"></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<a id="__codelineno-7-184" name="__codelineno-7-184"></a>                <span class="c1"># 获取当前样本中存在目标的网格位置的掩码，形状为 [S, S]</span>
<a id="__codelineno-7-185" name="__codelineno-7-185"></a>                <span class="c1"># 这里的机制是 obj_cells[n] 是 [S, S] 的张量</span>
<a id="__codelineno-7-186" name="__codelineno-7-186"></a>                <span class="c1"># obj_cells[n] &gt; 0 会得到一个布尔张量，形状也是 [S, S]</span>
<a id="__codelineno-7-187" name="__codelineno-7-187"></a>                <span class="c1"># 这个布尔张量表示哪些格子是有目标的</span>
<a id="__codelineno-7-188" name="__codelineno-7-188"></a>                <span class="n">obj_mask_n</span> <span class="o">=</span> <span class="n">obj_cells</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-7-189" name="__codelineno-7-189"></a>                <span class="c1"># 提取当前样本中所有真实框的坐标</span>
<a id="__codelineno-7-190" name="__codelineno-7-190"></a>                <span class="c1"># 由于 t_xyxy[n] 是 [S, S, 4] 的张量，所以可以直接索引</span>
<a id="__codelineno-7-191" name="__codelineno-7-191"></a>                <span class="c1"># 那你就要问了，gt_n 的形状是 [S, S, 4] 吗？</span>
<a id="__codelineno-7-192" name="__codelineno-7-192"></a>                <span class="c1"># 不是的，因为 obj_mask_n 是布尔索引，所以会把所有为 True 的位置都提取出来</span>
<a id="__codelineno-7-193" name="__codelineno-7-193"></a>                <span class="c1"># 单独放进第一个维度，所以最终 gt_n 的形状是 [num_gt, 4]，其中 num_gt 是当前样本中真实框的数量</span>
<a id="__codelineno-7-194" name="__codelineno-7-194"></a>                <span class="n">gt_n</span> <span class="o">=</span> <span class="n">t_xyxy</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">obj_mask_n</span><span class="p">]</span>
<a id="__codelineno-7-195" name="__codelineno-7-195"></a>                <span class="c1"># 将当前样本的所有预测框重塑为 [S*S*B, 4] 的形状</span>
<a id="__codelineno-7-196" name="__codelineno-7-196"></a>                <span class="c1"># .reshape(-1, 4) 会将 [S, S, B, 4] 变成 [S*S*B, 4]</span>
<a id="__codelineno-7-197" name="__codelineno-7-197"></a>                <span class="c1"># -1 就是让前面的维度都堆在一起</span>
<a id="__codelineno-7-198" name="__codelineno-7-198"></a>                <span class="n">pred_n</span> <span class="o">=</span> <span class="n">p_xyxy</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-7-199" name="__codelineno-7-199"></a>                <span class="c1"># 检查当前样本中是否存在真实框</span>
<a id="__codelineno-7-200" name="__codelineno-7-200"></a>                <span class="c1"># .numel() 会返回张量中元素的总数量</span>
<a id="__codelineno-7-201" name="__codelineno-7-201"></a>                <span class="k">if</span> <span class="n">gt_n</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-7-202" name="__codelineno-7-202"></a>                    <span class="c1"># 如果没有真实框，所有预测框的最大 IoU 设为 0</span>
<a id="__codelineno-7-203" name="__codelineno-7-203"></a>                    <span class="n">max_iou</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred_n</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-204" name="__codelineno-7-204"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-205" name="__codelineno-7-205"></a>                    <span class="c1"># 计算所有预测框与所有真实框的 IoU，得到 [num_pred, num_gt] 的 IoU 矩阵</span>
<a id="__codelineno-7-206" name="__codelineno-7-206"></a>                    <span class="n">ious</span> <span class="o">=</span> <span class="n">box_iou_xyxy</span><span class="p">(</span><span class="n">pred_n</span><span class="p">,</span> <span class="n">gt_n</span><span class="p">)</span>
<a id="__codelineno-7-207" name="__codelineno-7-207"></a>                    <span class="c1"># 获取每个预测框与所有真实框的最大 IoU [num_pred]</span>
<a id="__codelineno-7-208" name="__codelineno-7-208"></a>                    <span class="n">max_iou</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-7-209" name="__codelineno-7-209"></a>                <span class="c1"># 将最大 IoU 超过阈值的预测框标记为忽略 (1.0)，否则为 0</span>
<a id="__codelineno-7-210" name="__codelineno-7-210"></a>                <span class="c1"># 也就是我们只需要对那些 IoU 较低的预测框计算无目标损失 L_N</span>
<a id="__codelineno-7-211" name="__codelineno-7-211"></a>                <span class="c1"># 其他框我们就忽略掉，不计算损失，肯定它们的劳动成果</span>
<a id="__codelineno-7-212" name="__codelineno-7-212"></a>                <span class="c1"># 然后将标记重塑为 [S, S, B] 的形状，与 ignore_mask 的当前样本形状匹配</span>
<a id="__codelineno-7-213" name="__codelineno-7-213"></a>                <span class="n">ign</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_iou</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_iou_thresh</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
<a id="__codelineno-7-214" name="__codelineno-7-214"></a>                <span class="c1"># 将当前样本的忽略掩码赋值给 ignore_mask</span>
<a id="__codelineno-7-215" name="__codelineno-7-215"></a>                <span class="n">ignore_mask</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ign</span>
<a id="__codelineno-7-216" name="__codelineno-7-216"></a>            <span class="c1"># 还有个问题，我们之前讨论过：为什么在这里还在用 for-if 这么低效的方案呢？</span>
<a id="__codelineno-7-217" name="__codelineno-7-217"></a>            <span class="c1"># 因为每个图像的 num_gt 也就是物品个数不一样，没法在维度上对齐</span>
<a id="__codelineno-7-218" name="__codelineno-7-218"></a>            <span class="c1"># 强行对齐也不是不可以，但是你还是要遍历一遍，效率差不了多少</span>
<a id="__codelineno-7-219" name="__codelineno-7-219"></a>            <span class="c1"># 并且这时候你就等着 CUDA out of memory 吧</span>
<a id="__codelineno-7-220" name="__codelineno-7-220"></a>
<a id="__codelineno-7-221" name="__codelineno-7-221"></a>        <span class="c1"># 计算无目标置信度损失，不包括被忽略的预测框，也就是 L_N</span>
<a id="__codelineno-7-222" name="__codelineno-7-222"></a>        <span class="c1"># 无目标损失包括两部分：非负责预测框 (not_resp_mask) 和无目标格子中的所有预测框 (noobj_cells_mask)</span>
<a id="__codelineno-7-223" name="__codelineno-7-223"></a>        <span class="c1"># 但需要排除那些与真实框 IoU 较高而被忽略的预测框 (乘以 (1.0 - ignore_mask))</span>
<a id="__codelineno-7-224" name="__codelineno-7-224"></a>        <span class="n">conf_noobj_terms</span> <span class="o">=</span> <span class="p">((</span><span class="n">pconf</span> <span class="o">-</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">not_resp_mask</span> <span class="o">+</span> <span class="n">noobj_cells_mask</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ignore_mask</span><span class="p">)</span>
<a id="__codelineno-7-225" name="__codelineno-7-225"></a>
<a id="__codelineno-7-226" name="__codelineno-7-226"></a>        <span class="c1"># 对框的损失计算完毕，下面是对格子的损失。</span>
<a id="__codelineno-7-227" name="__codelineno-7-227"></a>
<a id="__codelineno-7-228" name="__codelineno-7-228"></a>        <span class="c1"># 计算分类损失，仅对存在目标的格子计算交叉熵损失</span>
<a id="__codelineno-7-229" name="__codelineno-7-229"></a>        <span class="c1"># 首先计算存在目标的格子数量，用于后续归一化，使用 clamp(min=1.0) 防止除零</span>
<a id="__codelineno-7-230" name="__codelineno-7-230"></a>        <span class="n">num_objcells</span> <span class="o">=</span> <span class="n">obj_cells</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-231" name="__codelineno-7-231"></a>        <span class="c1"># 从 one-hot 编码的真实标签中获取类别索引，形状为 [N, S, S]</span>
<a id="__codelineno-7-232" name="__codelineno-7-232"></a>        <span class="n">t_cls_idx</span> <span class="o">=</span> <span class="n">t_cls</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-233" name="__codelineno-7-233"></a>        <span class="c1"># 构建存在目标的布尔掩码，形状为 [N, S, S]，用于索引存在目标的格子</span>
<a id="__codelineno-7-234" name="__codelineno-7-234"></a>        <span class="n">obj_mask_bool</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj_cells</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-7-235" name="__codelineno-7-235"></a>
<a id="__codelineno-7-236" name="__codelineno-7-236"></a>        <span class="c1"># 检查是否存在至少一个包含目标的格子</span>
<a id="__codelineno-7-237" name="__codelineno-7-237"></a>        <span class="k">if</span> <span class="n">obj_mask_bool</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-7-238" name="__codelineno-7-238"></a>            <span class="c1"># 计算交叉熵损失，使用标签平滑</span>
<a id="__codelineno-7-239" name="__codelineno-7-239"></a>            <span class="c1"># 首先从预测的分类logits中提取存在目标的格子部分，并重塑为 [N*S*S, C] 形状</span>
<a id="__codelineno-7-240" name="__codelineno-7-240"></a>            <span class="c1"># 同时从真实标签中提取对应的类别索引，并重塑为 [N*S*S] 形状</span>
<a id="__codelineno-7-241" name="__codelineno-7-241"></a>            <span class="n">ce</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
<a id="__codelineno-7-242" name="__codelineno-7-242"></a>                <span class="n">pred_cls_logits</span><span class="p">[</span><span class="n">obj_mask_bool</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span>
<a id="__codelineno-7-243" name="__codelineno-7-243"></a>                <span class="n">t_cls_idx</span><span class="p">[</span><span class="n">obj_mask_bool</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-7-244" name="__codelineno-7-244"></a>                <span class="n">reduction</span><span class="o">=</span><span class="s1">'sum'</span><span class="p">,</span>  <span class="c1"># 使用求和而不是均值，因为后面会除以 num_objcells</span>
<a id="__codelineno-7-245" name="__codelineno-7-245"></a>                <span class="n">label_smoothing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_label_smooth</span>  <span class="c1"># 应用标签平滑</span>
<a id="__codelineno-7-246" name="__codelineno-7-246"></a>            <span class="p">)</span>
<a id="__codelineno-7-247" name="__codelineno-7-247"></a>            <span class="c1"># 将交叉熵损失除以存在目标的格子数量，得到平均分类损失</span>
<a id="__codelineno-7-248" name="__codelineno-7-248"></a>            <span class="n">class_loss</span> <span class="o">=</span> <span class="n">ce</span> <span class="o">/</span> <span class="n">num_objcells</span>
<a id="__codelineno-7-249" name="__codelineno-7-249"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-250" name="__codelineno-7-250"></a>            <span class="c1"># 如果没有存在目标的格子，将分类损失设为 0</span>
<a id="__codelineno-7-251" name="__codelineno-7-251"></a>            <span class="n">class_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-252" name="__codelineno-7-252"></a>
<a id="__codelineno-7-253" name="__codelineno-7-253"></a>        <span class="c1"># 对各个损失组件进行归一化处理</span>
<a id="__codelineno-7-254" name="__codelineno-7-254"></a>        <span class="c1"># 计算负责预测的框数量，用于坐标损失和有目标置信度损失的归一化</span>
<a id="__codelineno-7-255" name="__codelineno-7-255"></a>        <span class="n">num_resp</span> <span class="o">=</span> <span class="n">resp_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-256" name="__codelineno-7-256"></a>        <span class="c1"># 计算需要计算无目标损失的框数量，包括非负责预测框和无目标格子中的预测框</span>
<a id="__codelineno-7-257" name="__codelineno-7-257"></a>        <span class="c1"># 但要排除被忽略的预测框 (乘以 (1.0 - ignore_mask))</span>
<a id="__codelineno-7-258" name="__codelineno-7-258"></a>        <span class="n">num_noobj</span> <span class="o">=</span> <span class="p">(</span> <span class="p">((</span><span class="n">not_resp_mask</span> <span class="o">+</span> <span class="n">noobj_cells_mask</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ignore_mask</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-7-259" name="__codelineno-7-259"></a>
<a id="__codelineno-7-260" name="__codelineno-7-260"></a>        <span class="c1"># 计算加权后的坐标损失，包括中心点坐标和宽高损失</span>
<a id="__codelineno-7-261" name="__codelineno-7-261"></a>        <span class="c1"># 使用 lambda_coord 增强坐标预测的重要性</span>
<a id="__codelineno-7-262" name="__codelineno-7-262"></a>        <span class="n">coord_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_coord</span> <span class="o">*</span> <span class="p">(</span>
<a id="__codelineno-7-263" name="__codelineno-7-263"></a>            <span class="n">coord_x_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">coord_y_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> 
<a id="__codelineno-7-264" name="__codelineno-7-264"></a>            <span class="n">coord_w_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">coord_h_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-7-265" name="__codelineno-7-265"></a>        <span class="p">)</span> <span class="o">/</span> <span class="n">num_resp</span>
<a id="__codelineno-7-266" name="__codelineno-7-266"></a>
<a id="__codelineno-7-267" name="__codelineno-7-267"></a>        <span class="c1"># 计算有目标置信度损失，使用负责预测的框数量进行归一化</span>
<a id="__codelineno-7-268" name="__codelineno-7-268"></a>        <span class="n">conf_obj_loss</span> <span class="o">=</span> <span class="n">conf_obj_terms</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">num_resp</span>
<a id="__codelineno-7-269" name="__codelineno-7-269"></a>
<a id="__codelineno-7-270" name="__codelineno-7-270"></a>        <span class="c1"># 计算加权后的无目标置信度损失</span>
<a id="__codelineno-7-271" name="__codelineno-7-271"></a>        <span class="c1"># 使用 lambda_noobj 降低背景预测的权重，避免背景主导训练过程</span>
<a id="__codelineno-7-272" name="__codelineno-7-272"></a>        <span class="n">conf_noobj_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_noobj</span> <span class="o">*</span> <span class="n">conf_noobj_terms</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">num_noobj</span>
<a id="__codelineno-7-273" name="__codelineno-7-273"></a>
<a id="__codelineno-7-274" name="__codelineno-7-274"></a>        <span class="c1"># 计算总损失，将所有损失组件相加</span>
<a id="__codelineno-7-275" name="__codelineno-7-275"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">coord_loss</span> <span class="o">+</span> <span class="n">conf_obj_loss</span> <span class="o">+</span> <span class="n">conf_noobj_loss</span> <span class="o">+</span> <span class="n">class_loss</span>
<a id="__codelineno-7-276" name="__codelineno-7-276"></a>
<a id="__codelineno-7-277" name="__codelineno-7-277"></a>        <span class="c1"># 构建损失字典，用于记录各个损失组件的值</span>
<a id="__codelineno-7-278" name="__codelineno-7-278"></a>        <span class="c1"># 使用 detach().item() 将张量转换为 Python 数值，避免在日志记录中保留计算图</span>
<a id="__codelineno-7-279" name="__codelineno-7-279"></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-280" name="__codelineno-7-280"></a>            <span class="s1">'loss_total'</span><span class="p">:</span> <span class="n">total_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>          <span class="c1"># 总损失</span>
<a id="__codelineno-7-281" name="__codelineno-7-281"></a>            <span class="s1">'loss_coord'</span><span class="p">:</span> <span class="n">coord_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>          <span class="c1"># 坐标损失</span>
<a id="__codelineno-7-282" name="__codelineno-7-282"></a>            <span class="s1">'loss_conf_obj'</span><span class="p">:</span> <span class="n">conf_obj_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>    <span class="c1"># 有目标置信度损失</span>
<a id="__codelineno-7-283" name="__codelineno-7-283"></a>            <span class="s1">'loss_conf_noobj'</span><span class="p">:</span> <span class="n">conf_noobj_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span><span class="c1"># 无目标置信度损失</span>
<a id="__codelineno-7-284" name="__codelineno-7-284"></a>            <span class="s1">'loss_class'</span><span class="p">:</span> <span class="n">class_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>          <span class="c1"># 分类损失</span>
<a id="__codelineno-7-285" name="__codelineno-7-285"></a>        <span class="p">}</span>
<a id="__codelineno-7-286" name="__codelineno-7-286"></a>
<a id="__codelineno-7-287" name="__codelineno-7-287"></a>        <span class="c1"># 返回总损失和损失字典</span>
<a id="__codelineno-7-288" name="__codelineno-7-288"></a>        <span class="k">return</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">loss_dict</span>
</code></pre></div></td></tr></table></div>
</details>
<h4 id="_16">推理与评估<a class="headerlink" href="#_16" title="Permanent link">¶</a></h4>
<p>唯一值得一提的就是推理时使用的 NMS 手段。由于打框的时候模型想提高召回（尤其在我们之前魔改过的 YOLO Loss 里面），就会给同一个目标打很多相互重叠的框，于是我们就需要对这些框进行筛选。</p>
<p>首先评判一个框好不好最佳标准是<strong>置信度</strong> <span class="arithmatex">\(c\)</span>，因此我们按置信度排序，最高的框就是质量最好的框。我们记录下来。接下来我们不能保留太多重叠的框，就丢弃和这个最佳框 IoU 大于某个阈值 <code>NMS_IoU</code> 的所有框。然后对剩下的框（不含那个最佳框）重复执行刚刚的排序——丢弃操作。最后记录下来的所有框就是筛选好的框了。</p>
<p>这叫做 Non-Max Suppression(NMS)，非极大值抑制。</p>
<p>其他的内容，请具体看代码吧。这里没有给 <code>yolo_decode</code> 函数，因为解码的部分在 <code>YOLOV1Loss</code> 类里面已经有呈现了。</p>
<details>
<summary> 利用 NMS 评估 mAP, P-R 等指标 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">  1</a></span>
<span class="normal"><a href="#__codelineno-8-2">  2</a></span>
<span class="normal"><a href="#__codelineno-8-3">  3</a></span>
<span class="normal"><a href="#__codelineno-8-4">  4</a></span>
<span class="normal"><a href="#__codelineno-8-5">  5</a></span>
<span class="normal"><a href="#__codelineno-8-6">  6</a></span>
<span class="normal"><a href="#__codelineno-8-7">  7</a></span>
<span class="normal"><a href="#__codelineno-8-8">  8</a></span>
<span class="normal"><a href="#__codelineno-8-9">  9</a></span>
<span class="normal"><a href="#__codelineno-8-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-8-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-8-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-8-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-8-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-8-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-8-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-8-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-8-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-8-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-8-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-8-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-8-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-8-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-8-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-8-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-8-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-8-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-8-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-8-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-8-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-8-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-8-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-8-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-8-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-8-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-8-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-8-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-8-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-8-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-8-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-8-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-8-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-8-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-8-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-8-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-8-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-8-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-8-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-8-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-8-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-8-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-8-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-8-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-8-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-8-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-8-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-8-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-8-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-8-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-8-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-8-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-8-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-8-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-8-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-8-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-8-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-8-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-8-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-8-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-8-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-8-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-8-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-8-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-8-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-8-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-8-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-8-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-8-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-8-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-8-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-8-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-8-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-8-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-8-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-8-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-8-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-8-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-8-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-8-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-8-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-8-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-8-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-8-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-8-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-8-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-8-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-8-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-8-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-8-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-8-100">100</a></span>
<span class="normal"><a href="#__codelineno-8-101">101</a></span>
<span class="normal"><a href="#__codelineno-8-102">102</a></span>
<span class="normal"><a href="#__codelineno-8-103">103</a></span>
<span class="normal"><a href="#__codelineno-8-104">104</a></span>
<span class="normal"><a href="#__codelineno-8-105">105</a></span>
<span class="normal"><a href="#__codelineno-8-106">106</a></span>
<span class="normal"><a href="#__codelineno-8-107">107</a></span>
<span class="normal"><a href="#__codelineno-8-108">108</a></span>
<span class="normal"><a href="#__codelineno-8-109">109</a></span>
<span class="normal"><a href="#__codelineno-8-110">110</a></span>
<span class="normal"><a href="#__codelineno-8-111">111</a></span>
<span class="normal"><a href="#__codelineno-8-112">112</a></span>
<span class="normal"><a href="#__codelineno-8-113">113</a></span>
<span class="normal"><a href="#__codelineno-8-114">114</a></span>
<span class="normal"><a href="#__codelineno-8-115">115</a></span>
<span class="normal"><a href="#__codelineno-8-116">116</a></span>
<span class="normal"><a href="#__codelineno-8-117">117</a></span>
<span class="normal"><a href="#__codelineno-8-118">118</a></span>
<span class="normal"><a href="#__codelineno-8-119">119</a></span>
<span class="normal"><a href="#__codelineno-8-120">120</a></span>
<span class="normal"><a href="#__codelineno-8-121">121</a></span>
<span class="normal"><a href="#__codelineno-8-122">122</a></span>
<span class="normal"><a href="#__codelineno-8-123">123</a></span>
<span class="normal"><a href="#__codelineno-8-124">124</a></span>
<span class="normal"><a href="#__codelineno-8-125">125</a></span>
<span class="normal"><a href="#__codelineno-8-126">126</a></span>
<span class="normal"><a href="#__codelineno-8-127">127</a></span>
<span class="normal"><a href="#__codelineno-8-128">128</a></span>
<span class="normal"><a href="#__codelineno-8-129">129</a></span>
<span class="normal"><a href="#__codelineno-8-130">130</a></span>
<span class="normal"><a href="#__codelineno-8-131">131</a></span>
<span class="normal"><a href="#__codelineno-8-132">132</a></span>
<span class="normal"><a href="#__codelineno-8-133">133</a></span>
<span class="normal"><a href="#__codelineno-8-134">134</a></span>
<span class="normal"><a href="#__codelineno-8-135">135</a></span>
<span class="normal"><a href="#__codelineno-8-136">136</a></span>
<span class="normal"><a href="#__codelineno-8-137">137</a></span>
<span class="normal"><a href="#__codelineno-8-138">138</a></span>
<span class="normal"><a href="#__codelineno-8-139">139</a></span>
<span class="normal"><a href="#__codelineno-8-140">140</a></span>
<span class="normal"><a href="#__codelineno-8-141">141</a></span>
<span class="normal"><a href="#__codelineno-8-142">142</a></span>
<span class="normal"><a href="#__codelineno-8-143">143</a></span>
<span class="normal"><a href="#__codelineno-8-144">144</a></span>
<span class="normal"><a href="#__codelineno-8-145">145</a></span>
<span class="normal"><a href="#__codelineno-8-146">146</a></span>
<span class="normal"><a href="#__codelineno-8-147">147</a></span>
<span class="normal"><a href="#__codelineno-8-148">148</a></span>
<span class="normal"><a href="#__codelineno-8-149">149</a></span>
<span class="normal"><a href="#__codelineno-8-150">150</a></span>
<span class="normal"><a href="#__codelineno-8-151">151</a></span>
<span class="normal"><a href="#__codelineno-8-152">152</a></span>
<span class="normal"><a href="#__codelineno-8-153">153</a></span>
<span class="normal"><a href="#__codelineno-8-154">154</a></span>
<span class="normal"><a href="#__codelineno-8-155">155</a></span>
<span class="normal"><a href="#__codelineno-8-156">156</a></span>
<span class="normal"><a href="#__codelineno-8-157">157</a></span>
<span class="normal"><a href="#__codelineno-8-158">158</a></span>
<span class="normal"><a href="#__codelineno-8-159">159</a></span>
<span class="normal"><a href="#__codelineno-8-160">160</a></span>
<span class="normal"><a href="#__codelineno-8-161">161</a></span>
<span class="normal"><a href="#__codelineno-8-162">162</a></span>
<span class="normal"><a href="#__codelineno-8-163">163</a></span>
<span class="normal"><a href="#__codelineno-8-164">164</a></span>
<span class="normal"><a href="#__codelineno-8-165">165</a></span>
<span class="normal"><a href="#__codelineno-8-166">166</a></span>
<span class="normal"><a href="#__codelineno-8-167">167</a></span>
<span class="normal"><a href="#__codelineno-8-168">168</a></span>
<span class="normal"><a href="#__codelineno-8-169">169</a></span>
<span class="normal"><a href="#__codelineno-8-170">170</a></span>
<span class="normal"><a href="#__codelineno-8-171">171</a></span>
<span class="normal"><a href="#__codelineno-8-172">172</a></span>
<span class="normal"><a href="#__codelineno-8-173">173</a></span>
<span class="normal"><a href="#__codelineno-8-174">174</a></span>
<span class="normal"><a href="#__codelineno-8-175">175</a></span>
<span class="normal"><a href="#__codelineno-8-176">176</a></span>
<span class="normal"><a href="#__codelineno-8-177">177</a></span>
<span class="normal"><a href="#__codelineno-8-178">178</a></span>
<span class="normal"><a href="#__codelineno-8-179">179</a></span>
<span class="normal"><a href="#__codelineno-8-180">180</a></span>
<span class="normal"><a href="#__codelineno-8-181">181</a></span>
<span class="normal"><a href="#__codelineno-8-182">182</a></span>
<span class="normal"><a href="#__codelineno-8-183">183</a></span>
<span class="normal"><a href="#__codelineno-8-184">184</a></span>
<span class="normal"><a href="#__codelineno-8-185">185</a></span>
<span class="normal"><a href="#__codelineno-8-186">186</a></span>
<span class="normal"><a href="#__codelineno-8-187">187</a></span>
<span class="normal"><a href="#__codelineno-8-188">188</a></span>
<span class="normal"><a href="#__codelineno-8-189">189</a></span>
<span class="normal"><a href="#__codelineno-8-190">190</a></span>
<span class="normal"><a href="#__codelineno-8-191">191</a></span>
<span class="normal"><a href="#__codelineno-8-192">192</a></span>
<span class="normal"><a href="#__codelineno-8-193">193</a></span>
<span class="normal"><a href="#__codelineno-8-194">194</a></span>
<span class="normal"><a href="#__codelineno-8-195">195</a></span>
<span class="normal"><a href="#__codelineno-8-196">196</a></span>
<span class="normal"><a href="#__codelineno-8-197">197</a></span>
<span class="normal"><a href="#__codelineno-8-198">198</a></span>
<span class="normal"><a href="#__codelineno-8-199">199</a></span>
<span class="normal"><a href="#__codelineno-8-200">200</a></span>
<span class="normal"><a href="#__codelineno-8-201">201</a></span>
<span class="normal"><a href="#__codelineno-8-202">202</a></span>
<span class="normal"><a href="#__codelineno-8-203">203</a></span>
<span class="normal"><a href="#__codelineno-8-204">204</a></span>
<span class="normal"><a href="#__codelineno-8-205">205</a></span>
<span class="normal"><a href="#__codelineno-8-206">206</a></span>
<span class="normal"><a href="#__codelineno-8-207">207</a></span>
<span class="normal"><a href="#__codelineno-8-208">208</a></span>
<span class="normal"><a href="#__codelineno-8-209">209</a></span>
<span class="normal"><a href="#__codelineno-8-210">210</a></span>
<span class="normal"><a href="#__codelineno-8-211">211</a></span>
<span class="normal"><a href="#__codelineno-8-212">212</a></span>
<span class="normal"><a href="#__codelineno-8-213">213</a></span>
<span class="normal"><a href="#__codelineno-8-214">214</a></span>
<span class="normal"><a href="#__codelineno-8-215">215</a></span>
<span class="normal"><a href="#__codelineno-8-216">216</a></span>
<span class="normal"><a href="#__codelineno-8-217">217</a></span>
<span class="normal"><a href="#__codelineno-8-218">218</a></span>
<span class="normal"><a href="#__codelineno-8-219">219</a></span>
<span class="normal"><a href="#__codelineno-8-220">220</a></span>
<span class="normal"><a href="#__codelineno-8-221">221</a></span>
<span class="normal"><a href="#__codelineno-8-222">222</a></span>
<span class="normal"><a href="#__codelineno-8-223">223</a></span>
<span class="normal"><a href="#__codelineno-8-224">224</a></span>
<span class="normal"><a href="#__codelineno-8-225">225</a></span>
<span class="normal"><a href="#__codelineno-8-226">226</a></span>
<span class="normal"><a href="#__codelineno-8-227">227</a></span>
<span class="normal"><a href="#__codelineno-8-228">228</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">nms_classwise</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">iou_thr</span><span class="o">=</span><span class="mf">0.45</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="sd">    按类别进行非极大值抑制 (NMS)，去除重叠度高的检测框</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="sd">        dets: 检测结果张量，形状为 [num_detections, 6]，每行包含 [x1, y1, x2, y2, score, class]</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="sd">        iou_thr: IoU 阈值，用于判断两个框是否重叠过高，默认为 0.45</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="sd">        经过 NMS 处理后的检测结果张量</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="sd">    """</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>    <span class="c1"># 检查是否有检测结果</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="k">if</span> <span class="n">dets</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>        <span class="k">return</span> <span class="n">dets</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>    <span class="c1"># 对每个类别单独处理</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a>        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>        <span class="c1"># 创建当前类别的掩码</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a>        <span class="c1"># 提取当前类别的检测结果</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a>        <span class="c1"># 使用 TorchVision 的 NMS 函数进行非极大值抑制</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a>        <span class="c1"># 注意：这里应用了 NMS，这是去除重叠框的关键步骤</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a>        <span class="c1"># NMS 会保留得分最高的框，并移除与其 IoU 超过阈值的其他框</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a>        <span class="n">keep_idx</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">nms</span><span class="p">(</span><span class="n">d</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">iou_thr</span><span class="p">)</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a>        <span class="c1"># 将保留的检测结果添加到输出列表</span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a>        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">keep_idx</span><span class="p">])</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a>    <span class="c1"># 合并所有类别的检测结果</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">out</span> <span class="k">else</span> <span class="n">dets</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_map_pr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">nms_iou</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span> <span class="n">iou_match</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">subsample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="sd">    全面评估 YOLO 模型的性能，计算 mAP (mean Average Precision) 和精确率-召回率指标</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a><span class="sd">    Args:</span>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a><span class="sd">        dataset: 评估数据集，应提供图像和标注</span>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="sd">        model: 训练好的 YOLO 模型</span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a><span class="sd">        device: 计算设备 ('cpu' 或 'cuda')</span>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="sd">        conf_thresh: 置信度阈值，过滤低置信度预测框，默认 1e-4</span>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="sd">        nms_iou: NMS 操作的 IoU 阈值，用于去除重叠框，默认 0.45</span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="sd">        iou_match: 判断预测框与真实框匹配的 IoU 阈值，默认 0.5 (PASCAL VOC 标准)</span>
<a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="sd">        subsample: 评估子集大小，用于快速验证，默认评估全部数据</span>
<a id="__codelineno-8-46" name="__codelineno-8-46"></a>
<a id="__codelineno-8-47" name="__codelineno-8-47"></a><span class="sd">    Returns:</span>
<a id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="sd">        dict: 包含多种评估指标的字典</span>
<a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="sd">    """</span>
<a id="__codelineno-8-50" name="__codelineno-8-50"></a>    <span class="c1"># 设置模型为评估模式，关闭 dropout 和 batch normalization 的随机性</span>
<a id="__codelineno-8-51" name="__codelineno-8-51"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-8-52" name="__codelineno-8-52"></a>
<a id="__codelineno-8-53" name="__codelineno-8-53"></a>    <span class="c1"># 创建数据加载器，设置合适的批量大小和工作线程数</span>
<a id="__codelineno-8-54" name="__codelineno-8-54"></a>    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">NUM_WORKERS</span><span class="p">,</span>
<a id="__codelineno-8-55" name="__codelineno-8-55"></a>                        <span class="n">pin_memory</span><span class="o">=</span><span class="n">PIN_MEMORY</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">)</span>
<a id="__codelineno-8-56" name="__codelineno-8-56"></a>
<a id="__codelineno-8-57" name="__codelineno-8-57"></a>    <span class="c1"># 初始化数据结构存储所有真实框和预测框</span>
<a id="__codelineno-8-58" name="__codelineno-8-58"></a>    <span class="c1"># all_gts: 按类别组织的真实框，结构为 {class_id: {image_id: [bboxes]}}</span>
<a id="__codelineno-8-59" name="__codelineno-8-59"></a>    <span class="c1"># all_preds: 按类别组织的预测框，结构为 {class_id: [(image_id, confidence, bbox)]}</span>
<a id="__codelineno-8-60" name="__codelineno-8-60"></a>    <span class="n">all_gts</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">C_global</span><span class="p">)}</span>
<a id="__codelineno-8-61" name="__codelineno-8-61"></a>    <span class="n">all_preds</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">C_global</span><span class="p">)}</span>
<a id="__codelineno-8-62" name="__codelineno-8-62"></a>
<a id="__codelineno-8-63" name="__codelineno-8-63"></a>    <span class="c1"># 使用无梯度计算和自动混合精度（如果启用）以提高效率</span>
<a id="__codelineno-8-64" name="__codelineno-8-64"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">AUTOCAST_ENABLED</span><span class="p">):</span>
<a id="__codelineno-8-65" name="__codelineno-8-65"></a>        <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 已处理图像计数器</span>
<a id="__codelineno-8-66" name="__codelineno-8-66"></a>
<a id="__codelineno-8-67" name="__codelineno-8-67"></a>        <span class="c1"># 使用进度条遍历数据加载器</span>
<a id="__codelineno-8-68" name="__codelineno-8-68"></a>        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">gts</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">'Eval'</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-8-69" name="__codelineno-8-69"></a>            <span class="c1"># 将图像数据转移到指定设备（CPU/GPU）</span>
<a id="__codelineno-8-70" name="__codelineno-8-70"></a>            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-8-71" name="__codelineno-8-71"></a>
<a id="__codelineno-8-72" name="__codelineno-8-72"></a>            <span class="c1"># 前向传播获取模型预测</span>
<a id="__codelineno-8-73" name="__codelineno-8-73"></a>            <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<a id="__codelineno-8-74" name="__codelineno-8-74"></a>
<a id="__codelineno-8-75" name="__codelineno-8-75"></a>            <span class="c1"># 解码原始预测输出，转换为边界框格式</span>
<a id="__codelineno-8-76" name="__codelineno-8-76"></a>            <span class="n">dets_batch</span> <span class="o">=</span> <span class="n">yolo_decode</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="n">conf_thresh</span><span class="p">)</span>
<a id="__codelineno-8-77" name="__codelineno-8-77"></a>
<a id="__codelineno-8-78" name="__codelineno-8-78"></a>            <span class="c1"># 处理批次中的每个图像</span>
<a id="__codelineno-8-79" name="__codelineno-8-79"></a>            <span class="k">for</span> <span class="n">bi</span><span class="p">,</span> <span class="n">dets</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dets_batch</span><span class="p">):</span>
<a id="__codelineno-8-80" name="__codelineno-8-80"></a>                <span class="c1"># 对检测结果应用非极大值抑制 (NMS)，去除重叠框</span>
<a id="__codelineno-8-81" name="__codelineno-8-81"></a>                <span class="c1"># 这是评估流程中的关键步骤，确保每个目标只有一个最佳预测框</span>
<a id="__codelineno-8-82" name="__codelineno-8-82"></a>                <span class="n">dets</span> <span class="o">=</span> <span class="n">nms_classwise</span><span class="p">(</span><span class="n">dets</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">iou_thr</span><span class="o">=</span><span class="n">nms_iou</span><span class="p">)</span>
<a id="__codelineno-8-83" name="__codelineno-8-83"></a>
<a id="__codelineno-8-84" name="__codelineno-8-84"></a>                <span class="c1"># 获取当前图像的ID和真实标注</span>
<a id="__codelineno-8-85" name="__codelineno-8-85"></a>                <span class="n">img_id</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span>
<a id="__codelineno-8-86" name="__codelineno-8-86"></a>                <span class="n">gt</span> <span class="o">=</span> <span class="n">gts</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>  <span class="c1"># 真实标注，格式为 [x1, y1, x2, y2, class]</span>
<a id="__codelineno-8-87" name="__codelineno-8-87"></a>
<a id="__codelineno-8-88" name="__codelineno-8-88"></a>                <span class="c1"># 存储真实框信息到全局数据结构</span>
<a id="__codelineno-8-89" name="__codelineno-8-89"></a>                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gt</span><span class="p">:</span>
<a id="__codelineno-8-90" name="__codelineno-8-90"></a>                    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="bp">cls</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-8-91" name="__codelineno-8-91"></a>                    <span class="c1"># 初始化该类别的图像字典（如果不存在）</span>
<a id="__codelineno-8-92" name="__codelineno-8-92"></a>                    <span class="k">if</span> <span class="n">img_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_gts</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">)]:</span>
<a id="__codelineno-8-93" name="__codelineno-8-93"></a>                        <span class="n">all_gts</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">)][</span><span class="n">img_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-8-94" name="__codelineno-8-94"></a>                    <span class="c1"># 添加真实框坐标</span>
<a id="__codelineno-8-95" name="__codelineno-8-95"></a>                    <span class="n">all_gts</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">)][</span><span class="n">img_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
<a id="__codelineno-8-96" name="__codelineno-8-96"></a>
<a id="__codelineno-8-97" name="__codelineno-8-97"></a>                <span class="c1"># 存储预测框信息到全局数据结构</span>
<a id="__codelineno-8-98" name="__codelineno-8-98"></a>                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">:</span>
<a id="__codelineno-8-99" name="__codelineno-8-99"></a>                    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="bp">cls</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-8-100" name="__codelineno-8-100"></a>                    <span class="n">all_preds</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_id</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]))</span>
<a id="__codelineno-8-101" name="__codelineno-8-101"></a>
<a id="__codelineno-8-102" name="__codelineno-8-102"></a>            <span class="c1"># 更新已处理图像计数</span>
<a id="__codelineno-8-103" name="__codelineno-8-103"></a>            <span class="n">processed</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<a id="__codelineno-8-104" name="__codelineno-8-104"></a>
<a id="__codelineno-8-105" name="__codelineno-8-105"></a>            <span class="c1"># 如果设置了子采样且已达到采样数量，提前终止评估</span>
<a id="__codelineno-8-106" name="__codelineno-8-106"></a>            <span class="k">if</span> <span class="n">subsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">processed</span> <span class="o">&gt;=</span> <span class="n">subsample</span><span class="p">:</span>
<a id="__codelineno-8-107" name="__codelineno-8-107"></a>                <span class="k">break</span>
<a id="__codelineno-8-108" name="__codelineno-8-108"></a>
<a id="__codelineno-8-109" name="__codelineno-8-109"></a>    <span class="c1"># 初始化评估指标</span>
<a id="__codelineno-8-110" name="__codelineno-8-110"></a>    <span class="n">aps</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 存储每个类别的 AP (Average Precision)</span>
<a id="__codelineno-8-111" name="__codelineno-8-111"></a>    <span class="n">iou_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 存储所有匹配框的 IoU 值，用于计算平均 IoU</span>
<a id="__codelineno-8-112" name="__codelineno-8-112"></a>    <span class="n">tp_total</span> <span class="o">=</span> <span class="n">fp_total</span> <span class="o">=</span> <span class="n">fn_total</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 全局的真正例、假正例、假反例计数</span>
<a id="__codelineno-8-113" name="__codelineno-8-113"></a>
<a id="__codelineno-8-114" name="__codelineno-8-114"></a>    <span class="c1"># 对每个类别单独计算评估指标</span>
<a id="__codelineno-8-115" name="__codelineno-8-115"></a>    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">C_global</span><span class="p">):</span>
<a id="__codelineno-8-116" name="__codelineno-8-116"></a>        <span class="c1"># 按置信度降序排序当前类别的所有预测框</span>
<a id="__codelineno-8-117" name="__codelineno-8-117"></a>        <span class="c1"># 这是计算 PR 曲线的关键步骤，因为我们需要按置信度从高到低处理预测</span>
<a id="__codelineno-8-118" name="__codelineno-8-118"></a>        <span class="n">preds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_preds</span><span class="p">[</span><span class="bp">cls</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-8-119" name="__codelineno-8-119"></a>
<a id="__codelineno-8-120" name="__codelineno-8-120"></a>        <span class="c1"># 获取当前类别的所有真实框，按图像分组</span>
<a id="__codelineno-8-121" name="__codelineno-8-121"></a>        <span class="n">gt_per_image</span> <span class="o">=</span> <span class="n">all_gts</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
<a id="__codelineno-8-122" name="__codelineno-8-122"></a>
<a id="__codelineno-8-123" name="__codelineno-8-123"></a>        <span class="c1"># 创建匹配标记字典，记录每个真实框是否已被预测框匹配</span>
<a id="__codelineno-8-124" name="__codelineno-8-124"></a>        <span class="c1"># 结构: {image_id: numpy_array_of_booleans}</span>
<a id="__codelineno-8-125" name="__codelineno-8-125"></a>        <span class="n">gt_matched</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-8-126" name="__codelineno-8-126"></a>        <span class="k">for</span> <span class="n">img_id</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="n">gt_per_image</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-8-127" name="__codelineno-8-127"></a>            <span class="n">gt_matched</span><span class="p">[</span><span class="n">img_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<a id="__codelineno-8-128" name="__codelineno-8-128"></a>
<a id="__codelineno-8-129" name="__codelineno-8-129"></a>        <span class="c1"># 初始化真正例(TP)、假正例(FP)和得分列表</span>
<a id="__codelineno-8-130" name="__codelineno-8-130"></a>        <span class="n">TPs</span><span class="p">,</span> <span class="n">FPs</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-8-131" name="__codelineno-8-131"></a>
<a id="__codelineno-8-132" name="__codelineno-8-132"></a>        <span class="c1"># 按置信度从高到低遍历所有预测框</span>
<a id="__codelineno-8-133" name="__codelineno-8-133"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">img_id</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">:</span>
<a id="__codelineno-8-134" name="__codelineno-8-134"></a>            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>  <span class="c1"># 记录当前预测框的得分</span>
<a id="__codelineno-8-135" name="__codelineno-8-135"></a>
<a id="__codelineno-8-136" name="__codelineno-8-136"></a>            <span class="c1"># 获取当前图像中该类别的所有真实框</span>
<a id="__codelineno-8-137" name="__codelineno-8-137"></a>            <span class="n">gt_boxes</span> <span class="o">=</span> <span class="n">gt_per_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">img_id</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-8-138" name="__codelineno-8-138"></a>
<a id="__codelineno-8-139" name="__codelineno-8-139"></a>            <span class="c1"># 如果当前图像没有该类别的真实框，所有预测都是假正例(FP)</span>
<a id="__codelineno-8-140" name="__codelineno-8-140"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_boxes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-141" name="__codelineno-8-141"></a>                <span class="n">TPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-8-142" name="__codelineno-8-142"></a>                <span class="n">FPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-143" name="__codelineno-8-143"></a>                <span class="k">continue</span>
<a id="__codelineno-8-144" name="__codelineno-8-144"></a>
<a id="__codelineno-8-145" name="__codelineno-8-145"></a>            <span class="c1"># 计算当前预测框与所有真实框的 IoU</span>
<a id="__codelineno-8-146" name="__codelineno-8-146"></a>            <span class="n">box_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">box</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># 当前预测框</span>
<a id="__codelineno-8-147" name="__codelineno-8-147"></a>            <span class="n">gt_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">gt_boxes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># 所有真实框</span>
<a id="__codelineno-8-148" name="__codelineno-8-148"></a>
<a id="__codelineno-8-149" name="__codelineno-8-149"></a>            <span class="c1"># 计算 IoU 矩阵并获取最大值和索引</span>
<a id="__codelineno-8-150" name="__codelineno-8-150"></a>            <span class="n">ious</span> <span class="o">=</span> <span class="n">box_iou_xyxy</span><span class="p">(</span><span class="n">box_t</span><span class="p">,</span> <span class="n">gt_t</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-8-151" name="__codelineno-8-151"></a>            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>  <span class="c1"># 最高 IoU 的索引</span>
<a id="__codelineno-8-152" name="__codelineno-8-152"></a>            <span class="n">best_iou</span> <span class="o">=</span> <span class="n">ious</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>  <span class="c1"># 最高 IoU 值</span>
<a id="__codelineno-8-153" name="__codelineno-8-153"></a>
<a id="__codelineno-8-154" name="__codelineno-8-154"></a>            <span class="c1"># 判断是否为真正例(TP)的条件：</span>
<a id="__codelineno-8-155" name="__codelineno-8-155"></a>            <span class="c1"># 1. IoU 超过匹配阈值 (通常为 0.5)</span>
<a id="__codelineno-8-156" name="__codelineno-8-156"></a>            <span class="c1"># 2. 对应的真实框尚未被匹配</span>
<a id="__codelineno-8-157" name="__codelineno-8-157"></a>            <span class="k">if</span> <span class="n">best_iou</span> <span class="o">&gt;=</span> <span class="n">iou_match</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">gt_matched</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="n">best_idx</span><span class="p">]:</span>
<a id="__codelineno-8-158" name="__codelineno-8-158"></a>                <span class="n">TPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 真正例</span>
<a id="__codelineno-8-159" name="__codelineno-8-159"></a>                <span class="n">FPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 不是假正例</span>
<a id="__codelineno-8-160" name="__codelineno-8-160"></a>                <span class="n">gt_matched</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="n">best_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 标记该真实框已被匹配</span>
<a id="__codelineno-8-161" name="__codelineno-8-161"></a>                <span class="n">iou_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_iou</span><span class="p">)</span>  <span class="c1"># 记录匹配框的 IoU</span>
<a id="__codelineno-8-162" name="__codelineno-8-162"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-163" name="__codelineno-8-163"></a>                <span class="n">TPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 不是真正例</span>
<a id="__codelineno-8-164" name="__codelineno-8-164"></a>                <span class="n">FPs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 假正例</span>
<a id="__codelineno-8-165" name="__codelineno-8-165"></a>
<a id="__codelineno-8-166" name="__codelineno-8-166"></a>        <span class="c1"># 转换为 numpy 数组以便向量化计算</span>
<a id="__codelineno-8-167" name="__codelineno-8-167"></a>        <span class="n">TPs</span><span class="p">,</span> <span class="n">FPs</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TPs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">FPs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
<a id="__codelineno-8-168" name="__codelineno-8-168"></a>
<a id="__codelineno-8-169" name="__codelineno-8-169"></a>        <span class="c1"># 计算累积真正例和假正例数量</span>
<a id="__codelineno-8-170" name="__codelineno-8-170"></a>        <span class="n">cum_TP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">TPs</span><span class="p">)</span>
<a id="__codelineno-8-171" name="__codelineno-8-171"></a>        <span class="n">cum_FP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">FPs</span><span class="p">)</span>
<a id="__codelineno-8-172" name="__codelineno-8-172"></a>
<a id="__codelineno-8-173" name="__codelineno-8-173"></a>        <span class="c1"># 计算当前类别的真实框总数</span>
<a id="__codelineno-8-174" name="__codelineno-8-174"></a>        <span class="n">total_gts</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gt_per_image</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-8-175" name="__codelineno-8-175"></a>
<a id="__codelineno-8-176" name="__codelineno-8-176"></a>        <span class="c1"># 如果没有真实框，AP 设为 0</span>
<a id="__codelineno-8-177" name="__codelineno-8-177"></a>        <span class="k">if</span> <span class="n">total_gts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-178" name="__codelineno-8-178"></a>            <span class="n">aps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-8-179" name="__codelineno-8-179"></a>            <span class="k">continue</span>
<a id="__codelineno-8-180" name="__codelineno-8-180"></a>
<a id="__codelineno-8-181" name="__codelineno-8-181"></a>        <span class="c1"># 计算召回率和精确率曲线</span>
<a id="__codelineno-8-182" name="__codelineno-8-182"></a>        <span class="c1"># 召回率 = 真正例数 / 总真实框数</span>
<a id="__codelineno-8-183" name="__codelineno-8-183"></a>        <span class="n">recalls</span> <span class="o">=</span> <span class="n">cum_TP</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_gts</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-8-184" name="__codelineno-8-184"></a>
<a id="__codelineno-8-185" name="__codelineno-8-185"></a>        <span class="c1"># 精确率 = 真正例数 / (真正例数 + 假正例数)</span>
<a id="__codelineno-8-186" name="__codelineno-8-186"></a>        <span class="n">precisions</span> <span class="o">=</span> <span class="n">cum_TP</span> <span class="o">/</span> <span class="p">(</span><span class="n">cum_TP</span> <span class="o">+</span> <span class="n">cum_FP</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-8-187" name="__codelineno-8-187"></a>
<a id="__codelineno-8-188" name="__codelineno-8-188"></a>        <span class="c1"># 使用 11点插值法计算 AP (Average Precision)</span>
<a id="__codelineno-8-189" name="__codelineno-8-189"></a>        <span class="c1"># 这是 PASCAL VOC 挑战赛的标准评估方法</span>
<a id="__codelineno-8-190" name="__codelineno-8-190"></a>        <span class="n">ap</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-8-191" name="__codelineno-8-191"></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>  <span class="c1"># 在 [0, 1] 区间均匀取11个点</span>
<a id="__codelineno-8-192" name="__codelineno-8-192"></a>            <span class="c1"># 对于每个召回率阈值 t，找到所有召回率 ≥ t 的精确率最大值</span>
<a id="__codelineno-8-193" name="__codelineno-8-193"></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">precisions</span><span class="p">[</span><span class="n">recalls</span> <span class="o">&gt;=</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">recalls</span> <span class="o">&gt;=</span> <span class="n">t</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-8-194" name="__codelineno-8-194"></a>            <span class="n">ap</span> <span class="o">+=</span> <span class="n">p</span> <span class="o">/</span> <span class="mf">11.0</span>  <span class="c1"># 平均这些精确率值</span>
<a id="__codelineno-8-195" name="__codelineno-8-195"></a>
<a id="__codelineno-8-196" name="__codelineno-8-196"></a>        <span class="n">aps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span>  <span class="c1"># 记录当前类别的 AP</span>
<a id="__codelineno-8-197" name="__codelineno-8-197"></a>
<a id="__codelineno-8-198" name="__codelineno-8-198"></a>        <span class="c1"># 计算置信度阈值 0.5 下的 TP, FP, FN</span>
<a id="__codelineno-8-199" name="__codelineno-8-199"></a>        <span class="c1"># 这在实践中很有用，因为它反映了模型在实际应用中的性能</span>
<a id="__codelineno-8-200" name="__codelineno-8-200"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">&gt;=</span> <span class="mf">0.5</span>  <span class="c1"># 选择置信度 ≥ 0.5 的预测</span>
<a id="__codelineno-8-201" name="__codelineno-8-201"></a>        <span class="n">tp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TPs</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>  <span class="c1"># 真正例数</span>
<a id="__codelineno-8-202" name="__codelineno-8-202"></a>        <span class="n">fp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">FPs</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>  <span class="c1"># 假正例数</span>
<a id="__codelineno-8-203" name="__codelineno-8-203"></a>        <span class="n">fn</span> <span class="o">=</span> <span class="n">total_gts</span> <span class="o">-</span> <span class="n">tp</span>  <span class="c1"># 假反例数 = 总真实框数 - 真正例数</span>
<a id="__codelineno-8-204" name="__codelineno-8-204"></a>
<a id="__codelineno-8-205" name="__codelineno-8-205"></a>        <span class="c1"># 累加到全局计数</span>
<a id="__codelineno-8-206" name="__codelineno-8-206"></a>        <span class="n">tp_total</span> <span class="o">+=</span> <span class="n">tp</span>
<a id="__codelineno-8-207" name="__codelineno-8-207"></a>        <span class="n">fp_total</span> <span class="o">+=</span> <span class="n">fp</span>
<a id="__codelineno-8-208" name="__codelineno-8-208"></a>        <span class="n">fn_total</span> <span class="o">+=</span> <span class="n">fn</span>
<a id="__codelineno-8-209" name="__codelineno-8-209"></a>
<a id="__codelineno-8-210" name="__codelineno-8-210"></a>    <span class="c1"># 计算最终评估指标</span>
<a id="__codelineno-8-211" name="__codelineno-8-211"></a>    <span class="c1"># mAP: 所有类别 AP 的平均值，是目标检测的主要评估指标</span>
<a id="__codelineno-8-212" name="__codelineno-8-212"></a>    <span class="n">mAP</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aps</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aps</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-8-213" name="__codelineno-8-213"></a>
<a id="__codelineno-8-214" name="__codelineno-8-214"></a>    <span class="c1"># 平均 IoU: 所有匹配框的 IoU 平均值，反映定位精度</span>
<a id="__codelineno-8-215" name="__codelineno-8-215"></a>    <span class="n">mean_iou_matched</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">iou_list</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iou_list</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-8-216" name="__codelineno-8-216"></a>
<a id="__codelineno-8-217" name="__codelineno-8-217"></a>    <span class="c1"># 置信度阈值 0.5 下的精确率和召回率</span>
<a id="__codelineno-8-218" name="__codelineno-8-218"></a>    <span class="n">precision_05</span> <span class="o">=</span> <span class="n">tp_total</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp_total</span> <span class="o">+</span> <span class="n">fp_total</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-8-219" name="__codelineno-8-219"></a>    <span class="n">recall_05</span> <span class="o">=</span> <span class="n">tp_total</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp_total</span> <span class="o">+</span> <span class="n">fn_total</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-8-220" name="__codelineno-8-220"></a>
<a id="__codelineno-8-221" name="__codelineno-8-221"></a>    <span class="c1"># 返回包含所有评估指标的字典</span>
<a id="__codelineno-8-222" name="__codelineno-8-222"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-8-223" name="__codelineno-8-223"></a>        <span class="s1">'mAP_50'</span><span class="p">:</span> <span class="n">mAP</span><span class="p">,</span>  <span class="c1"># 使用 IoU 阈值 0.5 的 mAP</span>
<a id="__codelineno-8-224" name="__codelineno-8-224"></a>        <span class="s1">'mean_iou_matched'</span><span class="p">:</span> <span class="n">mean_iou_matched</span><span class="p">,</span>  <span class="c1"># 匹配框的平均 IoU</span>
<a id="__codelineno-8-225" name="__codelineno-8-225"></a>        <span class="s1">'precision@0.5'</span><span class="p">:</span> <span class="n">precision_05</span><span class="p">,</span>  <span class="c1"># 置信度阈值 0.5 下的精确率</span>
<a id="__codelineno-8-226" name="__codelineno-8-226"></a>        <span class="s1">'recall@0.5'</span><span class="p">:</span> <span class="n">recall_05</span><span class="p">,</span>  <span class="c1"># 置信度阈值 0.5 下的召回率</span>
<a id="__codelineno-8-227" name="__codelineno-8-227"></a>        <span class="s1">'AP_per_class'</span><span class="p">:</span> <span class="n">aps</span>  <span class="c1"># 每个类别的 AP 值，用于分析类别特异性性能</span>
<a id="__codelineno-8-228" name="__codelineno-8-228"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
<h4 id="_17">可视化<a class="headerlink" href="#_17" title="Permanent link">¶</a></h4>
<p>这里实现了通过摄像头视频流进行<strong>实时目标检测</strong>。</p>
<details>
<summary> 实时目标检测使用的代码 </summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">  1</a></span>
<span class="normal"><a href="#__codelineno-9-2">  2</a></span>
<span class="normal"><a href="#__codelineno-9-3">  3</a></span>
<span class="normal"><a href="#__codelineno-9-4">  4</a></span>
<span class="normal"><a href="#__codelineno-9-5">  5</a></span>
<span class="normal"><a href="#__codelineno-9-6">  6</a></span>
<span class="normal"><a href="#__codelineno-9-7">  7</a></span>
<span class="normal"><a href="#__codelineno-9-8">  8</a></span>
<span class="normal"><a href="#__codelineno-9-9">  9</a></span>
<span class="normal"><a href="#__codelineno-9-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-9-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-9-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-9-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-9-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-9-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-9-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-9-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-9-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-9-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-9-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-9-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-9-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-9-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-9-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-9-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-9-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-9-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-9-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-9-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-9-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-9-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-9-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-9-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-9-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-9-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-9-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-9-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-9-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-9-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-9-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-9-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-9-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-9-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-9-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-9-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-9-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-9-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-9-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-9-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-9-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-9-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-9-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-9-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-9-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-9-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-9-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-9-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-9-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-9-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-9-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-9-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-9-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-9-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-9-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-9-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-9-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-9-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-9-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-9-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-9-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-9-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-9-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-9-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-9-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-9-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-9-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-9-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-9-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-9-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-9-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-9-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-9-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-9-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-9-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-9-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-9-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-9-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-9-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-9-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-9-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-9-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-9-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-9-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-9-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-9-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-9-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-9-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-9-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-9-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-9-100">100</a></span>
<span class="normal"><a href="#__codelineno-9-101">101</a></span>
<span class="normal"><a href="#__codelineno-9-102">102</a></span>
<span class="normal"><a href="#__codelineno-9-103">103</a></span>
<span class="normal"><a href="#__codelineno-9-104">104</a></span>
<span class="normal"><a href="#__codelineno-9-105">105</a></span>
<span class="normal"><a href="#__codelineno-9-106">106</a></span>
<span class="normal"><a href="#__codelineno-9-107">107</a></span>
<span class="normal"><a href="#__codelineno-9-108">108</a></span>
<span class="normal"><a href="#__codelineno-9-109">109</a></span>
<span class="normal"><a href="#__codelineno-9-110">110</a></span>
<span class="normal"><a href="#__codelineno-9-111">111</a></span>
<span class="normal"><a href="#__codelineno-9-112">112</a></span>
<span class="normal"><a href="#__codelineno-9-113">113</a></span>
<span class="normal"><a href="#__codelineno-9-114">114</a></span>
<span class="normal"><a href="#__codelineno-9-115">115</a></span>
<span class="normal"><a href="#__codelineno-9-116">116</a></span>
<span class="normal"><a href="#__codelineno-9-117">117</a></span>
<span class="normal"><a href="#__codelineno-9-118">118</a></span>
<span class="normal"><a href="#__codelineno-9-119">119</a></span>
<span class="normal"><a href="#__codelineno-9-120">120</a></span>
<span class="normal"><a href="#__codelineno-9-121">121</a></span>
<span class="normal"><a href="#__codelineno-9-122">122</a></span>
<span class="normal"><a href="#__codelineno-9-123">123</a></span>
<span class="normal"><a href="#__codelineno-9-124">124</a></span>
<span class="normal"><a href="#__codelineno-9-125">125</a></span>
<span class="normal"><a href="#__codelineno-9-126">126</a></span>
<span class="normal"><a href="#__codelineno-9-127">127</a></span>
<span class="normal"><a href="#__codelineno-9-128">128</a></span>
<span class="normal"><a href="#__codelineno-9-129">129</a></span>
<span class="normal"><a href="#__codelineno-9-130">130</a></span>
<span class="normal"><a href="#__codelineno-9-131">131</a></span>
<span class="normal"><a href="#__codelineno-9-132">132</a></span>
<span class="normal"><a href="#__codelineno-9-133">133</a></span>
<span class="normal"><a href="#__codelineno-9-134">134</a></span>
<span class="normal"><a href="#__codelineno-9-135">135</a></span>
<span class="normal"><a href="#__codelineno-9-136">136</a></span>
<span class="normal"><a href="#__codelineno-9-137">137</a></span>
<span class="normal"><a href="#__codelineno-9-138">138</a></span>
<span class="normal"><a href="#__codelineno-9-139">139</a></span>
<span class="normal"><a href="#__codelineno-9-140">140</a></span>
<span class="normal"><a href="#__codelineno-9-141">141</a></span>
<span class="normal"><a href="#__codelineno-9-142">142</a></span>
<span class="normal"><a href="#__codelineno-9-143">143</a></span>
<span class="normal"><a href="#__codelineno-9-144">144</a></span>
<span class="normal"><a href="#__codelineno-9-145">145</a></span>
<span class="normal"><a href="#__codelineno-9-146">146</a></span>
<span class="normal"><a href="#__codelineno-9-147">147</a></span>
<span class="normal"><a href="#__codelineno-9-148">148</a></span>
<span class="normal"><a href="#__codelineno-9-149">149</a></span>
<span class="normal"><a href="#__codelineno-9-150">150</a></span>
<span class="normal"><a href="#__codelineno-9-151">151</a></span>
<span class="normal"><a href="#__codelineno-9-152">152</a></span>
<span class="normal"><a href="#__codelineno-9-153">153</a></span>
<span class="normal"><a href="#__codelineno-9-154">154</a></span>
<span class="normal"><a href="#__codelineno-9-155">155</a></span>
<span class="normal"><a href="#__codelineno-9-156">156</a></span>
<span class="normal"><a href="#__codelineno-9-157">157</a></span>
<span class="normal"><a href="#__codelineno-9-158">158</a></span>
<span class="normal"><a href="#__codelineno-9-159">159</a></span>
<span class="normal"><a href="#__codelineno-9-160">160</a></span>
<span class="normal"><a href="#__codelineno-9-161">161</a></span>
<span class="normal"><a href="#__codelineno-9-162">162</a></span>
<span class="normal"><a href="#__codelineno-9-163">163</a></span>
<span class="normal"><a href="#__codelineno-9-164">164</a></span>
<span class="normal"><a href="#__codelineno-9-165">165</a></span>
<span class="normal"><a href="#__codelineno-9-166">166</a></span>
<span class="normal"><a href="#__codelineno-9-167">167</a></span>
<span class="normal"><a href="#__codelineno-9-168">168</a></span>
<span class="normal"><a href="#__codelineno-9-169">169</a></span>
<span class="normal"><a href="#__codelineno-9-170">170</a></span>
<span class="normal"><a href="#__codelineno-9-171">171</a></span>
<span class="normal"><a href="#__codelineno-9-172">172</a></span>
<span class="normal"><a href="#__codelineno-9-173">173</a></span>
<span class="normal"><a href="#__codelineno-9-174">174</a></span>
<span class="normal"><a href="#__codelineno-9-175">175</a></span>
<span class="normal"><a href="#__codelineno-9-176">176</a></span>
<span class="normal"><a href="#__codelineno-9-177">177</a></span>
<span class="normal"><a href="#__codelineno-9-178">178</a></span>
<span class="normal"><a href="#__codelineno-9-179">179</a></span>
<span class="normal"><a href="#__codelineno-9-180">180</a></span>
<span class="normal"><a href="#__codelineno-9-181">181</a></span>
<span class="normal"><a href="#__codelineno-9-182">182</a></span>
<span class="normal"><a href="#__codelineno-9-183">183</a></span>
<span class="normal"><a href="#__codelineno-9-184">184</a></span>
<span class="normal"><a href="#__codelineno-9-185">185</a></span>
<span class="normal"><a href="#__codelineno-9-186">186</a></span>
<span class="normal"><a href="#__codelineno-9-187">187</a></span>
<span class="normal"><a href="#__codelineno-9-188">188</a></span>
<span class="normal"><a href="#__codelineno-9-189">189</a></span>
<span class="normal"><a href="#__codelineno-9-190">190</a></span>
<span class="normal"><a href="#__codelineno-9-191">191</a></span>
<span class="normal"><a href="#__codelineno-9-192">192</a></span>
<span class="normal"><a href="#__codelineno-9-193">193</a></span>
<span class="normal"><a href="#__codelineno-9-194">194</a></span>
<span class="normal"><a href="#__codelineno-9-195">195</a></span>
<span class="normal"><a href="#__codelineno-9-196">196</a></span>
<span class="normal"><a href="#__codelineno-9-197">197</a></span>
<span class="normal"><a href="#__codelineno-9-198">198</a></span>
<span class="normal"><a href="#__codelineno-9-199">199</a></span>
<span class="normal"><a href="#__codelineno-9-200">200</a></span>
<span class="normal"><a href="#__codelineno-9-201">201</a></span>
<span class="normal"><a href="#__codelineno-9-202">202</a></span>
<span class="normal"><a href="#__codelineno-9-203">203</a></span>
<span class="normal"><a href="#__codelineno-9-204">204</a></span>
<span class="normal"><a href="#__codelineno-9-205">205</a></span>
<span class="normal"><a href="#__codelineno-9-206">206</a></span>
<span class="normal"><a href="#__codelineno-9-207">207</a></span>
<span class="normal"><a href="#__codelineno-9-208">208</a></span>
<span class="normal"><a href="#__codelineno-9-209">209</a></span>
<span class="normal"><a href="#__codelineno-9-210">210</a></span>
<span class="normal"><a href="#__codelineno-9-211">211</a></span>
<span class="normal"><a href="#__codelineno-9-212">212</a></span>
<span class="normal"><a href="#__codelineno-9-213">213</a></span>
<span class="normal"><a href="#__codelineno-9-214">214</a></span>
<span class="normal"><a href="#__codelineno-9-215">215</a></span>
<span class="normal"><a href="#__codelineno-9-216">216</a></span>
<span class="normal"><a href="#__codelineno-9-217">217</a></span>
<span class="normal"><a href="#__codelineno-9-218">218</a></span>
<span class="normal"><a href="#__codelineno-9-219">219</a></span>
<span class="normal"><a href="#__codelineno-9-220">220</a></span>
<span class="normal"><a href="#__codelineno-9-221">221</a></span>
<span class="normal"><a href="#__codelineno-9-222">222</a></span>
<span class="normal"><a href="#__codelineno-9-223">223</a></span>
<span class="normal"><a href="#__codelineno-9-224">224</a></span>
<span class="normal"><a href="#__codelineno-9-225">225</a></span>
<span class="normal"><a href="#__codelineno-9-226">226</a></span>
<span class="normal"><a href="#__codelineno-9-227">227</a></span>
<span class="normal"><a href="#__codelineno-9-228">228</a></span>
<span class="normal"><a href="#__codelineno-9-229">229</a></span>
<span class="normal"><a href="#__codelineno-9-230">230</a></span>
<span class="normal"><a href="#__codelineno-9-231">231</a></span>
<span class="normal"><a href="#__codelineno-9-232">232</a></span>
<span class="normal"><a href="#__codelineno-9-233">233</a></span>
<span class="normal"><a href="#__codelineno-9-234">234</a></span>
<span class="normal"><a href="#__codelineno-9-235">235</a></span>
<span class="normal"><a href="#__codelineno-9-236">236</a></span>
<span class="normal"><a href="#__codelineno-9-237">237</a></span>
<span class="normal"><a href="#__codelineno-9-238">238</a></span>
<span class="normal"><a href="#__codelineno-9-239">239</a></span>
<span class="normal"><a href="#__codelineno-9-240">240</a></span>
<span class="normal"><a href="#__codelineno-9-241">241</a></span>
<span class="normal"><a href="#__codelineno-9-242">242</a></span>
<span class="normal"><a href="#__codelineno-9-243">243</a></span>
<span class="normal"><a href="#__codelineno-9-244">244</a></span>
<span class="normal"><a href="#__codelineno-9-245">245</a></span>
<span class="normal"><a href="#__codelineno-9-246">246</a></span>
<span class="normal"><a href="#__codelineno-9-247">247</a></span>
<span class="normal"><a href="#__codelineno-9-248">248</a></span>
<span class="normal"><a href="#__codelineno-9-249">249</a></span>
<span class="normal"><a href="#__codelineno-9-250">250</a></span>
<span class="normal"><a href="#__codelineno-9-251">251</a></span>
<span class="normal"><a href="#__codelineno-9-252">252</a></span>
<span class="normal"><a href="#__codelineno-9-253">253</a></span>
<span class="normal"><a href="#__codelineno-9-254">254</a></span>
<span class="normal"><a href="#__codelineno-9-255">255</a></span>
<span class="normal"><a href="#__codelineno-9-256">256</a></span>
<span class="normal"><a href="#__codelineno-9-257">257</a></span>
<span class="normal"><a href="#__codelineno-9-258">258</a></span>
<span class="normal"><a href="#__codelineno-9-259">259</a></span>
<span class="normal"><a href="#__codelineno-9-260">260</a></span>
<span class="normal"><a href="#__codelineno-9-261">261</a></span>
<span class="normal"><a href="#__codelineno-9-262">262</a></span>
<span class="normal"><a href="#__codelineno-9-263">263</a></span>
<span class="normal"><a href="#__codelineno-9-264">264</a></span>
<span class="normal"><a href="#__codelineno-9-265">265</a></span>
<span class="normal"><a href="#__codelineno-9-266">266</a></span>
<span class="normal"><a href="#__codelineno-9-267">267</a></span>
<span class="normal"><a href="#__codelineno-9-268">268</a></span>
<span class="normal"><a href="#__codelineno-9-269">269</a></span>
<span class="normal"><a href="#__codelineno-9-270">270</a></span>
<span class="normal"><a href="#__codelineno-9-271">271</a></span>
<span class="normal"><a href="#__codelineno-9-272">272</a></span>
<span class="normal"><a href="#__codelineno-9-273">273</a></span>
<span class="normal"><a href="#__codelineno-9-274">274</a></span>
<span class="normal"><a href="#__codelineno-9-275">275</a></span>
<span class="normal"><a href="#__codelineno-9-276">276</a></span>
<span class="normal"><a href="#__codelineno-9-277">277</a></span>
<span class="normal"><a href="#__codelineno-9-278">278</a></span>
<span class="normal"><a href="#__codelineno-9-279">279</a></span>
<span class="normal"><a href="#__codelineno-9-280">280</a></span>
<span class="normal"><a href="#__codelineno-9-281">281</a></span>
<span class="normal"><a href="#__codelineno-9-282">282</a></span>
<span class="normal"><a href="#__codelineno-9-283">283</a></span>
<span class="normal"><a href="#__codelineno-9-284">284</a></span>
<span class="normal"><a href="#__codelineno-9-285">285</a></span>
<span class="normal"><a href="#__codelineno-9-286">286</a></span>
<span class="normal"><a href="#__codelineno-9-287">287</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">ResNet18_Weights</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">regnet_y_1_6gf</span><span class="p">,</span> <span class="n">RegNet_Y_1_6GF_Weights</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="c1"># 全局配置 (仅保留推理必要参数)</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="n">S</span> <span class="o">=</span> <span class="mi">7</span>   <span class="c1"># 网格大小</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="n">B</span> <span class="o">=</span> <span class="mi">2</span>   <span class="c1"># 每个网格的边界框数量</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="n">C</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># VOC类别数量</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="mi">448</span>  <span class="c1"># 输入图像尺寸</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="n">DEVICE</span> <span class="o">=</span> <span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'xpu'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">xpu</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="n">AUTOCAST_ENABLED</span> <span class="o">=</span> <span class="p">(</span><span class="n">DEVICE</span> <span class="o">==</span> <span class="s1">'cuda'</span> <span class="ow">or</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s1">'xpu'</span><span class="p">)</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="c1"># VOC类别映射</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="n">VOC_CLASSES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a>    <span class="s1">'aeroplane'</span><span class="p">,</span><span class="s1">'bicycle'</span><span class="p">,</span><span class="s1">'bird'</span><span class="p">,</span><span class="s1">'boat'</span><span class="p">,</span><span class="s1">'bottle'</span><span class="p">,</span><span class="s1">'bus'</span><span class="p">,</span><span class="s1">'car'</span><span class="p">,</span><span class="s1">'cat'</span><span class="p">,</span><span class="s1">'chair'</span><span class="p">,</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a>    <span class="s1">'cow'</span><span class="p">,</span><span class="s1">'diningtable'</span><span class="p">,</span><span class="s1">'dog'</span><span class="p">,</span><span class="s1">'horse'</span><span class="p">,</span><span class="s1">'motorbike'</span><span class="p">,</span><span class="s1">'person'</span><span class="p">,</span><span class="s1">'pottedplant'</span><span class="p">,</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a>    <span class="s1">'sheep'</span><span class="p">,</span><span class="s1">'sofa'</span><span class="p">,</span><span class="s1">'train'</span><span class="p">,</span><span class="s1">'tvmonitor'</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="p">]</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="n">CLASS_TO_IDX</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">VOC_CLASSES</span><span class="p">)}</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="n">IDX_TO_CLASS</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="n">CLASS_TO_IDX</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="c1"># 边界框工具函数</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="k">def</span><span class="w"> </span><span class="nf">box_iou_xyxy</span><span class="p">(</span><span class="n">boxes1</span><span class="p">,</span> <span class="n">boxes2</span><span class="p">):</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a>    <span class="c1"># boxes1: [N, 4], boxes2: [M, 4]</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a>    <span class="n">N</span> <span class="o">=</span> <span class="n">boxes1</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a>    <span class="n">M</span> <span class="o">=</span> <span class="n">boxes2</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a>    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">M</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-42" name="__codelineno-9-42"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">boxes1</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-9-43" name="__codelineno-9-43"></a>    <span class="n">lt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">boxes1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">boxes2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>   <span class="c1"># [N,M,2]</span>
<a id="__codelineno-9-44" name="__codelineno-9-44"></a>    <span class="n">rb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">boxes1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">:],</span> <span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>   <span class="c1"># [N,M,2]</span>
<a id="__codelineno-9-45" name="__codelineno-9-45"></a>    <span class="n">wh</span> <span class="o">=</span> <span class="p">(</span><span class="n">rb</span> <span class="o">-</span> <span class="n">lt</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-46" name="__codelineno-9-46"></a>    <span class="n">inter</span> <span class="o">=</span> <span class="n">wh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">wh</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-9-47" name="__codelineno-9-47"></a>    <span class="n">area1</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">boxes1</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-48" name="__codelineno-9-48"></a>    <span class="n">area2</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-49" name="__codelineno-9-49"></a>    <span class="n">union</span> <span class="o">=</span> <span class="n">area1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">area2</span> <span class="o">-</span> <span class="n">inter</span>
<a id="__codelineno-9-50" name="__codelineno-9-50"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">/</span> <span class="p">(</span><span class="n">union</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-9-51" name="__codelineno-9-51"></a>    <span class="k">return</span> <span class="n">iou</span>
<a id="__codelineno-9-52" name="__codelineno-9-52"></a>
<a id="__codelineno-9-53" name="__codelineno-9-53"></a><span class="k">def</span><span class="w"> </span><span class="nf">cxcywh_to_xyxy</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
<a id="__codelineno-9-54" name="__codelineno-9-54"></a>    <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-9-55" name="__codelineno-9-55"></a>    <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx</span> <span class="o">-</span> <span class="n">w</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-9-56" name="__codelineno-9-56"></a>    <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cy</span> <span class="o">-</span> <span class="n">h</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-9-57" name="__codelineno-9-57"></a>    <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-9-58" name="__codelineno-9-58"></a>    <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">cy</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
<a id="__codelineno-9-59" name="__codelineno-9-59"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-60" name="__codelineno-9-60"></a>
<a id="__codelineno-9-61" name="__codelineno-9-61"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-62" name="__codelineno-9-62"></a><span class="c1"># YOLOv1模型定义</span>
<a id="__codelineno-9-63" name="__codelineno-9-63"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-64" name="__codelineno-9-64"></a><span class="k">class</span><span class="w"> </span><span class="nc">YOLOv1ResNet18</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-9-65" name="__codelineno-9-65"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-9-66" name="__codelineno-9-66"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-9-67" name="__codelineno-9-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
<a id="__codelineno-9-68" name="__codelineno-9-68"></a>        <span class="n">backbone</span> <span class="o">=</span> <span class="n">resnet18</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">ResNet18_Weights</span><span class="o">.</span><span class="n">IMAGENET1K_V1</span> <span class="k">if</span> <span class="n">pretrained</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-9-69" name="__codelineno-9-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stem</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-9-70" name="__codelineno-9-70"></a>            <span class="n">backbone</span><span class="o">.</span><span class="n">conv1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">bn1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">maxpool</span><span class="p">,</span>
<a id="__codelineno-9-71" name="__codelineno-9-71"></a>            <span class="n">backbone</span><span class="o">.</span><span class="n">layer1</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer2</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer3</span><span class="p">,</span> <span class="n">backbone</span><span class="o">.</span><span class="n">layer4</span>
<a id="__codelineno-9-72" name="__codelineno-9-72"></a>        <span class="p">)</span>
<a id="__codelineno-9-73" name="__codelineno-9-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-9-74" name="__codelineno-9-74"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-9-75" name="__codelineno-9-75"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<a id="__codelineno-9-76" name="__codelineno-9-76"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-77" name="__codelineno-9-77"></a>        <span class="p">)</span>
<a id="__codelineno-9-78" name="__codelineno-9-78"></a>        <span class="n">out_ch</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span> <span class="n">c</span>
<a id="__codelineno-9-79" name="__codelineno-9-79"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-9-80" name="__codelineno-9-80"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-9-81" name="__codelineno-9-81"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<a id="__codelineno-9-82" name="__codelineno-9-82"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-9-83" name="__codelineno-9-83"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-84" name="__codelineno-9-84"></a>        <span class="p">)</span>
<a id="__codelineno-9-85" name="__codelineno-9-85"></a>
<a id="__codelineno-9-86" name="__codelineno-9-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-9-87" name="__codelineno-9-87"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># [N,512,14,14] 输入为448x448时</span>
<a id="__codelineno-9-88" name="__codelineno-9-88"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   <span class="c1"># [N,1024,7,7]</span>
<a id="__codelineno-9-89" name="__codelineno-9-89"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># [N,(B*5+C),7,7]</span>
<a id="__codelineno-9-90" name="__codelineno-9-90"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
<a id="__codelineno-9-91" name="__codelineno-9-91"></a>        <span class="k">return</span> <span class="n">x</span>  <span class="c1"># [N,S,S,B*5+C]</span>
<a id="__codelineno-9-92" name="__codelineno-9-92"></a>
<a id="__codelineno-9-93" name="__codelineno-9-93"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-94" name="__codelineno-9-94"></a><span class="c1"># 预测解码与后处理</span>
<a id="__codelineno-9-95" name="__codelineno-9-95"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-96" name="__codelineno-9-96"></a><span class="k">def</span><span class="w"> </span><span class="nf">yolo_decode</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<a id="__codelineno-9-97" name="__codelineno-9-97"></a><span class="w">    </span><span class="sd">"""将模型输出解码为边界框 [x1,y1,x2,y2,score,cls] (归一化坐标)"""</span>
<a id="__codelineno-9-98" name="__codelineno-9-98"></a>    <span class="n">N</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-99" name="__codelineno-9-99"></a>    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="o">*</span><span class="mi">5</span><span class="o">+</span><span class="n">C</span><span class="p">)</span>
<a id="__codelineno-9-100" name="__codelineno-9-100"></a>    <span class="n">boxes</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="n">B</span><span class="o">*</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-9-101" name="__codelineno-9-101"></a>    <span class="n">cls_logits</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">B</span><span class="o">*</span><span class="mi">5</span><span class="p">:]</span>  <span class="c1"># [N,S,S,C]</span>
<a id="__codelineno-9-102" name="__codelineno-9-102"></a>    <span class="n">cls_prob</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">cls_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-103" name="__codelineno-9-103"></a>
<a id="__codelineno-9-104" name="__codelineno-9-104"></a>    <span class="c1"># 生成网格坐标</span>
<a id="__codelineno-9-105" name="__codelineno-9-105"></a>    <span class="n">grid_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-9-106" name="__codelineno-9-106"></a>    <span class="n">grid_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-9-107" name="__codelineno-9-107"></a>    <span class="n">gy</span><span class="p">,</span> <span class="n">gx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">grid_y</span><span class="p">,</span> <span class="n">grid_x</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">'ij'</span><span class="p">)</span>
<a id="__codelineno-9-108" name="__codelineno-9-108"></a>    <span class="n">gx</span> <span class="o">=</span> <span class="n">gx</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-9-109" name="__codelineno-9-109"></a>    <span class="n">gy</span> <span class="o">=</span> <span class="n">gy</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-9-110" name="__codelineno-9-110"></a>
<a id="__codelineno-9-111" name="__codelineno-9-111"></a>    <span class="c1"># 解码边界框</span>
<a id="__codelineno-9-112" name="__codelineno-9-112"></a>    <span class="n">px</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
<a id="__codelineno-9-113" name="__codelineno-9-113"></a>    <span class="n">py</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
<a id="__codelineno-9-114" name="__codelineno-9-114"></a>    <span class="n">pw</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-9-115" name="__codelineno-9-115"></a>    <span class="n">ph</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-9-116" name="__codelineno-9-116"></a>    <span class="n">pconf</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
<a id="__codelineno-9-117" name="__codelineno-9-117"></a>
<a id="__codelineno-9-118" name="__codelineno-9-118"></a>    <span class="c1"># 转换为归一化坐标</span>
<a id="__codelineno-9-119" name="__codelineno-9-119"></a>    <span class="n">pcx</span> <span class="o">=</span> <span class="p">(</span><span class="n">gx</span> <span class="o">+</span> <span class="n">px</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-9-120" name="__codelineno-9-120"></a>    <span class="n">pcy</span> <span class="o">=</span> <span class="p">(</span><span class="n">gy</span> <span class="o">+</span> <span class="n">py</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<a id="__codelineno-9-121" name="__codelineno-9-121"></a>    <span class="n">p_cxcywh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">pcx</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">px</span><span class="p">),</span> <span class="n">pcy</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">py</span><span class="p">),</span> <span class="n">pw</span><span class="p">,</span> <span class="n">ph</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-122" name="__codelineno-9-122"></a>    <span class="n">p_xyxy</span> <span class="o">=</span> <span class="n">cxcywh_to_xyxy</span><span class="p">(</span><span class="n">p_cxcywh</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-123" name="__codelineno-9-123"></a>
<a id="__codelineno-9-124" name="__codelineno-9-124"></a>    <span class="n">dets_per_image</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-125" name="__codelineno-9-125"></a>    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<a id="__codelineno-9-126" name="__codelineno-9-126"></a>        <span class="n">boxes_n</span> <span class="o">=</span> <span class="n">p_xyxy</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>      <span class="c1"># [S*S*B,4]</span>
<a id="__codelineno-9-127" name="__codelineno-9-127"></a>        <span class="n">conf_n</span> <span class="o">=</span> <span class="n">pconf</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c1"># [S*S*B,1]</span>
<a id="__codelineno-9-128" name="__codelineno-9-128"></a>        <span class="n">cls_prob_n</span> <span class="o">=</span> <span class="n">cls_prob</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="n">S</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
<a id="__codelineno-9-129" name="__codelineno-9-129"></a>        <span class="n">cls_prob_expand</span> <span class="o">=</span> <span class="n">cls_prob_n</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [S*S*B,C]</span>
<a id="__codelineno-9-130" name="__codelineno-9-130"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">conf_n</span> <span class="o">*</span> <span class="n">cls_prob_expand</span>                          <span class="c1"># [S*S*B,C]</span>
<a id="__codelineno-9-131" name="__codelineno-9-131"></a>        <span class="n">max_scores</span><span class="p">,</span> <span class="n">max_cls</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-132" name="__codelineno-9-132"></a>        <span class="n">keep</span> <span class="o">=</span> <span class="n">max_scores</span> <span class="o">&gt;</span> <span class="n">conf_thresh</span>
<a id="__codelineno-9-133" name="__codelineno-9-133"></a>
<a id="__codelineno-9-134" name="__codelineno-9-134"></a>        <span class="k">if</span> <span class="n">keep</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-135" name="__codelineno-9-135"></a>            <span class="n">dets_per_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-9-136" name="__codelineno-9-136"></a>            <span class="k">continue</span>
<a id="__codelineno-9-137" name="__codelineno-9-137"></a>
<a id="__codelineno-9-138" name="__codelineno-9-138"></a>        <span class="n">boxes_keep</span> <span class="o">=</span> <span class="n">boxes_n</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
<a id="__codelineno-9-139" name="__codelineno-9-139"></a>        <span class="n">scores_keep</span> <span class="o">=</span> <span class="n">max_scores</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
<a id="__codelineno-9-140" name="__codelineno-9-140"></a>        <span class="n">cls_keep</span> <span class="o">=</span> <span class="n">max_cls</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-9-141" name="__codelineno-9-141"></a>        <span class="n">dets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">boxes_keep</span><span class="p">,</span> <span class="n">scores_keep</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cls_keep</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-142" name="__codelineno-9-142"></a>        <span class="n">dets_per_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>
<a id="__codelineno-9-143" name="__codelineno-9-143"></a>
<a id="__codelineno-9-144" name="__codelineno-9-144"></a>    <span class="k">return</span> <span class="n">dets_per_image</span>
<a id="__codelineno-9-145" name="__codelineno-9-145"></a>
<a id="__codelineno-9-146" name="__codelineno-9-146"></a><span class="k">def</span><span class="w"> </span><span class="nf">nms_classwise</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">iou_thr</span><span class="o">=</span><span class="mf">0.45</span><span class="p">):</span>
<a id="__codelineno-9-147" name="__codelineno-9-147"></a><span class="w">    </span><span class="sd">"""按类别进行非极大值抑制"""</span>
<a id="__codelineno-9-148" name="__codelineno-9-148"></a>    <span class="k">if</span> <span class="n">dets</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-149" name="__codelineno-9-149"></a>        <span class="k">return</span> <span class="n">dets</span>
<a id="__codelineno-9-150" name="__codelineno-9-150"></a>    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-151" name="__codelineno-9-151"></a>    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
<a id="__codelineno-9-152" name="__codelineno-9-152"></a>        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-9-153" name="__codelineno-9-153"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span>
<a id="__codelineno-9-154" name="__codelineno-9-154"></a>        <span class="n">class_dets</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<a id="__codelineno-9-155" name="__codelineno-9-155"></a>        <span class="n">keep_idx</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">nms</span><span class="p">(</span><span class="n">class_dets</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">class_dets</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">iou_thr</span><span class="p">)</span>
<a id="__codelineno-9-156" name="__codelineno-9-156"></a>        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_dets</span><span class="p">[</span><span class="n">keep_idx</span><span class="p">])</span>
<a id="__codelineno-9-157" name="__codelineno-9-157"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">else</span> <span class="n">dets</span>
<a id="__codelineno-9-158" name="__codelineno-9-158"></a>
<a id="__codelineno-9-159" name="__codelineno-9-159"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-160" name="__codelineno-9-160"></a><span class="c1"># 摄像头实时检测功能</span>
<a id="__codelineno-9-161" name="__codelineno-9-161"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-162" name="__codelineno-9-162"></a><span class="k">def</span><span class="w"> </span><span class="nf">preprocess_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">img_size</span><span class="o">=</span><span class="mi">448</span><span class="p">):</span>
<a id="__codelineno-9-163" name="__codelineno-9-163"></a><span class="w">    </span><span class="sd">"""预处理摄像头帧用于模型输入"""</span>
<a id="__codelineno-9-164" name="__codelineno-9-164"></a>    <span class="c1"># 调整大小</span>
<a id="__codelineno-9-165" name="__codelineno-9-165"></a>    <span class="n">frame_resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">))</span>
<a id="__codelineno-9-166" name="__codelineno-9-166"></a>    <span class="c1"># BGR转RGB</span>
<a id="__codelineno-9-167" name="__codelineno-9-167"></a>    <span class="n">frame_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame_resized</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
<a id="__codelineno-9-168" name="__codelineno-9-168"></a>    <span class="c1"># 转换为张量并归一化</span>
<a id="__codelineno-9-169" name="__codelineno-9-169"></a>    <span class="n">frame_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">frame_rgb</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="mf">255.0</span>
<a id="__codelineno-9-170" name="__codelineno-9-170"></a>    <span class="c1"># 应用ImageNet标准化</span>
<a id="__codelineno-9-171" name="__codelineno-9-171"></a>    <span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
<a id="__codelineno-9-172" name="__codelineno-9-172"></a>        <span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span>
<a id="__codelineno-9-173" name="__codelineno-9-173"></a>        <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]</span>
<a id="__codelineno-9-174" name="__codelineno-9-174"></a>    <span class="p">)</span>
<a id="__codelineno-9-175" name="__codelineno-9-175"></a>    <span class="n">frame_tensor</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">frame_tensor</span><span class="p">)</span>
<a id="__codelineno-9-176" name="__codelineno-9-176"></a>    <span class="c1"># 添加批次维度</span>
<a id="__codelineno-9-177" name="__codelineno-9-177"></a>    <span class="k">return</span> <span class="n">frame_tensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-178" name="__codelineno-9-178"></a>
<a id="__codelineno-9-179" name="__codelineno-9-179"></a><span class="k">def</span><span class="w"> </span><span class="nf">draw_detections</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">img_size</span><span class="p">):</span>
<a id="__codelineno-9-180" name="__codelineno-9-180"></a><span class="w">    </span><span class="sd">"""在原始帧上绘制检测结果"""</span>
<a id="__codelineno-9-181" name="__codelineno-9-181"></a>    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-9-182" name="__codelineno-9-182"></a>    <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
<a id="__codelineno-9-183" name="__codelineno-9-183"></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">cls_idx</span> <span class="o">=</span> <span class="n">det</span>
<a id="__codelineno-9-184" name="__codelineno-9-184"></a>        <span class="c1"># 将归一化坐标转换为原始图像尺寸</span>
<a id="__codelineno-9-185" name="__codelineno-9-185"></a>        <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-9-186" name="__codelineno-9-186"></a>        <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y1</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-9-187" name="__codelineno-9-187"></a>        <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x2</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-9-188" name="__codelineno-9-188"></a>        <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y2</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-9-189" name="__codelineno-9-189"></a>
<a id="__codelineno-9-190" name="__codelineno-9-190"></a>        <span class="c1"># 绘制边界框</span>
<a id="__codelineno-9-191" name="__codelineno-9-191"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-192" name="__codelineno-9-192"></a>        <span class="c1"># 绘制类别和置信度</span>
<a id="__codelineno-9-193" name="__codelineno-9-193"></a>        <span class="n">cls_name</span> <span class="o">=</span> <span class="n">IDX_TO_CLASS</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">cls_idx</span><span class="p">)]</span>
<a id="__codelineno-9-194" name="__codelineno-9-194"></a>        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">cls_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-9-195" name="__codelineno-9-195"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="o">-</span><span class="mi">10</span><span class="p">)),</span> 
<a id="__codelineno-9-196" name="__codelineno-9-196"></a>                   <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-197" name="__codelineno-9-197"></a>    <span class="k">return</span> <span class="n">frame</span>
<a id="__codelineno-9-198" name="__codelineno-9-198"></a>
<a id="__codelineno-9-199" name="__codelineno-9-199"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_camera_detection</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">nms_iou</span><span class="o">=</span><span class="mf">0.45</span><span class="p">):</span>
<a id="__codelineno-9-200" name="__codelineno-9-200"></a><span class="w">    </span><span class="sd">"""运行摄像头实时检测"""</span>
<a id="__codelineno-9-201" name="__codelineno-9-201"></a>    <span class="c1"># 打开摄像头</span>
<a id="__codelineno-9-202" name="__codelineno-9-202"></a>    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-203" name="__codelineno-9-203"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">():</span>
<a id="__codelineno-9-204" name="__codelineno-9-204"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"无法打开摄像头"</span><span class="p">)</span>
<a id="__codelineno-9-205" name="__codelineno-9-205"></a>        <span class="k">return</span>
<a id="__codelineno-9-206" name="__codelineno-9-206"></a>
<a id="__codelineno-9-207" name="__codelineno-9-207"></a>    <span class="c1"># 设置摄像头参数</span>
<a id="__codelineno-9-208" name="__codelineno-9-208"></a>    <span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="mi">1280</span><span class="p">)</span>
<a id="__codelineno-9-209" name="__codelineno-9-209"></a>    <span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="mi">720</span><span class="p">)</span>
<a id="__codelineno-9-210" name="__codelineno-9-210"></a>    <span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FPS</span><span class="p">,</span> <span class="n">fps</span><span class="p">)</span>
<a id="__codelineno-9-211" name="__codelineno-9-211"></a>
<a id="__codelineno-9-212" name="__codelineno-9-212"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-9-213" name="__codelineno-9-213"></a>    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-9-214" name="__codelineno-9-214"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"开始实时检测 (按 'q' 退出)"</span><span class="p">)</span>
<a id="__codelineno-9-215" name="__codelineno-9-215"></a>
<a id="__codelineno-9-216" name="__codelineno-9-216"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-9-217" name="__codelineno-9-217"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-9-218" name="__codelineno-9-218"></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-9-219" name="__codelineno-9-219"></a>
<a id="__codelineno-9-220" name="__codelineno-9-220"></a>            <span class="c1"># 读取一帧</span>
<a id="__codelineno-9-221" name="__codelineno-9-221"></a>            <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-9-222" name="__codelineno-9-222"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
<a id="__codelineno-9-223" name="__codelineno-9-223"></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">"无法获取视频帧"</span><span class="p">)</span>
<a id="__codelineno-9-224" name="__codelineno-9-224"></a>                <span class="k">break</span>
<a id="__codelineno-9-225" name="__codelineno-9-225"></a>
<a id="__codelineno-9-226" name="__codelineno-9-226"></a>            <span class="c1"># 预处理</span>
<a id="__codelineno-9-227" name="__codelineno-9-227"></a>            <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">preprocess_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-9-228" name="__codelineno-9-228"></a>
<a id="__codelineno-9-229" name="__codelineno-9-229"></a>            <span class="c1"># 模型推理</span>
<a id="__codelineno-9-230" name="__codelineno-9-230"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s1">'cuda'</span> <span class="k">else</span> <span class="s1">'cpu'</span><span class="p">,</span> 
<a id="__codelineno-9-231" name="__codelineno-9-231"></a>                                                  <span class="n">enabled</span><span class="o">=</span><span class="n">AUTOCAST_ENABLED</span><span class="p">):</span>
<a id="__codelineno-9-232" name="__codelineno-9-232"></a>                <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">)</span>
<a id="__codelineno-9-233" name="__codelineno-9-233"></a>
<a id="__codelineno-9-234" name="__codelineno-9-234"></a>            <span class="c1"># 解码和后处理</span>
<a id="__codelineno-9-235" name="__codelineno-9-235"></a>            <span class="n">dets</span> <span class="o">=</span> <span class="n">yolo_decode</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="n">conf_thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-9-236" name="__codelineno-9-236"></a>            <span class="n">dets</span> <span class="o">=</span> <span class="n">nms_classwise</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">iou_thr</span><span class="o">=</span><span class="n">nms_iou</span><span class="p">)</span>
<a id="__codelineno-9-237" name="__codelineno-9-237"></a>
<a id="__codelineno-9-238" name="__codelineno-9-238"></a>            <span class="c1"># 绘制检测结果</span>
<a id="__codelineno-9-239" name="__codelineno-9-239"></a>            <span class="n">frame_with_dets</span> <span class="o">=</span> <span class="n">draw_detections</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">)</span>
<a id="__codelineno-9-240" name="__codelineno-9-240"></a>
<a id="__codelineno-9-241" name="__codelineno-9-241"></a>            <span class="c1"># 计算并显示FPS</span>
<a id="__codelineno-9-242" name="__codelineno-9-242"></a>            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-9-243" name="__codelineno-9-243"></a>            <span class="n">current_fps</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">elapsed</span> <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-9-244" name="__codelineno-9-244"></a>            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">frame_with_dets</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"FPS: </span><span class="si">{</span><span class="n">current_fps</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
<a id="__codelineno-9-245" name="__codelineno-9-245"></a>                       <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-246" name="__codelineno-9-246"></a>
<a id="__codelineno-9-247" name="__codelineno-9-247"></a>            <span class="c1"># 显示结果</span>
<a id="__codelineno-9-248" name="__codelineno-9-248"></a>            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">"YOLOv1 Real-time Detection"</span><span class="p">,</span> <span class="n">frame_with_dets</span><span class="p">)</span>
<a id="__codelineno-9-249" name="__codelineno-9-249"></a>
<a id="__codelineno-9-250" name="__codelineno-9-250"></a>            <span class="c1"># 按'q'退出</span>
<a id="__codelineno-9-251" name="__codelineno-9-251"></a>            <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">'q'</span><span class="p">):</span>
<a id="__codelineno-9-252" name="__codelineno-9-252"></a>                <span class="k">break</span>
<a id="__codelineno-9-253" name="__codelineno-9-253"></a>
<a id="__codelineno-9-254" name="__codelineno-9-254"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-9-255" name="__codelineno-9-255"></a>        <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<a id="__codelineno-9-256" name="__codelineno-9-256"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
<a id="__codelineno-9-257" name="__codelineno-9-257"></a>
<a id="__codelineno-9-258" name="__codelineno-9-258"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-259" name="__codelineno-9-259"></a><span class="c1"># 主函数 - 加载模型并启动检测</span>
<a id="__codelineno-9-260" name="__codelineno-9-260"></a><span class="c1"># --------------------</span>
<a id="__codelineno-9-261" name="__codelineno-9-261"></a><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-9-262" name="__codelineno-9-262"></a>    <span class="c1"># 创建模型</span>
<a id="__codelineno-9-263" name="__codelineno-9-263"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">YOLOv1ResNet18</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">S</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">B</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-264" name="__codelineno-9-264"></a>
<a id="__codelineno-9-265" name="__codelineno-9-265"></a>    <span class="c1"># 加载权重</span>
<a id="__codelineno-9-266" name="__codelineno-9-266"></a>    <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="s1">'./yolov1_resnet18_voc0712.pth'</span>
<a id="__codelineno-9-267" name="__codelineno-9-267"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">):</span>
<a id="__codelineno-9-268" name="__codelineno-9-268"></a>        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">))</span>
<a id="__codelineno-9-269" name="__codelineno-9-269"></a>        <span class="c1"># 加载模型权重</span>
<a id="__codelineno-9-270" name="__codelineno-9-270"></a>        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">'model_state_dict'</span><span class="p">])</span>
<a id="__codelineno-9-271" name="__codelineno-9-271"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"成功加载模型权重: </span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-9-272" name="__codelineno-9-272"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-273" name="__codelineno-9-273"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"警告: 未找到模型权重文件 </span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2">，使用随机权重"</span><span class="p">)</span>
<a id="__codelineno-9-274" name="__codelineno-9-274"></a>
<a id="__codelineno-9-275" name="__codelineno-9-275"></a>    <span class="c1"># 启动摄像头检测</span>
<a id="__codelineno-9-276" name="__codelineno-9-276"></a>    <span class="n">run_camera_detection</span><span class="p">(</span>
<a id="__codelineno-9-277" name="__codelineno-9-277"></a>        <span class="n">model</span><span class="p">,</span>
<a id="__codelineno-9-278" name="__codelineno-9-278"></a>        <span class="n">fps</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>           <span class="c1"># 目标帧率</span>
<a id="__codelineno-9-279" name="__codelineno-9-279"></a>        <span class="n">conf_thresh</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span> <span class="c1"># 置信度阈值</span>
<a id="__codelineno-9-280" name="__codelineno-9-280"></a>        <span class="n">nms_iou</span><span class="o">=</span><span class="mf">0.45</span>      <span class="c1"># NMS的IOU阈值</span>
<a id="__codelineno-9-281" name="__codelineno-9-281"></a>    <span class="p">)</span>
<a id="__codelineno-9-282" name="__codelineno-9-282"></a>
<a id="__codelineno-9-283" name="__codelineno-9-283"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a id="__codelineno-9-284" name="__codelineno-9-284"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"using device: </span><span class="si">{</span><span class="n">DEVICE</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-9-285" name="__codelineno-9-285"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>  <span class="c1"># 延迟导入，仅在主程序运行时需要</span>
<a id="__codelineno-9-286" name="__codelineno-9-286"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"初始化完毕，开始加载权重..."</span><span class="p">)</span>
<a id="__codelineno-9-287" name="__codelineno-9-287"></a>    <span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<p>最后在真实世界样本的检测效果如下：（帧率很低是由于笔记本没有独显导致只能在 CPU 上面推理）</p>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20005625.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20005447.png"/></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20005400.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20005133.png"/></td>
</tr>
<tr>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20003519.png"/></td>
<td style="text-align: center;"><img alt="alt text" src="../%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-06%20010942.png"/></td>
</tr>
</tbody>
</table>
<div class="admonition info">
<p class="admonition-title">📝 如果您需要引用本文</p>
<p>Yan Li. (Sep. 13, 2025). 图像语义分割和目标检测相关模型复现手记 [Blog post]. Retrieved from <a href="https://dicaeopolis.github.io/DNN/model-expr/S-and-D-models-replication">https://dicaeopolis.github.io/DNN/model-expr/S-and-D-models-replication</a></p>
<p>在 BibTeX 格式中：
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span>
<span class="normal"><a href="#__codelineno-10-6">6</a></span>
<span class="normal"><a href="#__codelineno-10-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>@online{S-and-D-models-replication,
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    title={图像语义分割和目标检测相关模型复现手记},
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>    author={Yan Li},
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>    year={2025},
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>    month={Sep},
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>    url={\url{https://dicaeopolis.github.io/DNN/model-expr/S-and-D-models-replication}},
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>}
</code></pre></div></td></tr></table></div></p>
</div>
<form class="md-feedback" hidden="" name="feedback">
<fieldset>
<legend class="md-feedback__title">
        Was this page helpful?
      </legend>
<div class="md-feedback__inner">
<div class="md-feedback__list">
<button class="md-feedback__icon md-icon" data-md-value="1" title="This page was helpful" type="submit">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"></path></svg>
</button>
<button class="md-feedback__icon md-icon" data-md-value="0" title="This page could be improved" type="submit">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"></path></svg>
</button>
</div>
<div class="md-feedback__note">
<div data-md-value="1" hidden="">
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
<div data-md-value="0" hidden="">
              
              
                
              
              
              
                
                
              
              Thanks for your feedback! Help us improve this page by using our <a href="..." rel="noopener" target="_blank">feedback form</a>.
            </div>
</div>
</div>
</fieldset>
</form>
<h2 id="__comments">评论</h2>
<!-- Giscus 脚本粘贴在这里 -->
<script async="" crossorigin="anonymous" data-category="Comments" data-category-id="DIC_kwDOOfbpCM4CtuiH" data-emit-metadata="0" data-input-position="bottom" data-lang="zh-CN" data-mapping="pathname" data-reactions-enabled="1" data-repo="dicaeopolis/dicaeopolis.github.io" data-repo-id="R_kgDOOfbpCA" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js">
</script>
<!-- 这段脚本用于同步 Giscus 和 mkdocs-material 的主题 -->
<script>
    var giscus = document.querySelector("script[src*=giscus]");
    document.addEventListener("DOMContentLoaded", function () {
      var palette = __md_get("__palette");
      if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "transparent_dark" : "light";
        giscus.setAttribute("data-theme", theme);
      }
      var ref = document.querySelector("[data-md-component=palette]");
      ref.addEventListener("change", function () {
        var palette = __md_get("__palette");
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "transparent_dark" : "light";
          var message = { setConfig: { theme: theme } };
          var frame = document.querySelector(".giscus-frame");
          frame.contentWindow.postMessage({ giscus: message }, "https://giscus.app");
        }
      });
    });
  </script>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "content.code.select", "navigation.titles", "navigation.tabs", "navigation.indexes"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
<script src="../../../assets/js/custom.js"></script>
<script src="../../../themes/js/custom.js"></script>
<script src="../../../themes/js/simpleLightbox.min.js"></script>
<script src="../../../themes/js/optionalConfig.js"></script>
<script src="../../../themes/js/mermaidloader.js"></script>
<script src="../../../themes/js/umlconvert.js"></script>
<script src="../../../themes/js/mathjax.js"></script>
<script src="../../../themes/js/katex.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.17.1/flowchart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mermaid-js/mermaid-mindmap@9.3.0/dist/diagram-definition.0faef4c2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-plantuml@1.4.1/index.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml-full.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-svg-full.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
</body>
</html>